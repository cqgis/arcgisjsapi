// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../PopupTemplate ../renderers ../request ../core/Error ../core/Logger ../core/promiseUtils ../core/urlUtils ../core/watchUtils ../core/accessorSupport/decorators ../core/accessorSupport/PropertyOrigin ../core/accessorSupport/utils ./FeatureLayer ./Layer ./mixins/SceneService ./support/commonProperties ./support/commonProperties ./support/FeatureReduction ./support/FeatureReductionSelection ./support/Field ./support/fieldUtils ./support/LabelClass ./support/labelingInfo ./support/RangeInfo ../portal/PortalItem ../renderers/support/jsonUtils ../renderers/support/styleUtils ../support/popupUtils ../tasks/support/Query".split(" "),
function(p,U,x,y,d,z,A,m,g,B,f,C,D,c,k,E,q,F,G,l,H,I,J,K,n,L,r,M,N,O,P,Q,R){function t(c,b,a){c&&((c=O.read(c,b,a)||void 0)||h.error("Failed to create renderer",{rendererDefinition:c,layer:this,context:a}));return c}var S=["3DObject","Point"],h=B.getLogger("esri.layers.SceneLayer"),v={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",points:"points","features-points":"points",lines:"lines","features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},
T={"mesh-pyramids":"mesh",points:"point",lines:"polyline",polygons:"polygon"};return function(u){function b(a,e){a=u.call(this)||this;a.featureReduction=null;a.rangeInfos=null;a.operationalLayerType="ArcGISSceneServiceLayer";a.type="scene";a.fields=[];a.definitionExpression=null;a.path=null;a.labelsVisible=!0;a.labelingInfo=null;a.legendEnabled=!0;a.cachedDrawingInfo={color:!1};a.popupEnabled=!0;a.popupTemplate=null;a.objectIdField=null;a.objectIdFilter=null;a._fieldUsageInfo={};a.screenSizePerspectiveEnabled=
!0;return a}y(b,u);b.prototype.normalizeCtorArgs=function(a,e){return"string"===typeof a?x({url:a},e):a};b.prototype.getField=function(a){return n.getField(this.fields,a)};Object.defineProperty(b.prototype,"elevationInfo",{set:function(a){this._set("elevationInfo",a);this.loaded&&this._validateElevationInfo()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"geometryType",{get:function(){return T[this.profile]||"mesh"},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"renderer",{set:function(a){n.fixRendererFields(a,this.fields);this._set("renderer",a)},enumerable:!0,configurable:!0});b.prototype.readCachedDrawingInfo=function(a,e){if(null==a||"object"!==typeof a)a={};null==a.color&&(a.color=!1);return a};Object.defineProperty(b.prototype,"defaultPopupTemplate",{get:function(){return this.associatedLayer||this.attributeStorageInfo?this.createPopupTemplate():null},enumerable:!0,configurable:!0});b.prototype.readObjectIdField=function(a,e){!a&&e.fields&&e.fields.some(function(e){"esriFieldTypeOID"===
e.type&&(a=e.name);return!!a});return a||void 0};b.prototype.readProfile=function(a,e){a=e.store.profile;if(null!=a&&v[a])return v[a];h.error("Unknown or missing profile",{profile:a,layer:this});return"mesh-pyramids"};b.prototype.load=function(){var a=this,e=this.loadFromPortal({supportedTypes:["Scene Service"]}).then(function(){return a._fetchService()},function(){return a._fetchService()}).then(function(){return f.all([a._verifyRootNodeAndUpdateExtent(),a._setAssociatedFeatureLayer()])}).then(function(){return a._validateElevationInfo()}).then(function(){return a._applyAssociatedLayerOverrides()}).then(function(){return a._populateFieldUsageInfo()}).then(function(){return P.loadStyleRenderer(a,
{origin:"service"})}).then(function(){return n.fixRendererFields(a.renderer,a.fields)});this.addResolvingPromise(e);return this.when()};b.prototype.createLayerView=function(a){var e=this;return(null==this.profile||"mesh-pyramids"===this.profile?f.create(function(a){return p(["../views/3d/layers/SceneLayerView3D"],a)}):f.create(function(a){return p(["../views/3d/layers/SceneLayerGraphicsView3D"],a)})).then(function(b){return new b({view:a,layer:e})})};b.prototype.createQuery=function(){var a=new R;
"mesh"!==this.geometryType&&(a.returnGeometry=!0,a.returnZ=!0);a.where=this.definitionExpression||"1\x3d1";a.sqlFormat="standard";return a};b.prototype.queryExtent=function(a){var e=this;return this._getAssociatedLayerForQuery().then(function(b){return b.queryExtent(a||e.createQuery())})};b.prototype.queryFeatureCount=function(a){var e=this;return this._getAssociatedLayerForQuery().then(function(b){return b.queryFeatureCount(a||e.createQuery())})};b.prototype.queryFeatures=function(a){var e=this;
return this._getAssociatedLayerForQuery().then(function(b){return b.queryFeatures(a||e.createQuery())}).then(function(a){if(a&&a.features)for(var b=0,c=a.features;b<c.length;b++){var w=c[b];w.layer=e;w.sourceLayer=e}return a})};b.prototype.queryObjectIds=function(a){var b=this;return this._getAssociatedLayerForQuery().then(function(e){return e.queryObjectIds(a||b.createQuery())})};b.prototype.getFieldUsageInfo=function(a){var b={supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,
supportsLayerQuery:!1};return this.loaded?this._fieldUsageInfo[a]||b:(h.error("#getFieldUsageInfo()","Unavailable until layer is loaded"),b)};b.prototype.createPopupTemplate=function(a){return Q.createPopupTemplate(this,a)};b.prototype._getAssociatedLayerForQuery=function(){var a=this;if(!this.loaded)return this.load().then(function(){return a._getAssociatedLayerForQuery()});var b=this.associatedLayer;return null!=b?f.resolve(b):f.reject(new g("scenelayer:query-not-available","SceneLayer queries are not available without associated feature layer"))};
b.prototype.hasCachedStatistics=function(a){return null!=this.statisticsInfo&&this.statisticsInfo.some(function(b){return b.name===a})};b.prototype.queryCachedStatistics=function(a){if(!this.hasCachedStatistics(a))return f.reject(new g("scenelayer:no-cached-statistics","Cached statistics for this attribute are not available"));for(var b=0,c=this.statisticsInfo;b<c.length;b++){var d=c[b];if(d.name===a)return a=C.join(this.parsedUrl.path,d.href),m(a,{query:{f:"json"},responseType:"json"}).then(function(a){return a.data})}};
b.prototype._validateLayer=function(a){if(a.layerType&&-1===S.indexOf(a.layerType))throw new g("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",{layerType:a.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new g("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});if(1<this.version.major)throw new g("layer:service-version-too-new","Service version is too new.",
{serviceVersion:this.version.versionString,supportedVersions:"1.x"});a=this.normalReferenceFrame;var b=this.spatialReference,c=!1,d=!1;if(null==a)d=c=!0;else switch(b=b&&b.isGeographic,a){case "east-north-up":case "earth-centered":c=!0;d=b;break;case "vertex-reference-frame":c=!0;d=!b;break;default:c=!1}if(!c)throw new g("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!d)throw new g("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.");
};b.prototype._populateFieldUsageInfo=function(){this._fieldUsageInfo={};if(this.fields)for(var a=function(a){var c=!(!b.attributeStorageInfo||!b.attributeStorageInfo.some(function(b){return b.name===a.name})),e=!!(b.associatedLayer&&b.associatedLayer.fields&&b.associatedLayer.fields.some(function(b){return b&&a.name===b.name}));b._fieldUsageInfo[a.name]={supportsLabelingInfo:c,supportsRenderer:c,supportsPopupTemplate:c||e,supportsLayerQuery:e}},b=this,c=0,d=this.fields;c<d.length;c++)a(d[c])};b.prototype._applyAssociatedLayerOverrides=
function(){if(this.associatedLayer){if(this.associatedLayer.fields)for(var a=0,b=this.associatedLayer.fields;a<b.length;a++){var c=b[a];this.getField(c.name)||this.fields.push(c.clone())}a=["popupTemplate","popupEnabled"];b=E.getProperties(this);for(c=0;c<a.length;c++){var d=a[c];this._buddyIsMoreImportant(d)&&(b.setDefaultOrigin(this.associatedLayer.originOf(d)),b.set(d,this.associatedLayer[d]),b.setDefaultOrigin("user"))}}};b.prototype._setAssociatedFeatureLayer=function(){var a=this;return this._fetchAssociatedFeatureLayer().then(function(b){a.associatedLayer=
b})};b.prototype._fetchAssociatedFeatureLayer=function(){var a=this;return-1===["mesh-pyramids","points"].indexOf(this.profile)?f.resolve(null):(this.portalItem&&this.portalItem.isResolved()?this._fetchAssociatedFeatureLayerFromRelatedItems(this.portalItem):this._fetchAssociatedFeatureLayerFromUrl()).then(function(a){return a.load()}).catch(function(b){D.whenValidOnce(a,["popupTemplate","popupEnabled"],function(){return a.popupEnabled&&null!=a.popupTemplate}).then(function(){return function(){var b=
"this SceneLayer: "+a.title;null==a.attributeStorageInfo?h.warn("Associated FeatureLayer could not be loaded and no binary attributes found. Popups will not work on "+b):h.info("Associated FeatureLayer could not be loaded. Falling back to binary attributes for Popups on "+b)}});return null})};b.prototype._fetchAssociatedFeatureLayerFromRelatedItems=function(a){var b=this;return a.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"}).then(function(a){return(a=a.filter(function(a){return"Feature Service"===
a.type})[0])?b._fetchAssociatedFeatureLayerFromPortalItem(new N({id:a.id,portal:a.portal})):f.reject()}).catch(function(){return b._fetchAssociatedFeatureLayerFromUrl()})};b.prototype._fetchAssociatedFeatureLayerFromPortalItem=function(a){var b=this;return a.load().then(function(a){return b._findMatchingAssociatedSublayerUrl(a.url)}).then(function(b){return f.resolve(new q({url:b,portalItem:a}))})};b.prototype._fetchAssociatedFeatureLayerFromUrl=function(){return this._findMatchingAssociatedSublayerUrl().then(function(a){return f.resolve(new q({url:a}))})};
b.prototype._findMatchingAssociatedSublayerUrl=function(a){var b=this.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);if(!b)return f.reject();null==a&&(a=b[1]+"/FeatureServer");var c=a.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1");a={query:{f:"json"},responseType:"json"};var d=b[1]+"/SceneServer",g=parseInt(b[2],10),b=m(d,a).catch(function(a){return{data:{layers:null}}});a=m(c,a);return f.all([a,b]).then(function(a){var b=a[0];a=a[1];a=a.data&&a.data.layers;b=b.data&&b.data.layers;
if(!Array.isArray(b))throw Error("expected layers array");if(Array.isArray(a))for(var d=0;d<Math.min(a.length,b.length);d++){if(a[d].id===g)return c+"/"+b[d].id}else if(g<b.length)return c+"/"+b[g].id;throw Error("could not find matching associated sublayer");})};b.prototype._buddyIsMoreImportant=function(a){if(!this.associatedLayer)return!1;var b=k.nameToId(this.originOf(a));a=k.nameToId(this.associatedLayer.originOf(a));return null!=a&&a<=k.OriginId.SERVICE?null==b||b<k.OriginId.SERVICE:null!=a&&
a<=k.OriginId.PORTAL_ITEM?null==b||b<k.OriginId.PORTAL_ITEM:!1};b.prototype._validateElevationInfo=function(){var a=this.elevationInfo;a&&("mesh-pyramids"===this.profile&&"absolute-height"!==a.mode&&h.warn(".elevationInfo\x3d","Mesh scene layers only support absolute-height elevation mode"),a.featureExpressionInfo&&"0"!==a.featureExpressionInfo.expression&&h.warn(".elevationInfo\x3d","Scene layers do not support featureExpressionInfo"))};d([c.shared("esri.layers.SceneLayer")],b.prototype,"declaredClass",
void 0);d([c.property({types:{key:"type",base:I.default,typeMap:{selection:J.default}},json:{origins:{"web-scene":{read:{source:"layerDefinition.featureReduction"},write:{target:"layerDefinition.featureReduction"}}}}})],b.prototype,"featureReduction",void 0);d([c.property({type:[M.default],json:{read:!1,origins:{"web-scene":{read:{source:"layerDefinition.rangeInfos"},write:{target:"layerDefinition.rangeInfos"}}}}})],b.prototype,"rangeInfos",void 0);d([c.property({json:{read:!1}})],b.prototype,"associatedLayer",
void 0);d([c.property({type:["show","hide"]})],b.prototype,"listMode",void 0);d([c.property({type:["ArcGISSceneServiceLayer"]})],b.prototype,"operationalLayerType",void 0);d([c.property({json:{read:!1},readOnly:!0})],b.prototype,"type",void 0);d([c.property({type:[K]})],b.prototype,"fields",void 0);d([c.property({readOnly:!0})],b.prototype,"attributeStorageInfo",void 0);d([c.property({readOnly:!0})],b.prototype,"statisticsInfo",void 0);d([c.property({type:String,json:{origins:{service:{read:!1,write:!1}},
read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],b.prototype,"definitionExpression",void 0);d([c.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],b.prototype,"path",void 0);d([c.property(l.elevationInfo)],b.prototype,"elevationInfo",null);d([c.property({type:String,dependsOn:["profile"]})],b.prototype,"geometryType",null);d([c.property(l.labelsVisible)],b.prototype,"labelsVisible",void 0);d([c.property({type:[L],
json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:r.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:r.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],b.prototype,"labelingInfo",void 0);d([c.property(l.legendEnabled)],b.prototype,"legendEnabled",void 0);d([c.property({types:A.rendererTypes,json:{origins:{service:{read:{source:"drawingInfo.renderer",reader:t}}},read:{source:"layerDefinition.drawingInfo.renderer",
reader:t},write:{target:"layerDefinition.drawingInfo.renderer"}},value:null})],b.prototype,"renderer",null);d([c.property({json:{read:!1}})],b.prototype,"cachedDrawingInfo",void 0);d([c.reader("service","cachedDrawingInfo")],b.prototype,"readCachedDrawingInfo",null);d([c.property(l.popupEnabled)],b.prototype,"popupEnabled",void 0);d([c.property({type:z,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],b.prototype,"popupTemplate",void 0);d([c.property({readOnly:!0,json:{read:!1},dependsOn:["fields",
"title","attributeStorageInfo","associatedLayer"]})],b.prototype,"defaultPopupTemplate",null);d([c.property({type:String,json:{read:!1}})],b.prototype,"objectIdField",void 0);d([c.reader("service","objectIdField",["objectIdField","fields"])],b.prototype,"readObjectIdField",null);d([c.property({json:{read:!1}})],b.prototype,"objectIdFilter",void 0);d([c.property({type:String,json:{read:!1}})],b.prototype,"profile",void 0);d([c.reader("service","profile",["store.profile"])],b.prototype,"readProfile",
null);d([c.property({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],b.prototype,"normalReferenceFrame",void 0);d([c.property(H.screenSizePerspectiveEnabled)],b.prototype,"screenSizePerspectiveEnabled",void 0);return b=d([c.subclass()],b)}(c.declared(F,G))});