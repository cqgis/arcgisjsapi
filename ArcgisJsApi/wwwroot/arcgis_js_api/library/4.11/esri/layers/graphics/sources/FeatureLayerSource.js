// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper dojo/io-query ../../../request ../../../core/Accessor ../../../core/Error ../../../core/Loadable ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../tasks/QueryTask ../../../tasks/operations/queryAttachments".split(" "),function(r,t,v,n,l,w,h,x,u,y,m,e,z,A){Object.defineProperty(t,"__esModule",{value:!0});r=function(q){function b(){var a=
null!==q&&q.apply(this,arguments)||this;a.type="feature-layer";return a}v(b,q);b.prototype.load=function(){this.addResolvingPromise(this._fetchService());return this.when()};Object.defineProperty(b.prototype,"queryTask",{get:function(){var a=this.layer,c=a.parsedUrl,d=a.gdbVersion;return new z({url:null!=a.dynamicDataSource?c.path+"?"+w.objectToQuery(c.query):c.path,gdbVersion:d})},enumerable:!0,configurable:!0});b.prototype.addAttachment=function(a,c){var d=this;return this.load().then(function(){var b=
a.attributes[d.layer.objectIdField],f=d.layer.parsedUrl.path+"/"+b+"/addAttachment",g=l({f:"json"},d.layer.parsedUrl.query),g=d._getFormDataForAttachment(c,g);return h(f,{body:g}).then(function(a){return d._createFeatureEditResult(a.data.addAttachmentResult)}).catch(function(a){return m.reject(d._createAttachmentErrorResult(b,a))})})};b.prototype.updateAttachment=function(a,c,d){var b=this;return this.load().then(function(){var f=a.attributes[b.layer.objectIdField],p=b.layer.parsedUrl.path+"/"+f+
"/updateAttachment",k=l({f:"json"},b.layer.parsedUrl.query,{attachmentId:c}),k=b._getFormDataForAttachment(d,k);return h(p,{body:k}).then(function(a){return b._createFeatureEditResult(a.data.updateAttachmentResult)}).catch(function(a){return m.reject(b._createAttachmentErrorResult(f,a))})})};b.prototype.applyEdits=function(a){var c=this;return this.load().then(function(){var d=a.addFeatures.map(c._serializeFeature,c),b=a.updateFeatures.map(c._serializeFeature,c),f=c._getFeatureIds(a.deleteFeatures),
d={f:"json",adds:d.length?JSON.stringify(d):null,updates:b.length?JSON.stringify(b):null,deletes:f.length?f.join(","):null};return h(c.layer.parsedUrl.path+"/applyEdits",{query:d,method:"post",responseType:"json"})}).then(function(a){return c._createEditsResult(a)})};b.prototype.deleteAttachments=function(a,c){var d=this;return this.load().then(function(){var b=a.attributes[d.layer.objectIdField];return h(d.layer.parsedUrl.path+"/"+b+"/deleteAttachments",{query:l({f:"json"},d.layer.parsedUrl.query,
{attachmentIds:c.join(",")}),method:"post",responseType:"json"}).then(function(a){return a.data.deleteAttachmentResults.map(d._createFeatureEditResult)}).catch(function(a){return m.reject(d._createAttachmentErrorResult(b,a))})})};b.prototype.queryAttachments=function(a){var c=this,b=this.layer.parsedUrl,p=b.path;return this.load().then(function(){var d={query:l({},b.query,{f:"json"}),responseType:"json"};if(!c.layer.get("capabilities.operations.supportsQueryAttachments")){for(var g=a.objectIds,k=
[],e=0;e<g.length;e++)k.push(h(p+"/"+g[e]+"/attachments",d));return m.all(k).then(function(a){return g.map(function(c,b){return{parentObjectId:c,attachmentInfos:a[b].data.attachmentInfos}})}).then(function(a){return A.processAttachmentQueryResult(a,p)})}return c.queryTask.executeAttachmentQuery(a,d)})};b.prototype.queryFeatures=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.execute(a,c)})};b.prototype.queryFeaturesJSON=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeJSON(a,
c)})};b.prototype.queryObjectIds=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForIds(a,c)})};b.prototype.queryFeatureCount=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForCount(a,c)})};b.prototype.queryExtent=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForExtent(a,c)})};b.prototype.queryRelatedFeatures=function(a){var c=this;return this.load().then(function(){return c.queryTask.executeRelationshipQuery(a)})};
b.prototype._fetchService=function(){var a=this,c=this.layer.resourceInfo;return c?(this.layerDefinition=c,m.resolve()):h(this.layer.parsedUrl.path,{query:l({f:"json"},this.layer.parsedUrl.query),responseType:"json"}).then(function(c){a.layerDefinition=c.data})};b.prototype._serializeFeature=function(a){var c=a.geometry;a=a.attributes;return c?"mesh"===c.type||"extent"===c.type?null:{geometry:c.toJSON(),attributes:a}:{attributes:a}};b.prototype._getFeatureIds=function(a){var c=a[0];return c?"objectId"in
c?this._getIdsFromFeatureIdentifier(a):this._getIdsFromFeatures(a):[]};b.prototype._getIdsFromFeatures=function(a){var c=this.layer.objectIdField;return a.map(function(a){return a.attributes&&a.attributes[c]})};b.prototype._getIdsFromFeatureIdentifier=function(a){return a.map(function(a){return a.objectId})};b.prototype._createEditsResult=function(a){a=a.data;return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,
this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=function(a){var c=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:c?new u("feature-layer-source:edit-failure",c.description,{code:c.code}):null}};b.prototype._createAttachmentErrorResult=function(a,c){return{objectId:a,globalId:null,error:new u("feature-layer-source:attachment-failure",c.details.messages&&
c.details.messages[0]||c.message,{code:c.details.httpStatus||c.details.messageCode})}};b.prototype._getFormDataForAttachment=function(a,c){if(a=a instanceof FormData?a:a&&a.elements?new FormData(a):null)for(var b in c){var e=c[b];null!=e&&(a.set?a.set(b,e):a.append(b,e))}return a};n([e.property()],b.prototype,"type",void 0);n([e.property({constructOnly:!0})],b.prototype,"layer",void 0);n([e.property({readOnly:!0,dependsOn:["layer.parsedUrl","layer.gdbVersion","layer.dynamicDataSource"]})],b.prototype,
"queryTask",null);return b=n([e.subclass("esri.layers.graphics.sources.FeatureLayerSource")],b)}(e.declared(x,y));t.default=r});