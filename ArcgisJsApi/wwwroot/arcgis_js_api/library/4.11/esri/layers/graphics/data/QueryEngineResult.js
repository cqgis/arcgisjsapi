// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper @dojo/framework/shim/Set ../../../core/maybe ../../../core/promiseUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils".split(" "),function(B,C,D,H,I,r,E,y,J,F,K,G,L,l){Object.defineProperty(C,"__esModule",{value:!0});B=function(){function e(a,b,d){this.items=a;this.queryGeometry=b;this.definitionExpression=
d.definitionExpression;this.geometryType=d.geometryType;this.hasM=d.hasM;this.hasZ=d.hasZ;this.objectIdField=d.objectIdField;this.spatialReference=d.spatialReference;this.fieldsMap=d.fieldsMap;this.timeInfo=d.timeInfo}Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0});e.prototype.createQueryResponse=function(a){var b;b=a.outStatistics?a.outStatistics.some(function(a){return"exceedslimit"===a.statisticType})?this._createExceedsLimitQueryResponse(a):
this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(y.isValid(a.outSR)&&!y.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=l.cleanFromGeometryEngine(D({spatialReference:a.outSR},G.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR))):b.queryGeometry=l.cleanFromGeometryEngine(D({spatialReference:a.outSR},this.queryGeometry)));return b};e.prototype.executeAttributesQuery=function(a){var b=K.getWhereClause(a.where);
if(!b)return r.resolve(this);if(b.isStandardized()){for(var d=0,h=[],c=0,f=this.items;c<f.length;c++){var g=f[c];b.testFeature(g.attributes)&&(h[d++]=g)}b=new e(h,this.queryGeometry,this);b.definitionExpression=a.where;return r.resolve(b)}return r.reject(new TypeError("Where clause is not standardized"))};e.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return r.resolve(this);var b=new H.default(a.objectIds);return r.resolve(new e(this.items.filter(function(a){return b.has(a.objectId)}),
this.queryGeometry,this))};e.prototype.executeTimeQuery=function(a){a=L.getTimeOperator(this.timeInfo,a.timeExtent);if(!I.isSome(a))return r.resolve(this);a=this.items.filter(a);return r.resolve(new e(a,this.queryGeometry,this))};e.prototype.project=function(a){var b=this;return!a||y.equals(this.spatialReference,a)?r.resolve(this):G.projectMany(this.items.map(function(a){return l.getGeometry(b,a)}),this.spatialReference,a).then(function(d){for(var h=[],c=0;c<b.items.length;c++)h[c]={attributes:b.items[c].attributes,
geometry:d[c]};d=[];J.convertFromFeatures(d,h,b.geometryType,b.hasZ,b.hasM,b.objectIdField);return new e(d,b.queryGeometry,{definitionExpression:b.definitionExpression,geometryType:b.geometryType,hasM:b.hasM,hasZ:b.hasZ,objectIdField:b.objectIdField,spatialReference:a,fieldsMap:b.fieldsMap,timeInfo:b.timeInfo})})};e.prototype._createFeatureQueryResponse=function(a){var b=this,d=this.items,h=this.geometryType,c=this.hasM,f=this.hasZ,g=this.objectIdField,v=this.spatialReference,k=a.outFields,e=a.outSR,
q=a.quantizationParameters,m=a.resultRecordCount,n=a.resultOffset,u=!1;null!=m&&null!=n&&(m=n+m,u=d.length>m,d=d.slice(n,Math.min(d.length,m)));return{exceededTransferLimit:u,features:this._createFeatures(a,d),fields:k&&k.map(function(a){return b.fieldsMap.get(a)}),geometryType:h,hasM:c,hasZ:f,objectIdFieldName:g,spatialReference:l.cleanFromGeometryEngine(e?e:v),transform:q&&E.toQuantizationTransform(q)||null}};e.prototype._createFeatures=function(a,b){var d=new F.default(a,this.fieldsMap),h=a.quantizationParameters,
c=a.returnGeometry,f=a.returnCentroid,g=a.maxAllowableOffset,v=a.orderByFields;a=[];var k=0;if(b.length&&v&&v.length){var v=v[0].split(" "),e=v[0],q="DESC"===v[1];b.sort(function(a,b){a=d.getFieldValue(a,e);b=d.getFieldValue(b,e);if("number"===typeof a&&"number"===typeof b)return q?b-a:a-b;if("string"===typeof a&&"string"===typeof b)return a=a.toUpperCase(),b=b.toUpperCase(),(q?a>b:a<b)?-1:(q?a<b:a>b)?1:0})}if(c||f)if(h=E.toQuantizationTransform(h),c&&!f)for(f=0;f<b.length;f++)c=b[f],a[k++]={attributes:d.getAttributes(c),
geometry:l.getGeometry(this,c,g,h)};else if(!c&&f)for(g=0;g<b.length;g++)c=b[g],a[k++]={attributes:d.getAttributes(c),centroid:l.getCentroid(this,c,h)};else for(f=0;f<b.length;f++)c=b[f],a[k++]={attributes:d.getAttributes(c),centroid:l.getCentroid(this,c,h),geometry:l.getGeometry(this,c,g,h)};else for(g=0;g<b.length;g++)c=b[g],(c=d.getAttributes(c))&&(a[k++]={attributes:c});return a};e.prototype._createExceedsLimitQueryResponse=function(a){var b=!1,d=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY,
b=Number.POSITIVE_INFINITY,c=0;for(a=a.outStatistics;c<a.length;c++){var f=a[c];if("exceedslimit"===f.statisticType){d=null!=f.maxPointCount?f.maxPointCount:Number.POSITIVE_INFINITY;h=null!=f.maxRecordCount?f.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=f.maxVertexCount?f.maxVertexCount:Number.POSITIVE_INFINITY;break}}"esriGeometryPoint"===this.geometryType?b=this.items.length>d:this.items.length>h?b=!0:(d=this.hasZ?this.hasM?4:3:this.hasM?3:2,b=this.items.reduce(function(a,b){return a+(b.geometry&&
b.geometry.coords.length||0)},0)/d>b);return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};e.prototype._createStatisticsQueryResponse=function(a){var b=new F.default(a,this.fieldsMap),d=[],h=[],c=a.groupByFieldsForStatistics,f=a.having,g=c&&c.length,c=g&&c[0],e={},k={},r={},q={attributes:{}},m=0;for(a=a.outStatistics;m<a.length;m++){var n=a[m],u=n.outStatisticFieldName,
l=n.statisticType,t="exceedslimit"!==n.statisticType?n.onStatisticField:void 0,x="1"===t;if(g&&(t===c||x)&&"count"===n.statisticType){e[t]||(e[t]=this._calculateUniqueValues(b,x?c:t));var l=e[t],A;for(A in l){var p=l[A],z=p.count,n=p.data,w=p.items,p=k[n]||{attributes:{}};if(!f||b.validateItems(w,f))p.attributes[u]=z,p.attributes[x?"EXPR_1":t]=n,k[n]=p}h.push({name:u,alias:u,type:"esriFieldTypeString"})}else{if(g)for(A in x=this._calculateUniqueValues(b,c),x){if(p=x[A],n=p.data,w=p.items,!f||b.validateItems(w,
f))p=k[n]||{attributes:{}},w=this._calculateStatistics(w,b,t),z="var"===l?"variance":l,p.attributes[u]=w[z],p.attributes[c]=n,k[n]=p}else r[t]||(r[t]=this._calculateStatistics(this.items,b,t)),w=r[t],z="var"===l?"variance":l,q.attributes[u]=w[z];h.push({name:u,alias:u,type:"esriFieldTypeDouble"})}}if(g)for(var y in k)d.push(k[y]);else d.push(q);return{fields:h,features:d}};e.prototype._calculateStatistics=function(a,b,d){for(var h=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,f=null,g=null,
e=null,k=null,l=[],q=0;q<a.length;q++){var m=b.getFieldValue(a[q],d);null==m||isNaN(m)||(f+=m,h=Math.min(h,m),c=Math.max(c,m),l.push(m))}if(a=l.length){g=f/a;for(k=e=0;k<l.length;k++)m=l[k],e+=Math.pow(m-g,2);k=1<a?e/(a-1):0;e=Math.sqrt(k)}else c=h=null;return{avg:g,count:a,max:c,min:h,stddev:e,sum:f,variance:k}};e.prototype._calculateUniqueValues=function(a,b){for(var d={},e=0,c=this.items;e<c.length;e++){var f=c[e],g=a.getFieldValue(f,b);if(null==g||"string"===typeof g&&""===g.trim())g=null;null==
d[g]?d[g]={count:1,data:g,items:[f]}:(d[g].count++,d[g].items.push(f))}return d};return e}();C.default=B});