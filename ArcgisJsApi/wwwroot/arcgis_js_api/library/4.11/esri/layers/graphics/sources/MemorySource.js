// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../geometry ../../../Graphic ../../../core/Accessor ../../../core/Collection ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/typescript ../../../tasks/support/FeatureSet module".split(" "),
function(x,r,y,g,p,v,f,z,t,A,B,C,w,D,E,m,F,G,H,I){Object.defineProperty(r,"__esModule",{value:!0});var J=0,u=C.getLogger("esri.layers.graphics.sources.MemorySource");f=function(f){function b(){var a=null!==f&&f.apply(this,arguments)||this;a._idToClientGraphic=null;a.type="memory";return a}y(b,f);b.prototype.load=function(){var a=this,c;c=w.resolve();this.addResolvingPromise(c.then(function(){return E.open(D.getAbsMid("./support/MemorySourceWorker",x,I),{strategy:A("esri-workers-for-memory-layers")?
"dedicated":"local"}).then(function(c){a._connection=c;var b=a.layer,d=b.fields,e=b.spatialReference,h=b.objectIdField,k=b.hasM,l=b.hasZ,b=b.timeInfo,K="defaults"===a.layer.originOf("spatialReference"),q=a._prepareAddFeatures(a.items);a.on("before-changes",function(a){u.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead");a.preventDefault()});d={features:q.features,fields:d&&d.map(function(a){return a.toJSON()}),geometryType:p.typeKebabDictionary.toJSON(a.workerGeometryType),
hasM:k,hasZ:l,objectIdField:h,spatialReference:K?null:e&&e.toJSON(),timeInfo:b?b.toJSON():null};return c.invoke("load",d).then(function(c){for(var b=0,d=c.warnings;b<d.length;b++)u.warn(d[b].message,{layer:a.layer});c.featureErrors.length&&u.warn("Encountered "+c.featureErrors.length+" validation errors while loading features",c.featureErrors);b=c.layerDefinition;a._geometryTypeRequiresClientGraphicMapping(q.inferredGeometryType)&&(b.geometryType=p.typeKebabDictionary.toJSON(q.inferredGeometryType));
a.layerDefinition=b;a._requiresClientGraphicMapping()&&(a._idToClientGraphic=new Map);q.finish(c.assignedObjectIds)})})}));return this.when()};Object.defineProperty(b.prototype,"workerGeometryType",{get:function(){var a=this.layer&&this.layer.geometryType;return a?this._geometryTypeRequiresClientGraphicMapping(a)?"polygon":a:null},enumerable:!0,configurable:!0});b.prototype.applyEdits=function(a){var c=this;return this.load().then(function(){return c._applyEdits(a)})};b.prototype.openPorts=function(){var a=
this;return this.load().then(function(){return a._connection.openPorts()})};b.prototype.queryFeatures=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null)}).then(function(a){a=H.fromJSON(a);if(!c._requiresClientGraphicMapping())return a;for(var b=c.layer.objectIdField,d=0,e=a.features;d<e.length;d++){var h=e[d],k=c._idToClientGraphic.get(h.attributes[b]);k&&(h.geometry=k.geometry)}a.geometryType=c.layer.geometryType;return a})};b.prototype.queryFeaturesJSON=
function(a){var c=this;return this._requiresClientGraphicMapping()?w.reject(new t("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)")):this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null)})};b.prototype.queryFeatureCount=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatureCount",a?a.toJSON():null)})};b.prototype.queryObjectIds=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryObjectIds",
a?a.toJSON():null)})};b.prototype.queryExtent=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryExtent",a?a.toJSON():null)}).then(function(a){return{count:a.count,extent:p.Extent.fromJSON(a.extent)}})};b.prototype._applyEdits=function(a){var c=this;if(!this._connection)throw new t("feature-layer-source:edit-failure","Memory source not loaded");var b=this.layer.objectIdField,n=null,f=[],e=[];a.addFeatures&&(n=this._prepareAddFeatures(a.addFeatures));if(a.deleteFeatures)for(var h=
0,k=a.deleteFeatures;h<k.length;h++){var l=k[h];"objectId"in l&&null!=l.objectId?f.push(l.objectId):"attributes"in l&&null!=l.attributes[b]&&f.push(l.attributes[b])}if(a.updateFeatures)for(b=0,a=a.updateFeatures;b<a.length;b++)l=a[b],e.push(this._serializeFeature(l));return this._connection.invoke("applyEdits",{adds:n?n.features:[],updates:e,deletes:f}).then(function(a){var b=a.featureEditResults;c.fullExtent=a.fullExtent;n&&n.finish(b.uidToObjectId);if(c._idToClientGraphic){a=0;for(var d=b.deleteResults;a<
d.length;a++){var e=d[a];e.success&&c._idToClientGraphic.delete(e.objectId)}}return c._createEditsResult(b)})};b.prototype._createEditsResult=function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=function(a){var b=!0===
a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new t("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};b.prototype._prepareAddFeatures=function(a){for(var b=new Map,d=Array(a.length),f=null,g=0;g<a.length;g++){var e=a[g],h=this._serializeFeature(e);!f&&e.geometry&&(f=e.geometry.type);d[g]=h;b.set(""+h.uid,e)}var k=this;return{features:d,inferredGeometryType:f,finish:function(a){var c=k.layerDefinition.objectIdField,
d;for(d in a){var f=a[d],e=b.get(d);e&&(e.attributes||(e.attributes={}),-1===f?delete e.attributes[c]:e.attributes[c]=f,k._addIdToClientGraphic(e))}}}};b.prototype._addIdToClientGraphic=function(a){if(this._idToClientGraphic){var b=this.layerDefinition.objectIdField,b=a.attributes&&a.attributes[b];null!=b&&this._idToClientGraphic.set(b,a)}};b.prototype._requiresClientGraphicMapping=function(){return this._geometryTypeRequiresClientGraphicMapping(this.layer.geometryType||this.layerDefinition.geometryType)};
b.prototype._geometryRequiresClientGraphicMapping=function(a){return this._geometryTypeRequiresClientGraphicMapping(a.type)};b.prototype._geometryTypeRequiresClientGraphicMapping=function(a){return"mesh"===a||"multipatch"===a||"extent"===a};b.prototype._serializeFeature=function(a){var b=a.attributes;a=this._geometryForSerialization(a);var d=(J++).toString();return a?{uid:d,geometry:a.toJSON(),attributes:b}:{uid:d,attributes:b}};b.prototype._geometryForSerialization=function(a){return(a=a.geometry)?
this._geometryRequiresClientGraphicMapping(a)?p.Polygon.fromExtent(a.extent):a:null};g([G.shared({Type:v,ensureType:F.ensureType(v)})],b.prototype,"itemType",void 0);g([m.property()],b.prototype,"type",void 0);g([m.property({constructOnly:!0})],b.prototype,"layer",void 0);g([m.property({readOnly:!0,dependsOn:["layer.geometryType"]})],b.prototype,"workerGeometryType",null);g([m.property()],b.prototype,"layerDefinition",void 0);return b=g([m.subclass("esri.layers.graphics.sources.MemorySource")],b)}(m.declared(f,
z,B));r.MemorySource=f;r.default=f});