// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../geometry ../../../core/Accessor ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/workers ../../../core/accessorSupport/decorators ../data/QueryEngineCapabilities ../../support/TimeInfo ../../../tasks/support/FeatureSet module".split(" "),
function(x,h,y,e,z,A,p,d,m,B,C,D,E,F,G,f,H,I,J,K){Object.defineProperty(h,"__esModule",{value:!0});var u=D.getLogger("esri.layers.graphics.sources.GeoJSONSource");d=function(d){function b(){var a=null!==d&&d.apply(this,arguments)||this;a.type="geojson";a.fullExtent=null;a.timeInfo=null;return a}y(b,d);b.prototype.load=function(){var a=this,c;c=E.resolve();this.addResolvingPromise(c.then(function(){return G.open(F.getAbsMid("./geojson/GeoJSONSourceWorker",x,K),{strategy:B("esri-workers-for-memory-layers")?
"dedicated":"local"}).then(function(c){return A(a,void 0,void 0,function(){var a,b,r,d,k,f,g,t,e,w,l,q,h,m;return z(this,function(v){switch(v.label){case 0:return this._connection=c,a=this.layer,b=a.fields,r=a.spatialReference,d=a.hasZ,k=a.geometryType,f=a.objectIdField,g=a.url,t=a.timeInfo,e="defaults"===this.layer.originOf("spatialReference"),w={url:g,fields:b&&b.map(function(a){return a.toJSON()}),geometryType:p.typeKebabDictionary.toJSON(k),hasZ:d,objectIdField:f,timeInfo:t?t.toJSON():null,spatialReference:e?
null:r&&r.toJSON()},[4,c.invoke("load",w)];case 1:l=v.sent();q=0;for(h=l.warnings;q<h.length;q++)m=h[q],u.warn(m.message,{layer:this.layer});l.featureErrors.length&&u.warn("Encountered "+l.featureErrors.length+" validation errors while loading features",l.featureErrors);this.fullExtent=p.Extent.fromJSON(l.layerDefinition.extent);this.timeInfo=I.fromJSON(l.layerDefinition.timeInfo);this.layerDefinition=l.layerDefinition;this.capabilities={data:{supportsAttachment:!1,supportsM:!1,supportsZ:l.layerDefinition.hasZ},
operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsUpdate:!0,supportsExceedsLimitStatistics:!0},query:H.queryCapabilities,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0},editing:{supportsGeometryUpdate:!0,supportsGlobalId:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,
supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}};return[2]}})})})}));return this.when()};b.prototype.applyEdits=function(a,b){var c=this;return this.load().then(function(){return c._applyEdits(a,b)})};b.prototype.openPorts=function(){var a=this;return this.load().then(function(){return a._connection.openPorts()})};b.prototype.queryFeatures=function(a,b){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null,b)}).then(function(a){return J.fromJSON(a)})};
b.prototype.queryFeaturesJSON=function(a,b){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null,b)})};b.prototype.queryFeatureCount=function(a,b){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatureCount",a?a.toJSON():null,b)})};b.prototype.queryObjectIds=function(a,b){var c=this;return this.load().then(function(){return c._connection.invoke("queryObjectIds",a?a.toJSON():null,b)})};b.prototype.queryExtent=function(a,
b){var c=this;return this.load().then(function(){return c._connection.invoke("queryExtent",a?a.toJSON():null,b)}).then(function(a){return{count:a.count,extent:p.Extent.fromJSON(a.extent)}})};b.prototype._applyEdits=function(a,b){var c=this;if(!this._connection)throw new m("geojson-layer-source:edit-failure","Memory source not loaded");var d=this.layer.objectIdField,f=[],e=[],h=[];if(a.addFeatures)for(var k=0,n=a.addFeatures;k<n.length;k++){var g=n[k];f.push(this._serializeFeature(g))}if(a.deleteFeatures)for(k=
0,n=a.deleteFeatures;k<n.length;k++)g=n[k],"objectId"in g&&null!=g.objectId?e.push(g.objectId):"attributes"in g&&null!=g.attributes[d]&&e.push(g.attributes[d]);if(a.updateFeatures)for(d=0,a=a.updateFeatures;d<a.length;d++)g=a[d],h.push(this._serializeFeature(g));return this._connection.invoke("applyEdits",{adds:f,updates:h,deletes:e},b).then(function(a){var b=a.timeExtent,d=a.featureEditResults;c.fullExtent=a.fullExtent;c.timeInfo&&(a=c.timeInfo.clone(),a.read({timeExtent:b}),c.timeInfo=a);return c._createEditsResult(d)})};
b.prototype._createEditsResult=function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=function(a){var b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?
new m("geojson-layer-source:edit-failure",b.description,{code:b.code}):null}};b.prototype._serializeFeature=function(a){var b=a.attributes;return(a=this._geometryForSerialization(a))?{geometry:a.toJSON(),attributes:b}:{attributes:b}};b.prototype._geometryForSerialization=function(a){return(a=a.geometry)?"mesh"===a.type||"extent"===a.type?p.Polygon.fromExtent(a.extent):a:null};e([f.property()],b.prototype,"capabilities",void 0);e([f.property()],b.prototype,"type",void 0);e([f.property()],b.prototype,
"fullExtent",void 0);e([f.property({constructOnly:!0})],b.prototype,"layer",void 0);e([f.property()],b.prototype,"layerDefinition",void 0);e([f.property()],b.prototype,"timeInfo",void 0);return b=e([f.subclass("esri.layers.graphics.sources.GeoJSONSource")],b)}(f.declared(d,C));h.GeoJSONSource=d;h.default=d});