// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper @dojo/framework/shim/array @dojo/framework/shim/Map @dojo/framework/shim/Set ../../../core/asyncUtils ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/MemCache ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/PromiseQueue".split(" "),
function(C,D,J,K,E,t,w,p,x,L,F,l,G,m,M,H,z,n,I,N,r,u,O,f,P){function A(e,a,b,c,d,g,v,k,h){h||(h=Q);v&&!g?c.forEachInBounds(d,function(d){if(!a.has(d.objectId)){var c=f.getCentroid(b,d,k),g=d.attributes;c&&(a.add(d.objectId),e.push(new B(g,null,c,h(d))))}}):g&&!v?c.forEachInBounds(d,function(d){if(!a.has(d.objectId)){var c=d.attributes,g=f.getGeometry(b,d,0,k);g&&(a.add(d.objectId),e.push(new B(c,g,null,h(d))))}}):c.forEachInBounds(d,function(d){if(!a.has(d.objectId)){var c=d.attributes,g=f.getGeometry(b,
d,0,k),v=f.getCentroid(b,d,k);g&&v&&(a.add(d.objectId),e.push(new B(c,g,v,h(d))))}})}Object.defineProperty(D,"__esModule",{value:!0});var Q=function(e){return 1},R=L.getLogger("esri.layers.graphics.data.QueryEngine"),B=function(){return function(e,a,b,c){this.attributes=e;this.geometry=a;this.centroid=b;this.filterFlags=c}}(),y=new t.default,S=new F.Storage(2E6),T=0;C=function(){function e(a){var b=this;this.capabilities={query:N.queryCapabilities};this.fieldsMap=new E.default;this.geometryType=a.geometryType;
this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.cacheSpatialQueries=a.cacheSpatialQueries||!1;this.gdbVersion=a.gdbVersion;this.historicMoment=a.historicMoment;this.featureStore=a.featureStore;this.featureStore.setEngine(this);this.timeInfo=a.timeInfo;this.cacheSpatialQueries&&(this._geometryQueryCache=new F(T++ +"$$",S));a.fields.forEach(function(a){b.fieldsMap.set(a.name.trim(),a);
b.fieldsMap.set(a.name.trim().toLowerCase(),a)});a.scheduler&&a.priority&&(this._frameQueue=new P.PromiseQueue,this._frameTask=a.scheduler.registerTask(a.priority,function(a){return b._update(a)},function(){return 0<b._frameQueue.length}))}e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null);this.clearCache();this._geometryQueryCache&&this._geometryQueryCache.destroy();this.fieldsMap.clear()};Object.defineProperty(e.prototype,
"fullExtent",{get:function(){var a=this.featureStore.fullBounds;return a?{xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:f.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=O.getTimeExtent(this.timeInfo,this.featureStore):null},enumerable:!0,configurable:!0});e.prototype.clearCache=function(){this._geometryQueryCache&&
this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};e.prototype.executeQuery=function(a){var b=this;void 0===a&&(a={});var c=x.clone(a);return w.safeCast(f.normalizeQuery(c,this.definitionExpression,this.spatialReference)).then(function(a){return b._schedule(a)}).then(function(a){return b._checkQuerySupport(a)}).then(function(a){return b._reschedule(a)}).then(function(a){return b._executeGeometryQuery(a)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeObjectIdsQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeTimeQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeAttributesQuery(c)}).catch(function(a){if(a===
f.QUERY_ENGINE_EMPTY_RESULT)return new r.default([],null,b);throw a;}).then(function(a){return a.createQueryResponse(c)})};e.prototype.executeQueryForCount=function(a){var b=this;void 0===a&&(a={});var c=x.clone(a);c.returnGeometry=!1;c.returnCentroid=!1;c.outSR=null;return w.safeCast(f.normalizeQuery(c,this.definitionExpression,this.spatialReference)).then(function(a){return b._schedule(a)}).then(function(a){return b._checkQuerySupport(a)}).then(function(a){return b._reschedule(a)}).then(function(a){return b._executeGeometryQuery(a)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeObjectIdsQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeTimeQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeAttributesQuery(c)}).then(function(a){return a.size}).catch(function(a){if(a===
f.QUERY_ENGINE_EMPTY_RESULT)return 0;throw a;})};e.prototype.executeQueryForExtent=function(a){var b=this;void 0===a&&(a={});var c=x.clone(a),d=c.outSR;return w.safeCast(f.normalizeQuery(c,this.definitionExpression,this.spatialReference)).then(function(a){return b._schedule(a)}).then(function(a){return b._checkQuerySupport(a)}).then(function(){c.returnGeometry=!0;c.returnCentroid=!1;c.outSR=null;return c}).then(function(a){return b._reschedule(a)}).then(function(a){return b._executeGeometryQuery(a)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeObjectIdsQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeTimeQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeAttributesQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){var c=
a.size;if(!c)return{count:c,extent:null};var g={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:f.cleanFromGeometryEngine(b.spatialReference)};b.featureStore.forEachBounds(a.items,function(a){g.xmin=Math.min(a[0],g.xmin);g.ymin=Math.min(a[1],g.ymin);g.xmax=Math.max(a[2],g.xmax);g.ymax=Math.max(a[3],g.ymax)});a=I.project(g,a.spatialReference,d);a.spatialReference=f.cleanFromGeometryEngine(d||b.spatialReference);
if(0===a.xmax-a.xmin){var h=G.getMetersPerUnitForSR(a.spatialReference);a.xmin-=h;a.xmax+=h}0===a.ymax-a.ymin&&(h=G.getMetersPerUnitForSR(a.spatialReference),a.ymin-=h,a.ymax+=h);return{count:c,extent:a}}).catch(function(a){if(a===f.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw a;})};e.prototype.executeQueryForIds=function(a){void 0===a&&(a={});return this.executeQueryForIdSet(a).then(function(a){return K.from(a)})};e.prototype.executeQueryForIdSet=function(a){var b=this;void 0===a&&
(a={});var c=x.clone(a);c.returnGeometry=!1;c.returnCentroid=!1;c.outSR=null;return w.safeCast(f.normalizeQuery(c,this.definitionExpression,this.spatialReference)).then(function(a){return b._schedule(a)}).then(function(a){return b._executeGeometryQuery(a)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeObjectIdsQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeTimeQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){return a.executeAttributesQuery(c)}).then(function(a){return b._reschedule(a)}).then(function(a){a=
a.items;for(var b=new t.default,c=0;c<a.length;c++)b.add(a[c].objectId);return b}).catch(function(a){if(a===f.QUERY_ENGINE_EMPTY_RESULT)return new t.default;throw a;})};e.prototype.executeTileQuery=function(a,b,c){var d=this;void 0===c&&(c=null);var g=b.returnGeometry,e=b.returnCentroid,k=b.pixelBuffer;b=new t.default;var h=[],k=k*a.resolution,q=m.pad(a.bounds,k,m.create());A(h,b,this,this.featureStore,q,g,e,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},
c);if("esriGeometryPoint"===this.geometryType||e){var l=z.getInfo(this.spatialReference);if(l){var f=l.valid,l=f[0],f=f[1];if(q[0]<l){var n=m.fromValues(f-k,q[1],f,q[3]);A(h,b,this,this.featureStore,n,g,e,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[f,a.bounds[3]]},c)}q[2]>f&&(k=m.fromValues(l,q[1],l+k,q[3]),A(h,b,this,this.featureStore,k,g,e,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[l-f+a.bounds[0],a.bounds[3]]},c))}}h.sort(function(a,b){return a.attributes[d.objectIdField]-
b.attributes[d.objectIdField]});return{features:h,objectIds:b}};e.prototype.executeTileQueryForIds=function(a,b){a=m.pad(a.bounds,b.pixelBuffer*a.resolution,m.create());var c=[];this.featureStore.forEachInBounds(a,function(a){return c.push(a.objectId)});return c};e.prototype.executeQueryForLatestObservations=function(a){var b=this;if(this.timeInfo)return this.executeQuery(a).then(function(a){return b._filterLatest(a,b.timeInfo)});R.error(new p("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))};
e.prototype._schedule=function(a){return this._frameQueue?this._frameQueue.push(a).then(function(a){return a}):l.resolve(a)};e.prototype._reschedule=function(a){return this._frameQueue?this._frameQueue.push(a).then(function(a){return a}):l.resolve(a)};e.prototype._update=function(a){for(this._budget=a;!a.done&&this._frameQueue.process();)a.madeProgress();this._budget=null};e.prototype._filterLatest=function(a,b){var c=b.trackIdField,d=b.startTimeField;b=b.endTimeField||d;for(var d=new E.default,g=
[],e=0,k=a.features;e<k.length;e++){var h=k[e],f=h.attributes[c],l=h.attributes[b];(!d.has(f)||d.get(f).attributes[b]<l)&&d.set(f,h)}d.forEach(function(a){return g.push(a)});return J({},a,{features:g})};e.prototype._getAll=function(){if(!this._allItems){var a=[];this.featureStore.forEach(function(b){return a.push(b)});this._allItems=new r.default(a,null,this)}return this._allItems};e.prototype._executeGeometryQuery=function(a){var b=this,c=a.geometry,d=a.outSR,g=a.spatialRel,e=z.isValid(d)&&!z.equals(this.spatialReference,
d),k=this.cacheSpatialQueries?e?JSON.stringify({geometry:c,spatialRelationship:g,outSpatialReference:d}):JSON.stringify({geometry:c,spatialRelationship:g}):null;if(k){var h=this._geometryQueryCache.get(k);if(void 0!==h)return l.resolve(h)}var f=function(c){if(e&&(a.returnGeometry||a.returnCentroid))return c.project(d).then(function(a){k&&b._geometryQueryCache.put(k,a,a.size||1);return a});k&&b._geometryQueryCache.put(k,c,c.size||1);return c};if(!c)return l.resolve(this._getAll()).then(function(a){return f(a)});
if("esriSpatialRelDisjoint"===g){h=this._searchFeatures(this._getQueryBBoxes(c));if(!h.length)return l.resolve(this._getAll()).then(function(a){return f(a)});var m,n;return this._reschedule(h).then(function(a){return new t.default(a)}).then(function(a){return b._reschedule(a)}).then(function(a){var c=0;m=Array(a.size);b.featureStore.forEach(function(a){return m[c++]=a});n=a}).then(function(){return b._reschedule()}).then(function(){return u.getSpatialQueryOperator(g,c,b)}).then(function(a){return b._runSpatialFilter(m,
function(b){return!n.has(b)||a(b.geometry)}).then(function(a){return new r.default(a,c,b)}).then(function(a){return f(a)})})}var p=this._searchFeatures(this._getQueryBBoxes(c));return p.length?this._canExecuteSoloPass(c,a)?l.resolve(new r.default(p,c,this)).then(function(a){return f(a)}):u.getSpatialQueryOperator(g,c,this).then(function(a){return b._runSpatialFilter(p,function(b){return a(b.geometry)})}).then(function(a){return new r.default(a,c,b)}).then(function(a){return f(a)}):(h=new r.default([],
c,this),k&&this._geometryQueryCache.put(k,h,h.size||1),l.resolve(h))};e.prototype._runSpatialFilter=function(a,b){var c=this;if(!b)return l.resolve(a);if(!this._budget)return l.resolve(a.filter(function(a){return b(a)}));var d=0,g=[],e=function(){for(;d<a.length;){var f=a[d];b(f)&&g.push(f);if(c._budget.done)return c._reschedule().then(function(){return e()});++d}return l.resolve()};return this._reschedule().then(function(){return e()}).then(function(){return g})};e.prototype._canExecuteSoloPass=
function(a,b){var c=this.geometryType;b=b.spatialRel;return u.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===b||"esriGeometryPoint"===c&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b||"esriSpatialRelWithin"===b))};e.prototype._getQueryBBoxes=function(a){if(u.canQueryWithRBush(a)){if(H.isExtent(a))return[m.fromValues(a.xmin,a.ymin,a.xmax,a.ymax)];if(H.isPolygon(a))return a.rings.map(function(a){return m.fromValues(a[0][0],a[0][1],a[2][0],a[2][1])})}return[M.getBoundsXY(m.create(),
a)]};e.prototype._searchFeatures=function(a){for(var b=0;b<a.length;b++)this.featureStore.forEachInBounds(a[b],function(a){y.add(a)});var c=Array(y.size),d=0;y.forEach(function(a){return c[d++]=a});y.clear();return c};e.prototype._checkQuerySupport=function(a){return 0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text?l.reject(new p("feature-store:unsupported-query","Unsupported query options",{query:a})):l.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),
u.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),I.checkProjectionSupport(this.spatialReference,a.outSR)]).then(function(){return a})};e.prototype._checkAttributesQuerySupport=function(a){var b=a.outFields,c=a.orderByFields,d=a.returnDistinctValues;c&&0<c.length&&(c=c.map(function(a){return-1<a.indexOf(" ASC")?a.split(" ASC")[0]:-1<a.indexOf(" DESC")?a.split(" DESC")[0]:a}),n.validateFields(this.fieldsMap,c,"orderByFields contains missing fields"));if(b&&0<b.length)n.validateFields(this.fieldsMap,
b,"outFields contains missing fields");else if(d)throw new p("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});n.validateWhere(this.fieldsMap,a.where)};e.prototype._checkStatisticsQuerySupport=function(a){var b=a.outStatistics,c=a.groupByFieldsForStatistics,d=a.having,e=c&&c.length,f=b&&b.length;if(d){if(!e||!f)return l.reject(new p("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a}));
n.validateHaving(this.fieldsMap,d,b)}if(f&&!b.some(function(a){return"exceedslimit"===a.statisticType}))for(d=b.map(function(a){return a.onStatisticField}),n.validateFields(this.fieldsMap,d,"onStatisticFields contains missing fields"),e&&n.validateFields(this.fieldsMap,c,"groupByFieldsForStatistics contains missing fields"),c=0;c<b.length;c++){var d=b[c],f=d.onStatisticField,k=d.statisticType;if("exceedslimit"===k)return l.reject(new p("feature-store:unsupported-query","statistic type exceedslimit is not supported",
{definition:d,query:a}));if((!e||"count"!==k)&&f&&n.hasInvalidFieldType(f,this.fieldsMap))return l.reject(new p("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:d,query:a}))}};return e}();D.default=C});