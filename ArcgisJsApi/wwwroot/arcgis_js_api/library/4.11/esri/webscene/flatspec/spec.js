// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/extendsHelper ../../core/Error ../../core/promiseUtils ../schema ./utils".split(" "),function(A,q,g,f,B,u,n,m,v){function C(b,a){if(a.properties){if("layerType"in a.properties)return a.properties.layerType.enum[0];if("type"in a.properties)return a.properties.type.enum[0]}switch(b){case "multipoint_geometry_schema.json":return"multipoint";case "point_geometry_schema.json":return"point";
case "polyline_geometry_schema.json":return"polyline";case "polygon_geometry_schema.json":return"polygon";case "extent_schema.json":return"extent"}}function D(b){var a={count:b.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},c=new Set,d;for(d in b){var e=b[d];e.$ref?a.refsCount++:e.type&&(a.typesCount++,c.add(e.type))}c.forEach(function(b){return a.distinctTypes.push(b)});a.distinctTypes.sort();a.refsCount===a.count?a.type="refs":2===a.count&&0<a.refsCount&&1===a.distinctTypes.length&&
"null"===a.distinctTypes[0]?a.type="refsAndNull":a.typesCount===a.count?(a.type="types",a.distinctTypes=a.distinctTypes):a.type="mix";return a}function w(b,a,c,d){return f(this,void 0,void 0,function(){var e,h,k;return g(this,function(x){switch(x.label){case 0:e=C(b,a);c=c?c.replace("\x3c?TYPE?\x3e",e?"\x3c"+e+"\x3e":""):null;if("array"===a.type||!("properties"in a))return r(a,c,d),[2,null];if((h="drawingInfo_schema.json"!==b&&!d.hasFilteredProperties&&d.seen.get(b))&&c)return d.addProperty({name:c,
type:h}),[2,h];k={type:b,name:b,properties:[]};c&&d.addProperty({name:c,type:k});d.push(c,k);return[4,r(a,"",d)];case 1:return x.sent(),[2,d.pop()]}})})}function y(b,a,c){return f(this,void 0,void 0,function(){var d;return g(this,function(e){switch(e.label){case 0:return[4,c.requestSchema(b.$ref)];case 1:return d=e.sent(),[2,w(d.schemaId,d.schema,a,c)]}})})}function E(b,a){if(!t(b))return!1;b=b.stack.map(function(a){return a.klass.type}).join("/");return/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(b)&&
"renderer"===a}function F(b,a){if(!t(b))return!1;b=b.stack.map(function(a){return a.klass.type}).join("/");return/.*rasterDataLayer_schema\/.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(b)&&"renderer"===a}function t(b){return"drawingInfo_schema.json"===b.currentClass.name}function G(b,a,c){var d=t(c),e=E(c,a),h=F(c,a);return d?b.filter(function(a){var b="#/definitions/pointCloudRenderers_schema.json"===a.$ref||/\#\/definitions\/pointCloud.*Renderer/.test(a.$ref);a="#/definitions/rasterRenderers_schema.json"===
a.$ref||/\#\/definitions\/raster.*Renderer/.test(a.$ref);return e===b&&a===h}):b}function H(b,a,c){return f(this,void 0,void 0,function(){return g(this,function(d){switch(d.label){case 0:return[4,r(b.items,a+"[]",c)];case 1:return d.sent(),[2]}})})}function I(b,a,c){return f(this,void 0,void 0,function(){var d=this;return g(this,function(e){switch(e.label){case 0:return[4,c.withFilteredProperties(null,function(e){return f(d,void 0,void 0,function(){var d,h,l,f,p;return g(this,function(k){switch(k.label){case 0:d=
[];for(h in b.properties)d.push(h);l=0;k.label=1;case 1:if(!(l<d.length))return[3,4];f=d[l];if(e&&!e.has(f))return[3,3];p=a?a+"."+f:f;return[4,r(b.properties[f],p,c)];case 2:k.sent(),k.label=3;case 3:return l++,[3,1];case 4:return[2]}})})})];case 1:return e.sent(),[2]}})})}function J(b,a,c){return f(this,void 0,void 0,function(){var d,e,h,k,f,l;return g(this,function(g){switch(g.label){case 0:d=null;e=new Set;h=0;for(k=b.allOf;h<k.length;h++)if(f=k[h],"$ref"in f){if(d)throw Error("Cannot process more than 1 ref in an allOf construct");
d=f}else if("properties"in f)for(l in f.properties)e.add(l);else throw Error("allOf construct only allows simple top-level property filters");return[4,c.withFilteredProperties(e,function(){return y(d,a,c)})];case 1:return g.sent(),[2]}})})}function K(b,a,c){return f(this,void 0,void 0,function(){var d,e,h,k,f,l,n,p,m,q;return g(this,function(g){switch(g.label){case 0:d=D(b.oneOf);if("refs"!==d.type&&"refsAndNull"!==d.type)return[3,6];e=G(b.oneOf,a,c);h=0;k=e;g.label=1;case 1:if(!(h<k.length))return[3,
5];f=k[h];return"null"!==f.type?[3,2]:[3,4];case 2:return[4,r(f,a+"\x3c?TYPE?\x3e",c)];case 3:g.sent(),g.label=4;case 4:return h++,[3,1];case 5:return[2];case 6:if("types"===d.type)return c.addProperty({name:a,type:d.distinctTypes.join("|")}),[2];l=[];for(n in b.oneOf)l.push(n);p=0;g.label=7;case 7:if(!(p<l.length))return[3,10];m=l[p];q=".oneOf["+m+"]";return[4,r(b.oneOf[m],""+a+q,c)];case 8:g.sent(),g.label=9;case 9:return p++,[3,7];case 10:return[2]}})})}function L(b,a,c){return f(this,void 0,void 0,
function(){return g(this,function(d){switch(d.label){case 0:return[4,y(b,a,c)];case 1:return d.sent(),[2]}})})}function M(b,a,c){return f(this,void 0,void 0,function(){var d,e;return g(this,function(h){d="unknown";b.type&&(d=Array.isArray(b.type)?b.type.join("|"):b.type.replace(/ /g,"").split(",").join("|"));e={name:a,type:d,default:b.default};b.enum&&(e.enum=v.sorted(b.enum).map(function(a){return"string"===typeof a?'"'+a+'"':""+a}).join("|"));c.addProperty(e);return[2]})})}function r(b,a,c){return f(this,
void 0,void 0,function(){return g(this,function(d){return"array"===b.type?[2,H(b,a,c)]:"properties"in b?[2,I(b,a,c)]:"allOf"in b?[2,J(b,a,c)]:"oneOf"in b?[2,K(b,a,c)]:"$ref"in b?[2,L(b,a,c)]:[2,M(b,a,c)]})})}function z(b){return 0===b.indexOf("#/definitions/")?b.slice(14):b}Object.defineProperty(q,"__esModule",{value:!0});q.scan=function(b,a){return f(this,void 0,void 0,function(){var c;return g(this,function(d){switch(d.label){case 0:return[4,N.create(b,a)];case 1:return c=d.sent(),[2,w((b||"webScene")+
"_schema.json",c.schemaRoot,null,c)]}})})};var N=function(b){function a(a,d,e){var c=b.call(this)||this;c.definitions=a;c.schemaRoot=d;c.requestSchema=e;c.filteredProperties=null;c.requestSchema.bind(c);return c}B(a,b);Object.defineProperty(a.prototype,"hasFilteredProperties",{get:function(){return this.filteredProperties&&0<this.filteredProperties.size},enumerable:!0,configurable:!0});a.prototype.withFilteredProperties=function(a,b){var c=this.filteredProperties;this.filteredProperties=a;a=b(c);
this.filteredProperties=c;return a};a.create=function(b,d){return f(this,void 0,void 0,function(){return g(this,function(c){return d&&d.useRemoteSchema?[2,a.createRemote(b,d.baseUrl)]:[2,a.createLocal(b)]})})};a.createLocal=function(b){return new a(m.json.definitions,b?m.json.definitions[b+"_schema.json"]:m.json,a.getLocalSchemaRequest())};a.createRemote=function(b,d){return f(this,void 0,void 0,function(){var c,f,k;return g(this,function(e){switch(e.label){case 0:return[4,a.getRemoteSchemaRequest(d)];
case 1:return c=e.sent(),f=new a({},null,c),[4,f.requestSchema((b||"webscene")+"_schema.json")];case 2:return k=e.sent().schema,[2,new a(f.definitions,k,c)]}})})};a.getLocalSchemaRequest=function(){return function(a){a=z(a);var b=this.definitions[a];return b?n.resolve({schemaId:a,schema:b}):n.reject(new u("flatspec-spec:invalid-local-schema","Schema reference is not a local reference"))}};a.getRemoteSchemaRequest=function(b){return f(this,void 0,void 0,function(){var c,e;return g(this,function(d){switch(d.label){case 0:if(!b)return[2,
n.reject(new u("flatspec-spec:missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"))];c=a.getLocalSchemaRequest();return[4,n.create(function(a){return A(["../../request"],a)})];case 1:return e=d.sent(),[2,function(a){var d=this;return c.call(this,a).catch(function(){return e(b+"/"+a,{responseType:"json"}).then(function(b){d.definitions[z(a)]=b.data;return{schemaId:a,schema:b.data}})})}]}})})};return a}(v.ScanContext);q.schemaDefinitions=Object.keys(m.json.definitions).map(function(b){return b.replace(/_schema\.json$/,
"")})});