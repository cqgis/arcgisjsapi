// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../Basemap ../Viewpoint ../core/Collection ../core/collectionUtils ../core/JSONSupport ../core/lang ../core/Logger ../core/promiseUtils ../core/accessorSupport/decorators ../core/accessorSupport/ensureType ../core/libs/gl-matrix-2/vec3 ../core/libs/gl-matrix-2/vec3f64 ../layers/Layer ../support/basemapUtils ../views/3d/support/mathUtils ../webdoc/support/Thumbnail ./Environment ./Lighting ./support/Description ./support/SlideGround ./support/Title".split(" "),
function(Q,R,t,u,f,F,G,v,H,w,I,J,g,e,m,x,p,K,y,L,k,z,M,n,A,l){function B(d){if("building-scene"===d.type||"map-image"===d.type)return d.allSublayers}function C(d){if(d=B(d))return d.filter(function(b){return b.visible}).map(function(b){return b.id}).toArray()}function N(d,b){d=b-d;d>D&&(d-=r);d<-D&&(d+=r);return d}var O=0,E=function(d){function b(a){a=d.call(this)||this;a.id="";a.sublayerIds=null;return a}u(b,d);a=b;b.prototype.clone=function(){return new a({id:this.id,sublayerIds:I.clone(this.sublayerIds)})};
var a;f([e.property({type:String,json:{write:!0}})],b.prototype,"id",void 0);f([e.property({type:[Number],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],b.prototype,"sublayerIds",void 0);return b=a=f([e.subclass("esri.webscene.VisibleLayer")],b)}(e.declared(w)),q=v.ofType(E),P=J.getLogger("esri.webscene.Slide"),r=86400,D=43200;return function(d){function b(a){a=d.call(this,a)||this;a._currentAnimation=null;a.id=Date.now().toString(16)+"-slide-"+O++;a.title=new l.default;a.description=
new n.default;a.thumbnail=new k.default;a.viewpoint=null;a.basemap=null;a.ground=null;a.environment=new z;a.visibleLayers=new q;return a}u(b,d);b.prototype.castTitle=function(a){return"string"===typeof a?new l.default({text:a}):m.ensureType(l.default,a)};b.prototype.castDescription=function(a){return"string"===typeof a?new n.default({text:a}):m.ensureType(n.default,a)};b.prototype.castThumbnail=function(a){return"string"===typeof a?new k.default({url:a}):m.ensureType(k.default,a)};b.prototype.castBasemap=
function(a){return y.ensureType(a)};Object.defineProperty(b.prototype,"visibleLayers",{set:function(a){this._set("visibleLayers",H.referenceSetter(a,this._get("visibleLayers"),q))},enumerable:!0,configurable:!0});b.prototype.castVisibleLayers=function(a){return a&&"function"===typeof a.map?a.map(function(a){if("string"===typeof a)return{id:a};if(a instanceof K){var b=C(a);return{id:a.id,sublayerIds:b}}if(a.id)return{id:a.id,sublayerIds:a.sublayerIds};P.warn('Invalid visible layer, expected { id }, Layer or "id"');
return a}):null};b.prototype.clone=function(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})};b.prototype._updateVisibleLayersFrom=function(a){var b=
this,c=[];return g.eachAlways(this._allLayers(a.map).map(function(b){return a.whenLayerView(b).then(function(a){if(a.visible){var h=C(b);c.push(new E({id:a.layer.id,sublayerIds:h}))}})}).toArray()).then(function(){b.visibleLayers.removeAll();b.visibleLayers.addMany(c)})};b.prototype.updateFrom=function(a,b){var c=this;b={screenshot:t({format:"jpeg",quality:80,width:120,height:75,disableSlice:!0},b&&b.screenshot)};return a.when(function(){c.viewpoint=a.viewpoint.clone();c.environment.lighting=M.prototype.clone.apply(a.environment.lighting);
c.basemap=a.map.basemap&&a.map.basemap.clone()||null;c.ground=a.map.ground?A.default.fromGround(a.map.ground):null;return c._updateVisibleLayersFrom(a)}).then(function(){return a.takeScreenshot(b.screenshot)}).then(function(a){c.thumbnail=new k.default({url:a.dataUrl});return c})};b.prototype.applyTo=function(a,b){var c=this,h=t({animate:!0},b);return this._applyBasemap(a).then(function(){return g.all([c._applyViewpoint(a,h),c._applyLayerVisibility(a),c._applyGround(a)])}).then(function(){return c})};
b.prototype._applyBasemap=function(a){var b=this;return this.basemap?this.basemap.load().catch(function(a){return a}).then(function(){a.map.basemap=y.clonePreservingTiledLayers(b.basemap,a.map.basemap)}):g.resolve()};b.prototype._applyGround=function(a){this.ground&&(a.map.ground=this.ground.cloneAndApplyTo(a.map.ground));return g.resolve()};b.prototype._allLayers=function(a){var b=new v;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};b.prototype._collectLayers=function(a,b){var c=
this;a.layers.forEach(function(a){b.add(a);a.layers&&c._collectLayers(a,b)})};b.prototype._applyLayerVisibility=function(a){var b=this;this.visibleLayers&&this._allLayers(a.map).forEach(function(a){var c=b.visibleLayers.find(function(b){return b.id===a.id});a.visible=null!=c;var d=c&&c.sublayerIds,c=B(a);d&&c&&c.forEach(function(a){return a.visible=0<=d.indexOf(a.id)})})};b.prototype._applyViewpoint=function(a,b){if(this.viewpoint&&!b.ignoreViewpoint){this.viewpoint.camera.fov=a.camera.fov;if(b.animate){if(this.get("environment.lighting.date"))return this._animateToLighting(a,
b);a.environment.lighting=this.environment.lighting.clone();return a.goTo(this.viewpoint,b)}a.viewpoint=this.viewpoint}a.environment.lighting=this.environment.lighting.clone();return g.resolve()};b.prototype._animateToLighting=function(a,b){var c=this,d;"global"===a.viewingMode&&(d=this._animateLightingWithCamera(a));this._currentAnimation&&(this._currentAnimation.cancel(),this._currentAnimation=null);a.environment.lighting.cameraTrackingEnabled=!1;a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;
null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);var e=a.goTo(this.viewpoint,b);this._currentAnimation=e;this._currentAnimation.catch(function(a){return a}).then(function(){d&&d.remove();c._currentAnimation===e&&(a.environment.lighting.cameraTrackingEnabled=!0)});this._currentAnimation.then(function(){a.environment.lighting=c.environment.lighting.clone()});return this._currentAnimation};b.prototype._getTime=function(a){var b=
a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};b.prototype._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);return a};b.prototype._animateLightingWithCamera=function(a){var b=this,c=this._getTime(new Date(a.environment.lighting.date.toString())),d=c[0],e=c[1],c=this._getTime(this.environment.lighting.date),f=c[0],k=N(e,c[1]),g=a.renderCoordsHelper,l=p.vec3f64.create();g.toRenderCoords(a.camera.position,
l);var n=p.vec3f64.create();g.toRenderCoords(this.viewpoint.camera.position,n);var m=p.vec3f64.create(),q=new Date;return a.watch("camera",function(c){g.toRenderCoords(c.position,m);var h=x.vec3.squaredDistance(l,m),p=x.vec3.squaredDistance(n,m);c=0;0!==h+p&&(c=h/(h+p));h=d+(f-d)*c;c=L.moduloPositive(e+k*c,r);a.environment.lighting.date=b._setTime(q,h,c)})};b.createFrom=function(a,b){return(new this).updateFrom(a,b)};f([e.property({type:String,json:{write:{isRequired:!0}}})],b.prototype,"id",void 0);
f([e.property({type:l.default,json:{default:function(){return new l.default({text:""})},write:{isRequired:!0}}})],b.prototype,"title",void 0);f([e.cast("title")],b.prototype,"castTitle",null);f([e.property({type:n.default,json:{write:{overridePolicy:function(a){return{enabled:!(!a||!a.text)}}}}})],b.prototype,"description",void 0);f([e.cast("description")],b.prototype,"castDescription",null);f([e.property({type:k.default,json:{default:function(){return new k.default({url:""})},write:{isRequired:!0}}})],
b.prototype,"thumbnail",void 0);f([e.cast("thumbnail")],b.prototype,"castThumbnail",null);f([e.property({type:G,nonNullable:!0,json:{write:{isRequired:!0}}})],b.prototype,"viewpoint",void 0);f([e.property({type:F,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],b.prototype,"basemap",void 0);f([e.cast("basemap")],b.prototype,"castBasemap",null);f([e.property({type:A.default,json:{write:!0}})],b.prototype,"ground",void 0);f([e.property({type:q,json:{write:{isRequired:!0}}})],b.prototype,"visibleLayers",
null);f([e.cast("visibleLayers")],b.prototype,"castVisibleLayers",null);f([e.property({type:z,json:{write:!0}})],b.prototype,"environment",void 0);return b=f([e.subclass("esri.webscene.Slide")],b)}(e.declared(w))});