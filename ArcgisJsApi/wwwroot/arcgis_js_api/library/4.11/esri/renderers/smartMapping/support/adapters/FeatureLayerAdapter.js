// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../geometry ../../../../core/Error ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/quantizationUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/arcgisLayerUrl ../../../../layers/support/fieldUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/predominanceUtils ./support/utils ../../../../tasks/GenerateRendererTask ../../../../tasks/support/GenerateRendererParameters ../../../../tasks/support/QuantizationParameters ../../../../tasks/support/Query ../../../../tasks/support/StatisticDefinition ../../../../tasks/support/UniqueValueDefinition".split(" "),
function(P,Q,r,G,C,H,m,g,u,t,D,E,I,w,l,J,K,z,k,L,A,M,N,B,O){return function(F){function e(a){return F.call(this,a)||this}G(e,F);e.prototype.destroy=function(){this._hasLocalSource=null};e.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!I.isHostedAgolService(a.url)&&10.5>a.version?g.reject(new m("feature-layer-adapter:not-supported","Layer does not support statistics query")):g.resolve()};e.prototype._fetchFeaturesFromMemory=
function(a,c){var b=this.layer;return this._hasLocalSource?g.resolve(b.source):a?a.whenLayerView(b).then(function(a){var b=u.whenFalseOnce(a,"updating").then(function(){return a.queryFeatures(c)}).then(function(a){return a.features});g.timeout(b,1E4,null);return b}):g.reject(new m("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};e.prototype._fetchFeaturesForStats=function(a){var c=this,b=this.layer,d=J.getFieldsList({field:a.field,normalizationField:a.normalizationField,
valueExpression:a.valueExpression}),b=b.createQuery();b.returnGeometry=!1;b.outFields=d;return this.layer.queryFeatures(b).then(function(a){return a&&a.features}).catch(function(b){return c._fetchFeaturesFromMemory(a.view)})};e.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:
void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,c,d;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(d=b.maxValue-b.minValue,c=b.minValue+d/2,d*=4);return k.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:d})})};e.prototype._getSummaryStatsQuery=function(a,c){var b=a.field,d=(c=this.supportsSQLExpression&&c?k.msSinceUnixEpochSQL(this,b):a.sqlExpression)||b,b=d?l.getRangeExpr(d,a.minValue,a.maxValue):null;a=l.mergeWhereClauses(a.sqlWhere,
b);b=this.layer.createQuery();b.where=l.mergeWhereClauses(b.where,a);b.sqlFormat=c?"standard":null;b.outStatistics=k.statisticTypes.map(function(a){var b=new B;b.statisticType="variance"===a?"var":a;b.onStatisticField=d;b.outStatisticFieldName=a+"_value";return b});return b};e.prototype._summaryStatsFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getSummaryStatsQuery(a,c))}).then(function(a){return k.getSummaryStatisticsFromFeatureSet(a,
c)}).then(k.processSummaryStatisticsResult)};e.prototype._summaryStatsFromClientQuery=function(a,c){var b=this,d=a.view;return d?d.whenLayerView(this.layer).then(function(d){var f=u.whenFalseOnce(d,"updating").then(function(){return d.queryFeaturesJSON(b._getSummaryStatsQuery(a,c))}).then(function(a){return k.getSummaryStatisticsFromFeatureSet(a,c)}).then(k.processSummaryStatisticsResult);g.timeout(f,1E4,null);return f}):g.reject(new m("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};
e.prototype._summaryStatsFromMemory=function(a,c){var b=a.field,d=a.valueExpression,f=(d||a.sqlExpression)&&!a.sqlExpression,h=a.view,d={field:b,valueExpression:d,normalizationField:a.normalizationField,view:h};return(this._hasLocalSource||a.features||"function"!==typeof b&&!f?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(h):this._fetchFeaturesForStats(d)).then(function(d){if(!d||!d.length)return g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));
var f=r({},a);if("percent-of-total"===f.normalizationType){var h=k.calculateStatsFromMemory({field:b},d).sum;if(null==h)return g.reject(new m("feature-layer-adapter:invalid","invalid normalizationTotal"));f.normalizationTotal=h}d=k.calculateStatsFromMemory(f,d,c);return k.processSummaryStatisticsResult(d)})};e.prototype._uvFromGenRenderer=function(a,c){var b=this,d=a.field,f=new O;f.attributeField=d;var h=new A;h.classificationDefinition=f;return this.generateRenderer(h).then(function(a){var c={},
f=b.getField(d);a.uniqueValues.forEach(function(a){var b=a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:w.isNumericField(f)&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return k.createUVResult(b,"service-generate-renderer",c,a.returnAllCodedValues)})};e.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,d="countOF"+(c||"Expr"),f=new B;f.statisticType="count";f.onStatisticField=
b?"1":c;f.outStatisticFieldName=d;d=this.layer.createQuery();d.where=l.mergeWhereClauses(d.where,a.sqlWhere);d.sqlFormat=b?"standard":null;d.outStatistics=[f];d.groupByFieldsForStatistics=[c||b];return d};e.prototype._uvFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a))}).then(function(c){return k.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return k.createUVResult(b,"service-query",c,a.returnAllCodedValues)})};
e.prototype._uvFromClientQuery=function(a,c){var b=this,d=a.view;return d?d.whenLayerView(this.layer).then(function(d){var f=u.whenFalseOnce(d,"updating").then(function(){return d.queryFeaturesJSON(b._getUVQuery(a))}).then(function(c){return k.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return k.createUVResult(b,"service-query",c,a.returnAllCodedValues)});g.timeout(f,1E4,null);return f}):g.reject(new m("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};
e.prototype._uvFromMemory=function(a,c){var b=a.valueExpression,d=a.sqlExpression,f=a.view,h={field:a.field,valueExpression:b,view:f};return(this._hasLocalSource||a.features||!b||d?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(f):this._fetchFeaturesForStats(h)).then(function(b){return k.calculateUniqueValuesFromMemory(a,b,c)})};e.prototype._calcBinsSQL=function(a,c){var b=[],d=c.length;c.forEach(function(c,h){c=l.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(h===d-1?" \x3c\x3d ":" \x3c ")+
c[1]);b.push("WHEN ("+c+") THEN "+(h+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};e.prototype._getNormalizationTotal=function(a,c){return a&&"percent-of-total"===c?this.summaryStatistics({field:a}).then(function(a){return a.sum}):g.resolve(null)};e.prototype._getQueryParamsForExpr=function(a,c){if(!a.valueExpression&&!a.sqlExpression){var b=a.field,d=b?this.getField(b):null,d=w.isDateField(d);c={field:b,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:c};
return{sqlExpression:d?k.msSinceUnixEpochSQL(this,b):k.getFieldExpr(c),sqlWhere:d?null:a.sqlWhere||l.getSQLFilterForNormalization(a)}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere}};e.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?g.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};e.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType).then(function(b){var d=
c._getQueryParamsForExpr(a,b);return c._getDataRange(d,a.minValue,a.maxValue).then(function(f){var h=f.min,p=f.max,e=a.numBins||10;f=k.getEqualIntervalBins(h,p,e);f=c._calcBinsSQL(d.sqlExpression,f);var g=new B({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),n=c.layer.createQuery();n.where=l.mergeWhereClauses(n.where,d.sqlWhere);n.sqlFormat="standard";n.outStatistics=[g];n.groupByFieldsForStatistics=[f];n.orderByFields=[f];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(n)}).then(function(a){return k.getHistogramFromFeatureSet(a,
h,p,e,b)})})})};e.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?g.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){return a.count?{min:a.min,max:a.max}:g.reject(new m("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field"))});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins)})};e.prototype._getBins=function(a,
c,b){void 0===b&&(b=10);var d=a.min,f=a.max,h=a.normTotal,p=a.excludeZerosExpr,e=a.intervals||k.getEqualIntervalBins(d,f,b);return this._queryBins(e,a.sqlExpr||c,p).then(function(a){return{bins:a.map(function(a,b){return{minValue:e[b][0],maxValue:e[b][1],count:a.value}}),minValue:d,maxValue:f,normalizationTotal:h}})};e.prototype._queryBins=function(a,c,b){for(var d=this,f=[],h=a.length,e=0;e<h;e++){var k=l.mergeWhereClauses(b,l.mergeWhereClauses(c+" \x3e\x3d "+a[e][0],null!==a[e][1]?c+(e===h-1?" \x3c\x3d ":
" \x3c ")+a[e][1]:""));f.push(k)}return g.eachAlways(f.map(function(a){return d.queryFeatureCount(a)}))};e.prototype._binParamsFromGenRend=function(a,c){var b=a.field,d=a.normalizationType,f=a.normalizationField,h=l.getSQLFilterForNormalization({field:b,normalizationType:d,normalizationField:f});a=new A({classificationDefinition:k.createCBDefn({field:b,normalizationType:d,normalizationField:f,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||
10}),where:l.mergeWhereClauses(h,c)});return this.generateRenderer(a).then(function(a){return k.generateBinParams({field:b,normalizationType:d,normalizationField:f,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:h})})};e.prototype._histogramFromMemory=function(a){var c=this,b=a.field,d=a.normalizationType,f=a.valueExpression,h=a.classificationMethod,e=a.minValue,q=a.maxValue,v=a.view,n=f&&!a.sqlExpression,l={field:b,valueExpression:f,normalizationField:a.normalizationField,
view:v};return(this._hasLocalSource||a.features||!n?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(v):this._fetchFeaturesForStats(l)).then(function(p){if(!p||!p.length)return g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"));var n=null!=e&&null!=q,l=null;h&&"equal-interval"!==h||d?(n=r({},a),n.features=p,l=c._getBinParamsFromMemory(n)):l=n?g.resolve({min:e,max:q,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:f,
features:p,view:v}).then(function(a){return a.count?{min:a.min,max:a.max}:g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return l.then(function(b){return k.calculateHistogramFromMemory(a,b,p)})})};e.prototype._getBinParamsFromMemory=function(a){var c=a.field,b=a.normalizationType,d=a.normalizationField;return this._classBreaksFromMemory({field:c,valueExpression:a.valueExpression,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,
standardDeviationInterval:a.standardDeviationInterval,minValue:a.minValue,maxValue:a.maxValue,numClasses:a.numBins,features:a.features,view:a.view}).then(function(a){var f=a.normalizationTotal;a=a.classBreakInfos;var e=l.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d});return k.generateBinParams({field:c,normalizationType:b,normalizationField:d,normalizationTotal:f,classBreaks:a,where:e})})};e.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,
d=a.normalizationField,f=a.normalizationTotal,h=l.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d}),f=k.getFieldExpr({field:c,normalizationType:b,normalizationField:d,normalizationTotal:f}),f=l.getRangeExpr(f,a.minValue,a.maxValue),c=k.createCBDefn({field:c,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new A;b.classificationDefinition=c;b.where=
l.mergeWhereClauses(h,f);return this.generateRenderer(b).then(function(b){return k.resolveCBResult(a,b)})};e.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,d=a.numClasses||5,f=[],h=(b-c)/d,e=0;e<d;e++){var q=c+e*h;f.push({minValue:q,maxValue:q+h})}f[d-1].maxValue=b;a=k.resolveCBResult(a,{classBreaks:f,normalizationTotal:a.normalizationTotal});return g.resolve(a)};e.prototype._classBreaksFromMemory=function(a){var c=a.field,b=a.valueExpression,d=a.view,f={field:c,
valueExpression:b,normalizationField:a.normalizationField,view:d};return(this._hasLocalSource||a.features||!b?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(d):this._fetchFeaturesForStats(f)).then(function(b){if(!b||!b.length)return g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));var d=r({},a);if("percent-of-total"===d.normalizationType){var f=k.calculateStatsFromMemory({field:c},b).sum;if(null==f)return g.reject(new m("feature-layer-adapter:invalid",
"invalid normalizationTotal"));d.normalizationTotal=f}return k.calculateClassBreaksFromMemory(d,b)})};e.prototype._heatmapStatsFromMemory=function(a,c){var b=this,d=a.blurRadius,f=a.field,h=a.view,e=h.state,q=e.size,l=new M.default({extent:h.extent,tolerance:e.resolution}),e=new N({returnGeometry:!0,geometry:h.extent,quantizationParameters:l});return(a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(h,e)).then(function(a){a=b._quantizeFeatures(a,l,h);return a&&a.length?(a=k.calculateHeatmapStats(a,
d,c,f,q[0],q[1]))?{count:a.count,min:a.min,max:a.max,avg:a.mean,stddev:a.stdDev}:g.reject(new m("feature-layer-adapter:invalid","unable to calculate heatmap statistics")):{count:0,min:null,max:null,avg:null,stddev:null}})};e.prototype._quantizeFeatures=function(a,c,b){var d=this,f=D.toQuantizationTransform(c);c=b.spatialReference;var e=b.size,g=E.isWrappable(c);b=E.getInfo(c);var k=Math.round((b.valid[1]-b.valid[0])/f.scale[0]);return a.map(function(a){var b=new H.Point(a.geometry);D.quantizePoint(f,
b,b,b.hasZ,b.hasM);a.geometry=g?d._wrapPoint(b,k,e[0]):b;return a})};e.prototype._wrapPoint=function(a,c,b){0>a.x?a.x+=c:a.x>b&&(a.x-=c);return a};e.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};e.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};e.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,c)};e.prototype.summaryStatistics=
function(a){var c=this,b=a.field,d=b?this.getField(b):null,f=w.isDateField(d),e=(d=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,b="function"===typeof b||e,e=(e=a.view)&&"3d"===e.type;return this._hasLocalSource||a.features||b?b||a.features||e?this._summaryStatsFromMemory(a,f):this._summaryStatsFromClientQuery(a,f):this.supportsSQLExpression||!f&&!d?(a.normalizationType?this._summaryStatsFromGenRend(a):this._summaryStatsFromServiceQuery(a,f)).catch(function(b){return c._summaryStatsFromMemory(a,
f)}):g.reject(new m("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};e.prototype.uniqueValues=function(a){var c=this,b=a.field,d=a.valueExpression,f=a.sqlExpression,e=(b?this.getField(b):null)&&this.getFieldDomain(b),g=d&&(!f||!this.supportsSQLExpression),k=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||a.features||g?g||a.features||k?this._uvFromMemory(a,e):this._uvFromClientQuery(a,e):this._uvFromServiceQuery(a,e).catch(function(b){return a.field?
c._uvFromGenRenderer(a,e):b}).catch(function(b){return g||a.features||k?c._uvFromMemory(a,e):c._uvFromClientQuery(a,e)})};e.prototype.histogram=function(a){var c=this,b=a.field,d=a.normalizationType,e=a.normalizationField,h=a.classificationMethod,p=b?this.getField(b):null,p=w.isDateField(p),q=a.valueExpression||a.sqlExpression,v=q&&!a.sqlExpression,n=this.supportsSQLExpression,x=!h||"equal-interval"===h,r=a.minValue,y=a.maxValue,u=null!=r&&null!=y,t=a.numBins||10;return this._hasLocalSource||a.features||
v?this._histogramFromMemory(a):(q||n)&&x?q&&!n?g.reject(new m("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):p&&x?g.reject(new m("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):d||!x?this._binParamsFromGenRend(a).then(function(f){if(!u)return c._getBins(f,b,t);if(r>f.max||y<f.min)return g.reject(new m("histogram:insufficient-data",
"Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));if(x)return c._getBins({min:r,max:y,sqlExpr:f.sqlExpr,excludeZerosExpr:f.excludeZerosExpr},b,t);f=k.getFieldExpr({field:b,normalizationType:d,normalizationField:e,normalizationTotal:f.normTotal});f=l.getRangeExpr(f,r,y);return c._binParamsFromGenRend(a,f).then(function(a){return c._getBins(a,b,t)})}):this._histogramForField(a)};e.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,d=this._hasLocalSource||
a.features||a.valueExpression;return b&&d?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(b){return c._classBreaksFromMemory(a)})};e.prototype.queryFeatureCount=function(a){if(this._hasLocalSource)return g.reject(new m("feature-layer-adapter:not-supported","Layer does not support count query"));var c=this.layer,b=c.createQuery();b.where=l.mergeWhereClauses(b.where,a);return c.queryFeatureCount(b)};e.prototype.generateRenderer=
function(a){var c=this.layer;if(this._hasLocalSource||10.1>c.version)return g.reject(new m("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var b=new L({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion}),c=c.createQuery();a.where=l.mergeWhereClauses(a.where,c.where);return b.execute(a)};e.prototype.heatmapStatistics=function(a){var c=this,b=a.field,d=a.fieldOffset;return(b&&null==d?this.summaryStatistics({field:b}):
g.resolve(null)).then(function(b){var e=d||0;if(b){var f=b.min,g=b.max;b.count?f===g&&0===f?e=1:0>=g?e="abs":0>f&&(e=-1.01*f):e=1}return c._heatmapStatsFromMemory(a,e).then(function(a){return r({},a,{summaryStatistics:b,fieldOffset:e})})})};e.prototype.getPredominantCategories=function(a,c){if(!this._hasLocalSource&&!this.supportsSQLExpression)return g.reject(new m("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries"));var b=z.getArcadeForPredominantCategory(a),
d=z.getSQLForPredominantCategoryName(a),e=c&&"3d"===c.type;return(this._hasLocalSource?e?this._uvFromMemory({valueExpression:b,view:c}):this._uvFromClientQuery({valueExpression:b,view:c}):this._uvFromServiceQuery({sqlExpression:d.expression,valueExpression:b})).then(function(b){b=b.uniqueValueInfos;for(var c=b.map(function(a){return a.value}),d=0,e=a.filter(function(a){return-1===c.indexOf(a)});d<e.length;d++)b.push({value:e[d],count:0});b.sort(function(b,c){return a.indexOf(b.value)-a.indexOf(c.value)});
for(d=0;d<b.length;d++)e=b[d],e.value===z.noDominantCategoryField&&(e.value=null);return{predominantCategoryInfos:b}})};e.prototype.load=function(){var a=this,c=this.layer,b=c.load().then(function(){a.geometryType=c.geometryType;a.objectIdField=c.objectIdField;a.supportsSQLExpression=c.get("capabilities.query.supportsSqlExpression");a._hasLocalSource=!c.url&&!!c.source;a.hasQueryEngine=a._hasLocalSource});this.addResolvingPromise(b);return this.when()};C([t.property({constructOnly:!0})],e.prototype,
"layer",void 0);return e=C([t.subclass()],e)}(t.declared(K))});