// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper @dojo/framework/shim/array @dojo/framework/shim/Set ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/support/fieldUtils ../../support/arcadeUtils ./RefreshableLayerView ./support/FeatureEffect ./support/FeatureFilter ./support/popupUtils".split(" "),
function(K,L,B,c,M,u,l,C,D,p,E,w,r,F,d,g,G,H,I,J,t){var x=E.getLogger("esri.views.layers.FeatureLayerView");return function(y){function a(b){b=y.call(this,b)||this;b.effect=null;b.filter=null;b.layer=null;b.requiredFields=null;b.view=null;return b}B(a,y);a.prototype.initialize=function(){var b=this;F.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","filter","effect"],function(){return b._updateRequiredFields()})};Object.defineProperty(a.prototype,"availableFields",
{get:function(){var b=this.layer,a=this.layer.fields,e=this.requiredFields;return"outFields"in b&&b.outFields?g.fixFields(a,g.unpackFieldNames(a,b.outFields).concat(e)):g.fixFields(a,e)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(b){x.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeaturesExceeded",
{get:function(){return!1},enumerable:!0,configurable:!0});a.prototype.highlight=function(b,a){void 0===a&&(a={});return this.inherited(arguments)};a.prototype.queryFeatures=function(b){return this.inherited(arguments)};a.prototype.queryObjectIds=function(b){return this.inherited(arguments)};a.prototype.queryFeatureCount=function(b){return this.inherited(arguments)};a.prototype.queryExtent=function(b){return this.inherited(arguments)};a.prototype._updateRequiredFields=function(){return l(this,void 0,
void 0,function(){var b,a,e,m,v,d,c,f,q,h,n,k,A;return u(this,function(z){switch(z.label){case 0:if(!this.layer||!this.view)return[2];b="3d"===this.view.type;a=this;m=e=a.layer;v=m.fields;d=m.objectIdField;c=m.renderer;f=new D.default;return[4,r.eachAlways([c?c.collectRequiredFields(f,v):null,g.collectLabelingFields(f,e),b?g.collectElevationFields(f,e):null,this.filter?g.collectFilterFields(f,e,this.filter):null,this.effect?g.collectFilterFields(f,e,this.effect.filter):null])];case 1:q=z.sent();h=
0;for(n=q;h<n.length;h++)k=n[h],k.error&&x.error(k.error);g.collectField(f,v,d);A=C.from(f).sort();this._set("requiredFields",A);return[2]}})})};a.prototype.validateFetchPopupFeatures=function(a){var b=this.layer;if(!this.layer.popupEnabled)return new p("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:b});if(!t.getFetchPopupTemplate(this.layer,a))return new p("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:b})};a.prototype.fetchClientPopupFeatures=
function(a){return l(this,void 0,void 0,function(){var b,e,c,d,l,p,f,q,h,n,k;return u(this,function(m){switch(m.label){case 0:b=w.isSome(a)?a.clientGraphics:null;if(!b||0===b.length)return[2,r.resolve([])];e=[];c=[];d=this.layer;l=t.getFetchPopupTemplate(d,a);if(!w.isSome(l))return[2,r.resolve([])];p=G.hasGeometryOperations(l);return[4,this.createPopupQuery(a)];case 1:f=m.sent();q=g.unpackFieldNames(d.fields,f.outFields);h=0;for(n=b;h<n.length;h++)k=n[h],p||!g.featureHasFields(q,k)?c.push(k):e.push(k);
if(0===c.length)return[2,r.resolve(e)];f.objectIds=c.map(function(a){return a.attributes[d.objectIdField]});return[2,d.queryFeatures(f).then(function(a){return e.concat(a.features)}).catch(function(){return c})]}})})};a.prototype.createPopupQuery=function(a){return l(this,void 0,void 0,function(){var b,e,c;return u(this,function(d){switch(d.label){case 0:return b=this.layer,e=b.createQuery(),e.returnGeometry=!0,e.returnZ=!0,e.returnM=!0,c=e,[4,t.getRequiredFields(this.layer,t.getFetchPopupTemplate(this.layer,
a))];case 1:return c.outFields=d.sent(),e.outSpatialReference=this.view.spatialReference,[2,e]}})})};c([d.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],a.prototype,"availableFields",null);c([d.property({type:I})],a.prototype,"effect",void 0);c([d.property({type:J})],a.prototype,"filter",void 0);c([d.property()],a.prototype,"layer",void 0);c([d.property({type:Number})],a.prototype,"maximumNumberOfFeatures",null);c([d.property({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",
null);c([d.property({readOnly:!0})],a.prototype,"requiredFields",void 0);c([d.property()],a.prototype,"view",void 0);return a=c([d.subclass("esri.views.layers.FeatureLayerView")],a)}(d.declared(H))});