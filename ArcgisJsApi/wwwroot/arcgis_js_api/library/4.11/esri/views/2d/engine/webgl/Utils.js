// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../arcade/Dictionary ../../../../arcade/Feature ../../../../core/Error ../../../../core/Logger ../../../../core/screenUtils ../../../../geometry/support/quantizationUtils ../../../../support/arcadeUtils ./color ./enums ./SymbolProperties ../../../3d/support/mathUtils ../../../webgl/Texture".split(" "),function(u,a,N,O,P,y,Q,A,v,G,H,d,R,I,S){function k(c){for(var a={},f=0;f<c.length;f++){var e=c[f];a[e.name]=e.strideInBytes}return a}
function J(a){switch(a){case d.WGLGeometryType.MARKER:return T;case d.WGLGeometryType.FILL:return U;case d.WGLGeometryType.LINE:return V;case d.WGLGeometryType.TEXT:return W;case d.WGLGeometryType.LABEL:return X}return null}function K(a){switch(a%4){case 0:case 2:return 4;case 1:case 3:return 1}}function m(a){switch(a){case "esriSMS":return"simple-marker";case "esriPMS":return"picture-marker";case "esriSLS":return"simple-line";case "esriPLS":return"picture-line";case "esriSFS":return"simple-fill";
case "esriPFS":return"picture-fill";case "esriTS":return"text"}return a}function L(a){return"string"===typeof a}function M(a){var c={};switch(a){case "esriGeometryPoint":return function(a,b,h,g){return v.hydratePoint(b,c,a,h,g)};case "esriGeometryPolygon":return function(a,b,h,g){return v.hydratePolygon(b,c,a,h,g)};case "esriGeometryPolyline":return function(a,b,h,g){return v.hydratePolyline(b,c,a,h,g)};case "esriGeometryMultipoint":return function(a,b,h,g){return v.hydrateMultipoint(b,c,a,h,g)};
default:return w.error(new y("mapview-arcade","Unable to handle geometryType: "+a)),function(a,c,b,g){return a}}}function Y(a){var c={},f=function(b){var f=0;c[b]=a[b].map(function(a){var c=N({},a,{normalized:a.normalized||!1,divisor:a.divisor||0,offset:f,stride:0}),b=f,h=a.count;a:{switch(a.type){case 5120:case 5121:a=1;break a;case 5122:case 5123:a=2;break a;case 5126:case 5124:case 5125:a=4;break a}a=void 0}f=b+h*a;return c});c[b].forEach(function(a){return a.stride=f})},e;for(e in a)f(e);return c}
Object.defineProperty(a,"__esModule",{value:!0});var p,w=Q.getLogger("esri.views.2d.engine.webgl.Utils");a.C_HITTEST_SEARCH_SIZE=4;a.C_VBO_GEOMETRY="geometry";a.C_VBO_PERINSTANCE="per_instance";a.C_VBO_PERINSTANCE_VV="per_instance_vv";a.C_VBO_VISIBILITY="visibility";a.C_VBO_VISIBILITY_RANGE="visibilityRange";a.C_ICON_VERTEX_DEF=[{name:a.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_ICON_VERTEX_DEF_VV=[{name:a.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},
{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_FILL_VERTEX_DEF=[{name:a.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_FILL_VERTEX_DEF_VV=[{name:a.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_FILL_VERTEX_DEF_DD=[{name:a.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_LINE_VERTEX_DEF=[{name:a.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},
{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_LINE_VERTEX_DEF_VV=[{name:a.C_VBO_GEOMETRY,strideInBytes:44,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_TEXT_VERTEX_DEF=[{name:a.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_TEXT_VERTEX_DEF_VV=[{name:a.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}];a.C_LABEL_VERTEX_DEF=[{name:a.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},
{name:a.C_VBO_VISIBILITY,strideInBytes:1,divisor:0},{name:a.C_VBO_VISIBILITY_RANGE,strideInBytes:2,divisor:0}];a.C_ICON_STRIDE_SPEC=k(a.C_ICON_VERTEX_DEF);a.C_ICON_STRIDE_SPEC_VV=k(a.C_ICON_VERTEX_DEF_VV);a.C_FILL_STRIDE_SPEC=k(a.C_FILL_VERTEX_DEF);a.C_FILL_STRIDE_SPEC_VV=k(a.C_FILL_VERTEX_DEF_VV);a.C_FILL_STRIDE_SPEC_DD=k(a.C_FILL_VERTEX_DEF_DD);a.C_LINE_STRIDE_SPEC=k(a.C_LINE_VERTEX_DEF);a.C_LINE_STRIDE_SPEC_VV=k(a.C_LINE_VERTEX_DEF_VV);a.C_TEXT_STRIDE_SPEC=k(a.C_TEXT_VERTEX_DEF);a.C_TEXT_STRIDE_SPEC_VV=
k(a.C_TEXT_VERTEX_DEF_VV);a.C_LABEL_STRIDE_SPEC=k(a.C_LABEL_VERTEX_DEF);a.getStrides=function(c,b,f){switch(c){case d.WGLGeometryType.MARKER:return b?a.C_ICON_STRIDE_SPEC_VV:a.C_ICON_STRIDE_SPEC;case d.WGLGeometryType.FILL:return f?a.C_FILL_STRIDE_SPEC_DD:b?a.C_FILL_STRIDE_SPEC_VV:a.C_FILL_STRIDE_SPEC;case d.WGLGeometryType.LINE:return b?a.C_LINE_STRIDE_SPEC_VV:a.C_LINE_STRIDE_SPEC;case d.WGLGeometryType.TEXT:return b?a.C_TEXT_STRIDE_SPEC_VV:a.C_TEXT_STRIDE_SPEC;case d.WGLGeometryType.LABEL:return a.C_LABEL_STRIDE_SPEC}return null};
var T=[a.C_VBO_GEOMETRY,a.C_VBO_VISIBILITY],U=[a.C_VBO_GEOMETRY,a.C_VBO_VISIBILITY],V=[a.C_VBO_GEOMETRY,a.C_VBO_VISIBILITY],W=[a.C_VBO_GEOMETRY,a.C_VBO_VISIBILITY],X=[a.C_VBO_GEOMETRY,a.C_VBO_VISIBILITY,a.C_VBO_VISIBILITY_RANGE];a.getNamedBuffers=J;a.strideToPackingFactor=K;a.allocateTypedArrayBuffer=function(a,b){switch(b%4){case 0:case 2:return new Uint32Array(Math.floor(a*b/4));case 1:case 3:return new Uint8Array(a*b)}};a.allocateTypedArrayBufferwithData=function(a,b){switch(b%4){case 0:case 2:return new Uint32Array(a);
case 1:case 3:return new Uint8Array(a)}};a.normalizeSymbolType=m;a.isMarkerSymbol=function(a){if(a=m(a.type)){switch(a){case "simple-marker":case "picture-marker":return!0;case "CIMPointSymbol":return!0}return!1}};a.isFillSymbol=function(a){if(a=m(a.type)){switch(a){case "simple-fill":case "picture-fill":return!0;case "CIMPolygonSymbol":return!0}return!1}};a.isLineSymbol=function(a){if(a=m(a.type)){switch(a){case "simple-line":case "picture-line":return!0;case "CIMLineSymbol":return!0}return!1}};
a.isPictureSymbol=function(a){if(a=m(a.type))switch(a){case "picture-marker":case "picture-line":case "picture-fill":return!0}return!1};a.isTextSymbol=function(a){if(a=m(a.type)){switch(a){case "text":return!0;case "CIMTextSymbol":return!0}return!1}};a.getTextProperties=function(a){return R.TextProperties.pool.acquire(a.color?H.copyAndPremultiply(a.color):[255,255,255,255],a.haloColor?H.copyAndPremultiply(a.haloColor):[255,255,255,255],A.pt2px(a.haloSize),A.pt2px(a.font.size),a.angle*Math.PI/180,
a.xoffset/a.font.size,a.yoffset/a.font.size,"left"===a.horizontalAlignment?0:"right"===a.horizontalAlignment?1:.5,"top"===a.verticalAlignment?0:"bottom"===a.verticalAlignment?1:.5)};a.isDefined=function(a){return null!==a&&void 0!==a};a.isNumber=function(a){return"number"===typeof a};a.isString=L;a.isStringOrNull=function(a){return null==a||L(a)};a.lerp=function(a,b,f){return a+(b-a)*f};u=function(){function a(){this._arr=[];this._push=this._push.bind(this)}a.prototype._push=function(a,c){this._arr.push(c)};
a.prototype.getKeys=function(a){this._arr.length=0;a&&a.forEach(this._push);return this._arr};return a}();a.KeysGetter=u;u=function(){function a(){this._arr=[];this._push=this._push.bind(this)}a.prototype._push=function(a,c){this._arr.push(a)};a.prototype.getValues=function(a){this._arr.length=0;a&&a.forEach(this._push);return this._arr};return a}();a.ValuesGetter=u;a.getCapType=function(a,b){switch(a){case "butt":return d.CapType.BUTT;case "round":return b?d.CapType.SQUARE:d.CapType.ROUND;case "square":return d.CapType.SQUARE;
default:return w.error(new y("mapview-invalid-type","Cap type "+a+" is not a valid option. Defaulting to round")),d.CapType.ROUND}};a.getJoinType=function(a){switch(a){case "miter":return d.JoinType.MITER;case "bevel":return d.JoinType.BEVEL;case "round":return d.JoinType.ROUND;default:return w.error(new y("mapview-invalid-type","Join type "+a+" is not a valid option. Defaulting to round")),d.JoinType.ROUND}};a.getVVType=function(a){switch(a){case "opacity":return d.VVType.OPACITY;case "color":return d.VVType.COLOR;
case "rotation":return d.VVType.ROTATION;case "size":return d.VVType.SIZE;default:return w.error("Cannot interpret unknown vv: "+a),null}};a.createHydrateFactory=M;a.getTransformParams=function(a){return{transform:a.transform,hasZ:a.hasZ,hasM:a.hasM}};a.createArcadeFunction=function(a,b,f){var c=b.fields,h=b.spatialReference,g=b.hasGeometryExpr;b=b.geometryType;var d=G.createFunction(a),E=new P,F=new O({viewingMode:null,scale:null}),k={},n={vars:{$feature:E,$view:null},spatialReference:h},q={fields:c},
t=M(b);return function(a,b,c){g?(b=t(a.geometry,b.transform,b.hasZ,b.hasM),b.spatialReference=h,E.repurposeFromGraphicLikeObject(b,a.attributes,q)):E.repurposeFromGraphicLikeObject(a.geometry,a.attributes,q);c?(n.vars.$view=F,F.attributes.viewingMode=c.viewingMode,F.attributes.scale=c.scale):n.vars.$view=k;a=G.executeFunction(d,n);return f?f(a):a}};a.copyMeshData=function(a,b,f,d,h,g,k){for(var c in g)for(var e=g[c].stride,x=K(e),n=g[c].data,q=f[c].data,t=e*h.vertexCount/x,l=e*a/x,x=e*h.vertexFrom/
x,e=0;e<t;++e)q[e+l]=n[e+x];f=h.indexCount;for(e=0;e<f;++e)d[e+b]=k[e+h.indexFrom]-h.vertexFrom+a};a.C_VBO_INFO=(p={},p[a.C_VBO_GEOMETRY]=35044,p[a.C_VBO_VISIBILITY]=35044,p[a.C_VBO_VISIBILITY_RANGE]=35048,p);a.createGeometryData=function(a,b){for(var c=[],e=0;5>e;++e){for(var h={},g=0,d=J(e);g<d.length;g++){var k=d[g];h[k]={data:b(e,k)}}c.push({data:a(e),buffers:h})}return c};a.resampleHermite=function(a,b,f,e,h,d,k){void 0===k&&(k=!0);var c=b/h;f/=d;for(var g=Math.ceil(c/2),x=Math.ceil(f/2),n=0;n<
d;n++)for(var q=0;q<h;q++){for(var t=4*(q+(k?d-n-1:n)*h),l=0,m=0,p=0,u=0,v=0,w=0,y=0,z=(n+.5)*f,B=Math.floor(n*f);B<(n+1)*f;B++)for(var C=Math.abs(z-(B+.5))/x,A=(q+.5)*c,C=C*C,D=Math.floor(q*c);D<(q+1)*c;D++){var r=Math.abs(A-(D+.5))/g,l=Math.sqrt(C+r*r);-1<=l&&1>=l&&(l=2*l*l*l-3*l*l+1,0<l&&(r=4*(D+B*b),y+=l*a[r+3],p+=l,255>a[r+3]&&(l=l*a[r+3]/250),u+=l*a[r],v+=l*a[r+1],w+=l*a[r+2],m+=l))}e[t]=u/m;e[t+1]=v/m;e[t+2]=w/m;e[t+3]=y/p}};a.createTextureFromTexelData=function(a,b){var c,e;I.isPowerOfTwo(b.width)&&
I.isPowerOfTwo(b.height)?(c=!0,e=9987):(c=!1,e=9729);return new S(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,hasMipmap:c,samplingMode:e,wrapMode:33071,flipped:!0},b)};a.geometryToMappedGeometry=function(a){return{vertexFrom:void 0,vertexTo:void 0,geometry:a}};var z=new Map;a.createProgramDescriptor=function(a,b){if(!z.has(a)){var c=Y(b),e={},d;for(d in c){var g=c[d];e[d]=g.length?g[0].stride:0}d={};for(var k in b)for(var g=0,m=b[k];g<m.length;g++){var p=m[g];d[p.name]=p.location}z.set(a,
{strides:e,bufferLayouts:c,attributes:d})}return z.get(a)}});