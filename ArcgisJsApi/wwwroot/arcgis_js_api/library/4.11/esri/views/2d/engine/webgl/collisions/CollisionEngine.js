// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/array @dojo/framework/shim/Map ../definitions ./CollisionBucket ./LayerCollisionInfo ../util/iterator ../../../../3d/support/mathUtils".split(" "),function(w,x,z,y,p,A,r,B,q){Object.defineProperty(x,"__esModule",{value:!0});var t=p.TILE_SIZE/p.COLLISION_BUCKET_SIZE;w=function(){function d(a){this._layers=new y.default;this._collisionBuckets=new y.default;this._tilingScheme=a}Object.defineProperty(d.prototype,"collisionInfos",{get:function(){var a=[];B.forEachIter(this._layers.values(),
function(b){return a.push(b)});return a},enumerable:!0,configurable:!0});d.prototype.registerLayer=function(a,b,e){if(a&&!this._layers.has(a.uid)){var c=r.default.create(a,b,e,this.collisionInfos,this._tilingScheme);this._layers.set(a.uid,c);this._collisionBuckets.forEach(function(a){return a.onRegisterLayer(c.index)})}};d.prototype.unregisterLayer=function(a){var b=this;if(a&&this._layers.has(a.uid)){var e=this._layers.get(a.uid);r.default.delete(e.index,this.collisionInfos);this._layers.delete(a.uid);
this._collisionBuckets.forEach(function(a,f){var c=a.getTile(e.index);c&&(a.onUnregisterLayer(e.index),a.canDelete()&&b._collisionBuckets.delete(f),c.reference&&(c.reference.isDirty=!1))})}};d.prototype.addTile=function(a,b){var e=b.key.id;this._layers.has(a)&&(this._collisionBuckets.has(e)||this._collisionBuckets.set(e,new A.default(b.key,this._layers.size)),this._collisionBuckets.get(e).getTile(this._getIndex(a)).reference=b)};d.prototype.removeTile=function(a,b){this._layers.has(a)&&this._collisionBuckets.has(b)&&
(a=this._collisionBuckets.get(b).getTile(this._getIndex(a)),a.dirty=!1,a.reference=null)};d.prototype.run=function(a,b){for(var e=z.from(this._collisionBuckets.values()).filter(function(a){return a.key.level===b}).sort(function(a,b){return a.key.compareRowMajor(b.key)}),c=this._checkRotation(a.rotation),f=0;f<e.length;f++)for(var k=e[f],c=c||k.isDirty,d=0;d<this._layers.size;d++){var l=r.default.find(d,this.collisionInfos);k.computeNeighbors(this._collisionBuckets);k.reset(a,c,l)}for(a=0;a<this._layers.size;a++)for(l=
r.default.find(a,this.collisionInfos),c=0,f=e;c<f.length;c++)k=f[c],this._run(k,l,b);for(l=0;l<e.length;l++)k=e[l],k.ready()};d.prototype._run=function(a,b,e){var c=a.getReference(b.index);c&&c.isDirty&&c.hasData&&this._runVisibility(a,c,b,e)};d.prototype._runVisibility=function(a,b,e,c){for(var f=0,d=b.displayObjects;f<d.length;f++){for(var m=d[f],l=0,g=0;g<m.metrics.length;g++)var h=m.metrics[g],h=m.getLabelVisibility(e.layerView)?this._computeLabelVisibility(m,h,e.index,a,b,h.baseZoom,c):255,l=
Math.max(h,l);for(var g=0,n=m.metrics;g<n.length;g++)h=n[g],b.setVisibilityRange(m.id,h.range.from,h.range.count,l),h.minZoom=l}};d.prototype._computeLabelVisibility=function(a,b,e,c,d,k,m){for(var f=b.xBucket,g=b.yBucket,h=b.xOverflow,n=b.yOverflow,r=f-h,f=f+h+1,h=g+n+1,g=g-n;g<h;g++)for(n=r;n<f;n++)if(!(n<-t||g<-t||n>t||g>t))for(var p=0;p<=e;p++){var q=this._getRelativeSubBucket(p,c,d,n,g);if(q)for(var v=0;v<q.length;v++){var u=q[v];u.id!==a.id&&(u=this._compareLabels(b,u,k,m),k=Math.max(u,k))}}return k};
d.prototype._compareLabels=function(a,b,e,c){var d=10*(c+p.COLLISION_MAX_ZOOM_DELTA);if(-1===b.minZoom||b.minZoom>d||b.minZoom>Math.floor(10*c))return e;a=a.findCollisionDelta(b);c=q.clamp(Math.floor(10*(a+c)),0,255);return b.minZoom>=c?e:Math.max(e,c)};d.prototype._getNeighboringTile=function(a,b,e,c,d){return(b=b.neighbors[3*(1+d)+(1+c)])&&b.getTile(a)};d.prototype._getRelativeSubBucket=function(a,b,e,c,d){var f=q.sign(Math.floor(c/4)),m=q.sign(Math.floor(d/4));return(a=this._getNeighboringTile(a,
b,e,f,m))&&a.reference&&a.index&&a.reference.hasData?a.index[d-4*m][c-4*f]:null};d.prototype._checkRotation=function(a){if(!this._lastRotation)return this._lastRotation=a,!1;var b=a!==this._lastRotation;this._lastRotation=a;return b};d.prototype._getIndex=function(a){return this._layers.get(a).index};return d}();x.default=w});