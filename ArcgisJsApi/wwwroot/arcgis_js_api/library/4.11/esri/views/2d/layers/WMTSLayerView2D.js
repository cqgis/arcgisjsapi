// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Handles ../../../core/accessorSupport/decorators ../../../geometry/support/webMercatorUtils ../engine/BitmapContainer ./LayerView2D ./support/BitmapTile ../tiling/TileInfoView ../tiling/TileQueue ../tiling/TileStrategy ../../layers/RefreshableLayerView".split(" "),function(w,x,h,f,k,e,l,m,n,p,q,r,t,u){var v=[102113,102100,3857,3785,900913];return function(g){function b(){var a=
null!==g&&g.apply(this,arguments)||this;a._handles=new k;a._tileStrategy=null;a._tileInfoView=null;a._fetchQueue=null;a._tileRequests=new Map;a.container=new m.BitmapContainer;a.layer=null;return a}h(b,g);Object.defineProperty(b.prototype,"tileMatrixSet",{get:function(){if(this.layer.activeLayer.tileMatrixSetId)return this.layer.activeLayer.tileMatrixSet;var a=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);if(!a)return null;this.layer.activeLayer.tileMatrixSetId=a.id;return a},enumerable:!0,
configurable:!0});b.prototype.hitTest=function(a,c){return null};b.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")};b.prototype.attach=function(){var a=this,c=this.layer.activeLayer,d=this.tileMatrixSet;if(d){var b=d.tileInfo.spatialReference,c=c.fullExtent&&c.fullExtent.clone();b.isWebMercator?c=l.geographicToWebMercator(c):b.isWGS84||(c=d.fullExtent);this._tileInfoView=new q(d.tileInfo,
c);this._fetchQueue=new r({tileInfoView:this._tileInfoView,process:function(c){return a.fetchTile(c)}});this._tileStrategy=new t({cachePolicy:"keep",acquireTile:function(c){return a.acquireTile(c)},releaseTile:function(c){return a.releaseTile(c)},tileInfoView:this._tileInfoView});this._handles.add(this.watch("layer.activeLayer.styleId, tileMatrixSet",function(){return a._refresh()}))}};b.prototype.detach=function(){this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeAllChildren();
this._fetchQueue=this._tileStrategy=this._tileInfoView=null};b.prototype.moveStart=function(){this.requestUpdate()};b.prototype.viewChange=function(){this.requestUpdate()};b.prototype.moveEnd=function(){this.requestUpdate()};b.prototype.doRefresh=function(){this.updateRequested||this.suspended||this._refresh()};b.prototype.isUpdating=function(){var a=!0;this._tileRequests.forEach(function(c){a=a&&c.isFulfilled()});return!a};b.prototype.acquireTile=function(a){var c=this,b=p.default.pool.acquire();
b.key.set(a);b.resolution=this._tileInfoView.getTileResolution(b.key);a=this._tileInfoView.tileInfo.size;b.width=a[0];b.height=a[1];this._tileInfoView.getTileCoords(b,b.key);a=this._fetchQueue.push(b.key).then(function(a){b.source=a;b.once("attach",function(){return c.requestUpdate()});c.container.addChild(b)});this._tileRequests.set(b,a);this.requestUpdate();return b};b.prototype.releaseTile=function(a){var b=this._tileRequests.get(a);b.isFulfilled()||b.cancel();this._tileRequests.delete(a);this.container.removeChild(a);
this.requestUpdate()};b.prototype.fetchTile=function(a){return this.layer.fetchTile(a.level,a.row,a.col)};b.prototype.canResume=function(){var a=this.inherited(arguments);return a?null!==this.tileMatrixSet:a};b.prototype._refresh=function(){var a=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(b){if(b.source){b.source=null;var c=a._fetchQueue.push(b.key).then(function(c){b.source=c;b.requestRender();a.notifyChange("updating")});a._tileRequests.set(b,c)}});this.notifyChange("updating")};
b.prototype._getTileMatrixSetBySpatialReference=function(a){var b=this.view.spatialReference,d=a.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===b.wkid});!d&&b.isWebMercator&&(d=a.tileMatrixSets.find(function(a){return-1<v.indexOf(a.tileInfo.spatialReference.wkid)}));return d};f([e.property({dependsOn:["tileMatrixSet"]})],b.prototype,"suspended",void 0);f([e.property({readOnly:!0,dependsOn:["view.spatialReference","layer.activeLayer"]})],b.prototype,"tileMatrixSet",null);
f([e.property({dependsOn:["updateRequested","attached"]})],b.prototype,"updating",void 0);return b=f([e.subclass("esri.views.2d.layers.WMTSLayerView2D")],b)}(e.declared(n,u))});