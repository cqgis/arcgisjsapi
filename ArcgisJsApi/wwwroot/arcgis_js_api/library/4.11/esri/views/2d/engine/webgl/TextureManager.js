// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../config ../../../../core/asyncUtils ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ./CIMSymbolHelper ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SDFHelper ./SpriteMosaic ./Utils ./util/Result ../../../3d/support/imageUtils".split(" "),function(M,
N,t,u,z,A,n,B,v,w,C,g,p,q,D,E,F,G,x,H,h,I,J){function K(b){if(b.type){switch(h.normalizeSymbolType(b.type)){case "simple-marker":return b.path?"simple-marker"+b.style+b.path:"simple-marker"+b.style;case "simple-line":return"simple-line"+b.style+b.cap;case "simple-fill":return"simple-fill"+b.style}if(h.isPictureSymbol(b))return b.imageData?b.imageData:b.url+(""+b.width+b.height)}return JSON.stringify(b)}var y=C.vec2f32.create(),r=B.getLogger("esri.views.2d.engine.webgl.TextureManager"),L=function(){function b(a,
c,e){this.mosaicType=a;this.page=c;this.sdf=e}b.fromMosaic=function(a,c){return new b(a,c.page,c.sdf)};return b}();return function(){function b(){this._invalidFontsMap=new Map;this._sdfConverter=new G.default(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._spriteMosaic=new H(1024,1024,300);this._glyphSource=new F(z.fontsUrl+"/{fontstack}/{range}.pbf");this._glyphMosaic=new E(1024,1024,this._glyphSource)}Object.defineProperty(b.prototype,"sprites",{get:function(){return this._spriteMosaic},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});b.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizationCanvas=this._glyphMosaic=this._spriteMosaic=null};b.prototype._hashMosaic=function(a,c){return 1|a<<1|(c.sdf?1:0)<<2|c.page<<3};b.prototype._setTextureBinding=function(a,c){var e=this._hashMosaic(a,c);this._hashToBindingIndex.has(e)||(a=L.fromMosaic(a,
c),this._hashToBindingIndex.set(e,this._bindingInfos.length+1),this._bindingInfos.push(a));c.textureBinding=this._hashToBindingIndex.get(e)};b.prototype.rasterizeItem=function(a,c){var e=this;void 0===c&&(c=null);return a?a.type&&-1!==a.type.toLowerCase().indexOf("3d")?(r.error(new n("mapview-invalid-type","MapView does not support 3d symbol type: "+a.type,a)),v.resolve({glyphMosaicItems:[],spriteMosaicItem:null})):!a.type||"text"!==a.type&&"esriTS"!==a.type?A.safeCast(this._rasterizeSpriteSymbol(a)).then(function(a){I.ok(a)&&
a&&e._setTextureBinding(q.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}):this._rasterizeTextSymbol(a,c).then(function(a){a.forEach(function(a){return e._setTextureBinding(q.MosaicType.GLYPH,a)});return{glyphMosaicItems:a}}):(r.error(new n("mapview-null-resource","Unable to rasterize null resource")),v.resolve(null))};b.prototype.bindTextures=function(a,c,e,d){void 0===d&&(d=1);if(0!==e.textureBinding){var b=this._bindingInfos[e.textureBinding-1];e=b.page;switch(b.mosaicType){case q.MosaicType.SPRITE:b=
this.sprites.getWidth(e)/d;d=this.sprites.getHeight(e)/d;d=w.vec2.set(y,b,d);this._bindSpritePage(a,e,p.TEXTURE_BINDING_SPRITE_ATLAS,9729);c.setUniform1i("u_texture",p.TEXTURE_BINDING_SPRITE_ATLAS);c.setUniform2fv("u_mosaicSize",d);break;case q.MosaicType.GLYPH:b=this.glyphs.width/d;d=this.glyphs.height/d;d=w.vec2.set(y,b,d);this._bindGlyphsPage(a,e,p.TEXTURE_BINDING_GLYPH_ATLAS);c.setUniform1i("u_texture",p.TEXTURE_BINDING_GLYPH_ATLAS);c.setUniform2fv("u_mosaicSize",d);break;default:r.error("mapview-texture-manager",
"Cannot handle unknown type "+b.mosaicType)}}};b.prototype._bindSpritePage=function(a,c,e,d){d||(d=9729);this._spriteMosaic.bind(a,d,c,e)};b.prototype._bindGlyphsPage=function(a,c,e){this._glyphMosaic.bind(a,9729,c,e)};b.prototype._rasterizeTextSymbol=function(a,c){var e=this,d=D.getFullyQualifiedFontName(a.font);a=this._invalidFontsMap.has(d);return this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":d,c).catch(function(a){r.error(new n("mapview-invalid-resource","Couldn't find font "+d+
". Falling back to Arial Unicode MS Regular"));e._invalidFontsMap.set(d,!0);return e._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",c)})};b.prototype._rasterizeSpriteSymbol=function(a){return t(this,void 0,void 0,function(){var c,e,d,b,k,l,m;return u(this,function(f){if(a&&(h.isFillSymbol(a)||h.isLineSymbol(a))&&"style"in a&&("solid"===a.style||"esriSFSSolid"===a.style||"esriSLSSolid"===a.style||"none"===a.style||"esriSFSNull"===a.style||"esriSLSNull"===a.style))return[2,null];c=K(a);if(this._spriteMosaic.has(c))return[2,
this._spriteMosaic.getSpriteItem(c)];if(("simple-marker"===a.type||"esriSMS"===a.type)&&a.path)return[2,this._handleSVG(a,c)];if(a.url||a.imageData)return[2,this._handleImage(a,c)];e=this._rasterizeResource(a);d=e.size;b=e.anchor;k=e.image;l=e.sdf;m=e.simplePattern;return[2,this._addItemToMosaic(c,d,b,k,!h.isMarkerSymbol(a),l,m)]})})};b.prototype._handleSVG=function(a,c){return t(this,void 0,void 0,function(){var e,d;return u(this,function(b){switch(b.label){case 0:return e=[126,126],[4,this._sdfConverter.draw(a.path)];
case 1:return d=b.sent(),[2,this._addItemToMosaic(c,e,[0,0],new Uint32Array(d.buffer),!1,!0,!0)]}})})};b.prototype._handleImage=function(a,c){return t(this,void 0,void 0,function(){var b,d,f,k,l,m,g;return u(this,function(e){switch(e.label){case 0:b=a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,J.requestImage(b)];case 2:return d=e.sent(),f=this._rasterizeResource(d),k=f.size,l=f.anchor,m=f.sdf,g=f.image,[2,this._addItemToMosaic(c,k,
l,g,!h.isMarkerSymbol(a),m,!1)];case 3:return e.sent(),[2,new n("mapview-invalid-resoure","Could not fetch requested resource at "+b)];case 4:return[2]}})})};b.prototype._rasterizeResource=function(a){if(a instanceof HTMLImageElement){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));this._rasterizationCanvas.width=a.width;this._rasterizationCanvas.height=a.height;var c=this._rasterizationCanvas.getContext("2d");c.drawImage(a,0,0,a.width,a.height);for(var c=c.getImageData(0,
0,a.width,a.height),c=new Uint8Array(c.data),b=void 0,d=0;d<c.length;d+=4)b=c[d+3]/255,c[d]*=b,c[d+1]*=b,c[d+2]*=b;var b=a.width,d=a.height,f=c;if(256<=b||256<=d)f=a.width/a.height,1<f?(b=256,d=Math.round(256/f)):(d=256,b=Math.round(256*f)),f=new Uint8Array(4*b*d),h.resampleHermite(c,a.width,a.height,new Uint8ClampedArray(f.buffer),b,d,!1);return{size:[b,d],anchor:[0,0],image:new Uint32Array(f.buffer),sdf:!1,simplePattern:!1}}return this._rasterizeJSON(a)};b.prototype._addItemToMosaic=function(a,
b,e,d,f,g,h){return this._spriteMosaic.addSpriteItem(a,b,e,d,f,g,h)};b.prototype._rasterizeJSON=function(a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));if("simple-fill"===a.type||"esriSFS"===a.type)return a=g.SymbolHelper.rasterizeSimpleFill(this._rasterizationCanvas,a.style),{size:[a[1],a[2]],anchor:[0,0],image:new Uint32Array(a[0].buffer),sdf:!1,simplePattern:!0};if("simple-line"===a.type||"esriSLS"===a.type)return a=g.SymbolHelper.rasterizeSimpleLine(this._rasterizationCanvas,
a.style,a.cap),{size:[a[1],a[2]],anchor:[0,0],image:new Uint32Array(a[0].buffer),sdf:!0,simplePattern:!0};var b;"simple-marker"===a.type||"esriSMS"===a.type?(a=g.CIMSymbolHelper.fromSimpleMarker(a),b=!0):b=x.checkSDF(a);if(b)return a=x.buildSDF(a),{size:[a[1],a[2]],anchor:[0,0],image:new Uint32Array(a[0].buffer),sdf:!0,simplePattern:!0};a=g.CIMSymbolHelper.rasterize(this._rasterizationCanvas,a);return{size:[a[1],a[2]],anchor:[a[3],a[4]],image:new Uint32Array(a[0].buffer),sdf:!1,simplePattern:!1}};
return b}()});