// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/HandleOwner ../../../../core/Identifiable ../../../../core/MapPool ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/jsonUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../engine/webgl/GraphicContainer ../../engine/webgl/TileData ../../engine/webgl/WGLTile ../../engine/webgl/mesh/factories/matcherUtils ../../engine/webgl/mesh/factories/WGLMeshFactory ../../engine/webgl/mesh/templates/WGLTemplateStore ../features/support/TileStore ../graphics/GraphicProcessingQueue ../graphics/GraphicStore ../graphics/graphicsUtils ../../../layers/GraphicsView".split(" "),
function(v,z,E,q,S,F,G,A,k,H,p,I,l,r,w,B,J,K,L,C,M,N,O,P,Q,D,R){function x(k,d,a){if(a.has(k))return a.get(k);d={tile:d,addedOrModified:[],removed:[]};a.set(k,d);return d}Object.defineProperty(z,"__esModule",{value:!0});var y=new Set;v=function(v){function d(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a=v.apply(this,a)||this;a._hiddenGraphics=[];a._tiles=new Map;a._graphicStoreUpdate=!1;a._highlightIDs=new Set;a._graphicsSet=new Set;a._matcher=null;a._tileUpdateSet=new Set;a._tilesToUpdate=
new Map;a._pendingUpdates=0;a._attached=!1;a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(a);a._addOrUpdateGraphic=a._addOrUpdateGraphic.bind(a);a._processAnalyzedGraphics=a._processAnalyzedGraphics.bind(a);a._graphicsChangeHandler=a._graphicsChangeHandler.bind(a);return a}E(d,v);d.prototype.initialize=function(){var a=this;this._tileStore=new O.default(this.view.featuresTilingScheme);this.container=new J.default({tileInfoView:this.view.featuresTilingScheme,
highlightIDs:this._highlightIDs});this._graphicStore=new Q.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.renderer,this.graphics);this._graphicProcessingQueue=new P.default({process:this._addOrUpdateGraphic});var b=new N.default(this.container.getMaterialItems);this.renderer&&(this._matcher=C.createMatcher(this.renderer,b,null));this._meshFactory=new M.default(null,this.uid,null,null,window.devicePixelRatio,this.view.spatialReference,b,null,this._tileStore.tileScheme.tileInfo);
this.watch("renderer",function(c){if(a._graphicStore.renderer=c)a._matcher=C.createMatcher(a.renderer,b,null)});this._tileStore.on("update",this._onTileUpdate.bind(this));this.container.on("attach",function(){0<a.graphics.items.length&&a._graphicsChangeHandler({target:a.graphics,added:a.graphics.items,removed:[],moved:[]});a.handles.add(a.graphics.on("change",a._graphicsChangeHandler),"graphics");a._attached=!0;a.notifyChange("updating")})};d.prototype.destroy=function(){this._set("graphics",null);
this._graphicStore.clear();this._tileStore.destroy()};Object.defineProperty(d.prototype,"updating",{get:function(){return!this._attached||0!==this._pendingUpdates||this._graphicProcessingQueue.updating||0<this._tileUpdateSet.size||0<this._tilesToUpdate.size},enumerable:!0,configurable:!0});d.prototype.install=function(a){a.addChild(this.container)};d.prototype.uninstall=function(a){a.removeChild(this.container)};d.prototype.addHighlight=function(a){for(var b=0;b<a.length;b++)this._highlightIDs.add(a[b]);
this._buildHLList()};d.prototype.highlight=function(a){var b=this;b.addHighlight(a);return{remove:function(){b.removeHighlight(a)}}};d.prototype.hitTest=function(a,b){if(!this.view||!this.view.position)return k.resolve();a=this.view.toMap(H.createScreenPoint(a,b));return this.searchFeatures(a).then(function(a){return a&&a.length?a[0]:null})};d.prototype.searchFeatures=function(a,b){var c=this;void 0===b&&(b=2);return k.create(function(d){d(c._graphicStore.hitTest(a.x,a.y,b,c.view.state.resolution,
c.view.state.rotation))})};d.prototype.removeHighlight=function(a){for(var b=0;b<a.length;b++)this._highlightIDs.delete(a[b]);this._buildHLList()};d.prototype.setHighlight=function(a){this._highlightIDs.clear();this.addHighlight(a)};d.prototype.update=function(a){a=a.state;var b=this.view.featuresTilingScheme.getClosestInfoForScale(a.scale).level;this._graphicStore.updateLevel(b);this._tileStore.setViewState(a);this._graphicStoreUpdate=!0;this.updateRequested=!1};d.prototype.viewChange=function(){this.requestUpdate()};
d.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate(this))};d.prototype.processUpdate=function(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))};d.prototype.graphicUpdateHandler=function(a){var b=a.graphic,c=a.newValue;switch(a.property){case "geometry":case "symbol":this._graphicProcessingQueue.push(b,"update");break;case "visible":this._setVisible(b.uid,c)}};d.prototype._getIntersectingTiles=function(a){return(a=this._graphicStore.getBounds(a))&&
0!==l.width(a)&&0!==l.height(a)?this._tileStore.boundsIntersections(a):[]};d.prototype._updateTile=function(a){var b=this,c=a.tile,d=this._getGraphicsData(c,a.addedOrModified);return this._processGraphics(c.key,d).then(function(d){b._patchTile(c.key,{addOrUpdate:d,remove:a.removed});return d})};d.prototype._graphicsChangeHandler=function(a){var b=this;this._pendingUpdates++;this.notifyChange("updating");if(!this._graphicStoreUpdate){var c=this.view.state,d=this.view.featuresTilingScheme.getClosestInfoForScale(c.scale).level;
this._graphicStore.updateLevel(d);this._tileStore.setViewState(c)}var e=a.added,d=a.removed;a=a.moved;for(var f=this._tilesToUpdate,g,c=[],n=Array(e.length),h=0;h<e.length;h++){var m=e[h];n[h]=m;this._graphicsSet.add(m);c.push(this._addOrUpdateGraphic(m,"add"))}for(h=0;h<d.length;h++){for(var m=d[h],e=this._getIntersectingTiles(m),u=0,l=e;u<l.length;u++)e=l[u],g=e.key.id,e=x(g,e,f),e.removed.push(m.uid);this._graphicsSet.delete(m);this._graphicStore.remove(m)}for(d=0;d<a.length;d++)for(h=a[d],e=this._getIntersectingTiles(h),
m=0,u=e;m<u.length;m++)e=u[m],g=e.key.id,e=x(g,e,f),e.addedOrModified.push(h);k.all(c).then(function(){for(var a,c=0;c<n.length;c++){a=n[c];for(var d=0,e=b._getIntersectingTiles(a);d<e.length;d++){var t=e[d];g=t.key.id;x(g,t,f).addedOrModified.push(a)}}b._graphicStore.updateZ();var h=[];f.forEach(function(a){return h.push(b._updateTile(a))});return k.all(h).then(function(){f.clear();b._pendingUpdates--;b.notifyChange("updating")})}).catch(function(){b._pendingUpdates--})};d.prototype._buildHLList=
function(){for(var a=0,b=this.container.children;a<b.length;a++)b[a].buildHLList(this._highlightIDs);this.container.requestRender()};d.prototype._getSymbolResources=function(a){var b=a.symbol;!b&&this.renderer&&(b=this.renderer.getSymbol(a,{scale:this.view.scale}));if(!b||b&&"text"!==b.type)return k.resolve(null);y.clear();a=b;for(var b=a.text,c=0;c<b.length;c++)y.add(b.charCodeAt(c));var d=[];y.forEach(function(a){return d.push(a)});b=[];b.push({symbol:a.toJSON(),id:0,glyphIds:d});return this.container.getMaterialItems(b).then(function(a){return 0<
a.length?a[0].mosaicItem:null})};d.prototype._projectAndNormalizeGeometry=function(a){var b=this;if(!a.geometry)return k.resolve(null);var c=a.geometry;r.isPolygon(c)?c.rings=c.rings:r.isPolyline(c)?c.paths=c.paths:r.isExtent(c)&&(c=I.fromExtent(c));return B.checkProjectionSupport(c.spatialReference,this.view.spatialReference).then(function(){var a=D.normalizeCentralMeridian(c),a=B.project(a,c.spatialReference,b.view.spatialReference);D.ensureClosedRings(a);return a})};d.prototype._onTileUpdate=function(a){var b=
this,c=w.getInfo(this.view.spatialReference);if(a.added&&0<a.added.length)for(var d=function(a){var d=e._graphicStore.queryTileData(a);if(c)for(var f=Math.round((c.valid[1]-c.valid[0])/a.resolution),t=0;t<d.length;t++){var g=d[t];g.geometry&&r.isPoint(g.geometry)&&e._wrapPoints(g,f)}e._tileUpdateSet.add(a.key);e.notifyChange("updating");e._processGraphics(a.key,d).then(function(c){b._addTile(a.key,c);b._tileUpdateSet.delete(a.key);b.notifyChange("updating")}).catch(function(){b._tileUpdateSet.delete(a.key);
b.notifyChange("updating")})},e=this,f=0,g=a.added;f<g.length;f++)d(g[f]);if(a.removed&&0<a.removed.length)for(d=0,a=a.removed;d<a.length;d++)this._removeTile(a[d].key)};d.prototype._addOrUpdateGraphic=function(a,b){var c=this,d=this._projectAndNormalizeGeometry(a),e=this._getSymbolResources(a);return k.all([d,e]).then(function(d){var e=d[0];d=d[1];return"add"===b?c._addProjectedGraphic(a,d,e):c._updateGraphic(a,d,e)})};d.prototype._addProjectedGraphic=function(a,b,c){if(!this._graphicsSet.has(a))return null;
a.visible||this._hiddenGraphics.push(a.uid);a=this._graphicStore.add(a,b,c);return!a||0===l.width(a)&&0===l.height(a)?null:a};d.prototype._updateGraphic=function(a,b,c){var d=this;if(!this._graphicStore.has(a))return k.resolve();c=this._graphicStore.update(a,b,c);b=c.oldBounds;var e=c.newBounds,f=0===l.width(b)&&0===l.height(b);c=0===l.width(e)&&0===l.height(e);var g=f?[]:this._tileStore.boundsIntersections(b);b=c?[]:this._tileStore.boundsIntersections(e);c=A.acquire();for(var n=0;n<g.length;n++)f=
g[n],c.set(f.key,{addOrUpdate:null,remove:[a.uid]});for(g=0;g<b.length;g++)f=b[g],n=this._getGraphicData(f,a),c.has(f.key)?(f=c.get(f.key),f.remove.length=0,f.addOrUpdate=n):c.set(f.key,{addOrUpdate:n,remove:null});var h=[];c.forEach(function(a,b){var c=d._processGraphics(b,a.addOrUpdate).then(function(c){d._patchTile(b,{addOrUpdate:c,remove:a.remove})});h.push(c)});A.release(c);return k.all(h).then(function(){return e})};d.prototype._addTile=function(a,b){var c=l.create();this.view.featuresTilingScheme.getTileBounds(c,
a);c=new L(a,c,!0);c.setData({clear:!0,addOrUpdate:b,remove:[]},!1,!1);c.buildHLList(this._highlightIDs);0<this._hiddenGraphics.length&&c.setFilterFlag(0,[],this._hiddenGraphics);this._tiles.set(a,c);this.container.addChild(c)};d.prototype._removeTile=function(a){this._tiles.has(a)&&(a=this._tiles.get(a),this.container.removeChild(a))};d.prototype._patchTile=function(a,b){this._tiles.has(a)&&(a=this._tiles.get(a),a.setData(b,!1,!1),a.buildHLList(this._highlightIDs),0<this._hiddenGraphics.length&&
a.setFilterFlag(0,[],this._hiddenGraphics),this.container.requestRender())};d.prototype._setVisible=function(a,b){var c=[],d=[],e=this._hiddenGraphics.indexOf(a);if(b){if(-1!==e)this._hiddenGraphics.splice(e,1);else return;c.push(a)}else{if(-1===e)this._hiddenGraphics.push(a);else return;d.push(a)}a=0;for(b=this.container.children;a<b.length;a++)e=b[a],e.data&&e.setFilterFlag(0,c,d)};d.prototype._getGraphicsData=function(a,b){var c=w.getInfo(this.view.spatialReference);b=this._graphicStore.getGraphicsData(a,
b);if(c)for(a=Math.round((c.valid[1]-c.valid[0])/a.resolution),c=0;c<b.length;c++){var d=b[c];d.geometry&&r.isPoint(d.geometry)&&this._wrapPoints(d,a)}b.sort(function(a,b){return a.insertAfter-b.insertAfter});return b};d.prototype._getGraphicData=function(a,b){b=this._graphicStore.getGraphicData(a,b);var c=[b],d=w.getInfo(this.view.spatialReference);d&&(a=Math.round((d.valid[1]-d.valid[0])/a.resolution),b.geometry&&r.isPoint(b.geometry)&&this._wrapPoints(b,a));return c};d.prototype._wrapPoints=function(a,
b){var c=a.geometry;512===b?20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:492<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]}):-20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:532<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]})};d.prototype._processGraphics=function(a,b){var c=this;return b&&b.length&&this._meshFactory?this._meshFactory.analyze(b,this._matcher).then(function(b){return c._processAnalyzedGraphics(a,b)}):k.resolve(null)};d.prototype._processAnalyzedGraphics=function(a,b){for(var c=this._meshFactory,
d=c.createMeshData(b.length),e=0;e<b.length;e++)c.write(d,b[e],null,null,a.level);return K.fromMeshData(d)};q([p.property()],d.prototype,"_graphicProcessingQueue",void 0);q([p.property({constructOnly:!0})],d.prototype,"graphics",void 0);q([p.property({dependsOn:["_graphicProcessingQueue.updating"]})],d.prototype,"updating",null);q([p.property()],d.prototype,"view",void 0);q([p.property()],d.prototype,"updateRequested",void 0);return d=q([p.subclass("esri.views.2d.layers.support.GraphicsView2D")],
d)}(p.declared(R,F,G.Identifiable));z.default=v});