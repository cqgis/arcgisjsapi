// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../geometry/Point ../Container ../../engine/webgl/TileData ./enums ./Utils ./WGLRendererInfo".split(" "),function(m,n,p,r,t,k,u,v,w,x,l,q,y){Object.defineProperty(n,"__esModule",{value:!0});m=function(h){function c(a){var b=h.call(this)||this;b._rendererInfo=new y;b._pointToCallbacks=new Map;b._invisibleFeatures=
new Set;b._displayWidth=0;b._displayHeight=0;b.layer=null;b.tileInfoView=a.tileInfoView;b.layer=a.layer;b._layerView=a.layerView;return b}r(c,h);c.prototype.dispose=function(){this.removeAllChildren();for(var a=0,b=this.children;a<b.length;a++)b[a].dispose()};c.prototype.disposeWebGLResources=function(){for(var a=0,b=this.children;a<b.length;a++)b[a].clear()};c.prototype.displayWidth=function(){return this._displayWidth};Object.defineProperty(c.prototype,"displayHeight",{get:function(){return this._displayHeight},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"visualVariablesInfo",{get:function(){return this._visualVariablesInfo},set:function(a){this._visualVariablesInfo=a;this.requestRender()},enumerable:!0,configurable:!0});c.prototype.hitTest=function(a,b){var f=this,d=[a,b];return k.create(function(a,b){f._pointToCallbacks.set(d,{resolve:a,reject:b});f.requestRender()},function(){f._pointToCallbacks.has(d)&&f._pointToCallbacks.delete(d)})};c.prototype.setFilterFlag=function(a,b,f,d){void 0===
d&&(d=!0);if(d){b||(b=[]);f||(f=[]);d=this._invisibleFeatures;a=0;for(var e=b;a<e.length;a++){var c=e[a];d.has(c)&&d.delete(c)}a=0;for(e=f;a<e.length;a++)d.add(e[a]);a=0;for(e=this.children;a<e.length;a++)d=e[a],d.data&&d.setFilterFlag(0,b,f)}else for(e=0,c=this.children;e<c.length;e++)d=c[e],d.data&&d.setFilterFlag(a,b,f)};c.prototype.whenAttached=function(){var a=this;return this.attached?k.resolve():k.create(function(b){return a.once("attached",function(){return b()})})};c.prototype.getMaterialItems=
function(a){var b=this;return this.whenAttached().then(function(){if(b.stage&&a&&0!==a.length){for(var c=[],d=b.stage.painter.textureManager,e=0;e<a.length;e++){var g=a[e];c.push(d.rasterizeItem(g.symbol,g.glyphIds))}return u.all(c).then(function(b){return b.map(function(b,d){return{id:a[d].id,mosaicItem:b}})})}})};c.prototype.onTileData=function(a,b){var c=!(!this.layer.labelingInfo||!this.layer.labelingInfo.length),d=b.addOrUpdate&&x.decode(b.addOrUpdate);b=p({},b,{addOrUpdate:d});a.setData(b,c,
this.layer.labelsVisible);a.resetVisibility(this._invisibleFeatures);a.buildHLList(this._layerView.highlightIDs);this.contains(a)||this.addChild(a);this.requestRender();this._layerView&&this._layerView.view.labelManager.requestUpdate()};c.prototype.onTileError=function(a){a.clear();a.buildHLList(this._layerView.highlightIDs);this.contains(a)||this.addChild(a);this.requestRender()};c.prototype.addChild=function(a){var b=h.prototype.addChild.call(this,a);this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.addTile(this.layer.uid,
a);this._buildHLList();return b};c.prototype.removeChild=function(a){var b=h.prototype.removeChild.call(this,a);this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.removeTile(this.layer.uid,a.key.id);this._buildHLList();return b};c.prototype.renderChildren=function(a){var b=this,c=this.stage.painter;this._updateTilesTransform(a.state,this.tileInfoView.getClosestInfoForScale(a.state.scale).level);this._rendererInfo.update(a.state,this.layer.renderer,this._visualVariablesInfo.vvRanges,
this._layerView.effects);var d=this.tileInfoView.getClosestInfoForScale(a.state.scale).level,e=this.tileInfoView.tileInfo.scaleToZoom(a.state.scale),g=p({},a,{rendererInfo:this._rendererInfo,requiredLevel:d,displayLevel:e,context:this.stage.context,painter:this.stage.painter});this.sortChildren(function(a,b){return 0!==a.key.level-b.key.level?a.key.level-b.key.level:0!==a.key.row-b.key.row?a.key.row-b.key.row:a.key.col-b.key.col});a=g.drawPhase;if(a&(l.WGLDrawPhase.LABEL|l.WGLDrawPhase.LABEL_ALPHA)){d=
this.layer;if(!(d.labelsVisible&&d.labelingInfo&&0<d.labelingInfo.length))return;this._updateTilesTransform(g.state,g.requiredLevel)}c.draw(g,this.children,a,this._painterOptions);0<this._layerView.highlightIDs.size&&c.highlight(g,this.children);this._pointToCallbacks.forEach(function(a,d){a.resolve(b._hitTest(g,d[0],d[1]))});this._pointToCallbacks.clear();this._layerView.effects&&this._layerView.effects.some(function(a){return t.isSome(a)&&!a.done})&&this.requestRender()};c.prototype.updateHighlight=
function(){this._buildHLList()};c.prototype._hitTest=function(a,b,c){var d=this.stage,e=d.painter,d=d.context,f=a.requiredLevel,h=[0,0];a.state.toMap(h,[b,c]);b=a.state.clone();c=b.viewpoint.clone();c.targetGeometry=new v(h[0],h[1],a.state.spatialReference);b.viewpoint=c;b.size=[q.C_HITTEST_SEARCH_SIZE,q.C_HITTEST_SEARCH_SIZE];this._updateTilesTransform(b,f);return e.hitTest({globalOpacity:1,painter:e,context:d,drawPhase:l.WGLDrawPhase.HITTEST,pixelRatio:a.pixelRatio,displayLevel:a.displayLevel,rendererInfo:this._rendererInfo,
requiredLevel:f,state:b,stationary:a.stationary},this.children)};c.prototype._updateTilesTransform=function(a,b){b=0;for(var c=this.children;b<c.length;b++){var d=c[b],e=this.tileInfoView.tileInfo.lods[d.key.level].resolution;d.setTransform(a,e/(a.resolution*a.pixelRatio));d.setLabelTransform(a,e)}};c.prototype._buildHLList=function(){for(var a=0,b=this.children;a<b.length;a++)b[a].buildHLList(this._layerView.highlightIDs);this.requestRender()};return c}(w.Container);n.default=m});