// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../geometry ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/workers ../../../../../core/accessorSupport/decorators ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/support/FeatureProcessing ../../../../../tasks/support/QuantizationParameters ../../../../../tasks/support/Query ../../../engine/webgl/Utils ./BaseController ../support/TileUpdateQueue".split(" "),
function(n,p,y,l,q,z,A,r,t,B,C,u,D,k,v,w,E,F,G,H,I,J){Object.defineProperty(p,"__esModule",{value:!0});var x=B.getLogger("esri.views.2d.layers.features.controllers.MemoryController");n=function(m){function b(){var a=null!==m&&m.apply(this,arguments)||this;a.type="memory";a._processingInMainThread=!1;return a}y(b,m);b.prototype.initialize=function(){var a=this;this._tileQueue=new J.default({tileInfoView:this.tileStore.tileScheme,process:function(c,d){return a._fetchFeatureSet(c,d)}});this._memorySource=
D.openWithPorts(this.service.source,{client:this});this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))};b.prototype.destroy=function(){this._memorySource.close();this._memorySource=null;this._tileQueue.clear();this._tileQueue.pause()};Object.defineProperty(b.prototype,"processing",{get:function(){return E.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this._tileQueue.updating},enumerable:!0,
configurable:!0});b.prototype.onEdits=function(a){this.refresh()};b.prototype.queryFeatures=function(a){return this._memorySource.invoke("queryFeatures",a)};b.prototype.queryFeatureCount=function(a){return this._memorySource.invoke("queryFeatureCount",a)};b.prototype.queryObjectIds=function(a){return this._memorySource.invoke("queryObjectIds",a)};b.prototype.queryExtent=function(a){return this._memorySource.invoke("queryExtent",a)};b.prototype.redraw=function(){this.refresh()};b.prototype.refresh=
function(){this._tileQueue.refresh();for(var a=0,c=this.tileStore.tiles;a<c.length;a++){var d=c[a];this._tileQueue.push(d.id,d.updateTimestamp)}};b.prototype.setViewState=function(a){this._tileQueue.state=a};b.prototype.setFilter=function(a){var c=a.index,d=a.filter;return A(this,void 0,void 0,function(){var a;return z(this,function(e){switch(e.label){case 0:return[4,this.setFilterBase(c,d)];case 1:return a=e.sent(),this.processor&&!this.processor.supportsTileUpdates&&this.redraw(),C.isNone(a)?(x.error(new t("featurelayer-controller:required-fields-error",
"Tried to set filter but was unable to find required fields")),[2,{show:[],hide:[]}]):[2,a]}})})};b.prototype.onTileUpdate=function(a){this._tileQueue.pause();for(var c=0,d=a.removed;c<d.length;c++){var e=d[c];this._tileQueue.cancel(e.id)}c=0;for(a=a.added;c<a.length;c++)e=a[c],this._tileQueue.push(e.id,e.updateTimestamp);this.processor&&this._tileQueue.resume()};b.prototype._switchProcessor=function(a,c){this.refresh();a&&this._tileQueue.resume()};b.prototype._fetchFeatureSet=function(a,c){var d=
this,e=this.tileStore.get(a),b=this.processor.queryInfo;return this._query(e,b).then(function(a){return d._setFilterFlags(a)}).then(function(a){return d._wrapPoints(a,b)}).then(function(a){return d._sortFeatures(a,b)}).then(function(a){return a.features.length?a:null}).then(function(a){e.updateTimestamp=c;return d.processor.onTileData(e,{addOrUpdate:a&&a.features,clear:!0,transformParams:a&&H.getTransformParams(a)})}).catch(function(a){e.updateTimestamp=c;"cancel"!==a.dojoType&&(d.processor.onTileError(e,
a.message),x.error("query-error",{error:a}));return u.reject(a)})};b.prototype._query=function(a,c){var d=this,e=new G,b=this._getQuantizationParameters(a),h=c.pixelBuffer*a.resolution;a=a.bounds.slice();a[0]-=h;a[1]-=h;a[2]+=h;a[3]+=h;e.outFields=this.processor.queryInfo.outFields;e.where=this.processor.queryInfo.definitionExpression||"1\x3d1";e.geometry=new r.Extent({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.spatialReference});this.service.capabilities.query.supportsQuantization?
(e.quantizationParameters=b,"esriGeometryPolyline"===this.service.geometryType&&(e.maxAllowableOffset=b.tolerance)):e.maxAllowableOffset=b.tolerance;e.resultType="tile";e.returnExceededLimitFeatures=!1;e.returnGeometry=!0;e.returnCentroid=c.returnCentroid;e.orderByFields=c.orderByFields;return this.queryFeatures(e.toJSON()).then(function(a){a.features=c.returnCentroid?a.features.filter(function(a){return null!=a.geometry&&null!=a.centroid}):a.features.filter(function(a){return null!=a.geometry});
return a}).then(function(a){return d._applyProcessing(a)})};b.prototype._applyProcessing=function(a){var c=this.processing;if(!c)return a;if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:a});try{var d=c.process(a,c.options);return d?d:u.reject(new t("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(e){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:a})}};b.prototype._getQuantizationParameters=
function(a){return new F.default({mode:"view",originPosition:"lower-left",tolerance:a.resolution,extent:new r.Extent({xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference})})};b.prototype._wrapPoints=function(a,c){if(0===a.features.length)return a;var d=c.returnCentroid;c=c.pixelBuffer;var b=a.geometryType,g=a.spatialReference,h=a.transform;if("esriGeometryPoint"!==b&&"esriGeometryMultipoint"!==b&&!d||!v.isWrappable(g))return a;d=a.features;g=
v.getInfo(g);h=Math.round((g.valid[1]-g.valid[0])/h.scale[0]);if(512===h){g=[];for(b=0;b<d.length;b++){var k=d[b],f=k.geometry,k=k.attributes;f&&(f.x<c?(f={geometry:q({},f),attributes:k},f.geometry.x+=h,g.push(f)):f.x>512-c&&(f={geometry:q({},f),attributes:k},f.geometry.x-=h,g.push(f)))}d.push.apply(d,g)}else for(g=0;g<d.length;g++)if(f=d[g].geometry)f.x<-c?f.x+=h:f.x>512+c&&(f.x-=h);return a};b.prototype._sortFeatures=function(a,c){if(c=c.orderByFields){c=c[0].split(" ");var b=c[0];"DESC"===c[1]&&
a.features.sort(function(a,c){return c.attributes[b]-a.attributes[b]})}return a};b.prototype._setFilterFlags=function(a){var c=w.convertFromFeatureSet(a,this.service.objectIdField);this.hasGeometryFilter()&&(c=w.hydrateOptimizedFeatureSet(c));for(var c=c.features,b=0;b<c.length;b++)a.features[b].filterFlags=this._getFilterFlags(c[b]);return a};l([k.property()],b.prototype,"_tileQueue",void 0);l([k.property({readOnly:!0,dependsOn:["configuration"]})],b.prototype,"processing",null);l([k.property({dependsOn:["_tileQueue.updating"]})],
b.prototype,"updating",null);return b=l([k.subclass()],b)}(k.declared(I.default));p.default=n});