// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix-2/mat2d ../../../../core/libs/gl-matrix-2/mat2df32 ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f32 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../DisplayObject ./definitions ./DirtyMap ./DisplayRecordStore ./enums ./Fader ./number ./Utils ./WGLBuffers ./WGLDisplayList ../../tiling/TileKey".split(" "),function(N,O,C,v,D,x,y,E,F,G,u,z,
A,p,H,I,t,J,K,L){function M(p,b){return p.sortKey-b.sortKey}var w=new Set;return function(B){function b(a,k,f){void 0===f&&(f=!1);var d=B.call(this)||this;d._data=null;d.hlDisplayList=null;d._displayList=null;d._wglBuffers=null;d._dirtyMap=new z.default;d.coords=[0,0];d.bounds=[0,0,0,0];d.dvsMat3=y.mat3f32.create();d.tileMat3=y.mat3f32.create();d.labelMat2d=D.mat2df32.create();d._labelIndex=null;d._dirty=!0;d.fader=new H.default;d.key=L.pool.acquire(a);d.coords[0]=k[0];d.coords[1]=k[3];d.bounds=k;
d._ensureCorrectZOrder=f;return d}C(b,B);Object.defineProperty(b.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canDisplay",{get:function(){return!!this.attached},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isDirty",{get:function(){return this._dirty},set:function(a){(this._dirty=a)||this.isReady||this.ready();this.requestRender()},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0});b.prototype.getGeometry=function(a){return this._wglBuffers&&this._wglBuffers.has(a)?this._wglBuffers.get(a):null};b.prototype.getDisplayList=function(a){switch(a){case p.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._displayList}};Object.defineProperty(b.prototype,
"data",{get:function(){return this._data},enumerable:!0,configurable:!0});b.prototype.setData=function(a,k,f){var d=a.addOrUpdate,g=a.remove;this.fader.reset();!a.clear&&this.hasData||a.addOrUpdate?!a.clear&&this.hasData||!a.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:d,remove:g},k,f):(d.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new z.default,this._dispRecStore=A.default.fromTileData(d,this._dirtyMap),this._data=d,this._readyTileIfNoLabels(k,f),this._dirtyMap.markAllDirty(),
this._displayList||(this._displayList=d.tileDisplayData.displayList.clone())):(this.clear(),this.ready())};b.prototype.commitChanges=function(a){this.isDirty&&this._wglBuffers||(this._wglBuffers||(this._wglBuffers=new J.default(this.stage.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())};b.prototype.resetVisibility=function(a){var k=this,f=[],d=Array(1);a.forEach(function(a){d[0]=
a;k.setFilterFlag(0,f,d)})};b.prototype.setFilterFlag=function(a,k,f){if(this.hasData){for(var d=1<<a,g=this._data.tileBufferData.geometries.map(t.geometryToMappedGeometry),m=0;m<k.length;m++){var b=this._data.tileDisplayData.displayObjectRegistry.get(k[m]);if(b){b.setFilterFlag(a,!0);for(var l=0,h=b.displayRecords;l<h.length;l++){var c=h[l],e=g[c.geometryType];if(b=e.geometry.vertexBuffer[t.C_VBO_VISIBILITY]){e.vertexFrom=null==e.vertexFrom?c.vertexFrom:Math.min(e.vertexFrom,c.vertexFrom);e.vertexTo=
null==e.vertexTo?c.vertexFrom+c.vertexCount:Math.max(e.vertexTo,c.vertexFrom+c.vertexCount);for(var e=c.vertexFrom,c=c.vertexCount,n=0;n<c;++n)b.data[e+n]|=d}}}}for(k=0;k<f.length;k++)if(b=this._data.tileDisplayData.displayObjectRegistry.get(f[k]))for(b.setFilterFlag(a,!1),m=0,l=b.displayRecords;m<l.length;m++)if(c=l[m],e=g[c.geometryType],b=e.geometry.vertexBuffer[t.C_VBO_VISIBILITY])for(e.vertexFrom=null==e.vertexFrom?c.vertexFrom:Math.min(e.vertexFrom,c.vertexFrom),e.vertexTo=null==e.vertexTo?
c.vertexFrom+c.vertexCount:Math.max(e.vertexTo,c.vertexFrom+c.vertexCount),e=c.vertexFrom,c=c.vertexCount,n=0;n<c;++n)b.data[e+n]&=~d;a=!1;for(f=0;f<g.length;++f)e=g[f],null!=e.vertexFrom&&null!=e.vertexTo&&(this._dirtyMap.markDirtyVertices(f,t.C_VBO_VISIBILITY,e.vertexFrom,e.vertexTo?e.vertexTo-e.vertexFrom:0),a=!0);a&&this.requestRender()}};b.prototype.setVisibilityRange=function(a,k,f,d){a=this._data.tileDisplayData.displayObjectRegistry.get(a);for(var g=this._data.tileBufferData.geometries[p.WGLGeometryType.LABEL].vertexBuffer[t.C_VBO_VISIBILITY_RANGE],
b=Infinity,q=0,l=k;l<k+f;++l){for(var h=a.displayRecords[l],c=Math.max(h.minZoom,d),e=h.maxZoom,c=I.i8888to32(c,e,c,e),e=h.vertexFrom*g.stride/4,n=h.vertexCount*g.stride/4,r=e;r<e+n;++r)g.data[r]=c;b=Math.min(b,h.vertexFrom);q=Math.max(q,h.vertexFrom+h.vertexCount)}this._dirtyMap.markDirtyVertices(p.WGLGeometryType.LABEL,t.C_VBO_VISIBILITY_RANGE,b,q-b)};b.prototype.setTransform=function(a,k){var f=this.tileMat3,d=a.toScreenNoRotation([0,0],this.coords);x.mat3.set(this.tileMat3,k,0,0,0,k,0,d[0],d[1],
1);x.mat3.multiply(this.dvsMat3,a.displayViewMat3,f)};b.prototype.setLabelTransform=function(a,k){var f=this.labelMat2d;k=a.getScreenTransform(f,k);var d=F.vec2f32.create();E.vec2.transformMat2d(d,this.coords,k);v.mat2d.identity(f);v.mat2d.translate(f,f,d);v.mat2d.multiply(f,a.viewMat2d,f)};b.prototype.clear=function(){this._dispRecStore=this._displayList=this._data=null;this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null);this.hlDisplayList&&(this.hlDisplayList=null)};b.prototype.attach=
function(){return!0};b.prototype.dispose=function(){this.clear()};b.prototype.doRender=function(a){if(this.isReady&&this.hasData){this.commitChanges(a);this.stage.context.setStencilFunction(514,this.stencilRef,255);if(a.drawPhase===p.WGLDrawPhase.MAP||a.drawPhase===p.WGLDrawPhase.LABEL||a.drawPhase===p.WGLDrawPhase.LABEL_ALPHA)this._displayList.replay(a,this);else for(var k=0,f=this.stage.painter.getBrushes(a.drawPhase);k<f.length;k++)f[k].draw(a,this);this.fader.step()||this.requestRender()}};b.prototype.buildHLList=
function(a){var k=this;this.hlDisplayList=new K;a.forEach(function(a){k._addToHLDisplayList(k.hlDisplayList,a)})};b.prototype._addToHLDisplayList=function(a,k){if(this._data){var f=this._data.tileDisplayData.displayObjectRegistry.get(k);if(f){k=[];for(var d=0,f=f.displayRecords;d<f.length;d++){var b=f[d].copy();b.meshData=null;b.symbolLevel=0;b.zOrder=0;k.push(b)}k.sort(M);a.addToList(k)}}};b.prototype._readyTileIfNoLabels=function(a,b){a&&b?(this._rebuildLabelIndex(),this.isDirty=!0):this.isDirty=
!1};b.prototype._doPatchData=function(a,b,f){this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=A.default.fromTileData(this._data,this._dirtyMap));this._readyTileIfNoLabels(b,f);this.requestRender()};b.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var a=0,b=this.displayObjects;a<b.length;a++)for(var f=0,d=b[a].metrics;f<d.length;f++)this._insertIntoLabelIndex(d[f])};b.prototype._insertIntoLabelIndex=function(a){-1!==a.xBucket&&
this.labelIndex[a.yBucket][a.xBucket].push(a)};b.prototype._initLabelIndex=function(){for(var a=[],b=0;b<u.TILE_SIZE/u.COLLISION_BUCKET_SIZE;b++){a.push([]);for(var f=0;f<u.TILE_SIZE/u.COLLISION_BUCKET_SIZE;f++)a[b].push([])}return a};b.prototype._patchData=function(a){for(var b=!0,f=a.addOrUpdate&&a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||[],d=(a.remove||[]).slice(),g=0;g<f.length;g++){var m=f[g];null!=m.insertAfter&&d.push(m.id)}for(m=0;m<d.length;m++){var q=d[m];
if(g=this._data.tileDisplayData.displayObjectRegistry.get(q)){this._data.tileDisplayData.displayList.removeFromList(g.displayRecords);for(var l=0,h=g.displayRecords;l<h.length;l++)this._dispRecStore.delete(h[l]);this._data.tileDisplayData.displayObjectRegistry.delete(q);g=this._data.tileDisplayData.displayObjects.indexOf(g);this._data.tileDisplayData.displayObjects.splice(g,1)}}for(d=0;d<f.length;d++){m=f[d];g=this._data.tileDisplayData.displayObjectRegistry.get(m.id);q=void 0;if(g){l=g.displayRecords;
g.set(m);g.displayRecords=l;l=g.displayRecords.length;for(h=0;h<l;++h){var c=g.displayRecords[h],e=m.displayRecords[h];if(h>=m.displayRecords.length||c.geometryType!==e.geometryType||c.symbolLevel!==e.symbolLevel||c.zOrder!==e.zOrder||c.materialKey!==e.materialKey)this._dispRecStore.delete(g.displayRecords[h]),h<m.displayRecords.length&&(g.displayRecords[h]=void 0)}g.displayRecords.length=m.displayRecords.length;g.metrics=m.metrics}else if(g=m.copy(),g.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(m.id,
g),h=void 0,c=this._data.tileDisplayData.displayObjects,null!=g.insertAfter?(q={},0<=g.insertAfter?(l=this._data.tileDisplayData.displayObjectRegistry.get(g.insertAfter))?(h=c.indexOf(l)+1,h<c.length?c.splice(h,0,g):(c.push(g),h=c.length)):(c.push(g),h=c.length):(c.unshift(g),h=0)):(c.push(g),h=c.length),q){e=void 0;if(this._data.tileDisplayData.displayList.unified)e=0<m.displayRecords.length?1:0;else{w.clear();for(var e=0,n=m.displayRecords;e<n.length;e++)l=this._data.tileDisplayData.displayList.getDPInfoType(n[e].geometryType),
w.add(l);e=w.size}n=0;for(--h;0<=h&&n<e;--h)for(var r=c[h].displayRecords.length-1;0<=r&&n<e;--r){var p=c[h].displayRecords[r],l=this._data.tileDisplayData.displayList.getDPInfoType(p.geometryType);q[l]||(q[l]=p,++n)}}n=m.displayRecords.length;for(h=0;h<n;++h){e=m.displayRecords[h];(c=g.displayRecords[h])?(c.meshData=e.meshData,c.materialKey=e.materialKey):(c=e.copy(),c.vertexFrom=void 0,c.indexFrom=void 0,g.displayRecords[h]=c);var r=e.geometryType,l=this._data.tileDisplayData.displayList.getDPInfoType(r),
p=a.addOrUpdate.tileBufferData.geometries[r],r=p.vertexBuffer,p=p.indexBuffer,t=void 0;q&&(t=q[l]?this._data.tileDisplayData.displayList.splitAfter(q[l]):-1);b=this._dispRecStore.setMeshData(c,e,r,p,t)&&b;q&&null!=c.indexFrom&&null!=c.indexFrom&&(q[l]=c)}}return b};return b}(G.DisplayObject)});