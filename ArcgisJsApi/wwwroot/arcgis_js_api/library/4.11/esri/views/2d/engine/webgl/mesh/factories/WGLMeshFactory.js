// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/maybe ../../../../../../geometry/support/jsonUtils ../../../../../../symbols/SimpleLineSymbol ../../definitions ../../enums ../../WGLDisplayObject ../../collisions/LayerCollisionInfo ../MeshData ../VertexVector ./VVFactory ../templates/WGLLabelTemplate ../templates/WGLLineTemplate ../templates/WGLMarkerTemplate ../templates/WGLTemplateStore ../../util/vvFlagUtils".split(" "),
function(w,x,M,y,B,t,C,D,z,k,E,F,G,m,H,I,J,K,A,q){Object.defineProperty(x,"__esModule",{value:!0});var v=B.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),L={esriGeometryPoint:"above-right above-center above-left center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null,esriGeometryEnvelope:null};w=function(){function l(b,a,c,e,n,d,f,h,p){this._isDD=!1;this._labelsDebugVVEval=
this._labelsDebugTemplate=null;d=t.isSome(c)&&"visualVariables"in c&&c.visualVariables;this._isDD=t.isSome(c)&&"dot-density"===c.type;this._geometryType=b;this._idField=a;this._pixelRatio=n;this._vvFlags=d?q.getVVFlags(d):0;this._vvFactory=t.isSome(c)&&H.default.fromRenderer(c,e);this._vvBuf=new ArrayBuffer(32);this._vvBufU32=new Uint32Array(this._vvBuf);this._vvBufF32=new Float32Array(this._vvBuf);this._templateStore=f;h&&(z.DEBUG_LABELS&&(this._labelsDebugVVEval=d&&F.createLabelVVEvaluator(d)),
this._validateLabelingInfo(h)&&(this._labelTemplates=h.map(function(a){return I.default.fromLabelClass(c,a,p)})))}Object.defineProperty(l.prototype,"templates",{get:function(){return this._templateStore},enumerable:!0,configurable:!0});l.prototype.createMeshData=function(b){var a=Array(5),c=!!q.getMarkerVVFlags(this._vvFlags),e=!!q.getFillVVFlags(this._vvFlags),n=!!q.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),d=!!q.getTextVVFlags(this._vvFlags),f="esriGeometryPolyline"===
this._geometryType?z.HEURISTIC_GLYPHS_PER_LINE:z.HEURISTIC_GLYPHS_PER_FEATURE;a[k.WGLGeometryType.MARKER]=new m.VertexVectors(k.WGLGeometryType.MARKER,c,b);a[k.WGLGeometryType.FILL]=new m.VertexVectors(k.WGLGeometryType.FILL,e,b,this._isDD);a[k.WGLGeometryType.LINE]=new m.VertexVectors(k.WGLGeometryType.LINE,n,b);a[k.WGLGeometryType.TEXT]=new m.VertexVectors(k.WGLGeometryType.TEXT,d,b);a[k.WGLGeometryType.LABEL]=new m.VertexVectors(k.WGLGeometryType.LABEL,!1,this._labelTemplates&&0<this._labelTemplates.length?
f:0);return new G.default([],a)};l.prototype.analyze=function(b,a,c,e){for(var n=0;n<b.length;n++){var d=b[n],f=-1;if("symbol"in d)d.filterFlags=1,null!=d.symbol?f=this._templateStore.createTemplateGroup(d.symbol,null,null,null):a&&(f=a.match(d,c,e));else if(a&&(f=a.match(d,c,e),A.isDynamicId(f)))for(var h=0,p=this._templateStore.getDynamicTemplateGroup(f);h<p.length;h++){var g=p[h];g&&g.analyze&&g.analyze(d,this._templateStore)}d.groupId=f}return this._templateStore.finalize().then(function(){return b})};
l.prototype.write=function(b,a,c,e,n,d,f){var h=this._templateStore.getTemplateGroup(a.groupId),p=a.attributes[this._idField],g=new E(p),l=!!d&&!!this._labelTemplates&&d.has(p);if(A.isDynamicId(a.groupId))for(var k=0;k<h.length;k++){var u=h[k];u.bindFeature(a,c,e)}if(h&&(a.geometry||a.centroid)){this._vvFactory&&this._vvFactory.computeVV(this._vvBufF32,a,c,e);k=g.displayRecords;u=a.insertAfter;void 0!==u&&(g.insertAfter=u);(c=this._geometryType)||(c=null!=a.centroid?"esriGeometryPolygon":C.getJsonType(a.geometry));
e=a.filterFlags;g.filterFlags=e;for(var m=0;m<h.length;m++){var u=h[m],q=b.get(u.geometryType);u.writeMesh(k,q,c,p,a,this._pixelRatio,this._vvBufU32,e)}l&&(h=this._getLabelReference(h),d=d.get(p),this._writeLabelMesh(g,b,p,a,f,d,h,n,c,e));b.pushDisplayObject(g)}};l.prototype._hasBadLabelClass=function(b,a){var c=b.labelPlacement,e=L[a];if(!b.symbol)return v.error(new y("mapview-labeling:missing-required-parameter","Unable to create labels for Feature Layer, LabelClass missing symbol",b)),!0;if(!e)return v.error(new y("mapview-labeling:unsupported-geometry-type",
"Unable to create labels for Feature Layer, "+a+" is not supported")),!0;e.some(function(a){return a===c})||(e=e[0],c&&v.warn("Found invalid label placement type "+c+" for "+a+". Defaulting to "+e),b.labelPlacement=e);return!1};l.prototype._validateLabelingInfo=function(b){var a=this;return!b.some(function(b){return a._hasBadLabelClass(b,a._geometryType)})};l.prototype._getLabelReference=function(b){for(var a=0;a<b.length;a++){var c=b[a];if(c instanceof K.default)return c}return null};l.prototype._writeLabelMesh=
function(b,a,c,e,k,d,f,h,p,g){for(var l=b.displayRecords,n=[],m=this._pixelRatio,q=this._vvBufU32,t=0;t<d.length;t++){var r=d[t],v=r.text,w=r.rtl,r=this._labelTemplates[r.id],x=a.get(r.geometryType),y=k.get(r.symbolId).glyphMosaicItems;r.bindReferenceTemplate(f);r.bindTextInfo(y,v,w);r.writeMesh(l,x,p,c,e,m,q,g,h,n)}b.metrics=n;z.DEBUG_LABELS&&this._debugLabels(b,a,g)};l.prototype._debugLabels=function(b,a,c){var e=b.displayRecords,k=b.id,d=0;for(b=b.metrics;d<b.length;d++){var f=b[d],h=f.boxes?f.boxes.concat([f.bounds]):
[f.bounds];this._labelsDebugVVEval&&f.computeOffset(this._labelsDebugVVEval);for(var l=0;l<h.length;l++){var g=h[l],g={geometry:{paths:[[[f.anchor[0]+f.offsetX+g.center[0]-g.width/2,f.anchor[1]+f.offsetY+g.center[1]+g.height/2],[0,-g.height],[g.width,0],[0,g.height],[-g.width,0]]]},attributes:{}},m=this._getLabelDebugTemplate(),q=a.get(m.geometryType);m.writeMesh(e,q,"esriGeometryPolyline",k,g,this._pixelRatio,null,c)}}};l.prototype._getLabelDebugTemplate=function(){this._labelsDebugTemplate||(this._labelsDebugTemplate=
this._createLabelsDebugTemplate());return this._labelsDebugTemplate};l.prototype._createLabelsDebugTemplate=function(){var b=new D({style:"solid",width:1,color:[255,0,0,1]});return J.default.fromSimpleLine(null,!1,b,null)};return l}();x.default=w});