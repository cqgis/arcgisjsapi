// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/screenUtils ../../../../../../core/libs/gl-matrix-2/mat2d ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../color ../../definitions ../../enums ../../fontUtils ../../number ../../TextShapingNew ../../WGLDisplayRecord ../../collisions/BoundingBox ../../materialKey/MaterialKey ./ComputedGlyph ./WGLMeshTemplate ../../util/BidiText ../../../../layers/graphics/graphicsUtils ../../../../../vectorTiles/GeometryUtils".split(" "),
function(v,G,J,K,L,w,x,M,q,y,H,z,A,N,C,D,I,O,B,P,Q,R,E,S){Object.defineProperty(G,"__esModule",{value:!0});var T=L.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),U=M.mat2df32.create(),F=y.vec2f32.create();v=function(v){function k(c,a){var b=v.call(this)||this;b.geometryType=A.WGLGeometryType.TEXT;b._xOffset=w.pt2px(a.xoffset);b._yOffset=w.pt2px(a.yoffset);b._decorationTop=N.getFontDecorationTop(a.font);b._color=(a.color&&H.premultiplyAlphaRGBA(a.color))|0;b._haloColor=(a.haloColor&&H.premultiplyAlphaRGBA(a.haloColor))|
0;b._haloSize=Math.min(Math.floor(5*w.pt2px(w.toPt(a.haloSize||0))),127);b._size=Math.min(Math.round(w.pt2px(a.font.size)),127);b._scale=b._size/24;b._angle=a.angle||0;b._justify=E.getJustification(a.horizontalAlignment||"center");b._xAlignD=E.getXAnchorDirection(a.horizontalAlignment||"center");b._yAlignD=-E.getYAnchorDirection(a.verticalAlignment||"baseline");b._baseline="baseline"===(a.verticalAlignment||"baseline");b._bitset=0;c=B.MaterialKeyBase.load(B.createMaterialKey(b.geometryType,c,!1));
c.sdf=!0;b._materialKey=c.data;b.symbolId=a.id;return b}J(k,v);k.fromText=function(c,a,b){c=new k(c,a);a=R.bidiText(a.text);c.bindTextInfo(b,a[0],a[1]);c._computeGlyphs(c._shapedGlyphs,c._shapedBox);return c};k.prototype.bindTextInfo=function(c,a,b){c=this._computeShaping(c,this._justify).getShaping(a,b);isNaN(this._decorationTop)||D.addDecoration(c,this._decorationTop);this._shapedGlyphs=c;this._shapedBox=D.getBox(c)};k.prototype.writeMesh=function(c,a,b,f,e,g,h,n){g=this._computedGlyphs;var l=B.TextMaterialKey.load(this._materialKey),
m=C.i8888to32(0,0,0,this._bitset);switch(b){case "esriGeometryPoint":e=e.geometry;b=e.x;e=e.y;for(var d=0;d<g.length;d++){var r=g[d];r.anchorX=b;r.anchorY=e}this._writeVertices(c,a,f,h,g,n,l,m,0,0);break;case "esriGeometryPolygon":if(e.centroid){e=e.centroid;b=e.x;e=e.y;for(d=0;d<g.length;d++)r=g[d],r.anchorX=b,r.anchorY=e;this._writeVertices(c,a,f,h,g,n,l,m,0,0);break}case "esriGeometryMultipoint":for(var d=e.geometry.points,k=e=b=0;k<d.length;k++){r=d[k];b+=r[0];e+=r[1];for(var t=0,p=g;t<p.length;t++)r=
p[t],r.anchorX=b,r.anchorY=e;this._writeVertices(c,a,f,h,g,n,l,m,0,0)}break;default:c=void 0,void 0===c&&(c="mapview-processing"),T.error(K(c,"Unable to handle geometryType: "+b))}};k.prototype._computeGlyphs=function(c,a){var b=Array(c.length);a=this._computeGlyphTransform(a);for(var f=B.MaterialKeyBase.load(this._materialKey),e=0;e<c.length;e++){var g=c[e],h=g.x,n=g.y,l=g.codePoint,g=g.glyphMosaicItem;f.textureBinding=g.textureBinding;b[e]=P.default.from(h,n,0,0,-1,0,25,g,l,f.data,a,this._size,
this._haloSize,!1,!0)}this._computedGlyphs=b};k.prototype._createBounds=function(c,a){var b=c.width/2,f=c.height/2,e=a[4],g=a[5],h;if(this._angle){c=y.vec2f32.fromValues(-b,-f);h=y.vec2f32.fromValues(b,-f);var n=y.vec2f32.fromValues(-b,f),l=y.vec2f32.fromValues(b,f);q.vec2.transformMat2d(c,c,a);q.vec2.transformMat2d(h,h,a);q.vec2.transformMat2d(n,n,a);q.vec2.transformMat2d(l,l,a);a=f=Infinity;var m=0,d=b=0;for(c=[c,h,n,l];d<c.length;d++)h=c[d],f=Math.min(h[0],f),m=Math.max(h[0],m),a=Math.min(h[1],
a),b=Math.max(h[1],b);h=m-f;c=b-a}else h=c.width*this._scale,c=c.height*this._scale;return new O.default(e,g,h+z.COLLISION_BOX_PADDING,c+z.COLLISION_BOX_PADDING)};k.prototype._computeShaping=function(c,a){return new D([c],512,z.TEXT_LINE_HEIGHT,z.TEXT_SPACING,[0,.5*-z.TEXT_LINE_HEIGHT],.5*(1-this._xAlignD),0,a)};k.prototype._computeGlyphTransform=function(c){var a=this._scale,b=this._angle*S.C_DEG_TO_RAD,f=x.mat2d.identity(U);x.mat2d.rotate(f,f,b);x.mat2d.translate(f,f,q.vec2.set(F,this._xOffset,
-this._yOffset));x.mat2d.scale(f,f,q.vec2.set(F,a,a));x.mat2d.translate(f,f,q.vec2.set(F,-4,-4-(this._baseline?25:c.y+(1-this._yAlignD)*c.height*.5)));return f};k.prototype._writeVertices=function(c,a,b,f,e,g,h,n,l,m){this._writeHalos(c,a,b,f,e,g,h,n,l,m);this._writeText(c,a,b,f,e,g,h,n,l,m)};k.prototype._writeHalos=function(c,a,b,f,e,g,h,n,l,m){var d=a.indexVector;h=h.hasVV();var k=a.getVector("geometry").vertexCount,q=0;if(this._haloSize)for(var t=0;t<e.length;t++,q+=4){var p=e[t],v=C.i1616to32(2*
p.anchorX+1,2*p.anchorY),u=new I(b,this.geometryType,p.materialKey,null==l?Math.floor(10*p.minZoom):l,null==m?Math.floor(10*p.maxZoom):m);u.vertexFrom=k+q;u.indexFrom=d.length;this._writeVertex(u,a,b,v,this._haloColor,p,h,f,g,n);this._writeIndices(u,d,k+q);c.push(u)}};k.prototype._writeText=function(c,a,b,f,e,g,h,k,l,m){var d=a.indexVector;h=h.hasVV();for(var n=a.getVector("geometry").vertexCount,q=0,t=0;t<e.length;t++,q+=4){var p=e[t],v=C.i1616to32(2*p.anchorX,2*p.anchorY),u=new I(b,this.geometryType,
p.materialKey,null==l?Math.floor(10*p.minZoom):l,null==m?Math.floor(10*p.maxZoom):m);u.vertexFrom=n+q;u.indexFrom=d.length;this._writeVertex(u,a,b,v,this._color,p,h,f,g,k);this._writeIndices(u,d,n+q);c.push(u)}};k.prototype._writeVertex=function(c,a,b,f,e,g,h,k,l,m){var d=a.get("geometry");a=a.get("visibility");d.push(f);d.push(b);d.push(e);d.push(g.vertexOffsetUpperLeft);d.push(g.texFontSizeUpperLeft);d.push(m);this._writeVV(d,k,h);a.push(l);d.push(f);d.push(b);d.push(e);d.push(g.vertexOffsetUpperRight);
d.push(g.texFontSizeUpperRight);d.push(m);this._writeVV(d,k,h);a.push(l);d.push(f);d.push(b);d.push(e);d.push(g.vertexOffsetLowerLeft);d.push(g.texFontSizeLowerLeft);d.push(m);this._writeVV(d,k,h);a.push(l);d.push(f);d.push(b);d.push(e);d.push(g.vertexOffsetLowerRight);d.push(g.texFontSizeLowerRight);d.push(m);this._writeVV(d,k,h);a.push(l);c.vertexCount+=4};k.prototype._writeVV=function(c,a,b){b&&(c.push(a[A.VVType.SIZE]),c.push(a[A.VVType.COLOR]),c.push(a[A.VVType.OPACITY]),c.push(a[A.VVType.ROTATION]))};
k.prototype._writeIndices=function(c,a,b){a.push(b+0);a.push(b+1);a.push(b+2);a.push(b+1);a.push(b+3);a.push(b+2);c.indexCount+=6};return k}(Q.default);G.default=v});