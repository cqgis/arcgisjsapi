// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../core/screenUtils ../../../../../../core/libs/gl-matrix-2/mat2d ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../../cim/cimAnalyzer ../../color ../../enums ../../number ../../WGLDisplayRecord ../../materialKey/MaterialKey ./util ./WGLDynamicMeshTemplate ../../util/Result".split(" "),
function(x,B,F,G,H,n,z,I,q,C,J,y,t,w,K,A,f,L,M){Object.defineProperty(B,"__esModule",{value:!0});var N=3.14159265359/180,e=C.vec2f32.create(),r=I.mat2df32.create(),D=G.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");x=function(x){function h(c,a){var b=x.call(this)||this;b.geometryType=t.WGLGeometryType.MARKER;b.xOffset=0;b.yOffset=0;b.width=0;b.height=0;b._dynamicPropertyMap=new Map;b._cimMarkerLayer=a;var u=0;f.isFunction(a.color)||(u=y.premultiplyAlphaRGBA(a.color));b._dynamicPropertyMap.set("_fillColor",
function(b,c,d){return f.isFunction(a.color)?y.premultiplyAlphaRGBA(a.color(b,c,d)):u});var d=0;f.isFunction(a.outlineColor)||(d=y.premultiplyAlphaRGBA(a.outlineColor));b._dynamicPropertyMap.set("_outlineColor",function(b,c,g){return f.isFunction(a.outlineColor)?y.premultiplyAlphaRGBA(a.outlineColor(b,c,g)):d});var l;f.isFunction(a.size)||(l=n.pt2px(a.size));b._dynamicPropertyMap.set("_size",function(b,c,d){return f.isFunction(a.size)?n.pt2px(a.size(b,c,d)):l});var k;f.isFunction(a.scaleX)||(k=a.scaleX);
b._dynamicPropertyMap.set("_scaleX",function(b,c,d){return f.isFunction(a.scaleX)?a.scaleX(b,c,d):k});var e;f.isFunction(a.offsetX)||(e=n.pt2px(a.offsetX));b._dynamicPropertyMap.set("xOffset",function(b,c,d){return f.isFunction(a.offsetX)?n.pt2px(a.offsetX(b,c,d)):e});var E;f.isFunction(a.offsetY)||(E=n.pt2px(a.offsetY));b._dynamicPropertyMap.set("yOffset",function(b,c,d){return f.isFunction(a.offsetY)?n.pt2px(a.offsetY(b,c,d)):E});var p;f.isFunction(a.outlineWidth)||(p=n.pt2px(a.outlineWidth));b._dynamicPropertyMap.set("_outlineWidth",
function(b,c,d){return f.isFunction(a.outlineWidth)?n.pt2px(a.outlineWidth(b,c,d)):p});var g;f.isFunction(a.rotation)||(g=a.rotation);b._dynamicPropertyMap.set("_angle",function(b,c,d){return f.isFunction(a.rotation)?a.rotation(b,c,d):g});b._colorLockedAndAlignment=(a.alignment===t.Alignment.MAP?1:0)|(a.colorLocked?1:0)<<1;b._materialKey=A.createMaterialKey(b.geometryType,c,!1);return b}F(h,x);h.fromCIMMarker=function(c,a){return new h(c,a)};h.prototype.analyze=function(c,a){var b=this._materialCache,
e=this._cimMarkerLayer.materialHash(c);return b.has(e)?(c=b.get(e),H.resolve(c)):a.getMosaicItem(J.analyzeCIMResource(c,this._cimMarkerLayer.cim)).then(function(a){b.set(e,a);return a})};h.prototype.bindFeature=function(c,a,b){var u=this,d=this._dynamicPropertyMap;d&&d.forEach(function(d,e){u[e]=d(c,a,b)});var l=this._cimMarkerLayer.rotateClockwise?-this._angle:this._angle,d=this._size*this._scaleX,k=this._size,v=this.xOffset,f=this.yOffset,p=this._outlineWidth*(this._cimMarkerLayer.frameHeight?k/
this._cimMarkerLayer.frameHeight:1),g=this._materialCache,m=this._cimMarkerLayer.materialHash(c);if(g=g.get(m))m=1,g&&M.ok(g.spriteMosaicItem)&&(g=g.spriteMosaicItem,this._sizeOutlineWidth=w.i8888to32(d,k,p,this._colorLockedAndAlignment),m=g.sdf?.5:1,z.mat2d.identity(r),z.mat2d.translate(r,r,C.vec2f32.fromValues(m*v,m*-f)),l&&z.mat2d.rotate(r,r,N*l),l=Math.round(g.rect.x/4)-128,v=Math.round(g.rect.y/4)-128,f=l+Math.round(g.rect.width/4),p=v+Math.round(g.rect.height/4),q.vec2.set(e,-.5*d,-.5*k),q.vec2.transformMat2d(e,
e,r),this._offsetAndTexUpperLeft=w.i8888to32(e[0],e[1],l,v),q.vec2.set(e,.5*d,-.5*k),q.vec2.transformMat2d(e,e,r),this._offsetAndTexUpperRight=w.i8888to32(e[0],e[1],f,v),q.vec2.set(e,-.5*d,.5*k),q.vec2.transformMat2d(e,e,r),this._offsetAndTexBottomLeft=w.i8888to32(e[0],e[1],l,p),q.vec2.set(e,.5*d,.5*k),q.vec2.transformMat2d(e,e,r),this._offsetAndTexBottomRight=w.i8888to32(e[0],e[1],f,p),d=A.MarkerMaterialKey.load(this._materialKey),g&&(d.sdf=g.sdf,d.pattern=!0,d.textureBinding=g.textureBinding),this._materialKey=
d.data)};h.prototype.writeMesh=function(c,a,b,e,d,l,k,f){l=A.MarkerMaterialKey.load(this._materialKey);var h=a.indexVector,p=a.get("geometry"),g=a.get("visibility"),m=new K(e,this.geometryType,this._materialKey);a=a.getVector("geometry").vertexCount;c.push(m);m.vertexFrom=a;m.indexFrom=h.length;switch(b){case "esriGeometryPoint":b=d.geometry;c=b.x;b=b.y;this._writeVertices(m,p,g,e,this._getPos(c,b),l,k,f);this._writeIndices(m,h,a);break;case "esriGeometryPolyline":this._writeMany(m,h,p,g,a,e,d.geometry.paths[0],
l,k,f);break;case "esriGeometryPolygon":(b=d.centroid)?(c=b.x,b=b.y,this._writeVertices(m,p,g,e,this._getPos(c,b),l,k,f),this._writeIndices(m,h,a)):D.error("Tried to render polygon geometries as markers, but found no centroid!");break;case "esriGeometryMultipoint":this._writeMany(m,h,p,g,a,e,d.geometry.points,l,k,f);break;default:D.error("Unable to handle geometryType: "+b)}};h.prototype._getPos=function(c,a){return w.i1616to32(c,a)};h.prototype._writeMany=function(c,a,b,e,d,f,k,h,r,p){for(var g=
0,l=0,v=0,u=0;u<k.length;u++){var n=k[u],q=n[0],n=n[1],t=this._getPos(q+g,n+l);this._writeVertices(c,b,e,f,t,h,r,p);this._writeIndices(c,a,d+v);g+=q;l+=n;v+=4}};h.prototype._writeVertices=function(c,a,b,e,d,f,k,h){a.push(d);a.push(this._offsetAndTexUpperLeft);a.push(e);a.push(this._fillColor);a.push(this._outlineColor);a.push(this._sizeOutlineWidth);this._writeVV(a,k,f);b.push(h);a.push(d);a.push(this._offsetAndTexUpperRight);a.push(e);a.push(this._fillColor);a.push(this._outlineColor);a.push(this._sizeOutlineWidth);
this._writeVV(a,k,f);b.push(h);a.push(d);a.push(this._offsetAndTexBottomLeft);a.push(e);a.push(this._fillColor);a.push(this._outlineColor);a.push(this._sizeOutlineWidth);this._writeVV(a,k,f);b.push(h);a.push(d);a.push(this._offsetAndTexBottomRight);a.push(e);a.push(this._fillColor);a.push(this._outlineColor);a.push(this._sizeOutlineWidth);this._writeVV(a,k,f);b.push(h);c.vertexCount+=4};h.prototype._writeVV=function(c,a,b){b.hasVV()&&(c.push(a[t.VVType.SIZE]),c.push(a[t.VVType.COLOR]),c.push(a[t.VVType.OPACITY]),
c.push(a[t.VVType.ROTATION]))};h.prototype._writeIndices=function(c,a,b){a.push(b+0);a.push(b+1);a.push(b+2);a.push(b+1);a.push(b+3);a.push(b+2);c.indexCount+=6};return h}(L.default);B.default=x});