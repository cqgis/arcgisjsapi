// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat2d ../../../../core/libs/gl-matrix-2/mat2df32 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/boundsUtils ../../../../geometry/support/intersects ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtils ../../../../geometry/support/spatialReferenceUtils ../../../../geometry/support/spatialReferenceUtils ../../engine/webgl/definitions ../../engine/webgl/fontUtils ../../engine/webgl/GeometryUtils ../../engine/webgl/TextShapingNew ../../engine/webgl/TileClipper ../../engine/webgl/util/BidiText".split(" "),
function(ja,m,t,p,ba,h,u,A,ca,M,N,q,B,da,O,r,ea,C,w,fa,P){function G(a){switch(a){case "left":return 1;case "right":return-1;case "center":case "justify":return 0}}function Q(a){switch(a){case "top":return-1;case "middle":return 0;case "baseline":case "bottom":return 1}}function H(a){switch(a){case "left":return 0;case "right":return 1;case "center":case "justify":return.5}}function R(a,c,b,d,e){var f,k,v=t.pt2px(b.xoffset),g=t.pt2px(b.yoffset),l=C.C_DEG_TO_RAD*b.angle;e*=C.C_DEG_TO_RAD;switch(b.type){case "simple-marker":f=
k=t.pt2px(b.size);break;case "picture-marker":f=t.pt2px(b.width),k=t.pt2px(b.height)}b=p.mat2d.identity(S);p.mat2d.translate(b,b,h.vec2.set(n,a,c));p.mat2d.rotate(b,b,e-l);p.mat2d.scale(b,b,h.vec2.set(n,d,-d));p.mat2d.translate(b,b,h.vec2.set(n,v,-g));a=[0,0];h.vec2.transformMat2d(a,h.vec2.set(n,-.5*f,-.5*k),b);c=[0,0];h.vec2.transformMat2d(c,h.vec2.set(n,-.5*f,.5*k),b);d=[0,0];h.vec2.transformMat2d(d,h.vec2.set(n,.5*f,-.5*k),b);v=[0,0];h.vec2.transformMat2d(v,h.vec2.set(n,.5*f,.5*k),b);return{rings:[[a,
d,v,c,a]]}}function T(a,c,b,d,e,f){var k=Q(b.verticalAlignment||"baseline"),v="baseline"===(b.verticalAlignment||"baseline"),g=t.pt2px(b.xoffset),l=t.pt2px(b.yoffset),m=t.pt2px(b.font.size)/24,U=4*m,k=v?25*m:d[1]+(1+k)*d[3]*.5;b=C.C_DEG_TO_RAD*b.angle;v=C.C_DEG_TO_RAD*f;f=p.mat2d.identity(S);p.mat2d.translate(f,f,h.vec2.set(n,a,c));p.mat2d.rotate(f,f,v-b);p.mat2d.scale(f,f,h.vec2.set(n,e,-e));p.mat2d.translate(f,f,h.vec2.set(n,g,-l));p.mat2d.translate(f,f,h.vec2.set(n,-U,-U-k));a=[0,0];h.vec2.transformMat2d(a,
h.vec2.set(n,d[0],d[1]),f);c=[0,0];h.vec2.transformMat2d(c,h.vec2.set(n,d[0],d[1]+d[3]),f);e=[0,0];h.vec2.transformMat2d(e,h.vec2.set(n,d[0]+d[2],d[1]),f);g=[0,0];h.vec2.transformMat2d(g,h.vec2.set(n,d[0]+d[2],d[1]+d[3]),f);return{rings:[[a,e,g,c,a]]}}function I(a,c,b){if(!b||0===b.glyphMosaicItems.length)return a;var d=P.bidiText(c.text),e=d[0],d=d[1],f=H(c.horizontalAlignment||"center"),k=G(c.horizontalAlignment||"center");b=(new w([b.glyphMosaicItems],r.TEXT_MAX_WIDTH,r.TEXT_LINE_HEIGHT,r.TEXT_SPACING,
[0,.5*-r.TEXT_LINE_HEIGHT],.5*(1-k),0,f)).getShaping(e,d);e=ea.getFontDecorationTop(c.font);isNaN(e)||w.addDecoration(b,e);b=w.getBox(b);c=t.pt2px(c.font.size)/V;a[0]=c*b.x;a[1]=c*b.y;a[2]=c*b.width;a[3]=c*b.height;return a}function x(a,c){return Math.ceil((a-c)/(2*c))}function ga(a,c){var b;b=q.isPolygon(a)?a.rings:a.paths;for(var d=0;d<b.length;d++)for(var e=0,f=b[d];e<f.length;e++)f[e][0]+=c;return a}function ha(a,c){if(!c)return a;var b=ia(a,c).map(function(a){return a.extent});return 2>b.length?
b[0]||a:2<b.length?(a.xmin=c.valid[0],a.xmax=c.valid[1],a):{rings:b.map(function(a){return[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]]})}}function ia(a,c){var b=[],d=a.ymin,e=a.ymax,f=a.xmax-a.xmin,k=a.xmin,h=a.xmax,g,l=c.valid,m=l[0],n=l[1];g=W(a.xmin,c);var p=g.x,l=g.frameId;g=W(a.xmax,c);c=g.x;a=g.frameId;g=p===c&&0<f;if(f>2*n){f={xmin:k<h?p:c,ymin:d,xmax:n,ymax:e};k={xmin:m,ymin:d,xmax:k<h?c:p,ymax:e};h={xmin:0,ymin:d,xmax:n,ymax:e};d={xmin:m,ymin:d,xmax:0,
ymax:e};e=[];m=[];D(f,h)&&e.push(l);D(f,d)&&m.push(l);D(k,h)&&e.push(a);D(k,d)&&m.push(a);for(n=l+1;n<a;n++)e.push(n),m.push(n);b.push({extent:f,frameIds:[l]},{extent:k,frameIds:[a]},{extent:h,frameIds:e},{extent:d,frameIds:m})}else p>c||g?b.push({extent:{xmin:p,ymin:d,xmax:n,ymax:e},frameIds:[l]},{extent:{xmin:m,ymin:d,xmax:c,ymax:e},frameIds:[a]}):b.push({extent:{xmin:p,ymin:d,xmax:c,ymax:e},frameIds:[l]});return b}function W(a,c){var b=c.valid;c=b[0];var d=b[1],b=2*d,e=0;a>d?(c=Math.ceil(Math.abs(a-
d)/b),a-=c*b,e=c):a<c&&(c=Math.ceil(Math.abs(a-c)/b),a+=c*b,e=-c);return{x:a,frameId:e}}function D(a,c){var b=c.xmin,d=c.ymin,e=c.xmax;c=c.ymax;return E(a,b,d)&&E(a,b,c)&&E(a,e,c)&&E(a,e,d)}function E(a,c,b){return c>=a.xmin&&c<=a.xmax&&b>=a.ymin&&b<=a.ymax?!0:!1}function X(a,c,b){if(Array.isArray(a)){var d=a[0];if(d>c){var e=x(d,c);a[0]=d+-2*e*c}else d<b&&(e=x(d,b),a[0]=d+-2*e*b)}else d=a.x,d>c?(e=x(d,c),a.x+=-2*e*c):d<b&&(e=x(d,b),a.x+=-2*e*b);return a}Object.defineProperty(m,"__esModule",{value:!0});
var S=ba.mat2df32.create(),n=u.vec2f32.create(),y=ca.create();m.ensureClosedRings=function(a){if(q.isPolygon(a)){var c=0;for(a=a.rings;c<a.length;c++){var b=a[c];3>b.length||b[0][0]===b[b.length-1][0]&&b[0][1]===b[b.length-1][1]||b.push(b[0])}}};m.getBounds=function(a,c,b,d,e,f,k,h,g){if(!d)return a[0]=a[1]=a[2]=a[3]=0,c[0]=c[1]=c[2]=c[3]=0,a;var l=b.symbol;!l&&f&&(l=f.getSymbol(b,{scale:h}));if(!l)return a;if(q.isPoint(d))switch(b=d.x,d=d.y,l.type){case "simple-marker":case "picture-marker":k=R(b,
d,l,k,0);for(e=c=0;e<k.rings[0].length-1;e++)l=k.rings[0][e],l=(b-l[0])*(b-l[0])+(d-l[1])*(d-l[1]),c=Math.max(c,l);c=Math.sqrt(c);k=B.normalizeMapX(b-c,g);b=B.normalizeMapX(b+c,g);k>b&&(g=O.getInfo(g))&&(b=g.valid,g=b[1],k=b[0],b=g);a[0]=k;a[1]=d-c;a[2]=b;a[3]=d+c;break;case "text":0===c[2]&&0===c[3]&&I(c,l,e);k=T(b,d,l,c,k,0);for(e=c=0;e<k.rings[0].length-1;e++)l=k.rings[0][e],l=(b-l[0])*(b-l[0])+(d-l[1])*(d-l[1]),c=Math.max(c,l);c=Math.sqrt(c);k=B.normalizeMapX(b-c,g);b=B.normalizeMapX(b+c,g);k>
b&&(g=O.getInfo(g))&&(b=g.valid,g=b[1],k=b[0],b=g);a[0]=k;a[1]=d-c;a[2]=b;a[3]=d+c}else{M.getBoundsXY(a,d);d=c[0];if(0===d){a:switch(d=0,l.type){case "simple-fill":case "picture-fill":d=l.outline;if(!d){d=0;break a}d=d.width;break;case "simple-line":d=l.width;break;case "simple-marker":d=l.size;break;case "picture-marker":d=Math.max(l.width,l.height);break;case "text":d=[0,0,0,0],I(d,l,e),d=Math.max(d[0],d[1])}c[0]=d}d=k*d/2;a[0]-=d;a[1]-=d;a[2]+=d;a[3]+=d}return a};m.isMarkerSymbol=function(a){return"simple-marker"===
a||"picture-marker"===a||"text"===a};m.graphicGeometryToNumber=function(a){switch(a.geometry.type){case "polyline":return 1;case "polygon":case "extent":return 2}return 0};m.getXAnchorDirection=G;m.getYAnchorDirection=Q;m.getJustification=H;var J=u.vec2f32.create(),Y=u.vec2f32.create(),Z=u.vec2f32.create(),z=u.vec2f32.create(),K=u.vec2f32.create(),aa=u.vec2f32.create(),L=u.vec2f32.create();m.isPointOnPolyline=function(a,c,b,d){h.vec2.set(Z,c,b);a=a.paths;for(var e,f,k,m,g,l,n,p,t=Infinity,u=0;u<a.length;u++){var q=
a[u];if(!(2>q.length))for(var r=1;r<q.length;r++)e=q[r-1][0],k=q[r-1][1],f=q[r][0],m=q[r][1],g=Math.min(e,f)-d,l=Math.min(k,m)-d,n=Math.max(e,f)+d,p=Math.max(k,m)+d,c<g||c>n||b<l||b>p||(h.vec2.set(J,e,k),h.vec2.set(Y,f,m),h.vec2.subtract(z,Y,J),h.vec2.subtract(K,J,Z),h.vec2.scale(aa,z,h.vec2.dot(z,K)/h.vec2.dot(z,z)),h.vec2.subtract(L,K,aa),e=h.vec2.dot(L,L),t>e&&(t=e))}return Math.sqrt(t)<=d};m.getMarkerSymbolBounds=R;m.getTextSymbolBounds=T;m.normalizeCentralMeridian=function(a){var c,b,d,e,f,k=
null;if(!a)return null;c=a.spatialReference;b=da.getInfo(c);f=c.isWebMercator?102100:4326;d=F[f].maxX;e=F[f].minX;c=F[f].plus180Line;f=F[f].minus180Line;var h,g=a.toJSON();if(!b)return g;"mesh"===a.type?h=g:q.isPoint(g)?h=X(g,d,e):q.isMultipoint(g)?(g.points=g.points.map(function(a){return X(a,d,e)}),h=g):q.isExtent(g)?h=ha(g,b):q.isPolygon(g)||q.isPolyline(g)?(M.getBoundsXY(y,g),a={xmin:y[0],ymin:y[1],xmax:y[2],ymax:y[3]},b=2*x(a.xmin,e)*d,g=0===b?g:ga(g,b),a.xmin+=b,a.xmax+=b,N.extentIntersectsPolyline(a,
c)&&a.xmax!==d?k=g:N.extentIntersectsPolyline(a,f)&&a.xmin!==e?k=g:h=g):h=a.clone();return null!==k?(new fa.CutVertical).cut(k,d):h};var V=24;m.getTextSymbolSize=I;m.getTextSymbolEstimatedSize=function(a,c,b){var d=P.bidiText(c.text),e=d[0],d=d[1],f=H(c.horizontalAlignment||"center"),h=G(c.horizontalAlignment||"center");b=(new w([],r.TEXT_MAX_WIDTH,r.TEXT_LINE_HEIGHT,r.TEXT_SPACING,[0,.5*-r.TEXT_LINE_HEIGHT],.5*(1-h),0,f)).getEstimatedShaping(e,d,b);b=w.getBox(b);c=t.pt2px(c.font.size)/V;a[0]=c*b.x;
a[1]=c*b.y;a[2]=c*b.width;a[3]=c*b.height;return a};var F={102100:{maxX:2.0037508342788905E7,minX:-2.0037508342788905E7,plus180Line:{paths:[[[2.0037508342788905E7,-2.0037508342788905E7],[2.0037508342788905E7,2.0037508342788905E7]]],spatialReference:A.WebMercator},minus180Line:{paths:[[[-2.0037508342788905E7,-2.0037508342788905E7],[-2.0037508342788905E7,2.0037508342788905E7]]],spatialReference:A.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:A.WGS84},
minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:A.WGS84}}}});