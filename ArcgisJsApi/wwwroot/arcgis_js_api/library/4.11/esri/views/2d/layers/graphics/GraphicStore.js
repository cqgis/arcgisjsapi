// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper @dojo/framework/shim/Map ../../../../core/has ../../../../core/screenUtils ../../../../core/libs/rbush/rbush ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/contains ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtils ../../engine/webgl/util/iterator ./GraphicStoreItem ./graphicsUtils".split(" "),function(B,C,y,D,E,F,G,r,z,H,I,J,w,q){function x(d,a,c,b,e){u.minX=a;u.minY=c;u.maxX=
b;u.maxY=e;return d.search(u)}Object.defineProperty(C,"__esModule",{value:!0});var u={minX:0,minY:0,maxX:0,maxY:0},v=r.create(),A=[];B=function(){function d(a,c,b,e,l){this.renderer=e;this._graphics=l;this._index=G(9,E("csp-restrictions")?function(a){return{minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);this._itemByGraphic=new D.default;this._currentLevel=-Infinity;this._tileInfoView=a;this._uidFieldName=b;if(a=a.getClosestInfoForScale(c))this._currentLevel=
a.level,this._resolution=this._tileInfoView.getTileResolution(a.level)}d.prototype.hitTest=function(a,c,b,e,l){a=I.normalizeMapX(a,this._tileInfoView.spatialReference);var g=.5*e*b;v[0]=a-g;v[1]=c-g;v[2]=a+g;v[3]=c+g;b=.5*e*(b+50);b=x(this._index,a-b,c-b,a+b,c+b);if(!b||0===b.length)return[];for(var g={x:a,y:c},k=[],f,d=0;d<b.length;d++){var h=b[d];if(h.graphic.visible)switch(H.getJsonType(h.geometry)){case "esriGeometryPoint":f=this._getSymbol(h.graphic);if(!f)continue;var m=h.geometry,p=void 0,
p="text"===f.type?q.getTextSymbolBounds(m.x,m.y,f,h.size,this._resolution,l):q.getMarkerSymbolBounds(m.x,m.y,f,this._resolution,l);z.polygonContainsPoint(p,g)&&k.push(h);break;case "esriGeometryPolyline":f=this._getSymbol(h.graphic);if(!f)continue;f=1.5*e*window.devicePixelRatio*F.pt2px(f.width);q.isPointOnPolyline(h.geometry,a,c,f)&&k.push(h);break;case "esriGeometryEnvelope":f=h.geometry;f=r.fromValues(f.xmin,f.ymin,f.xmax,f.ymax);r.intersects(f,v)&&k.push(h);break;case "esriGeometryPolygon":z.polygonContainsPoint(h.geometry,
g)&&k.push(h);break;case "esriGeometryMultipoint":if(m=this._getSymbol(h.graphic)){p=h.geometry.points;f=void 0;for(var t=0;t<p.length;t++)if("text"===m.type?(f=m,f=q.getTextSymbolBounds(p[t][0],p[t][1],f,h.size,this._resolution,l)):f=q.getMarkerSymbolBounds(p[t][0],p[t][1],m,this._resolution,l),z.polygonContainsPoint(f,g)){k.push(h);break}}}}k.sort(function(a,b){var c=q.graphicGeometryToNumber(a.graphic),e=q.graphicGeometryToNumber(b.graphic);return c===e?b.zorder-a.zorder:c-e});return k.map(function(a){return a.graphic})};
d.prototype.getGraphicsData=function(a,c){var b=x(this._index,a.bounds[0],a.bounds[1],a.bounds[2],a.bounds[3]);if(0===b.length||0===c.length)return[];b.sort(function(a,b){return a.zorder-b.zorder});b[0].insertAfter=-1;for(var e=1;e<b.length;e++)b[e].insertAfter=b[e-1].graphic.uid;b.sort(function(a,b){return a.graphic.uid-b.graphic.uid});c.sort(function(a,b){return a.uid-b.uid});var l=e=0,g,d=[];a={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};for(var f=
0;f<c.length;f++){for(var n=c[f],l=-2;e<b.length;)if(g=b[e],e++,n.uid===g.graphic.uid){l=g.insertAfter;break}if(g.geometry&&-2!==l){var h=g.getGeometryQuantized(a),m=y({},g.graphic.attributes);m[this._uidFieldName]=n.uid;d.push({centroid:w.default.getCentroidQuantized(g,a,this.renderer,this._scale),geometry:h,attributes:m,symbol:n.symbol,insertAfter:l})}}return d};d.prototype.getGraphicData=function(a,c){var b=this._itemByGraphic.get(c);if(!b)return null;var e=x(this._index,a.bounds[0],a.bounds[1],
a.bounds[2],a.bounds[3]);e.sort(function(a,b){return a.zorder-b.zorder});var d=e.indexOf(b),e=0===d||-1===d?-1:e[d-1].graphic.uid;a={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};var d=b.getGeometryQuantized(a),g=y({},b.graphic.attributes);g[this._uidFieldName]=c.uid;return{centroid:w.default.getCentroidQuantized(b,a,this.renderer,this._scale),geometry:d,attributes:g,symbol:c.symbol,insertAfter:e}};d.prototype.queryTileData=function(a){var c=r.pad(a.bounds,
50*a.resolution,r.create()),c=x(this._index,c[0],c[1],c[2],c[3]),b=[];this._createTileGraphics(b,c,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]});return b};d.prototype.has=function(a){return this._itemByGraphic.has(a)};d.prototype.getBounds=function(a){return this._itemByGraphic.has(a)?this._itemByGraphic.get(a).bounds:null};d.prototype.add=function(a,c,b){if(a)return c=w.default.acquire(a,b,c,this.renderer,this._resolution,this._scale,this._tileInfoView.spatialReference),
this._itemByGraphic.set(a,c),b&&this._index.insert(c),c.bounds};d.prototype.remove=function(a){if(this._itemByGraphic.has(a)){var c=this._itemByGraphic.get(a);this._index.remove(c);this._itemByGraphic.delete(a)}};d.prototype.updateZ=function(){for(var a=this._graphics.items,c,b=0;b<a.length;b++)if(c=a[b],c=this._itemByGraphic.get(c))c.zorder=b};d.prototype.update=function(a,c,b){var e=this._itemByGraphic.get(a),d=r.clone(e.bounds);e.size[0]=e.size[1]=0;this._index.remove(e);e.set(a,b,c,this.renderer,
this._resolution,this._scale,this._tileInfoView.spatialReference);b&&this._index.insert(e);return{oldBounds:d,newBounds:e.bounds}};d.prototype.updateLevel=function(a){var c=this;this._currentLevel!==a&&(this._currentLevel=a,this._resolution=this._tileInfoView.getTileResolution(a),this._scale=this._tileInfoView.getTileScale({level:a,row:0,col:0,world:0}),this._index.clear(),a=this._itemByGraphic.values(),A.length=0,J.forEachIter(a,function(a){a.updateBounds(c.renderer,c._resolution,c._scale,c._tileInfoView.spatialReference);
a.geometry&&A.push(a)}),this._index.load(A))};d.prototype.clear=function(){this._itemByGraphic.clear();this._index.clear()};d.prototype._createTileGraphics=function(a,c,b){var e=this._uidFieldName;c.sort(function(a,b){return a.zorder-b.zorder});for(var d,g,k,f,n=0;n<c.length;n++){k=c[n];d=k.graphic;g=k.getGeometryQuantized(b);f=0===n?-1:c[n-1].graphic.uid;var h=y({},k.graphic.attributes);h[e]=d.uid;a.push({centroid:w.default.getCentroidQuantized(k,b,this.renderer,this._scale),geometry:g,attributes:h,
symbol:d.symbol,insertAfter:f})}};d.prototype._getSymbol=function(a){return a.symbol?a.symbol:this.renderer?this.renderer.getSymbol(a,{scale:this._scale}):null};return d}();C.default=B});