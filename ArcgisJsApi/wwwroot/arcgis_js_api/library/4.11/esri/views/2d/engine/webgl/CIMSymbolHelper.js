// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../Color ../../../../core/Logger ../../../../geometry/support/jsonUtils ../cim/CIMCursor ../cim/CIMEffects ../cim/CIMOperators ./CIMSymbolDrawHelper ./SDFHelper ../../../vectorTiles/GeometryUtils".split(" "),function(n,q,z,A,t,u,w,B,v,C,x){Object.defineProperty(q,"__esModule",{value:!0});var y=A.getLogger("esri/views/2d/engine/webgl/CIMSymbolHelper");n=function(){function e(){}e.getEnvelope=function(b){if("CIMPointSymbol"!==b.type)return null;var a=new v.EnvDrawHelper;
a.drawSymbol(b,{type:"point",x:0,y:0});return a.envelope()};e.rasterize=function(b,a){var c=this.getEnvelope(a);if(!c||0>=c.width||0>=c.height)return[null,0,0,0,0];var d=96/72,f=(c.x+.5*c.width)*d,g=-(c.y+.5*c.height)*d;b.width=c.width*d+2;b.height=c.height*d+2;c=b.getContext("2d");d=v.Transformation.createScale(d,-d);d.translate(.5*b.width-f,.5*b.height-g);(new v.CanvasDrawHelper(c,d)).drawSymbol(a,{type:"point",x:0,y:0});a=c.getImageData(0,0,b.width,b.height);a=new Uint8Array(a.data);for(c=0;c<
a.length;c+=4)d=a[c+3]/255,a[c]*=d,a[c+1]*=d,a[c+2]*=d;return[a,b.width,b.height,f/b.width,g/b.height]};e.fromSimpleMarker=function(b){var a,c,d=b.style;if("circle"===d||"esriSMSCircle"===d){a=Math.acos(.995);c=Math.ceil(x.C_PI/a/4);0===c&&(c=1);a=x.C_PI_BY_2/c;c*=4;d=[];d.push([50,0]);for(var f=1;f<c;f++)d.push([50*Math.cos(f*a),-50*Math.sin(f*a)]);d.push([50,0]);a={rings:[d]};c={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===d||"esriSMSCross"===d)a=0,a={rings:[[[a,50],[a,a],[50,a],[50,-a],
[a,-a],[a,-50],[-a,-50],[-a,-a],[-50,-a],[-50,a],[-a,a],[-a,50],[a,50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("diamond"===d||"esriSMSDiamond"===d)a={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===d||"esriSMSSquare"===d)a={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===d||"esriSMSX"===d)a=0,a={rings:[[[0,a],[50-a,50],[50,50-a],[a,0],[50,a-50],[50-a,-50],[0,-a],[a-50,-50],
[-50,a-50],[-a,0],[-50,50-a],[a-50,50],[0,a]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("triangle"===d||"esriSMSTriangle"===d)c=2/3*100,d=c-100,a={rings:[[[-57.735026918962575,d],[0,c],[57.735026918962575,d],[-57.735026918962575,d]]]},c={xmin:-57.735026918962575,ymin:d,xmax:57.735026918962575,ymax:c};var g;a&&c&&(g=[{type:"CIMSolidFill",enable:!0,color:b.color}],b.outline&&g.push({type:"CIMSolidStroke",enable:!0,width:b.outline.width,color:b.outline.color}),g={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",
enable:!0,rotation:b.angle,size:b.size,offsetX:b.xoffset,offsetY:b.yoffset,frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:a,symbol:{type:"CIMPolygonSymbol",symbolLayers:g}}]}]});return g};e.getFillColor=function(b){if(!b)return null;switch(b.type){case "CIMPolygonSymbol":if(b.symbolLayers){var a=0;for(b=b.symbolLayers;a<b.length;a++){var c=e.getFillColor(b[a]);if(null!=c)return c}}break;case "CIMSolidFill":return b.color}};e.getStrokeColor=function(b){if(b)switch(b.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(b.symbolLayers){var a=
0;for(b=b.symbolLayers;a<b.length;a++){var c=e.getStrokeColor(b[a]);if(void 0!==c)return c}}break;case "CIMSolidStroke":return b.color}};e.getStrokeWidth=function(b){if(b)switch(b.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(b.symbolLayers){var a=0;for(b=b.symbolLayers;a<b.length;a++){var c=e.getStrokeWidth(b[a]);if(void 0!==c)return c}}break;case "CIMSolidStroke":case "CIMGradientStroke":case "CIMPictureStroke":return b.width}};e.getSize=function(b){if(b)switch(b.type){case "CIMPointSymbol":var a=
0;if(b.symbolLayers){var c=0;for(b=b.symbolLayers;c<b.length;c++){var d=e.getSize(b[c]);d>a&&(a=d)}}return a;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":return b.width;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":return b.size}};e.getMarkerScaleRatio=function(b){if(b)switch(b.type){case "CIMVectorMarker":if(!1!==b.scaleSymbolsProportionally&&b.frame)return b.size/(b.frame.ymax-b.frame.ymin)}return 1};e.executeEffects=function(b,a,c){void 0===
c&&(c=!1);var d=96/72,f=b?b.length:0;f&&c&&--f;for(c=0;c<f;++c){var g=b[c];if(g){var e=B.getEffectOperator(g);e&&(a=e.execute(a,g,d))}}return a};e.processEffects=function(b,a,c){var d;b.effects&&0<b.effects.length&&(d=u.deltaEncodeGeometry(c),d=new w.SimpleGeometryCursor(d),d=e.executeEffects(b.effects,d));b=b.symbolLayers[a];b.effects&&0<b.effects.length&&(a=!1,"CIMGeometricEffectDashes"===b.effects[b.effects.length-1].type&&(a=!0),d||(d=u.deltaEncodeGeometry(c),d=new w.SimpleGeometryCursor(d)),
d=e.executeEffects(b.effects,d,a));if(!d)return c;c=[];for(b=d.next();b;)c.push(b),b=d.next();d=c.length;switch(d){case 0:return null;case 1:return u.deltaEncodeGeometry(c[0]);default:b=c[0];for(a=1;a<d;++a){var f=c[a];t.isPolygon(b)&&t.isPolygon(f)&&Array.prototype.push.apply(b.rings,f.rings);t.isPolyline(b)&&t.isPolyline(f)&&Array.prototype.push.apply(b.paths,f.paths)}return u.deltaEncodeGeometry(b)}};return e}();q.CIMSymbolHelper=n;n=function(){function e(){}e.rasterizeSimpleFill=function(b,a){"solid"!==
a&&"none"!==a&&"esriSFSSolid"!==a&&"esriSFSNull"!==a||console.error("Unexpected: style does not require rasterization");b.width=8;b.height=8;var c=b.getContext("2d");c.strokeStyle="#FFFFFF";c.lineWidth=1;c.beginPath();if("vertical"===a||"cross"===a||"esriSFSCross"===a||"esriSFSVertical"===a)c.moveTo(0,0),c.lineTo(0,8);if("horizontal"===a||"cross"===a||"esriSFSCross"===a||"esriSFSHorizontal"===a)c.moveTo(0,0),c.lineTo(8,0);if("forward-diagonal"===a||"diagonal-cross"===a||"esriSFSDiagonalCross"===a||
"esriSFSForwardDiagonal"===a)c.moveTo(0,0),c.lineTo(8,8);if("backward-diagonal"===a||"diagonal-cross"===a||"esriSFSBackwardDiagonal"===a||"esriSFSDiagonalCross"===a)c.moveTo(8,0),c.lineTo(0,8);c.stroke();a=c.getImageData(0,0,b.width,b.height);a=new Uint8Array(a.data);for(var d=0;d<a.length;d+=4)c=a[d+3]/255,a[d]*=c,a[d+1]*=c,a[d+2]*=c;return[a,b.width,b.height]};e.rasterizeSimpleLine=function(b,a,c){switch(c){case "butt":c="Butt";break;case "square":c="Square";break;default:c="Round"}var d="Butt"===
c;switch(a){case "dash":case "esriSLSDash":a=d?[4,3]:[3,4];break;case "dash-dot":case "esriSLSDashDot":a=d?[4,3,1,3]:[3,4,0,4];break;case "dot":case "esriSLSDot":a=d?[1,3]:[0,4];break;case "long-dash":case "esriSLSLongDash":a=d?[8,3]:[7,4];break;case "long-dash-dot":case "esriSLSLongDashDot":a=d?[8,3,1,3]:[7,4,0,4];break;case "long-dash-dot-dot":case "esriSLSDashDotDot":a=d?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case "short-dash":case "esriSLSShortDash":a=d?[4,1]:[3,2];break;case "short-dash-dot":case "esriSLSShortDashDot":a=
d?[4,1,1,1]:[3,2,0,2];break;case "short-dash-dot-dot":case "esriSLSShortDashDotDot":a=d?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case "short-dot":case "esriSLSShortDot":a=d?[1,1]:[0,2];break;case "solid":case "esriSLSSolid":case "none":y.error("Unexpected: style does not require rasterization");a=[0,0];break;default:y.error("Tried to rasterize SLS, but found an unexpected style: "+a+"!"),a=[0,0]}return this.rasterizeDash(b,a,c)};e.rasterizeDash=function(b,a,c){b="Butt"===c;var d="Square"===c;c=!b&&!d;for(var f=
0,g=0;g<a.length;g++)var e=a[g],f=f+e;for(var f=15*f,h=31*f,g=new Float32Array(h),k=c?225:15,e=0;e<h;++e)g[e]=k;for(var k=h=0,n=!0,q=0;q<a.length;q++){for(var e=a[q],h=k,k=k+15*e,l=h;l<k;){for(var r=0;31>r;){var e=r*f+l,p=c?(r-15)*(r-15):Math.abs(r-15);g[e]=n?b?Math.max(Math.max(h+7.5-l,p),Math.max(l-k+7.5,p)):p:c?Math.min((l-h)*(l-h)+p,(l-k)*(l-k)+p):d?Math.min(Math.max(l-h,p),Math.max(k-l,p)):Math.min(Math.max(l-h+7.5,p),Math.max(k+7.5-l,p));r++}l++}n=!n}a=g.length;b=new Uint8Array(4*a);for(e=0;e<
a;++e)C.packFloat((c?Math.sqrt(g[e]):g[e])/15,b,4*e);return[b,f,31]};return e}();q.SymbolHelper=n;n=function(){function e(){}e.findApplicableOverrides=function(b,a,c){if(a){if(b.primitiveName)for(var d=0;d<a.length;d++){var f=a[d];if(f.primitiveName===b.primitiveName){for(var g=!1,m=0,h=c;m<h.length;m++)h[m].primitiveName===b.primitiveName&&(g=!0);g||c.push(f)}}switch(b.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(b.effects)for(f=0,g=b.effects;f<g.length;f++)d=g[f],
e.findApplicableOverrides(d,a,c);if(b.symbolLayers)for(d=0,b=b.symbolLayers;d<b.length;d++)e.findApplicableOverrides(b[d],a,c);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(b.effects)for(f=0,g=b.effects;f<g.length;f++)d=g[f],e.findApplicableOverrides(d,a,c);if("CIMVectorMarker"===b.type&&b.markerGraphics)for(d=0,b=b.markerGraphics;d<b.length;d++)f=b[d],e.findApplicableOverrides(f,a,c),e.findApplicableOverrides(f.symbol,a,c)}}};e.applyOverrides=function(b,a,c,d){if(a){if(b.primitiveName)for(var f=
0;f<a.length;f++){var g=a[f];if(g.primitiveName===b.primitiveName){d&&d.push({cim:b,propertyName:g.propertyName,value:b[g.propertyName]});g.expression&&(g.value=e.toValue(g.propertyName,g.expression));if(c){for(var m=!1,h=0,k=c;h<k.length;h++)k[h].primitiveName===b.primitiveName&&(m=!0);m||c.push(g)}b[g.propertyName]=g.value}}switch(b.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(b.effects)for(g=0,m=b.effects;g<m.length;g++)f=m[g],e.applyOverrides(f,a,c,d);if(b.symbolLayers)for(f=
0,b=b.symbolLayers;f<b.length;f++)e.applyOverrides(b[f],a,c,d);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(b.effects)for(g=0,m=b.effects;g<m.length;g++)f=m[g],e.applyOverrides(f,a,c,d);if("CIMVectorMarker"===b.type&&b.markerGraphics)for(f=0,b=b.markerGraphics;f<b.length;f++)g=b[f],e.applyOverrides(g,a,c,d),e.applyOverrides(g.symbol,a,c,d)}}};e.restoreOverrides=function(b){for(var a=0;a<b.length;a++){var c=b[a];c.cim[c.propertyName]=c.value}};e.getOverride=function(b,
a,c){if(a&&0!==a.length)for(var d=0;d<b.length;d++){var f=b[d];if(f.primitiveName===a&&f.propertyName===c)return e.toValue(c,f.value)}};e.buildOverrideKey=function(b){return JSON.stringify(b.map(function(a){return{P:a.primitiveName,F:a.propertyName,V:a.value}}))};e.toValue=function(b,a){return"dashTemplate"===b?a.split(" ").map(function(a){return Number(a)}):"color"===b?(b=(new z(a)).toRgba(),b[3]*=255,b):a};return e}();q.OverrideHelper=n});