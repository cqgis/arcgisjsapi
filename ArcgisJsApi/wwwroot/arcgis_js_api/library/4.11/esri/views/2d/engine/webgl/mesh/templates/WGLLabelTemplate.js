// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/libs/gl-matrix-2/mat2d ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../definitions ../../enums ../../number ../../TextShaping ../../collisions/Metric ../../materialKey/MaterialKey ./GlyphGroup ./util ./WGLTextTemplate ../../../../../3d/support/mathUtils ../../../../../vectorTiles/GeometryUtils".split(" "),
function(P,I,V,W,X,E,Y,Q,Z,C,K,F,L,R,M,G,D,aa,N,ba){function ca(x){switch(x){case "above-left":return[-1,-1];case "above-center":case "above-along":return[0,-1];case "above-right":return[1,-1];case "center-left":return[-1,0];case "center-center":case "center-along":return[0,0];case "center-right":return[1,0];case "below-left":return[-1,1];case "below-center":case "below-along":return[0,1];case "below-right":return[1,1];case "always-horizontal":return[0,0];default:O("Found invalid placement type "+
x)}}Object.defineProperty(I,"__esModule",{value:!0});var da=X.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),S=F.i8888to32(255,255,255,255),T=Z.vec2f32.create(),ea=Y.mat2df32.create(),U={xOffset:0,yOffset:0,width:0,height:0},O=function(x,d){void 0===d&&(d="mapview-labeling");return da.error(W(d,x))};I.isMapAligned=function(x){switch(x){case "above-along":case "below-along":case "center-along":return 1;default:return 0}};P=function(x){function d(b,e,a){var f=x.call(this,b,e.symbol)||this;
f.geometryType=K.WGLGeometryType.LABEL;f._refTemplate=U;var t=e.symbol,c;c=!!e.minScale&&a.scaleToZoom(e.minScale)||0;c=N.clamp(c,0,25.5);a=!!e.maxScale&&a.scaleToZoom(e.maxScale)||255;a=N.clamp(a,0,25.5);var p=ca(e.labelPlacement),r=p[0],p=p[1];f._justify=(-1*r+1)/2;f._xAlignD=r;f._yAlignD=p;f._xPlacementD=r;f._yPlacementD=p;f._minZoom=c;f._maxZoom=a;b=M.LabelMaterialKey.load(M.createMaterialKey(f.geometryType,b,!1,e));b.sdf=!0;f._materialKey=b.data;t=t.font.decoration.toLowerCase();"underline"===
t?f._decorationTop=6:"line-through"===t&&(f._decorationTop=-5);return f}V(d,x);d.fromLabelClass=function(b,e,a){return new d(b,e,a)};d.prototype.bindTextInfo=function(b,e,a){b=this._computeShaping(b,this._justify).getShaping(e,a);isNaN(this._decorationTop)||L.addDecoration(b,this._decorationTop);this._shapedGlyphs=b;this._shapedBox=L.getBox(b)};d.prototype._computeShaping=function(b,e){return new L([b],C.TEXT_MAX_WIDTH,C.TEXT_LINE_HEIGHT,C.TEXT_SPACING,[0,0],.5,.5,e)};Object.defineProperty(d.prototype,
"bounds",{get:function(){return this._bounds},enumerable:!0,configurable:!0});d.prototype.bindReferenceTemplate=function(b){this._refTemplate=b||U};d.prototype._placeGlyphs=function(b,e,a,f){var t=this._size,c=this._haloSize,p=this._shapedBox,r=this._shapedGlyphs,m=this._computeGlyphTransform(p);if("esriGeometryPolyline"!==b)for(var h=0;h<a.length;h++)for(var B=a[h],k=0,g=r;k<g.length;k++){var n=g[k];B.place(n,b,e,m,this._materialKey,t,c,p,f,this._minZoom,this._maxZoom)}else for(h=0;h<a.length;h++)for(var B=
a[h],k=n=B.order,g=k-(k-1)/2-1,l=g-(g-1)/2-1,q=l-(l-1)/2-1,n=-1===n?0:k%2?g%2?l%2?q%2?0:f-3.1:f-2.1:f-1.1:f-.1,k=Math.max(f+N.log2((this._shapedBox.width*this._scale+48)/B.pathLen),Math.max(n,this._minZoom)),g=0,l=r;g<l.length;g++)n=l[g],B.place(n,b,e,m,this._materialKey,t,c,p,f,k,this._maxZoom)};d.prototype.writeMesh=function(b,e,a,f,t,c,p,r,m,h){var B=this,k=this._computeAnchors(a,t),g=F.i8888to32(0,0,0,this._bitset);if(k.length&&this._shapedGlyphs.length){this._placeGlyphs(a,t,k,m);var n=M.LabelMaterialKey.load(this._materialKey);
if("esriGeometryPolyline"!==a){a=k[0];t=this._computeGlyphTransform(this._shapedBox);t=this._createBounds(this._shapedBox,t);c=a.glyphs.get(0);var l=c[0];m=l.anchorX;var q=l.anchorY,d=Math.floor(10*l.minZoom),l=Math.floor(10*l.maxZoom),y=b.length;c.forEach(function(a){a.minZoom=25.5;a.maxZoom=25.5});this._writeVertices(b,e,f,p,c,r,n,g,d,l);c=new R.default(f,{from:y,count:b.length-y},m,q,d);m=Math.max(this._refTemplate.height,this._refTemplate.width);n.vvSizeFieldStops||n.vvSizeMinMaxValue||n.vvSizeScaleStops||
n.vvSizeUnitValue?c.setVV(F.toFloat32(p[K.VVType.SIZE]),m,this._xPlacementD,this._yPlacementD):(c.offsetX=(m/2+C.COLLISION_PLACEMENT_PADDING)*this._xPlacementD,c.offsetY=(m/2+C.COLLISION_PLACEMENT_PADDING)*this._yPlacementD);c.bounds=t;h.push(c);a.clear()}else{a=function(a){var c=k[a],t=c.x,l=c.y;a=b.length;var m=new R.default(f,{from:a,count:-1},t,l,25.5);c.glyphs.forEach(function(a){for(var k=0;k<a.length;k++){var h=a[k];h.minZoom=Math.max(c.minZoom,h.minZoom);if(h.bounds){var q=h.anchorY-l;h.bounds.center[0]+=
h.anchorX-t;h.bounds.center[1]+=q;m.add(h.bounds)}}m.bounds&&B._writeHalos(b,e,f,p,a,r,n,g)});c.glyphs.forEach(function(a){m.bounds&&B._writeText(b,e,f,p,a,r,n,g)});m.range.count=b.length-a;m.bounds&&h.push(m);c.clear()};for(t=0;t<k.length;t++)a(t);this._computedGlyphs=[]}}};d.prototype._outsideTile=function(b,e){return 0>b||512<=b||0>e||512<=e};d.prototype._smoothVertices=function(b,e){if(!(0>=e)){var a=b.length;if(!(3>a)){var f=[],t=0;f.push(0);for(var c=1;c<a;c++)t+=D.dist(b[c],b[c-1]),f.push(t);
e=Math.min(e,.2*t);t=[];t.push(b[0][0]);t.push(b[0][1]);var p=b[a-1][0],r=b[a-1][1],c=D.sub([0,0],b[0],b[1]);D.normalize(c);b[0][0]+=e*c[0];b[0][1]+=e*c[1];D.sub(c,b[a-1],b[a-2]);D.normalize(c);b[a-1][0]+=e*c[0];b[a-1][1]+=e*c[1];for(c=1;c<a;c++)f[c]+=e;f[a-1]+=e;for(var m=.5*e,c=1;c<a-1;c++){for(var h=0,B=0,k=0,g=c-1;0<=g&&!(f[g+1]<f[c]-m);g--){var n=m+f[g+1]-f[c],l=f[g+1]-f[g],q=f[c]-f[g]<m?1:n/l;if(1E-6>Math.abs(q))break;var d=q*q,y=q*n-.5*d*l,v=q*l/e,u=b[g+1],w=b[g][0]-u[0],z=b[g][1]-u[1],h=h+
v/y*(u[0]*q*n+.5*d*(n*w-l*u[0])-d*q*l*w/3),B=B+v/y*(u[1]*q*n+.5*d*(n*z-l*u[1])-d*q*l*z/3),k=k+v}for(g=c+1;g<a&&!(f[g-1]>f[c]+m);g++){n=m-f[g-1]+f[c];l=f[g]-f[g-1];q=f[g]-f[c]<m?1:n/l;if(1E-6>Math.abs(q))break;d=q*q;y=q*n-.5*d*l;v=q*l/e;u=b[g-1];w=b[g][0]-u[0];z=b[g][1]-u[1];h+=v/y*(u[0]*q*n+.5*d*(n*w-l*u[0])-d*q*l*w/3);B+=v/y*(u[1]*q*n+.5*d*(n*z-l*u[1])-d*q*l*z/3);k+=v}t.push(h/k);t.push(B/k)}t.push(p);t.push(r);for(g=c=0;c<a;c++)b[c][0]=t[g++],b[c][1]=t[g++]}}};d.prototype._computeLineAnchors=function(b,
e,a){e=e.paths;var f=this._scale*this._shapedBox.width;a=f/2+a;for(var f=f/2+16,t=this._shapedBox.width*this._scale,c=0;c<e.length;c++){var p=e[c],r=[];r.push(p[0]);for(var m=1;m<p.length;m++){var h=r[m-1],d=h[0],h=h[1],d=d+p[m][0],h=h+p[m][1];r.push([d,h])}this._smoothVertices(r,t);p=[];p.push(r[0]);for(m=1;m<r.length;m++){var h=r[m-1],k=r[m],d=Math.round(k[0]-h[0]),h=Math.round(k[1]-h[1]);p.push([d,h])}e[c]=p;r=this._getPathLength(p);if(!(r<2*f))for(var m=r/2,g=0,k=p[0][0],n=p[0][1],l=1;l<p.length;l++){var d=
p[l][0],h=p[l][1],q=Math.sqrt(d*d+h*h),g=g+q;if(0<=g-m){var x=g-m,y=q-x,v=y/q,u=k+d*v,w=n+h*v;this._outsideTile(u,w)||(g=new G.default(u,w,v,c,l,k,n,q,r,-1),b.push(g));for(var z=-1,w=0,w=y-a;0<=w;w-=a){var v=w/q,u=k+d*v,A=n+h*v;z++;this._outsideTile(u,A)||(g=new G.default(u,A,v,c,l,k,n,q,r,z),b.push(g))}g=w+a;w=q-x;v=k;u=n;for(A=l-1;0!==A;A--){var C=p[A][0],D=p[A][1],H=Math.sqrt(C*C+D*D);if(g+H>=a){for(var J=g=a-g;J<H;J+=a){var E=J/H,F=v-C*E,I=u-D*E;z++;(g=J+w+f<m)&&!this._outsideTile(F,I)&&(g=new G.default(F,
I,1-E,c,A,v-C,u-D,H,r,z),b.push(g))}g=H-(J-a)}else g+=H;w+=H;v-=C;u-=D}z=-1;for(w=y+a;w<=q;w+=a)v=w/q,u=k+d*v,y=n+h*v,z++,this._outsideTile(u,y)||(g=new G.default(u,y,v,c,l,k,n,q,r,z),b.push(g));v=k+d;u=n+h;g=q-(w-a);w=x;for(A=l+1;A<p.length;A++){d=p[A][0];h=p[A][1];k=Math.sqrt(d*d+h*h);if(g+k>=a){for(n=g=a-g;n<k;n+=a)l=n/k,q=v+d*l,x=u+h*l,z++,(g=n+w+f<m)&&!this._outsideTile(q,x)&&(g=new G.default(q,x,l,c,A,v,u,k,r,z),b.push(g));g=k-(n-a)}else g+=k;w+=k;v+=d;u+=h}break}k+=d;n+=h}}return b};d.prototype._computeAnchors=
function(b,e){var a=[];switch(b){case "esriGeometryPoint":return e=e.geometry,b=e.x,e=e.y,b=new G.default(b,e),a.push(b),a;case "esriGeometryPolygon":if(e.centroid)return e=e.centroid,b=e.x,e=e.y,b=new G.default(b,e),a.push(b),a;O("Non-centroid polygon anchor placement not supported");break;case "esriGeometryPolyline":return this._computeLineAnchors(a,e.geometry,376);default:return O("Unable to handle geometryType: "+b),a}};d.prototype._getPathLength=function(b){for(var e=0,a=1;a<b.length;a++)var f=
b[a][0],d=b[a][1],e=e+Math.sqrt(f*f+d*d);return e};d.prototype._computeGlyphTransform=function(b){var e=this._scale,a=this._angle*ba.C_DEG_TO_RAD,f=b.width/2,d=b.height/2,f=this._xAlignD*f*e+(this._xOffset+this._refTemplate.xOffset)+(b.x+f);b=this._yAlignD*d*e-(this._yOffset+this._refTemplate.yOffset)-(b.y+d);d=E.mat2d.identity(ea);E.mat2d.translate(d,d,Q.vec2.set(T,f,b));E.mat2d.scale(d,d,Q.vec2.set(T,e,e));E.mat2d.rotate(d,d,a);return d};d.prototype._writeVertex=function(b,e,a,f,d,c,p,r,m,h){a=
e.get("geometry");p=e.get("visibility");e=e.get("visibilityRange");r=r&&r[K.VVType.SIZE]||1;this._refSymbolAndPlacementOffset=F.i8888to32(c.angle,Math.min(Math.floor(Math.max(this._refTemplate.width,this._refTemplate.height)),255),this._xPlacementD+1,this._yPlacementD+1);a.push(f);a.push(d);a.push(c.vertexOffsetUpperLeft);a.push(c.texFontSizeUpperLeft);a.push(this._refSymbolAndPlacementOffset);a.push(r);p.push(m);a.push(f);a.push(d);a.push(c.vertexOffsetUpperRight);a.push(c.texFontSizeUpperRight);
a.push(this._refSymbolAndPlacementOffset);a.push(r);p.push(m);a.push(f);a.push(d);a.push(c.vertexOffsetLowerLeft);a.push(c.texFontSizeLowerLeft);a.push(this._refSymbolAndPlacementOffset);a.push(r);p.push(m);a.push(f);a.push(d);a.push(c.vertexOffsetLowerRight);a.push(c.texFontSizeLowerRight);a.push(this._refSymbolAndPlacementOffset);a.push(r);p.push(m);e.push(S);e.push(S);b.vertexCount+=4};return d}(aa.default);I.default=P});