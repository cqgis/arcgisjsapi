// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/has ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./Utils ./VertexStream ./brushes/WGLBrushInfo ./brushes/WGLBrushStencil ./brushes/WGLGeometryBrushFill ./brushes/WGLGeometryBrushLabel ./brushes/WGLGeometryBrushLine ./brushes/WGLGeometryBrushMarker ./brushes/WGLGeometryBrushText ./painter/WGLHighlightPainter ./shaders/RasterPrograms ../../../webgl/FramebufferObject ../../../webgl/programUtils".split(" "),
function(w,q,D,S,m,E,t,r,F,f,G,H,v,I,J,K,L,x,M,N,O,P,y,z,A){Object.defineProperty(q,"__esModule",{value:!0});w=function(){function d(){this._initialized=!1}d.prototype.registerPass=function(a,b){this._initialize();for(var c=0;c<f.WGLDrawPhase.NUM_DRAW_PHASES-2;c++){var e=1<<c;e&b&&this._passMap.set(e,a)}return this};d.prototype.getPaintPassTs=function(a){this._initialize();return this._passMap.has(a)?[this._passMap.get(a)]:[]};d.prototype._initialize=function(){this._initialized||(this._passMap=new Map,
this._initialized=!0)};return d}();q.PainterOptions=w;var B=new Uint8Array(4*v.C_HITTEST_SEARCH_SIZE*v.C_HITTEST_SEARCH_SIZE),Q=new Uint32Array(B.buffer),u=r.vec3f32.create(),R=[0,0];r=function(){function d(a){this.context=a;this._hlPainter=new P.default;this._blitRenderer=new F;this._boundFBO=this._globalOpacityFBO=null;this.textureManager=new H;this.stencilRef=-1;this.materialManager=new G(a);this._quadVertexStream=new I(a,[0,0,1,0,0,1,1,1]);this._transformTextureProgram=A.createProgram(a,y.transformTexture);
this._transformSolidProgram=A.createProgram(a,y.transformSolid);this._transform=E.mat4f32.create()}d.prototype.dispose=function(){this.materialManager.dispose();this.textureManager.dispose();this._hlPainter&&(this._hlPainter.dispose(),this._hlPainter=null);this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._globalOpacityFBO&&(this._globalOpacityFBO.dispose(),this._globalOpacityFBO=null);this._boundFBO=null;this._hittestFBO&&(this._hittestFBO.dispose(),this._hittestFBO=
null);this._passes&&(this._passes.forEach(function(a){return a.dispose()}),this._passes.clear());this._brushes&&(this._brushes.forEach(function(a){return a.forEach(function(a){return a.dispose()})}),this._brushes.clear());this._geometryBrushes&&(this._geometryBrushes.forEach(function(a){return a.dispose()}),this._geometryBrushes.clear());this._quadVertexStream.dispose()};d.prototype.getBrushes=function(a){if(a===f.WGLDrawPhase.MAP)throw Error("Painter: Tried to get brush for the MAP phase; use a specific geometry type and call getMapBrush() instead.");
if(!this._brushes){var b=[this.getGeometryBrush(f.WGLGeometryType.FILL),this.getGeometryBrush(f.WGLGeometryType.LINE),this.getGeometryBrush(f.WGLGeometryType.MARKER),this.getGeometryBrush(f.WGLGeometryType.TEXT)],c=new x.default,e=new J.default,d=new K.default;this._brushes=new Map;this._brushes.set(f.WGLDrawPhase.LABEL,[c]);this._brushes.set(f.WGLDrawPhase.LABEL_ALPHA,[c]);this._brushes.set(f.WGLDrawPhase.HITTEST,b);this._brushes.set(f.WGLDrawPhase.HIGHLIGHT,b);this._brushes.set(f.WGLDrawPhase.CLIP,
[d]);this._brushes.set(f.WGLDrawPhase.DEBUG,[e])}if(!this._brushes.has(a))throw Error("Painter: Tried to get brush for unknown phase: "+a);return this._brushes.get(a)};d.prototype.getGeometryBrush=function(a){if(!this._geometryBrushes){var b=new L.default,c=new M.default,e=new N.default,d=new O.default,g=new x.default;this._geometryBrushes=new Map;this._geometryBrushes.set(f.WGLGeometryType.FILL,b);this._geometryBrushes.set(f.WGLGeometryType.LINE,c);this._geometryBrushes.set(f.WGLGeometryType.MARKER,
e);this._geometryBrushes.set(f.WGLGeometryType.TEXT,d);this._geometryBrushes.set(f.WGLGeometryType.LABEL,g)}return this._geometryBrushes.get(a)};d.prototype.draw=function(a,b,c,e){this._setGlobalOpacity(a,c);0===(c&(f.WGLDrawPhase.LABEL_ALPHA|f.WGLDrawPhase.LABEL))&&this._drawClippingRects(a,b);var d=this.context;d.setBlendingEnabled(!0);d.setStencilWriteMask(0);d.setBlendFunctionSeparate(1,771,1,771);this._drawPhases(a,b,c,e);this._applyGlobalOpacity(a,c);this._debugTiles(a,b)};d.prototype.highlight=
function(a,b){var c=this.context,e=c.getViewport();this._hlPainter.setup(c,e.width,e.height);this._hlPainter.startMaskDraw(c);this._drawClippingRects(a,b);c.setBlendingEnabled(!0);c.setStencilWriteMask(0);c.setBlendFunctionSeparate(1,771,1,771);this._drawPhases(a,b,f.WGLDrawPhase.HIGHLIGHT);this._hlPainter.draw(c)};d.prototype.setHighlightOptions=function(a){this._hlPainter.setHighlightOptions(a)};d.prototype.hitTest=function(a,b){var c=this.context,e=v.C_HITTEST_SEARCH_SIZE,d=[0,0],g=[0,0],h=a.state;
h.toMap(d,[0,0]);h.toMap(g,[e,e]);if(0===b.filter(function(a){return!(d[0]>a.bounds[2]||g[0]<a.bounds[0]||d[1]<a.bounds[1]||g[1]>a.bounds[3])}).length)return[];this._hittestFBO||(this._hittestFBO=z.create(c,{colorTarget:0,depthStencilTarget:3,width:e,height:e}));var h=c.getViewport(),n=c.getBoundFramebufferObject();c.bindFramebuffer(this._hittestFBO);c.setViewport(0,0,e,e);this._drawClippingRects(a,b);var l=c.gl;c.setClearColor(1,1,1,1);c.clear(l.COLOR_BUFFER_BIT);c.setBlendingEnabled(!1);c.setStencilWriteMask(0);
this._drawPhases(a,b,f.WGLDrawPhase.HITTEST);c.setBlendingEnabled(!0);this._hittestFBO.readPixels(0,0,e,e,6408,5121,B);a=e*e;b=new Set;for(e=0;e<a;e++)l=Q[e],4294967295!==l&&b.add(l);c.bindFramebuffer(n);c.setViewport(h.x,h.y,h.width,h.height);var p=[];b.forEach(function(a){p.push(a)});return p};d.prototype.startStencilBurn=function(){this.context.setStencilTestEnabled(!0);this.context.setStencilWriteMask(255);this.context.setClearStencil(0);this.context.clear(this.context.gl.STENCIL_BUFFER_BIT);
this.context.setStencilOp(7680,7680,7681);this.context.setColorMask(!1,!1,!1,!1);this.context.setBlendingEnabled(!1);this._quadVertexStream.bind();this.context.bindProgram(this._transformSolidProgram)};d.prototype.startStencilDraw=function(){this.context.setStencilWriteMask(0);this.context.setStencilOp(7680,7680,7680);this.context.setColorMask(!0,!0,!0,!0);this.context.setBlendingEnabled(!0);this.context.setBlendFunction(1,771);this._quadVertexStream.bind();this.context.bindProgram(this._transformTextureProgram)};
d.prototype.endStencilDraw=function(){this.context.setStencilTestEnabled(!1);this._quadVertexStream.unbind();this.context.bindProgram()};d.prototype.drawBitmap=function(a,b,c){var e=this.context,d=a.state,g=-Math.PI*d.rotation/180,h=-Math.PI*b.rotation/180;!(g+b.rotation)&&1.05>c&&.95<c?b.setSamplingMode(9728):b.setSamplingMode(9729);var n=d.toScreen(R,b.x,b.y),d=n[0],n=n[1],l=a.state.size[0],p=a.state.size[1],C=c*b.width;c*=b.height;var q=a.globalOpacity*b.opacity,k=this._transform,r=this._quadVertexStream;
a=a.drawPhase;a===f.WGLDrawPhase.CLIP?(e.setStencilFunction(519,this.stencilRef,255),e=this._transformSolidProgram):(e.setStencilFunction(514,this.stencilRef,255),e=this._transformTextureProgram);m.mat4.identity(k);m.mat4.scale(k,k,t.vec3.set(u,2/l,2/p,1));m.mat4.translate(k,k,t.vec3.set(u,d-l/2,-n+p/2,0));m.mat4.rotateZ(k,k,g);m.mat4.translate(k,k,t.vec3.set(u,C/2,-c/2,0));m.mat4.rotateZ(k,k,-h);m.mat4.scale(k,k,t.vec3.set(u,C/2,c/2,1));e.setUniformMatrix4fv("u_transform",k);a!==f.WGLDrawPhase.CLIP&&
(b.bind(0),e.setUniform1i("u_texture",0));e.setUniform1f("u_opacity",q);r.draw()};d.prototype._getPaintPass=function(a){this._passes||(this._passes=new Map);if(!this._passes.has(a))try{this._passes.set(a,new a)}catch(b){throw Error("Tried to instantiate WGLPaintPass with unknown constructor: "+a+",\n"+b);}return this._passes.get(a)};d.prototype._getPaintPasses=function(a,b){var c=this;return b.getPaintPassTs(a).map(function(a){return c._getPaintPass(a)})};d.prototype._drawPhases=function(a,b,c,e){var d=
this.context;d.setStencilTestEnabled(!0);for(var g=0;g<f.WGLDrawPhase.NUM_DRAW_PHASES-2;g++){var h=1<<g;if(h&c){var n=e?this._getPaintPasses(h,e):[],h=D({},a,{drawPhase:h});n.forEach(function(b){return b.preRender(a,a.rendererInfo)});for(var l=0,p=b;l<p.length;l++)p[l].doRender(h);n.reverse().forEach(function(b){return b.postRender(a,a.rendererInfo)})}}d.setStencilTestEnabled(!1)};d.prototype._debugTiles=function(a,b){};d.prototype._drawClippingRects=function(a,b){if(0!==b.length){var c=this.context;
c.setDepthWriteEnabled(!1);c.setDepthTestEnabled(!1);c.setStencilTestEnabled(!0);c.setBlendingEnabled(!1);c.setColorMask(!1,!1,!1,!1);c.setStencilOp(7680,7680,7681);c.setClearStencil(0);c.clear(c.gl.STENCIL_BUFFER_BIT);c.setStencilWriteMask(255);for(var d=0,m=b.length;d<b.length;d++,m--){var g=b[d];g.attached&&(g.stencilRef=m)}this._drawPhases(a,b,f.WGLDrawPhase.CLIP);c.setColorMask(!0,!0,!0,!0)}};d.prototype._setGlobalOpacity=function(a,b){if(b===f.WGLDrawPhase.MAP&&1!==a.globalOpacity){b=a.context;
var c=a.pixelRatio,d=a.state.size;a=Math.round(d[0]*c);c=Math.round(d[1]*c);if(null===this._globalOpacityFBO||this._globalOpacityFBO.width!==a||this._globalOpacityFBO.height!==c)null!==this._globalOpacityFBO&&this._globalOpacityFBO.dispose(),this._globalOpacityFBO=z.create(b,{colorTarget:0,depthStencilTarget:3,width:a,height:c});this._boundFBO=b.getBoundFramebufferObject();b.bindFramebuffer(this._globalOpacityFBO);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);
b.setClearStencil(0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT|b.gl.STENCIL_BUFFER_BIT);b.setDepthWriteEnabled(!1)}};d.prototype._applyGlobalOpacity=function(a,b){b===f.WGLDrawPhase.MAP&&1!==a.globalOpacity&&(b=a.context,b.bindFramebuffer(this._boundFBO),this._blitRenderer.render(b,this._globalOpacityFBO.colorTexture,9728,a.globalOpacity),this._boundFBO=null)};return d}();q.default=r});