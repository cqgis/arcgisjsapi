// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/generatorHelper ../core/Accessor ../core/arrayUtils ../core/asyncUtils ../core/maybe ../core/Promise ../core/promiseUtils ../core/accessorSupport/decorators".split(" "),function(B,C,D,v,w,m,n,x,y,z,p,A,r,t){return function(q){function a(){return null!==q&&q.apply(this,arguments)||this}v(a,q);a.prototype.when=function(b,d){return this.inherited(arguments)};
a.prototype.fetchPopupFeatures=function(b,d){return z.safeCast(this._fetchPopupFeaturesAsync(b,d))};a.prototype._fetchPopupFeaturesAsync=function(b,d){return m(this,void 0,void 0,function(){var c,h,f,e,a,g;return n(this,function(l){switch(l.label){case 0:return[4,this.when()];case 1:return l.sent(),[4,this._prepareFetchPopupFeatures(b,d)];case 2:return c=l.sent(),h=c.location,f=this._queryLayerPopupFeatures(c,d),e=r.resolve(c.clientOnlyGraphics),a=[e].concat(f),g=r.eachAlwaysValues(a).then(y.flatten),
[2,{promise:g,location:h,promises:a}]}})})};a.prototype._queryLayerPopupFeatures=function(b,d){var c=b.queryArea;return b.layerViewsAndGraphics.map(function(b){var a=b.layerView;b={clientGraphics:b.graphics,defaultPopupTemplateEnabled:p.isSome(d)?!!d.defaultPopupTemplateEnabled:!1};return a.fetchPopupFeatures(c,b)})};a.prototype._isValidPopupGraphic=function(b,d){return b&&!!b.getEffectivePopupTemplate(p.isSome(d)&&d.defaultPopupTemplateEnabled)};a.prototype._prepareFetchPopupFeatures=function(b,
d){return m(this,void 0,void 0,function(){var c,a,f,e,k,g,l,u;return n(this,function(h){switch(h.label){case 0:return[4,this._popupHitTestGraphics(b,d)];case 1:return c=h.sent(),a=c.clientGraphics,f=c.queryArea,e=c.location,k=this._getFetchPopupLayerViews(),g=this._graphicsPerFetchPopupLayerView(a,k),l=g.layerViewsAndGraphics,u=g.clientOnlyGraphics,[2,{clientOnlyGraphics:u,layerViewsAndGraphics:l,queryArea:f,location:e}]}})})};a.prototype._popupHitTestGraphics=function(b,d){return m(this,void 0,void 0,
function(){var a,h,f,e,k,g,l=this;return n(this,function(c){switch(c.label){case 0:return[4,this.popupHitTest(b)];case 1:return a=c.sent(),h=a.results,f=a.mapPoint,e=h.filter(function(b){return l._isValidPopupGraphic(b.graphic,d)}),k=e.length?e[0].mapPoint:null,g=e.map(function(b){return b.graphic}),[2,{clientGraphics:g,queryArea:f,location:f||k}]}})})};a.prototype._getFetchPopupLayerViews=function(){var b=this,a=[];this.allLayerViews.forEach(function(c){b._isValidPopupLayerView(c)&&a.push(c)});this._isValidPopupLayerView(this.graphicsView)&&
a.push(this.graphicsView);return a.reverse()};a.prototype._isValidPopupLayerView=function(b){return p.isSome(b)&&(!("layer"in b)||!b.suspended)&&"function"===typeof b.fetchPopupFeatures};a.prototype._graphicsPerFetchPopupLayerView=function(b,a){var c=[],d=new Map;a=a.map(function(a){var b=[];"layer"in a?d.set(a.layer,b):d.set(a.graphics,b);return{layerView:a,graphics:b}});for(var f=0;f<b.length;f++){var e=b[f],k=d.get(e.layer)||null;k?k.push(e):c.push(e)}return{layerViewsAndGraphics:a,clientOnlyGraphics:c}};
return a=w([t.subclass("esri.views.PopupView")],a)}(t.declared(x,A))});