// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/decorateHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/assignHelper ../core/Accessor ../core/Collection ../core/Handles ../core/Logger ../core/maybe ../core/screenUtils ../core/watchUtils ../core/accessorSupport/decorators ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/ManipulatorCollection".split(" "),function(E,F,h,v,w,x,y,m,z,A,B,f,k,q,g,C,n,D){function p(f){return"mouse"!==
f.pointerType||0===f.button}function t(f){f=f.native;return!(!f.ctrlKey&&!f.metaKey)}var u=B.getLogger("esri.views.ToolViewManager");return function(r){function c(a){a=r.call(this)||this;a._handles=new A;a._ignorePopupEventId=null;a._ignoreClickEventId=null;a._manipulators=new D;a._stopDrag=!1;a._manipulatorPointerUpEventId=0;a._dragStartScreenPoints=new Map;a._dragPreviousScreenPoints=new Map;a._hoveredManipulators=new Map;a._grabbedManipulators=new Map;a.tools=n.newToolCollection(a);a.cursor=null;
return a}v(c,r);c.prototype.initialize=function(){var a=this,b=this.view;this._handles.add(C.eventTypes.map(function(d){return b.on(d,function(b){a._handleInputEvent(b)})}).concat([this.tools.on("change",function(){a._refreshToolCursorWatchers();a._refreshToolManipulatorWatchers()})]))};c.prototype.destroy=function(){this.tools.forEach(function(a){a.destroy&&a.destroy()});this._manipulators.destroy();this._manipulators=null;this._handles.destroy();this._handles=null};Object.defineProperty(c.prototype,
"activeTool",{set:function(a){var b=this;f.isSome(a)&&!this.view.ready?u.error("#activeTool\x3d","cannot set active tool while view is not ready"):n.swap(this,a,function(a){b._set("activeTool",a);b._setManipulatorActive()})},enumerable:!0,configurable:!0});c.prototype.createTool=function(a,b,d){return x(this,void 0,void 0,function(){var e;return w(this,function(l){switch(l.label){case 0:return[4,this.view.whenReady()];case 1:return l.sent(),d?[4,this.removeTool(d)]:[3,3];case 2:l.sent(),l.label=3;
case 3:return e=new a(y({},b,{view:this.view})),this.tools.add(e),[2,e]}})})};c.prototype.removeTool=function(a){this.tools.remove(a)};c.prototype.attach=function(){var a=this;this.tools.forEach(function(b){b.attach&&b.attach(n.wrapToolViewManager(a,b))})};c.prototype.detach=function(){var a=this;this.tools.forEach(function(b){b.detach&&b.detach();a.removeToolManipulators(b)})};c.prototype.handlesClickEvent=function(a){return f.isSome(this.activeTool)||a.eventId===this._ignorePopupEventId||f.isSome(this._manipulators.findClosest(k.createScreenPointFromEvent(a),
a.pointerType))};c.prototype.addToolManipulator=function(a,b){var d=this;this.tools.includes(a)&&this.view.ready?(this._manipulators.add(a,b,this._manipulatorPointerUpEventId),b.installRenderHandles&&b.installRenderHandles(this._handles,function(a){return d._manipulators.forEach(a)})):u.error("#addToolManipulator()","cannot add manipulator for tool not attached to view")};c.prototype.removeToolManipulator=function(a,b){var d=this,e=this._manipulators.remove(a,b);this._hoveredManipulators.forEach(function(a,
b){e===a.manipulatorId&&d._hoveredManipulators.delete(b)});this._grabbedManipulators.forEach(function(a,b){e===a.manipulatorId&&(d._grabbedManipulators.delete(b),d._dragStartScreenPoints.delete(b),d._dragPreviousScreenPoints.delete(b))});this._setToolCursor()};c.prototype.removeToolManipulators=function(a){var b=this;this._manipulators.removeTool(a);this._hoveredManipulators.forEach(function(d,e){a===d.tool&&b._hoveredManipulators.delete(e)});this._grabbedManipulators.forEach(function(d,e){a===d.tool&&
(b._grabbedManipulators.delete(e),b._dragStartScreenPoints.delete(e),b._dragPreviousScreenPoints.delete(e))});this._setToolCursor()};c.prototype.attemptManipulatorDragTo=function(a,b,d,e){if(this._manipulators.hasOverlappingInTool(a,b,d.screenPoint))return!1;b.attemptDragTo(d,f.isSome(e)?e:{start:d.screenPoint,previous:d.screenPoint});return!0};c.prototype._handleInputEvent=function(a){var b=this.activeTool;"pointer-up"===a.type&&(this._manipulatorPointerUpEventId=a.eventId);"click"===a.type&&a.eventId===
this._ignoreClickEventId||"double-click"===a.type&&a.eventId===this._ignoreClickEventId+2?a.stopPropagation():(f.isSome(this.activeTool)?(this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(a),"immediate-click"===a.type&&f.isNone(this.activeTool)&&(this._ignoreClickEventId=a.eventId)):this.tools.forEach(function(b){!1!==b.visible&&b.handleInputEvent&&b.handleInputEvent(a)}),this._handleManipulatorEvent(a)&&(a.stopPropagation(),this._setToolCursor()),f.isSome(b)&&"pointer-up"===a.type&&
(this._ignorePopupEventId=a.eventId))};c.prototype._handleManipulatorEvent=function(a){var b=!1;switch(a.type){case "drag":0<this._grabbedManipulators.size&&(this._stopDrag=!0);this._stopDrag&&(a.stopPropagation(),"end"===a.action&&(this._stopDrag=!1));break;case "pointer-down":if(!p(a)||t(a))break;var d=k.createScreenPointFromEvent(a),e=this._manipulators.findClosest(d,a.pointerType);if(f.isNone(e))break;var c=this._manipulators.findByKey(e);f.isSome(c)&&c.interactive&&(b=!0,this._grabbedManipulators.set(a.pointerId,
e),c.grabbing=!0,this._dragStartScreenPoints.set(a.pointerId,d),this._dragPreviousScreenPoints.set(a.pointerId,d),this.activeTool=e.tool);break;case "pointer-up":if(!p(a))break;e=this._manipulators.findByKey(this._grabbedManipulators.get(a.pointerId));f.isSome(e)&&(b=!0,e.grabbing=!1,1===this._grabbedManipulators.size&&(this.activeTool=null));this._grabbedManipulators.delete(a.pointerId);this._dragStartScreenPoints.delete(a.pointerId);this._dragPreviousScreenPoints.delete(a.pointerId);break;case "pointer-drag":if(!p(a))break;
c=this._grabbedManipulators.get(a.pointerId);e=this._manipulators.findByKey(c);if(f.isNone(e))break;d=k.createScreenPointFromEvent(a);d.x=Math.max(0,Math.min(this.view.width,d.x));d.y=Math.max(0,Math.min(this.view.height,d.y));var g={start:this._dragStartScreenPoints.get(a.pointerId),previous:this._dragPreviousScreenPoints.get(a.pointerId)};switch(a.action){case "start":case "update":e.dragging=!0;b=this.attemptManipulatorDragTo(c.tool,e,{screenPoint:d},g);break;case "end":e.dragging=!1,b=!0}this._dragPreviousScreenPoints.set(a.pointerId,
d);break;case "immediate-click":case "pointer-move":if("touch"===a.pointerType)break;d=this._manipulators.findByKey(this._hoveredManipulators.get(a.pointerId));e=this._manipulators.findClosest(k.createScreenPointFromEvent(a),a.pointerType);c=this._manipulators.findByKey(e);if(d===c)break;b=!0;f.isSome(d)&&(d.hovering=!1);f.isSome(e)&&f.isSome(c)&&c.interactive?(c.hovering=!0,this._hoveredManipulators.set(a.pointerId,e)):this._hoveredManipulators.delete(a.pointerId);break;case "click":d=k.createScreenPointFromEvent(a),
e=this._manipulators.findClosest(d,a.pointerType,a.eventId),c=this._manipulators.findByKey(e),t(a)||this._manipulators.forEach(function(a){a.selected=!1}),!f.isNone(c)&&c.interactive&&(c.selectable&&(c.selected=!0),c.click({screenPoint:d,button:a.button}),b=!0)}return b};c.prototype._refreshToolCursorWatchers=function(){var a=this;this._handles.remove("cursors");this._setToolCursor();this.tools.forEach(function(b){b instanceof m&&(b=q.watch(b,["cursor","visible"],function(){return a._setToolCursor()}),
a._handles.add(b,"cursors"))})};c.prototype._setToolCursor=function(){for(var a=null,b=0;b<this.tools.length;b++){var d=this.tools.getItemAt(b);if(null!=d.cursor&&!1!==d.visible){a=d.cursor;break}}!a&&0<this._grabbedManipulators.size&&(a="grabbing");!a&&0<this._hoveredManipulators.size&&(a="pointer");this._set("cursor",a)};c.prototype._refreshToolManipulatorWatchers=function(){var a=this;this._handles.remove("manipulators");this.tools.forEach(function(b){b instanceof m&&(b=q.watch(b,"visible",function(){return a._setManipulatorActive()},
!0),a._handles.add(b,"manipulators"))})};c.prototype._setManipulatorActive=function(){var a=this;this._manipulators.forEach(function(b,d){var c=f.isNone(a.activeTool)||a.activeTool===d;b.active=d.visible&&c})};h([g.property({constructOnly:!0,nonNullable:!0})],c.prototype,"view",void 0);h([g.property({value:null})],c.prototype,"activeTool",null);h([g.property({readOnly:!0,type:z})],c.prototype,"tools",void 0);h([g.property({readOnly:!0})],c.prototype,"cursor",void 0);return c=h([g.subclass("esri.views.ToolViewManager")],
c)}(g.declared(m))});