// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/decorateHelper ../../core/tsSupport/declareExtendsHelper ../../core/Accessor ../../core/Collection ../../core/compilerUtils ../../core/maybe ../../core/screenUtils ../../core/accessorSupport/decorators ../../core/libs/gl-matrix-2/mat3 ../../core/libs/gl-matrix-2/mat3f64 ../../core/libs/gl-matrix-2/mat4 ../../core/libs/gl-matrix-2/mat4f64 ../../core/libs/gl-matrix-2/vec2 ../../core/libs/gl-matrix-2/vec2f32 ../../core/libs/gl-matrix-2/vec3 ../../core/libs/gl-matrix-2/vec3f64 ../../geometry/support/aaBoundingRect ../../layers/graphics/dehydratedFeatures ../3d/support/geometryUtils ../3d/support/stack ../3d/webgl-engine/lib/Intersector ../3d/webgl-engine/lib/intersectorUtils ../3d/webgl-engine/lib/Layer ../3d/webgl-engine/lib/Object3D ../3d/webgl-engine/parts/Model".split(" "),
function(u,E,f,T,U,V,F,p,q,d,G,W,A,B,w,X,l,r,Y,H,m,x,Z,aa,ba,ca,t){function I(d){return 0!==d[12]||0!==d[13]||0!==d[14]}Object.defineProperty(E,"__esModule",{value:!0});u=function(u){function c(a){a=u.call(this)||this;a.hideOnGrab=!1;a.moveOnDrag=!0;a.snapToPointer=!0;a.allowOverlap=!1;a.collisionType={type:"point"};a.renderObjects=[];a.autoScaleRenderObjects=!0;a._radius=10;a._focusMultiplier=2;a._touchMultiplier=2.5;a.interactive=!0;a.selectable=!1;a.dragging=!1;a._position=r.vec3f64.create();a._modelTransform=
B.mat4f64.create();a._dragOffset=null;a._dirtyScreenPoint=q.createScreenPoint();a._dirtyScreenPointArray=q.createScreenPointArray();a._dirtyRenderScreenPointArray=q.createRenderScreenPointArray3();a._dirtyOriginScreenPointArray=q.createScreenPointArray();a._screenPositionDirty=!0;a._engineResourcesAddedToStage=!1;a._engineResources=null;a._engineLayerId=null;a._materialIdReferences=null;a._hitResult={onSurface:!1,surfaceType:"ground"};a._handlers=new V;return a}T(c,u);v=c;c.prototype.initialize=function(){this._intersector=
new Z(this.view.viewingMode);this._mapPoint=H.makeDehydratedPoint(0,0,0,this.view.spatialReference)};c.prototype.destroy=function(){this._handlers.removeAll();this._handlers=null;this._removeResourcesFromStage();this._engineResources=null;this._set("view",null);this._camera=null};Object.defineProperty(c.prototype,"alignment",{get:function(){return this._get("alignment")},set:function(a){this._set("alignment",a);this.constructed&&this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"visible",{set:function(a){a!==this._get("visible")&&(this._set("visible",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"radius",{get:function(){return this._radius},set:function(a){a!==this._radius&&(this._radius=a,this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"focusMultiplier",{get:function(){return this._focusMultiplier},set:function(a){this._focusMultiplier=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"touchMultiplier",{get:function(){return this._touchMultiplier},set:function(a){this._touchMultiplier=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"modelTransform",{get:function(){return this._modelTransform},set:function(a){I(a)&&(this._screenPositionDirty=!0);A.mat4.copy(this._modelTransform,a);this._updateEngineObject()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"position",{get:function(){return this._position},set:function(a){this.view.renderCoordsHelper.fromRenderCoords(a,
this._mapPoint,this._mapPoint.spatialReference);this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"mapPoint",{get:function(){return this._mapPoint},set:function(a){H.clonePoint(a,this._mapPoint);this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"grabbing",{set:function(a){a!==this._get("grabbing")&&(this._set("grabbing",a),this._updateEngineObject());a||(this._dragOffset=null)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"hovering",{set:function(a){a!==this._get("hovering")&&(this._set("hovering",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"selected",{set:function(a){a!==this._get("selected")&&(this._set("selected",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"active",{set:function(a){a!==this._get("active")&&(this._set("active",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"state",{set:function(a){a!==this._get("state")&&(this._set("state",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"surfaceType",{get:function(){return this._hitResult.onSurface?this._hitResult.surfaceType:null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"screenPoint",{get:function(){this._updateScreenPositions();return this._dirtyScreenPoint},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_screenPointArray",{get:function(){this._updateScreenPositions();return this._dirtyScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_renderScreenPointArray",{get:function(){this._updateScreenPositions();return this._dirtyRenderScreenPointArray},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_originScreenPointArray",{get:function(){this._updateScreenPositions();return this._dirtyOriginScreenPointArray},enumerable:!0,configurable:!0});c.prototype._updateScreenPositions=function(a){void 0===a&&(a=!1);if(this._screenPositionDirty){a=I(this._modelTransform);var b;a?(b=this._calculateModelTransformOffset(da),b=l.vec3.add(b,b,this._position)):b=this._position;this._screenPositionDirty=!1;this._camera.projectPoint(b,this._dirtyRenderScreenPointArray);
this._camera.renderToScreen(this._dirtyRenderScreenPointArray,this._dirtyScreenPointArray);q.screenPointArrayToObject(this._dirtyScreenPointArray,this._dirtyScreenPoint);a?(this._camera.projectPoint(this._position,J),this._camera.renderToScreen(J,this._dirtyOriginScreenPointArray)):w.vec2.copy(this._dirtyOriginScreenPointArray,this._dirtyScreenPointArray)}};c.prototype.intersectionDistance=function(a,b){if(!this._get("visible")||!this._get("active"))return null;var c=q.screenPointObjectToArray(a,
K);a=this._getCollisionRadius(b);switch(this.collisionType.type){case "point":if(w.vec2.squaredDistance(this._screenPointArray,c)<a*a)return this._renderScreenPointArray[2];break;case "line":var n=this.collisionType.paths;b=this._camera.computeScreenPixelSizeAt(this._position);b=this._calculateObjectTransform(b,y);a*=this._camera.computeScreenPixelSizeAt(this._position);for(var c=m.ray.fromScreen(this._camera,c,C),k=0,h=n;k<h.length;k++)if(n=h[k],0!==n.length)for(var e=l.vec3.transformMat4(L,n[0],
b),g=1;g<n.length;g++){var d=l.vec3.transformMat4(M,n[g],b),f=m.lineSegment.closestRayDistance2(m.lineSegment.fromPoints(e,d,N),c);if(null!=f&&f<a*a)return b=l.vec3.add(x.sv3d.get(),e,d),l.vec3.scale(b,b,.5),a=q.castRenderScreenPointArray(x.sv3d.get()),this._camera.projectPoint(b,a),a[2];l.vec3.copy(e,d)}break;case "disc":e=this.collisionType.direction;b=this._camera.computeScreenPixelSizeAt(this._position);b=this._calculateObjectTransform(b,y);a*=this._camera.computeScreenPixelSizeAt(this._position);
c=m.ray.fromScreen(this._camera,c,C);g=G.mat3.fromMat4(O,b);g=l.vec3.transformMat3(P,e,g);e=this._calculateModelTransformPosition(Q);m.plane.fromPositionAndNormal(e,g,z);k=D;if(m.plane.intersectRay(z,c,k)&&l.vec3.squaredDistance(k,e)<a*a)return this._renderScreenPointArray[2];break;case "ribbon":b=this.collisionType;n=b.paths;e=b.direction;b=this._camera.computeScreenPixelSizeAt(this._position);b=this._calculateObjectTransform(b,y);a*=this._camera.computeScreenPixelSizeAt(this._position);c=m.ray.fromScreen(this._camera,
c,C);g=G.mat3.fromMat4(O,b);g=l.vec3.transformMat3(P,e,g);e=this._calculateModelTransformPosition(Q);m.plane.fromPositionAndNormal(e,g,z);k=D;if(!m.plane.intersectRay(z,c,k))break;c=0;for(h=n;c<h.length;c++)if(n=h[c],0!==n.length)for(e=l.vec3.transformMat4(L,n[0],b),g=1;g<n.length;g++){d=l.vec3.transformMat4(M,n[g],b);f=m.lineSegment.distance2(m.lineSegment.fromPoints(e,d,N),k);if(null!=f&&f<a*a)return b=l.vec3.add(x.sv3d.get(),e,d),l.vec3.scale(b,b,.5),a=q.castRenderScreenPointArray(x.sv3d.get()),
this._camera.projectPoint(b,a),a[2];l.vec3.copy(e,d)}break;default:F.neverReached(this.collisionType)}return null};c.prototype.attemptDragTo=function(a){if(!this.moveOnDrag)return this._handlers.forEach(function(b){var c=b.handler;"drag"===b.type&&c(a)}),!1;var b=q.screenPointObjectToArray(a.screenPoint,K);p.isNone(this._dragOffset)&&this.grabbing&&!this.snapToPointer&&(this._dragOffset=w.vec2.subtract(X.vec2f32.create(),b,this._originScreenPointArray));p.isSome(this._dragOffset)&&w.vec2.subtract(b,
b,this._dragOffset);var b=this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(b,this._intersector,"on-the-ground"===this.alignment?R:null).results.min,c=D;b.getIntersectionPoint(c)?(this.position=c,this._hitResult.onSurface=!0,this._hitResult.surfaceType="TerrainRenderer"===b.intersector?"ground":"feature",this._handlers.forEach(function(b){var c=b.handler;"drag"===b.type&&c(a)})):this._hitResult.onSurface=!1;return this._hitResult.onSurface};c.prototype.click=function(a){this._handlers.forEach(function(b){var c=
b.handler;"click"===b.type&&c(a)})};c.prototype.on=function(a,b){this._handlers.push({type:a,handler:b})};c.prototype.addToEngineLayer=function(a,b){p.isSome(this._engineLayerId)||(p.isSome(a)?this._engineLayerId=a:(a=new ba("manipulator-3d",{isPickable:!1}),this.view._stage.add(t.ContentType.LAYER,a),this.view._stage.addToViewContent([a.id]),this._engineLayerId=a.id),p.isSome(b)?this._materialIdReferences=b:this._materialIdReferences=new Map,this._updateEngineObject())};c.prototype.installRenderHandles=
function(a,b){var c=null,d=null;b(function(a){return a instanceof v?(c=a._engineLayerId,d=a._materialIdReferences,!1):!0});this.addToEngineLayer(c,d);this._camera=this.view.state.camera;if(!a.has("render-manipulator-3d")){var k=function(a){b(function(b){b instanceof v&&b.view.renderCoordsHelper.fromRenderCoords(b.position,S,a.spatialReference)&&Y.containsPoint(a.extent,S)&&b._refreshMapPoint(!0)})};a.add([this.view.state.watch("camera",function(a){b(function(b){b instanceof v&&(b._camera=a,b._screenPositionDirty=
!0,b._updateEngineObject())})}),this.view.elevationProvider.on("elevation-change",function(a){return k(a)})],"render-manipulator-3d")}};c.prototype._refreshMapPoint=function(a){void 0===a&&(a=!1);switch(this.alignment){case "none":break;case "on-the-ground":var b=this.view.elevationProvider.getElevation(this.mapPoint,"ground");if(b===this._mapPoint.z&&a)return;this._mapPoint.z=b;break;default:F.neverReached(this.alignment)}this._screenPositionDirty=!0;this._hitResult.onSurface=!1;this.view.renderCoordsHelper.toRenderCoords(this._mapPoint,
this._position);this._updateEngineObject()};c.prototype._updateEngineObject=function(){if(!p.isNone(this._engineLayerId))if(!1===this._get("visible")||!1===this._get("active"))this._removeResourcesFromStage();else{var a=this._get("view").state.camera.computeScreenPixelSizeAt(this._position),b=y;!0===this._get("autoScaleRenderObjects")&&(a*=this._getFocusedSize(this._radius,this._focused));this._calculateObjectTransform(a,b);for(var a=this._ensureEngineResources().objectsByState,c=(this._focused?2:
1)|(this._get("selected")?8:4),d=this._get("hideOnGrab")&&this._get("grabbing"),k=0;k<a.length;k++){var h=a[k],e=h.stateMask,h=h.objects;if(d)for(var e=0,g=h;e<g.length;e++)h=g[e],h.object3D.hideAllComponents(),h.startTimeMs=0;else if(g=0===(e&15)||(c&e)===(e&15),e=0===(e&32752)||(this._get("state")&e)===(e&32752),g&&e)for(e=0,g=h;e<g.length;e++)h=g[e],h.object3D.unhideAllComponents(),h.object3D.objectTransformation=b;else for(e=0,g=h;e<g.length;e++)h=g[e],h.object3D.hideAllComponents(),h.startTimeMs=
0}}};c.prototype._ensureEngineResources=function(){if(p.isNone(this._engineResources)){var a=this.view._stage.get(t.ContentType.LAYER,p.expect(this._engineLayerId)),b=[],c=new Set;this.renderObjects.forEach(function(a){a=a.material;c.has(a)||(b.push(a),c.add(a))});var d=function(a,b){var c=b.geometry,e=b.material,d=b.transform;Array.isArray(c)?c.forEach(function(b){return a.addGeometry(b,e,d)}):a.addGeometry(c,e,d)},k=new Map;this.renderObjects.forEach(function(a){var b=new ca({idHint:"manipulator"});
d(b,a);var c=a.stateMask||0,e=k.get(c)||[];e.push({object3D:b,startTimeMs:0,delayMs:a.delayMs});k.set(c,e)});var h=[];k.forEach(function(a,b){h.push({stateMask:b,objects:a})});this._engineResources={objectsByState:h,layer:a,materials:b}}this._addResourcesToStage();return this._engineResources};c.prototype._addResourcesToStage=function(){var a=this;if(!this._engineResourcesAddedToStage&&!p.isNone(this._engineResources)){var b=this._engineResources,c=b.objectsByState,d=b.layer;b.materials.forEach(function(b){var c=
p.expect(a._materialIdReferences),e=c.get(b.id)||0;0===e&&a.view._stage.add(t.ContentType.MATERIAL,b);c.set(b.id,e+1)});c.forEach(function(b){b.objects.forEach(function(b){b=b.object3D;d.addObject(b);a.view._stage.add(t.ContentType.OBJECT,b)})});this._engineResourcesAddedToStage=!0}};c.prototype._removeResourcesFromStage=function(){var a=this;if(this._engineResourcesAddedToStage&&!p.isNone(this._engineResources)){var b=this._engineResources,c=b.layer,d=b.materials;b.objectsByState.forEach(function(b){b.objects.forEach(function(b){b=
b.object3D;c.removeObject(b);a.view._stage.remove(t.ContentType.OBJECT,b.id)})});d.forEach(function(b){var c=p.expect(a._materialIdReferences),d=c.get(b.id);1===d?(a.view._stage.remove(t.ContentType.MATERIAL,b.id),c.delete(b.id)):c.set(b.id,d-1)});this._engineResourcesAddedToStage=!1}};c.prototype._getCollisionRadius=function(a){return this._getFocusedSize(this._radius,!0)*("touch"===a?this._touchMultiplier:1)};c.prototype._getFocusedSize=function(a,b){return a*(b?this._focusMultiplier:1)};c.prototype._calculateModelTransformPosition=
function(a){var b=this._camera.computeScreenPixelSizeAt(this._position),b=this._calculateObjectTransform(b,ea);return l.vec3.set(a,b[12],b[13],b[14])};c.prototype._calculateModelTransformOffset=function(a){var b=this._calculateModelTransformPosition(a);return l.vec3.subtract(a,b,this._position)};c.prototype._calculateObjectTransform=function(a,b){A.mat4.set(b,a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1);A.mat4.multiply(b,b,this._modelTransform);b[12]+=this._position[0];b[13]+=this._position[1];b[14]+=this._position[2];
b[15]=1;return b};var v;f([d.property({constructOnly:!0,nonNullable:!0})],c.prototype,"view",void 0);f([d.property({value:"none",nonNullable:!0})],c.prototype,"alignment",null);f([d.property()],c.prototype,"hideOnGrab",void 0);f([d.property()],c.prototype,"moveOnDrag",void 0);f([d.property()],c.prototype,"snapToPointer",void 0);f([d.property()],c.prototype,"allowOverlap",void 0);f([d.property()],c.prototype,"collisionType",void 0);f([d.property({constructOnly:!0})],c.prototype,"renderObjects",void 0);
f([d.property()],c.prototype,"autoScaleRenderObjects",void 0);f([d.property({value:!0})],c.prototype,"visible",null);f([d.property()],c.prototype,"radius",null);f([d.property()],c.prototype,"focusMultiplier",null);f([d.property()],c.prototype,"touchMultiplier",null);f([d.property()],c.prototype,"interactive",void 0);f([d.property()],c.prototype,"selectable",void 0);f([d.property({value:!1})],c.prototype,"grabbing",null);f([d.property()],c.prototype,"dragging",void 0);f([d.property({value:!1})],c.prototype,
"hovering",null);f([d.property({value:!1})],c.prototype,"selected",null);f([d.property({value:!0})],c.prototype,"active",null);f([d.property({value:0})],c.prototype,"state",null);f([d.property({dependsOn:["hovering","grabbing"]})],c.prototype,"focused",null);return c=v=f([d.subclass("esri.views.interactive.Manipulator3D")],c)}(d.declared(U));E.Manipulator3D=u;var R={include:new Set};R.include.add(aa.TERRAIN_ID);var K=q.createScreenPointArray(),J=q.createRenderScreenPointArray3(),N=m.lineSegment.create(),
C=m.ray.create(),O=W.mat3f64.create(),ea=B.mat4f64.create(),y=B.mat4f64.create(),z=m.plane.create(),L=r.vec3f64.create(),M=r.vec3f64.create(),D=r.vec3f64.create(),P=r.vec3f64.create(),Q=r.vec3f64.create(),da=r.vec3f64.create(),S=r.vec3f64.create()});