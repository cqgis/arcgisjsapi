// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../core/executeAsync ../../core/pbf ../../core/promiseUtils ../2d/engine/webgl/TileClipper ../2d/tiling/enums ./BackgroundBucket ./CircleBucket ./Feature ./FillBucket ./LineBucket ./SourceLayerData ./SymbolBucket".split(" "),function(R,S,I,y,z,n,u,A,L,M,N,O,P,Q){return function(){function e(c,b,B){this._pbfTiles={};this._tileClippers={};this._client=B;this._tile=b;this._layers=b.getLayers();var f=b.tileKey.split("/").map(parseFloat);b=f[0];B=f[1];f=f[2];this._level=b;for(var a=
0,h=Object.keys(c);a<h.length;a++){var d=h[a],g=c[d];this._pbfTiles[d]=new y(new Uint8Array(g.protobuff),new DataView(g.protobuff));if(g.refKey&&(g=g.refKey.split("/").map(parseFloat)[0],g=b-g,0<g)){var e=(1<<g)-1;this._tileClippers[d]=new n.TileClipper(g,B&e,f&e)}this._tileClippers[d]||(this._tileClippers[d]=new n.SimpleBuilder)}}e.prototype.parse=function(){for(var c=this,b=this._parseTileData(this._pbfTiles),e=this._layers,f=this._level,a,h=[],d=this._tileClippers,g={},v={},p=e.length-1;0<=p;p--)if(a=
e[p],!(a.minzoom&&f<a.minzoom||a.maxzoom&&f>=a.maxzoom||a.layout&&"none"===a.layout.visibility))if(0===a.type){var l=this._createBucket(a);l.layerIndex=p;h.push(l)}else if(b[a.source]&&d[a.source]){var q=d[a.source],C=a.sourceLayer,n=b[a.source][C];n&&((l=v[a.source])||(l=v[a.source]=new Set),l.add(a.sourceLayer),l=this._createBucket(a))&&(l.layerIndex=p,l.layerExtent=n.extent,l.tileClipper=q,(q=g[a.source])||(q=g[a.source]={}),(a=q[C])||(a=q[C]=[]),a.push(l))}for(var y=10*this._level,A=10*(this._level+
1),r=[],D=[],w=[],J=[],E=new Set,F={},G=[],K=[],e=function(c){v[c].forEach(function(b){G.push(b);K.push(c)})},f=0,d=Object.keys(v);f<d.length;f++)e(d[f]);var x=0,m=0,H=G.length;return I(function(){if(c._tile.status===u.TileStatus.INVALID)return!0;switch(x){case 0:if(m<H){var a=K[m],k=G[m++];if(b[a]&&g[a]){var e=b[a][k];if((a=g[a][k])&&0!==a.length)for(var f=e.getData();f.next(2);){var h=new M(f.getMessage(),e);if(k=h.values){var d=k._minzoom;if(d&&d>=A)continue;if((k=k._maxzoom)&&k<=y)continue}for(var d=
0,t=a;d<t.length;d++)k=t[d],k.pushFeature(h)}}}else{e=c._tile;f=0;for(h=Object.keys(g);f<h.length;f++)for(d in a=h[f],t=g[a],t)for(var a=t[d],l=0;l<a.length;l++)k=a[l],k.hasFeatures()&&(3===k.layer.type?(r.push(k),e.addBucket(k)):k.layer.refLayerId?w.push(k):(D.push(k),J[k.layer.id]=k));x=1;m=0;H=r.length}break;case 1:m<H?(a=r[m++],a.getResources(a.tileClipper,E,F)):x=2}return 2===x}).then(function(){if(c._tile.status===u.TileStatus.INVALID)return[];var a=[],b=c._tile.getWorkerTileHandler(),d;0<E.size&&
(d=b.fetchSprites(E,c._client),a.push(d));for(var e in F)d=F[e],0<d.size&&(d=b.fetchGlyphs(c._tile.tileKey,e,d,c._client),a.push(d));return z.all(a).then(function(a){if(c._tile.status===u.TileStatus.INVALID)return[];var b=0,d=0,e=D.length;return I(function(){if(c._tile.status===u.TileStatus.INVALID)return!0;switch(b){case 0:if(d<e){var a=D[d++];a.processFeatures(a.tileClipper,c._tile);h.push(a)}else b=1,d=0,e=w.length;break;case 1:for(var f=0;f<w.length;f++){var a=w[f],g=J[a.layer.refLayerId];g&&
(g.assignBufferInfo(a),h.push(a))}b=2;d=0;e=r.length;break;case 2:d<e?(a=r[d++],a.processFeatures(a.tileClipper,c._tile),h.push(a)):b=3}return 3===b}).then(function(){h.sort(function(a,b){return a.layerIndex-b.layerIndex});return h})}).catch(function(a){return z.reject(Error(a))})}).catch(function(a){return z.reject(Error(a))})};e.prototype._parseTileData=function(c){for(var b={},e=0,f=Object.keys(c);e<f.length;e++){for(var a=f[e],h=c[a],d={};h.next();)switch(h.tag()){case 3:var g=new P(h.getMessage());
d[g.name]=g;break;default:h.skip()}b[a]=d}return b};e.prototype._createBucket=function(c){switch(c.type){case 0:return this._createBackgroundBucket(c);case 1:return this._createFillBucket(c);case 2:return this._createLineBucket(c);case 4:return this._createCircleBucket(c);case 3:return this._createSymbolBucket(c)}};e.prototype._createBackgroundBucket=function(c){return new A(c,this._level)};e.prototype._createFillBucket=function(c){var b=this._tile;return new N(c,this._level,c.hasDataDrivenFill?b.fillDDVertexBuffer:
b.fillVertexBuffer,b.fillIndexBuffer,c.hasDataDrivenOutline?b.outlineDDVertexBuffer:b.outlineVertexBuffer,b.outlineIndexBuffer)};e.prototype._createLineBucket=function(c){var b=this._tile;return new O(c,this._level,c.hasDataDrivenLine?b.lineDDVertexBuffer:b.lineVertexBuffer,b.lineIndexBuffer)};e.prototype._createCircleBucket=function(c){var b=this._tile;return new L(c,this._level,b.circleVertexBuffer,b.circleIndexBuffer)};e.prototype._createSymbolBucket=function(c){var b=this._tile;return new Q(c,
this._level,c.hasDataDrivenIcon?b.iconDDVertexBuffer:b.iconVertexBuffer,b.iconIndexBuffer,c.hasDataDrivenText?b.textDDVertexBuffer:b.textVertexBuffer,b.textIndexBuffer,b.placementEngine,b.getWorkerTileHandler())};return e}()});