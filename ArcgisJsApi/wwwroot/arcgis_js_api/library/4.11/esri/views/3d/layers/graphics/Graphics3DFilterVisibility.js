// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../geometry ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Polygon ../../../../geometry/support/jsonUtils ../../../../layers/graphics/featureConversionUtils ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/data/FeatureStore ../../../../layers/graphics/data/QueryEngine".split(" "),
function(c,h,m,f,n,p,q,r,t,e,u,v,k,w,x,y){Object.defineProperty(h,"__esModule",{value:!0});var z=r.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");c=function(c){function b(a){a=c.call(this)||this;a._dirty=!1;a._querying=!1;a._handles=new q;return a}m(b,c);Object.defineProperty(b.prototype,"updating",{get:function(){return this._dirty||this._querying||null!=this._queryResult},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"featureGeometryType",{get:function(){switch(this.geometryType){case "multipoint":case "point":case "polygon":case "polyline":return this.geometryType;
case "mesh":case "extent":return"polygon"}},enumerable:!0,configurable:!0});b.prototype.setup=function(a,d){var b=this;this._layerView=a;this._core=d;this._objectIdField=a.layer.objectIdField;a.layer.timeInfo&&(this._timeInfo=a.layer.timeInfo.toJSON());this._scheduler=this._layerView.view.resourceController.scheduler;this._handles.add(this._scheduler.registerTask(4,function(a){return b._update(a)},function(){return b._needsUpdate()}));this._handles.add(t.on(d.owner,"loadedGraphics","change",function(a){return b._graphicsChanged(a)},
function(){return b.dirty=!0}))};b.prototype.destroy=function(){this._handles.destroy();this._handles=null;this.clear();this._core=this._layerView=null};b.prototype.clear=function(){this._queryEngine&&(this._queryEngine.destroy(),this._store=this._queryResult=this._queryEngine=null,this._querying=!1,this._core.forEachGraphics3DGraphic(function(a){return a.clearVisibilityFlag(2)}));this.dirty=!1;this.notifyChange("updating")};b.prototype._graphicsChanged=function(a){if(this._queryEngine){if(a.removed&&
0<a.removed.length){for(var d=Array(a.removed.length),b=0;b<a.removed.length;++b)d[b]=a.removed[b].uid;this._store.removeManyById(d)}if(a.added&&0<a.added.length){d=Array(a.added.length);for(b=0;b<a.added.length;++b)d[b]=this._convertToOptimizedFeature(a.added[b]);this._store.addMany(d);this.dirty=!0}}else this.dirty=!0};b.prototype.updateVisibility=function(a){this._queryEngine&&(a.hasVisibilityFlag(2,0)||a.setVisibilityFlag(2,!1,0),this.dirty=!0)};b.prototype.filterChanged=function(){this.dirty=
!0};Object.defineProperty(b.prototype,"active",{get:function(){return this._layerView.filter&&0<this._core.owner.loadedGraphics.length},enumerable:!0,configurable:!0});b.prototype._ensureQueryEngine=function(a){var b=this;if(!this.active)return this.clear(),!1;if(this._queryEngine)return!0;var c=this._core.owner.loadedGraphics,l=n.featureGeometryTypeKebabDictionary.toJSON(this.featureGeometryType),g,e=Array(c.length),f=0;c.forEach(function(a){e[++f]=b._convertToOptimizedFeature(a);g=g||a.geometry.spatialReference});
this._store=new x.default({geometryType:l,hasM:!1,hasZ:!1});this._store.addMany(e);this._queryEngine=new y.default({hasZ:!1,hasM:!1,geometryType:l,fields:[],timeInfo:this._timeInfo,spatialReference:g,objectIdField:this._objectIdField,featureStore:this._store,scheduler:this._scheduler,priority:4});a.madeProgress();return!0};b.prototype._needsUpdate=function(){return this._dirty&&!this._querying||null!=this._queryResult};b.prototype._update=function(a){var b=this;if(this._ensureQueryEngine(a)){if(this._dirty&&
!this._querying&&!a.done){this._querying=!0;this.dirty=!1;var c=this._layerView.filter?this._layerView.filter.toJSON():{};this._queryEngine.executeQueryForIdSet(c).then(function(a){b._queryResult=a;b._querying=!1}).catch(function(a){z.warn("FeatureFilter query failed: "+a);b._queryResult=new Set;b._core.forEachGraphics3DGraphic(function(a){b._queryResult.add(b._getFeatureId(a.graphic));return!1});b._querying=!1});a.madeProgress()}this._queryResult&&!a.done&&(this._core.forEachGraphics3DGraphic(function(d){if(a.done)return!1;
var c=b._queryResult.has(b._getFeatureId(d.graphic));return d.setVisibilityFlag(2,c,0)?(a.madeProgress(),!0):!1}),a.done||(this._queryResult=null));this.notifyChange("updating")}else this.dirty=!1};b.prototype._convertToOptimizedFeature=function(a){var b=a.geometry;return"mesh"===b.type||"extent"===b.type?(b=u.fromExtent("mesh"===b.type?b.extent:b),b.hasZ=!1,b.hasM=!1,new w.default(k.convertFromGeometry(b),a.attributes,null,this._getFeatureId(a))):k.convertFromFeature(a,v.getJsonType(a.geometry),
!1,!1,this._objectIdField)};b.prototype._getFeatureId=function(a){return null==a.objectId?a.attributes[this._objectIdField]:a.objectId};Object.defineProperty(b.prototype,"dirty",{set:function(a){this._dirty!==a&&(this._dirty=a,this.notifyChange("updating"))},enumerable:!0,configurable:!0});f([e.property({readOnly:!0})],b.prototype,"updating",null);f([e.property({constructOnly:!0})],b.prototype,"geometryType",void 0);f([e.property({readOnly:!0,dependsOn:["geometryType"]})],b.prototype,"featureGeometryType",
null);return b=f([e.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],b)}(e.declared(p));h.Graphics3DFilterVisibility=c});