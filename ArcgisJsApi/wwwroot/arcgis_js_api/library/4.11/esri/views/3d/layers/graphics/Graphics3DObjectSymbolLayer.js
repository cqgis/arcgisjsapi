// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/errors/CancelError ../../../../Color ../../../../core/asyncUtils ../../../../core/lang ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ./ElevationAligners ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lodResourceUtils ./objectResourceUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(A,B,N,O,C,P,G,H,v,I,g,h,J,f,Q,R,S,l,T,m,K,U,D,V,n,L,p,W,X,q,Y){Object.defineProperty(B,"__esModule",{value:!0});A=function(w){function e(b,a,c,d){b=w.call(this,b,a,c,d)||this;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;c=b._getStageIdHint();if(!b._isPropertyDriven("size")&&(d=m.validateSymbolLayerSize(b.symbolLayer)))return b._logWarning(d),b.reject(),b;a.resource&&a.resource.href?b._prepareModelResources(a.resource.href,c):b._preparePrimitiveResources(a.resource?a.resource.primitive:
Q.defaultPrimitive,c);return b}N(e,w);e.prototype.getCachedSize=function(){var b=this._symbolSize;return{width:b[0],depth:b[1],height:b[2]}};Object.defineProperty(e.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0});e.prototype._preparePrimitiveResources=function(b,a){if(D.isValidPrimitive(b)){var c=this.symbolLayer;this._resourceBoundingBox=f.create(D.primitiveBoundingBox(b));this._resourceSize=h.vec3f64.fromArray(f.size(this._resourceBoundingBox));
this._symbolSize=h.vec3f64.fromArray(m.computeSizeWithResourceSize(this._resourceSize,c));var d=this._getMaterialOpacity(),d={specular:[0,0,0],opacity:d,transparent:1>d||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:x,diffuse:x,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},e=this.symbol;if("point-3d"===e.type&&e.verticalOffset){var e=e.verticalOffset,r=e.minWorldLength,k=e.maxWorldLength;d.verticalOffset={screenLength:H.pt2px(e.screenLength),
minWorldLength:r||0,maxWorldLength:null!=k?k:Infinity};d.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(d.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._isPropertyDriven("color")?d.externalColor=u:(c=c.material?C.toUnitRGBA(c.material.color):u,d.externalColor=c);this._fastUpdates=n.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(G.mixin(d,this._fastUpdates.materialParameters),
d.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(d.instanced.push("color"),this._optionalFields.push("color"));c=new Y(d,a+"_objectmat");this._lodResources=D.primitiveLodResources(b,c,a);this._originalOpacities=q.materialsFromLodResources(this._lodResources).map(function(){return 1});this._lodResources?(this.finalizeSymbolResources(),this.initializeLodRenderer(),this.complexity=this.computeComplexity(),this.resolve()):(this._logWarning("Unknown object symbol primitive: "+
b),this.reject())}else this._logWarning("Unknown object symbol primitive: "+b),this.reject()};e.prototype._prepareModelResources=function(b,a){var c=this,d=["transformation"];a={materialParamsMixin:{instanced:d,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},idHint:a,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=n.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?
(G.mixin(a.materialParamsMixin,this._fastUpdates.materialParameters),d.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(d.push("color"),this._optionalFields.push("color"));d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){var d=d.verticalOffset,e=d.minWorldLength,r=d.maxWorldLength;a.materialParamsMixin.verticalOffset={screenLength:H.pt2px(d.screenLength),minWorldLength:e||0,maxWorldLength:null!=r?r:Infinity};a.materialParamsMixin.castShadows=
!1}this._symbolLoaderPromise=P.safeCast(U.fetch(b,a));this._symbolLoaderPromise.then(function(a){c._symbolLoaderPromise=null;if(!c.isRejected()){var b=K.makeLodResources(a.lods);K.fillEstimatedMinScreenSpaceRadius(b);b.levels.sort(function(a,b){return a.minScreenSpaceRadius-b.minScreenSpaceRadius});b.levels[0].minScreenSpaceRadius=Math.min(2,b.levels[0].minScreenSpaceRadius);c._lodResources=b;var d=c._context,e=c._getExternalColorParameters(c.symbolLayer.material),Z=c._getMaterialOpacity(),k=c._isPropertyDriven("opacity"),
b=q.materialsFromLodResources(c._lodResources);c._originalOpacities=b.map(function(a){return a.getParameters().opacity||1});b.forEach(function(a){var b=a.getParameters();a.setParameterValues(e);var c=b.opacity*Z;a.setParameterValues({opacity:c,transparent:1>c||k||b.transparent});d.screenSizePerspectiveEnabled&&a.setParameterValues({screenSizePerspective:d.sharedResources.screenSizePerspectiveSettings})});c._resourceBoundingBox=a.referenceBoundingBox;c._resourceSize=h.vec3f64.fromArray(f.size(c._resourceBoundingBox));
c._pivotOffset=h.vec3f64.fromArray(c._lodResources.levels[0].pivotOffset);c._symbolSize=h.vec3f64.fromArray(m.computeSizeWithResourceSize(c._resourceSize,c.symbolLayer));n.updateFastSymbolUpdatesState(c._fastUpdates,c._context.renderer,c._fastVisualVariableConvertOptions())&&b.forEach(function(a){return a.setParameterValues(c._fastUpdates.materialParameters)});c.finalizeSymbolResources();c.initializeLodRenderer();c.complexity=c.computeComplexity();c.resolve()}},function(a){c._symbolLoaderPromise=
null;if(!c.isFulfilled()){if(!(a instanceof O)){var b="ObjectSymbol3DLayer failed to load";a&&a.message&&(b+=" ("+a.message+")");c._logWarning(b)}c.reject()}})};e.prototype.finalizeSymbolResources=function(){var b=this._context.stage;this._materials=q.materialsFromLodResources(this._lodResources);this._materials.forEach(function(a){b.add(p.ModelContentType.MATERIAL,a)});this._textures=q.texturesFromLodResources(this._lodResources);this._textures.forEach(function(a){b.add(p.ModelContentType.TEXTURE,
a)});this._geometries=q.geometriesFromLodResources(this._lodResources);this._geometries.forEach(function(a){b.add(p.ModelContentType.GEOMETRY,a)})};e.prototype.initializeLodRenderer=function(){var b=this,a=this._context.stage;this._lodRenderer=new X.LodRenderer(this._lodResources,this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:function(a){return b._instanceIndexToGraphicUid.get(a)}},this._fastUpdates.enabled?{applyTransform:function(a,d,e){a.getFeatureAttribute(d,y);v.mat4.copy(e,
n.evaluateModelTransform(b._fastUpdates.materialParameters,y,e))},scaleFactor:function(a,d,e){d.getFeatureAttribute(e,y);return n.evaluateModelTransformScale(a,b._fastUpdates.materialParameters,y)}}:null);this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;a.addRenderPlugin(this._lodRenderer.slots,this._lodRenderer)};e.prototype._getExternalColorParameters=function(b){var a={};this._isPropertyDriven("color")?a.externalColor=u:b&&b.color?a.externalColor=C.toUnitRGBA(b.color):(a.externalColor=
u,a.colorMixMode="ignore");return a};e.prototype.destroy=function(){w.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var b=this._context.stage;this._lodRenderer&&(b.removeRenderPlugin(this._lodRenderer),this._lodRenderer.destroy());this._materials&&this._materials.forEach(function(a){return b.remove(p.ModelContentType.MATERIAL,a.id)});this._textures&&this._textures.forEach(function(a){return b.remove(p.ModelContentType.TEXTURE,
a.id)});this._geometries&&this._geometries.forEach(function(a){return b.remove(p.ModelContentType.GEOMETRY,a.id)})};e.prototype.createGraphics3DGraphic=function(b){var a=b.graphic;if(!this._validateGeometry(a.geometry))return null;var c=l.placePointOnGeometry(a.geometry);if(!c)return this._logWarning("unsupported geometry type for icon symbol: "+a.geometry.type),null;var d=this.getGraphicElevationContext(a);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid)};e.prototype.notifyDestroyGraphicLayer=
function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};e.prototype.graphicLayerToGraphicId=function(b){return 0};e.prototype.layerOpacityChanged=function(){var b=this,a=this._isPropertyDriven("opacity");this._materials.forEach(function(c,d){d=b._getMaterialOpacity()*b._originalOpacities[d];c.setParameterValues({opacity:d,transparent:1>d||a})});return!0};e.prototype.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,l.needsElevationUpdates3D)};
e.prototype.slicePlaneEnabledChanged=function(b,a){var c=this;this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;this._materials.forEach(function(a){a.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});return!0};e.prototype.pixelRatioChanged=function(b,a){return!0};e.prototype.applyRendererDiff=function(b,a){var c=this,d;for(d in b.diff)switch(d){case "visualVariables":if(n.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions()))this._materials.forEach(function(a){return a.setParameterValues(c._fastUpdates.materialParameters)}),
this._lodRenderer.notifyShaderTransformationChanged();else return!1;break;default:return!1}return!0};e.prototype.computeComplexity=function(){if(!this._lodResources)return w.prototype.computeComplexity.call(this);var b=q.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(a,b){return a+b.data.getIndices(W.VertexAttrConstants.POSITION).length},0)/3,a=V.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,
memory:a}};e.prototype._createAs3DShape=function(b,a,c,d,e){b=this.getFastUpdateAttrValues(b);var r=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?m.mixinColorAndOpacity(c.color,c.opacity):null,k=this._context.clippingExtent;L.pointToVector(a,t,this._context.elevationProvider.spatialReference);if(k&&!l.pointInBox2D(t,k))return null;var k=this._requiresTerrainElevation(d),h=this._computeGlobalTransform(a,d,E,k?z:null);c=this._computeLocalTransform(this.symbolLayer,c,M);var g=this._lodRenderer.instanceData,
f=g.addInstance();this._instanceIndexToGraphicUid.set(f,e);g.setLocalTransform(f,c,!1);g.setGlobalTransform(f,h);b&&g.setFeatureAttribute(f,b);r&&g.setColor(f,r);e=new S(this,f,R.perLodInstanceElevationAligner,d);k&&(e.alignedTerrainElevation=z.terrainElevation);e.needsElevationUpdates=l.needsElevationUpdates3D(d.mode);l.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);return e};e.prototype._computeGlobalTransform=function(b,a,c,d){a=l.computeElevation(this._context.elevationProvider,
b,a,this._context.renderCoordsHelper,d);t[0]=b.x;t[1]=b.y;t[2]=a;L.computeLinearTransformation(b.spatialReference,t,c,this._context.renderSpatialReference);return c};e.prototype._computeLocalTransform=function(b,a,c){v.mat4.identity(c);this._applyObjectRotation(a,!1,c);this._applyObjectRotation(b,!0,c);this._applyObjectScale(a,c);this._applyAnchor(b,c);return c};e.prototype._applyObjectScale=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._isPropertyDriven("size")&&
b.size?b.size:this._symbolSize,b=m.computeObjectScale(b,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||v.mat4.scale(a,a,b))};e.prototype.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}};e.prototype.updateGeometry=function(b,a){var c=a&&l.placePointOnGeometry(a);if(!c)return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==
a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(c,b.elevationContext,E,a?z:null);a&&(b.alignedTerrainElevation=z.terrainElevation);this._lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,E,!0);l.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0};e.prototype._preparePatchTransform=function(b,a){var c=this;if(a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition){var d=function(a,b,c){return(null!=
a&&"complete"===a.type?a.newValue:b)||c},e=d(a.heading,this.symbolLayer.heading,0),f=d(a.tilt,this.symbolLayer.tilt,0),k=d(a.roll,this.symbolLayer.roll,0),g=d(a.width,this.symbolLayer.width,void 0),l=d(a.height,this.symbolLayer.height,void 0),n=d(a.depth,this.symbolLayer.depth,void 0),p=d(a.anchor,this.symbolLayer.anchor,void 0),d=d(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;
var q={heading:e,tilt:f,roll:k,anchor:p,anchorPosition:d};this.isResolved()&&b.symbolLayerStatePatches.push(function(){c._symbolSize=h.vec3f64.fromArray(m.computeSizeWithResourceSize(c._resourceSize,{width:g,height:l,depth:n,isPrimitive:c.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push(function(a,b){b=c._computeLocalTransform(q,b,M);c._lodRenderer.instanceData.setLocalTransform(a.instanceIndex,b,!0)})}};e.prototype._preparePatchColor=function(b,a){var c=this;if(a.material&&"partial"===
a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type)){var d=a.color.newValue,e=d?C.toUnitRGBA(d):u;delete a.color;b.graphics3DGraphicPatches.push(function(a,b){if(c._hasPerInstanceColor())c._lodRenderer.instanceData.setColor(a.instanceIndex,e);else for(a=0,b=c._materials;a<b.length;a++)b[a].setParameterValues({externalColor:e})})}};e.prototype._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};e.prototype._applyObjectRotation=function(b,a,c){if(!(this._fastUpdates.enabled&&
this._fastUpdates.requiresShaderTransformation&&a))return m.computeObjectRotation(b.heading,b.tilt,b.roll,c)};e.prototype._computeAnchor=function(b){var a=h.vec3f64.create();switch(b.anchor){case "center":g.vec3.copy(a,f.center(this._resourceBoundingBox));g.vec3.negate(a,a);break;case "top":var c=f.center(this._resourceBoundingBox);g.vec3.set(a,-c[0],-c[1],-this._resourceBoundingBox[5]);break;case "bottom":c=f.center(this._resourceBoundingBox);g.vec3.set(a,-c[0],-c[1],-this._resourceBoundingBox[2]);
break;case "relative":var c=f.center(this._resourceBoundingBox),d=f.size(this._resourceBoundingBox);b=(b=b.anchorPosition)?h.vec3f64.fromValues(b.x,b.y,b.z):F;g.vec3.multiply(a,d,b);g.vec3.add(a,a,c);g.vec3.negate(a,a);break;default:this._pivotOffset?g.vec3.negate(a,this._pivotOffset):g.vec3.copy(a,F)}return a};e.prototype._applyAnchor=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b))&&v.mat4.translate(a,a,b)};e.prototype._hasPerInstanceColor=
function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};e.prototype._fastVisualVariableConvertOptions=function(){var b=this._resourceBoundingBox?h.vec3f64.fromArray(f.size(this._resourceBoundingBox)):x,a=this._resourceBoundingBox?this._computeAnchor(this.symbolLayer):F,c=this._context.renderCoordsHelper.unitInMeters,d=m.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,c),e=h.vec3f64.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||
0);return{modelSize:b,symbolSize:this._symbolSize||x,unitInMeters:c,transformation:{anchor:a,scale:d,rotation:e}}};return e}(T.default);B.Graphics3DObjectSymbolLayer=A;var x=h.vec3f64.fromValues(1,1,1),u=J.vec4f64.fromValues(1,1,1,1),F=h.vec3f64.fromValues(0,0,0),t=h.vec3f64.create(),M=I.mat4f64.create(),E=I.mat4f64.create(),y=J.vec4f64.create(),z={verticalDistanceToGround:0,terrainElevation:0};B.default=A});