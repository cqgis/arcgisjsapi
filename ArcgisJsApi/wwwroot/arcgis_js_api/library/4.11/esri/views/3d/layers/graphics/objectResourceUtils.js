// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../core/lang ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../glTF/DefaultLoadingContext ../../glTF/esriProvidedModelParameters ../../glTF/loader ../../glTF/internal/indexUtils ./wosrLoader ../../support/mathUtils ../../support/buffer/BufferView ../../support/buffer/math ../../support/buffer/utils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ba,z,ca,N,O,D,P,h,B,J,w,C,G,Q,E,R,H,S,T,n,x,r,U,V,K,L){function M(a){var d=a.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return d?{fileType:"gltf",url:d[1],specifiedLodIndex:null!=d[4]?Number(d[4]):null}:a.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:a,specifiedLodIndex:null}:{fileType:"unknown",url:a,specifiedLodIndex:null}}function F(a,d,c){var k=a.model,m=J.mat4f64.create(),f=[],I=new Map,p=new Map;k.lods.forEach(function(a,g){if(void 0===c||g===c){var y=0,t={stageResources:{textures:[],
materials:[],geometries:[]},lodThreshold:h.isSome(a.lodThreshold)?a.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:G.empty()};f.push(t);a.parts.forEach(function(b){var c=b.material+(b.attributes.normal?"_normal":"")+(b.attributes.color?"_color":"")+(b.attributes.texCoord0?"_texCoord0":"")+(b.attributes.tangent?"_tangent":""),e=k.materials.get(b.material),f=h.isSome(b.attributes.texCoord0),g=h.isSome(b.attributes.normal);if(!I.has(c)){if(h.isSome(e.textureColor)&&f&&!p.has(e.textureColor)){var q=
k.textures.get(e.textureColor),u=D({},q.parameters,{preMultiplyAlpha:!0});p.set(e.textureColor,new K(q.data,e.textureColor,u))}h.isSome(e.textureNormal)&&f&&!p.has(e.textureNormal)&&(q=k.textures.get(e.textureNormal),u=D({},q.parameters,{preMultiplyAlpha:!0}),p.set(e.textureNormal,new K(q.data,e.textureNormal,u)));var v=L.COLOR_GAMMA,q=Math.pow(e.color[0],1/v),u=Math.pow(e.color[1],1/v),v=Math.pow(e.color[2],1/v);I.set(c,new L(D({transparent:"BLEND"===e.alphaMode,textureAlphaMode:W(e.alphaMode),textureAlphaCutoff:e.alphaCutoff,
diffuse:[q,u,v],ambient:[q,u,v],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",vertexColors:!!b.attributes.color,vertexTangents:!!b.attributes.tangent,normals:g?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:h.isSome(e.textureColor)&&f?p.get(e.textureColor).id:void 0,colorMixMode:e.colorMixMode,normalTextureId:h.isSome(e.textureNormal)&&f?p.get(e.textureNormal).id:void 0,textureAlphaPremultiplied:!0},d),c))}a:{g=b.indices||b.attributes.position.count;
switch(b.primitiveType){case 4:q=H.trianglesToTriangles(g);break a;case 5:q=H.triangleStripToTriangles(g);break a;case 6:q=H.triangleFanToTriangles(g);break a}q=void 0}var u={},v={},g=b.attributes.position.count,l=r.createBuffer(n.BufferViewVec3f,g);x.vec3.transformMat4(l,b.attributes.position,b.transform);v.position={data:l.typedBuffer,size:l.elementCount};u.position=q;h.isSome(b.attributes.normal)&&(l=r.createBuffer(n.BufferViewVec3f,g),B.mat4.invert(m,b.transform),B.mat4.transpose(m,m),x.vec3.transformMat4(l,
b.attributes.normal,m),v.normal={data:l.typedBuffer,size:l.elementCount},u.normal=q);h.isSome(b.attributes.tangent)&&(l=r.createBuffer(n.BufferViewVec4f,g),B.mat4.invert(m,b.transform),B.mat4.transpose(m,m),x.vec4.transformMat4(l,b.attributes.tangent,m),v.aTangent={data:l.typedBuffer,size:l.elementCount},u.aTangent=q);h.isSome(b.attributes.texCoord0)&&(l=r.createBuffer(n.BufferViewVec2f,g),r.vec2.normalizeIntegerBuffer(l,b.attributes.texCoord0),v.uv0={data:l.typedBuffer,size:l.elementCount},u.uv0=
q);if(h.isSome(b.attributes.color)){l=r.createBuffer(n.BufferViewVec4u8,g);if(4===b.attributes.color.elementCount)b.attributes.color instanceof n.BufferViewVec4f?x.vec4.scale(l,b.attributes.color,255):b.attributes.color instanceof n.BufferViewVec4u8?r.vec4.copy(l,b.attributes.color):b.attributes.color instanceof n.BufferViewVec4u16&&x.vec4.scale(l,b.attributes.color,1/256);else{r.vec4.fill(l,255,255,255,255);var w=new n.BufferViewVec3u8(l.buffer,0,4);b.attributes.color instanceof n.BufferViewVec3f?
x.vec3.scale(w,b.attributes.color,255):b.attributes.color instanceof n.BufferViewVec3u8?r.vec3.copy(w,b.attributes.color):b.attributes.color instanceof n.BufferViewVec3u16&&x.vec3.scale(w,b.attributes.color,1/256)}v.color={data:l.typedBuffer,size:l.elementCount};u.color=q}b=new U(new V(v,u),"gltf_"+a.name+"_"+y++);t.stageResources.geometries.push(b);t.stageResources.materials.push(I.get(c));h.isSome(e.textureColor)&&f&&t.stageResources.textures.push(p.get(e.textureColor));h.isSome(e.textureNormal)&&
f&&t.stageResources.textures.push(p.get(e.textureNormal));t.numberOfVertices+=g;c=b.boundingInfo;G.expand(t.boundingBox,c.getBBMin());G.expand(t.boundingBox,c.getBBMax())})}});return f}function W(a){switch(a){case "BLEND":return"blend";case "MASK":return"mask";case "OPAQUE":return"opaque";default:return"blend"}}function X(a,d){void 0===a&&(a="");void 0===d&&(d="");var c=P.endsWith(a,"Imposter");a=a.split("__")[0];if(-1!==d.indexOf("/RealisticTrees/")&&(d=E.treeParamsTable[a]))return{crownCenter:d.center,
crownDimensions:d.radius,imposter:c}}function Y(a){a.meta.isEsriSymbolResource&&a.model.lods.forEach(function(d){var c=X(d.name,a.meta.uri);c&&(a.customMeta.esriTreeRendering=!0,d.parts.forEach(function(a){var d=a.attributes.normal,f=a.attributes.position,k=f.count;if(!h.isNone(d)){for(var p=C.vec3f64.create(),x=C.vec3f64.create(),g=C.vec3f64.create(),y=r.createBuffer(n.BufferViewVec4u8,k),t=r.createBuffer(n.BufferViewVec3f,k),b=B.mat4.invert(J.mat4f64.create(),a.transform),z=w.vec3.transformMat4(C.vec3f64.create(),
c.crownCenter,b),b=w.vec3.transformMat4(C.vec3f64.create(),c.crownDimensions,b),e=0;e<k;e++){f.getVec(e,x);d.getVec(e,p);w.vec3.subtract(g,x,z);w.vec3.divide(g,g,b);var A=T.clamp(w.vec3.length(g),0,1),A=.6+.4*A*A;w.vec3.lerp(g,g,p,.2);t.setVec(e,g);y.set(e,0,255*A);y.set(e,1,255*A);y.set(e,2,255*A);y.set(e,3,255)}a.attributes.normal=t;a.attributes.color=y}}))})}function Z(a){var d=a.model.lods.length;a.meta.isEsriSymbolResource&&a.model.lods.forEach(function(a){if(!h.isSome(a.lodThreshold)){var c=
(a.name||"").split("__")[0],m=a.parts.reduce(function(a,c){return a+c.attributes.position.count},0);a.lodThreshold=aa(c,m,d)}})}function aa(a,d,c){void 0===a&&(a="");if(1===c)return null;if(a in E.lodThresholdLUT){c=E.lodThresholdLUT[a].vertexCounts;a=E.lodThresholdLUT[a].thresholds;var k=c.length;if(1>=k)return null;if(d<=c[0]){var m=(c[1]-c[0])/(a[1]-a[0]);d-=c[0];return Math.max(0,a[0]+d*m)}if(d>=c[k-1])return m=(c[k-1]-c[k-2])/(a[k-1]-a[k-2]),d-=c[k-1],a[k-1]+d*m;for(var f=1;f<c.length;++f){var h=
c[f-1],p=c[f],k=a[f-1],m=a[f];if(d<p)return d=(d-h)/(p-h),k*(1-d)+m*d}}return null}Object.defineProperty(z,"__esModule",{value:!0});z.fetch=function(a,d){void 0===d&&(d={});return O(this,void 0,void 0,function(){var c,k,m,f,h,p,n,g,r,t;return N(this,function(b){switch(b.label){case 0:return c=M(a),"wosr"!==c.fileType?[3,2]:[4,S.load(c.url,d)];case 1:return k=b.sent(),[2,{lods:[k],referenceBoundingBox:k.boundingBox}];case 2:return m=new Q.DefaultLoadingContext(d.streamDataSupplier),[4,R.load(m,c.url,
d)];case 3:f=b.sent();Y(f);Z(f);h=D({},d.materialParamsMixin,{treeRendering:f.customMeta.esriTreeRendering});if(null!=c.specifiedLodIndex)return p=F(f,h,c.specifiedLodIndex),n=p[0].boundingBox,0!==c.specifiedLodIndex&&(g=F(f,h,c.specifiedLodIndex),n=g[0].boundingBox),[2,{lods:p,referenceBoundingBox:n}];r=F(f,h);t=r[0].boundingBox;return[2,{lods:r,referenceBoundingBox:t}]}})})};z.parseUrl=M;z.gltfToEngineResources=F});