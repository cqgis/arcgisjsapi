// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Graphic ../../../core/Collection ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ./BuildingComponentSublayerView3D ./BuildingGroupSublayerView3D ./LayerView3D ./i3s/I3SUtil ./support/layerViewUpdatingProperties".split(" "),
function(E,F,G,r,f,t,u,n,k,v,l,w,p,e,x,y,z,A,B,C){var q=v.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D");return function(m){function c(){var a=null!==m&&m.apply(this,arguments)||this;a.componentLayerViews=new k;a.groupLayerViews=new k;a._componentPromises=[];a._loadingComponents=0;return a}r(c,m);Object.defineProperty(c.prototype,"parsedFilterExpression",{get:function(){var a=this.layer.activeFilterId,b=null!=a?this.layer.filters.find(function(b){return b.id===a}):null;if(b=null!=b?b.filterBlocks.find(function(a){return"solid"===
a.filterMode.type}):null)try{var d=x.create(b.filterExpression);return d.isStandardized()?d:(q.error("filterExpression is using non standard function"),null)}catch(D){q.error("Failed to parse filterExpression: "+D)}return null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updatingPercentageValue",{get:function(){var a=this.componentLayerViews,b=this._loadingComponents,d=b+a.length;return a.reduce(function(a,b){return a+b.updatingPercentage},100*b)/d},enumerable:!0,configurable:!0});
c.prototype.isUpdating=function(){return 0<this._loadingComponents||this.componentLayerViews.some(function(a){return a.updating})};c.prototype.initialize=function(){B.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode);this.initializeSubLayerViews(this.layer.sublayers,this)};c.prototype.destroy=function(){this.groupLayerViews&&(this.groupLayerViews.forEach(function(a){return a.destroy()}),this.groupLayerViews=null);this.componentLayerViews&&(this.componentLayerViews.forEach(function(a){return a.destroy()}),
this.componentLayerViews=null);this._componentPromises&&(this._componentPromises.forEach(function(a){return a.cancel()}),this._componentPromises=null)};c.prototype.initializeSubLayerViews=function(a,b){var d=this,c=this,e=this.view;a.forEach(function(a){if("building-group"===a.type){var g=new z({layer:a,view:e,parent:b});d.groupLayerViews.push(g);d.initializeSubLayerViews(a.sublayers,g)}else d._loadingComponents++,g=a.load().then(function(){d._loadingComponents--;var g=new y({layer:a,layerView:c,
view:e,parent:b});d.componentLayerViews.push(g);d.handles.add([p.init(g,"updating",function(){return d.notifyChange("updating")}),p.init(g,"updatingPercentage",function(){return d.notifyChange("updatingPercentageValue")})]);return g.when()}),d._componentPromises.push(g)})};c.prototype.getGraphicFromStageObject=function(a,b){var d=this.componentLayerViews.find(function(b){return b.hasStageObject(a)});return d?d.getGraphicFromStageObject(a,b):null};c.prototype.fetchPopupFeatures=function(a,b){return u(this,
void 0,void 0,function(){var d;return t(this,function(c){if(!l.isSome(b)||!b.clientGraphics||0===b.clientGraphics.length)return[2];d=this._findComponent(b.clientGraphics[0].sourceLayer);return l.isNone(d)?[2]:[2,d.fetchPopupFeatures(a,b)]})})};c.prototype.whenGraphicBounds=function(a){var b=this._findComponent(a.sourceLayer);return l.isNone(b)?w.reject():b.whenGraphicBounds(a)};c.prototype._findComponent=function(a){return this.componentLayerViews.find(function(b){return a===b.layer})};c.prototype.highlight=
function(a,b){void 0===b&&(b={});a instanceof n?a=[a]:a instanceof k&&(a=a.toArray());var c=[];if(Array.isArray(a)&&0<a.length&&a[0]instanceof n){var e=new Map;for(b=0;b<a.length;b++){var f=a[b],h=e.get(f.sourceLayer);null==h&&(h=[],e.set(f.sourceLayer,h));h.push(f)}this.componentLayerViews.forEach(function(a){var b=e.get(a.layer);b&&c.push(a.highlight(b))})}return{remove:function(){return c.forEach(function(a){return a.remove()})},pause:function(){return c.forEach(function(a){return a.pause()})},
resume:function(){return c.forEach(function(a){return a.resume()})}}};c.prototype.getUsedMemory=function(){return this.componentLayerViews.reduce(function(a,b){return a+b.getUsedMemory()},0)};c.prototype.getUnloadedMemory=function(){return this.componentLayerViews.reduce(function(a,b){return a+b.getUnloadedMemory()},0)};c.prototype.ignoresMemoryFactor=function(){return!1};f([e.property()],c.prototype,"layer",void 0);f([e.property()],c.prototype,"componentLayerViews",void 0);f([e.property()],c.prototype,
"groupLayerViews",void 0);f([e.property({readOnly:!0,dependsOn:["layer.filters","layer.activeFilterId"]})],c.prototype,"parsedFilterExpression",null);f([e.property(C.updatingPercentage)],c.prototype,"updatingPercentage",void 0);f([e.property({readOnly:!0})],c.prototype,"updatingPercentageValue",null);return c=f([e.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],c)}(e.declared(A))});