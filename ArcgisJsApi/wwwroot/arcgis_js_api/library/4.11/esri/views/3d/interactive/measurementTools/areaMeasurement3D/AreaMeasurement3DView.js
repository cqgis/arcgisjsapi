// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/Handles ../../../../../core/screenUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../directLineMeasurement3D/LaserLineRenderer ../support/Label ../support/LabelSegment ../support/labelUtils ../support/PathSegmentInterpolator ../support/viewUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryData ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Intersector ../../../webgl-engine/lib/Layer ../../../webgl-engine/lib/Object3D ../../../webgl-engine/materials/CheckerBoardMaterial ../../../webgl-engine/materials/DefaultMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/parts/Model".split(" "),
function(t,Q,R,S,H,A,E,F,B,n,I,p,u,v,G,m,w,C,J,D,K,L,q,M,N,r,e){var O={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,pathLineColor:[1,.5,0,1],pathLineWidth:3,intersectingLineColor:[1,.2,0,1],perimeterLineColor:[1,.5,0,1],perimeterLineWidth:2,projectionLineColor:[1,.5,0,1],projectionLineWidth:2,
projectionLineStippleSize:5,areaColor1:[1,.5,0,.5],areaColor2:[1,1,1,.5],fillColor:[1,.5,0,.5],lineSubdivisions:64,labelDistance:25};t=function(){function d(a,b){void 0===b&&(b={});this._model=a;this._visible=!1;this._laserLineRenderer=null;this._pathSegmentObjects=[];this._perimeterSegmentObjects=[];this._vertexHandleObjects=[];this._projectionLineObjects=[];this._areaLabel=new p(16);this._pathLengthLabel=new p(12);this._cursorSegmentLengthLabel=new p(12);this._perimeterLengthLabel=new p(12);this._pathLabelSegments=
[];this._perimeterLabelSegments=[];this._cursorSegmentLengthLabelSegment=new u;this._listenerHandles=null;this._origin=n.vec3f64.create();this._originTransform=F.mat4f64.create();this._tempStartPosition=n.vec3f64.create();this._tempEndPosition=n.vec3f64.create();this._tempHandlePosition=n.vec3f64.create();this._tempMat4=F.mat4f64.create();this._sceneView=this._model.sceneView;this._params=m.copyParameter(O,b);this._layer=new L("path-measurement-tool",{isPickable:!1});this._createMaterials();this._createObjects();
this._intersector=new K(this._sceneView.viewingMode)}d.prototype.destroy=function(){this.hide()};Object.defineProperty(d.prototype,"requiresCursorPoint",{get:function(){return("initial"===this._model.state||"drawing"===this._model.state)&&this._model.active},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"visible",{get:function(){return this._visible},set:function(a){a?this.show():this.hide()},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"testData",{get:function(){return{labels:{area:this._areaLabel,
pathLength:this._pathLengthLabel,cursorSegmentLength:this._cursorSegmentLengthLabel,perimeterLength:this._perimeterLengthLabel},laserLineRenderer:this._laserLineRenderer}},enumerable:!0,configurable:!0});d.prototype.show=function(){if(!this._visible){this._visible=!0;var a=this._sceneView._stage;this._laserLineRenderer=new I(this._sceneView.renderCoordsHelper,{glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,
globalAlpha:this._params.laserLineGlobalAlpha});a.addRenderPlugin(this._laserLineRenderer.renderSlots,this._laserLineRenderer);this._addToStage(a);this._areaLabel.addToView(this._sceneView);this._pathLengthLabel.addToView(this._sceneView);this._cursorSegmentLengthLabel.addToView(this._sceneView);this._perimeterLengthLabel.addToView(this._sceneView);this._initializeListeners();this._updateAll(this._model.viewData)}};d.prototype.hide=function(){if(this._visible){this._visible=!1;var a=this._sceneView._stage;
a.removeRenderPlugin(this._laserLineRenderer);this._laserLineRenderer=null;this._destroyListeners();this._updatePathLength(0);this._removeFromStage(a);this._areaLabel.removeFromView(this._sceneView);this._pathLengthLabel.removeFromView(this._sceneView);this._cursorSegmentLengthLabel.removeFromView(this._sceneView);this._perimeterLengthLabel.removeFromView(this._sceneView);this._sceneView.cursor=null}};d.prototype.vertexHandleAt=function(a,b){a=A.screenPointObjectToArray(a);b="touch"===b?this._params.handleRadiusTouch:
this._params.handleRadiusMouse;for(var c=this._model.path,f=0;f<c.length;++f)if(m.pointToScreenPositionDistance(c.vertex(f),a,this._sceneView)<b)return f;return null};d.prototype.pick=function(a){var b=this._sceneView.spatialReference;a=A.screenPointObjectToArray(a.screenPoint);a=this._sceneView.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector).results.min;var c=n.vec3f64.create();if(!a.getIntersectionPoint(c))return new d.PickResult;b=this._sceneView.renderCoordsHelper.fromRenderCoords(c,
b);return new d.PickResult("TerrainRenderer"===a.intersector?"surface":"feature",c,b)};d.prototype.overlappingHandles=function(a,b){return m.pointToPointScreenDistance(a,b,this._sceneView)<=this._params.handleRadius};d.prototype.overlapsAnyHandles=function(a,b){void 0===b&&(b=[]);for(var c=this._model.path,f=0;f<c.length;++f)if(!(0<=b.indexOf(f))&&this.overlappingHandles(a,c.vertex(f)))return!0;return!1};d.prototype._createMaterials=function(){var a=1!==this._params.handleOpacity;this._handleMaterial=
new N({diffuse:this._params.handleColor,transparent:a,writeDepth:!a,cullFace:"back",opacity:this._params.handleOpacity,castShadows:!1},"handle");this._handleMaterial.renderOccluded=4;this._pathLineMaterial=new r({width:this._params.pathLineWidth,color:this._params.pathLineColor,polygonOffset:!0},"path-line");this._pathLineMaterial.renderOccluded=4;this._intersectingPathLineMaterial=new r({width:this._params.pathLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0},"intersecting-path-line");
this._intersectingPathLineMaterial.renderOccluded=4;this._perimeterLineMaterial=new r({width:this._params.perimeterLineWidth,color:this._params.perimeterLineColor,polygonOffset:!0},"perimeter-line");this._perimeterLineMaterial.renderOccluded=4;this._intersectingPerimeterLineMaterial=new r({width:this._params.perimeterLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0},"intersecting-perimeter-line");this._intersectingPerimeterLineMaterial.renderOccluded=4;this._projectionLineMaterial=
new r({width:this._params.projectionLineWidth,color:this._params.projectionLineColor,polygonOffset:!0,stippleLength:0},"projection-line");this._projectionLineMaterial.renderOccluded=4;this._checkerBoardMaterial=new M({color1:this._params.areaColor1,color2:this._params.areaColor2,transparent:!0,writeDepth:!1,polygonOffset:!0},"checker-board");this._checkerBoardMaterial.renderOccluded=4};d.prototype._createObjects=function(){this._cursorHandleObject=new q;this._cursorSegmentObject=new q;this._areaObject=
new q};d.prototype._addToStage=function(a){a.add(e.ContentType.LAYER,this._layer);a.add(e.ContentType.MATERIAL,this._handleMaterial);a.add(e.ContentType.MATERIAL,this._pathLineMaterial);a.add(e.ContentType.MATERIAL,this._intersectingPathLineMaterial);a.add(e.ContentType.MATERIAL,this._perimeterLineMaterial);a.add(e.ContentType.MATERIAL,this._intersectingPerimeterLineMaterial);a.add(e.ContentType.MATERIAL,this._projectionLineMaterial);a.add(e.ContentType.MATERIAL,this._checkerBoardMaterial);a.addToViewContent([this._layer.id])};
d.prototype._removeFromStage=function(a){a.removeFromViewContent([this._layer.id]);a.remove(e.ContentType.LAYER,this._layer.id);a.remove(e.ContentType.MATERIAL,this._handleMaterial.id);a.remove(e.ContentType.MATERIAL,this._pathLineMaterial.id);a.remove(e.ContentType.MATERIAL,this._intersectingPathLineMaterial.id);a.remove(e.ContentType.MATERIAL,this._perimeterLineMaterial.id);a.remove(e.ContentType.MATERIAL,this._intersectingPerimeterLineMaterial.id);a.remove(e.ContentType.MATERIAL,this._projectionLineMaterial.id);
a.remove(e.ContentType.MATERIAL,this._checkerBoardMaterial.id)};d.prototype._syncViewData=function(a){var b=this;if(!this._visible)return"none";var c=a.pathChanges;"full"===c.change?this._updateAll(a):"incremental"===c.change&&(c.updatedVertices.forEach(function(c){var f=(c-1+b._model.path.length)%b._model.path.length;b._updatePathSegment(a,c);b._updatePathSegment(a,f);b._updateVertexHandle(a,c);b._updateArea(a);b._updatePerimeterSegments(a);b._updateProjectionLines(a);b._updateLaserLine();b._updateLabels(a)}),
c.updatedVertices.has(this._model.path.length-1)&&this._updateCursorSegment(a));var f=c.change;c.clear();return f};d.prototype._updateAfterSyncViewData=function(a){var b=this._model.viewData;"full"!==this._syncViewData(b)&&a&&a(b)};d.prototype._updateOrigin=function(a){m.midpoint(a.positionsRenderCoords,this._origin);E.mat4.identity(this._originTransform);E.mat4.translate(this._originTransform,this._originTransform,this._origin)};d.prototype._updateAll=function(a){this._updateOrigin(a);this._updatePathLength(a.path.length);
this._updatePathSegments(a);this._updatePerimeterSegments(a);this._updateHandles(a);this._updateArea(a);this._updateProjectionLines(a);this._updateLabels(a);this._updateLaserLine()};d.prototype._updateCameraDependent=function(a){this._updateHandles(a);this._updateProjectionLines(a);this._updateLabels(a)};d.prototype._updatePathLength=function(a){this._resizeObject3DArray(this._pathSegmentObjects,a);this._resizeObject3DArray(this._perimeterSegmentObjects,a);this._resizeObject3DArray(this._vertexHandleObjects,
a);m.resizeArray(this._pathLabelSegments,a,function(){return new u});m.resizeArray(this._perimeterLabelSegments,a,function(){return new u})};d.prototype._updatePathSegments=function(a){for(var b=0;b<this._pathSegmentObjects.length;++b)this._updatePathSegment(a,b);this._updateCursorSegment(a)};d.prototype._updatePathSegment=function(a,b){var c=a.path,f=this._pathSegmentObjects[b];a.validMeasurement||b<c.length-1?(this._createInterpolatedLineGeometry(f,a.intersectingSegments.has(b)?this._intersectingPathLineMaterial:
this._pathLineMaterial,"path-segment",a.positionsRenderCoords[b],a.positionsRenderCoords[(b+1)%c.length],this._origin,this._originTransform,this._model.measurementMode,this._pathLabelSegments[b],a.validMeasurement?"center":"end"),this._addObject3D(f)):(f.removeAllGeometries(),this._removeObject3D(f))};d.prototype._updateCursorSegment=function(a){a=this._sceneView.renderCoordsHelper;var b=this._model.path,c=this._cursorSegmentObject;0<b.length&&"drawing"===this._model.state&&this._model.cursorPoint?
(a.toRenderCoords(b.back,this._tempStartPosition),a.toRenderCoords(this._model.cursorPoint,this._tempEndPosition),this._createInterpolatedLineGeometry(c,this._pathLineMaterial,"path-segment",this._tempStartPosition,this._tempEndPosition,this._origin,this._originTransform,this._model.measurementMode,this._cursorSegmentLengthLabelSegment,"end"),this._addObject3D(c)):(c.removeAllGeometries(),this._removeObject3D(c))};d.prototype._updatePerimeterSegments=function(a){for(var b=0;b<this._perimeterSegmentObjects.length;++b)this._updatePerimeterSegment(a,
b)};d.prototype._updatePerimeterSegment=function(a,b){var c=a.path,f=this._perimeterSegmentObjects[b];a.validMeasurement&&"geodesic"!==this._model.measurementMode?(this._updatePerimeterSegmentObject(f,a.positionsFittedRenderCoords[b],a.positionsFittedRenderCoords[(b+1)%c.length],this._origin,this._originTransform,a.intersectingSegments.has(b),this._perimeterLabelSegments[b]),this._addObject3D(f)):(f.removeAllGeometries(),this._removeObject3D(f))};d.prototype._updatePerimeterSegmentObject=function(a,
b,c,f,d,e,k){this._createInterpolatedLineGeometry(a,e?this._intersectingPerimeterLineMaterial:this._perimeterLineMaterial,"perimeter-segment",b,c,f,d,this._model.measurementMode,k)};d.prototype._updateHandles=function(a){for(var b=0;b<this._vertexHandleObjects.length;++b)this._updateVertexHandle(a,b);this._updateCursorHandle(a)};d.prototype._updateVertexHandle=function(a,b){var c=this._sceneView._stage.getCamera(),f=this._vertexHandleObjects[b];this._updateHandleObject(f,a.positionsRenderCoords[b],
!0,this._model.hoveredVertexHandle===b,this._model.draggedVertices.includes(b),c);this._addObject3D(f)};d.prototype._updateCursorHandle=function(a){a=this._cursorHandleObject;if("drawing"===this._model.state&&this._model.cursorPoint){var b=this._sceneView._stage.getCamera(),c=this._tempHandlePosition;this._sceneView.renderCoordsHelper.toRenderCoords(this._model.cursorPoint,c);this._updateHandleObject(a,c,!0,!1,!1,b);this._addObject3D(a)}else a.removeAllGeometries(),this._removeObject3D(a)};d.prototype._updateHandleObject=
function(a,b,c,f,P,e){a.removeAllGeometries();c&&!P&&this._model.editable&&(m.scaleTranslateMatrix((f?this._params.handleRadiusHovered:this._params.handleRadius)*e.computeScreenPixelSizeAt(b),b,this._tempMat4),a.addGeometry(d._handleGeometry,this._handleMaterial,this._tempMat4))};d.prototype._updateArea=function(a){switch(this._model.measurementMode){case "euclidean":this._updateAreaEuclidean(a);break;case "geodesic":this._updateAreaGeodesic(a)}};d.prototype._updateAreaEuclidean=function(a){var b=
this,c=this._areaObject;if(a.validMeasurement&&0===a.intersectingSegments.size&&a.triangleIndices){var f=[],d=n.vec3f64.create();a.positionsFittedRenderCoords.forEach(function(a){B.vec3.subtract(d,a,b._origin);f.push(d[0],d[1],d[2])});var e=[];a.positionsProjected.forEach(function(a){e.push(a[0],a[1])});var k=new J({position:{size:3,data:f},uv0:{size:2,data:e}},{position:a.triangleIndices,uv0:a.triangleIndices}),k=new C(k,"area");c.removeAllGeometries();c.addGeometry(k,this._checkerBoardMaterial,
this._originTransform);this._addObject3D(c);this._checkerBoardMaterial.setParameterValues({size:[a.checkerSize,a.checkerSize]})}else c.removeAllGeometries(),this._removeObject3D(c)};d.prototype._updateAreaGeodesic=function(a){a=this._areaObject;a.removeAllGeometries();this._removeObject3D(a)};d.prototype._updateProjectionLines=function(a){var b=a.path;this._resizeObject3DArray(this._projectionLineObjects,b.length);for(var c=0;c<b.length;++c)this._updateProjectionLine(a,c);for(var d=Infinity,c=0;c<
b.length;++c)d=Math.max(this._sceneView._stage.getCamera().computeScreenPixelSizeAt(a.positionsRenderCoords[c])),d=Math.max(this._sceneView._stage.getCamera().computeScreenPixelSizeAt(a.positionsFittedRenderCoords[c]));this._projectionLineMaterial.setParameterValues({stippleLength:this._params.projectionLineStippleSize*d})};d.prototype._updateProjectionLine=function(a,b){var c=this._projectionLineObjects[b];c.removeAllGeometries();if(a.validMeasurement&&"euclidean"===this._model.measurementMode){a=
n.vec3f64.create();B.vec3.subtract(a,this._model.viewData.positionsRenderCoords[b],this._origin);var d=n.vec3f64.create();B.vec3.subtract(d,this._model.viewData.positionsFittedRenderCoords[b],this._origin);b=new C(D.createPolylineGeometry([a,d]),"projected-line");c.addGeometry(b,this._projectionLineMaterial,this._originTransform);this._addObject3D(c)}else this._removeObject3D(c)};d.prototype._updateLabels=function(a){var b=this,c=this._sceneView._stage.getCamera(),d=this._params.labelDistance,e=this._model,
m="geodesic"===e.measurementMode,k="drawing"===e.state,l=function(a,c){return a.visible&&c.visible&&b._sceneView.overlay.overlaps(a.textItem,c.textItem)},g=this._areaLabel,h=v.positionLabelOnPoint(g,a.areaCentroid,c);g.text=e.areaLabel;g.visible=h&&a.validMeasurement&&0===a.intersectingSegments.size&&null!=e.areaLabel;g=this._pathLengthLabel;h=v.positionLabelOnCorner(g,this._pathLabelSegments[a.pathLengthLabelSegmentIndex],this._cursorSegmentLengthLabelSegment,d,c);g.text=e.pathLengthLabel;g.visible=
h&&k&&0<e.path.length;g=this._cursorSegmentLengthLabel;h=this._cursorSegmentLengthLabelSegment;h=v.positionLabelOnSegment(g,h,d,"bottom",c);g.text=e.cursorSegmentLengthLabel;g.visible=h&&k&&e.cursorSegmentLength&&0!==e.cursorSegmentLength.value;l(this._cursorSegmentLengthLabel,this._pathLengthLabel)&&(this._cursorSegmentLengthLabel.visible=!1);l(this._pathLengthLabel,this._areaLabel)&&(this._pathLengthLabel.visible=!1);g=this._perimeterLengthLabel;if(e.validMeasurement&&0===a.intersectingSegments.size)for(k=
0;k<a.path.length;++k)if(h=(a.perimeterLengthLabelSegmentIndex+k)%a.path.length,h=m?this._pathLabelSegments[h]:this._perimeterLabelSegments[h],h=v.positionLabelOnSegment(g,h,d,"top",c),g.text=e.perimeterLengthLabel,g.visible=h,l(g,this._areaLabel))g.visible=!1;else break;else g.visible=!1};d.prototype._lastAddedDraggedVertex=function(){var a=this._model.draggedVertices;return 0<a.length?a.items[a.length-1]:null};d.prototype._getFocusPoint=function(){var a=this._model,b=this._lastAddedDraggedVertex();
switch(a.state){case "drawing":return a.cursorPoint?a.cursorPoint:a.path.vertex(null!=b?b:a.path.length-1);case "editing":return null!=b?a.path.vertex(b):null;default:return a.cursorPoint}};d.prototype._updateLaserLine=function(){var a=this._model,b=this._params.laserLineEnabled&&"measured"!==a.state&&a.active;this._laserLineRenderer.focusSphereActive=!1;this._laserLineRenderer.segmentActive=!1;a=this._getFocusPoint();b&&a?(b=this._tempHandlePosition,this._sceneView.renderCoordsHelper.toRenderCoords(a,
b),this._laserLineRenderer.focusPosition=b,this._laserLineRenderer.focusPlaneActive=!0):this._laserLineRenderer.focusPlaneActive=!1};d.prototype._addObject3D=function(a){a.parentLayer||(this._layer.addObject(a),this._sceneView._stage.add(e.ContentType.OBJECT,a))};d.prototype._removeObject3D=function(a){a.parentLayer&&(this._layer.removeObject(a),this._sceneView._stage.remove(e.ContentType.OBJECT,a.id))};d.prototype._resizeObject3DArray=function(a,b){var c=this;m.resizeArray(a,b,function(){return new q},
function(a){c._removeObject3D(a)})};d.prototype._createInterpolatedLineGeometry=function(a,b,c,d,e,n,k,l,g,h){var f=this._sceneView.renderCoordsHelper,r=[],t=[],p=function(a,b){var c=w.sv3d.get();B.vec3.subtract(c,a,n);r.push(c);t.push(b)};if("euclidean"===l){var x=w.sv3d.get();m.midpoint([d,e],x);l=w.sv3d.get();f.worldUpAtPosition(x,l);p(d,l);p(e,l);g&&g.update(d,e,h)}else{d=this._getSegmentInterpolator(d,e);e=this._params.lineSubdivisions+1&-2;var v=x=null,q=e/2-1,u=e/2;"start"===h?(q=0,u=1):"end"===
h&&(q=e-2,u=e-1);for(var y=0;y<e;++y){var A=y/(e-1),z=w.sv3d.get();l=w.sv3d.get();d.eval(A,z);f.worldUpAtPosition(z,l);y===q&&(x=z);y===u&&(v=z);p(z,l)}g&&g.update(x,v,h)}c=new C(D.createPolylineGeometry(r,t),c);a.removeAllGeometries();a.addGeometry(c,b,k)};d.prototype._getSegmentInterpolator=function(a,b){var c=this._sceneView.spatialReference;return c.isWebMercator||c.isWGS84?(c=this._sceneView.renderCoordsHelper.spatialReference,new G.Spherical(a,b,c,c)):new G.Linear(a,b)};d.prototype._initializeListeners=
function(){var a=this;this._listenerHandles=new H;this._listenerHandles.add([this._model.watch("state",function(){return a._updateLaserLine()}),this._model.draggedVertices.on("change",function(){return a._updateLaserLine()}),this._model.watch("hoveredVertexHandle",function(){return a._updateAfterSyncViewData(function(b){return a._updateHandles(b)})}),this._model.draggedVertices.on("change",function(){return a._updateAfterSyncViewData(function(b){return a._updateHandles(a._model.viewData)})}),this._model.watch("cursorPoint",
function(){return a._updateAfterSyncViewData(function(b){a._updateCursorSegment(b);a._updateCursorHandle(b);"drawing"===a._model.state&&a._updateLabels(b);a._updateLaserLine()})}),this._sceneView.state.watch("camera",function(){return a._updateAfterSyncViewData(function(b){return a._updateCameraDependent(a._model.viewData)})}),this._model.watch(["unit","measurementMode"],function(){return a._updateAll(a._model.viewData)}),this._model.watch(["active","editable"],function(){a._updateLaserLine();a._updateAfterSyncViewData(function(b){return a._updateHandles(b)})}),
this._model.watch("viewData",function(b){return a._syncViewData(b)})])};d.prototype._destroyListeners=function(){this._listenerHandles.destroy();this._listenerHandles=null};d._handleGeometry=new C(D.createSphereGeometry(1,32,32),"handle");return d}();(function(d){var a=function(){return function(){}}();d.PickRequest=a;a=function(){return function(a,c,d){void 0===a&&(a=null);void 0===c&&(c=null);void 0===d&&(d=null);this.type=a;this.scenePoint=c;this.mapPoint=d}}();d.PickResult=a})(t||(t={}));return t});