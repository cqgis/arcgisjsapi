// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/tsSupport/extendsHelper","./TerrainConst","./tileUtils"],function(g,k,p,v,x){var q=Error("Abstract method called on TileAgent");g=function(){function b(){}b.prototype.init=function(a,b,d,e){this.tile=a;this._layerIdx=b;this._layerClass=d;this._suspended=e;this._tileLayerInfo=a.getLayerInfo(b,d);this._dataRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)};b.prototype.startLoading=function(){return this._requestNext()};b.prototype.dispose=
function(){this._dataRequested&&(this._dataRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._dataRequested=null);this._tileLayerInfo=this.tile=null};b.prototype.setSuspension=function(a){a!==this._suspended&&((this._suspended=a)?this._dataRequested&&(this._dataRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._dataRequested=null):this._tileLayerInfo.data||this.update())};b.prototype.update=function(){var a=this._findAncestorWithData();this._setUpsampleTile(a);
return this._requestNext()};b.prototype.dataArrived=function(a){this._setUpsampleTile(a);this._dataRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()};b.prototype.dataMissing=function(a){this._dataRequested=null;this._tileLayerInfo.disposeData();this._requestNext()};b.prototype._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()};b.prototype._requestNext=function(){if(this._suspended)return!0;var a=this._findNextDownload();
if(this._dataRequested){if(a===this._dataRequested)return!0;this._dataRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._dataRequested=null}a?a.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._dataRequested=a):this._agentDone();return!!this._dataRequested};b.prototype._findNextDownload=function(){for(var a=this._layerIdx,b=this._layerClass,d=this.tile.surface.layerViewByIndex(a,b),e=d.layer,g=d.minDataLevel,d=d.maxDataLevel,l=this._desiredMinLevelDelta(),k=v.START_LOADING_LEVEL_DELTA+
l,p=this._scaleRangeEnabled?x.fallsWithinLayer:function(){return!0},f,c=this.tile,r=0,m=this._tileLayerInfo.upsampleFromTile,m=m?m.tile.lij[0]:-1,t=this.tile.surface,q=t.tilemapStats,h=t.getTilemapTile(c),w=!1;c&&p(c,e,!1)&&c.lij[0]>=g;){var u=c.lij[0],n=c.layerInfo[b][a];if(n.data&&r>=l){u>m&&this._setUpsampleTile(c);n.dataInvalidated&&(f=c);break}if(h&&!h.hasDataAvailable(c,a,b))w=!0;else if(u<=d&&!n.data&&!n.dataMissing){if(!f||0===u%v.LOADING_LEVEL_MODULO||this.tile.lij[0]-f.lij[0]<l)f=c;if(r>=
k)break}(c=c.parent)&&h&&(h=h.parent||t.getTilemapTile(c));r++}f&&this.tile.lij[0]-f.lij[0]<l&&this._tileLayerInfo.upsampleFromTile&&(f=null);!f&&w&&q.tilesNotPresent++;return f};b.prototype._findAncestorWithData=function(){for(var a=this.tile.vlevel,b=this._desiredMinLevelDelta(),d,e=this.tile;e;e=e.parent)if(e.hasLayerData(this._layerIdx,this._layerClass)){if(a-e.lij[0]>=b)return e;d=e}return d};b.prototype._setUpsampleTile=function(a){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass)};
return b}();k=function(b){function a(){return null!==b&&b.apply(this,arguments)||this}p(a,b);a.prototype._desiredMinLevelDelta=function(){throw q;};return a}(g);(g||(g={})).DONE=new k;return g});