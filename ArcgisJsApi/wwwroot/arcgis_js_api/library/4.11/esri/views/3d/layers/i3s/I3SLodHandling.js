// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/PooledArray"],function(g,n,m){g=function(){function b(a,c){this.layerView=a;this.lodGlobalDirtyChanged=c}b.prototype.startNodeLoading=function(a,c,d,b,f,e,h){this._lodGlobalDirty=!1;this._maxLodLevel=h.maxLodLevel;this._index=f;this._rootId=e;this._nodeTraversalState=d;this._isNodeVisible=a;this._isGeometryVisible=c;this._removeNodes=b;this.lodGlobalDirtyChanged(this._lodGlobalDirty)};b.prototype.shouldLoadNode=function(a){var c=this._nodeTraversalState(a);
return this.isChosenMaxLOD(c)?!0:c.isChosen?this._childrenRequireLoading(a):!1};b.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0;this.lodGlobalDirtyChanged(this._lodGlobalDirty)};b.prototype.lodSwapBundleLoaded=function(a){this.setLodGlobalDirty()};Object.defineProperty(b.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._rootId&&(!0===this._lodGlobalDirty||this.layerView.view&&1.1<this.layerView.view.resourceController.memoryController.usedMemory)},enumerable:!0,
configurable:!0});b.prototype.lodGlobalHandling=function(a){if(this.requiresLODGlobalHandling){var c=this._rootId,d=Math.max(0,Math.floor(10*(this.layerView.view.resourceController.memoryController.usedMemory-1)));e.clear();this._lodGlobalHandlingRecursion(c,d);this._removeNodes(e,a);0===e.length&&(this._lodGlobalDirty=!1,this.lodGlobalDirtyChanged(this._lodGlobalDirty));e.clear()}};b.prototype._lodGlobalHandlingRecursion=function(a,c){a=this._index.getNode(a);if(null==a)return!1;var d=this._nodeTraversalState(a),
b=this.isChosenMaxLOD(d);(d=this.layerView.isNodeLoaded(a))&&null!=this.layerView.setPolygonOffset&&this.layerView.setPolygonOffset(a,!b);if(b&&d)return this._removeChildrenRecursive(a),!0;var f=!1;if(null!=a.children&&0!==a.children.length)for(var f=!0,k=0,h=a.children;k<h.length;k++){var l=h[k],g=this._index.getNode(l.id);(g?this._isGeometryVisible(g):this._isNodeVisible(l))&&!this._lodGlobalHandlingRecursion(l.id,c)&&(f=!1)}d&&!b&&(f||e.length<c)&&(e.push(a),d=!1);c=!a.featureData||0===a.featureData.length;
return f||d||c};b.prototype._removeChildrenRecursive=function(a){this._index.traverseChildren(a,function(a){e.push(a);return!0})};b.prototype.childrenEmpty=function(a){var c=this,b=!0;this._index.traverseChildren(a,function(a){return b&&c._isNodeVisible(a)?c.layerView.isNodeLoaded(a)?b=!1:!0:!1});return b};b.prototype._childrenRequireLoading=function(a){var b=this,d=!1,e=!0;this._index.traverseChildren(a,function(a){if(!e||!b._isNodeVisible(a))return!1;var c=b._nodeTraversalState(a);b.isChosenMaxLOD(c)&&
b._isGeometryVisible(a)&&(d=!0);return b.layerView.isNodeLoaded(a)?e=!1:!0});return e&&d};b.prototype.isChosenMaxLOD=function(a){return a.isChosen&&(!a.nodeHasLOD||a.lodLevel===this._maxLodLevel)};return b}();var e=new m;return g});