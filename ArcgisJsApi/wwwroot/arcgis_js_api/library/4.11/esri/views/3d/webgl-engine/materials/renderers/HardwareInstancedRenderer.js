// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/BufferView ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/InstanceBufferData ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(t,F,u,p,v,B,C,k,w,x,D){function E(c,a){var b=new Map,d=function(a,d){var e=a.origin.id,c=a.data.id,g=b.get(e);g||(g={origin:a.origin.vec3,deltaByGeometry:new Map},b.set(e,g));e=
g.deltaByGeometry.get(c);e||(e={renderData:a.data,toAdd:[],toRemove:[]},g.deltaByGeometry.set(c,e));(d?e.toAdd:e.toRemove).push(a)};c.forEach(function(a){d(a,!0)});a.forEach(function(a){d(a,!1)});return b}function z(c,a,b){var d=a.elementCount(c),d=a.allocate(d);a.write({},c,null,d,0);b.setData(d.buffer)}var A=function(){function c(a,b,d,c,e){void 0===e&&(e=0);this.data=new C(d,e);this.instanceBuffer=w.createVertex(a,35044);this.vao=new D(a,B.Default3D,{geometry:v.glLayout(b),instance:v.glLayout(d,
{divisor:1})},{geometry:c,instance:this.instanceBuffer})}c.prototype.dispose=function(){this.vao.dispose(!1);this.instanceBuffer.dispose()};Object.defineProperty(c.prototype,"count",{get:function(){return this.data.getCount()},enumerable:!0,configurable:!0});c.prototype.has=function(a){return this.data.hasSlot(a.idx)};c.prototype.prepareAdd=function(a){this.data.prepareAllocate(a)};c.prototype.add=function(a){var b=this.data.allocate(a.idx);this.writeInstance(a,b)};c.prototype.prepareRemove=function(a){this.data.prepareFree(a)};
c.prototype.remove=function(a){this.data.free(a.idx)};c.prototype.updateTransform=function(a,b){void 0===b&&(b=!0);var d=this.data.getSlot(a.idx);null!=d&&(this.writeTransform(a,d),b&&this.uploadSlot(d))};c.prototype.uploadAll=function(){this.data.compact();this.instanceBuffer.setData(this.data.getBuffer().buffer)};c.prototype.uploadSlot=function(a){var b=this.data,d=b.layout.stride;a*=d;this.instanceBuffer.setSubData(b.getBuffer().buffer,a,a,a+d)};c.prototype.instanceBufferView=function(){var a=
this.data.getBuffer();this._buffer!==a&&(this._bufferView={transformation:a.getField("model",p.BufferViewMat4f),transformationNormal:a.getField("modelNormal",p.BufferViewMat4f),instanceColor:a.getField("instanceColor",p.BufferViewVec4f),instanceFeatureAttribute:a.getField("instanceFeatureAttribute",p.BufferViewVec4f)});return this._bufferView};c.prototype.writeTransform=function(a,b){var d=this.instanceBufferView();k.calculateTransformRelToOrigin(a,q,r);d.transformation.setMat(b,q);d.transformationNormal.setMat(b,
r)};c.prototype.writeInstance=function(a,b){var d=this.instanceBufferView();k.calculateTransformRelToOrigin(a,q,r);d.transformation.setMat(b,q);d.transformationNormal.setMat(b,r);d.instanceColor&&d.instanceColor.setVec(b,a.instanceParameters.color);d.instanceFeatureAttribute&&d.instanceFeatureAttribute.setVec(b,a.instanceParameters.featureAttribute)};return c}();t=function(){function c(a,b,d){this._dataByOrigin=new Map;this._highlightCount=0;this._instanceDataToUploadCache=new Set;this._rctx=a;this._material=
d;this._materialRep=b;this._glMaterials=k.acquireMaterials(this._material,this._materialRep);this._bufferWriter=d.createBufferWriter()}c.prototype.dispose=function(){k.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(c.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return 0<this._highlightCount},enumerable:!0,configurable:!0});c.prototype.renderPriority=
function(){return this._material.renderPriority};c.prototype.modify=function(a){this.updateGeometries(a.toUpdate);this.addAndRemoveGeometries(a.toAdd,a.toRemove);this.updateHighlightCount()};c.prototype.addAndRemoveGeometries=function(a,b){var d=this._rctx,c=this._bufferWriter,e=this._dataByOrigin;a=E(a,b);var y=c.vertexBufferLayout,l=c.instanceBufferLayout;a.forEach(function(a,b){var f=e.get(b);f||(f={origin:a.origin,highlightCount:0,dataByGeometry:new Map},e.set(b,f));a.deltaByGeometry.forEach(function(a,
e){var b=f.dataByGeometry.get(e);!b&&0<a.toAdd.length&&(b=w.createVertex(d,35044),z(a.renderData,c,b),b={count:0,vertexBuffer:b,instanceData:new A(d,y,l,b,a.toAdd.length),highlightInstanceData:new A(d,y,l,b)},f.dataByGeometry.set(e,b));var g=b.instanceData,h=b.highlightInstanceData;g.prepareAdd(a.toAdd.length);a.toAdd.forEach(function(a){k.isRenderGeometryHidden(a)||(g.add(a),k.doesRenderGeometryHaveHighlights(a)&&(h.add(a),f.highlightCount=null))});g.prepareRemove(a.toRemove.length);a.toRemove.forEach(function(a){g.remove(a);
h.remove(a)});a.toAdd.length+a.toRemove.length&&(g.uploadAll(),h.uploadAll());b.count+=a.toAdd.length;b.count-=a.toRemove.length;0===b.count&&(b.instanceData.dispose(),b.highlightInstanceData.dispose(),b.vertexBuffer.dispose(),f.dataByGeometry.delete(e))});0===f.dataByGeometry.size&&e.delete(b)})};c.prototype.updateGeometries=function(a){var b=this._dataByOrigin,d=this._bufferWriter;this._instanceDataToUploadCache.clear();var c=this._instanceDataToUploadCache;a.forEach(function(a){var e=a.updateType;
a=a.renderGeometry;var g=b.get(a.origin.id),h=g&&g.dataByGeometry.get(a.data.id);if(h){var m=h.instanceData,f=h.highlightInstanceData,n=e&1;n&&(k.isRenderGeometryHidden(a)?(m.remove(a),c.add(m),f.has(a)&&(f.remove(a),c.add(f))):m.has(a)||(m.add(a),c.add(m),k.doesRenderGeometryHaveHighlights(a)&&!f.has(a)&&(f.add(a),c.add(f))));if(m=e&16)k.doesRenderGeometryHaveHighlights(a)?f.has(a)||(f.add(a),c.add(f)):(f.remove(a),c.add(f)),g.highlightCount=null;e&2&&z(a.data,d,h.vertexBuffer);e&4&&(h.instanceData.updateTransform(a,
!n),h.highlightInstanceData.updateTransform(a,!m))}});c.forEach(function(a){a.uploadAll()})};c.prototype.updateHighlightCount=function(){var a=this;this._highlightCount=0;this._dataByOrigin.forEach(function(b){if(null==b.highlightCount){var c=0;b.dataByGeometry.forEach(function(a){c+=a.highlightInstanceData.count});b.highlightCount=c}a._highlightCount+=b.highlightCount})};c.prototype.render=function(a,b,c,g){var d=this._rctx,k=d.capabilities.instancing,l=this._glMaterials.get(b.pass),h=4===b.pass;
if(!l||null!=a&&!l.beginSlot(a)||h&&0===this._highlightCount)return!1;var m=l.getProgram(),f=l.getDrawMode();l.bind(d,c);var n=!1;this._dataByOrigin.forEach(function(a){h&&0===a.highlightCount||(c.origin=a.origin,l.bindView(d,c),a.dataByGeometry.forEach(function(a){var b=h?a.highlightInstanceData:a.instanceData;a=b.count;h&&0===a||(b=b.vao,x.assertCompatibleVertexAttributeLocations(b,m),d.bindVAO(b),b=x.vertexCount(b,"geometry"),k.drawArraysInstanced(f,0,b,a),g&&(g.drawCallsInstanced++,4===f&&(g.triangles+=
b/3*a)),n=!0)}))});d.bindVAO(null);l.release(d,c);return n};return c}();var q=u.mat4f64.create(),r=u.mat4f64.create();return t});