// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../geometry ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../layers/graphics/dehydratedFeatures ./DirectLineMeasurement3DView".split(" "),function(f,p,q,r,m,n,e,g,h,k){f=function(){function c(a,b){this._handles=new n;this._cachedPickRequest=new k.PickRequest;this._cachedPickResult=new k.PickResult;this._isAnyPointerDown=
!1;this.model=a;this.view=b;this.model.reset()}c.prototype.destroy=function(){this._handles.destroy();this._handles=null};c.prototype.setup=function(a){var b=this,c=a.start,d=a.end;c.on("drag",function(){var a=c.mapPoint,d=c.surfaceType;e.isSome(a)&&e.isSome(d)&&(a=h.clonePoint(a,l),b.model.startPoint=a,b.model.startPointSurfaceLocation=b._surfaceLocation(a,d))});d.on("drag",function(){var a=d.mapPoint,c=d.surfaceType;e.isSome(a)&&e.isSome(c)&&(a=h.clonePoint(a,l),b.model.endPoint=a,b.model.endPointSurfaceLocation=
b._surfaceLocation(a,c))});[c,d].forEach(function(c){b._handles.add([c.watch("grabbing",function(){var c=a.start.grabbing||a.end.grabbing;c&&"measured"===b.model.state&&(b.model.state="editing");c||(b.model.finishedMeasurement({cameraAboveGround:b.view.cameraAboveGround}),"editing"===b.model.state&&(b.model.state="measured"))},!0)])})};c.prototype.handleInputEvent=function(a,b,c){switch(a.type){case "immediate-click":this._handleImmediateClick(a,b,c);break;case "pointer-move":this._handlePointerMove(a,
b,c);break;case "pointer-down":this._handlePointerDown(a);break;case "pointer-up":this._handlePointerUp(a);break;case "key-down":this._handleKeyDown(a)}};c.prototype._handlePointerMove=function(a,b,c){this._clearCachedPickRequest();var d=g.createScreenPointFromEvent(a);"mouse"===a.pointerType&&(this._hoverAt(d),"drawing"===this.model.state&&(c.attemptManipulatorDragTo(b.end,d),a.stopPropagation()))};c.prototype._handlePointerDown=function(a){this._isAnyPointerDown=!0};c.prototype._handlePointerUp=
function(a){this._isAnyPointerDown=!1};c.prototype._handleImmediateClick=function(a,b,c){this._clearCachedPickRequest();if("mouse"!==a.pointerType||0===a.button){var d=g.createScreenPointFromEvent(a),e=!1;if(this.model.active)switch(this.model.state){case "initial":b.start.attemptDragTo({screenPoint:d})&&(b.start.interactive=!1,b.end.interactive=!1,this.model.state="drawing",e=!0);break;case "drawing":c.attemptManipulatorDragTo(b.end,d)&&(b.start.interactive=!0,b.end.interactive=!0,this.model.finishedMeasurement({cameraAboveGround:this.view.cameraAboveGround}),
e=!0)}e&&a.stopPropagation();"mouse"===a.pointerType&&this._hoverAt(d)}};c.prototype._handleKeyDown=function(a){"Escape"===a.key&&"drawing"===this.model.state&&(this.model.clearMeasurement(),a.stopPropagation())};c.prototype._hoverAt=function(a){var b=this._isAnyPointerDown&&"drawing"!==this.model.state&&"editing"!==this.model.state;this.view.requiresCursorPoint&&!b?(a=this._pick(a),a.mapPoint&&(this.model.cursorPoint=a.mapPoint)):this.model.cursorPoint=null};c.prototype._pick=function(a){var b=this._cachedPickRequest.screenPoint;
if(b&&b.x===a.x&&b.y===a.y)return this._cachedPickResult;this._cachedPickRequest.screenPoint=a;return this._cachedPickResult=this.view.pick(this._cachedPickRequest)};c.prototype._clearCachedPickRequest=function(){this._cachedPickRequest.screenPoint=null};c.prototype._surfaceLocation=function(a,b){return"ground"===b?"on-the-surface":a.z>=this.view.getElevation(a)?"above-the-surface":"below-the-surface"};return c}();var l=new m.Point;return f});