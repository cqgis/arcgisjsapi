// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../support/buffer/BufferView ../../support/buffer/InterleavedLayout ../lib/GLMaterialTexture ../lib/Material ../lib/Util ../lib/Util ./VisualVariableMaterialParameters ./internal/bufferWriters ./internal/MaterialUtil ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/PathPrograms ../../../webgl/renderState".split(" "),
function(R,ka,W,E,p,u,X,S,Y,F,Z,m,aa,ba,Q,z,f,ca,A,g){function G(e,a){a.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",a.vvSizeOffset),e.setUniform3fv("vvSizeFactor",a.vvSizeFactor));a.vvColorEnabled&&(e.setUniform1fv("vvColorValues",a.vvColorValues),e.setUniform4fv("vvColorColors",a.vvColorColors));a.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",a.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",
a.vvOpacityOpacities))}var B=aa.assert;R=function(e){function a(b,c){c=e.call(this,c)||this;c.supportsEdges=!0;c.params=f.copyParameters(b,da);c.vertexBufferLayout=a.getVertexBufferLayout(c.params);c.textureMode=b.textureId?b.atlasRegions?"AtlasTextured":"Textured":"none";return c}E(a,e);a.prototype.isVisibleInPass=function(b){return 3===b?this.params.castShadows:!0};a.prototype.isVisible=function(){var b=this.params;if(!e.prototype.isVisible.call(this)||0===b.layerOpacity)return!1;var c=b.symbolColors,
k="replace"===b.colorMixMode,a=0<b.opacity,f=b.externalColor&&0<b.externalColor[3];return b.vvColorEnabled||c?k?!0:a:k?f:a};a.prototype.setParameterValues=function(b){var c=this.params,a;for(a in b)"textureId"===a&&B(c.textureId,"Can only change texture of material that already has a texture"),"wireframe"===a&&B(c.wireframe,"wireframe flag affects drawmode (lines instead of triangles) and therefore can only be set during contruction"),"atlasRegions"===a&&B(b.atlasRegions===c.atlasRegions,"Can not change texture atlas mode."),
!b[a]||"vvSizeMinSize"!==a&&"vvSizeMaxSize"!==a&&"vvSizeOffset"!==a&&"vvSizeFactor"!==a?c[a]=b[a]:p.vec3.set(c[a],b[a][0],b[a][1],b[a][2]);this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.computeVertexPosition=function(b,c,a,d){p.vec3.copy(d,c);if(this.params.vvSizeEnabled){p.vec3.copy(v,this.params.vvSizeFactor);p.vec3.scale(v,v,a);p.vec3.add(v,v,this.params.vvSizeOffset);c=v;a=this.params.vvSizeMinSize;var k=this.params.vvSizeMaxSize;c[0]=Math.min(Math.max(c[0],
a[0]),k[0]);c[1]=Math.min(Math.max(c[1],a[1]),k[1]);c[2]=Math.min(Math.max(c[2],a[2]),k[2]);p.vec3.multiply(d,d,v)}else p.vec3.scale(d,d,this.params.size);p.vec3.add(d,d,b)};a.prototype.intersectTriangles=function(b,c,a,d,e,m,h,l,g,v,E){var k=b[0],T=b[1];b=b[2];var N=c[0]-k,u=c[1]-T;for(c=c[2]-b;a<d;a++){var H=v?v[a]:a,q=h.offsetIdx+h.strideIdx*e[3*H],w=h.offsetIdx+h.strideIdx*e[3*H+1],x=h.offsetIdx+h.strideIdx*e[3*H+2],t=l.offsetIdx+l.strideIdx*e[3*H],y=l.offsetIdx+l.strideIdx*e[3*H+1],I=l.offsetIdx+
l.strideIdx*e[3*H+2],C=0;this.params.vvSizeEnabled&&(C=g.data[g.offsetIdx+g.strideIdx*m[3*H]]);p.vec3.set(K,h.data[q],h.data[q+1],h.data[q+2]);p.vec3.set(L,l.data[t],l.data[t+1],l.data[t+2]);this.computeVertexPosition(K,L,C,r);var n=r[0],t=r[1],q=r[2];p.vec3.set(K,h.data[w],h.data[w+1],h.data[w+2]);p.vec3.set(L,l.data[y],l.data[y+1],l.data[y+2]);this.computeVertexPosition(K,L,C,r);var M=r[0],y=r[1],w=r[2];p.vec3.set(K,h.data[x],h.data[x+1],h.data[x+2]);p.vec3.set(L,l.data[I],l.data[I+1],l.data[I+
2]);this.computeVertexPosition(K,L,C,r);var x=M-n,I=y-t,C=w-q,w=r[0]-n,y=r[1]-t,M=r[2]-q,D=u*M-y*c,B=c*w-M*N,F=N*y-w*u,J=x*D+I*B+C*F,n=k-n,z=T-t,A=b-q,q=z*C-I*A,t=A*x-C*n,G=n*I-x*z;if(J>U){n=n*D+z*B+A*F;if(0>n||n>J)continue;D=N*q+u*t+c*G;if(0>D||n+D>J)continue}else if(J<-U){n=n*D+z*B+A*F;if(0<n||n<J)continue;D=N*q+u*t+c*G;if(0<D||n+D<J)continue}else continue;q=(w*q+y*t+M*G)/J;0<=q&&(x=f.computeNormal(x,I,C,w,y,M,ea),E(q,x,H))}};a.prototype.intersect=function(b,c,a,d,e,g,h,l){"triangle"===b.data.primitiveType&&
(c=0,c=this.params.vvSizeEnabled?Math.max(this.params.vvSizeMaxSize[0],Math.max(this.params.vvSizeMaxSize[1],this.params.vvSizeMaxSize[2])):this.params.size,c=X.fromValues(b.boundingInfo.bbMin[0]-c,b.boundingInfo.bbMin[1]-c,b.boundingInfo.bbMin[2]-c,b.boundingInfo.bbMax[0]+c,b.boundingInfo.bbMax[1]+c,b.boundingInfo.bbMax[2]+c),a=[g[0]-e[0],g[1]-e[1],g[2]-e[2]],l=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),f.intersectAabbInvDir(c,e,[l/a[0],l/a[1],l/a[2]],d.tolerance)&&this.intersectTriangles(e,g,0,b.indexCount/
3,b.getIndices(m.VertexAttrConstants.POSITION),b.getIndices(m.VertexAttrConstants.AUXPOS2),b.getAttribute(m.VertexAttrConstants.POSITION),b.getAttribute(m.VertexAttrConstants.AUXPOS1),b.getAttribute(m.VertexAttrConstants.AUXPOS2),null,h))};a.prototype.createBufferWriter=function(){return new fa(this.vertexBufferLayout)};a.prototype.createRenderer=function(b,c){return new ca(b,c,this)};a.prototype.getGLMaterials=function(){return{color:ga,depth:V,depthShadowMap:this.params.castShadows?ha:null,normal:ia,
highlight:ja}};a.prototype.getAllTextureIds=function(){return this.params.textureId?[this.params.textureId]:[]};a.getVertexBufferLayout=function(b){var c=Y.newLayout().vec3f("position").vec3f("normal");c.vec4f(m.VertexAttrConstants.AUXPOS1);b.textureId&&(c=c.vec2f("uv0"),b.atlasRegions&&(c=c.vec4u16("region",{glNormalized:!0})));b.symbolColors&&(c=c.vec4u8("symbolColor"));if(b.vvColorEnabled||b.vvSizeEnabled||b.vvOpacityEnabled)c=c.vec4f(m.VertexAttrConstants.AUXPOS2);return c};return a}(Z);var ga=
function(e){function a(b,c,a){var d=this,k=b.getParameters(),d=e.call(this,b,c,a,k.textureId,void 0,k.textureInitTransparent)||this;d.params=f.copyParameters(k);d.slot=d.params.transparent?6:4;d.textureMode=b.textureMode;d._createPrograms();d.selectPipeline();return d}E(a,e);a.prototype._createPrograms=function(){var b=this;this.programs=z.BindParametersMap.create(this.params,function(c){return b._createProgram(c)})};a.prototype._createProgram=function(b){var c=this.params;return this.programRep.getProgram(A.colorPass,
{textureMode:this.textureMode,symbolColors:c.symbolColors,flipV:c.flipV,doubleSided:c.doubleSided&&"normal"===c.doubleSidedType,windowOrderDoubleSided:c.doubleSided&&"winding-order"===c.doubleSidedType,receiveShadows:b.receiveShadows,receiveSSAO:b.receiveSSAO,vvSize:c.vvSizeEnabled,vvColor:c.vvColorEnabled,vvOpacity:c.vvOpacityEnabled,verticalOffset:null!==c.verticalOffset,screenSizePerspective:null!==c.screenSizePerspective,slice:c.slicePlaneEnabled,compressedNormals:c.compressedNormals,transparencyDiscard:c.transparent,
wireframe:c.wireframe})};a.prototype.selectPipeline=function(){var b=this.params;this.pipelineState=g.makePipelineState({blending:b.transparent&&g.separateBlendingParams(770,1,771,771),culling:O(b),polygonOffset:b.polygonOffset&&P,depthTest:{func:513},depthWrite:g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program||this.getPrograms()[0]};a.prototype.getPrograms=function(){return z.BindParametersMap.programs(this.programs)};
a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.slot=this.params.transparent?6:4;this.updateTexture(this.params.textureId);this._createPrograms();this.selectPipeline()};a.prototype.bind=function(b,c){var a=this.params,d=this.program=z.BindParametersMap.lookup(this.programs,c);b.bindProgram(d);b.setPipelineState(this.pipelineState);d.setUniform1f("size",a.size);d.setUniform3fv("ambient",a.ambient);d.setUniform3fv("diffuse",a.diffuse);d.setUniform3fv("specular",
a.specular);d.setUniform4fv("externalColor",a.externalColor);d.setUniform1i("colorMixMode",f.colorMixModes[a.colorMixMode]);d.setUniform1f("opacity",a.opacity);d.setUniform1f("layerOpacity",a.layerOpacity);f.bindVerticalOffset(a.verticalOffset,c,d);f.bindScreenSizePerspective(a.screenSizePerspective,d);G(d,a);this.bindTexture(b,d);"none"!==this.textureMode&&this.bindTextureSize(b,d)};a.prototype.release=function(b,a){};a.prototype.bindView=function(b,a){b=this.program=z.BindParametersMap.lookup(this.programs,
a);var c=this.params,d=a.origin;f.bindView(d,a.view,b);f.bindCamPos(d,a.viewInvTransp,b);c.slicePlaneEnabled&&f.bindSlicePlane(d,a.slicePlane,b);a.shadowMappingEnabled&&a.shadowMap.bindView(b,d)};a.prototype.bindInstance=function(b,a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(F),V=function(e){function a(b,a,k,d){void 0===d&&(d=!1);a=e.call(this,
b,a,k,b.getParameters().textureId)||this;a.textureMode=b.textureMode;a.biased=d;a.updateParameters();return a}E(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(A.depthPass,{textureMode:this.textureMode,flipV:b.flipV,shadowMap:this.biased,vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,
slice:b.slicePlaneEnabled,transparencyDiscard:b.transparent});this.pipelineState=g.makePipelineState({culling:O(b),polygonOffset:b.polygonOffset&&P,depthTest:{func:513},depthWrite:g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?6:4};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};
a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);c.setUniform1f("size",d.size);c.setUniform2fv("nearFar",a.nearFar);f.bindVerticalOffset(d.verticalOffset,a,c);f.bindScreenSizePerspective(d.screenSizePerspective,c);G(c,d);this.bindTexture(b,c)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params,d=a.origin;f.bindView(d,a.view,b);c.slicePlaneEnabled&&f.bindSlicePlane(a.origin,a.slicePlane,
b);c.screenSizePerspective&&f.bindCamPos(d,a.viewInvTransp,b)};a.prototype.bindInstance=function(b,a){this.program.setUniformMatrix4fv("model",a.transformation)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(F),ha=function(e){function a(a,c,k){return e.call(this,a,c,k,!0)||this}E(a,e);return a}(V),ia=function(e){function a(a,c,k){c=e.call(this,a,c,k,a.getParameters().textureId)||this;c.textureMode=a.textureMode;c.updateParameters();return c}E(a,e);a.prototype.beginSlot=
function(a){return a===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(A.normalPass,{textureMode:this.textureMode,flipV:a.flipV,vvSize:a.vvSizeEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,slice:a.slicePlaneEnabled,compressedNormals:a.compressedNormals,transparencyDiscard:a.transparent});this.pipelineState=g.makePipelineState({polygonOffset:a.polygonOffset&&
P,culling:O(a),depthTest:{func:513},depthWrite:g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?6:4};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(a,c){var b=this.program,d=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform1f("size",
d.size);this.bindTexture(a,b);f.bindVerticalOffset(d.verticalOffset,c,b);f.bindScreenSizePerspective(d.screenSizePerspective,b);G(b,d)};a.prototype.release=function(a){};a.prototype.bindView=function(a,c){a=this.program;var b=this.params,d=c.origin;f.bindView(d,c.view,a);a.setUniformMatrix4fv("viewNormal",c.viewInvTransp);b.slicePlaneEnabled&&f.bindSlicePlane(c.origin,c.slicePlane,a);b.screenSizePerspective&&f.bindCamPos(d,c.viewInvTransp,a)};a.prototype.bindInstance=function(a,c){a=this.program;
a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(F),ja=function(e){function a(a,c,k){c=e.call(this,a,c,k,a.getParameters().textureId)||this;c.textureMode=a.textureMode;c.updateParameters();return c}E(a,e);a.prototype.beginSlot=function(a){return a===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=this.params;
this.program=this.programRep.getProgram(A.highlightPass,{textureMode:this.textureMode,flipV:a.flipV,vvSize:a.vvSizeEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,slice:a.slicePlaneEnabled,transparencyDiscard:a.transparent});this.pipelineState=g.makePipelineState({polygonOffset:a.polygonOffset&&P,culling:O(a),depthTest:{func:513},depthWrite:g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=
this.params.transparent?6:4};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(a,c){var b=this.program,d=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform1f("size",d.size);this.bindTexture(a,b);f.bindVerticalOffset(d.verticalOffset,c,b);f.bindScreenSizePerspective(d.screenSizePerspective,b);G(b,d)};a.prototype.release=
function(a){};a.prototype.bindView=function(a,c){a=this.program;var b=this.params,d=c.origin;f.bindView(d,c.view,a);b.slicePlaneEnabled&&f.bindSlicePlane(c.origin,c.slicePlane,a);b.screenSizePerspective&&f.bindCamPos(d,c.viewInvTransp,a)};a.prototype.bindInstance=function(a,c){a=this.program;a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(F),da=W({size:1,wireframe:!1,
textureId:void 0,textureInitTransparent:!1,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,symbolColors:!1,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,compressedNormals:!1,receiveSSAO:!0,castShadows:!0,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,transparent:!1,polygonOffset:!1,atlasRegions:!1},ba.Default),fa=function(){function e(a){this.vertexBufferLayout=a}e.prototype.allocate=
function(a){return this.vertexBufferLayout.createBuffer(a)};e.prototype.elementCount=function(a){return a.indices.position.length};e.prototype.write=function(a,b,c,e,d){if(m.VertexAttrConstants.AUXPOS1 in b.vertexAttr){var f=b.vertexAttr[m.VertexAttrConstants.AUXPOS1],g=b.indices[m.VertexAttrConstants.AUXPOS1];B(4===f.size);var h=e.getField(m.VertexAttrConstants.AUXPOS1,S.BufferViewVec4f);if(h)Q.writeBufferVec4(g,f.data,h,d);else throw Error("unable to aquire view for "+m.VertexAttrConstants.AUXPOS1);
}if(m.VertexAttrConstants.AUXPOS2 in b.vertexAttr)if(f=b.vertexAttr[m.VertexAttrConstants.AUXPOS2],g=b.indices[m.VertexAttrConstants.AUXPOS2],B(4===f.size),h=e.getField(m.VertexAttrConstants.AUXPOS2,S.BufferViewVec4f))Q.writeBufferVec4(g,f.data,h,d);else throw Error("unable to aquire view for "+m.VertexAttrConstants.AUXPOS2);Q.writeDefaultAttributes(b,c,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,e,d)};return e}(),P={factor:2,units:2},O=function(e){var a;a=e.slicePlaneEnabled?
!1:e.cullFace?"none"!==e.cullFace:!e.transparent&&!e.doubleSided;return a&&{face:"front"===e.cullFace?1028:1029,mode:2305}},U=Math.pow(2,-52),r=u.vec3f64.create(),v=u.vec3f64.create(),K=u.vec3f64.create(),L=u.vec3f64.create(),ea=u.vec3f64.create();return R});