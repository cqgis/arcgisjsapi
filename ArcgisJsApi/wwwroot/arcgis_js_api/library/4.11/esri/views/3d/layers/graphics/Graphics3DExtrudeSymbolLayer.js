// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/maybe ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Polygon ../../../../layers/graphics/dehydratedFeatures ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/edgeUtils ../../support/projectionUtils ../../support/buffer/BufferView ../../support/buffer/math/vec3 ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(K,L,ha,S,ia,ja,ka,T,P,z,m,la,ma,na,H,oa,U,pa,V,W,X,Y,qa,ra,sa,D,ta){function ua(f,e,a,b,d,c,q,p,v,h,B,t,n,m){var F=a.length/3,C=0;B+=2*b.count;var l=b.index,r=b.count,g=v,u=B;z.vec3.copy(k,n);var x=0<t?1:-1,l=3*l,y=g;n=3*y;for(var A=g+r,g=3*A,w=0;w<r;++w)m&&(k[0]=f[l+0],k[1]=f[l+1],k[2]=f[l+2],z.vec3.normalize(k,k)),d[n+0]=f[l+0],d[n+1]=f[l+1],d[n+2]=f[l+2],c[n+0]=e[l+0],c[n+1]=e[l+1],c[n+2]=e[l+2],q[n+0]=-x*k[0],q[n+1]=-x*k[1],q[n+2]=-x*k[2],p[y]=0,d[g+0]=f[l+0]+t*k[0],d[g+1]=f[l+1]+t*k[1],
d[g+2]=f[l+2]+t*k[2],c[g+0]=e[l+0],c[g+1]=e[l+1],c[g+2]=e[l+2],q[g+0]=x*k[0],q[g+1]=x*k[1],q[g+2]=x*k[2],p[A]=t,n+=3,g+=3,l+=3,y+=1,A+=1;l=0;n=3*u;g=3*(u+F);n=3*(u+F);g=3*u;f=Z;e=aa;0>t&&(f=aa,e=Z);for(w=0;w<F;++w)h[n+0]=a[l+f[0]],h[n+1]=a[l+f[1]],h[n+2]=a[l+f[2]],h[g+0]=a[l+e[0]]+r,h[g+1]=a[l+e[1]]+r,h[g+2]=a[l+e[2]]+r,n+=3,g+=3,l+=3;v+=2*b.count;B=B+2*F-(2*b.count+2*F);ba(d,c,p,q,C,b.pathLengths[0],b.count,v,h,B,t);v+=4*b.pathLengths[0];B+=2*b.pathLengths[0];C+=b.pathLengths[0];for(a=1;a<b.pathLengths.length;++a)ba(d,
c,p,q,C,b.pathLengths[a],b.count,v,h,B,t),v+=4*b.pathLengths[a],B+=2*b.pathLengths[a],C+=b.pathLengths[a]}function I(f,e,a,b,d,c,q){b[c]=b[q];q*=3;c*=3;f[c+0]=f[q+0];f[c+1]=f[q+1];f[c+2]=f[q+2];e[c+0]=e[q+0];e[c+1]=e[q+1];e[c+2]=e[q+2];a[c+0]=d[0];a[c+1]=d[1];a[c+2]=d[2]}function ba(f,e,a,b,d,c,q,p,v,h,B){var t=d,n=d+1,k=d+q,m=d+q+1,C=p,l=p+1,r=p+2*c;p=p+2*c+1;0>B&&(t=d+q+1,m=d);h*=3;for(var g=0;g<c;++g){g===c-1&&(0<B?(n=d,m=d+q):(n=d,t=d+q));var u=f,x=t,y=n,A=k,w=G,x=3*x,y=3*y,A=3*A;z.vec3.set(M,
u[x++],u[x++],u[x++]);z.vec3.set(ca,u[y++],u[y++],u[y++]);z.vec3.set(da,u[A++],u[A++],u[A++]);z.vec3.subtract(ea,ca,M);z.vec3.subtract(fa,da,M);z.vec3.cross(w,fa,ea);z.vec3.normalize(w,w);I(f,e,b,a,G,C,t);I(f,e,b,a,G,l,n);I(f,e,b,a,G,r,k);I(f,e,b,a,G,p,m);v[h++]=C;v[h++]=r;v[h++]=p;v[h++]=C;v[h++]=p;v[h++]=l;t++;n++;k++;m++;C+=2;l+=2;r+=2;p+=2}}Object.defineProperty(L,"__esModule",{value:!0});var E=m.vec3f64.create(),k=m.vec3f64.create(),Z=[0,2,1],aa=[0,1,2],O=ma.makeDehydratedPoint(0,0,0,null),ga=
{verticalDistanceToGround:0,terrainElevation:0};K=function(f){function e(a,b,d,c){a=f.call(this,a,b,d,c)||this;a._edgeStageObjects=new Set;if(!a._isPropertyDriven("size")&&(b=U.validateSymbolLayerSize(a._getSymbolSize())))return a._logWarning(b),a.reject(),a;b=a._getStageIdHint();c=a._getMaterialOpacityAndColor();d=m.vec3f64.fromArray(c);c=c[3];d={diffuse:d,ambient:d,opacity:c,transparent:1>c||a._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:a._context.slicePlaneEnabled,castShadows:a.symbolLayer.castShadows};
a._material=new ta(d,b+"_3dlinemat");a._context.stage.add(Y.ModelContentType.MATERIAL,a._material);a.resolve();return a}ha(e,f);e.prototype.destroy=function(){f.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&this._context.stage.remove(Y.ModelContentType.MATERIAL,this._material.id)};e.prototype.createGraphics3DGraphic=function(a){var b=a.renderingInfo;a=a.graphic;var d=a.geometry;if("polygon"!==d.type&&"extent"!==d.type)return this._logWarning("unsupported geometry type for extrude symbol: "+
d.type),null;if(!this._validateGeometry(d))return null;var c="graphic"+a.uid,e=this._getVertexOpacityAndColor(b,Float32Array,255),p=this.getGraphicElevationContext(a);return this._createAs3DShape(d,b,e,p,c,a.uid)};e.prototype.layerOpacityChanged=function(){var a=this._getMaterialOpacity(),b=1>a||this._isPropertyDriven("opacity");this._material.setParameterValues({opacity:a,transparent:b});if(0<this._edgeStageObjects.size){var d=this._context.stage.view.ensureEdgeView(),c=this._getLayerOpacity();this._edgeStageObjects.forEach(function(a){return d.updateAllComponentOpacities(a,
[c])})}return!0};e.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,H.needsElevationUpdates3D)};e.prototype.slicePlaneEnabledChanged=function(a,b){var d=this;this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});if(0<this._edgeStageObjects.size){var c=this._context.stage.view.ensureEdgeView();a=this._createEdgeMaterial(c);if(S.isSome(a)){var e=[a];this._edgeStageObjects.forEach(function(a){return c.updateAllComponentMaterials(a,
e,{slicePlaneEnabled:d._context.slicePlaneEnabled},!1)})}}return!0};e.prototype.pixelRatioChanged=function(a,b){return!0};e.prototype._getExtrusionSize=function(a){a=a.size&&this._isPropertyDriven("size")?H.getSingleSizeDriver(a.size,2):this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};e.prototype._getSymbolSize=function(){return this.symbolLayer.size||1};e.prototype._createAs3DShape=function(a,b,d,c,e,p){var f=this,h="extent"===a.type?la.fromExtent(a):a;a=h.rings;var q=
[],k=[],n=[],G=Array(6),F=this._context.renderSpatialReference===V.SphericalECEFSpatialReference,C=this._getExtrusionSize(b),l=m.vec3f64.create();F||this._context.renderCoordsHelper.worldUpAtPosition(null,l);b=H.getGeometryVertexData3D(a,h.hasZ,h.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c);this._logGeometryCreationWarnings(b,a,"rings","ExtrudeSymbol3DLayer");if(0===a.length||!a.some(function(a){return 0<a.length}))return null;
var r=U.computeCentroid(h);a=P.mat4f64.create();V.computeLinearTransformation(h.spatialReference,[r.x,r.y,0],a,this._context.renderSpatialReference);var g=P.mat4f64.create();T.mat4.invert(g,a);var u=ka.mat3f64.create();ja.mat3.normalFromMat4(u,g);for(var x=b.geometryData.polygons,y=b.eleVertexData,A=b.vertexData,h=A.length/3,w=new Float64Array(18*h),I=new Float64Array(18*h),K=new Float64Array(18*h),L=new Float64Array(6*h),J=0,h=function(a){var b=x[a],c=b.count,f=b.index;if(Q._context.clippingExtent&&
(H.computeBoundingBox(y,f,c,G),H.boundingBoxClipped(G,Q._context.clippingExtent)))return"continue";var p=new Float64Array(y.buffer,3*f*w.BYTES_PER_ELEMENT,3*c),h=b.holeIndices.map(function(a){return a-f}),p=ia(p,h,3);if(0===p.length)return"continue";var h=new Uint32Array(6*c+2*p.length),m=6*c,r=3*w.BYTES_PER_ELEMENT,r=new W.BufferViewVec3f64(w.buffer,J*r,r,(J+m)*r),t=3*I.BYTES_PER_ELEMENT,t=new W.BufferViewVec3f64(I.buffer,J*t,t,(J+m)*t),v=new Float64Array(K.buffer,3*J*K.BYTES_PER_ELEMENT,3*m),m=
new Float64Array(L.buffer,1*J*L.BYTES_PER_ELEMENT,1*m);ua(A,y,p,b,r.typedBuffer,v,t.typedBuffer,m,0,h,0,C,l,F);X.transformMat4(r,r,g);X.transformMat3(t,t,u);J+=6*c;b=Q._createExtrudeGeometry(h,{positions:r.typedBuffer,elevation:v,normals:t.typedBuffer,heights:m},d);a=new qa(b,e+"path"+a);a.singleUse=!0;q.push(a);k.push(Q._material);n.push(P.mat4f64.create())},Q=this,r=0;r<x.length;++r)h(r);if(0===q.length)return null;var R=new sa({geometries:q,materials:k,transformations:n,castShadow:!0,metadata:{layerUid:this._context.layer.uid,
graphicUid:p},idHint:e});R.objectTransformation=a;var M=function(a){var b=f._context.stage.view.ensureEdgeView();b.removeObject(a);f._edgeStageObjects.delete(a);var c=f._createEdgeMaterial(b);S.isSome(c)&&(f._edgeStageObjects.add(a),b.addObject(a,[c],{slicePlaneEnabled:f._context.slicePlaneEnabled},!f._context.isAsync))};M(R);p=new na(this,R,q,null,null,function(a,b,c,e){a=a.stageObject;O.spatialReference=c.spatialReference;for(var d=a.getGeometryRecords(),f=d.length,p="absolute-height"!==b.mode,
h=0,l=a.objectTransformation,q=T.mat4.invert(P.mat4f64.create(),l),n=0;n<f;n++){var g=d[n].geometry;g.invalidateBoundingInfo();for(var m=g.data.getVertexAttr(),g=m[D.VertexAttrConstants.POSITION].data,r=m[D.VertexAttrConstants.SIZE].data,m=m.mapPos.data,t=g.length/3,k=0,u=0,v=!1,x=0,y=0;y<t;y++){O.x=m[u];O.y=m[u+1];O.z=m[u+2];N[0]=g[k];N[1]=g[k+1];N[2]=g[k+2];var w=H.computeElevation(c,O,b,e,p?ga:null);p&&(x+=ga.terrainElevation);z.vec3.set(E,g[k+0],g[k+1],g[k+2]);z.vec3.transformMat4(E,E,l);e.setAltitude(w+
r[k/3],E);z.vec3.transformMat4(E,E,q);g[k]=E[0];g[k+1]=E[1];g[k+2]=E[2];w=.01/e.unitInMeters;if(Math.abs(N[0]-g[k])>w||Math.abs(N[1]-g[k+1])>w||Math.abs(N[2]-g[k+2])>w)v=!0;u+=3;k+=3}v&&a.geometryVertexAttrsUpdated(n);h+=x/t}b=h/f;M(R);return b},c);p.alignedTerrainElevation=b.terrainElevation;p.needsElevationUpdates=H.needsElevationUpdates3D(c.mode);return p};e.prototype._createExtrudeGeometry=function(a,b,e){for(var c=a.length,f=new Uint32Array(c),d=0;d<c;d++)f[d]=0;c={};d={};c[D.VertexAttrConstants.POSITION]=
a;c[D.VertexAttrConstants.NORMAL]=a;c[D.VertexAttrConstants.COLOR]=f;d[D.VertexAttrConstants.POSITION]={size:3,data:b.positions};d[D.VertexAttrConstants.NORMAL]={size:3,data:b.normals};d[D.VertexAttrConstants.COLOR]={size:4,data:e};d[D.VertexAttrConstants.SIZE]={size:1,data:b.heights};b.elevation&&(d.mapPos={size:3,data:b.elevation},c.mapPos=a);return new ra(d,c)};e.prototype._createEdgeMaterial=function(a){var b={opacity:this._getLayerOpacity()};return pa.createMaterial(a,this.symbolLayer,b)};return e}(oa.default);
L.Graphics3DExtrudeSymbolLayer=K;var G=m.vec3f64.create(),M=m.vec3f64.create(),ca=m.vec3f64.create(),da=m.vec3f64.create(),ea=m.vec3f64.create(),fa=m.vec3f64.create(),N=m.vec3f64.create();L.default=K});