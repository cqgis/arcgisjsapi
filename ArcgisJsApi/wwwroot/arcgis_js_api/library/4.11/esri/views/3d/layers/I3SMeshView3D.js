// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/errors/CancelError ../../../Color ../../../Graphic ../../../core/arrayUtils ../../../core/asyncUtils ../../../core/Collection ../../../core/Evented ../../../core/HandleOwner ../../../core/has ../../../core/iteratorUtils ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/requireUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/aaBoundingBox ../../../layers/graphics/controllers/I3SOnDemandController ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/edgeUtils ./support/layerViewUpdatingProperties ./support/symbolColorUtils ../support/mathUtils ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../webgl-engine/Stage ../webgl-engine/lib/Geometry ../webgl-engine/lib/Layer ../webgl-engine/lib/Object3D ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/TextureBackedBuffer/BufferManager ../webgl-engine/materials/component/index module".split(" "),
function(ca,P,G,da,q,ea,fa,ga,ha,I,ia,ja,ka,B,la,Q,ma,na,oa,pa,qa,F,ra,sa,R,ta,A,ua,m,S,va,wa,C,xa,ya,za,Aa,T,Ba,Ca,Da,p,U,K,Ea,Fa,E,L,Ga,M,Ha,Ia,Ja,Ka,La,N,V,t,Ma,W,Na){function X(p){return R.isArrayBuffer(p.data)}function Y(p,b){for(var a=1024,c=0;c<p.length;c++)var d=p[c],a=a+(d.interleavedVertexData.byteLength+(d.indices?d.indices.byteLength:0)),a=a+(d.positionData.data.byteLength+d.positionData.indices.byteLength);for(p=0;p<b.length;p++)c=b[p],R.isArrayBuffer(c.data)&&(a+=c.data.byteLength);
return a}function Z(p,b){return 104857600<b.byteSize?(z.warn("Node is too big to store in IndexedDB cache: "+p.baseUrl+" ("+b.byteSize+" bytes)"),!1):!0}Object.defineProperty(P,"__esModule",{value:!0});var x=Ia.ModelContentType,z=oa.getLogger("esri.views.3d.layers.SceneLayerView3D"),aa=[1,1,1,1],Oa=[.8,.8,.8],Pa=function(){return function(){}}();B=function(B){function b(){var a=null!==B&&B.apply(this,arguments)||this;a._layerUid="";a._highlights=new Ba(a);a._elevationProvider=null;a._worker=new Aa;
a._workerThread=null;a._nodeId2Meta=new Map;a._addTasks=new Map;a._rendererVersion=0;a._rendererFields=null;a._colorVariable=null;a._opacityVariable=null;a._symbolInfos=new Map;a._idbCache=new U.IDBCache("esri-scenelayer-cache","geometries",11);a._cancelCount=0;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a._cacheKeySuffix=null;a._tmpAttributeOnlyGraphic=new I(null,null,{});return a}da(b,B);Object.defineProperty(b.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?
this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rendererNeedsTextures",{get:function(){return p.rendererNeedsTextures(this._currentRenderer)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var c=ta.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=za.getMetersPerUnit(a.unit);
return(a.offset||0)*d/c}return 0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"useCompressedTextures",{get:function(){var a=this.layer.version,a=!Q("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.has("s3tc")&&a},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;ua.open(ra.getAbsMid("./SceneLayerWorker",ca,Na)).then(function(c){a.destroyed?c.close():a._workerThread=c});p.checkSceneLayerValid(this.layer);p.checkSceneLayerCompatibleWithView(this.layer,this.view);this._layerUid=this.layer.uid;this._controller=new xa({layerView:this});this.geoMemoryEstimate=
this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;if(this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var c=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(c&&c.faceRange&&c.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.view.ensureEdgeView());
this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(c){return a._deleteNodeStageData(c)});this._addThisLayerToStage();this._elevationProvider=new Ca({layerView:this,stageLayer:this._stageLayer});this.handles.add([A.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),A.watch(this,"fullOpacity",function(c){return a._opacityChange(c)}),A.watch(this,"slicePlaneEnabled",function(c){return a._slicePlaneEnabledChange(c)}),A.watch(this,"elevationOffset",
function(c,e){return a._reloadAll(e)}),A.init(this,"filter",function(){return a._filterChange()}),A.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){a._reloadAll();a._memCache.clear()}),A.init(this,"suspended",function(c){return a._suspendedChange(c)})],"sceneLayerHandles");Q("disable-feature:single-idb-cache")&&(this._idbCache=new U.IDBCache("esri-scenelayer-cache-v11","geometries",11));this._idbCache.init().catch(function(a){z.warn("Failed to initialize IndexedDB cache: "+
a)});this._cacheKeySuffix=p.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._componentColorManager=this._hasSymbolColors?new Ma.BufferManager(this._stage.view.renderingContext):null};b.prototype.destroy=function(){this.handles.remove("sceneLayerHandles");this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._memCache=null;this._removeThisLayerFromStage();this._stage=null;this._idbCache&&
(this._idbCache.destroy(),this._idbCache=null);null!=this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};b.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};
b.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};b.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};b.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};b.prototype.isNodeLoaded=function(a){return this._nodeId2Meta.has(a.id)};b.prototype.getUsedMemory=
function(){var a=0;this._nodeId2Meta.forEach(function(c){return a+=c.node.memory});return a};b.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0};b.prototype.ignoresMemoryFactor=function(){return!1};b.prototype._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)};b.prototype.getStats=
function(){var a={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};this._controller&&(this._cachingEnabled()&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a};b.prototype._addThisLayerToStage=function(){for(var a=this._stage,
c=new Uint8Array(256),d=0;d<c.length;d++)c[d]=255;c=""+this.layer.uid;this._stageLayer=c=new Ka(c,{},c);a.add(x.LAYER,c);this._stage.addToViewContent([c.id])};b.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var a=this._stage;this._removeAllNodeDataFromStage();t.verify(0===this._nodeId2Meta.size);a.remove(x.LAYER,this._stageLayer.id);this._stageLayer=void 0;this.gpuMemoryEstimate=0}};b.prototype.getLoadedAttributes=function(a){if((a=this._nodeId2Meta.get(a.id))&&a.attributeInfo)return a.attributeInfo.loadedAttributes};
b.prototype.getAttributeData=function(a){if((a=this._nodeId2Meta.get(a.id))&&a.attributeInfo)return a.attributeInfo.attributeData};b.prototype.setAttributeData=function(a,c){if(a=this._nodeId2Meta.get(a.id))a.attributeInfo=c,a.cachedRendererVersion=this._getInvalidRendererVersion(),a.filteredIds=null,this._updateEngineObject(a)};b.prototype.getLoadedNodeIDs=function(){return ia.keysOfMap(this._nodeId2Meta)};b.prototype._calcEngineMaterialTransparencyParams=function(a,c,d){if(this._isIntegratedMesh)return{forceTransparency:!1};
var e=this.fullOpacity,f=1-L.clamp(t.fallbackIfUndefined(c.transparency,0),0,1);a=1>f||1>e||a&&na.endsWith(a.channels,"a")||!0===c.useVertexColorAlpha||d;return{baseColorOpacity:f,layerOpacity:e,forceTransparency:!!a}};b.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0};b.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"};b.prototype._getMaterialParameters=
function(a,c,d){var e=c.params,f=t.fallbackIfUndefined(e.diffuse,Oa);"standard"!==c.type&&z.warn("Unknown material type '"+c.type+"', must be 'standard'");c=this._isIntegratedMesh;a=this._calcEngineMaterialTransparencyParams(a,e);return G({baseColor:f,baseColorTexture:d,doubleSidedShading:this._calcEngineMaterialDoubleSidedParams(e),cullFace:this._calcEngineMaterialCullFaceParams(e),writeStencil:c,receiveSSAO:!c,normals:c?"ground":"vertex"},a)};b.prototype._getGeometryParameters=function(a,c){return{textureCoordinates:null!=
a,textureCoordinateRegions:c.params.vertexRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":"compressed"}};b.prototype._createTexture=function(a,c,d,e,f){if(null==c)return null;a:{for(var b=0;b<e.length;b++){var h=e[b];if(h.i3sTexId===d){e=h.data;break a}}e=null}if(null==e)return null;var k=null==c?null:this._getI3STexEncoding(c),b="none"!==c.wrap[0]||"none"!==c.wrap[1],h="rgba"===c.channels,l=!0,n;k===p.DDS_ENCODING_STRING?n=V.DDS_ENCODING:
(l=e,l=L.isPowerOfTwo(l.width)&&L.isPowerOfTwo(l.height));f=((c=f||!0===c.atlas)?this._enableAtlasMipMaps:this._enableMipMaps)&&l;d=new V(e,d,{mipmap:f,wrap:c||!b?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:c&&f&&this._disableAtlasAnisotropy,encoding:n,noUnpackFlip:!0,components:h?4:3});this._stage.add(x.TEXTURE,d);a.memory+=this.memEstimateTextureAdded(d);return d};b.prototype._createEngineMaterial=function(a,c,d,e,f,b){var g=e.params.vertexRegions;a=null!=c?this._createTexture(a,c,d,b,
g):null;d=this._getMaterialParameters(c,e,a&&a.id);b=this._getGeometryParameters(c,e);f=W.ComponentMaterial.create(d,b,f);f.metadata={i3sTex:c,i3sMatParams:e.params,engineTex:a};return f};b.prototype._getI3STexEncoding=function(a){var c=p.getAppropriateTextureEncoding(a.encoding,this.useCompressedTextures);return-1<c?a.encoding[c]:a.encoding};b.prototype._getVertexBufferLayout=function(a,c){var d=a.params.materialID,e=c.materialDefinitions[d];t.assert(void 0!==e,"geometry wants unknown material "+
d);a=a.params.textureID||"none";var f;"none"!==a&&(null!=c.textureDefinitions&&null!=c.textureDefinitions[a]||z.warn("textureDefinitions missing in shared resource"),f=c.textureDefinitions[a]);return Ha.glLayout(W.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(f,e)))};b.prototype._createEngineMat=function(a,c,d,e){var f=c.params.materialID,b=d.materialDefinitions[f];t.assert(void 0!==b,"geometry wants unknown material "+f);c=c.params.textureID||"none";var h;"none"!==c&&(null!=d.textureDefinitions&&
null!=d.textureDefinitions[c]||z.warn("textureDefinitions missing in shared resource"),h=d.textureDefinitions[c]);return this._createEngineMaterial(a,h,c,b,f,e)};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._findGraphicNodeAndIndex=function(a){var c=K.attributeLookup(a.attributes,this._getObjectIdField()),d=null;ma.everyMap(this._nodeId2Meta,function(a,f){f=a.featureIds.indexOf(c);if(-1===f)return!0;d={node:a.node,index:f};return!1});return d};
b.prototype._getGraphicIndices=function(a,c){a=this._nodeId2Meta.get(a.id);if(!a)return[];for(var d=[],e=this._getObjectIdField(),f=0;f<c.length;f++){var b=K.attributeLookup(c[f].attributes,e),b=a.featureIds.indexOf(b);-1!==b&&d.push(b)}return d};b.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(!a)return F.reject();var c=this._nodeId2Meta.get(a.node.id).engineObject;a=this._boundingBoxCornerPoints(a.index,c,new Float64Array(24));if(M.bufferToBuffer(a,this.view.renderSpatialReference,
0,a,this.view.spatialReference,0,8))return c=C.empty(),C.expandWithBuffer(c,a,0,8),F.resolve({boundingBox:c,screenSpaceObjects:[]})};b.prototype.whenGraphicAttributes=function(a,c){var d=this;return p.whenGraphicAttributes(this.layer,a,this._getObjectIdField(),c,function(a){for(var c=new Map,e=[],b=0;b<a.length;b++){var k=a[b],l=d._findGraphicNodeAndIndex(k),n=c.get(l.node);n||(n={node:l.node,indices:[],graphics:[]},e.push(n));n.indices.push(l.index);n.graphics.push(k)}return e},{ignoreUnavailableFields:!0,
populateObjectId:!0})};b.prototype.getGraphicFromStageObject=function(a,c){if(this._isIntegratedMesh)return null;var d=this._getMetadata(a);a=a.getComponentFromTriangleNr(0,c);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?this._createGraphic(a,d):null};b.prototype.hasStageObject=function(a){var c=a.getMetadata();return(c=this._nodeId2Meta.get(c.i3sNode))&&c.engineObject===a};b.prototype._getMetadata=function(a){a=a.getMetadata();return this._nodeId2Meta.get(a.i3sNode)};b.prototype._getCacheKey=
function(a){return a.baseUrl+this._cacheKeySuffix};b.prototype._getMemCacheKey=function(a,c){void 0===c&&(c=this.elevationOffset);return a+"#"+c};b.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};b.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=(this._cancelCount|0)+1|0};b.prototype._handleCancelled=function(a){if(0<((this._cancelCount|0)+(-a|0)|0))throw new ga;};b.prototype.loadCachedGPUData=
function(a){return this._memCache.pop(this._getMemCacheKey(a.id))};b.prototype.loadCachedNodeData=function(a,c){var d=this,e=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(a)).then(function(b){if(null==b)return null;d._handleCancelled(e);if(b.nodeVersion!==a.version)return d._idbCache.remove(d._getCacheKey(a)),null;a.obb||(a.obb=Ga.clone(b.nodeObb),d._controller.updateVisibility(a.id));var f=function(a){if(null==a.data)return!0;var c=d._getI3STexEncoding(b.sharedResource.textureDefinitions[a.i3sTexId]);
return a.encoding!==c};return d.rendererNeedsTextures&&b.textureData.some(f)?c(b.allGeometryData,b.sharedResource).then(function(c){b.textureData=c;b.byteSize=Y(b.transformedGeometries,b.textureData);c.every(X)&&Z(a,b)&&d._idbCache.put(d._getCacheKey(a),b).catch(function(c){c&&"indexedb:not-initialized"===c.name||z.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+c)});d._handleCancelled(e);return b}):b}):F.resolve(null)};b.prototype.addNodeData=function(a,c){var d=this;return this._addData(a,
c.attributeDataInfo,function(){return d._transformBundle(a,c).then(function(c){return d._controller.reschedule(a.id,c)}).then(function(b){a.obb||(a.obb=b.obb,d._controller.updateVisibility(a.id));b={allGeometryData:c.allGeometryData,transformedGeometries:b.transformedGeometries,textureData:c.textureData,sharedResource:c.sharedResource,nodeVersion:a.version,nodeObb:a.obb,byteSize:d._cachingEnabled()?Y(b.transformedGeometries,c.textureData):0};if(Z(a,b)&&0<b.byteSize){var e=b.textureData.map(function(a){return X(a)?
a:{i3sTexId:a.i3sTexId,encoding:a.encoding,data:null}});d._idbCache.put(d._getCacheKey(a),G({},b,{textureData:e})).catch(function(c){return z.warn("Failed to store node in IndexedDB cache: "+a.id+": "+c)})}return d._addCachedNodeData(a,b)})})};b.prototype._transformBundle=function(a,c){for(var d=this,b=[],f=[c.geometryBuffer],g=0,h=c.allGeometryData;g<h.length;g++)for(var k=0,l=h[g].geometries;k<l.length;k++)b.push(this._getVertexBufferLayout(l[k],c.sharedResource));c={geometryBuffer:c.geometryBuffer,
geometryData:c.allGeometryData,layouts:b,mbs:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",c,{transferList:f}):this._controller.reschedule(a.id,c).then(function(a){return d._worker.transform(a)})};
b.prototype.addCachedGPUData=function(a,c){if(this._controller.isGeometryVisible(a)){this._nodeId2Meta.set(a.id,c);c.engineObject.setHidden(c.engineObject.geometryRecords[0],!1);a=0;for(var d=c.engineObject.getGeometryRecords();a<d.length;a++)d[a].material.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled});this._updateEngineObject(c);this._highlights.objectCreated(c.engineObject)}else this._memCache.put(this._getMemCacheKey(a.id),c,a.memory)};b.prototype.addCachedNodeData=function(a,c,d){var b=
this;return this._addData(a,d,function(){return b._addCachedNodeData(a,c)})};b.prototype._addCachedNodeData=function(a,c){var d=this;if(this.suspended||!this._controller.isGeometryVisible(a))return F.resolve();var b=c.allGeometryData,f=c.transformedGeometries,g=c.textureData;c=c.sharedResource;if(0===b.length)return F.resolve();1!==b.length&&console.warn("Node with",b.length,"geometries is unsupported");if(!this.rendererNeedsTextures)for(var h=0;h<g.length;h++)g[h].data=null;var k={};k[x.OBJECT]=
{};k[x.GEOMETRY]={};k[x.MATERIAL]={};var h=0,l=!1;a.memory=0;var n=b[0],b=n.componentOffsets,p=n.geometries,n=n.featureIds,u=null,J=null;if(this._hasSymbolColors)for(var u=this._componentColorManager.getBuffer(n.length),J=new Uint16Array(n.length),r=0;r<n.length;r++)J[r]=u.aquireIndex();for(var r=a.id+"|"+n[0],m=[],v=[],q=[],z=[],D=this.view,B,A=0;A<p.length;A++){var t=p[A],C=this._createEngineMat(a,t,c,g),y=f[h++];B=y.corMatrices.globalTrafo;l=l||y.hasColors;y=new N(new Float32Array(y.interleavedVertexData),
y.layout,y.positionData,b||N.DefaultOffsets,y.indices||N.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(y,J);var t=null!=t.transformation?S.mat4f64.clone(t.transformation):Qa,E=m.length,y=new Ja(y,r+(0<E?"_"+E:"")),E=D.renderSpatialReference;m.push(y);q.push(t);z.push(C);t=Da.createOrigin(a.mbs,this.elevationOffset,this._controller.crsIndex,E);v.push(t);a.memory+=this.memEstimateGeometryAdded(y.data);k[x.MATERIAL][C.id]=C;k[x.GEOMETRY][y.id]=y}var H=new La({idHint:a.id,name:r,geometries:m,
materials:z,transformations:q,origins:v,castShadow:!0,metadata:{i3sNode:a.id,layerUid:this._layerUid}});H.objectTransformation=B;k[x.OBJECT][H.id]=H;var G=this._addTasks.get(a.id),w=new Pa;w.node=a;w.engineObject=H;w.featureIds=n;w.componentColorBuffer=u;w.componentIndices=J;w.cachedRendererVersion=this._getInvalidRendererVersion();w.cachedSymbolInfos=[];w.attributeInfo=G.attributeInfo;!this._hasTextures&&null!=a.textureData&&0<a.textureData.length&&(this._hasTextures=!0);this._hasColors||(this._hasColors=
l);this._hasData=!0;this.notifyChange("hasTexturesOrVertexColors");var I=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(w).then(function(){var c=d._stageLayer,b=d._stage,e=k[x.OBJECT],f;for(f in e)e.hasOwnProperty(f)&&c.addObject(e[f]);for(var g in k)if(k.hasOwnProperty(g)){var c=k[g],h;for(h in c)c.hasOwnProperty(h)&&null==b.get(g,h)&&b.add(g,c[h])}d._nodeId2Meta.set(a.id,w);if(d.suspended)d._removeNodeStageData(a.id);else for(w.attributeInfo=G.attributeInfo,w.cachedRendererVersion===
d._rendererVersion&&I===d.slicePlaneEnabled||d._addOrUpdateEdgeRendering(w),d._setObjectSymbology(w),d._applyFiltersToNode(w)&&d._updateEdgeRendering(w),d.visibleGeometryChanged(H),d._highlights.objectCreated(H),b=0,g=w.engineObject.getGeometryRecords();b<g.length;b++)g[b].material.updateParameters({slicePlaneEnabled:d.slicePlaneEnabled})})};b.prototype._addData=function(a,c,d){var b=this,f=this._addTasks.get(a.id);f?f.attributeInfo=c:(f=G({},F.createResolver(),{attributeInfo:c}),this._addTasks.set(a.id,
f),d().then(f.resolve,f.reject).then(function(){return b._addTasks.delete(a.id)}));return f.promise};b.prototype._clippingAreaChanged=function(){var a=C.create();M.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};b.prototype._filterChange=function(){this._applyFilters(!1)};b.prototype._applyFilters=function(a){var c=this;this._filters=
this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(a){c._applyFiltersToNode(a)&&(c._addOrUpdateEdgeRendering(a),c.visibleGeometryChanged(a.engineObject))})};b.prototype.getFilters=function(){var a=this,c=[];this._clippingArea&&c.push(function(c,b){return a._boundingboxFilter(c,b,a._clippingArea)});return c};b.prototype.addSqlFilter=function(a,c,d,b){var e=this;c&&d&&a.push(function(a,f){return e._sqlFilter(a,f,c,d,b)})};b.prototype._sqlFilter=
function(a,c,d,b,f){var e={},h=this._createLayerGraphic(e),k=this.layer.objectIdField,l=c.featureIds,n=c.attributeInfo.attributeData;b.every(function(a){return null!=n[a]||a===k})&&p.filterInPlace(a,l,function(a){e[k]=l[a];for(var c=0;c<b.length;c++){var g=b[c];g!==k&&(e[g]=p.getCachedAttributeValue(n[g],a))}try{return d.testFeature(h)}catch(r){return f(r),!1}})};b.prototype._boundingboxFilter=function(a,c,b){M.mbsToMbs(c.node.mbs,this._controller.crsIndex,ba,this.view.renderSpatialReference);var d=
null!=b?p.intersectBoundingBoxWithMbs(b,ba):2;if(2!==d)if(0===d)a.length=0;else{var f=c.engineObject.getGeometryRecords()[0].geometry;if(f.componentCount===c.featureIds.length){var g=p.getClipAABB(b,c.engineObject);p.filterInPlace(a,c.featureIds,function(a){return C.intersects(g,f.getComponentAABB(a,Ra))})}}};b.prototype._addOrUpdateEdgeRendering=function(a,c){void 0===c&&(c=!0);if(!this._edgeView)return F.resolve();var b=a.engineObject,e=this._edgeView.hasObject(b),f=this._extractObjectEdgeMaterials(a);
a=f.perFeatureEdgeMaterials;var g={slicePlaneEnabled:this.slicePlaneEnabled};if(f.hasEdges)if(f=!b.isHidden(b.geometryRecords[0]),e)this._edgeView.updateAllComponentMaterials(b,a,g,c),this._edgeView.updateObjectVisibility(b,f);else{if(f)return ja.safeCast(this._edgeView.addObject(b,a,g,!1))}else e&&this._edgeView.removeObject(b);return F.resolve()};b.prototype._removeEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.engineObject)&&this._edgeView.removeObject(a.engineObject)};b.prototype._applyFiltersToNode=
function(a){var c=a.engineObject,b=c.areAllComponentsVisible();c.unhideAllComponents();if(0===this._filters.length)return!b;var e=a.featureIds;if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters;a=a.filteredIds;if(a===e)return!b;for(var b=c.getGeometryRecords()[0],f=0,g=0;g<e.length;g++){var h=e[g];f>=a.length||a[f]!==h?c.setComponentVisibility(b,g,!1):f++}return!0};b.prototype._computeFilteredIds=function(a){for(var c=
a.featureIds.slice(),b=0,e=this._filters;b<e.length;b++)(0,e[b])(c,a);return c.length===a.featureIds.length?a.featureIds:c};b.prototype._removeAllNodeDataFromStage=function(a){var c=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(b,e){return c._removeNodeStageData(e,a)})};b.prototype.removeNodeData=function(a,c){for(;0<a.length&&!c.done;){var b=a.pop();this._removeNodeStageData(b.id);c.madeProgress()}};b.prototype._removeNodeStageData=function(a,c){void 0===c&&(c=this.elevationOffset);
var b=this._nodeId2Meta.get(a);if(b){var e=b.engineObject;e.setHidden(e.geometryRecords[0],!0);this.visibleGeometryChanged(e);this._removeEdgeRendering(b);this._nodeId2Meta.delete(a);this._highlights.objectDeleted(e);this._memCache.put(this._getMemCacheKey(a,c),b,b.node.memory)}};b.prototype._deleteNodeStageData=function(a){var c=this._stage,b=this._stageLayer,e=a.engineObject;this._edgeView&&this._edgeView.removeObject(e);b.removeObject(e);for(var b=0,f=e.getGeometryRecords();b<f.length;b++){var g=
f[b];this.memEstimateGeometryRemoved(g.geometry.data);c.remove(x.GEOMETRY,g.geometry.id);this._removeMaterial(g.material,c)}if(a.componentIndices){for(b=0;b<a.componentIndices.length;b++)a.componentColorBuffer.releaseIndex(a.componentIndices[b]);this._componentColorManager.garbageCollect()}c.remove(x.OBJECT,e.id)};b.prototype._removeMaterial=function(a,c){c.remove(x.MATERIAL,a.id);if(a=a.metadata.engineTex)this.memEstimateTextureRemoved(a),c.remove(x.TEXTURE,a.id)};b.prototype.setPolygonOffset=function(a,
c){var b=this._nodeId2Meta.get(a.id);if(b)for(a=0,b=b.engineObject.getGeometryRecords();a<b.length;a++)b[a].material.updateParameters({polygonOffsetEnabled:c})};b.prototype._getInvalidRendererVersion=function(){return(this._rendererVersion|0)+-1|0};b.prototype._rendererChange=function(a){return fa(this,void 0,void 0,function(){var c,b,e,f,g,h,k,l;return ea(this,function(d){switch(d.label){case 0:this._currentRenderer=a;this.notifyChange("rendererNeedsTextures");this._rendererVersion=(this._rendererVersion|
0)+1|0;this._opacityVariable=this._colorVariable=this._rendererFields=null;if(!a)return[3,2];c=this;b=p.findFieldsCaseInsensitive;return[4,a.getRequiredFields(this.layer.fields)];case 1:c._rendererFields=b.apply(void 0,[d.sent(),this.layer.fields]),d.label=2;case 2:if(a&&"visualVariables"in a&&a.visualVariables)for(e=0,f=a.visualVariables;e<f.length;e++)g=f[e],"color"===g.type?this._colorVariable=g:"opacity"===g.type?this._opacityVariable=g:z.warn("Unsupported visual variable type for 3D Object Scene Services: "+
g.type);if(a)for(h=0,k=a.getSymbols();h<k.length;h++)l=k[h],"mesh-3d"!==l.type&&z.error("Symbols of type '"+l.type+"' are not supported for 3D Object Scene Services.");this._controller&&this._controller.requestUpdate();return[2]}})})};b.prototype._getSymbolInfos=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolInfos};b.prototype._getSymbolColors=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&
this._updateCachedRendererData(a);return a.cachedSymbolColors};b.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var c=a.featureIds?a.featureIds.length:1,b={},e=this._tmpAttributeOnlyGraphic;e.attributes=b;var f=this._currentRenderer,g=a.attributeInfo.attributeData,h=null!=a.featureIds?this.layer.objectIdField:null,k=null!=g?this._rendererFields:null;null==a.cachedSymbolColors&&(a.cachedSymbolColors=new Uint8Array(4*a.featureIds.length));
for(var l=a.cachedSymbolColors,n=!0,m=0;m<c;m++){null!=h&&(b[h]=a.featureIds[m]);if(null!=k)for(var u=0,q=k;u<q.length;u++){var r=q[u];g[r]&&(b[r]=p.getCachedAttributeValue(g[r],m))}q=f&&f.getSymbol(e);u=null;q instanceof ya&&(this._symbolInfos.has(q.id)||this._symbolInfos.set(q.id,p.getSymbolInfo(q)),u=this._symbolInfos.get(q.id));a.cachedSymbolInfos[m]=u;var t=r=null,v=!0,q=!0;f&&"visualVariables"in f&&(this._colorVariable&&(v=f.getColor(e,{colorInfo:this._colorVariable,color:Sa}))&&(r=O,r[0]=v.r/
255,r[1]=v.g/255,r[2]=v.b/255,this._opacityVariable||null===v.a||(t=v.a)),this._opacityVariable&&(t=f.getOpacity(e,{opacityInfo:this._opacityVariable})));u&&u.material?(v=u.material,r=null==r||null==t?T.overrideColor(r,t,v.color,v.alpha,aa,O):T.overrideColor(r,t,null,null,aa,O),E.encodeSymbolColor(r,v.colorMixMode,l,4*m),v=u.castShadows):(E.encodeSymbolColor(null,null,l,4*m),v=!0);if(0<m&&n){for(u=4*(m-1);u<4*m;u++)l[u]!==l[u+4]&&(n=!1);v!==q&&(n=!1)}q=v}a.uniformSymbolColor=n}};b.prototype._extractObjectEdgeMaterials=
function(a){var c=[],b=a.engineObject,e=a.featureIds?a.featureIds.length:1,f={opacity:this.fullOpacity},g=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),h=!1,k=null,l=null;a=this._getSymbolInfos(a);for(var n=0;n<e;n++){var m=a[n];b.getComponentVisibility(b.getGeometryRecords()[0],n)&&m?(l!==m&&(l=m,(k=Ea.createMaterialFromEdges(this._edgeView,m.edges,f))&&(h=!0)),c.push(pa.isSome(k)?k:g)):c.push(g)}return{hasEdges:h,perFeatureEdgeMaterials:c}};b.prototype._setObjectSymbology=
function(a){if(this._hasSymbolColors){var c=a.featureIds?a.featureIds.length:1,b=this._getSymbolColors(a);if(a.uniformSymbolColor){var e=E.decodeSymbolColor(b,0),f=e.color,e=e.colorMixMode,b=!0;a.cachedSymbolInfos[0]&&(b=a.cachedSymbolInfos[0].castShadows);for(var g=0,h=a.engineObject.getGeometryRecords();g<h.length;g++)c=h[g],c=c.material,c.updateParameters({componentData:{castShadows:b,externalColor:f,externalColorMixMode:e}});this._updateObjectOpacity(a.engineObject,1>f[3])}else{f=a.componentColorBuffer.textureBuffer;
e=!0;for(g=0;g<c;g++){var h=4*g,k=a.componentIndices[g],l=1;a.cachedSymbolInfos[g]&&(l=!0===a.cachedSymbolInfos[g].castShadows?1:0);f.setData(k,0,b[h],b[h+1],b[h+2]&254|l,b[h+3]);e=e&&E.isOpaqueSymbolColor(b,h)}b=0;for(g=a.engineObject.getGeometryRecords();b<g.length;b++)c=g[b],c=c.material,c.updateParameters({componentData:f});this._updateObjectOpacity(a.engineObject,!e);this._stage.setNeedsRender()}}};b.prototype._setComponentIndices=function(a,c){for(var b=a.getAttribute(t.VertexAttrConstants.COMPONENTINDEX),
e=b.data,f=b.offsetIdx,b=b.strideIdx,g=a.getIndices(t.VertexAttrConstants.COMPONENTINDEX),h=0;h<c.length;h++)for(var k=a.componentOffsets[h+1],l=a.componentOffsets[h];l<k;l++)e[f+g[l]*b]=c[h]};b.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};b.prototype._opacityChange=function(a){var c=this;this._nodeId2Meta.forEach(function(a){c._updateObjectOpacity(a.engineObject);c._updateEdgeRendering(a)})};
b.prototype._updateObjectOpacity=function(a,c){var b=0;for(a=a.getGeometryRecords();b<a.length;b++){var e=a[b].material,f=e.metadata;void 0!==c&&(f.symbolIsTransparent=c);f=this._calcEngineMaterialTransparencyParams(f.i3sTex,f.i3sMatParams,f.symbolIsTransparent);e.updateParameters(f)}};b.prototype._updateEngineObject=function(a){this._setObjectSymbology(a);this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this.visibleGeometryChanged(a.engineObject)};b.prototype._slicePlaneEnabledChange=
function(a){var c=this,b={slicePlaneEnabled:a};this._stageLayer.isSliceable=a;this._nodeId2Meta.forEach(function(a){for(var e=0,d=a.engineObject.getGeometryRecords();e<d.length;e++)d[e].material.updateParameters(b);c._updateEdgeRendering(a,!1)})};b.prototype._updateEdgeRendering=function(a,c){void 0===c&&(c=!0);this._edgeView&&this._edgeView.hasObject(a.engineObject)&&this._addOrUpdateEdgeRendering(a,c)};b.prototype._forAllFeatures=function(a,c,b){var e=this;this._nodeId2Meta.forEach(function(d,g){e._forAllFeaturesOfNode(d,
a,b);c&&c(d.node)})};b.prototype._forAllFeaturesOfNode=function(a,c,b){for(var e=a.featureIds,d=a.engineObject.getGeometryRecords()[0],g=0;g<e.length;g++)(b||a.engineObject.getComponentVisibility(d,g))&&c(e[g],g,a,d)};b.prototype._createGraphic=function(a,c){var b={};null!=c.featureIds&&(b[this._getObjectIdField()]=c.featureIds[a]);c=c.attributeInfo.attributeData;if(null!=c)for(var e=0,f=Object.keys(c);e<f.length;e++){var g=f[e];b[g]=p.getCachedAttributeValue(c[g],a)}return this._createLayerGraphic(b)};
b.prototype._boundingBoxCornerPoints=function(a,b,d){a=b.geometries[0].getComponentAABB(a,Ta);for(var c=0;8>c;++c)D[0]=c&1?a[0]:a[3],D[1]=c&2?a[1]:a[4],D[2]=c&4?a[2]:a[5],va.vec3.transformMat4(D,D,b.objectTransformation),d[3*c]=D[0],d[3*c+1]=D[1],d[3*c+2]=D[2];return d};b.prototype.highlight=function(a,b){var c=this;void 0===b&&(b={});var e=this._highlights;"number"===typeof a?a=[a]:a instanceof I?a=[a]:a instanceof ka&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof I){a=a.map(function(a){return K.attributeLookup(a.attributes,
c._getObjectIdField())});var f=e.acquireSet(b);b=f.set;f=f.handle;e.setFeatureIds(b,a);return f}if("number"===typeof a[0])return f=e.acquireSet(b),b=f.set,f=f.handle,e.setFeatureIds(b,a),f}return Ua};b.prototype.visibleGeometryChanged=function(a){var b=this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=sa.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=
null}))};b.prototype.test=function(){return{controller:this._controller}};q([m.property()],b.prototype,"view",void 0);q([m.property()],b.prototype,"layer",void 0);q([m.property()],b.prototype,"_controller",void 0);q([m.property({dependsOn:["_controller.updating"]})],b.prototype,"updating",void 0);q([m.property({dependsOn:["_controller.rootNodeVisible"]})],b.prototype,"suspended",void 0);q([m.property(Fa.updatingPercentage)],b.prototype,"updatingPercentage",void 0);q([m.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],
b.prototype,"updatingPercentageValue",void 0);q([m.property({readOnly:!0})],b.prototype,"hasTexturesOrVertexColors",null);q([m.property({readOnly:!0})],b.prototype,"rendererNeedsTextures",null);q([m.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],b.prototype,"elevationOffset",null);q([m.property({type:Boolean})],b.prototype,"slicePlaneEnabled",void 0);q([m.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],b.prototype,
"uncompressedTextureDownsamplingEnabled",null);q([m.property({dependsOn:["layer.version"]})],b.prototype,"useCompressedTextures",null);return b=q([m.subclass("esri.views.3d.layers.I3SMeshView3D")],b)}(m.declared(la,B,qa));P.I3SMeshView3D=B;var Qa=S.mat4f64.create(),D=wa.vec3f64.create(),Ta=C.create(),Ra=C.create(),O=[0,0,0,0],Sa=new ha([0,0,0,0]),ba=[0,0,0,0],Ua={remove:function(){},pause:function(){},resume:function(){}}});