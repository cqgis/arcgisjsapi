// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper dojo/errors/CancelError ../../../../core/PooledArray ../../../../core/urlUtils ../../support/orientedBoundingBox".split(" "),function(r,t,u,w,n,v,x){Object.defineProperty(t,"__esModule",{value:!0});var y="version level sharedResource attributeData geometryData textureData lodSelection".split(" ");r=function(){function c(a,b,d,g,e,c,k,h,f,z){var m=this;this.rootId=d;this.streamDataSupplier=g;this.viewportQueries=e;this.logger=c;this._isLoaded=
k;this._isSelected=h;this._enable=f;this._needsUpdate=z;this._dirty=!0;this.nodeIndex={};this._loadingNodes=new Set;this._failedNodes=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState={};this._version=0;this._featureEstimate={estimate:0,leafsReached:!1};this._unloadedMemoryEstimate=0;this._missing=new n;this._prefetch=new n;this._updates=new A;this.ignoreServiceOBB=!1;this.progressiveLoadPenalty=0;
this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1;this.rootUrl=v.makeAbsolute(b,a);this.traverseVisible(function(a,b){return m.nodeTraversalState(b)})}c.prototype.getNode=function(a){return this.nodeIndex[a]};Object.defineProperty(c.prototype,"size",{get:function(){return Object.keys(this.nodeIndex).length},enumerable:!0,configurable:!0});c.prototype.destroy=function(){p.prune()};c.prototype.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;++this._version};c.prototype.update=
function(a,b){var d=this;if(this._dirty){this._indexMissing=0;this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();p.clear();this._updates.reset(a);var g=!0,e=new q,c=new q,k=new Map;this.traverseVisible(function(h,f,m){d._updateNodeFeatureEstimate(f,c);if(f){if(0===d._missing.length&&f.children)for(h=0,m=f.children;h<m.length;h++){var l=m[h];d.nodeIndex[l.id]||d._loadingNodes.has(l.id)||(k.set(l.id,d.entryPriority(l)),d._prefetch.push(u({},
l,{baseUrl:f.baseUrl})))}!f.failed&&f.featureData&&0!==f.featureData.length&&(d._isLoaded(f)?(e.known+=f.memory,++e.knownNodes,d._isSelected(f)?f.children&&(g=!1):(e.unremoved+=f.memory,g=!1),d._needsUpdate(f)&&(h=d.entryPriority(f),k.set(f.id,h),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,h),d._updates.update.push(f))):(f.memory&&(e.known+=f.memory,++e.knownNodes),d._isSelected(f)&&(f.children&&(g=!1),f.memory?(e.missing+=f.memory,e.known+=f.memory,++e.knownNodes):++e.missingNodes,0<=a.indexOf(f.id)?
(d._maxProcessingPrio=Math.max(d._maxProcessingPrio,d.entryPriority(f)),d._updates.cancel=d._updates.cancel.filter(function(a){return a!==f.id})):!b.done&&d._enable(f)?b.madeProgress():(h=d.entryPriority(f),k.set(f.id,h),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,h),p.push(f)))))}else++d._indexMissing,l=d.entryPriority(h),d._loadingNodes.has(h.id)||d._failedNodes.has(h.id)||(d._missing.push(u({},h,{baseUrl:m})),k.set(h.id,l)),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l)});this._unloadedMemoryEstimate=
e.missing-e.unremoved;3<e.knownNodes&&0<e.missingNodes&&(this._unloadedMemoryEstimate+=e.known/e.knownNodes*e.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(c);this._featureEstimate.leafsReached=g;this._missing.sort(function(a,b){return k.get(a.id)-k.get(b.id)});0<this._missing.length?(this._maxUnloadedPrio=k.get(this._missing.back().id),this._prefetch.clear()):this._prefetch.sort(function(a,b){return k.get(a.id)-
k.get(b.id)});this._updates.add=p.filter(function(a){return k.get(a.id)>=d._maxUnloadedPrio},this,this._updates.add);this._updates.add.sort(function(a,b){return k.get(a.id)-k.get(b.id)});this._updates.update.sort(function(a,b){return k.get(a.id)-k.get(b.id)});this._dirty=0<this._indexMissing}};c.prototype.checkFeatureTarget=function(a,b){for(var d=this.viewportQueries.updateScreenSpaceErrorBias(b),g=b,e=b,c=d,k=10;k--;){var h=new q;this._updateFeatureEstimate(g,h);if(this._computeFeatureEstimate(h)<=
a){if(g>=b||0<h.missingNodes||0===k)break;c=g;g=.5*(g+e)}else e=g,g=.5*(g+c)}++this._version;this.viewportQueries.updateScreenSpaceErrorBias(d);return Math.min(b,g)};c.prototype._updateFeatureEstimate=function(a,b){var d=this;++this._version;this.viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible(function(a,e){return d._updateNodeFeatureEstimate(e,b)})};c.prototype._updateNodeFeatureEstimate=function(a,b){a&&!a.failed&&null!=a.numFeatures&&(this._isLoaded(a)?(b.known+=a.numFeatures,
++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):this._isSelected(a)&&(a.numFeatures?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};c.prototype._computeFeatureEstimate=function(a){var b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};c.prototype.load=function(a){if(0===this._missing.length)return!1;a=Math.min(a,this._missing.length);for(var b=0;b<a;++b)this._loadNode(this._missing.pop());
return!0};c.prototype.prefetch=function(a){if(0===this._prefetch.length)return!1;a=Math.min(a,this._prefetch.length);for(var b=0;b<a;++b)this._loadNode(this._prefetch.pop());return!0};c.prototype.isLoading=function(){return 0<this._indexMissing};c.prototype.getIndexLoading=function(){return this._loadingNodes.size};c.prototype.getIndexMissing=function(){return this._indexMissing};c.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate};Object.defineProperty(c.prototype,
"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0});c.prototype.getFeatureEstimate=function(){return this._featureEstimate};c.prototype.nodeTraversalState=function(a){if(!a)return null;var b=this._nodeTraversalState[a.id];if(b&&b.version===this._version)return b;var d=this.viewportQueries.getLodLevel(a),g=this.viewportQueries.hasLOD(a),e=!0;if(g)if(a.parentNode){e=this.nodeIndex[a.parentNode.id];if(null==e)return null;e=(e=this._nodeTraversalState[e.id])&&d>e.lodLevel}else e=
0<d;if(b)return b.lodLevel=d,b.isChosen=e,b.version=this._version,b;this._nodeTraversalState[a.id]={nodeHasLOD:g,lodLevel:d,isChosen:e,version:this._version};return this._nodeTraversalState[a.id]};c.prototype._loadNode=function(a){var b=this;this._loadingNodes.add(a.id);var d=v.makeAbsolute(a.href,a.baseUrl),g=function(a){b._loadingNodes.delete(a);0===b._missing.length&&0===b._loadingNodes.size&&b.requestUpdate()};this.streamDataSupplier.request(d,"json").then(function(a){var e=a.data,c={id:e.id,
mbs:e.mbs,parentNode:e.parentNode,children:e.children,featureData:e.featureData};y.forEach(function(a){c[a]=e.hasOwnProperty(a)?e[a]:null});e.hasOwnProperty("obb")&&!b.ignoreServiceOBB&&(c.obb=x.clone(e.obb),c.hasServiceOBB=!0,b.viewportQueries.updateNode(c.id));b.nodeIndex[c.id]=c;c.baseUrl=d;c.featureData&&1===c.featureData.length&&c.featureData[0].featureRange&&(c.numFeatures=c.featureData[0].featureRange[1]-c.featureData[0].featureRange[0]+1);b.nodeTraversalState(c);g(c.id)},function(c){c instanceof
w||(b.logger.error("Error loading node: "+d),b._failedNodes.add(a.id));g(a.id)})};c.prototype.resetFailedNodes=function(){this._failedNodes.clear();for(var a=0,b=Object.keys(this.nodeIndex);a<b.length;a++)this.nodeIndex[b[a]].failed=!1};c.prototype.entryPriority=function(a){if(null==a.mbs&&a.id===this.rootId)return Infinity;var b=0,d=this.nodeIndex[a.id];if(null!=d&&null!=d.parentNode){var c=this._nodeTraversalState[d.parentNode.id];null!=c&&(b=c.lodLevel)}for(c=this.progressiveLoadPenalty;d;d=d.parentNode?
this.nodeIndex[d.parentNode.id]:null)if(this._isLoaded(d)){c=0;break}a=this.viewportQueries.distToPOI(a);return-a-b*(a+this.progressiveLoadPenalty)+c};c.prototype.traverseVisible=function(a){var b=this.nodeIndex[this.rootId];b?this._traverse({id:this.rootId,mbs:b.mbs,href:this.rootUrl},b,a,""):a({id:this.rootId,mbs:null,href:this.rootUrl},null,"")};c.prototype._traverse=function(a,b,d,c){if(!b.children||0===b.children.length)this.viewportQueries.isGeometryVisible(b)&&d(a,b,c);else if(this.viewportQueries.isNodeVisible(b)&&
(d(a,b,c),a=this.nodeTraversalState(b),!a.nodeHasLOD||a.lodLevel!==this._maxLodLevel))for(a=0,c=b.children;a<c.length;a++){var e=c[a],g=this.nodeIndex[e.id];g?this._traverse(e,g,d,b.baseUrl):this.viewportQueries.isNodeVisible(e)&&d(e,null,b.baseUrl)}};c.prototype.traverse=function(a,b){if(b(a)&&a.children)for(var c=0;c<a.children.length;++c){var g=this.getNode(a.children[c].id);g&&this.traverse(g,b)}};c.prototype.traverseChildren=function(a,b){if(a.children)for(var c=0;c<a.children.length;++c){var g=
this.getNode(a.children[c].id);g&&b(g)&&this.traverseChildren(g,b)}};c.prototype.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){var b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};c.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,
this._maxUnloadedPrio)};return c}();t.I3SIndex=r;var p=new n,A=function(){function c(){this.update=new n;this.add=new n;this.cancel=[]}c.prototype.reset=function(a){this.add.clear();this.update.clear();this.cancel=a};return c}(),q=function(){return function(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0}}()});