// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/has ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../lib/DrapedRenderer ../lib/GLMaterialRep ../lib/GLTextureRep ../lib/ProgramRepository ../lib/tracer ../lighting/Lightsources ./Model ./Viewport ../shaders/globalOptions ../../../support/screenshotUtils ../../../webgl/context-util ../../../webgl/FramebufferObject ../../../webgl/RenderingContext".split(" "),
function(p,K,q,u,v,w,r,t,x,y,z,A,B,k,C,D,E,F,l,G,H,I){var J=v.getLogger("esri.views.3d.webgl-engine.parts.View");p=function(){function b(a,m,c,b){var d=this;this.options=b;this._backgroundColor=x.vec4f64.fromValues(1,1,1,1);this._lightDirection=t.vec3f64.fromValues(0,1,0);this._didRender=!1;this._idleSuspend=this._needsRender=!0;this._shouldRender=!1;this._supersampleScreenshots=!0;this._screenshotQueue=[];this._container=a;this._stage=m;this._initializeContext(b);a=F.glslifyGlobalOptions({viewingMode:b.viewingMode});
this._programRepository=new B(this._rctx,a);this._textureRep=new A(m.getAll(D.ContentType.TEXTURE),this._programRepository,function(){return d._viewport.getCamera().viewport},this._rctx);this._materialRep=new z(this._textureRep,this._programRepository);this._viewport=new E(this._stage,this._programRepository,this._materialRep,this._textureRep,this._rctx);this._initializeViewportCamera();this._drapedRenderer=new y(this._rctx,this._canvas,this._programRepository,this._materialRep,this._textureRep,c);
this._initializeFrameTask()}Object.defineProperty(b.prototype,"isLoadingResources",{get:function(){return this._viewport.isLoadingResources},enumerable:!0,configurable:!0});b.prototype._initializeFrameTask=function(){var a=this;this._frameTask={preRender:function(){k.begin();a._stage.processDirty();a.needsRender()?(a._shouldRender=!0,a._viewport.getCamera().setGLViewport(a._rctx),a._rctx.setClearColor.apply(a._rctx,a._backgroundColor),a._rctx.clearSafe(16640)):a._shouldRender=!1},render:function(){a._shouldRender&&
(a._didRender=!0,n.lightDirection=a._lightDirection,n.disableSlice=!1,a._viewport.render(n))},postRender:function(){k.end()},update:function(){a.resetNeedsRender();a._performScreenshots()}}};b.prototype._initializeViewportCamera=function(){var a=this._container.getBoundingClientRect(),b=this._viewport.getCamera();b.viewport[2]=a.width;b.viewport[3]=a.height;this._viewport.setCamera(b)};b.prototype._initializeContext=function(a){this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));
this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var b=G.createContextOrErrorHTML(this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil},a.renderContext);this._gl=k.instrumentContext(b);this._rctx=new I(this._gl,{disabledExtensions:a.deactivatedWebGLExtensions||{}});!a.alpha&&this._rctx.contextAttributes.alpha&&J.error("WebGL context has alpha channel even though no alpha channel was requested");!this._rctx.contextAttributes.alpha&&
11<=u("safari")&&(this._container.style.backgroundColor="black");this._container.appendChild(this._canvas);null!=a.supersampleScreenshots&&(this._supersampleScreenshots=a.supersampleScreenshots)};b.prototype.dispose=function(){this._viewport.dispose();this._viewport=null;this._drapedRenderer.dispose();this._drapedRenderer=null;this._programRepository.dispose();this._programRepository=null;this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=this._gl=this._canvas=
this._container=null};b.prototype.getCombinedStats=function(){return this._viewport.getCombinedStats()};b.prototype.setNeedsRender=function(){this._didRender=!1;this._needsRender=!0};b.prototype.resetNeedsRender=function(){this._didRender&&(this._didRender=this._needsRender=!1);this._viewport.resetNeedsRender();this._textureRep.resetNeedsRender()};b.prototype.needsRender=function(){var a=this._viewport.getCamera();return 0===a.fullWidth||0===a.fullHeight?!1:this._needsRender||!this._idleSuspend||
this._viewport.needsRender()||this._textureRep.needsRender()};b.prototype.getFrameTask=function(){return this._frameTask};b.prototype.setLighting=function(a){r.vec3.set(this._lightDirection,0,0,0);for(var b=0,c=a.lights;b<c.length;b++){var d=c[b];if(d instanceof C.MainLight){r.vec3.negate(this._lightDirection,d.direction);break}}this._viewport.setLighting(a);this._needsRender=!0};b.prototype.ensureEdgeView=function(){return this._viewport.ensureEdgeView()};Object.defineProperty(b.prototype,"edgeView",
{get:function(){return this._viewport.edgeView},enumerable:!0,configurable:!0});b.prototype.getMainLightDirection=function(){return this._lightDirection};b.prototype.setViewParams=function(a){"backgroundColor"in a&&(this._needsRender=!0,this._backgroundColor=a.backgroundColor);"supersampleScreenshots"in a&&(this._supersampleScreenshots=a.supersampleScreenshots)};b.prototype.setRenderParams=function(a){this._needsRender=!0;void 0!==a.idleSuspend&&(this._idleSuspend=!!a.idleSuspend);this._viewport.setRenderParams(a)};
b.prototype.getRenderParams=function(){var a=this._viewport.getRenderParams();a.anisotropicFiltering=this._textureRep.getMaxAnisotropy();a.idleSuspend=this._idleSuspend;return a};Object.defineProperty(b.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!0,configurable:!0});b.prototype.has=function(a){return"s3tc"===a?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===a?!!this._rctx.capabilities.shaderTextureLOD:!1};b.prototype.modify=function(a,b,c,d){this._viewport.modify(a,
b,c,d)};b.prototype.setCamera=function(a){this._viewport.setCamera(a)};b.prototype.getCamera=function(){return this._viewport.getCamera()};b.prototype.getCanvas=function(){return this._canvas};b.prototype.getDrapedRenderer=function(){return this._drapedRenderer};b.prototype.takeScreenshot=function(a){var b=this,c=w.createResolver(function(){b._screenshotQueue=b._screenshotQueue.filter(function(a){return a.resolver!==c})});this._screenshotQueue.push({settings:a,resolver:c});this._needsRender=!0;return c.promise};
b.prototype.getFramebufferTexture=function(a){return this._viewport.getFramebufferTexture(a)};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._viewport.renderPlugins},enumerable:!0,configurable:!0});b.prototype._renderScreenshotOverlay=function(a,b,c){if(this.options.renderScreenshotOverlay){a.width=b.width;a.height=b.height;var d=a.getContext("2d"),m=this._viewport.getCamera().pixelRatio*c.pixelRatio;d.save();d.translate(0,b.height);d.scale(1,-1);c.region&&d.translate(-c.region.x,
-c.region.y);d.scale(m,m);this.options.renderScreenshotOverlay(a,b);d.restore()}};b.prototype._readbackScreenshot=function(a){return a.resample?this._readbackScreenshotResampled(a):this._readbackScreenshotImmediate(a)};b.prototype._readbackScreenshotResampled=function(a){var b=a.framebufferWidth,c=a.framebufferHeight,d=a.region,e=a.resample,h=this._ensureScreenshotEncodeCanvas(),g=l.createEmptyImageData(b,c,h);this._gl.readPixels(0,0,b,c,6408,5121,new Uint8Array(g.data.buffer));this._renderScreenshotOverlay(h,
g,q({},a,{region:null}));a=l.createEmptyImageData(d.width,d.height,h);return l.resampleHermite(g,a,!0,e.region.x,c-(e.region.y+e.region.height),e.region.width,e.region.height)};b.prototype._readbackScreenshotImmediate=function(a){var b=a.framebufferHeight,c=a.region,d=this._ensureScreenshotEncodeCanvas(),e=l.createEmptyImageData(c.width,c.height,d);this._gl.readPixels(c.x,b-(c.y+c.height),c.width,c.height,6408,5121,new Uint8Array(e.data.buffer));this._renderScreenshotOverlay(d,e,a);return e};b.prototype._renderScreenshot=
function(a){var b=null,c=this._viewport.getCamera(),d=l.screenshotSuperSampleSettings(a,this._supersampleScreenshots),e=d.framebufferWidth,h=d.framebufferHeight,g=!1,k=this._viewport.hasSlicePlane&&a.disableSlice;if(k=e!==c.fullWidth||h!==c.fullHeight||k){var f=c.copy();f.fullWidth=e;f.fullHeight=h;f.pixelRatio*=d.pixelRatio;b=c.fovX-f.fovX;g=c.fovY-f.fovY;0>b&&b<g?f.fovX=c.fovX:0>g&&g<b&&(f.fovY=c.fovY);this._drapedRenderer.forceUpdate&&this._drapedRenderer.forceUpdate(f);g=!0;b=new H(this._rctx,
{width:f.fullWidth,height:f.fullHeight,colorTarget:0,depthStencilTarget:3});this._rctx.bindFramebuffer(b);f.setGLViewport(this._rctx);this._rctx.setClearColor.apply(this._rctx,this._backgroundColor);this._rctx.clearSafe(16640);this._viewport.render({lightDirection:this._lightDirection,fbo:b,camera:f,disableSlice:a.disableSlice})}a=this._readbackScreenshot(d);if(k&&!this._rctx.contextAttributes.alpha)for(d=3;d<a.data.length;d+=4)a.data[d]=255;b&&b.dispose();this._rctx.bindFramebuffer(null);g&&this._drapedRenderer.forceUpdate&&
this._drapedRenderer.forceUpdate(c);return a};b.prototype._performScreenshots=function(){if(0!==this._screenshotQueue.length){for(var a=0,b=this._screenshotQueue;a<b.length;a++){var c=b[a],d=c.settings;if(this._gl){var e=this._ensureScreenshotEncodeCanvas(),h=this._renderScreenshot(d),d=l.encodeResult(h,d,e,{flipY:!0,premultipliedAlpha:!0});c.resolver(d)}else c.resolver.reject()}this._screenshotQueue=[]}};b.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=
document.createElement("canvas"));return this._screenshotEncodeCanvas};Object.defineProperty(b.prototype,"test",{get:function(){return{viewport:this._viewport}},enumerable:!0,configurable:!0});b.prototype.getGpuMemoryUsage=function(){return q({},this._viewport.getGpuMemoryUsage(),{draped:this._drapedRenderer?this._drapedRenderer.getGpuMemoryUsage():0})};return b}();var n={fbo:null,camera:null,lightDirection:t.vec3f64.create(),disableSlice:!1};return p});