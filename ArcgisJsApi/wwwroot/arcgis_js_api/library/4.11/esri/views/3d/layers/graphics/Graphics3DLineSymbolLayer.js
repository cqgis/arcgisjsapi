// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry".split(" "),
function(r,y,G,A,B,C,D,H,E,I,J,K,g,L,M,z,F,N,O,P){Object.defineProperty(y,"__esModule",{value:!0});r=function(r){function c(a,b,d,g){a=r.call(this,a,b,d,g)||this;d=a._getStageIdHint();b=null!=b.size?A.pt2px(b.size):1;b={idHint:d,width:b,color:a._getMaterialOpacityAndColor(),slicePlaneEnabled:a._context.slicePlaneEnabled};if(!a._isPropertyDriven("size")&&(d=M.validateSymbolLayerSize(b.width)))return a._logWarning(d),a.reject(),a;if(0>=b.width)return a.reject(),a;a._isPropertyDriven("size")&&(b.width=
0);a._material=z.createRibbonMaterial(b);a._context.stage.add(F.ModelContentType.MATERIAL,a._material);a.resolve();return a}G(c,r);c.prototype.destroy=function(){r.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(F.ModelContentType.MATERIAL,this._material.id),this._material=null)};c.prototype.createGraphics3DGraphic=function(a){var b=a.renderingInfo;a=a.graphic;var d=a.geometry;if("polyline"!==d.type&&"polygon"!==d.type&&"extent"!==d.type)return this._logWarning("unsupported geometry type for line symbol: "+
d.type),null;if(!this._validateGeometry(d))return null;var d="polygon"===d.type||"extent"===d.type?"rings":"paths",c="graphic"+a.uid,p=this._getVertexOpacityAndColor(b,Float32Array,255),t=0;b.size&&this._isPropertyDriven("size")&&(t=g.getSingleSizeDriver(b.size),t=A.pt2px(t));b=this.getGraphicElevationContext(a);return"on-the-ground"===b.mode?this._createAsOverlay(a,d,p,t,b,c,this._context.layer.uid):this._createAs3DShape(a,d,p,t,b,c,a.uid)};c.prototype.layerOpacityChanged=function(){var a=this._material.getColor(),
a={color:[a[0],a[1],a[2],this._getMaterialOpacity()]};this._material.setParameterValues(a);return!0};c.prototype.layerElevationInfoChanged=function(a,b,d){var c=this._elevationContext.mode;if(null==d||null==c)return!1;if("on-the-ground"===d&&"on-the-ground"===c)return!0;if(d!==c&&("on-the-ground"===d||"on-the-ground"===c))return!1;var p=g.needsElevationUpdates2D(c);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return p})};c.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
return!0};c.prototype.pixelRatioChanged=function(a,b){return!0};c.prototype._getOutlineGeometry=function(a,b){return b};c.prototype._getGeometry=function(a){a=a.geometry;"extent"===a.type&&(a=H.fromExtent(a));return a};c.prototype._createAs3DShape=function(a,b,d,c,p,t,r){var e=this._getGeometry(a),l=e[b],q=this._getOutlineGeometry(e,l);a=[];var f=[],v=[],u=D.vec3f64.create(),h=Array(6),e=g.getGeometryVertexData3D(q,e.hasZ,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,
this._context.renderCoordsHelper,p);this._logGeometryCreationWarnings(e,l,b,"LineSymbol3DLayer");if(0<q.length){for(var l=e.geometryData.outlines,q=e.eleVertexData,m=e.vertexData,n=0;n<l.length;++n){var w=l[n];if(!(1>=w.count)){var k=w.index,x=w.count;if(this._context.clippingExtent&&(g.computeBoundingBox(q,k,x,h),g.boundingBoxClipped(h,this._context.clippingExtent)))continue;g.chooseOrigin(m,k,x,u);g.subtractCoordinates(m,k,x,u);w=new Float64Array(q.buffer,3*k*q.BYTES_PER_ELEMENT,3*x);k=new Float64Array(m.buffer,
3*k*m.BYTES_PER_ELEMENT,3*x);k=z.createPolylineGeometry(k,w,"rings"===b,d,c);k=new N(k,t+"path"+n);k.singleUse=!0;a.push(k);f.push(this._material);k=C.mat4f64.create();B.mat4.translate(k,k,u);v.push(k)}}if(0<a.length)return b=new O({geometries:a,materials:f,transformations:v,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r},idHint:t}),b=new K(this,b,a,null,null,I.perVertexElevationAligner,p),b.alignedTerrainElevation=e.terrainElevation,b.needsElevationUpdates=g.needsElevationUpdates2D(p.mode),
b}return null};c.prototype._createAsOverlay=function(a,b,d,c,p,t,r){var e=this._getGeometry(a);this._material.renderPriority=this._symbolLayerOrder;var l=e[b],q=this._getOutlineGeometry(e,l);p=[];var f=Array(6),v=E.empty(),u=D.vec3f64.create(),e=g.getGeometryVertexDataDraped(q,e.spatialReference,this._context.overlaySR);this._logGeometryCreationWarnings(e,l,b,"LineSymbol3DLayer");if(0<q.length){l=e.vertexData;q=e.geometryData.outlines;for(e=0;e<q.length;++e){var h=q[e],m=h.index,h=h.count;g.computeBoundingBox(l,
m,h,f);if(!g.boundingBoxClipped(f,this._context.clippingExtent)){E.expand(v,f);g.chooseOrigin(l,m,h,u);g.subtractCoordinates(l,m,h,u);g.setZ(l,m,h,this._getDrapedZ());h=new Float64Array(l.buffer,3*m*l.BYTES_PER_ELEMENT,3*h);m=C.mat4f64.create();B.mat4.translate(m,m,u);var h=z.createPolylineGeometry(h,null,"rings"===b,d,c),n=new P(h);n.data.layerUid=r;n.data.graphicUid=a.uid;n.material=this._material;n.center=[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];n.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*
(f[4]-f[1]));n.transformation=m;n.name=t;n.uniqueName=t+"#"+h.id;p.push(n)}}return new J(this,p,v)}return null};return c}(L.default);y.Graphics3DLineSymbolLayer=r;y.default=r});