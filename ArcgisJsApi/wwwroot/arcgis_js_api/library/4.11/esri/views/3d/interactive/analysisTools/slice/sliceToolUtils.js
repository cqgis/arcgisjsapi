// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/compilerUtils ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/quat ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ./sliceToolConfig ../../../support/geometryUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../../interactive/manipulatorUtils".split(" "),
function(R,g,F,G,H,q,I,M,d,w,r,p,h,B,C,Q){function N(a,c,b,e,f,l){var n=d.vec3.dot(a,c),n=Math.abs(n)>r.VERTICAL_DOT_THRESHOLD?"vertical":"horizontal",m=h.sv3d.get(),k=h.sv3d.get(),t=function(){d.vec3.cross(m,c,b.viewUp);d.vec3.cross(k,c,m)},g=function(a){d.vec3.cross(k,a,c);d.vec3.copy(m,c)};if(G.isSome(e)&&e!==n)switch(e){case "vertical":t();break;case "horizontal":g(b.viewUp);break;default:F.neverReached(e)}else switch(n){case "vertical":t();break;case "horizontal":g(a);break;default:F.neverReached(n)}a=
d.vec3.cross(h.sv3d.get(),m,k);0<d.vec3.dot(a,b.viewForward)&&d.vec3.scale(k,k,-1);d.vec3.normalize(f,m);d.vec3.normalize(l,k)}function J(a,c){return Math.abs(d.vec3.dot(c.basis1,a))>Math.abs(d.vec3.dot(c.basis2,a))?1:2}function O(a){return{basis1Positive:{position:d.vec3.add(h.sv3d.get(),a.origin,a.basis1),rotationIdx:0},basis2Positive:{position:d.vec3.add(h.sv3d.get(),a.origin,a.basis2),rotationIdx:1},basis1Negative:{position:d.vec3.subtract(h.sv3d.get(),a.origin,a.basis1),rotationIdx:2},basis2Negative:{position:d.vec3.subtract(h.sv3d.get(),
a.origin,a.basis2),rotationIdx:3}}}function K(a,c,b){var e=b.projectPoint(d.vec3.add(h.sv3d.get(),a,c),H.castRenderScreenPointArray3(h.sv3d.get()));a=b.projectPoint(d.vec3.subtract(h.sv3d.get(),a,c),H.castRenderScreenPointArray3(h.sv3d.get()));return d.vec3.squaredLength(d.vec3.subtract(e,e,a))}function x(a){var c=d.vec3.length(a.basis1);a=d.vec3.length(a.basis2);return r.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(c,a)}function P(a,c,b,e){d.vec3.normalize(b,a.basis1);d.vec3.scale(b,b,-c.direction[0]*
c.scale);d.vec3.add(b,b,c.position);d.vec3.normalize(e,a.basis2);d.vec3.scale(e,e,-c.direction[1]*c.scale);d.vec3.add(e,e,c.position)}function D(a){return 0!==a.direction[0]&&0!==a.direction[1]}function L(a,c){return Math.abs(d.vec3.dot(a.plane,c))<=r.PERPENDICULAR_GROUND_DOT_THRESHOLD}Object.defineProperty(g,"__esModule",{value:!0});g.createPlane=function(a,c,b,e,f,l,n,m,k){m=m.worldUpAtPosition(a,h.sv3d.get());N(c,m,l,n,k.basis1,k.basis2);d.vec3.scale(k.basis1,k.basis1,e);d.vec3.scale(k.basis2,
k.basis2,f);d.vec3.copy(k.origin,c);d.vec3.scale(k.origin,k.origin,-b);d.vec3.add(k.origin,k.origin,a);return p.boundedPlane.fromValues(k.origin,k.basis1,k.basis2,k)};g.normalToBases=N;g.resizePlane=function(a,c,b,e,f,l){var n=d.vec3.copy(h.sv3d.get(),l.origin),m=d.vec3.copy(h.sv3d.get(),l.basis1),k=d.vec3.copy(h.sv3d.get(),l.basis2),t=d.vec3.copy(h.sv3d.get(),f.origin);d.vec3.add(t,t,d.vec3.scale(h.sv3d.get(),f.basis1,0>a.direction[0]?1:-1));d.vec3.add(t,t,d.vec3.scale(h.sv3d.get(),f.basis2,0>a.direction[1]?
1:-1));var g=d.vec3.length(f.basis1),q=d.vec3.length(f.basis2);b=d.vec3.subtract(h.sv3d.get(),b,t);var u=d.vec3.subtract(h.sv3d.get(),c,t),v=0;c=0;if(D(a)){var w=x(f),y=x(l),v=g-.5*a.direction[0]*d.vec3.dot(f.basis1,u)/g;c=q-.5*a.direction[1]*d.vec3.dot(f.basis2,u)/q;u=y/w;v*=u;c*=u}u=.5*a.direction[0]*d.vec3.dot(f.basis1,b)/g;w=.5*a.direction[1]*d.vec3.dot(f.basis2,b)/q;b=v+u;c+=w;g=d.vec3.scale(h.sv3d.get(),f.basis1,b/g);f=d.vec3.scale(h.sv3d.get(),f.basis2,c/q);0<b&&K(l.origin,g,e)>r.PLANE_MIN_BASIS_SCREEN_LEN2&&
d.vec3.copy(m,g);0<c&&K(l.origin,f,e)>r.PLANE_MIN_BASIS_SCREEN_LEN2&&d.vec3.copy(k,f);d.vec3.copy(n,t);d.vec3.add(n,n,d.vec3.scale(h.sv3d.get(),m,0>a.direction[0]?-1:1));d.vec3.add(n,n,d.vec3.scale(h.sv3d.get(),k,0>a.direction[1]?-1:1));return p.boundedPlane.fromValues(n,m,k,l)};g.calculatePlaneHalfSize=function(a,c){return r.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(c.width,c.height)*c.computeRenderPixelSizeAt(a)};g.createShiftPlane=function(a,c,b,e){b=d.vec3.cross(h.sv3d.get(),c,b);d.vec3.cross(b,
b,c);return p.plane.fromPositionAndNormal(a,b,e)};g.calculateBoundedPlaneTranslateRotate=function(a,c){return Q.calculateTranslateRotateFromBases(a.basis1,a.basis2,a.origin,c)};g.hideHandles=function(a,c,d){a.visible=!1;c.visible=!1;d.forEach(function(a){return a.visible=!1})};g.createRotatePlane=function(a,c,b){var e=c.worldUpAtPosition(a.origin,h.sv3d.get());c=L(a,e);e=J(e,a);c=d.vec3.copy(h.sv3d.get(),c?1===e?a.basis1:a.basis2:a.plane);return p.plane.fromPositionAndNormal(a.origin,c,b)};g.updateShiftRestartHandle=
function(a,c,b,e,f){if(a.forceHide)a.visible=!1;else{a.floating=!1;var l=e.worldUpAtPosition(b.origin,h.sv3d.get());e=L(b,l);var l=J(l,b),n=O(b);e=e&&2!==l?n.basis2Positive:n.basis1Positive;q.mat4.rotateZ(a.transform,c,e.rotationIdx*Math.PI/2);c=d.vec3.subtract(h.sv3d.get(),e.position,b.origin);d.vec3.normalize(c,c);c=d.vec3.scale(h.sv3d.get(),c,f.computeScreenPixelSizeAt(e.position)*r.SHIFT_RESTART_OFFSET_DISTANCE);d.vec3.add(c,c,e.position);e=f.projectPoint(c,H.castRenderScreenPointArray3(h.sv3d.get()));
var m=f.viewport,l=m[0],n=m[1],k=m[2],m=m[3],g=Math.min(k,m)/16,z=!1;e[0]<l+g?(e[0]=l+g,z=!0):e[0]>l+k-g&&(e[0]=l+k-g,z=!0);e[1]<n+g?(e[1]=n+g,z=!0):e[1]>n+m-g&&(e[1]=n+m-g,z=!0);l=z;p.ray.fromRender(f,e,E);d.vec3.normalize(E.direction,E.direction);e=h.sv3d.get();l&&p.boundedPlane.intersectRay(b,E,e)&&(a.floating=!0,c=e);b=f.computeScreenPixelSizeAt(c);q.mat4.scale(a.transform,a.transform,d.vec3.set(h.sv3d.get(),b,b,b));a.transform[12]=c[0];a.transform[13]=c[1];a.transform[14]=c[2];a.position=w.vec3f64.clone(c);
a.visible=!0}};g.updateShiftRestartObject=function(a,c,d){c.visible&&a(c.transform,d)};g.updateResizeHandles=function(a,c,b){var e=d.vec3.length(c.basis1),f=d.vec3.length(c.basis2),l=x(c),n=x(c);b.forEach(function(b){b.visible=!0;d.vec3.add(b.position,d.vec3.scale(h.sv3d.get(),c.basis1,b.direction[0]),d.vec3.scale(h.sv3d.get(),c.basis2,b.direction[1]));d.vec3.add(b.position,c.origin,b.position);var k=0;if(D(b))1===b.direction[0]&&-1===b.direction[1]?k=Math.PI/2:1===b.direction[0]&&1===b.direction[1]?
k=Math.PI:-1===b.direction[0]&&1===b.direction[1]&&(k=3*Math.PI/2),b.scale=n;else{var k=0!==b.direction[0]?1:2,g=1===k?f:e,k=1===k?Math.PI/2:0;b.scale=g-l}q.mat4.identity(b.transform);q.mat4.rotateZ(b.transform,b.transform,k);q.mat4.scale(b.transform,b.transform,d.vec3.set(h.sv3d.get(),b.scale,b.scale,b.scale));q.mat4.multiply(b.transform,a,b.transform);b.transform[12]=b.position[0];b.transform[13]=b.position[1];b.transform[14]=b.position[2]})};g.updateResizeHandleObjects=function(a,c,b){for(var d=
0;d<c.length;d++)(0,a[d])(c[d].transform,d===b)};g.updateRotateHeadingHandle=function(a,c,b,e,f,l){f.forceHide?f.visible=!1:(l=b.worldUpAtPosition(c.origin,h.sv3d.get()),b=L(c,l),l=J(l,c),c=O(c),c=b&&2!==l?c.basis2Negative:c.basis1Negative,q.mat4.identity(f.transform),q.mat4.rotateZ(f.transform,f.transform,c.rotationIdx*Math.PI/2),b&&q.mat4.rotateX(f.transform,f.transform,Math.PI/2),q.mat4.multiply(f.transform,a,f.transform),a=c.position,e=e.computeScreenPixelSizeAt(a),q.mat4.scale(f.transform,f.transform,
d.vec3.set(h.sv3d.get(),e,e,e)),f.transform[12]=a[0],f.transform[13]=a[1],f.transform[14]=a[2],f.position=w.vec3f64.clone(a),f.visible=!0)};g.updateRotateHeadingObject=function(a,c,b){c.visible&&a(c.transform,b)};g.intersectsShiftRestartHandle=function(a,c,b){if(!a.visible)return!1;for(var e=r.SHIFT_RESTART_TIP_RADIUS*("mouse"===b.pointerType?r.MOUSE_INPUT_FOCUS_MULTIPLIER:r.TOUCH_INPUT_FOCUS_MULTIPLIER)*b.camera.computeScreenPixelSizeAt(a.position),f=d.vec3.transformMat4(h.sv3d.get(),c[0],a.transform),
l=1;l<c.length;l++){var n=d.vec3.transformMat4(h.sv3d.get(),c[l],a.transform),f=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(f,n,y),b.ray);if(null!=f&&f<e*e)return!0;f=n}return!1};g.intersectsResizeHandle=function(a,c,b){if(!a.visible)return!1;var e=d.vec3.length(c.basis1),f=d.vec3.length(c.basis2),l=x(c),n=a.position,g=r.RESIZE_HANDLE_INPUT_RADIUS*("mouse"===b.pointerType?r.MOUSE_INPUT_FOCUS_MULTIPLIER:r.TOUCH_INPUT_FOCUS_MULTIPLIER)*b.camera.computeScreenPixelSizeAt(n);if(D(a))return l=
h.sv3d.get(),e=h.sv3d.get(),P(c,a,l,e),c=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(n,l,y),b.ray),b=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(n,e,y),b.ray),null!=c&&c<g*g||null!=b&&b<g*g;a=0!==a.direction[0]?1:2;c=1===a?c.basis2:c.basis1;a=1===a?f:e;c=d.vec3.scale(h.sv3d.get(),c,1-l/a);l=d.vec3.add(h.sv3d.get(),n,c);e=d.vec3.subtract(h.sv3d.get(),n,c);b=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(l,e,y),b.ray);return null!=b&&b<g*g};g.intersectsRotateHeadingHandle=
function(a,c,b){if(!a.visible)return!1;for(var e=r.ROTATE_HEADING_TIP_RADIUS*("mouse"===b.pointerType?r.MOUSE_INPUT_FOCUS_MULTIPLIER:r.TOUCH_INPUT_FOCUS_MULTIPLIER)*b.camera.computeScreenPixelSizeAt(a.position),f=d.vec3.transformMat4(h.sv3d.get(),c[0],a.transform),l=1;l<c.length;l++){var g=d.vec3.transformMat4(h.sv3d.get(),c[l],a.transform),f=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(f,g,y),b.ray);if(null!=f&&f<e*e)return!0;f=g}return!1};g.calculateScreenSpaceBasisLength2=K;g.calculateResizeHandlePadding=
x;g.calculateDiagonalResizeHandleScale=function(a){return x(a)};g.calculateDiagonalResizeHandleEndPositions=P;g.isDiagonalResizeHandle=D;g.createArrowGeometry=function(a,c,b){var e=function(f){var e=(f?c:a).slice(0),g=d.vec3.subtract(h.sv3d.get(),e[0],e[1]);d.vec3.normalize(g,g);var m=d.vec3.subtract(h.sv3d.get(),e[e.length-1],e[e.length-2]);d.vec3.normalize(m,m);if(0<b.padding){var k=d.vec3.scale(w.vec3f64.create(),m,-b.padding);e[e.length-1]=d.vec3.add(k,k,e[e.length-1]);b.bothEnds&&(k=d.vec3.scale(w.vec3f64.create(),
g,-b.padding),e[0]=d.vec3.add(k,k,e[0]))}var t=f?b.tipFocusMultiplier:1,k=b.tipLength*(b.focusTipLength?t:1),r=b.tipRadius*t,t=q.mat4.identity(h.sm4d.get());if(0<b.padding){var p=k/4,u=d.vec3.set(h.sv3d.get(),0,p,0),p=1+b.padding/p;q.mat4.translate(t,t,u);q.mat4.scale(t,t,d.vec3.set(h.sv3d.get(),p,p,p));q.mat4.translate(t,t,d.vec3.scale(u,u,-1/p))}p=q.mat4.identity(I.mat4f64.create());u=w.vec3f64.fromValues(0,1,0);m=q.mat4.fromQuat(I.mat4f64.create(),M.quat.rotationTo(h.sq4d.get(),u,m));m[12]=e[e.length-
1][0];m[13]=e[e.length-1][1];m[14]=e[e.length-1][2];q.mat4.multiply(m,m,t);f=b.tubeRadius*(f?b.tubeFocusMultiplier:1)+b.padding;var v=b.flat,x=[];if(G.isSome(v))x.push([f,v.thickness/2],[-f,v.thickness/2],[-f,-v.thickness/2],[f,-v.thickness/2]);else for(v=0;12>v;v++){var y=v/12*2*Math.PI;x.push([Math.cos(y)*f,Math.sin(y)*f])}f=C.createPathExtrusionGeometry(x,e,[],[],!1);f=[{part:"tube",geometry:new B(f,"arrow-tube"),transform:p}];var A;G.isSome(b.flat)?p=new B(C.createExtrudedTriangle(k,r,r,b.flat.thickness),
"arrow-tip"):(p=new B(C.createConeGeometry(k,r,24,!1,!1,!0),"arrow-tip"),A=new B(C.createConeGeometry(k,r,24,!1,!0,!1),"arrow-cap"));f.push({part:"tip",geometry:p,transform:m});A&&f.push({part:"cap",geometry:A,transform:m});b.bothEnds&&(g=q.mat4.fromQuat(I.mat4f64.create(),M.quat.rotationTo(h.sq4d.get(),u,g)),g[12]=e[0][0],g[13]=e[0][1],g[14]=e[0][2],q.mat4.multiply(g,g,t),f.push({part:"tip",geometry:p,transform:g}),A&&f.push({part:"cap",geometry:A,transform:g}));return f};return{normal:e(!1),focused:e(!0)}};
g.addArrowTips=function(a,c){var b=d.vec3.subtract(w.vec3f64.create(),a[a.length-1],a[a.length-2]);d.vec3.normalize(b,b);d.vec3.scale(b,b,r.ROTATE_HEADING_TIP_LENGTH);d.vec3.add(b,b,a[a.length-1]);return c?(c=d.vec3.subtract(w.vec3f64.create(),a[0],a[1]),d.vec3.normalize(c,c),d.vec3.scale(c,c,r.ROTATE_HEADING_TIP_LENGTH),d.vec3.add(c,c,a[0]),[c].concat(a,[b])):a.concat([b])};g.isAlwaysDrapedLayer=function(a){switch(a.type){case "building-scene":case "csv":case "feature":case "geo-rss":case "geojson":case "graphics":case "group":case "integrated-mesh":case "kml":case "map-notes":case "point-cloud":case "scene":case "stream":case "unknown":case "unsupported":case null:return!1;
case "base-dynamic":case "base-elevation":case "base-tile":case "bing-maps":case "elevation":case "imagery":case "map-image":case "open-street-map":case "tile":case "vector-tile":case "web-tile":case "wms":case "wmts":return!0;default:return F.neverReached(a.type),!1}};var y=p.lineSegment.create(),E=p.ray.create()});