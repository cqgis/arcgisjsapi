// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../symbols/callouts/calloutUtils ./ElevationAligners ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTexture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(p,r,y,e,z,A,B,C,D,t,E,w,F,G,H,I,x){function u(e,c,a){e&&e.forEach(function(b){var v=c(b);v&&a(v,b.graphic)})}Object.defineProperty(r,"__esModule",{value:!0});var J=[0,0,1];p=function(n){function c(a,b,c,d){a=n.call(this,a,b,c,d)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};if(!a._isPropertyDriven("size")&&(b=w.validateSymbolLayerSize(a.symbolLayer.size)))return a._logWarning(b),a.reject(),a;a._createTextRenderParameters();a.resolve();return a}y(c,n);c.prototype._createTextRenderParameters=
function(){this._textRenderParameters=H.default.fromSymbol(this.symbolLayer,this._context.layerView.view.pixelRatio)};c.prototype.destroy=function(){n.prototype.destroy.call(this);this.isFulfilled()||this.reject()};c.prototype.createGraphics3DGraphic=function(a){a=a.graphic;var b=t.placePointOnGeometry(a.geometry);if(!b)return this._logWarning("unsupported geometry type for text symbol: "+a.geometry.type),null;var c=this.symbolLayer.text;if(!c)return null;var d=B.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?
this.symbol:null;return this._createAs3DShape(a,b,c,d)};c.prototype.createLabel=function(a,b,c,d){a=a.graphic;var f=t.placePointOnGeometry(a.geometry);if(!f)return this._logWarning("unsupported geometry type for label: "+a.geometry.type),null;var e=b.text;return e?this._createAs3DShape(a,f,e,b,b,c,d):null};c.prototype.getGraphicElevationContext=function(a,b){void 0===b&&(b=0);a=n.prototype.getGraphicElevationContext.call(this,a);a.addOffsetRenderUnits(b);return a};c.prototype.layerOpacityChanged=
function(){this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");return!1};c.prototype.layerElevationInfoChanged=function(a,b){var c=this;u(a,b,function(a,b){c.updateGraphicElevationContext(b,a)});return!0};c.prototype.slicePlaneEnabledChanged=function(a,b){var c=this;u(a,b,function(a){var b=0;for(a=a.stageObject.geometryRecords;b<a.length;b++)a[b].material.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});return!0};c.prototype.pixelRatioChanged=
function(a,b){return!1};c.prototype.updateGraphicElevationContext=function(a,b){a=this.getGraphicElevationContext(a,b.metadata.elevationOffset);b.elevationContext.set(a);b.needsElevationUpdates=t.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode};c.prototype._defaultElevationInfoNoZ=function(){return K};c.prototype._createAs3DShape=function(a,b,c,d,f,h,l){void 0===f&&(f=L);var q=this.getGraphicElevationContext(a,f.elevationOffset),m=this._context.layer.id+"_label_"+a.uid,k="polyline"===
a.geometry.type,n=a.uid;a=this._context.stage.view.renderingContext;var g=w.namedAnchorToHUDMaterialAnchorPos[f.anchor in w.namedAnchorToHUDMaterialAnchorPos?f.anchor:"center"];a=e.isNone(l)?new I(a,c,this._textRenderParameters,m):null;g={occlusionTest:!0,screenOffset:f.screenOffset,anchorPos:g,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:f.centerOffsetUnits,debugDrawBorder:f.debugDrawBorder,drawInSecondSlot:!0};e.isSome(a)&&(g.textureId=a.id,g.texCoordScale=a.texcoordScale);e.isSome(l)&&(g.textureId=
l.textureId);if(e.isSome(d)&&e.isSome(d.verticalOffset)){d=d.verticalOffset;var p=d.minWorldLength,r=d.maxWorldLength;g.verticalOffset={screenLength:z.pt2px(d.screenLength),minWorldLength:p||0,maxWorldLength:null!=r?r:Infinity}}this._context.screenSizePerspectiveEnabled&&(d=this._context.sharedResources,p=d.screenSizePerspectiveSettings,g.screenSizePerspective=d.screenSizePerspectiveSettingsLabels.overridePadding(this._textRenderParameters.haloSize),g.screenSizePerspectiveAlignment=p);k&&(g.shaderPolygonOffset=
1E-4);g.slicePlaneEnabled=this._context.slicePlaneEnabled;k=null;d=JSON.stringify(g);e.isSome(h)?(k=h.getMaterial(d),null==k&&(k=new x(g,m),h.addMaterial(d,k))):k=new x(g,m);k=[k];l=G.createPointGeometry(J,f.translation,void 0,e.isSome(a)?[a.displayWidth,a.displayHeight]:[0,0],f.centerOffset,e.isSome(l)?[0,0]:null);l=[new F(l,m)];m=t.createStageObjectForPoint(this._context,b,l,k,null,null,q,m,this._context.layer.uid,n,!0);if(null===m)return null;n=C.perObjectElevationAligner;h=new D(this,m.object,
l,e.isNone(h)?k:null,e.isSome(a)?[a]:null,n,q);h.alignedTerrainElevation=m.terrainElevation;h.needsElevationUpdates=t.needsElevationUpdates2D(q.mode)||"absolute-height"===q.mode;var q=e.isSome(a)?a:f,u=q.displayWidth,v=q.displayHeight;h.getScreenSize=function(a){void 0===a&&(a=A.vec2f64.create());a[0]=u;a[1]=v;return a};h.metadata={labelText:c,elevationOffset:f.elevationOffset};t.extendPointGraphicElevationContext(h,b,this._context.elevationProvider);return h};return c}(E.default);r.Graphics3DTextSymbolLayer=
p;var K={mode:"relative-to-ground",offset:0},L={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};r.default=p});