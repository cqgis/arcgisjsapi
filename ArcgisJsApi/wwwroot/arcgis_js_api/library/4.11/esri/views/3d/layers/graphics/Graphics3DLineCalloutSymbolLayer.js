// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ./ElevationAligners ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./symbolComplexity ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Util ../../webgl-engine/materials/LineCalloutMaterial".split(" "),function(p,q,w,r,t,x,y,k,z,A,B,u,C,v,D,l){Object.defineProperty(q,"__esModule",
{value:!0});var e,h,f=D.VertexAttrConstants;p=function(e){function b(a,c){a=e.call(this,a,null,c,!0)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};c=a._getStageIdHint();a._createMaterialsAndAddToStage(a._context.stage,c);a.resolve();return a}w(b,e);b.prototype.destroy=function(){e.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id),this._material=null)};b.prototype.perInstanceMaterialParameters=
function(a){var c=this.materialParameters;c.screenOffset=a.screenOffset||[0,0];c.centerOffsetUnits=a.centerOffsetUnits||"world";return c};Object.defineProperty(b.prototype,"materialParameters",{get:function(){var a=this.symbol,c=a.callout,g=r.toUnitRGBA(c.color);g[3]*=this._getLayerOpacity();var b=t.pt2px(c.size||0),d=null;if(a.verticalOffset)var d=a.verticalOffset,m=d.minWorldLength,e=d.maxWorldLength,d={screenLength:t.pt2px(d.screenLength),minWorldLength:m||0,maxWorldLength:null!=e?e:Infinity};
c=c.border&&c.border.color?r.toUnitRGBA(c.border.color):null;m="object"===a.symbolLayers.getItemAt(0).type;return{color:g,size:b,verticalOffset:d,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:c,occlusionTest:!m,shaderPolygonOffset:m?0:void 0,depthHUDAlignStart:"label-3d"===a.type,slicePlaneEnabled:this._context.slicePlaneEnabled}},enumerable:!0,configurable:!0});
b.prototype._createMaterialsAndAddToStage=function(a,c){this._material=new l(this.materialParameters,c+"_lineCallout_common");a.add(u.ModelContentType.MATERIAL,this._material)};b.prototype._defaultElevationInfoNoZ=function(){return E};b.prototype.createGraphics3DGraphic=function(a){var c=a.renderingInfo;a=a.graphic;var g=this.getGraphicElevationContext(a,c.elevationOffset||0),b=c.symbol,d="on-the-ground"===this._elevationContext.mode&&!b.symbolLayers.some(function(a){return"object"===a.type||"text"===
a.type});if("label-3d"!==b.type&&d)return null;b=A.computeCentroid(a.geometry);return null==b?null:this._createAs3DShape(a,b,g,c,"graphic"+a.uid,a.uid)};b.prototype.layerOpacityChanged=function(){this._material.setParameterValues(this.materialParameters);return!0};b.prototype.layerElevationInfoChanged=function(a,c,b){var g=this,d=this._elevationContext.mode;if(b!==d&&("on-the-ground"===b||"on-the-ground"===d))return!1;a.forEach(function(a){var b=c(a);b&&g.updateGraphicElevationContext(a.graphic,b)});
return!0};b.prototype.slicePlaneEnabledChanged=function(a,c){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};b.prototype.pixelRatioChanged=function(a,c){return!0};b.prototype.getGraphicElevationContext=function(a,c){void 0===c&&(c=0);a=e.prototype.getGraphicElevationContext.call(this,a);a.addOffsetRenderUnits(c);return a};b.prototype.updateGraphicElevationContext=function(a,c){a=this.getGraphicElevationContext(a,c.metadata.elevationOffset);c.elevationContext.set(a);
c.needsElevationUpdates=k.needsElevationUpdates2D(a.mode)};b.prototype.computeComplexity=function(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,memory:B.emptySymbolComplexity.memory}};b.prototype.createVertexData=function(a){var c,b=a.translation;a=a.centerOffset;if(!b&&!a)return n;b=b?{size:3,data:[b[0],b[1],b[2]]}:n[f.POSITION];a=a?{size:4,data:[a[0],a[1],a[2],a[3]]}:n[f.AUXPOS1];return c={},c[f.POSITION]=b,c[f.NORMAL]=n[f.NORMAL],c[f.AUXPOS1]=a,c};b.prototype.getOrCreateMaterial=function(a,
c){var b=this.perInstanceMaterialParameters(a),e=l.uniqueMaterialIdentifier(b);if(e===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(a.materialCollection){var d=a.materialCollection.getMaterial(e);d||(d=new l(b,c+"_lineCallout_shared"),a.materialCollection.addMaterial(e,d));return{material:d,isUnique:!1}}d=new l(b,c+"_lineCallout_unique");return{material:d,isUnique:!0}};b.prototype._createAs3DShape=function(a,c,b,e,d,f){a=new v(this.createVertexData(e),F,v.DefaultOffsets,
"point");a=[new C(a,d)];var g=this.getOrCreateMaterial(e,d);d=k.createStageObjectForPoint(this._context,c,a,[g.material],null,null,b,d,this._context.layer.uid,f,!0);if(null===d)return null;f=new y(this,d.object,a,g.isUnique?[g.material]:null,null,x.perObjectElevationAligner,b);f.metadata={elevationOffset:e.elevationOffset||0};f.alignedTerrainElevation=d.terrainElevation;f.needsElevationUpdates=k.needsElevationUpdates2D(b.mode);k.extendPointGraphicElevationContext(f,c,this._context.elevationProvider);
return f};return b}(z.Graphics3DSymbolLayer);q.Graphics3DLineCalloutSymbolLayer=p;var n=(e={},e[f.POSITION]={size:3,data:[0,0,0]},e[f.NORMAL]={size:3,data:[0,0,1]},e[f.AUXPOS1]={size:4,data:[0,0,0,1]},e);e=new Uint32Array([0]);var F=(h={},h[f.POSITION]=e,h[f.NORMAL]=e,h[f.AUXPOS1]=e,h),E={mode:"relative-to-ground",offset:0};q.default=p});