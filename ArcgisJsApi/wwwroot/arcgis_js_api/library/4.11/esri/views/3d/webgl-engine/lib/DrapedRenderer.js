// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../support/debugFlags ../../webgl-engine/lib/intersectorUtils ./Camera ./DefaultVertexBufferLayouts ./glUtil3D ./GridLocalOriginFactory ./Renderer ../lighting/Lightsources ../materials/ColorMaterial ../materials/HUDMaterial ../materials/RibbonLineMaterial ../shaders/MiscPrograms ../../../webgl/FramebufferObject ../../../webgl/renderState ../../../webgl/Texture ../../../webgl/Util".split(" "),
function(v,O,r,l,A,w,B,C,D,E,F,G,H,I,J,K,L,M,t,N,x){v=function(){function b(a,c,f,b,h,e){var g=this;this._renderTargets={};this._clearColor=A.vec4f64.fromValues(0,0,0,0);this._uniqueIdx=0;this._localOrigins=new F;this._rctx=a;this._canvas=c;this._programRep=f;this._modelDirtySet=e;this._modelDirtySet.onMaterialChanged=function(a){return g.materialChanged(a)};this._renderer=new G(f,b,h,this._rctx,"draped");this._renderer.onHasHighlightsChanged=function(a){if(g.onHasHighlightsChanged)g.onHasHighlightsChanged(a)};
this._renderer.setLighting({lights:[new H.AmbientLight(l.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0})}b.prototype.dispose=function(){for(var a in this._renderTargets)this._renderTargets[a].dispose();this._renderTargets=null;this._renderer.dispose();this._renderer=null};b.prototype.createRenderTarget=function(a){return this.createRenderTargetInternal(a,!0)};b.prototype.createHighlightRenderTarget=function(a){return this.createRenderTargetInternal(a,!1)};b.prototype.disposeRenderTarget=
function(a){var c=this._renderTargets[a];c&&c.dispose();delete this._renderTargets[a]};b.prototype.getRenderTargetTexture=function(a){return(a=this._renderTargets[a])?a.colorTexture:null};b.prototype.addRenderGeometries=function(a){var c=this;a.forEach(function(a){null==a.origin&&(a.origin=c._localOrigins.getOrigin(a.center));a.idx=c._uniqueIdx++});this._renderer.modify(a,[]);if(this.onContentChanged)this.onContentChanged()};b.prototype.removeRenderGeometries=function(a){this._renderer.modify([],
a);if(this.onContentChanged)this.onContentChanged()};b.prototype.updateRenderGeometries=function(a,c){a=a.map(function(a){return{renderGeometry:a,updateType:c}});this._renderer.modify([],[],a);if(this.onContentChanged)this.onContentChanged()};b.prototype.updateRenderOrder=function(a){if(0<a.size&&(this._renderer.modifyRenderOrder(a),this.onContentChanged))this.onContentChanged()};b.prototype.setBackgroundColor=function(a){this._clearColor=a;if(this.onContentChanged)this.onContentChanged()};b.prototype.updateHighlights=
function(a){this.updateRenderGeometries(a,16)};b.prototype.isEmpty=function(){return this._renderer.isEmpty()&&!w.OVERLAY_DRAW_TEST_TEXTURE};b.prototype.processDirtyMaterials=function(){var a=this._modelDirtySet.getDirtyMaterials();a&&this._renderer.modify([],[],[],a);this._modelDirtySet.clearDirtyMaterials()};Object.defineProperty(b.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0});b.prototype.draw=function(a,c){return this.drawPass(0,
a,c)};b.prototype.drawHighlights=function(a,c){return this.drawPass(4,a,c)};b.prototype.drawPass=function(a,c,f){y=f.pixelRatio*Math.abs(f.views[0].extent[2]-f.views[0].extent[0])/Math.abs(f.views[0].viewport[2]-f.views[0].viewport[0]);if(this.isEmpty()||4===a&&!this.hasHighlights)return!1;this.processDirtyMaterials();if(!f.views.some(function(a){return a.extent[0]!==a.extent[2]&&a.extent[1]!==a.extent[3]}))return!1;c=this._renderTargets[c];if(!c)return!1;var b=this._rctx,h=f.width,e=f.height;if(c.width!==
h||c.height!==e)c.resize(h,e),c.colorTexture.setSamplingMode(9729);var g=u.camera;u.fbo=c;g.near=1;g.far=1E4;g.pixelRatio=f.pixelRatio||1;b.bindFramebuffer(c);b.setClearColor.apply(b,this._clearColor);b.clearSafe(16384);for(var d=0;d<f.views.length;d++){var k=f.views[d];g.viewport=k.viewport;r.mat4.ortho(g.projectionMatrix,0,k.extent[2]-k.extent[0],0,k.extent[3]-k.extent[1],g.near,g.far);r.mat4.identity(g.viewMatrix);r.mat4.translate(g.viewMatrix,g.viewMatrix,[-k.extent[0],-k.extent[1],0]);g.setGLViewport(this._rctx);
w.OVERLAY_DRAW_TEST_TEXTURE&&this._drawTestTexture(h,e,z[f.index%z.length]);this._renderer.renderPass(a,u)}b.bindFramebuffer(null);b.setViewport(0,0,this._canvas.width,this._canvas.height);c.colorTexture.descriptor.hasMipmap&&c.colorTexture.generateMipmap();return!0};b.prototype._drawTestTexture=function(a,c,b){var f=this._rctx;if(!this._testPatternTexture){for(var h=new Uint8Array(a*c*4),e=0,g=0;g<c;g++)for(var d=0;d<a;d++){var k=Math.floor(d/10),n=Math.floor(g/10);2>k||2>n||10*k>a-20||10*n>c-20?
(h[e++]=255,h[e++]=255,h[e++]=255,h[e++]=255):(h[e++]=255,h[e++]=255,h[e++]=255,k&1&&n&1?h[e++]=d&1^g&1?0:255:h[e++]=k&1^n&1?0:128)}this._testPatternTexture=new N(f,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:a,height:c},h);this._testPatternProgram=this._programRep.getProgram(L.texOnly);this._testPatternPipelineState=t.makePipelineState({blending:t.separateBlendingParams(770,1,771,771),colorWrite:t.defaultColorWriteParams});this._quadVAO=E.createQuadVAO(f,D.Pos3Tex)}a=this._testPatternProgram;
f.bindProgram(a);f.setPipelineState(this._testPatternPipelineState);a.setUniform4f("color",b[0],b[1],b[2],1);a.setUniform1i("tex",0);f.bindTexture(this._testPatternTexture,0);f.bindVAO(this._quadVAO);f.drawArrays(5,0,x.vertexCount(this._quadVAO,"geometry"))};b.prototype.materialChanged=function(a){if(this.onContentChanged)this.onContentChanged()};b.prototype.createRenderTargetInternal=function(a,c){for(var b=a,m=0;this._renderTargets[b];)b=a+"_"+ ++m;this._renderTargets[b]=M.createWithAttachments(this._rctx,
{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:c,maxAnisotropy:8,width:0,height:0},{colorTarget:0,depthStencilTarget:0});return b};b.prototype.getGpuMemoryUsage=function(){var a=0,c;for(c in this._renderTargets)a+=x.getGpuMemoryUsage(this._renderTargets[c]);return a};b.prototype.intersect=function(a,c,b){var f=this,h=0;this._renderer.forEachRenderGeometry(function(e){if(!b||b(e)){if(e.material instanceof I||e.material instanceof K||e.material instanceof J){var g=
e.transformation[12],d=e.transformation[13];p[0]=c[0]-g;p[1]=c[1]-d;p[2]=1;q[0]=c[0]-g;q[1]=c[1]-d;q[2]=0;e.pixelRatio=y;e.material.intersect(e,null,e.getShaderTransformation(),a,p,q,function(b,c,d,g,m,l){f.addIntersectionResult(b,c,d,e.material.renderPriority,h,m,l,a,e.data.layerUid,e.data.graphicUid)},e.calculateShaderTransformation,!0)}h++}})};b.prototype.addIntersectionResult=function(a,b,f,m,h,e,g,d,k,l){var c={type:"external",metadata:{layerUid:k,graphicUid:l}};a=function(a){a.set(c,null,d.results.terrain.dist,
d.results.terrain.normal,d.results.terrain.transformation,m,null,null,f,h);a.intersector="DrapedRenderer"};(null==d.results.min.drapedLayerOrder||m>=d.results.min.drapedLayerOrder)&&(null==d.results.min.dist||d.results.terrain.dist<=d.results.min.dist)&&a(d.results.min);(null==d.results.max.drapedLayerOrder||m<d.results.max.drapedLayerOrder)&&(null==d.results.max.dist||d.results.terrain.dist>d.results.max.dist)&&a(d.results.max);d.enable.storeAll&&(b=new B.IntersectorResult(d.ray),a(b),d.results.all.push(b))};
return b}();var y,z=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],u={fbo:null,camera:new C,lightDirection:l.vec3f64.fromValues(0,0,1)},p=l.vec3f64.create(),q=l.vec3f64.create();return v});