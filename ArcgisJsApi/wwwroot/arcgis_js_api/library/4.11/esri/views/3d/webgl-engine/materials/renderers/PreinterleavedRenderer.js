// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/Util ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(n,B,w,r,x,y,q,z,k,t,u,A){n=function(){function g(a,b,f){this._material=f;this._dataByOrigin=new Map;this._highlightCount=0;this._rctx=a;this._materialRep=b;this._glMaterials=
k.acquireMaterials(this._material,this._materialRep)}g.prototype.dispose=function(){k.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(g.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"hasHighlights",{get:function(){return 0<this._highlightCount},enumerable:!0,configurable:!0});g.prototype.renderPriority=function(){return this._material.renderPriority};g.prototype.modify=function(a){this.updateGeometries(a.toUpdate);
this.addAndRemoveGeometries(a.toAdd,a.toRemove);this.updateHighlightCount()};g.prototype.addAndRemoveGeometries=function(a,b){var f=this,e=this._rctx,d=this._dataByOrigin;a.forEach(function(c){var a=c.data;if(a.preinterleaved)if(null==a.vertexData)q.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else{var b=c.origin.id,h=c.origin.vec3,g=c.uniqueName,p=d.get(b);p||(p={origin:h,highlightCount:0,dataByGeometry:new Map},d.set(b,p));q.setMatrixTranslation3(v,-h[0],
-h[1],-h[2]);b=r.mat4f64.create();w.mat4.multiply(b,v,c.transformation);var h=k.generateRenderGeometryVisibleIndexRanges(c),n=k.generateRenderGeometryHighlightRanges(c);n&&(p.highlightCount=null);c=new z(c.name,0,a.indexCount,h,n,b,c.instanceParameters,c.idx,a.id);b=a.indexData?t.createIndex(e,35044,a.indexData):null;h=f._material.createBufferLayout();b=new A(e,y.Default3D,{geometry:x.glLayout(h)},{geometry:t.createVertex(e,35044)},b);b.vertexBuffers.geometry.setData(a.vertexData);a.indexData=null;
a.vertexData=null;p.dataByGeometry.set(g,{instance:c,vao:b})}else q.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")});b.forEach(function(a){var b=a.origin.id;a=a.uniqueName;var c=d.get(b);c.dataByGeometry.get(a).vao.dispose();c.dataByGeometry.delete(a);0===c.dataByGeometry.size&&d.delete(b)})};g.prototype.updateGeometries=function(a){var b=this;a.forEach(function(a){var e=a.updateType;a=a.renderGeometry;var d=a.uniqueName,c=b._dataByOrigin.get(a.origin.id);if(d=c&&c.dataByGeometry.get(d).instance)e&
1&&(d.displayedIndexRange=k.generateRenderGeometryVisibleIndexRanges(a)),e&17&&(d.highlightedIndexRanges=k.generateRenderGeometryHighlightRanges(a),c.highlightCount=null),e&2&&console.error("Updating Preinterleaved geometry not supported"),e&4&&k.calculateTransformRelToOrigin(a,d.transformation,d.transformationNormal)})};g.prototype.updateHighlightCount=function(){var a=this;this._highlightCount=0;this._dataByOrigin.forEach(function(b){if(null==b.highlightCount){var f=0;b.dataByGeometry.forEach(function(a){a.instance.highlightedIndexRanges&&
++f});b.highlightCount=f}a._highlightCount+=b.highlightCount})};g.prototype.render=function(a,b,f,e){var d=this,c=this._rctx,l=this._glMaterials.get(b.pass),g=4===b.pass;if(!l||null!=a&&!l.beginSlot(a)||g&&0===this._highlightCount)return!1;l.bind(c,f);var h=!1;this._dataByOrigin.forEach(function(a){g&&0===a.highlightCount||(f.origin=a.origin,l.bindView(c,f),g?a.dataByGeometry.forEach(function(a){h=d.renderInstanceHighlight(l,a,e)||h}):a.dataByGeometry.forEach(function(a){h=d.renderInstance(l,a,e)||
h}))});l.release(c,f);c.bindVAO(null);return h};g.prototype.renderInstance=function(a,b,f){var e=b.instance,d=b.vao,c=e.displayedIndexRange;if(c&&0===c.length)return!1;b=this._rctx;var g=a.getProgram(),m=a.getDrawMode();u.assertCompatibleVertexAttributeLocations(d,g);b.bindVAO(d);a.bindInstance(b,e);a=d.indexBuffer&&d.indexBuffer.indexType;c?a?k.drawElementsFaceRange(b,c,e.from,m,a,f):k.drawArraysFaceRange(b,c,e.from,m,f):(c=e.to-e.from,a?k.drawElements(b,m,a,e.from,c,f):k.drawArrays(b,m,e.from,c,
f));return!0};g.prototype.renderInstanceHighlight=function(a,b,g){var e=b.instance,d=b.vao;b=e.highlightedIndexRanges;if(!b)return!1;var c=this._rctx,f=a.getProgram(),m=a.getDrawMode();u.assertCompatibleVertexAttributeLocations(d,f);c.bindVAO(d);a.bindInstance(c,e);a=d.indexBuffer&&d.indexBuffer.indexType;f=!1;for(d=0;d<b.length;d++){var h=b[d],f=h.range?h.range[0]+e.from:e.from,h=h.range?h.range[1]-h.range[0]+1:e.to-e.from;a?k.drawElements(c,m,a,f,h,g):k.drawArrays(c,m,f,h,g);f=!0}return f};return g}();
var v=r.mat4f64.create();return n});