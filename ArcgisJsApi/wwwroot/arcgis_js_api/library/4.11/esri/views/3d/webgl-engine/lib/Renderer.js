// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/TimeProfiler ../../../../core/libs/gl-matrix-2/vec2f64 ../../support/debugFlags ../lib/Util ./BoundingInfo ./depthRange ./depthRangeUtils ./FxaaRenderPass ./HighlightHelper ./OffscreenRenderingHelper ./RenderContext ./RenderPluginManager ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./Util ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../../../webgl/Profiling ../../../webgl/Texture".split(" "),
function(n,Q,u,q,v,r,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O){function P(b,a){var c=new Map,e=null,d=null,g=function(a){if(a===e)return d;var b=c.get(a);b||(b={toAdd:[],toRemove:[],toUpdate:[]},c.set(a,b));e=a;return d=b};b.toAdd.forEach(function(a){1<=p(a.data)&&g(a.material).toAdd.push(a)});b.toRemove.forEach(function(a){1<=p(a.data)&&g(a.material).toRemove.push(a)});var f=0;b.toUpdate.forEach(function(a){1<=p(a.renderGeometry.data)&&(g(a.renderGeometry.material).toUpdate.push(a),f|=a.updateType)});
a&&(a.updateTypes=f);return c}function p(b){return!1===b.preinterleaved?J.getFirstObjectValue(b.indices).length:b.indexCount}function t(b,a){return b.isVisible()&&b.isVisibleInPass(a.pass)&&0!==(b.renderOccluded&a.renderOccludedMask)}n=function(){function b(a,c,e,d,g,f){var h=this;this._materialRenderers=new Map;this._orderedMaterialRenderers=[];this._hasHighlights=!1;this._lighting=new L.SceneLighting;this._content=new Map;this._isRendering=!1;this._needsRender=!0;this._fallbackDepthStencilTexture=
null;this._stats=new b.RenderStats;this._edgeView=null;this.renderOptions={antialiasing:"smaa"};this._programRep=a;this._materialRep=c;this._rctx=d;this._mode=g;this._stage=f;this._fxaaPass=new A(d);this._smaaPass=new H(d);this._bindParameters={view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,lightingData:null,viewport:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null};this._offscreenRendering=new C(a,this._rctx);this._sliceHelper=new G;"scene"===this._mode&&
(this._shadowMap=new F(this._rctx),this._ssaoHelper=new I(a,this._rctx,function(){h._needsRender=!0}),this._highlightHelper=new B(a,this._rctx));this._renderPlugins=new E.RenderPluginManager({rctx:d,programRep:a,textureRep:e,materialRep:c});this._renderContext=new D(d,this._offscreenRendering,this._lighting.getOld(),this._shadowMap,this._ssaoHelper,this._sliceHelper)}b.prototype.dispose=function(){this._materialRenderers.forEach(function(a){a.dispose()});this._orderedMaterialRenderers=this._materialRenderers=
null;this._edgeView&&(this._edgeView.destroy(),this._edgeView=null);this._offscreenRendering.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null);this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);x.tmpIndices.prune();this._content.clear();this._content=null};Object.defineProperty(b.prototype,
"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){var a=this;null==this._edgeView&&(this._edgeView=new K.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){return a._needsRender=!0}}),this._edgeView.initialize());return this._edgeView};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!0,configurable:!0});
b.prototype.setLighting=function(a){this._lighting.set(a)};b.prototype.setRenderParams=function(a){void 0!==a.shadowMapResolution&&!1===this._shadowMap.enabled&&(this._shadowMap.textureResolution=a.shadowMapResolution);void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==a.ssaoAttenuation&&(this._ssaoHelper.attenuation=
a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);a.background&&(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this.renderOptions.antialiasing=a.antialiasingEnabled?"smaa":"none");void 0!==a.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);
void 0!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane);this._needsRender=!0};Object.defineProperty(b.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!0,configurable:!0});b.prototype.getRenderParams=function(){var a={};this._shadowMap&&(a.shadowMap=this._shadowMap.enabled,a.shadowMapResolution=this._shadowMap.textureResolution,a.shadowMapMaxCascades=this._shadowMap.maxCascades);this._ssaoHelper&&this._ssaoHelper.isSupported&&(a.ssao=this._ssaoHelper.enabled,
a.ssaoAttenuation=this._ssaoHelper.attenuation,a.ssaoRadius=this._ssaoHelper.radius,a.ssaoFilterRadius=this._ssaoHelper.filterRadius,a.ssaoSamples=this._ssaoHelper.samples);return a};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0});b.prototype.resetNeedsRender=function(){this._needsRender=!1;this._renderPlugins.resetNeedsRender()};b.prototype.needsRender=function(){return this._needsRender||this._renderPlugins.needsRender()};
b.prototype.getCombinedStats=function(){this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;this._stats.VBOallocatedSize*=.00390625;this._stats.VBOusedSize*=.00390625;this._stats.VBOoptimalSize*=.00390625;return this._stats};b.prototype.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();
case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;case "highlight":return this._offscreenRendering.highlightTexture}return null};Object.defineProperty(b.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});b.prototype.isEmpty=function(){return 0===this._materialRenderers.size};b.prototype.modify=function(a,c,b,d){var e=this;void 0===b&&(b=[]);this._isRendering&&console.warn("Renderer.modify called while rendering");
for(var f=0;f<c.length;++f)this._content.delete(c[f].uniqueName);for(f=0;f<a.length;++f)this._content.set(a[f].uniqueName,a[f]);if(b)for(f=0;f<b.length;++f)w.assert(this._content.get(b[f].renderGeometry.uniqueName)===b[f].renderGeometry);if(a.length||c.length||b.length){var h=!1;P({toAdd:a,toRemove:c,toUpdate:b}).forEach(function(a,c){var b=e._materialRenderers.get(c);!b&&0<a.toAdd.length&&(b=c.createRenderer(e._rctx,e._materialRep),e._materialRenderers.set(c,b),e._orderedMaterialRenderers.push(b),
e.sortOrderedMaterialRenderers());b&&(b.modify(a),b.isEmpty&&(h=!0))});h&&this._materialRenderers.forEach(function(a,c){a.isEmpty&&(e._materialRenderers.delete(c),e._orderedMaterialRenderers.splice(e._orderedMaterialRenderers.indexOf(a),1),a.dispose())});var k=!1;this._materialRenderers.forEach(function(a){k=k||a.hasHighlights});if(k!==this._hasHighlights){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(k);this._hasHighlights=k}this._needsRender=!0}d&&(d.forEach(function(a){e._materialRep.updateMaterialParameters(a)}),
this._needsRender=!0)};b.prototype.modifyRenderOrder=function(a){"draped"===this._mode&&(this.sortOrderedMaterialRenderers(),this._needsRender=!0)};b.prototype.render=function(a){switch(this._mode){case "scene":this.renderScene(a);break;case "draped":this.renderDraped(a)}if(this.onPostRender)this.onPostRender()};b.prototype.renderPass=function(a,c){this.renderGeometryPass(a,c)};b.prototype.renderScene=function(a){var c=this;this._isRendering=!0;var b=this._rctx,d=this._offscreenRendering,g=this._ssaoHelper,
f=a.camera,h=a.fbo,k=this._sliceHelper.plane;a.disableSlice&&(this._sliceHelper.plane=null);this.prepareRender(f);this.renderShadowMap(a);d.enabled=!0;d.initializeFrame(f,h);this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth()?d.renderToTargets(function(){c.renderGeometryPass(1,a)},d.linearDepth,d.tmpDepth,[0,0,0,0],!0):d.disposeTarget(d.linearDepth);this._ssaoHelper.enabled?d.renderToTargets(function(){c.renderGeometryPass(2,a)},d.normal,d.tmpDepth,[0,0,0,0],!0):d.disposeTarget(d.normal);
this._ssaoHelper.enabled&&g.computeSSAO(f,d.linearDepthTexture,d.normalTexture);g.bindAll(this._programRep);this._stats.reset();this.updateGlobalUniforms(f.projectionMatrix);this._renderContext.pass=0;this._renderContext.camera=f;this._renderContext.options=this.renderOptions;d.bindTarget(d.mainColor,d.mainDepth);this._renderPlugins.render(0,this._renderContext);this.renderGeometrySlotsPt1(this._renderContext);this._edgeView&&this._edgeView.shouldRender()&&d.renderSeparateAndComposite(function(){return c._edgeView.render(c._bindParameters)},
void 0,"alpha");f=g=!1;g=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(17,this._renderContext);(f=this.renderTransparentTerrain(this._renderContext))&&g&&(d.compositeTransparentTerrainOntoHUDVisibility(),d.renderToTargets(function(){return c.renderHUD("occluded")},d.mainColor,d.tmpDepth,void 0,!0));f&&d.compositeTransparentTerrainOntoMain();d.renderToTargets(function(){c.renderInternalSlot(9,c._renderContext);c._renderPlugins.render(13,c._renderContext);c._renderPlugins.render(14,
c._renderContext)},d.mainColor,d.mainDepth);this.renderOccluded();g=this.renderOptions.antialiasing;"smaa"===g&&this._smaaPass.loadResources(function(){c._needsRender=!0});"smaa"===g&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:d.colorTexture},h)):"fxaa"===g&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:d.colorTexture},h)):(d.composite(),this._fxaaPass.disable(),this._smaaPass.disable());b.bindFramebuffer(h);this.renderHUD("notOccluded");
this.renderHighlights(a,h);this._sliceHelper.plane=k;this._isRendering=!1};b.prototype.renderDraped=function(a){this._stats.reset();this.renderGeometryPass(0,a)};b.prototype.prepareRender=function(a){this._renderPlugins.prepareRender(a)};b.prototype.renderShadowMap=function(a){var c=this._shadowMap,b=a.camera,d=a.fbo,g=a.lightDirection;if(c.enabled){r.ENABLE_PROFILE_DEPTH_RANGE&&q.begin("depthRange");var f=this.computeDepthRange(b);r.ENABLE_PROFILE_DEPTH_RANGE&&q.end("depthRange");c.prepare(b,g,f);
g=c.getCascades();for(f=0;f<g.length;++f){var h=g[f];h.camera.setGLViewport(this._rctx);a.camera=h.camera;this.renderGeometryPass(3,a)}a.camera=b;c.finish(d);b.setGLViewport(this._rctx)}c.bindAll(this._programRep)};b.prototype.computeDepthRange=function(a){var c=z.depthRangeFromScene(a,this._content,this._stage.getLayers());y.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};b.prototype.renderGeometryPass=function(a,c){this._isRendering=
!0;c=c.camera;this.updateGlobalUniforms(c.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=c;"draped"===this._mode?this.renderGeometryPassDraped(this._renderContext):this.renderGeometryPassScene(this._renderContext);this._isRendering=!1};b.prototype.renderGeometryPassDraped=function(a){var c=this,b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;l[0]=b.near;l[1]=b.far;
this._bindParameters.nearFar=l;this._bindParameters.lightingData=a.lightingData;this._bindParameters.viewport=b.fullViewport;this._bindParameters.pixelRatio=b.pixelRatio;this._bindParameters.slicePlane=a.sliceHelper&&a.sliceHelper.plane;this._bindParameters.highlightDepthTexture=this.getFallbackDepthTexture();this._orderedMaterialRenderers.forEach(function(b){b.render(null,a,c._bindParameters)})};b.prototype.renderGeometryPassScene=function(a){this.renderGeometrySlotsPt1(a);this.renderTransparentTerrain(a)};
b.prototype.renderGeometrySlotsPt1=function(a){this._renderPlugins.render(1,a);this.renderInternalSlot(2,a);this._renderPlugins.render(3,a);this.renderInternalSlot(4,a);this._renderPlugins.render(5,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._renderPlugins.render(12,this._renderContext);this.renderInternalSlot(6,a);this._renderPlugins.render(7,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep)};b.prototype.renderTransparentTerrain=function(a){return this._renderPlugins.render(8,
a)};b.prototype.renderHUDVisibility=function(a){var c=this,b=M.shouldRenderVisibilityDuringRenderPass(a.pass),d=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.enabled,g=!1;b&&d&&a.offscreenRenderingHelper.renderHUDVisibility(function(){g=c.renderInternalSlot(10,a)});return g};b.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(18,this._renderContext);this.renderInternalSlot(15,this._renderContext);this.renderInternalSlot(16,this._renderContext)};
b.prototype.renderHighlights=function(a,c){var b=this,d=this._highlightHelper;if(d&&d.enabled&&(this.hasHighlights||this._renderPlugins.needsHighlight())){var g=null;d.profilingCallback&&(g=N.startMeasurement(this._renderContext.rctx));var f=this._offscreenRendering,f=f.renderToTargets(function(){b.renderGeometryPass(4,a);b._rctx.clearSafe(256);b.renderHUD("both")},f.highlight,f.tmpDepth,[0,0,0,0],!0);d.render(a.camera,f,c);null!==g&&d.profilingCallback&&g.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};
b.prototype.renderOccluded=function(){var a=this;this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&1!==b.renderOccluded&&m.push(b)});if(0!==m.length){var b=this._offscreenRendering,e=this._renderContext,d=function(c,d){e.renderOccludedMask=d;b.renderToTargets(function(){a.renderInternalSlot(4,e,m);a.renderInternalSlot(6,e,m);a.renderInternalSlot(9,e,m)},b.tmpColor,b.tmpDepth,[0,0,0,0],!0);e.resetRenderOccludedMask();b.compositeOccludedOntoMain(c)};e.pass=0;d(.4,4);d(.5,2);d(1,8);m.length=
0}};b.prototype.renderInternalSlot=function(a,b,e){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;l[0]=b.camera.near;l[1]=b.camera.far;var c=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=l;this._bindParameters.lightingData=b.lightingData;this._bindParameters.viewport=
b.camera.fullViewport;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.enabled;this._bindParameters.pixelRatio=b.camera.pixelRatio;this._bindParameters.slicePlane=b.sliceHelper&&b.sliceHelper.plane;this._bindParameters.hudVisibilityTexture=c?c.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=c&&c.depthTexture||this.getFallbackDepthTexture();return this.renderInternalSlotMaterials(a,
b,e)};b.prototype.renderInternalSlotMaterials=function(a,b,e){var c=this,g=!1;u.isSome(e)?e.forEach(function(d){t(d,b)&&(g=c._materialRenderers.get(d).render(a,b,c._bindParameters)||g)}):this._materialRenderers.forEach(function(d,e){t(e,b)&&(g=d.render(a,b,c._bindParameters)||g)});return g};b.prototype.updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),e=0;e<b.length;e++)b[e].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");
for(e=0;e<b.length;e++)this._lighting.setUniforms(b[e]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(e=0;e<b.length;e++)this._lighting.setUniforms(b[e])}};b.prototype.sortOrderedMaterialRenderers=function(){"draped"===this._mode&&this._orderedMaterialRenderers.sort(function(a,b){return b.renderPriority()-a.renderPriority()})};b.prototype.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new O(this._rctx,{target:3553,pixelFormat:6408,
dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255])));return this._fallbackDepthStencilTexture};b.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};b.prototype.forEachRenderGeometry=function(a){this._content.forEach(function(b,
e){a(b)})};return b}();(function(b){var a=function(){function a(){this.reset()}a.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsPreinterleaved=this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=0};return a}();b.RenderStats=a})(n||(n={}));var l=v.vec2f64.create(),m=[];return n});