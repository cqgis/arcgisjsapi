// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper dojo/errors/CancelError ../../../../request ../../../../core/Error ../../../../core/lang ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/Version ../../../../geometry/support/aaBoundingBox ../../support/imageUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ka,e,la,g,h,D,W,X,Y,Z,q,P,k,aa,ba,ca,da,ea){function fa(b,d){if(d){var a=d.request(b,"json");return q.create(function(b,d){a.then(function(a){b(a.data)},function(a){d(a instanceof D?a:z(a.url))})},function(){d.cancelRequest(a)})}var l=W(b);return q.create(function(a,b){l.then(function(b){a(b.data)},function(a){b(a instanceof D?a:z(a))})},function(){l.cancel()})}function z(b){return new X("","Request for object resource failed: "+b)}function A(b,d){return h(this,void 0,void 0,function(){var a,
l,E,I,m,u,v,r,Q,F,R,J,S,K,G,B,q,x,e,h,k,y,D,z,A,L,M,w,C,T,t,N,U,O,V;return g(this,function(f){switch(f.label){case 0:return E=[],I=[],m=[],u=[],v=P.Version.parse(b.version||"1.0","wosr"),ga.validate(v),r="meshsymbol_"+b.model.name,Q=b.textureDefinitions,[4,ha(r,Q,d)];case 1:F=f.sent();for(R in F)u.push(F[R].engineTexObj);J=b.model.geometries;S=b.materialDefinitions;for(G=K=0;G<J.length;G++){var n=B=J[G],c=n.params,H=c.topology;f=!0;c.vertexAttributes||(p.warn("Geometry must specify vertex attributes"),
f=!1);switch(c.topology){case "PerAttributeArray":break;case "Indexed":case null:case void 0:H=c.faces;if(!H)p.warn("Indexed geometries must specify faces"),f=!1;else if(c.vertexAttributes){var g=void 0;for(g in c.vertexAttributes)(c=H[g])&&c.values?(null!=c.valueType&&"UInt32"!==c.valueType&&(p.warn("Unsupported indexed geometry indices type '"+c.valueType+"', only UInt32 is currently supported"),f=!1),null!=c.valuesPerElement&&1!==c.valuesPerElement&&(p.warn("Unsupported indexed geometry values per element '"+
c.valuesPerElement+"', only 1 is currently supported"),f=!1)):(p.warn("Indexed geometry does not specify face indices for '"+g+"' attribute"),f=!1)}break;default:p.warn("Unsupported topology '"+H+"'"),f=!1}n.params.material||(p.warn("Geometry requires material"),f=!1);n=n.params.vertexAttributes;c=void 0;for(c in n)n[c].values||(p.warn("Geometries with externally defined attributes are not yet supported"),f=!1);if(f){f=B.params;a=f.material;l=f.texture;q=B.params.vertexAttributes;x={};for(e in q)h=
q[e],k=h.values,x[e]={data:k,size:h.valuesPerElement};y={};if("PerAttributeArray"===B.params.topology){f=D=x.position.data.length/x.position.size;n=new Uint32Array(f);for(c=0;c<f;c++)n[c]=c;z=n;for(A in x)y[A]=z}else for(M in L=B.params.faces,L)y[M]=new Uint32Array(L[M].values);w=l?F[l]:null;C=m[a]?m[a][l]:null;C||(T=a.substring(a.lastIndexOf("/")+1),t=S[T].params,1===t.transparency&&(t.transparency=0),N=w&&w.alphaChannelUsage,U=0<t.transparency||"transparency"===N||"maskAndTransparency"===N,O={ambient:t.diffuse,
diffuse:t.diffuse,specular:[0,0,0],opacity:1-(t.transparency||0),transparent:U,textureAlphaMode:w?ia(w.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:w?w.engineTexObj.id:void 0,textureInitTransparent:!0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:t.externalColorMixMode||"tint",textureAlphaPremultiplied:!0},d&&d.materialParamsMixin&&Y.mixin(O,d.materialParamsMixin),C=new ea(O,r),m[a]||(m[a]={}),m[a][l]=C);I.push(C);V=new ba(new ca(x,y),r);K+=y.position?y.position.length:0;E.push(V)}}return[2,
{stageResources:{textures:u,materials:I,geometries:E},pivotOffset:b.model.pivotOffset,boundingBox:ja(E),numberOfVertices:K,lodThreshold:null}]}})})}function ja(b){var d=k.empty();b.forEach(function(a){a=a.boundingInfo;k.expand(d,a.getBBMin());k.expand(d,a.getBBMax())});return d}function ha(b,d,a){return h(this,void 0,void 0,function(){var l,e,h,m,u,v,r,k;return g(this,function(g){switch(g.label){case 0:l=[];e=function(e){var g=d[e],h=g.images[0].data;if(!h)return p.warn("Externally referenced texture data is not yet supported"),
"continue";var h=g.encoding+";base64,"+h,k="/textureDefinitions/"+e,m={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0};e=a&&a.disableTextures?q.resolve(null):aa.requestImage(h);l.push(e.then(function(a){return{refId:k,engineTexObj:new da(a,b,m),alphaChannelUsage:"rgba"===g.channels?g.alphaChannelUsage||"transparency":"none"}}))};for(h in d)e(h);return[4,q.all(l)];case 1:m=g.sent();u={};v=0;for(r=m;v<r.length;v++)k=r[v],u[k.refId]=k;return[2,u]}})})}function ia(b){switch(b){case "mask":return"mask";
case "maskAndTransparency":return"maskBlend";case "none":return"opaque";case "transparency":return"blend";default:return"blend"}}Object.defineProperty(e,"__esModule",{value:!0});var p=Z.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");e.load=function(b,d){return h(this,void 0,void 0,function(){var a;return g(this,function(e){switch(e.label){case 0:return[4,fa(b,d.streamDataSupplier)];case 1:return a=e.sent(),[2,A(a,d)]}})})};e.createStageResources=A;var ga=new P.Version(1,2,"wosr")});