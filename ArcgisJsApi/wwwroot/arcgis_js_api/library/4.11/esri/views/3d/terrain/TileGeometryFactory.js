// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/libs/gl-matrix-2/vec4 ../../../geometry/support/aaBoundingBox ../support/ArrayPool ../support/earthUtils ../support/mathUtils ./TerrainConst".split(" "),function(da,M,U,V,ca,N,P,v){function Q(b,d,g){for(var f=0;f<g.length;f++){var k=g[f];if(k){var F=k.safeWidth,h=k.width,l=k.pixelData,z=P.clamp(k.dy*(k.y1-d),0,F),k=P.clamp(k.dx*(b-k.x0),0,F),F=Math.floor(z),a=Math.floor(k),p=F*h+a,A=p+h,x=l[p],h=l[A],p=l[p+1],l=l[A+1];if(x+h+p+l<.5*v.ELEVATION_NODATA_VALUE)return z-=
F,k-=a,b=x+(p-x)*k,b+(h+(l-h)*k-b)*z}}return null}function W(b,d,g,f){var k=0<(g&2),v=d+(f?1024:0)+(k?2048:0),h=R.get(v);if(!h){var h=d-1,l=d-1,z=d*d,a=2*h+2*l,p=h*l*6,A=6*a,x=6*(2*h+l-1);f&&(p*=2,A*=2,x*=2);for(var a=65536<z+a?new Uint32Array(p+A):new Uint16Array(p+A),G=0,n=0,e=p,r,B,m,u,J=0,c=0;c<=l;c++){k&&(J=0===c?x:c===l?-x:0);for(var e=e+J,t=0;t<=h;t++)m=S(t,c,h,l),-1<m&&(u=0===c&&t!==h?1:t===h&&c!==l?h+1:c===l&&0!==t?-1:0===t&&0!==c?-(h+1):0,0!==u&&(r=G,B=z+m,m=z+(0===t&&1===c?0:m+1),u=G+u,
f?(a[e+0]=r,a[e+1]=B,a[e+2]=B,a[e+3]=m,a[e+4]=m,a[e+5]=r,a[e+6]=m,a[e+7]=u,a[e+8]=u,a[e+9]=r,a[e+10]=r,a[e+11]=m,e+=12):(a[e+0]=r,a[e+1]=B,a[e+2]=m,a[e+3]=m,a[e+4]=u,a[e+5]=r,e+=6))),++G,t<h&&c<l&&(r=c*(h+1)+t,B=r+1,m=B+(h+1),u=m-1,f?(a[n+0]=r,a[n+1]=B,a[n+2]=B,a[n+3]=m,a[n+4]=m,a[n+5]=r,a[n+6]=m,a[n+7]=u,a[n+8]=u,a[n+9]=r,a[n+10]=r,a[n+11]=m,n+=12):(a[n+0]=r,a[n+1]=B,a[n+2]=m,a[n+3]=m,a[n+4]=u,a[n+5]=r,n+=6));e-=J}h={values:a,numSurfaceIndices:p,numSkirtIndices:A};R.set(v,h)}b.indices=h.values;b.numSurfaceIndices=
h.numSurfaceIndices;b.numSkirtIndices=h.numSkirtIndices;b.numWithoutSkirtIndices=b.numSurfaceIndices+(g?6*(d-1)*(f?2:1):0)}function T(b,d,g,f){b<f[0]&&(f[0]=b);b>f[3]&&(f[3]=b);d<f[1]&&(f[1]=d);d>f[4]&&(f[4]=d);g<f[2]&&(f[2]=g);g>f[5]&&(f[5]=g)}function X(b,d){var g=d>b?1:0;return 2+4*g+(1-2*g)*(b+d)}function S(b,d,g,f){return 0===d?b:b===g?g+d:d===f?g+f+(g-b):0===b&&0<d?2*g+f+(f-d):-1}Object.defineProperty(M,"__esModule",{value:!0});var O=new ca.ArrayPool(Float32Array);M.clearCaches=function(){O.clear();
R.clear()};M.releaseGeometry=function(b){O.put(b.vertexAttributes);b.vertexAttributes=null;b.indices=null};M.elevationSampler=Q;M.createSphericalGlobeTile=function(b,d,g,f,k,F,h,l){var z=g[0],a=g[1],p=g[2];g=g[3];var A=.1*N.earthRadius*(g-a),x=b.numVertsPerRow-1,G=b.numVertsPerRow-1,n=b.numVertsPerRow*b.numVertsPerRow,e=O.get((n+(2*x+2*G))*v.GEOMETRY_VERTEX_STRIDE),r=l.geometryInfo.boundingBox;V.empty(r);var B=d[2]-d[0],m=d[3]-d[1],u=p-z,p=k[0],J=k[1];k=k[2];for(var c=0;c<=x;c++){var t=c/x,C=z+t*
u;Y[c]=Math.sin(C);Z[c]=Math.cos(C);aa[c]=t;ba[c]=d[0]+t*B}z=f&&!!(F&1);B=f&&!!(F&2);for(C=u=0;C<=G;C++){var I=C/G,c=P.lerp(a,g,I),H=Math.cos(c),L=Math.sin(c),K=void 0;f?(K=N.earthRadius/2*Math.log((1+L)/(1-L)),I=(K-d[1])/m):K=180*c/Math.PI;for(c=0;c<=x;c++){var t=aa[c],q=Y[c],E=Z[c],y=N.earthRadius;b.samplerData&&(y+=Q(ba[c],K,b.samplerData)||0);E=E*H*y-p;q=q*H*y-J;y=L*y-k;T(E,q,y,r);var w=v.GEOMETRY_VERTEX_STRIDE*u;e[w+0]=E;e[w+1]=q;e[w+2]=y;e[w+3]=t;e[w+4]=I;w=S(c,C,x,G);if(-1<w){var w=v.GEOMETRY_VERTEX_STRIDE*
(n+w),D=z&&0===C?-1:B&&C===G?1:0,E=0===D?E:-p,q=0===D?q:-J,y=0===D?y:N.earthRadius*D-k;e[w+0]=E;e[w+1]=q;e[w+2]=y;e[w+3]=0===D?X(t,I):t;e[w+4]=0===D?A:I;0!==D&&T(E,q,y,r)}++u}}l.geometryInfo.numVertsPerRow=b.numVertsPerRow;l.geometryInfo.vertexAttributes=e;l.geometryInfo.skirtLength=A;U.vec4.set(l.geometryInfo.uvOffsetAndScale,0,0,1,1);W(l.geometryInfo,b.numVertsPerRow,f?F:0,h)};M.createPlanarGlobeTile=function(b,d,g,f,k){var F=d[0],h=d[1],l=d[2]-F,z=d[3]-h,a=b.clippingArea,p=a?Math.max(0,(a[0]-d[0])/
l):0,A=a?Math.max(0,(a[1]-d[1])/z):0,x=a?Math.min(1,(a[2]-d[0])/l):1;d=a?Math.min(1,(a[3]-d[1])/z):1;var G=x>p?1/(x-p):1,n=d>A?1/(d-A):1,e=-p*G,r=-A*n,B=.1*l,m=b.numVertsPerRow-1,u=b.numVertsPerRow-1,J=b.numVertsPerRow*b.numVertsPerRow,c=O.get((J+(2*m+2*u))*v.GEOMETRY_VERTEX_STRIDE),t=k.geometryInfo.boundingBox;V.empty(t);for(var C=0,I=0;I<=u;I++){var H=I/u,L=r+H*n,H=h+H*z;a&&(H<a[1]?(H=a[1],L=0):H>a[3]&&(H=a[3],L=1));for(var K=0;K<=m;K++){var q=K/m,E=e+q*G,q=F+q*l;a&&(q<a[0]?(q=a[0],E=0):q>a[2]&&
(q=a[2],E=1));var y=b.samplerData?Q(q,H,b.samplerData)||0:0,q=q-g[0],w=H-g[1],y=y-g[2];T(q,w,y,t);c[v.GEOMETRY_VERTEX_STRIDE*C]=q;c[v.GEOMETRY_VERTEX_STRIDE*C+1]=w;c[v.GEOMETRY_VERTEX_STRIDE*C+2]=y;c[v.GEOMETRY_VERTEX_STRIDE*C+3]=E;c[v.GEOMETRY_VERTEX_STRIDE*C+4]=L;var D=S(K,I,m,m);-1<D&&(D=v.GEOMETRY_VERTEX_STRIDE*(J+D),c[D]=q,c[D+1]=w,c[D+2]=y,c[D+3]=X(E,L),c[D+4]=B);++C}}k.geometryInfo.numVertsPerRow=b.numVertsPerRow;k.geometryInfo.vertexAttributes=c;k.geometryInfo.skirtLength=B;U.vec4.set(k.geometryInfo.uvOffsetAndScale,
p,A,x-p,d-A);W(k.geometryInfo,b.numVertsPerRow,0,f)};var R=new Map,Y=Array(v.MAX_TILE_TESSELATION+1),Z=Array(v.MAX_TILE_TESSELATION+1),aa=Array(v.MAX_TILE_TESSELATION+1),ba=Array(v.MAX_TILE_TESSELATION+1)});