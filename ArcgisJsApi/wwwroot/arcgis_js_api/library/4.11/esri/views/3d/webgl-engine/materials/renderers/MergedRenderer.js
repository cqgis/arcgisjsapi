// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/Float32ArrayList ../../lib/IntervalUtilities ../../lib/Util ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(y,M,w,r,C,D,E,z,v,F,m,G,x,H){function I(g,a,b,e){for(var h=new Map,l=a.vertexBufferLayout.stride/4,c=function(f,e){var b=
f.origin,c=g.get(b.id),d=h.get(b.id);null==d&&(d={optimalCount:null==c?0:c.optimalCount,sparseCount:null==c?0:c.buffer.getSize(),toAdd:[],toRemove:[],origin:b.vec3},h.set(b.id,d));b=a.elementCount(f.data)*l;e?(d.optimalCount+=b,d.sparseCount+=b,d.toAdd.push(f)):(d.optimalCount-=b,d.toRemove.push(f))},k=0;k<b.length;k++){var d=b[k];c(d,!0)}for(b=0;b<e.length;b++)d=e[b],c(d,!1);return h}y=function(){function g(a,b,e){this._dataByOrigin=new Map;this._highlightCount=0;this._rctx=a;this._material=e;this._materialRep=
b;this._glMaterials=m.acquireMaterials(this._material,this._materialRep);this._bufferWriter=e.createBufferWriter()}g.prototype.dispose=function(){m.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(g.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"hasHighlights",{get:function(){return 0<this._highlightCount},enumerable:!0,configurable:!0});g.prototype.renderPriority=function(){return this._material.renderPriority};
g.prototype.modify=function(a){var b=this,e=J;e.clear();this.updateGeometries(a.toUpdate,e);this.addAndRemoveGeometries(a.toAdd,a.toRemove,e);this.updateHighlightCount();e.forEach(function(a){return b.updateDisplayedIndexRanges(a)})};g.prototype.addAndRemoveGeometries=function(a,b,e){var h=this,l=this._material,c=this._bufferWriter,k=c.vertexBufferLayout,d=k.stride/4,f=this._dataByOrigin,A=I(f,c,a,b);A.forEach(function(a,b){A.delete(b);var c=a.optimalCount,g=a.sparseCount,n=f.get(b);null==n&&(v.assert(0<
c),n=h.createData(k,c,a.origin),f.set(b,n));if(0===c)n.vao.dispose(!0),n.vao=null,f.delete(b);else{var t=(b=c<a.sparseCount/2)?c:g,c=K,g=n.buffer.getSize(),m=n.buffer.getArray(),t=n.buffer.resize(t);b||t?h.removeAndRebuild(n,a.toRemove,d,m,c):0<a.toRemove.length?(h.removeByErasing(n,a.toRemove,d,c),0<a.toAdd.length&&(c.end=g)):(c.begin=g,c.end=g);b=L;v.setMatrixTranslation3(b,-a.origin[0],-a.origin[1],-a.origin[2]);h.append(n,l,a.toAdd,d,b,c);a=n.vao.vertexBuffers.geometry;a.byteSize!==n.buffer.getArray().buffer.byteLength?
a.setData(n.buffer.getArray()):(m=c.begin,b=c.end,m<b&&(g=n.buffer.getArray(),m*=4,a.setSubData(g,m,m,4*b)));(c.updatedDisplayedIndexRange||n.displayedIndexRanges)&&e.add(n)}})};g.prototype.updateGeometries=function(a,b){for(var e=this._bufferWriter,h=e.vertexBufferLayout.stride/4,l=0;l<a.length;l++){var c=a[l],k=c.updateType,c=c.renderGeometry,d=this._dataByOrigin.get(c.origin.id),f=d&&d.instances.get(c.uniqueName);if(!f)break;k&1&&(f.displayedIndexRange=m.generateRenderGeometryVisibleIndexRanges(c),
b.add(d));k&17&&(f.highlightedIndexRanges=m.generateRenderGeometryHighlightRanges(c),d.highlightCount=null);k&6&&(k=d.buffer.getArray(),d=d.vao,m.calculateTransformRelToOrigin(c,u,q),e.write({transformation:u,invTranspTransformation:q},c.data,c.instanceParameters,e.vertexBufferLayout.createView(k.buffer),f.from),v.assert(f.from+e.elementCount(c.data)===f.to,"material VBO layout has changed"),d.vertexBuffers.geometry.setSubData(k,f.from*h*4,f.from*h*4,f.to*h*4))}};g.prototype.updateDisplayedIndexRanges=
function(a){var b=a.instances;a.displayedIndexRanges=[];var e=!0;b.forEach(function(b){b.displayedIndexRange?(a.displayedIndexRanges.push.apply(a.displayedIndexRanges,z.offsetIntervals(b.displayedIndexRange,b.from)),e=!1):a.displayedIndexRanges.push([b.from,b.to-1])});a.displayedIndexRanges=e?null:z.mergeIntervals(a.displayedIndexRanges)};g.prototype.updateHighlightCount=function(){var a=this;this._highlightCount=0;this._dataByOrigin.forEach(function(b){if(null==b.highlightCount){var e=0;b.instances.forEach(function(a){a.highlightedIndexRanges&&
++e});b.highlightCount=e}a._highlightCount+=b.highlightCount})};g.prototype.render=function(a,b,e,h){var l=this,c=this._rctx,k=this._glMaterials.get(b.pass),d=4===b.pass;if(!k||null!=a&&!k.beginSlot(a)||d&&0===this._highlightCount)return!1;k.bind(c,e);a=k.getProgram();a.setUniformMatrix4fv("model",B);a.hasUniform("modelNormal")&&a.setUniformMatrix4fv("modelNormal",B);var f=!1;this._dataByOrigin.forEach(function(a){d&&0===a.highlightCount||(e.origin=a.origin,k.bindView(c,e),f=d?l.renderHighlightPass(k,
a,h)||f:l.renderDefaultPass(k,a,h)||f)});k.release(c,e);return f};g.prototype.renderDefaultPass=function(a,b,e){var h=this._rctx,l=a.getProgram();a=a.getDrawMode();var c=b.displayedIndexRanges;if(c&&0===c.length)return!1;x.assertCompatibleVertexAttributeLocations(b.vao,l);h.bindVAO(b.vao);c?m.drawArraysFaceRange(h,c,0,a,e):m.drawArrays(h,a,0,x.vertexCount(b.vao,"geometry"),e);return!0};g.prototype.renderHighlightPass=function(a,b,e){var h=this._rctx,l=a.getProgram(),c=a.getDrawMode();a=b.vao;x.assertCompatibleVertexAttributeLocations(a,
l);h.bindVAO(a);var k=!1;b.instances.forEach(function(a){var b=a.highlightedIndexRanges;if(b&&0!==b.length)for(var d=0;d<b.length;d++){var l=b[d];m.drawArrays(h,c,l.range?l.range[0]+a.from:a.from,l.range?l.range[1]-l.range[0]+1:a.to-a.from,e);k=!0}});return k};g.prototype.createData=function(a,b,e){return{instances:new Map,vao:new H(this._rctx,D.Default3D,{geometry:C.glLayout(a)},{geometry:G.createVertex(this._rctx,35044)}),buffer:new E(b),optimalCount:0,origin:e,highlightCount:0}};g.prototype.removeAndRebuild=
function(a,b,e,h,l){for(var c=0;c<b.length;c++){var k=b[c].uniqueName,d=a.instances.get(k);a.optimalCount-=(d.to-d.from)*e;a.instances.delete(k)}var f=0,g=a.buffer.getArray();l.begin=0;l.end=0;var m=-1,p=-1,q=0;a.instances.forEach(function(a){var b=a.from*e,c=a.to*e,d=c-b;m!==p&&p!==b?(g.set(h.subarray(m,p),q),q+=p-m,m=b):-1===m&&(m=b);p=c;a.from=f/e;f+=d;a.to=f/e});m!==p&&g.set(h.subarray(m,p),q);l.end=f};g.prototype.removeByErasing=function(a,b,e,h){if(0!==b.length){h.begin=Infinity;h.end=-Infinity;
for(var l=-1,c=-1,k=0;k<b.length;k++){var d=b[k].uniqueName,f=a.instances.get(d),g=f.from*e,f=f.to*e;l!==c&&c!==g?(a.buffer.erase(l,c),l=g):-1===l&&(l=g);c=f;a.instances.delete(d);a.optimalCount-=f-g;g<h.begin&&(h.begin=g);f>h.end&&(h.end=f)}l!==c&&a.buffer.erase(l,c)}};g.prototype.append=function(a,b,e,g,l,c){c.updatedDisplayedIndexRange=!1;b=this._bufferWriter;for(var k=0;k<e.length;k++){var d=e[k],f=d.data;w.mat4.multiply(u,l,d.transformation);w.mat4.invert(q,u);w.mat4.transpose(q,q);var h=c.end;
b.write({transformation:u,invTranspTransformation:q},f,d.instanceParameters,b.vertexBufferLayout.createView(a.buffer.getArray().buffer),c.end/g);var f=b.elementCount(f)*g,t=h+f;v.assert(null==a.instances.get(d.uniqueName));var p=m.generateRenderGeometryVisibleIndexRanges(d),r=m.generateRenderGeometryHighlightRanges(d);r&&(a.highlightCount=null);h=new F(d.name,h/g,t/g,p,r,void 0,void 0,d.idx);a.instances.set(d.uniqueName,h);p&&(c.updatedDisplayedIndexRange=!0);a.optimalCount+=f;c.end+=f}};return g}();
var K={updatedDisplayedIndexRange:!1,begin:0,end:0},L=r.mat4f64.create(),u=r.mat4f64.create(),q=r.mat4f64.create(),B=r.mat4f64.create(),J=new Set;return y});