// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Point ../PropertiesPool ./PointOfInterest".split(" "),function(d,g,n,e,p,c,h,k,l,q,r){Object.defineProperty(g,"__esModule",{value:!0});var t=Array;d=function(d){function a(b){b=d.call(this,b)||this;b._dirtyTimeStamp=
0;b.propertiesPool=new q.default({location:l,renderLocation:t},b);b.estimatedSurfaceAltitude=0;b.pendingElevationQuery=null;b.renderLocation=k.vec3f64.create();return b}n(a,d);a.prototype.initialize=function(){var b=this;null!=this.scheduler&&this.handles.add(this.scheduler.registerTask(1,function(){return b.measureSurfaceAltitude()},function(){return b.needsUpdate()}));this.measureSurfaceAltitude();if(this.map){var a=function(){return b._setDirty()};this.handles.add([p.on(this.map,"ground.layers",
"change",a,a,a)])}};a.prototype.destroy=function(){this.cancelPendingRequest();this.propertiesPool.destroy();this.propertiesPool=null};Object.defineProperty(a.prototype,"location",{get:function(){var b=this.propertiesPool.get("location");this.renderCoordsHelper.fromRenderCoords(this.renderLocation,b,this.state.spatialReference);return b},enumerable:!0,configurable:!0});a.prototype.update=function(b){this._setDirty();this.updateCameraOnSurface()};a.prototype.forceUpdate=function(){this.measureSurfaceAltitude();
this.updateCameraOnSurface()};a.prototype.hasPendingUpdates=function(){return 0<this._dirtyTimeStamp};a.prototype._setDirty=function(){this._dirtyTimeStamp=this._dirtyTimeStamp||this.scheduler.now};a.prototype.needsUpdate=function(){return!this.pendingElevationQuery&&0<this._dirtyTimeStamp&&this.scheduler.now-this._dirtyTimeStamp>=this.altitudeEstimationInterval};a.prototype.cancelPendingRequest=function(){var b=this.pendingElevationQuery;b&&(this.pendingElevationQuery=null,b.cancel())};a.prototype.measureSurfaceAltitude=
function(){var b=this;this.cancelPendingRequest();this._dirtyTimeStamp=0;if(this.map&&this.map.ground){this.renderCoordsHelper.fromRenderCoords(this.state.camera.eye,m,this.state.spatialReference);var a=this.map.ground.queryElevation(m).then(function(a){return b.updateSurfaceAltitude(a.geometry.z)}).catch(function(a){a&&"cancel"===a.dojoType||b.updateSurfaceAltitude(0)}).catch(function(){}).then(function(){b.pendingElevationQuery===a&&(b.pendingElevationQuery=null)});a.isFulfilled()||(this.pendingElevationQuery=
a)}else this.updateSurfaceAltitude(0)};a.prototype.updateSurfaceAltitude=function(a){this.estimatedSurfaceAltitude!==a&&(this.estimatedSurfaceAltitude=a,this.updateCameraOnSurface())};a.prototype.updateCameraOnSurface=function(){h.vec3.copy(f,this.state.camera.eye);this.renderCoordsHelper.setAltitude(this.estimatedSurfaceAltitude,f);var a=this._get("renderLocation");h.vec3.equals(a,f)||this._set("renderLocation",h.vec3.copy(this.propertiesPool.get("renderLocation"),f))};e([c.property({constructOnly:!0})],
a.prototype,"scheduler",void 0);e([c.property({constructOnly:!0})],a.prototype,"altitudeEstimationInterval",void 0);e([c.property({readOnly:!0,dependsOn:["renderLocation"]})],a.prototype,"location",null);e([c.property({constructOnly:!0})],a.prototype,"map",void 0);e([c.property({readOnly:!0})],a.prototype,"renderLocation",void 0);return a=e([c.subclass("esri.views.3d.support.CameraOnSurface")],a)}(c.declared(r.PointOfInterest));g.CameraOnSurface=d;var f=k.vec3f64.create(),m=new l;g.default=d});