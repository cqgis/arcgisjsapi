// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports dojo/errors/CancelError ../../../request ../../../core/arrayUtils ../../../core/lang ../../../core/now ./AsyncQuotaRoundRobinQueue ./PromiseLightweight ../webgl-engine/lib/Util".split(" "),function(h,g,k,n,p,q,l,r,t,u){Object.defineProperty(g,"__esModule",{value:!0});g.ClientPromise=t.default;h=function(){function c(a,b){var e=this;this.tasks=new Map;this.clientPromiseToTask=new Map;this.doneQueue=[];this.loadQueue=new r(this.startLoading.bind(this),this.doneLoadingCallback,
this,a);b&&(this.taskHandle=b.registerTask(1,function(a){return e.update(a)},function(){return 0<e.doneQueue.length}))}c.prototype.destroy=function(){var a=this;this.taskHandle&&(this.taskHandle.remove(),this.taskHandle=null);this.tasks.forEach(function(b){var e=0;for(b=b.clientPromises;e<b.length;e++)a.cancel(b[e])});this.loadQueue.clear();this.clientPromiseToTask=this.tasks=this.doneQueue=this.loadQueue=null};c.prototype.request=function(a,b,e,d){var c=this;void 0===d&&(d=a);var f=new g.ClientPromise(function(){c.cancel(f)});
this.createOrUpdateTask(a,b,e,d,f);return f};c.prototype.createTask=function(a,b,e,d,c){a={url:a,docType:b,clientType:e,key:d,result:null,status:1,clientPromises:[],downloadObj:null,_cancelledInQueue:!1,startTime:0,duration:0,size:0};this.updateTask(a,c);this.tasks.set(d,a);this.loadQueue.push(a)};c.prototype.cancel=function(a){var b=this.clientPromiseToTask.get(a);b&&(a.reject(new k),p.removeUnordered(b.clientPromises,a),this.clientPromiseToTask.delete(a),0===b.clientPromises.length&&(2===b.status&&
(this.loadQueue.workerCancelled(b),b.status=4,b.downloadObj.cancel(),b.downloadObj=null),b.status=4,this.tasks.delete(b.key)))};c.prototype.hasPendingDownloads=function(){return 0<this.tasks.size};c.prototype.taskKey=function(a,b,e){return a+":"+b+":"+e};c.prototype.updateTask=function(a,b){this.clientPromiseToTask.set(b,a);a.clientPromises.push(b)};c.prototype.createOrUpdateTask=function(a,b,e,d,c){d=this.taskKey(d,b,e);var f=this.tasks.get(d);f?this.updateTask(f,c):this.createTask(a,b,e,d,c)};c.prototype.doneLoadingCallback=
function(a,b){u.assert(2===a.status);this.taskHandle?(a.status=3,this.doneQueue.push({task:a,err:b})):this.doneLoading(a,b)};c.prototype.update=function(a){for(;!a.done&&0<this.doneQueue.length;){var b=this.doneQueue.shift();3!==b.task.status&&(b.err=b.err||new k);this.doneLoading(b.task,b.err);a.madeProgress()}};c.prototype.doneLoading=function(a,b){for(var c=a.result instanceof HTMLImageElement?0:a.clientPromises.length,d=0,m=a.clientPromises;d<m.length;d++){var f=m[d];this.clientPromiseToTask.delete(f);
if(b)f.isRejected()||f.reject({url:a.url,error:b});else{--c;var g=0>=c?a.result:q.clone(a.result);f.resolve({url:a.url,data:g})}}this.tasks.delete(a.key)};c.prototype.startLoading=function(a,b){if(4===a.status)return!1;a.status=2;var c,d;switch(a.docType){case "binary":d="array-buffer";c=0;break;case "image":d="image";break;default:d="json"}a.startTime=l();a.downloadObj=n(a.url,{responseType:d,timeout:c});a.downloadObj.then(function(c){a.duration=l()-a.startTime;a.size="binary"===a.docType?c.data.byteLength:
0;a.result=c.data;b(a)},function(c){a.downloadObj.isCanceled()||b(a,c)});return!0};Object.defineProperty(c.prototype,"test",{get:function(){return{loadQueue:this.loadQueue}},enumerable:!0,configurable:!0});return c}();g.StreamDataLoader=h;g.default=h});