// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/meshUtils/deduplicate ./I3SBinaryReader ../../support/projectionUtils ../../webgl-engine/lib/Util".split(" "),function(K,r,F,G,w,C,L,M,N,B,x){function O(a,b,c,d,e,h,g){switch(c){case 1:for(c=0;c<g;c++)d[e]=a[b],b+=1,e+=h;break;case 2:for(c=0;c<g;c++)d[e]=
a[b],d[e+1]=a[b+1],b+=2,e+=h;break;case 3:for(c=0;c<g;c++)d[e]=a[b],d[e+1]=a[b+1],d[e+2]=a[b+2],b+=3,e+=h;break;case 4:for(c=0;c<g;c++)d[e]=a[b],d[e+1]=a[b+1],d[e+2]=a[b+2],d[e+3]=a[b+3],b+=4,e+=h;break;default:throw t("Unhandled stride size "+c);}}function P(a,b,c,d,e,h){switch(b){case 1:for(b=0;b<h;b++)c[d]=a,d+=e;break;case 2:for(b=0;b<h;b++)c[d]=a,c[d+1]=a,d+=e;break;case 3:for(b=0;b<h;b++)c[d]=a,c[d+1]=a,c[d+2]=a,d+=e;break;case 4:for(b=0;b<h;b++)c[d]=a,c[d+1]=a,c[d+2]=a,c[d+3]=a,d+=e;break;
default:throw t("Unhandled stride size "+b);}}function Q(a){switch(a){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw Error("Unhandled data type: "+a);}function H(a){switch(a){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw Error("Unhandled data type: "+
a);}function D(a){return 0<a&&0===a%Uint32Array.BYTES_PER_ELEMENT}function t(a){return Error("I3SGeometryUtil processing failed: "+a)}function I(a,b){switch(b){case 0:switch(a.type){case "intersects":case "contains":case "crosses":case "envelope-intersects":case "overlaps":case "touches":case "within":return 1;case "disjoint":return 0}break;case 2:switch(a.type){case "intersects":case "contains":case "envelope-intersects":case "within":return 0;case "disjoint":case "crosses":case "overlaps":case "touches":return 1}break;
case 1:switch(a.type){case "envelope-intersects":return 0}}return 2}function J(a,b){return z.contains(a.mask,b)?2:z.intersects(a.mask,b)?1:0}Object.defineProperty(r,"__esModule",{value:!0});var E=new Uint8Array(64);r.interleaveGeometryBuffer=function(a,b,c,d,e){void 0===d&&(d=[]);void 0===e&&(e=[]);var h=a.params.vertexAttributes,g=h.position.count;if(!D(c[0].stride))throw t("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var k=new Uint32Array(c[0].stride/Uint32Array.BYTES_PER_ELEMENT*
g);c=c.slice(0).sort(function(b,a){return b.offset-a.offset});a=function(a){if(-1!==e.indexOf(a.name))return"continue";var c=h[a.name],l=Q(a.type),f=void 0,p=!1;if(null==c)if(p=d.filter(function(b){return b.name===a.name})[0]){c={valueType:H(a.type),byteOffset:0,count:g,valuesPerElement:a.count};for(f=0;f<E.length;f++)E[f]=p.byteValue;f=E.buffer;p=!0}else throw t("Geometry definition is missing attribute");else f=b;if(H(a.type)!==c.valueType)throw t("Geometry definition type must match attribute type");
if(0!==c.byteOffset%Uint32Array.BYTES_PER_ELEMENT||0!==a.offset%Uint32Array.BYTES_PER_ELEMENT)throw t(a.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!D(c.valuesPerElement*l.BYTES_PER_ELEMENT)||!D(a.count*l.BYTES_PER_ELEMENT))throw t(a.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var f=new Uint32Array(f),m=c.byteOffset/Uint32Array.BYTES_PER_ELEMENT,c=c.valuesPerElement*l.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,l=a.offset/Uint32Array.BYTES_PER_ELEMENT,
n=a.stride/Uint32Array.BYTES_PER_ELEMENT;p?P(f[0],c,k,l,n,g):O(f,m,c,k,l,n,g)};for(var p=0;p<c.length;p++)a(c[p]);return k.buffer};r.processAndInterleaveNormals=function(a,b,c,d,e){if("none"===a){var h=e.normals,g=e.positions;b=e.normalInd;a=e.positionInd;x.assert(e.normalInd.length===e.positionInd.length);e=C.vec3f32.create();d=C.vec3f32.create();c=G.vec2f32.create();for(var k=g.data,p=g.offsetIdx,g=g.strideIdx,r=h.data,q=h.offsetIdx,h=h.strideIdx,l=0;l<a.length;l+=3){var f=a[l],f=p+g*f,u=k[f],m=
k[f+1],n=k[f+2],f=a[l+1],f=p+g*f;e[0]=k[f]-u;e[1]=k[f+1]-m;e[2]=k[f+2]-n;f=a[l+2];f=p+g*f;d[0]=k[f]-u;d[1]=k[f+1]-m;d[2]=k[f+2]-n;w.vec3.cross(e,e,d);x.encodeNormal(e,c);for(u=0;3>u;u++)m=q+h*b[l+u],r[m]=x.encodeInt16(c[0]),r[m+1]=x.encodeInt16(c[1])}}else if(b=N.createTypedView(c,b.params.vertexAttributes.normal),c=e.normals,m="earth-centered"===a?d:null,a=b.length/3,e=c.data,d=c.offsetIdx,c=c.strideIdx,null!=m)for(k=m[0],p=m[1],g=m[2],r=m[4],q=m[5],h=m[6],l=m[8],u=m[9],m=m[10],n=0;n<a;n++){var f=
b[3*n],v=b[3*n+1],t=b[3*n+2];y[0]=k*f+p*v+g*t;y[1]=r*f+q*v+h*t;y[2]=l*f+u*v+m*t;x.encodeNormal(y,A);e[d+n*c]=x.encodeInt16(A[0]);e[d+n*c+1]=x.encodeInt16(A[1])}else for(n=0;n<a;n++)y[0]=b[3*n],y[1]=b[3*n+1],y[2]=b[3*n+2],x.encodeNormal(y,A),e[d+n*c]=x.encodeInt16(A[0]),e[d+n*c+1]=x.encodeInt16(A[1])};r.extractPositionData=function(a,b,c){var d=b[0];if(null==d||"position"!==d.name||5126!==d.type)return null;a=new Float32Array(a);b=d.stride/4;for(var d=d.offset/4,e=3*a.length/b,h=new Float32Array(e),
g=0;g<e/3;g++)h[3*g]=a[g*b+d],h[3*g+1]=a[g*b+d+1],h[3*g+2]=a[g*b+d+2];c=M.default(h.buffer,3,c);return 65536>c.uniqueCount?{data:new Float32Array(c.buffer),indices:new Uint16Array(c.indices)}:{data:new Float32Array(c.buffer),indices:c.indices}};var z;r.loadGeometryEngine=function(){return null!=z?F.resolve():F.create(function(a,b){return K(["../../../../geometry/geometryEngine"],a)}).then(function(a){return z=a})};r.acquireMaskFilterContext=function(a,b,c,d){var e=c.spatialReference||b.spatialReference;
b=b.renderSpatialReference;var h={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:e};h.rings[0][4]=h.rings[0][0];var g=d.objectTransformation;d=d.getGeometryRecords()[0].geometry;var k={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:e};k.rings[0][3]=k.rings[0][0];var p=z[a];p||(console.error("Spatial relationship",a,"not supported"),p=function(){return!0});return{type:a,mask:c,maskSR:e,renderSR:b,aabb:h,transform:g,
geometry:d,triangle:k,testFunction:p}};r.getIntersectRelation=I;r.intersectMaskWithMbs=function(a,b){b=z.buffer({x:b[0],y:b[1],hasZ:!1,hasM:!1,type:"point",spatialReference:a.maskSR},b[3],1,!0);return J(a,b)};var R=Math.pow(2,-32);r.filterMask=function(a,b){var c=b.type,d=b.mask,e=b.transform,h=b.renderSR,g=b.maskSR,k=b.geometry,p=b.triangle,r=b.testFunction,q=b.aabb;k.getComponentAABB(a,v);var l=[q.rings[0][0],q.rings[0][1],q.rings[0][2],q.rings[0][3]];w.vec3.set(l[0],v[0],v[1],0);w.vec3.set(l[1],
v[0],v[4],0);w.vec3.set(l[2],v[3],v[4],0);w.vec3.set(l[3],v[3],v[1],0);for(var f=0;4>f;++f)w.vec3.transformMat4(l[f],l[f],e),B.vectorToVector(l[f],h,l[f],g);delete q._geVersion;f=J(b,q);switch(I(b,f)){case 1:return!1;case 0:return!0}b=p.rings[0][0];var q=p.rings[0][1],l=p.rings[0][2],u=k.data.getIndices(x.VertexAttrConstants.POSITION),f=k.data.componentOffsets,m=k.data.getAttribute(x.VertexAttrConstants.POSITION),k=m.data,n=m.offsetIdx,m=m.strideIdx,t=f.length?f[a]:0;a=f.length?f[a+1]:u.length;var y;
switch(c){case "intersects":case "crosses":case "envelope-intersects":case "index-intersects":case "overlaps":case "touches":y=function(){return r(d,p)?0:2};break;default:y=function(){return r(d,p)?2:1}}for(f=t;f<a;f+=3){var t=n+m*u[f+0],z=n+m*u[f+1],A=n+m*u[f+2];w.vec3.set(b,k[t+0],k[t+1],k[t+2]);w.vec3.set(q,k[z+0],k[z+1],k[z+2]);w.vec3.set(l,k[A+0],k[A+1],k[A+2]);w.vec3.transformMat4(b,b,e);w.vec3.transformMat4(q,q,e);w.vec3.transformMat4(l,l,e);B.vectorToVector(b,h,b,g);B.vectorToVector(q,h,q,
g);B.vectorToVector(l,h,l,g);if(!(Math.abs((q[0]-b[0])*(l[1]-b[1])-(q[1]-b[1])*(l[0]-b[0]))<R))switch(delete p._geVersion,y()){case 1:return!1;case 0:return!0}}switch(c){case "intersects":case "crosses":case "envelope-intersects":case "index-intersects":case "overlaps":case "touches":return!1;default:return!0}};var v=L.create(),y=C.vec3f32.create(),A=G.vec2f32.create()});