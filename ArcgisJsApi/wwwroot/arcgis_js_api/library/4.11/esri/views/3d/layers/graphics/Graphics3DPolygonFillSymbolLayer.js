// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/ColorMaterial".split(" "),
function(q,y,D,E,F,z,r,t,G,H,u,I,J,K,m,L,M,v,w,A,N,O,B,x,P){Object.defineProperty(y,"__esModule",{value:!0});q=function(q){function l(a,b,g,k){a=q.call(this,a,b,g,k)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};a._prepareFillResources();a._prepareOutlineResources();a.resolve();return a}D(l,q);l.prototype._prepareFillResources=function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),b={color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),
polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new P(b,a+"_colormat");this._context.stage.add(w.ModelContentType.MATERIAL,this._material)};l.prototype._prepareOutlineResources=function(){var a=this.symbolLayer.outline;if(this._hasOutline=!!(a&&a.size&&0<a.size&&a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:F.pt2px(a.size),slicePlaneEnabled:this._context.slicePlaneEnabled},this._outlineMaterial=1.5<=a.width?
v.createRibbonMaterial(a):v.createNativeMaterial(a),this._context.stage.add(w.ModelContentType.MATERIAL,this._outlineMaterial)};l.prototype.destroy=function(){q.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._material.id),this._material=null);this._outlineMaterial&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._outlineMaterial.id),this._outlineMaterial=null)};l.prototype.createGraphics3DGraphic=
function(a){var b=a.graphic,g=b.geometry.type;if("polyline"!==g&&"polygon"!==g&&"extent"!==g)return this._logWarning("unsupported geometry type for fill symbol: "+g),null;if(!this._validateGeometry(b.geometry))return null;g="graphic"+b.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var k=this.getGraphicElevationContext(b);return"on-the-ground"===k.mode?this._createAsOverlay(b,a,k,g):this._createAs3DShape(b,a,k,g,b.uid)};l.prototype.layerOpacityChanged=function(){var a=this._material.getColor(),
b=this._getMaterialOpacity();this._material.setColor([a[0],a[1],a[2],b]);this._material.setTransparent(1>b||this._isPropertyDriven("opacity"));this._outlineMaterial&&(a=this._outlineMaterial.getColor(),a={color:[a[0],a[1],a[2],this._getOutlineOpacity()]},this._outlineMaterial.setParameterValues(a));return!0};l.prototype.layerElevationInfoChanged=function(a,b,g){var k=this._elevationContext.mode;if(null==g||null==k)return!1;if("on-the-ground"===g&&"on-the-ground"===k)return!0;if(g!==k&&("on-the-ground"===
g||"on-the-ground"===k))return!1;var h=m.needsElevationUpdates2D(k);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return h})};l.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._outlineMaterial&&this._outlineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};l.prototype.pixelRatioChanged=function(a,b){return!0};l.prototype.setDrawOrder=function(a,b,
g){this.updateSymbolLayerOrder(a,b);this._material&&(this._material.renderPriority=a+b/2,g.add(this._material.id));this._outlineMaterial&&(this._outlineMaterial.renderPriority=a,g.add(this._outlineMaterial.id))};l.prototype._createAs3DShape=function(a,b,g,k,h){var e=this._getPolyGeometry(a);a=e.rings;var c=this._getOutlineGeometry(e,a),e=m.getGeometryVertexData3D(c,e.hasZ,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,g);f.idHint=
k;f.color=b;f.data=e;var d;this._hasOutline&&(d=new e.vertexData.constructor(e.vertexData));f.outNum=0;f.outGeometries=[];f.outTransforms=[];f.outMaterials=[];this._createAs3DShapeFill(f);f.data.vertexData=d;this._createAs3DShapeOutline(f);this._logGeometryCreationWarnings(f.data,a,"rings","FillSymbol3DLayer");if(0===f.outNum)return null;b=new O({geometries:f.outGeometries,materials:f.outMaterials,transformations:f.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:h},
idHint:k});b=new K(this,b,f.outGeometries,null,null,I.perVertexElevationAligner,g);b.alignedTerrainElevation=e.terrainElevation;b.needsElevationUpdates=m.needsElevationUpdates2D(g.mode);return b};l.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,g=a.data.eleVertexData,k=a.data.vertexData,h=function(d){var c=b[d];d=c.count;var h=c.index;if(e._context.clippingExtent&&(m.computeBoundingBox(g,h,d,n),m.boundingBoxClipped(n,e._context.clippingExtent)))return"continue";
var f=new Float64Array(g.buffer,3*h*g.BYTES_PER_ELEMENT,3*d),l=new Float64Array(k.buffer,3*h*k.BYTES_PER_ELEMENT,3*d),c=c.holeIndices.map(function(a){return a-h}),c=z(f,c,3);if(0===c.length)return"continue";m.chooseOrigin(k,h,d,p);m.subtractCoordinates(k,h,d,p);d=e._createFillGeometry(c,0,l,f,a.color);d=new A(d,a.idHint);d.singleUse=!0;f=t.mat4f64.create();r.mat4.translate(f,f,p);a.outGeometries.push(d);a.outMaterials.push(e._material);a.outTransforms.push(f);a.outNum++},e=this,c=0;c<b.length;++c)h(c)};
l.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,g=a.data.eleVertexData,f=a.data.vertexData,h=0;h<b.length;++h){var e=b[h],c=e.index,d=e.count;if(this._context.clippingExtent&&(m.computeBoundingBox(g,c,d,n),m.boundingBoxClipped(n,this._context.clippingExtent)))continue;m.chooseOrigin(f,c,d,p);m.subtractCoordinates(f,c,d,p);e=new Float64Array(g.buffer,3*c*g.BYTES_PER_ELEMENT,3*d);c=new Float64Array(f.buffer,3*c*f.BYTES_PER_ELEMENT,3*d);c=v.createPolylineGeometry(c,
e,!1,C,0);c=new A(c,a.idHint+"outline"+h);c.singleUse=!0;e=t.mat4f64.create();r.mat4.translate(e,e,p);a.outGeometries.push(c);a.outMaterials.push(this._outlineMaterial);a.outTransforms.push(e);a.outNum++}};l.prototype._createAsOverlay=function(a,b,g,k){var h=this._getPolyGeometry(a);g=h.rings;var e=this._getOutlineGeometry(h,g);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);h=m.getGeometryVertexDataDraped(e,
h.spatialReference,this._context.overlaySR);f.idHint=k;f.color=b;f.data=h;var c;this._hasOutline&&(c=new h.vertexData.constructor(h.vertexData));f.outNum=0;f.outGeometries=[];f.outBoundingBox=u.empty();f.layerUid=this._context.layer.uid;f.graphicsUid=a.uid;this._createAsOverlayFill(f);f.data.vertexData=c;this._createAsOverlayOutline(f);this._logGeometryCreationWarnings(f.data,g,"rings","FillSymbol3DLayer");return 0<f.outNum?new J(this,f.outGeometries,f.outBoundingBox):null};l.prototype._createAsOverlayFill=
function(a){for(var b=a.data.vertexData,f=a.data.geometryData.polygons,k=function(c){var d=f[c];c=d.count;var e=d.index,g=new Float64Array(b.buffer,3*e*b.BYTES_PER_ELEMENT,3*c),d=d.holeIndices.map(function(a){return a-e}),g=z(g,d,3);if(0===g.length)return"continue";m.computeBoundingBox(b,e,c,n);if(m.boundingBoxClipped(n,h._context.clippingExtent))return"continue";u.expand(a.outBoundingBox,n);m.chooseOrigin(b,e,c,p);m.subtractCoordinates(b,e,c,p);m.setZ(b,e,c,h._getDrapedZ());c=t.mat4f64.create();
r.mat4.translate(c,c,p);g=h._createFillGeometry(g,e,b,null,a.color);d=new B(g);d.data.layerUid=a.layerUid;d.data.graphicUid=a.graphicsUid;d.material=h._material;var k=n;d.center=[.5*(k[0]+k[3]),.5*(k[1]+k[4]),0];d.bsRadius=.5*Math.sqrt((k[3]-k[0])*(k[3]-k[0])+(k[4]-k[1])*(k[4]-k[1]));d.transformation=c;d.name=a.idHint;d.uniqueName=a.idHint+"#"+g.id;a.outGeometries.push(d);a.outNum++},h=this,e=0;e<f.length;++e)k(e)};l.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=a.data.vertexData,
f=a.data.geometryData.outlines,k=0;k<f.length;++k){var h=f[k],e=h.index,h=h.count;m.computeBoundingBox(b,e,h,n);if(!m.boundingBoxClipped(n,this._context.clippingExtent)){u.expand(a.outBoundingBox,n);m.chooseOrigin(b,e,h,p);m.subtractCoordinates(b,e,h,p);m.setZ(b,e,h,this._getDrapedZ());h=new Float64Array(b.buffer,3*e*b.BYTES_PER_ELEMENT,3*h);e=t.mat4f64.create();r.mat4.translate(e,e,p);var h=v.createPolylineGeometry(h,null,!0,C,0),c=new B(h);c.data.layerUid=a.layerUid;c.data.graphicUid=a.graphicsUid;
c.material=this._outlineMaterial;var d=n;c.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0];c.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]));c.transformation=e;c.name=a.idHint+"outline";c.uniqueName=a.idHint+"outline#"+h.id;a.outGeometries.push(c);a.outNum++}}};l.prototype._getOutlineGeometry=function(a,b){return b};l.prototype._getOutlineOpacity=function(){return this._getLayerOpacity()*this.symbolLayer.outline.color.a};l.prototype._getOutlineColor=function(){var a=this.symbolLayer.outline.color,
b=this._getOutlineOpacity();return M.mixinColorAndOpacity(E.toUnitRGB(a),b)};l.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?H.fromExtent(a):a};l.prototype._createFillGeometry=function(a,b,f,k,h){for(var e=a.length,c=new Uint32Array(e),d=new Uint32Array(e),g=0;g<e;g++)c[g]=a[g]+b,d[g]=0;a={};b={};a[x.VertexAttrConstants.POSITION]=c;a[x.VertexAttrConstants.COLOR]=d;b[x.VertexAttrConstants.POSITION]={size:3,data:f};b[x.VertexAttrConstants.COLOR]={size:4,data:h};k&&(b.mapPos=
{size:3,data:k},a.mapPos=c);return new N(b,a)};return l}(L.default);y.Graphics3DPolygonFillSymbolLayer=q;var n=u.create(),p=G.vec3f64.create(),C=new Float32Array([255,255,255,255]),f={idHint:null,color:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};y.default=q});