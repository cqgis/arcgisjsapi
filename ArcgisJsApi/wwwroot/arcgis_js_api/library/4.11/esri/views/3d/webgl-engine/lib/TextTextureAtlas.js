// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/iteratorUtils ../../../../core/mathUtils ./ModelContentType ./Texture ../../../webgl/Texture".split(" "),function(k,l,n,t,p,u,v){Object.defineProperty(l,"__esModule",{value:!0});k=function(){function d(a,b){this.dirty=!1;this.elementsToAdd=new Map;this.elementsToRemove=new Map;this.elementsToRender=new Map;this.elements=new Map;this.stageObjects=new Map;this.id=u.idGen.gen(a);this.stage=b._stage;this.scheduler=b.resourceController.scheduler;this.canvas=this.create2DCanvas();
this.ctx=this.canvas.getContext("2d");this.stage.add(p.TEXTURE,this);a=this.computeAtlasResolution(b.width,b.height);this.createAtlasRegion(a);this.update2DCanvasSize()}d.prototype.setUnloadFunc=function(a){this.unloadFunc=a};d.prototype.unload=function(){null!=this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=null)};d.prototype.deferredLoading=function(){return!1};d.prototype.getWidth=function(){return this.atlas.size.width};d.prototype.getHeight=function(){return this.atlas.size.height};
d.prototype.initializeThroughRender=function(a,b){var c=this;b.wrapMode=33071;b.samplingMode=9987;b.flipped=!0;b.preMultiplyAlpha=!0;b.hasMipmap=!0;this.glTexture=new v(a,b,this.canvas);this.frameWorker=this.scheduler.registerTask(12,function(a){return c.run(c.makeRunContext(a))},function(){return c.dirty});return this.glTexture};d.prototype.dispose=function(){this.elementsToRender=this.elementsToRemove=this.elementsToAdd=this.elements=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=
null);this.glTexture&&(this.glTexture=null,this.stage.remove(p.TEXTURE,this.id))};d.prototype.create2DCanvas=function(){var a=document.createElement("canvas");a.setAttribute("id","canvas2d");a.setAttribute("style","display:none");a.setAttribute("width",(512).toString());a.setAttribute("height",(512).toString());return a};d.prototype.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString());this.canvas.setAttribute("height",this.atlas.size.height.toString())};
d.prototype.createAtlasRegion=function(a){void 0===a&&(a=512);this.atlas={size:{width:a,height:a},cursor:{x:0,y:0},lineHeight:0}};d.prototype.computeAtlasResolution=function(a,b){a=Math.max(a,b);a=t.nextHighestPowerOfTwo(a+256);return a=Math.min(a,4096)};d.prototype.resizeAtlas=function(a,b){b=b||a;var c=this.atlas;c.size.width=a;c.size.height=b;this.glTexture&&this.glTexture.resize(a,b);this.update2DCanvasSize()};d.prototype.resetAtlasCursor=function(){var a=this.atlas;a.cursor.x=g;a.cursor.y=g+
q;a.lineHeight=0};d.prototype.getAtlasUsage=function(){var a=this.atlas;return(a.cursor.x+a.cursor.y*a.size.width)/(a.size.width*a.size.height)};d.prototype.getExpectedAtlasUsage=function(){var a=this.elementsToRemove.size,b=this.elementsToAdd.size,c=this.elements.size;return this.getAtlasUsage()/c*(c+b-a)};d.prototype.addAtlasElement=function(a,b,c,d){var e=this.atlas,f=a.textRenderer,r=f.renderedWidth,g=f.renderedHeight,w=f.displayWidth,f=f.displayHeight;a.placement.offset.x=e.cursor.x;a.placement.offset.y=
e.cursor.y;a.placement.size.width=r;a.placement.size.height=g;a.placement.size.displayWidth=w;a.placement.size.displayHeight=f;a.placement.uvMinMax=[a.placement.offset.x/e.size.width,1-(a.placement.offset.y+g)/e.size.height,(a.placement.offset.x+r)/e.size.width,1-a.placement.offset.y/e.size.height];e.cursor.x+=c;e.lineHeight=Math.max(e.lineHeight,d);this.elements.set(b,a)};d.prototype.removeAtlasElement=function(a){if(a&&this.elements.has(a.textId)){var b=a.placement.offset,c=a.placement.size;this.ctx.clearRect(b.x,
b.y,c.width,c.height);this.elements.delete(a.textId)}};d.prototype.ensureStageObjects=function(a){var b=this.stageObjects.get(a);b||(b=new Set,this.stageObjects.set(a,b));return b};d.prototype.addStageObject=function(a,b){this.ensureStageObjects(a).add(b)};d.prototype.removeStageObject=function(a,b){(a=this.stageObjects.get(a))&&a.delete(b)&&(b.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),b.geometryVertexAttrsUpdated(0))};d.prototype.processAdditionRequest=function(a,b){var c=
this.atlas,d=a.textId,e=a.textRenderer.renderedWidth+g,h=a.textRenderer.renderedHeight+g+q;b=b.repackingEnabled;if(c.cursor.x+e<c.size.width&&c.cursor.y+h<c.size.height)this.addAtlasElement(a,d,e,h),this.elementsToRender.set(d,a),this.elementsToAdd.delete(d);else if(c.cursor.y+h+c.lineHeight<c.size.height)c.cursor.x=g,c.cursor.y+=c.lineHeight,c.lineHeight=0,this.addAtlasElement(a,d,e,h),this.elementsToRender.set(d,a),this.elementsToAdd.delete(d);else{a=this.getExpectedAtlasUsage();(d=.85<a&&4096>
c.size.width)&&this.resizeAtlas(2*c.size.width,2*c.size.height);if(!b||!d&&.95<a&&4096===c.size.width)return this.processRemovals(),0;this.repack();return 1}return 0};d.prototype.processRemovals=function(){var a=this;this.elementsToRemove.forEach(function(b,c){var d=a.stageObjects.get(c);d&&0!==d.size||a.removeAtlasElement(b);d&&0===d.size&&a.stageObjects.delete(c)});this.elementsToRemove.clear()};d.prototype.repack=function(){var a=this;this.processRemovals();this.elements.forEach(function(b,c){b.rendered=
!1;a.elementsToAdd.set(c,b)});this.elements.clear();this.resetAtlasCursor();this.elementsToRender.clear()};d.prototype.processRenderingRequest=function(a){this.ctx.clearRect(a.placement.offset.x,a.placement.offset.y,a.placement.size.width,a.placement.size.height);a.textRenderer.render(this.ctx,a.placement.offset.x,a.placement.offset.y);var b=this.stageObjects.get(a.textId);b&&b.forEach(function(b){b.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(a.placement.uvMinMax);b.geometries[0].data.vertexAttributes.size.data=
new Float32Array([a.placement.size.displayWidth,a.placement.size.displayHeight]);b.geometryVertexAttrsUpdated(0)});a.rendered=!0};d.prototype.run=function(a){var b=this;if(this.dirty&&this.glTexture){var c=a.budget,f=!1;n.everyMap(this.elementsToAdd,function(c,d){return(c=b.elements.get(d))&&c.rendered?((c=b.stageObjects.get(d))&&c.forEach(function(a){var c=a.geometries[0].data.vertexAttributes,e=b.elements.get(d);c.uv0.data=new Float32Array(e.placement.uvMinMax);c.size.data=new Float32Array([e.placement.size.displayWidth,
e.placement.size.displayHeight]);a.geometryVertexAttrsUpdated(0)}),b.elementsToAdd.delete(d),!0):1===b.processAdditionRequest(b.elementsToAdd.get(d),a)?(f=!0,!1):!0});if(f)a.budget=null,a.repackingEnabled=!1,this.run(a);else{var e=!1;n.everyMap(this.elementsToRender,function(a,d){b.processRenderingRequest(a);b.elementsToRender.delete(d);e=!0;return c&&(c.madeProgress(),c.done)?!1:!0});e&&this.glTexture.setData(this.canvas);this.dirty=0<this.elementsToRender.size;!this.dirty&&d.test.orderedRepackingEnabled&&
this.repackOrdered()}}};d.prototype.makeRunContext=function(a){void 0===a&&(a=null);m.budget=a;m.repackingEnabled=!0;return m};d.prototype.addTextTexture=function(a,b){var c=a.key;this.elementsToAdd.has(c)||this.elementsToAdd.set(c,{textId:c,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:a,rendered:!1});this.addStageObject(c,b);this.elementsToRemove.delete(c);this.setDirty()};d.prototype.removeTextTexture=function(a,b){a=a.key;this.elementsToRemove.set(a,
this.elements.get(a));this.removeStageObject(a,b)};Object.defineProperty(d.prototype,"textureId",{get:function(){return this.id},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"isDirty",{get:function(){return this.dirty},enumerable:!0,configurable:!0});d.prototype.setDirty=function(){this.dirty=!0};Object.defineProperty(d.prototype,"test",{get:function(){return{elements:this.elements,stageObjects:this.stageObjects,elementsToRemove:this.elementsToRemove,atlas:this.atlas,resizeAtlas:this.resizeAtlas.bind(this)}},
enumerable:!0,configurable:!0});d.prototype.repackOrdered=function(){if(0!==this.elements.size){var a=[];this.elements.forEach(function(b,c){return a.push({element:b,key:c})});for(var b=!0,c=0;c<a.length-1;c++)if(0<a[c].key.localeCompare(a[c+1].key)){b=!1;break}if(!b){a.sort(function(a,b){return a.key.localeCompare(b.key)});this.elements.clear();for(b=0;b<a.length;b++)c=a[b],this.elements.set(c.key,c.element);this.repack();this.setDirty()}}};d.test={orderedRepackingEnabled:!1};return d}();l.TextTextureAtlas=
k;var g=2,q=2,m={budget:null,repackingEnabled:!0};l.default=k});