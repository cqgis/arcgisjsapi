// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports dojo/errors/CancelError ../../../../core/lang ../../../../core/promiseUtils ../../../../core/urlUtils ./I3SBinaryReader ./I3SUtil ../../webgl-engine/lib/Util".split(" "),function(l,w,t,u,n,p,q,r,v){l=function(){function c(a,e,b,d,f){this.loader=a;this.logger=e;this.defaultGeometrySchema=b;this.requiredAttributes=d;this.options=f;this.cancelled=!1;this.loadShared=function(a){if(null==a.sharedResource)return n.resolve({});var b=p.makeAbsolute(a.sharedResource.href,a.baseUrl);
return this.load(b,"json").then(function(a){c.fixTextureEncodings(a);c.addAbsoluteHrefTexture(a,b);return a})}}c.prototype.cancelAll=function(){this.cancelled=!0};c.prototype.load=function(a,e){var b=this;return n.create(function(d,f){b.loader.request(a,e).then(function(a){return d(a.data)},function(b){return f(b||Error("Failed to load: "+a))})})};c.prototype.loadAttribute=function(a,e,b){a=p.makeAbsolute(b,a);return this.load(a,"binary").then(function(a){return q.readBinaryAttribute(e,a)})};c.prototype.loadAttributes=
function(a,e){var b=this,d=e.map(function(d){return null==a.attributeData||null==a.attributeData[d.index]?(b.logger.error("Missing attributeData for '"+d.name+"' on node '"+a.id+"'"),n.resolve(null)):b.loadAttribute(a.baseUrl,d.attributeStorageInfo,a.attributeData[d.index].href).catch(function(e){b.logger.error("Failed to load attributeData for '"+d.name+"' on node '"+a.id+"'");return null})});return n.all(d).then(function(a){for(var b={},d=0;d<e.length;++d)a[d]&&(b[e[d].name]=a[d]);return b})};c.prototype.prepareBinaryGeometryData=
function(a,e,b,d){u.mixin(a.geometries[0].params,b);d||null!=b.vertexAttributes.region||delete b.vertexAttributes.region;if(null!=b.featureAttributes){d=b.featureAttributes;if(d.faceRange){var f=q.createTypedView(e,d.faceRange);a.componentOffsets=r.convertFlatRangesToOffsets(f,b.header.fields.featureCount,d.faceRange.valuesPerElement)}if(d.id){a.featureIds=[];var f=1,g=q.valueType2TypedArrayClassMap[d.id.valueType];"UInt64"===d.id.valueType&&(g=Uint32Array,f=2);e=new g(e,d.id.byteOffset,d.id.count*
d.id.valuesPerElement*f);for(g=0;g<b.header.fields.featureCount;g++)if(a.featureIds[g]=e[g*d.id.valuesPerElement*f],2===f){var c=e[g*d.id.valuesPerElement*f+1];if(2097150<=c)throw Error("ID exceeded maximum range supported by javascript (max \x3d 53bit-1 \x3d 9007199254740991)");a.featureIds[g]+=4294967296*c}}}};c.prototype.loadBundleData=function(a,e){var b=this,d=null,f=this.loadShared(a),g=null;null!=this.requiredAttributes&&(g=this.loadAttributes(a,this.requiredAttributes));var c=null;if(null!=
a.geometryData)var k=p.makeAbsolute(a.geometryData[e].href,a.baseUrl),c=this.load(k,"binary");return f.then(function(f){b.handleCancelled();return(b.options.loadFeatureData?b.loadFeatureData(a,e):n.resolve(null)).then(function(e){b.handleCancelled();var h=b.options.loadFeatureData?b.collectGeometries(a,e,f):b.meshPyramidGeometryData(a,f);e=null!=c?c.then(function(a){d=a;var e=Object.keys(f.materialDefinitions)[0],e=f.materialDefinitions[e].params.vertexRegions,c=q.createGeometryDataIndex(a,b.defaultGeometrySchema,
e);b.prepareBinaryGeometryData(h[0],a,c,e);return h}):n.resolve(h);var k=b.loadTextures(h,f);return n.all([k,e,g])}).then(function(a){var e=a[0],c=a[1];a=a[2];b.handleCancelled();var g=null;a&&(g={attributeData:a,loadedAttributes:b.requiredAttributes});return{allGeometryData:c,attributeDataInfo:g,geometryBuffer:d,sharedResource:f,textureData:e}})})};c.addAbsoluteHrefTexture=function(a,e){a=a.textureDefinitions;if(null!=a)for(var b=0,d=Object.keys(a);b<d.length;b++)for(var c=0,g=a[d[b]].images;c<g.length;c++){var h=
g[c];Array.isArray(h.href)?h.hrefConcat=h.href.map(function(a){return p.makeAbsolute(a,e)}):h.hrefConcat=p.makeAbsolute(h.href,e)}};c.fixTextureEncodings=function(a){a=a.textureDefinitions;if(null!=a)for(var e in a){var b=a[e];if(Array.isArray(b.encoding))for(var d=0;d<b.encoding.length;d++){var c=b.encoding[d];"data:"===c.substring(0,5)&&(b.encoding[d]=c.substring(5))}else c=b.encoding,"data:"===c.substring(0,5)&&(b.encoding=c.substring(5))}};c.prototype.loadTexture=function(a,e,b,d){var c=this;
return d===r.DDS_ENCODING_STRING?this.load(a,"binary").then(function(a){c.handleCancelled();return{i3sTexId:e,data:a,encoding:d}}):this.load(a,"image").then(function(a){var f=a;c.handleCancelled();if(b&&4096<=a.width*a.height){var f=Math.ceil(a.width/2),g=Math.ceil(a.height/2),m=document.createElement("canvas");m.width=f;m.height=g;m.getContext("2d").drawImage(a,0,0,f,g);f=m}return{i3sTexId:e,data:f,encoding:d}})};c.prototype.loadTextures=function(a,e){for(var b=[],d=0;d<a.length;d++){var f=a[d].geometries;
if(null!=f)for(var g=0;g<f.length;g++){var h=f[g].params.textureID||"none";if("none"!==h){null!=e.textureDefinitions&&null!=e.textureDefinitions[h]||this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+h);var k=e.textureDefinitions[h];v.assert(void 0!==k,"geometry wants unknown texture "+h);if(0!==k.images.length){var m=k.images[k.images.length-1],p=this.options.textureFormat===c.TextureFormat.Downsampled,l=r.getAppropriateTextureEncoding(k.encoding,this.options.textureFormat===
c.TextureFormat.Compressed),k=-1<l?k.encoding[l]:k.encoding,m=-1<l?m.hrefConcat[l]:m.hrefConcat;this.options.loadTextureData?b.push(this.loadTexture(m,h,p,k)):b.push({i3sTexId:h,encoding:k,data:null})}}}}return n.all(b)};c.prototype.meshPyramidGeometryData=function(a,e){a=e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null;e=e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null;return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:a,textureID:e}}],featureDataPosition:[0,
0,0]}]};c.prototype.collectGeometries=function(a,e,b){a=[];b=0;for(e=e.featureData;b<e.length;b++){var d=e[b],c=d.geometries;if(null!=c)for(var g=0;g<c.length;g++)a.push({featureIds:[d.id],featureDataPosition:d.position,geometries:[d.geometries[g]]});else null!=d.position&&a.push({featureIds:[d.id],featureDataPosition:d.position,geometries:null})}return a};c.prototype.loadFeatureData=function(a,c){a=p.makeAbsolute(a.featureData[c].href,a.baseUrl);return this.load(a,"json")};c.prototype.handleCancelled=
function(){if(this.cancelled)throw new t;};return c}();(function(c){c=c.TextureFormat||(c.TextureFormat={});c[c.Compressed=0]="Compressed";c[c.Normal=1]="Normal";c[c.Downsampled=2]="Downsampled"})(l||(l={}));return l});