// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/watchUtils ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ./atmosphereUtils ./resources/SimpleAtmosphereTexture ../support/earthUtils ../support/imageUtils ../support/mathUtils ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Util ../webgl-engine/shaders/SimpleAtmospherePrograms ../../webgl/BufferObject ../../webgl/programUtils ../../webgl/renderState ../../webgl/Texture ../../webgl/Util ../../webgl/VertexArrayObject".split(" "),
function(v,V,F,G,H,I,J,k,m,w,K,l,L,p,M,N,O,x,q,P,y,r,Q,z,R){function A(h,b,c,a,f){var e=k.vec3.length(h),g=a*Math.sqrt(e*e-a*a)/e,d=f.silCircleV1,l=f.silCircleV2;k.vec3.scale(f.silCircleCenter,h,Math.sqrt(a*a-g*g)/e);k.vec3.cross(d,h,b);1>k.vec3.squaredLength(d)&&k.vec3.cross(d,h,c);k.vec3.scale(d,d,g/k.vec3.length(d));k.vec3.cross(l,d,h);k.vec3.scale(l,l,g/k.vec3.length(l));return g}function B(h,b,c,a){k.vec3.add(n,a.silCircleCenter,a.silCircleV2);k.vec3.scale(t,n,C);G.mat4.lookAt(u,b,n,c);x.project(n,
u,h.projectionMatrix,h.viewport);x.project(t,u,h.projectionMatrix,h.viewport);return k.vec3.distance(n,t)/h.height}var D=-w.INNER_ATMOSPHERE_DEPTH,S=(l.earthRadius+D)/l.earthRadius,T=(l.earthRadius+0)/l.earthRadius,C=(l.earthRadius+3E5)/l.earthRadius,U=p.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5E3,.51171875],[5E4,.4140625]]);v=function(){function h(b){this.needsRender=!1;this.didRender=!0;this.slot=12;this._renderData={texV:J.vec2f64.create(),silCircleCenter:m.vec3f64.create(),silCircleV1:m.vec3f64.create(),
silCircleV2:m.vec3f64.create(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0};this._fadeVaoCount=0;this.view=b}h.prototype.when=function(b){return this._readyPromise.then(b)};h.prototype.initializeRenderContext=function(b){var c=this,a=b.rctx;this._cameraChangeHandle=F.init(this.view,"state.camera",function(){return c.needsRender=!0},!0);this._program=y.createProgram(a,q.colorPass);this._fadeProgram=y.createProgram(a,q.fadePass);this._vao=this._createRibbon(a);this._vaoCount=z.vertexCount(this._vao,
"geometry");this._fadeVao=O.createQuadVAO(a);this._fadeVaoCount=z.vertexCount(this._fadeVao,"geometry");this._readyPromise=L.requestImage(K).then(function(b){c._texture=new Q(a,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},b);c.needsRender=!0});this._pipelineState=r.makePipelineState({blending:r.separateBlendingParams(770,1,771,771),depthTest:{func:515},colorWrite:r.defaultColorWriteParams})};h.prototype.uninitializeRenderContext=function(b){this.destroy()};h.prototype.destroy=
function(){this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null);this._texture&&(this._texture.dispose(),this._texture=null);this._program&&(this._program.dispose(),this._program=null);this._fadeProgram&&(this._fadeProgram.dispose(),this._fadeProgram=null);this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null);this._readyPromise&&(this._readyPromise.cancel(),this._readyPromise=null)};h.prototype.render=function(b){if(b.slot!==this.slot||0!==b.pass||null==
this._texture)return!1;this._update(b.camera);var c=b.rctx;c.setPipelineState(this._pipelineState);if(1>this._renderData.undergroundFadeAlpha){var a=this._program;c.bindProgram(a);a.setUniformMatrix4fv("proj",b.camera.projectionMatrix);a.setUniformMatrix4fv("view",b.camera.viewMatrix);a.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter);a.setUniform3fv("silCircleV1",this._renderData.silCircleV1);a.setUniform3fv("silCircleV2",this._renderData.silCircleV2);a.setUniform2fv("texV",this._renderData.texV);
c.bindTexture(this._texture,0);a.setUniform1i("tex",0);a.setUniform3fv("lightDirection",b.lightingData.direction);a.setUniform1f("altitudeFade",this._renderData.altitudeFade);a.setUniform1f("innerScale",this._renderData.innerScale);c.bindVAO(this._vao);c.drawArrays(4,0,this._vaoCount)}0<this._renderData.undergroundFadeAlpha&&(a=this._fadeProgram,c.bindProgram(a),a.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),a.setUniform3fv("lightDirection",b.lightingData.direction),
a.setUniform3fv("cameraPosition",b.camera.eye),c.bindVAO(this._fadeVao),c.drawArrays(5,0,this._fadeVaoCount));this.needsRender=!1;return!0};h.prototype._update=function(b){var c=m.vec3f64.create(),a=l.earthRadius,f=k.vec3.length(b.eye),e=f-a;this._renderData.undergroundFadeAlpha=0>e?Math.min(-e/5E3,1):0;var g=a+D,d=a+Math.max(50,e);this._renderData.innerScale=d*d/(Math.sqrt(d*d-a*a)*Math.sqrt(d*d-g*g)+a*g)-1;this._renderData.altitudeFade=w.computeInnerAltitudeFade(e);k.vec3.scale(c,b.eye,(a+50)/f);
A(c,b.center,b.up,a,this._renderData);c=B(b,c,b.up,this._renderData);f=U(e);g=.001953125;d=0+c*f*1;50<e&&(A(b.eye,b.center,b.up,a,this._renderData),b=B(b,b.eye,b.up,this._renderData),b=p.clamp((b-1.5)/(c-1.5),0,1),g=0+.001953125*b,d=0+1*p.lerp(1,c*f,b));I.vec2.set(this._renderData.texV,g,d)};h.prototype._createRibbon=function(b){var c=new Float32Array(1155),a=new Uint32Array(1920);c[0]=0;c[1]=0;c[2]=-1;for(var f=0;128>f;f++){var e=9*f+3;c[e+0]=f;c[e+1]=S;c[e+2]=-1;c[e+3]=f;c[e+4]=T;c[e+5]=0;c[e+6]=
f;c[e+7]=C;c[e+8]=1;var e=3*f+1,g=127===f?1:e+3,d=15*f;a[d+0]=e;a[d+1]=e+1;a[d+2]=g+1;a[d+3]=g+1;a[d+4]=g;a[d+5]=e;a[d+6]=e+1;a[d+7]=e+2;a[d+8]=g+2;a[d+9]=g+2;a[d+10]=g+1;a[d+11]=e+1;a[d+12]=e;a[d+13]=g;a[d+14]=0}e=E.createBuffer(a.length);g=e.position;for(f=0;f<a.length;++f)d=3*a[f],g.set(f,0,c[d]),g.set(f,1,c[d+1]),g.set(f,2,c[d+2]);return new R(b,q.colorPass.attributes,{geometry:M.glLayout(E)},{geometry:P.createVertex(b,35044,e.buffer)})};return h}();var u=H.mat4f64.create(),n=m.vec3f64.create(),
t=m.vec3f64.create(),E=N.newLayout().vec3f("position");return v});