// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Logger ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../support/Evented ../../webgl-engine/lib/Intersector".split(" "),function(x,y,q,h,r,t,f,l,d,k,u,v,w){var e=k.empty(),
g={spatialReference:null,extent:e},c=d.vec3f64.create(),m=d.vec3f64.create(),n=d.vec3f64.create(),p=t.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(d){function a(b){return d.call(this)||this}q(a,d);a.prototype.initialize=function(){var b=this.layerView.view;this.view=b;this.renderCoordsHelper=b.renderCoordsHelper;this.intersectLayers=[this.stageLayer];this.intersector=new w(b.viewingMode);b=this.layerView.layer.fullExtent;this.zmin=b.zmin;this.zmax=b.zmax};a.prototype.getElevation=
function(b){if(u.isPoint(b)){if(!this.renderCoordsHelper.toRenderCoords(b,c))return p.error("could not project point for elevation alignment"),-Infinity}else if(!this.renderCoordsHelper.toRenderCoords(b,this.spatialReference,c))return p.error("could not project point for elevation alignment"),-Infinity;var a=this.layerView.elevationOffset;b=this.zmin+a;a=this.zmax+a;l.vec3.copy(m,c);l.vec3.copy(n,c);this.renderCoordsHelper.setAltitude(a,m);this.renderCoordsHelper.setAltitude(b,n);this.intersector.intersect(this.intersectLayers,
m,n,null,null,1,!1);return this.intersector.results.min.getIntersectionPoint(c)?this.renderCoordsHelper.getAltitude(c):-Infinity};a.prototype.layerChanged=function(){this.spatialReference&&(g.extent=this.computeLayerExtent(this.intersectLayers[0]),g.spatialReference=this.spatialReference,this.emit("elevation-change",g))};a.prototype.objectChanged=function(b){this.spatialReference&&(g.extent=this.computeObjectExtent(b),g.spatialReference=this.spatialReference,this.emit("elevation-change",g))};a.prototype.computeObjectExtent=
function(b){k.empty(e);this.expandExtent(b,e);return e};a.prototype.computeLayerExtent=function(b){k.empty(e);var a=0;for(b=b.getObjects();a<b.length;a++)this.expandExtent(b[a],e);return e};a.prototype.expandExtent=function(b,a){for(var e=b.getBBMin(!0),f=b.getBBMax(!0),d=0;8>d;++d)c[0]=d&1?e[0]:f[0],c[1]=d&2?e[1]:f[1],c[2]=d&4?e[2]:f[2],l.vec3.transformMat4(c,c,b.objectTransformation),this.renderCoordsHelper.fromRenderCoords(c,c,this.spatialReference),k.expand(a,c);return a};h([f.property({constructOnly:!0})],
a.prototype,"layerView",void 0);h([f.property({constructOnly:!0})],a.prototype,"stageLayer",void 0);h([f.property()],a.prototype,"view",void 0);h([f.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],a.prototype,"spatialReference",void 0);return a=h([f.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],a)}(f.declared(r,v.Evented))});