// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/clock ../../../../../core/Collection ../../../../../core/compilerUtils ../../../../../core/Handles ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../layers/Layer ../../../../../layers/buildingSublayers/BuildingComponentSublayer ./sliceToolConfig ./sliceToolUtils ../../../support/geometryUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Layer ../../../webgl-engine/lib/Object3D ../../../webgl-engine/materials/ColorMaterial ../../../webgl-engine/materials/NativeLineMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/materials/SlicePlaneMaterial ../../../webgl-engine/parts/Model ../../../../interactive/InteractiveToolBase ../../../../interactive/interactiveToolUtils ../../../../interactive/manipulatorUtils".split(" "),
function(B,ta,Z,t,aa,ba,ca,Q,da,q,ka,w,la,u,y,v,h,n,R,ma,e,g,m,p,z,A,J,K,I,ea,ha,na,C,oa,x,pa){function L(e){return"mouse"!==e.pointerType||0===e.button}var M=da.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool");B=function(B){function c(a,b){void 0===b&&(b=aa.default);a=B.call(this,a)||this;a._clock=b;a.cursor=null;a.layersMode="none";a.excludedLayers=new ba;a.disableEngineLayers=!1;a._handles=new Q;a._viewHandles=new Q;a._frameTask=null;a._ignoreClickEventId=null;a._prevPointerMoveTimeout=
null;a._activePointerId=null;a._editingEnabled=!0;a.inputState=null;a._startPlane=m.boundedPlane.create();a._previewPlane=null;a._activeKeyModifiers={};a._lastCursorPosition=w.createScreenPoint();a._baseOpacity=1;a._hoveredResizeHandleIdx=null;a._isShiftRestartHandleHovered=!1;a._isRotateHeadingHandleHovered=!1;a._resizeHandles=[{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[1,0],visible:!1},{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[1,
1],visible:!1},{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[0,1],visible:!1},{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[-1,1],visible:!1},{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[-1,0],visible:!1},{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[-1,-1],visible:!1},{transform:v.mat4f64.create(),position:n.vec3f64.create(),scale:1,direction:[0,-1],visible:!1},{transform:v.mat4f64.create(),
position:n.vec3f64.create(),scale:1,direction:[1,-1],visible:!1}];a._shiftRestartHandle={transform:v.mat4f64.create(),position:n.vec3f64.create(),visible:!1,forceHide:!1,floating:!1};a._rotateHeadingHandle={transform:v.mat4f64.create(),position:n.vec3f64.create(),visible:!1,forceHide:!1};a._areEngineLayersCreated=!1;a._outlineResources=null;a._gridResources=null;a._shiftRestartResources=null;a._resizeHandleResources=null;a._rotateHeadingHandleResources=null;return a}Z(c,B);D=c;c.prototype.initialize=
function(){var a=this;this._handles.add([la.init(this,"state",function(){"slicing"===a.state?x.setActive(a,!0):"sliced"===a.state&&x.setActive(a,!1)},!0),this.excludedLayers.on("before-add",function(b){var d=b.item;null!=d&&(d instanceof R||d instanceof ma)?d instanceof R&&g.isAlwaysDrapedLayer(d)?(M.error("excludedLayers","Layer '"+d.title+", id:"+d.id+"' of type '"+d.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),b.preventDefault()):a.excludedLayers.includes(d)&&
b.preventDefault():(M.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),b.preventDefault())})])};c.prototype.destroy=function(){this.detach();this._handles.destroy();this._handles=null;this._viewHandles.destroy();this._viewHandles=null;this._removeFrameTask();this._clearPointerMoveTimeout()};Object.defineProperty(c.prototype,"state",{get:function(){var a=!!this.plane,b=!!this.inputState;return a?a&&b?"slicing":a&&!b?"sliced":"ready":"ready"},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"plane",{set:function(a){this._set("plane",a);this.visible&&(this._updateLayerViews(),this.view.slicePlane=a,this._updateEngineLayers(),a&&this._unsetOtherToolPlanes())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"excludeGroundSurface",{set:function(a){this._set("excludeGroundSurface",a);this._updateLayerViews()},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"editable",{set:function(a){this._set("editable",a);this._updateEngineLayers()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_internallyEditable",{get:function(){return this.editable&&this._editingEnabled&&"none"===this.layersMode},enumerable:!0,configurable:!0});c.prototype.show=function(){var a=this;this._createEngineLayers();this._updateEngineLayers();this._updateMouseCursor();this._updateLayerViews();var b=
this.view;b.slicePlane=this.plane;0===this._viewHandles.size&&(this.disableEngineLayers||this._viewHandles.add(b.state.watch("camera",function(){a._updateEngineLayers();a._updateMouseCursor()})),this._viewHandles.add([b.allLayerViews.on("change",function(){a._updateLayerViews()}),this.excludedLayers.on("change",function(b){a._updateLayerViews()})]))};c.prototype.hide=function(){this._removeEngineLayers();this._updateMouseCursor();this._updateLayerViews();this.view.slicePlane=null;this._viewHandles.removeAll();
this._clearPointerMoveTimeout()};c.prototype.newSlice=function(){this._reset();this._unsetOtherToolPlanes();x.setActive(this,!0)};c.prototype.clearSlice=function(){this._reset()};c.prototype.enterExcludeLayerMode=function(){this._set("layersMode","exclude");x.setActive(this,!0)};c.prototype.exitExcludeLayerMode=function(){this._set("layersMode","none");x.setActive(this,!1)};c.prototype.deactivate=function(){this._updateMouseCursor(!1);this._set("layersMode","none");"sliced"!==this.state&&(this.plane=
null);this._updatePreviewPlane(null)};c.prototype.disableEditing=function(){this._editingEnabled=!1;this._updateEngineLayers()};c.prototype.enableEditing=function(){this._editingEnabled=!0;this._updateEngineLayers()};c.prototype.onDetach=function(){this._reset()};c.prototype.onInputEvent=function(a){switch(a.type){case "pointer-down":if(!this._shouldHandlePointerEvent(a))break;this._onPointerDown(a)&&a.stopPropagation();this._activePointerId=a.pointerId;break;case "pointer-drag":if(!this._shouldHandlePointerEvent(a))break;
this._onPointerDrag(a)&&a.stopPropagation();break;case "pointer-move":this._onPointerMove(a)&&a.stopPropagation();this._updateMouseCursor();break;case "pointer-up":if(!this._shouldHandlePointerEvent(a))break;this._onPointerUp(a)&&a.stopPropagation();this._activePointerId=null;break;case "click":if(!L(a))break;this._onClick(a)&&a.stopPropagation();break;case "double-click":if(!L(a))break;this._onDoubleClick(a)&&a.stopPropagation();break;case "drag":this.inputState&&a.stopPropagation();break;case "key-down":this._onKeyDown(a)&&
a.stopPropagation();break;case "key-up":this._onKeyUp(a)&&a.stopPropagation()}};c.prototype._reset=function(){this.plane=null;this._set("layersMode","none")};c.prototype._createEngineLayers=function(){var a=this;if(!this._areEngineLayersCreated&&!this.disableEngineLayers){this._areEngineLayersCreated=!0;var b=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]],d=new z(A.createPolylineGeometry(b),"slice-outline"),c=e.PLANE_OUTLINE_COLOR.slice(),r=new ha({color:c,writeDepth:!1,width:e.PLANE_OUTLINE_WIDTH},
"slice-outline");r.renderOccluded=4;var f=new J("slice-outline",{isPickable:!1}),k=new K({idHint:"slice-outline"}),l=function(b){k.removeAllGeometries();b&&(c[3]=e.PLANE_OUTLINE_COLOR[3]*a._baseOpacity,r.setParameterValues({color:c}),k.addGeometry(d,r,b))};f.addObject(k);this._outlineResources={layer:f,objects:[k],materials:[r],resetGeometry:l};this._addResourcesToStage(this._outlineResources);var m=new z(A.createSquareGeometry(),"slice-grid"),h=e.PLANE_BACKGROUND_COLOR.slice(),p=new na({backgroundColor:h,
gridColor:e.GRID_COLOR,gridWidth:4},"slice-grid");p.renderOccluded=4;var f=new J("slice-grid",{isPickable:!1}),q=new K({idHint:"slice-grid"}),u=[0,0,0,0],l=function(b){q.removeAllGeometries();b&&(h[3]=e.PLANE_BACKGROUND_COLOR[3]*a._baseOpacity,p.setParameterValues({backgroundColor:h,gridColor:a.inputState&&"resize"===a.inputState.type?e.GRID_COLOR:u}),q.addGeometry(m,p,b))};f.addObject(q);this._gridResources={layer:f,objects:[q],materials:[p],resetGeometry:l};this._addResourcesToStage(this._gridResources);
var t=[n.vec3f64.fromValues(0,0,-e.SHIFT_RESTART_ARROW_LENGTH/2),n.vec3f64.fromValues(0,0,e.SHIFT_RESTART_ARROW_LENGTH/2)],b=g.addArrowTips(t,!0),f=function(a,b){return g.createArrowGeometry(t,t,{tubeRadius:e.SHIFT_RESTART_TUBE_RADIUS,tipRadius:e.SHIFT_RESTART_TIP_RADIUS,tipLength:e.SHIFT_RESTART_TIP_LENGTH,tubeFocusMultiplier:e.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:e.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER,padding:a,bothEnds:!0,flat:null,focusTipLength:!0,addCap:b})},w=f(0,!1),C=f(e.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,
!0),x=new I({color:e.SHIFT_RESTART_ARROW_TIP_COLOR,cullFace:"back"},"slice-shift");x.renderOccluded=8;var B=new I({color:e.SHIFT_RESTART_ARROW_CAP_COLOR,cullFace:"back"},"slice-shift");B.renderOccluded=8;var D=new I({color:e.SHIFT_RESTART_TUBE_COLOR,cullFace:"back"},"slice-shift");D.renderOccluded=8;var T=new I({color:e.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,cullFace:"front"},"slice-shift");T.renderOccluded=2;var L=new z(A.createPolylineGeometry([[0,0,0],[-e.SHIFT_RESTART_OFFSET_DISTANCE,
0,0]]),"slice-rotate-heading"),N=new z(A.createPolylineGeometry([[0,0,0],[-e.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),fa=new ea({color:e.SHIFT_RESTART_CALLOUT_COLOR},"slice-rotate-heading");fa.renderOccluded=4;var E=new K({idHint:"slice-shift"}),f=new J("slice-shift",{isPickable:!1}),U=v.mat4f64.create(),l=function(b,d){E.removeAllGeometries();b&&(d?(w.focused.forEach(function(a){var d=a.part;E.addGeometry(a.geometry,"tip"===d?x:"cap"===d?B:D,y.mat4.multiply(U,b,a.transform))}),
C.focused.forEach(function(a){E.addGeometry(a.geometry,T,y.mat4.multiply(U,b,a.transform))}),a._shiftRestartHandle.floating||E.addGeometry(N,fa,b)):(w.normal.forEach(function(a){var d=a.part;E.addGeometry(a.geometry,"tip"===d?x:"cap"===d?B:D,y.mat4.multiply(U,b,a.transform))}),C.normal.forEach(function(a){E.addGeometry(a.geometry,T,y.mat4.multiply(U,b,a.transform))}),a._shiftRestartHandle.floating||E.addGeometry(L,fa,b)))};f.addObject(E);this._shiftRestartResources={layer:f,objects:[E],materials:[x,
D,T],intersectPath:b,resetGeometry:l};this._addResourcesToStage(this._shiftRestartResources);var b=[[1,0,0],[0,0,0],[0,1,0]],Q=new z(A.createPolylineGeometry(b),"slice-resize"),R=new z(A.createPolylineGeometry([[1,0,0],[-1,0,0]]),"slice-resize"),f=new J("slice-resize",{isPickable:!1}),b=this._resizeHandles.map(function(){return new K({idHint:"slice-resize"})}),M=e.HANDLE_COLOR.concat([1]),O=this._resizeHandles.map(function(a){a=g.isDiagonalResizeHandle(a);a=new ha({color:M,width:a?e.RESIZE_HANDLE_CORNER_WIDTH:
e.RESIZE_HANDLE_EDGE_WIDTH},"slice-resize");a.renderOccluded=4;return a}),ga=new ea({color:M},"slice-resize");ga.renderOccluded=4;for(var l=b.map(function(b,d){return function(c,S){b.removeAllGeometries();if(c){var f=g.isDiagonalResizeHandle(a._resizeHandles[d]),r=f?Q:R;S=(f?e.RESIZE_HANDLE_CORNER_WIDTH:e.RESIZE_HANDLE_EDGE_WIDTH)*(S?e.DISPLAY_FOCUS_MULTIPLIER:1);1===S?b.addGeometry(r,ga,c):(f=O[d],f.setParameterValues({width:S}),b.addGeometry(r,f,c))}}}),F=0;F<b.length;F++)f.addObject(b[F]);this._resizeHandleResources=
{layer:f,objects:b,materials:O.concat([ga]),resetGeometries:l};this._addResourcesToStage(this._resizeHandleResources);var P=.1*Math.PI,Z=1.7*Math.PI,f=e.ROTATE_HEADING_DISC_RADIUS,l=f*e.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,b=e.ROTATE_HEADING_DISC_ARROW_RADIUS*e.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,V=e.ROTATE_HEADING_OFFSET_DISTANCE,H=function(a){for(var b=[],d=0;32>d;d++){var c=Math.PI+P+(Z-P)*d/31;b.push(n.vec3f64.fromValues(V+a*Math.cos(c),a*Math.sin(c),0))}return b},F=H(e.ROTATE_HEADING_DISC_ARROW_RADIUS),
H=H(b),b=g.addArrowTips(F,!1),ia=g.createArrowGeometry(F,H,{tubeRadius:e.ROTATE_HEADING_TUBE_RADIUS,tipRadius:e.ROTATE_HEADING_TIP_RADIUS,tipLength:e.ROTATE_HEADING_TIP_LENGTH,tubeFocusMultiplier:e.ROTATE_HEADING_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:e.ROTATE_HEADING_TIP_FOCUS_MULTIPLIER,padding:0,bothEnds:!1,flat:{thickness:2},focusTipLength:!0,addCap:!0}),W=new I({color:e.ROTATE_HEADING_ARROW_COLOR,cullFace:"back"},"slice-rotate-heading");W.renderOccluded=8;var aa=new z(A.createPolylineGeometry([[0,
0,0],[V-f,0,0]]),"slice-rotate-heading"),ba=new z(A.createPolylineGeometry([[0,0,0],[V-l,0,0]]),"slice-rotate-heading"),X=new ea({color:e.ROTATE_HEADING_CALLOUT_COLOR},"slice-rotate-heading");X.renderOccluded=4;var F=n.vec3f64.fromValues(0,0,1),H=n.vec3f64.fromValues(V,0,0),ca=new z(A.createCylinderGeometry(1,f,32,F,H),"slice-rotate-heading"),da=new z(A.createCylinderGeometry(1,l,32,F,H),"slice-rotate-heading"),Y=new I({color:e.ROTATE_HEADING_DISC_COLOR,transparent:!0,writeDepth:!1,cullFace:"back"},
"slice-rotate-heading");Y.renderOccluded=8;var f=new J("slice-rotate-heading",{isPickable:!1}),G=new K({idHint:"slice-rotate-heading"}),ja=v.mat4f64.create(),l=function(a,b){G.removeAllGeometries();a&&(b?(ia.focused.forEach(function(b){G.addGeometry(b.geometry,W,y.mat4.multiply(ja,a,b.transform))}),G.addGeometry(ba,X,a),G.addGeometry(da,Y,a)):(ia.normal.forEach(function(b){G.addGeometry(b.geometry,W,y.mat4.multiply(ja,a,b.transform))}),G.addGeometry(aa,X,a),G.addGeometry(ca,Y,a)))};f.addObject(G);
this._rotateHeadingHandleResources={layer:f,objects:[G],materials:[W,X,Y],intersectPath:b,resetGeometry:l};this._addResourcesToStage(this._rotateHeadingHandleResources)}};c.prototype._updateEngineLayers=function(){if(this._areEngineLayersCreated){this._outlineResources.resetGeometry();this._gridResources.resetGeometry();this._shiftRestartResources.resetGeometry();this._resizeHandleResources.resetGeometries.forEach(function(a){return a()});this._rotateHeadingHandleResources.resetGeometry();g.hideHandles(this._shiftRestartHandle,
this._rotateHeadingHandle,this._resizeHandles);var a=this.plane||q.isSome(this._previewPlane)&&this._previewPlane,b=a===this._previewPlane;if(a){var d=g.calculateBoundedPlaneTranslateRotate(a,qa),c=h.vec3.set(p.sv3d.get(),h.vec3.length(a.basis1),h.vec3.length(a.basis2),1);y.mat4.fromScaling(N,c);var c=y.mat4.multiply(N,d,N),r=this.view._stage.getCamera(),f=g.calculateScreenSpaceBasisLength2(a.origin,a.basis1,r),k=g.calculateScreenSpaceBasisLength2(a.origin,a.basis2,r),f=Math.max(f,k);this._gridResources.resetGeometry(c);
b?this._outlineResources.resetGeometry(c):(this._internallyEditable&&f>e.SHIFT_MIN_BASIS_SCREEN_LEN2&&(g.updateShiftRestartHandle(this._shiftRestartHandle,d,a,this.view.renderCoordsHelper,r),g.updateShiftRestartObject(this._shiftRestartResources.resetGeometry,this._shiftRestartHandle,this._isShiftRestartHandleFocused())),this._internallyEditable&&f>e.PLANE_MIN_BASIS_SCREEN_LEN2?(g.updateResizeHandles(d,a,this._resizeHandles),g.updateResizeHandleObjects(this._resizeHandleResources.resetGeometries,
this._resizeHandles,this._focusedResizeHandleIdx())):this._outlineResources.resetGeometry(c),this._internallyEditable&&f>e.ROTATE_MIN_BASIS_SCREEN_LEN2&&(g.updateRotateHeadingHandle(d,a,this.view.renderCoordsHelper,r,this._rotateHeadingHandle,this._isRotateHeadingHandleFocused()),g.updateRotateHeadingObject(this._rotateHeadingHandleResources.resetGeometry,this._rotateHeadingHandle,this._isRotateHeadingHandleFocused())))}}};c.prototype._removeEngineLayers=function(){this._areEngineLayersCreated&&(this._areEngineLayersCreated=
!1,this._removeResourcesFromStage(this._outlineResources),this._outlineResources=null,this._removeResourcesFromStage(this._gridResources),this._gridResources=null,this._removeResourcesFromStage(this._shiftRestartResources),this._shiftRestartResources=null,this._removeResourcesFromStage(this._resizeHandleResources),this._resizeHandleResources=null,this._removeResourcesFromStage(this._rotateHeadingHandleResources),this._rotateHeadingHandleResources=null)};c.prototype._updateLayerViews=function(){var a=
this.view.tools.some(function(a){return a instanceof D&&!!a.plane}),b=[],d=function(a){"layers"in a?a.layers.forEach(d):b.push(a)};this.excludedLayers.forEach(d);this.view.allLayerViews.forEach(function(d){"slicePlaneEnabled"in d&&(d.slicePlaneEnabled=a&&0>b.indexOf(d.layer));"componentLayerViews"in d&&d.componentLayerViews.forEach(function(d){d.slicePlaneEnabled=a&&0>b.indexOf(d.layer)})});this.view.basemapTerrain.slicePlaneEnabled=a&&!this.excludeGroundSurface};c.prototype._onPointerDown=function(a){var b=
this;if("exclude"===this.layersMode||!this._internallyEditable)return!1;var d=!1,c=this.view._stage.getCamera(),e=this._calculatePickRay(w.createScreenPointFromEvent(a)),f=function(a,b,d){b=g.createShiftPlane(b,d.plane,e.direction,m.plane.create());d=n.vec3f64.create();m.plane.intersectRay(b,e,d);return{type:"shift",creating:a,shiftPlane:b,depth:0,startPoint:d}};if(this.plane)if(g.intersectsShiftRestartHandle(this._shiftRestartHandle,this._shiftRestartResources.intersectPath,{camera:c,pointerType:a.pointerType,
ray:e}))m.boundedPlane.copy(this.plane,this._startPlane),this.inputState=f(!1,this._shiftRestartHandle.position,this.plane),d=!0;else if(g.intersectsRotateHeadingHandle(this._rotateHeadingHandle,this._rotateHeadingHandleResources.intersectPath,{camera:c,pointerType:a.pointerType,ray:e})){var k=g.createRotatePlane(this.plane,this.view.renderCoordsHelper,m.plane.create()),l=n.vec3f64.create();m.plane.intersectRay(k,e,l)&&(m.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate-heading",
rotatePlane:k,startPoint:l},d=!0)}else{k=function(d,f){return g.intersectsResizeHandle(d,b.plane,{camera:c,pointerType:a.pointerType,ray:e})&&(d=p.sv3d.get(),m.plane.intersectRay(b.plane.plane,e,d))?(m.boundedPlane.copy(b.plane,b._startPlane),b.inputState={type:"resize",activeHandleIdx:f,startPoint:n.vec3f64.clone(d)},!0):!1};for(l=0;l<this._resizeHandles.length&&!d;l++){var h=this._resizeHandles[l];g.isDiagonalResizeHandle(h)&&k(h,l)&&(d=!0)}for(l=0;l<this._resizeHandles.length&&!d;l++)h=this._resizeHandles[l],
!g.isDiagonalResizeHandle(h)&&k(h,l)&&(d=!0)}d||this.inputState||this.plane||!this.active||(k=this.plane||m.boundedPlane.create(),this._pickPlane(w.createScreenPointFromEvent(a),!1,this._activeKeyModifiers,k)&&(m.boundedPlane.copy(k,this._startPlane),this.inputState=f(!0,k.origin,k),this.plane=k,d=!0));d&&this._updateMouseCursor();return d};c.prototype._onPointerDrag=function(a){var b=this.inputState;if(!b||!this.plane)return!1;if("end"===a.action)return this._finishInput(a);var d=this._calculatePickRay(w.createScreenPointFromEvent(a));
a=this.view._stage.getCamera();switch(b.type){case "shift":if(m.plane.intersectRay(b.shiftPlane,d,O)){a=Math.min((1-Math.abs(h.vec3.dot(this.plane.plane,d.direction)))/.001,1);var c=-m.plane.signedDistance(this._startPlane.plane,O),d=-m.plane.signedDistance(this._startPlane.plane,b.startPoint);b.depth=b.depth*(1-a)+c*a-d;h.vec3.copy(P,this._startPlane.origin);a=h.vec3.copy(p.sv3d.get(),this._startPlane.plane);h.vec3.scale(a,a,-b.depth);h.vec3.add(a,a,P);m.boundedPlane.fromValues(a,this.plane.basis1,
this.plane.basis2,this.plane);this.plane=this.plane}break;case "resize":c=p.sv3d.get();m.plane.intersectRay(this.plane.plane,d,c)&&(this.plane=g.resizePlane(this._resizeHandles[b.activeHandleIdx],b.startPoint,c,a,this._startPlane,this.plane));break;case "rotate-heading":a=p.sm4d.get();c=p.sv3d.get();m.plane.intersectRay(b.rotatePlane,d,c)&&(d=b.rotatePlane,b=pa.calculateInputRotationTransform(b.startPoint,c,this.plane.origin,d),y.mat4.rotate(a,y.mat4.identity(a),b,d),b=h.vec3.transformMat4(p.sv3d.get(),
this._startPlane.basis1,a),a=h.vec3.transformMat4(p.sv3d.get(),this._startPlane.basis2,a),m.boundedPlane.fromValues(this.plane.origin,b,a,this.plane),this.plane=this.plane);break;default:ca.neverReached(b)}return!0};c.prototype._onPointerMove=function(a){this._lastCursorPosition.x=a.x;this._lastCursorPosition.y=a.y;if(this._shiftRestartHandle.forceHide||this._rotateHeadingHandle.forceHide)this._shiftRestartHandle.forceHide=!1,this._rotateHeadingHandle.forceHide=!1,this._updateEngineLayers();this._resetPointerMoveTimeout();
if("touch"===a.pointerType)return!1;this._updatePreviewPlane(w.createScreenPointFromEvent(a),this._activeKeyModifiers);if(!this.plane||!this._internallyEditable)return!1;this._updateHovered(a)&&(this._updateEngineLayers(),this._updateMouseCursor());return null!=this._hoveredResizeHandleIdx||this._isShiftRestartHandleHovered||this._isRotateHeadingHandleHovered};c.prototype._onPointerUp=function(a){return this._finishInput(a)?(this._ignoreClickEventId=a.eventId,!0):!1};c.prototype._onClick=function(a){var b=
this;return"exclude"===this.layersMode?(this.view.hitTest(w.createScreenPointFromEvent(a)).then(function(a){a.results.length?(a=(a=a.results[0])&&a.graphic)&&(a=a.sourceLayer||a.layer)&&b.excludedLayers.push(a):b.excludeGroundSurface=!0}),this._set("layersMode","none"),x.setActive(this,!1),!0):!!this.inputState||this._ignoreClickEventId===a.eventId};c.prototype._onDoubleClick=function(a){return this._ignoreClickEventId===a.eventId};c.prototype._onKeyDown=function(a){return"Escape"===a.key&&this.plane&&
this.active?(this.plane=null,!0):a.key===e.forceVerticalModifier||a.key===e.forceHorizontalModifier?(this._activeKeyModifiers[a.key]=!0,q.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0):!1};c.prototype._onKeyUp=function(a){return a.key!==e.forceVerticalModifier&&a.key!==e.forceHorizontalModifier||!this._activeKeyModifiers[a.key]?!1:(delete this._activeKeyModifiers[a.key],q.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,
this._activeKeyModifiers),!0)};c.prototype._finishInput=function(a){var b=this.inputState;this.inputState=null;if(!b||!this.plane)return!1;m.boundedPlane.copy(this.plane,this._startPlane);this._updateHovered(a);this._updateEngineLayers();this._updateMouseCursor();return!0};c.prototype._updatePreviewPlane=function(a,b){var c=this;void 0===b&&(b={});var g=this._previewPlane;this._previewPlane=null;if(q.isNone(a))this._removeFrameTask();else{if(!this.plane&&this.active){var r=q.isSome(g)?g:m.boundedPlane.create(),
g=q.isSome(g)?m.boundedPlane.copy(g,ra):null;this._pickPlane(a,!0,b,r)&&(a=e.PREVIEW_FADE_DOT_THRESHOLD,b=!1,q.isSome(g)&&(b=h.vec3.dot(g.plane,r.plane)<a||h.vec3.dot(h.vec3.normalize(p.sv3d.get(),g.basis1),h.vec3.normalize(p.sv3d.get(),r.basis1))<a),b&&(this._baseOpacity=0),this._previewPlane=r)}q.isSome(this._previewPlane)&&q.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=ka.addFrameTask({update:function(a){c._baseOpacity=Math.min(c._baseOpacity+a.deltaTime/(1E3*e.PREVIEW_FADE_DURATION_SECONDS),
1);c._updateEngineLayers();1===c._baseOpacity&&c._removeFrameTask()}}):q.isNone(this._frameTask)&&(this._updateEngineLayers(),this._removeFrameTask())}};c.prototype._removeFrameTask=function(){q.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)};c.prototype._updateHovered=function(a){var b=this,c=this._hoveredResizeHandleIdx,e=this._isShiftRestartHandleHovered,h=this._isRotateHeadingHandleHovered;this._hoveredResizeHandleIdx=null;this._isRotateHeadingHandleHovered=this._isShiftRestartHandleHovered=
!1;var f=a.pointerType,k=function(){return!b._isAnyHandleFocused()&&"touch"!==f};a=this._calculatePickRay(w.createScreenPointFromEvent(a));var l=this.view._stage.getCamera();k()&&(this._isShiftRestartHandleHovered=g.intersectsShiftRestartHandle(this._shiftRestartHandle,this._shiftRestartResources.intersectPath,{camera:l,pointerType:f,ray:a}));k()&&(this._isRotateHeadingHandleHovered=g.intersectsRotateHeadingHandle(this._rotateHeadingHandle,this._rotateHeadingHandleResources.intersectPath,{camera:l,
pointerType:f,ray:a}));if(k())for(k=0;k<this._resizeHandles.length;k++)if(g.intersectsResizeHandle(this._resizeHandles[k],this.plane,{camera:l,pointerType:f,ray:a})){this._hoveredResizeHandleIdx=k;break}return this._hoveredResizeHandleIdx!==c||this._isShiftRestartHandleHovered!==e||this._isRotateHeadingHandleHovered!==h};c.prototype._focusedResizeHandleIdx=function(){return this.inputState&&"resize"===this.inputState.type?this.inputState.activeHandleIdx:this._hoveredResizeHandleIdx};c.prototype._isShiftRestartHandleFocused=
function(){return this.inputState&&"shift"===this.inputState.type?!0:this._isShiftRestartHandleHovered};c.prototype._isRotateHeadingHandleFocused=function(){return this.inputState&&"rotate-heading"===this.inputState.type?!0:this._isRotateHeadingHandleHovered};c.prototype._calculatePickRay=function(a){var b=m.ray.create();a=w.screenPointObjectToArray(a,sa);m.ray.fromScreen(this.view.state.camera,a,b);h.vec3.normalize(b.direction,b.direction);return b};c.prototype._pickIntersector=function(a){a=w.screenPointObjectToArray(a,
p.sv2d.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a)};c.prototype._pickPlane=function(a,b,c,m){var d=this._pickIntersector(a).results.min;a=p.sv3d.get();if(!d.getIntersectionPoint(a))return!1;var d=d.getTransformedNormal(p.sv3d.get()),f=this.view._stage.getCamera();0<h.vec3.dot(d,f.viewForward)&&h.vec3.scale(d,d,-1);var k=g.calculatePlaneHalfSize(a,f);b=(b?1:-1)*k*e.INITIAL_DEPTH_OFFSET_FRAC;b=h.vec3.scale(p.sv3d.get(),d,b);h.vec3.add(b,b,a);g.createPlane(b,d,0,
k,k,f,c[e.forceVerticalModifier]?"vertical":c[e.forceHorizontalModifier]?"horizontal":null,this.view.renderCoordsHelper,m);return!0};c.prototype._addResourcesToStage=function(a){var b=this;a.materials.forEach(function(a){return b.view._stage.add(C.ContentType.MATERIAL,a)});a.objects.forEach(function(a){return b.view._stage.add(C.ContentType.OBJECT,a)});this.view._stage.add(C.ContentType.LAYER,a.layer);this.view._stage.addToViewContent([a.layer.id])};c.prototype._removeResourcesFromStage=function(a){var b=
this;this.view._stage.remove(C.ContentType.LAYER,a.layer.id);this.view._stage.removeFromViewContent([a.layer.id]);a.objects.forEach(function(a){return b.view._stage.remove(C.ContentType.OBJECT,a.id)});a.materials.forEach(function(a){return b.view._stage.remove(C.ContentType.MATERIAL,a.id)})};c.prototype._updateMouseCursor=function(a){void 0===a&&(a=this.active);this._set("cursor",null);this._isAnyHandleFocused()?this._set("cursor","slicing"===this.state?"grabbing":"pointer"):a&&this._set("cursor",
"crosshair")};c.prototype._isAnyHandleFocused=function(){return null!=this._focusedResizeHandleIdx()||this._isShiftRestartHandleFocused()||this._isRotateHeadingHandleFocused()};c.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)};c.prototype._resetPointerMoveTimeout=function(){var a=this;this._clearPointerMoveTimeout();this._prevPointerMoveTimeout=this._clock.setTimeout(function(){a._shiftRestartHandle.forceHide=
!0;a._isShiftRestartHandleHovered=!1;a._rotateHeadingHandle.forceHide=!0;a._isRotateHeadingHandleHovered=!1;a._updateEngineLayers();a._updateMouseCursor()},e.POINTER_MOVE_TIMER_MS)};c.prototype._shouldHandlePointerEvent=function(a){return L(a)&&(q.isNone(this._activePointerId)||this._activePointerId===a.pointerId)};c.prototype._unsetOtherToolPlanes=function(){var a=this;this.view.tools.forEach(function(b){b!==a&&b instanceof D&&(b._set("plane",null),b._updateEngineLayers())})};var D;t([u.property({constructOnly:!0})],
c.prototype,"view",void 0);t([u.property({dependsOn:["plane","inputState"],readOnly:!0})],c.prototype,"state",null);t([u.property({dependsOn:["view.type"],readOnly:!0})],c.prototype,"isSupported",null);t([u.property({readOnly:!0})],c.prototype,"cursor",void 0);t([u.property({value:null})],c.prototype,"plane",null);t([u.property({readOnly:!0})],c.prototype,"layersMode",void 0);t([u.property({readOnly:!0})],c.prototype,"excludedLayers",void 0);t([u.property({type:Boolean,value:!1})],c.prototype,"excludeGroundSurface",
null);t([u.property({value:!0})],c.prototype,"editable",null);t([u.property()],c.prototype,"inputState",void 0);return c=D=t([u.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],c)}(u.declared(oa));var O=n.vec3f64.create(),P=n.vec3f64.create(),qa=v.mat4f64.create(),N=v.mat4f64.create(),ra=m.boundedPlane.create(),sa=w.createScreenPointArray();return B});