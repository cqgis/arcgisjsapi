// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/has ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/buffer/InterleavedLayout ../lib/GLMaterialTexture ../lib/Material ../lib/Util ./internal/bufferWriters ./internal/MaterialUtil ./internal/MaterialUtil ./renderers/HardwareInstancedRenderer ./renderers/MergedRenderer ../shaders/DefaultPrograms ../../../webgl/renderState".split(" "),
function(n,T,m,U,z,D,h,l,A,q,E,F,G,p,f,H,I,r,g){function t(e,a){var b=a.vvSizeEnabled;a.vvSizeEnabled?(e.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",a.vvSizeOffset),e.setUniform3fv("vvSizeFactor",a.vvSizeFactor)):b&&e.setUniform3fv("vvSizeValue",a.vvSizeValue);b&&(e.setUniform3fv("vvSymbolAnchor",a.vvSymbolAnchor),e.setUniformMatrix3fv("vvSymbolRotationMatrix",a.vvSymbolRotationMatrix));a.vvColorEnabled&&(e.setUniform1fv("vvColorValues",
a.vvColorValues),e.setUniform4fv("vvColorColors",a.vvColorColors))}var w=F.assert;n=function(e){function a(b,c){c=e.call(this,c)||this;c.supportsEdges=!0;c.params=f.copyParameters(b,J);c.vertexBufferLayout=a.getVertexBufferLayout(c.params);c.instanceBufferLayout=b.instanced?a.getInstanceBufferLayout(c.params):null;c.textureMode=c.vertexBufferLayout.hasField("uv0")?"Textured":"none";return c}m(a,e);a.prototype.isVisibleInPass=function(b){return 3===b?this.params.castShadows:!0};a.prototype.isVisible=
function(){var b=this.params;if(!e.prototype.isVisible.call(this)||0===b.layerOpacity)return!1;var c=b.instanced,a=b.vertexColors,d=b.symbolColors,c=!!c&&-1<c.indexOf("color"),f=b.vvColorEnabled,g="replace"===b.colorMixMode,h=0<b.opacity,b=b.externalColor&&0<b.externalColor[3];return a&&(c||f||d)?g?!0:h:a?g?b:h:c||f||d?g?!0:h:g?b:h};a.prototype.setParameterValues=function(b){var c=this.params,a;for(a in b)"instanced"===a&&w(b.instanced===c.instanced,"Can not change instanced attributes"),"textureId"===
a&&w(c.textureId,"Can only change texture of material that already has a texture"),"vertexColors"===a&&!0===b[a]&&b[a]!==c[a]&&w(c.vertexColors,"Can not enable vertex colors after DefaultMaterial creation"),c[a]=b[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(b,c,a,d,e,g,l,m){if(null!==this.params.verticalOffset){m=d.camera;h.vec3.set(x,a[12],a[13],a[14]);var k=h.vec3.subtract(K,x,m.eye),n=h.vec3.length(k),q=h.vec3.scale(k,
k,1/n),p=null,k=null;switch(d.viewingMode){case "global":k=h.vec3.normalize(B,x);break;case "local":k=h.vec3.copy(B,L)}this.params.screenSizePerspective&&(p=h.vec3.dot(k,q));m=f.verticalOffsetAtDistance(m,n,this.params.verticalOffset,p,this.params.screenSizePerspective);h.vec3.scale(k,k,m);h.vec3.transformMat3(y,k,d.transform.inverseRotation);e=h.vec3.subtract(M,e,y);g=h.vec3.subtract(N,g,y)}f.intersectTriangleGeometry(b,c,a,d,e,g,l)};a.prototype.getGLMaterials=function(){return{color:O,depthShadowMap:P,
normal:Q,depth:C,highlight:R}};a.prototype.getAllTextureIds=function(){var b=[];this.params.textureId&&b.push(this.params.textureId);this.params.normalTextureId&&b.push(this.params.normalTextureId);return[]};a.prototype.createRenderer=function(b,c){return this.params.instanced&&0<this.params.instanced.length?new H(b,c,this):new I(b,c,this)};a.prototype.createBufferWriter=function(){return new S(this.vertexBufferLayout,this.instanceBufferLayout)};a.getVertexBufferLayout=function(b){var c=A.newLayout().vec3f("position").vec3f("normal");
b.vertexTangents&&c.vec4f("aTangent");b.textureId&&c.vec2f("uv0");b.vertexColors&&c.vec4u8("color");b.symbolColors&&c.vec4u8("symbolColor");return c};a.getInstanceBufferLayout=function(b){var c=A.newLayout(),c=b.instancedDoublePrecision?c.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):c.mat4f("model").mat4f("modelNormal");b.instanced&&-1<b.instanced.indexOf("color")&&(c=c.vec4f("instanceColor"));b.instanced&&-1<b.instanced.indexOf("featureAttribute")&&(c=c.vec4f("instanceFeatureAttribute"));
return c};return a}(E);var O=function(e){function a(b,c,a){var d=this,k=b.getParameters(),d=e.call(this,b,c,a,k.textureId,k.normalTextureId,k.textureInitTransparent)||this;d.params=f.copyParameters(k);c=d.params;d.slot=c.transparent?c.writeDepth?6:9:4;d.textureMode=b.textureMode;b=c.instanced;d.instanced=!!b;d.instancedColor=!!b&&-1<b.indexOf("color");d._createPrograms();d.selectPipeline();return d}m(a,e);a.prototype._createPrograms=function(){var b=this;this.programs=p.BindParametersMap.create(this.params,
function(c){return b._createProgram(c)})};a.prototype._createProgram=function(b){var c=this.params;return this.programRep.getProgram(r.colorPass,{treeRendering:!!c.treeRendering,textureMode:this.textureMode,normalTexture:!!c.normalTextureId,tangents:c.vertexTangents?"vertex":"none",vertexColors:c.vertexColors,symbolColors:c.symbolColors,flipV:c.flipV,doubleSided:c.doubleSided&&"normal"===c.doubleSidedType,windowOrderDoubleSided:c.doubleSided&&"winding-order"===c.doubleSidedType,instanced:!!this.instanced,
instancedDoublePrecision:c.instancedDoublePrecision,instancedColor:this.instancedColor,receiveShadows:b.receiveShadows,receiveSSAO:b.receiveSSAO,vvSize:c.vvSizeEnabled,vvColor:c.vvColorEnabled,verticalOffset:null!==c.verticalOffset,screenSizePerspective:null!==c.screenSizePerspective,slice:c.slicePlaneEnabled,normals:c.normals,textureAlphaMode:c.textureAlphaMode,textureAlphaPremultiplied:!!c.textureAlphaPremultiplied,iosSafariFix:u})};a.prototype.selectPipeline=function(){var b=this.params;this.pipelineState=
g.makePipelineState({blending:b.transparent&&g.separateBlendingParams(770,1,771,771),culling:v(b),depthTest:{func:513},depthWrite:b.writeDepth&&g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program||this.getPrograms()[0]};a.prototype.getPrograms=function(){return p.BindParametersMap.programs(this.programs)};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());
this.slot=this.params.transparent?this.params.writeDepth?6:9:4;this.updateTexture(this.params.textureId);this._createPrograms();this.selectPipeline()};a.prototype.bind=function(b,c){var a=this.params,d=this.program=p.BindParametersMap.lookup(this.programs,c);b.bindProgram(d);b.setPipelineState(this.pipelineState);d.setUniform3fv("ambient",a.ambient);d.setUniform3fv("diffuse",a.diffuse);d.setUniform3fv("specular",a.specular);d.setUniform4fv("externalColor",a.externalColor);d.setUniform1i("colorMixMode",
f.colorMixModes[a.colorMixMode]);d.setUniform1f("opacity",a.opacity);d.setUniform1f("layerOpacity",a.layerOpacity);f.bindVerticalOffset(a.verticalOffset,c,d);f.bindScreenSizePerspective(a.screenSizePerspective,d);t(d,a);this.bindTexture(b,d);"none"!==this.textureMode&&this.bindTextureSize(b,d);"mask"!==a.textureAlphaMode&&"maskBlend"!==a.textureAlphaMode||d.setUniform1f("textureAlphaCutoff",a.textureAlphaCutoff)};a.prototype.release=function(b,c){};a.prototype.bindView=function(b,c){b=this.program=
p.BindParametersMap.lookup(this.programs,c);var a=this.params,d=a.instancedDoublePrecision?l.vec3f64.fromValues(c.viewInvTransp[3],c.viewInvTransp[7],c.viewInvTransp[11]):c.origin;f.bindView(d,c.view,b);f.bindCamPos(d,c.viewInvTransp,b);a.instancedDoublePrecision&&f.bindViewOriginDouble(d,b);a.slicePlaneEnabled&&f.bindSlicePlane(d,c.slicePlane,b);c.shadowMappingEnabled&&c.shadowMap.bindView(b,d)};a.prototype.bindInstance=function(b,c){b=this.program;b.setUniformMatrix4fv("model",c.transformation);
b.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return 4};return a}(q),C=function(e){function a(b,c,a,d){void 0===d&&(d=!1);c=e.call(this,b,c,a,b.getParameters().textureId)||this;c.textureMode=b.textureMode;c.biased=d;c.updateParameters();return c}m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(r.depthPass,
{textureMode:this.textureMode,normalTexture:!!b.normalTextureId,tangents:b.vertexTangents?"vertex":"none",flipV:b.flipV,instanced:!!b.instanced,instancedDoublePrecision:b.instancedDoublePrecision,shadowMap:this.biased,vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,textureAlphaMode:b.textureAlphaMode,normals:b.normals,iosSafariFix:u});this.pipelineState=g.makePipelineState({culling:v(b),depthTest:{func:513},
depthWrite:b.writeDepth&&g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?this.params.writeDepth?6:9:4};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(b,c){var a=this.program,d=this.params;b.bindProgram(a);b.setPipelineState(this.pipelineState);a.setUniform2fv("nearFar",
c.nearFar);f.bindVerticalOffset(d.verticalOffset,c,a);f.bindScreenSizePerspective(d.screenSizePerspective,a);t(a,d);"mask"!==d.textureAlphaMode&&"maskBlend"!==d.textureAlphaMode||a.setUniform1f("textureAlphaCutoff",d.textureAlphaCutoff);this.bindTexture(b,a)};a.prototype.release=function(b){};a.prototype.bindView=function(b,c){b=this.program;var a=this.params,d=a.instancedDoublePrecision?l.vec3f64.fromValues(c.viewInvTransp[3],c.viewInvTransp[7],c.viewInvTransp[11]):c.origin;f.bindView(d,c.view,b);
a.slicePlaneEnabled&&f.bindSlicePlane(d,c.slicePlane,b);a.screenSizePerspective&&f.bindCamPos(d,c.viewInvTransp,b);a.instancedDoublePrecision&&f.bindViewOriginDouble(d,b)};a.prototype.bindInstance=function(b,c){this.program.setUniformMatrix4fv("model",c.transformation)};a.prototype.getDrawMode=function(){return 4};return a}(q),P=function(e){function a(b,c,a){return e.call(this,b,c,a,!0)||this}m(a,e);return a}(C),Q=function(e){function a(b,c,a){c=e.call(this,b,c,a,b.getParameters().textureId)||this;
c.params=f.copyParameters(b.getParameters());c.textureMode=b.textureMode;c.selectProgram();c.selectSlot();return c}m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(r.normalPass,{textureMode:this.textureMode,normalTexture:!!b.normalTextureId,tangents:b.vertexTangents?"vertex":"none",flipV:b.flipV,instanced:!!b.instanced,instancedDoublePrecision:b.instancedDoublePrecision,
vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,textureAlphaMode:b.textureAlphaMode,normals:b.normals,iosSafariFix:u});this.pipelineState=g.makePipelineState({culling:v(b),depthTest:{func:513},depthWrite:b.writeDepth&&g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?this.params.writeDepth?6:9:4};a.prototype.updateParameters=
function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(b,c){var a=this.program,d=this.params;b.bindProgram(a);b.setPipelineState(this.pipelineState);this.bindTexture(b,a);f.bindVerticalOffset(d.verticalOffset,c,a);f.bindScreenSizePerspective(d.screenSizePerspective,a);t(a,d);"mask"!==d.textureAlphaMode&&"maskBlend"!==d.textureAlphaMode||a.setUniform1f("textureAlphaCutoff",d.textureAlphaCutoff)};
a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params,d=c.instancedDoublePrecision?l.vec3f64.fromValues(a.viewInvTransp[3],a.viewInvTransp[7],a.viewInvTransp[11]):a.origin;f.bindView(d,a.view,b);b.setUniformMatrix4fv("viewNormal",a.viewInvTransp);c.slicePlaneEnabled&&f.bindSlicePlane(d,a.slicePlane,b);c.screenSizePerspective&&f.bindCamPos(d,a.viewInvTransp,b);c.instancedDoublePrecision&&f.bindViewOriginDouble(d,b)};a.prototype.bindInstance=function(b,
a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.getDrawMode=function(){return 4};return a}(q),R=function(e){function a(b,a,f){a=e.call(this,b,a,f,b.getParameters().textureId)||this;a.textureMode=b.textureMode;a.updateParameters();return a}m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;
this.program=this.programRep.getProgram(r.highlightPass,{textureMode:this.textureMode,normalTexture:!!b.normalTextureId,tangents:b.vertexTangents?"vertex":"none",flipV:b.flipV,instanced:!!b.instanced,instancedDoublePrecision:b.instancedDoublePrecision,vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,textureAlphaMode:b.textureAlphaMode,normals:b.normals,iosSafariFix:u});this.pipelineState=g.makePipelineState({culling:v(b),
depthTest:{func:513},depthWrite:b.writeDepth&&g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?this.params.writeDepth?6:9:4};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);
f.bindHighlightRendering(b,a,c);this.bindTexture(b,c);f.bindVerticalOffset(d.verticalOffset,a,c);f.bindScreenSizePerspective(d.screenSizePerspective,c);t(c,d);"mask"!==d.textureAlphaMode&&"maskBlend"!==d.textureAlphaMode||c.setUniform1f("textureAlphaCutoff",d.textureAlphaCutoff)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params,d=c.instancedDoublePrecision?l.vec3f64.fromValues(a.viewInvTransp[3],a.viewInvTransp[7],a.viewInvTransp[11]):a.origin;
f.bindView(d,a.view,b);c.slicePlaneEnabled&&f.bindSlicePlane(d,a.slicePlane,b);c.screenSizePerspective&&f.bindCamPos(d,a.viewInvTransp,b);c.instancedDoublePrecision&&f.bindViewOriginDouble(d,b)};a.prototype.bindInstance=function(b,a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.getDrawMode=function(){return 4};return a}(q);(n||(n={})).COLOR_GAMMA=2.1;var J={textureId:void 0,textureInitTransparent:!1,normalTextureId:void 0,
vertexTangents:!1,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,castShadows:!0,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,
1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:D.mat3f64.create(),transparent:!1,writeDepth:!0,textureAlphaMode:"blend",textureAlphaCutoff:.1,textureAlphaPremultiplied:!1},S=function(){function e(a,b){this.vertexBufferLayout=a;this.instanceBufferLayout=b}e.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};e.prototype.elementCount=
function(a){return a.indices.position.length};e.prototype.write=function(a,b,c,e,d){G.writeDefaultAttributes(b,c,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,e,d)};return e}(),v=function(e){var a;a=e.slicePlaneEnabled?!1:e.cullFace?"none"!==e.cullFace:!e.transparent&&!e.doubleSided;return a&&{face:"front"===e.cullFace?1028:1029,mode:2305}},u=!!z("ios")&&!!z("safari"),M=l.vec3f64.create(),N=l.vec3f64.create(),L=l.vec3f64.fromValues(0,0,1),B=l.vec3f64.create(),y=l.vec3f64.create(),
x=l.vec3f64.create(),K=l.vec3f64.create();return n});