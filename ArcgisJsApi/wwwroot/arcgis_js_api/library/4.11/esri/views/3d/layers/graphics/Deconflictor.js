// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/Handles ../../../../core/PooledArray ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingRect ./deconflictorDebug ../../support/debugFlags ../../support/earthUtils ../../support/geometryUtils ../../support/mathUtils ../../support/geometryUtils/sphere ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(z,E,ea,M,N,g,O,P,w,F,r,t,u,Q,R,x,G,S,T,H,U,A){function V(c){var a,b,d,e;return M(this,function(f){switch(f.label){case 0:a=[];for(b in c)a.push(b);d=0;f.label=1;case 1:if(!(d<a.length))return[3,4];e=a[d];return[4,c[e]];case 2:f.sent(),f.label=3;case 3:return d++,[3,1];case 4:return[2]}})}Object.defineProperty(E,"__esModule",{value:!0});var I=r.vec4f64.create(),y=r.vec4f64.create(),J=r.vec4f64.create(),W=r.vec4f64.create(),X=F.vec3f64.fromValues(0,0,0),K=x.sphere.create(),B=x.ray.create(),
L=F.vec3f64.create(),Y=t.create(),Z=t.create(),aa=function(){return function(){this.posView=this.yMax=this.yMin=this.xMax=this.xMin=0;this.pooled=this.visible=this.culled=!1}}(),ba=function(){return function(c,a,b){void 0===b&&(b={});this.graphics3DGraphic=c;this.slicePlaneEnabled=a;this.info=b}}(),ca=function(){return function(c,a){void 0===a&&(a=new Map);this.graphics3DCore=c;this.graphics=a}}();z=function(){function c(a){var b,d,e=this;this.handles=new N;this.dirty=!0;this.state=0;this.contexts=
[];this.iterators=this.graphics=null;this.accBinsNumX=15;this.accBinsNumY=20;this.accBinsSizeY=this.accBinsSizeX=0;this.accBins=null;this.accNumTests=0;this._iconMarginFactor=-.1;this.slicePlaneViewSpace=null;this.view=a;this.graphics=(b={},b[0]={active:{},visible:new g,remove:new g},b[1]={active:{},visible:new g,remove:new g},b);this.iterators=(d={},d[0]={active:null,visible:null,remove:null,sort:null},d[1]={active:null,visible:null,remove:null,sort:null},d);this.handles.add([a.watch("state.camera",
function(){e.updateSlicePlane();e.setDirtyUrgent()}),a.watch("map.ground.opacity",function(a,b){1!==a&&1!==b||e.setDirtyUrgent()}),O.init(a,"slicePlane",function(){return e.updateSlicePlane()})]);this.frameWorker=a.resourceController.scheduler.registerTask(12,function(a){return e.run(a)},function(){return e.shouldRun()})}Object.defineProperty(c.prototype,"iconMarginFactor",{get:function(){return this._iconMarginFactor},set:function(a){this._iconMarginFactor=a;this.setDirty()},enumerable:!0,configurable:!0});
c.prototype.updateSlicePlane=function(){var a=this.view&&this.view.slicePlane;a?(this.slicePlaneViewSpace||(this.slicePlaneViewSpace=x.boundedPlane.create()),x.boundedPlane.transform(a,this.view.state.camera.viewMatrix,this.slicePlaneViewSpace),this.slicePlaneChanged()):this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged())};c.prototype.slicePlaneChanged=function(){for(var a=0,b=this.contexts;a<b.length;a++)if(b[a].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();
break}};c.prototype.destroy=function(){this.handles.destroy();this.handles=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.graphics[0].active=null;this.graphics[0].visible.clear();this.graphics[0].remove.clear();this.graphics[1].active=null;this.graphics[1].visible.clear();this.graphics[1].remove.clear();this.view=this.iterators=this.graphics=null};c.prototype.addGraphicsOwner=function(a){var b=this,d=this.findDeconflictionContext(a),e;-1!==d?e=this.contexts[d]:(e=new ca(a),
this.contexts.push(e),this.setDirtyUrgent());return{addGraphic:function(a){return b.addGraphic(e,a)},removeGraphic:function(a){return b.removeGraphic(e,a)},labelingInfoChange:function(){return b.globalLabelingInfoChanged(e)},visibilityInfoChange:function(){},featureReductionChange:function(){return b.globalFeatureReductionChanged(e)},slicePlaneEnabledChange:function(){return b.globalSlicePlaneEnabledChanged(e)},clear:function(){e.graphics.forEach(function(a){b.removeGraphic(e,a.graphics3DGraphic)})}}};
c.prototype.removeGraphicsOwner=function(a){var b=this;a=this.findDeconflictionContext(a);if(-1!==a){var d=this.contexts.splice(a,1)[0];d.graphics.forEach(function(a){return b.removeGraphic(d,a.graphics3DGraphic)});this.setDirtyUrgent()}};c.prototype.setInitialIconVisibilityFlag=function(a,b){a=!(this.graphicSupportsDeconfliction(b)&&this.isFeatureReductionEnabled(a));b.setVisibilityFlag(3,a,0)};Object.defineProperty(c.prototype,"isDirty",{get:function(){return 0!==this.state||this.dirty},enumerable:!0,
configurable:!0});c.prototype.setDirtyUrgent=function(){this.dirty=!0;this.frameWorker.priority=2};c.prototype.setDirty=function(){this.dirty=!0;this.frameWorker.priority=12};c.prototype.shouldRun=function(){return this.view.ready&&null!=this.view.state&&this.isDirty};c.prototype.run=function(a){switch(this.state){case 0:u.prepare(this.view),this.dirty=!1,this.camera=this.view.state.camera,this.initBins(this.camera.fullWidth,this.camera.fullHeight),this.resetIterators(),a.madeProgress();case 1:if(this.state=
1,!this.processActiveGraphics(0,a))break;case 3:if(this.state=3,!this.cleanVisibleGraphics(0,a))break;case 5:if(this.state=5,!this.sortVisibleGraphics(0,a))break;case 7:this.state=7;if(!this.deconflictVisibleGraphics(0,a))break;u.drawAccelerationStruct(this,this.graphics[0].visible);case 2:if(this.state=2,!this.processActiveGraphics(1,a))break;case 4:if(this.state=4,!this.cleanVisibleGraphics(1,a))break;case 6:if(this.state=6,!this.sortVisibleGraphics(1,a))break;case 8:this.state=8;if(!this.deconflictVisibleGraphics(1,
a))break;u.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=0}};c.prototype.findDeconflictionContext=function(a){for(var b=0;b<this.contexts.length;b++)if(this.contexts[b].graphics3DCore===a)return b;return-1};c.prototype.globalFeatureReductionChanged=function(a){var b=this.isFeatureReductionEnabled(a.graphics3DCore);b||this.clearVisibilityFlags(a);this.modifyGraphics(a,b,0)};c.prototype.globalLabelingInfoChanged=function(a){var b=this.isLabelDeconflictionEnabled(a.graphics3DCore);
this.modifyGraphics(a,b,1)};c.prototype.globalSlicePlaneEnabledChanged=function(a){var b=a.graphics3DCore.symbolCreationContext.slicePlaneEnabled;a.graphics.forEach(function(a){a.slicePlaneEnabled=b});this.setDirtyUrgent()};c.prototype.modifyGraphics=function(a,b,d){var e=this;b?a.graphics.forEach(function(a){return e.addToActiveGraphics(a,d)}):a.graphics.forEach(function(a){return e.removeFromActiveGraphics(a,d)});this.setDirtyUrgent()};c.prototype.graphicSupportsDeconfliction=function(a){var b=
a._graphics;if(!b||!b.length||a.isDraped())return!1;for(a=0;a<b.length;a++)if(this.graphics3DGraphicsLayerSupportsDeconfliction(b[a]))return!0;return!1};c.prototype.graphics3DGraphicsLayerSupportsDeconfliction=function(a){if(!a||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.getNumGeometryRecords():0)&&a.getGeometryRecord(0).material instanceof U?!0:!1};c.prototype.addGraphic=function(a,b){var d=b.graphic.uid;b=new ba(b,a.graphics3DCore.symbolCreationContext.slicePlaneEnabled);a.graphics.set(d,
b);this.isFeatureReductionEnabled(a.graphics3DCore)&&this.addToActiveGraphics(b,0);this.isLabelDeconflictionEnabled(a.graphics3DCore)&&this.addToActiveGraphics(b,1);this.setDirty()};c.prototype.removeGraphic=function(a,b){b=b.graphic.uid;var d=a.graphics.get(b);d&&(this.removeFromActiveGraphics(d,0),this.removeFromActiveGraphics(d,1),a.graphics.delete(b),this.setDirty())};c.prototype.addToActiveGraphics=function(a,b){a.info[b]=new aa;this.graphics[b].active[a.graphics3DGraphic.graphic.uid]=a};c.prototype.removeFromActiveGraphics=
function(a,b){this.removeFromVisibleGraphics(a,b);this.clearGraphicVisibility(a,b);delete a.info[b];delete this.graphics[b].active[a.graphics3DGraphic.graphic.uid]};c.prototype.addToVisibleGraphics=function(a,b){var d=a.info[b];d&&!d.pooled&&(this.graphics[b].visible.push(a),d.pooled=!0)};c.prototype.removeFromVisibleGraphics=function(a,b){var d=a.info[b];d&&d.pooled&&(this.graphics[b].remove.push(a),d.pooled=!1)};c.prototype.processActiveGraphics=function(a,b){for(var d=this.getOrCreateActiveGraphicsIterator(a),
e="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this.camera&&0<this.camera.relativeElevation;!b.done;){b.madeProgress();var c=d.next();if(c.done)return this.resetActiveGraphicsIterator(a),!0;var n=(c=c.value)&&c.info[a];n&&(this.collectGraphics3DGraphics(c,a,e),n.culled?this.removeFromVisibleGraphics(c,a):this.addToVisibleGraphics(c,a))}return!1};c.prototype.cleanVisibleGraphics=function(a,b){for(var d=this.graphics[a],c=this.ensureRemoveGraphicsIterator(a,b);!b.done;){var f=
c.next();b.madeProgress();if(f.done)return d.remove.clear(),this.resetRemoveGraphicsIterator(a),!0}return!1};c.prototype.sortVisibleGraphics=function(a,b){for(var c=this.ensureSortGraphicsIterator(a,function(b,c){return b.info[a]&&c.info[a]?c.info[a].posView-b.info[a].posView:Number.MAX_VALUE},b);!b.done;){var e=c.next();b.madeProgress();if(e.done)return this.resetSortGraphicsIterator(a),!0}return!1};c.prototype.deconflictVisibleGraphics=function(a,b){for(var c=this.getOrCreateVisibleGraphicsIterator(a),
e=1===a;!b.done;){b.madeProgress();var f=c.next();if(f.done)return this.resetVisibleGraphicsIterator(a),!0;var f=f.value,n=f.info[a];if(n&&!n.culled){var k=f.graphics3DGraphic,k=!(e&&!k.isVisible())&&!this.doesIntersectExistingPoly(f,a);(n.visible=k)&&this.addToBins(f,a);this.setGraphicVisibility(f,a,k);k&&u.drawPoly(n,k?"green":"red")}}return!1};c.prototype.resetIterators=function(){this.iterators[0].active=null;this.iterators[0].visible=null;this.iterators[0].remove=null;this.iterators[0].sort=
null;this.iterators[1].active=null;this.iterators[1].visible=null;this.iterators[1].remove=null;this.iterators[1].sort=null};c.prototype.getOrCreateActiveGraphicsIterator=function(a){var b=this.graphics[a];a=this.iterators[a];a.active||(a.active=V(b.active));return a.active};c.prototype.resetActiveGraphicsIterator=function(a){this.iterators[a].active=null};c.prototype.getOrCreateVisibleGraphicsIterator=function(a){var b=this.graphics[a];a=this.iterators[a];a.visible||(a.visible=b.visible.iterableForEach());
return a.visible};c.prototype.resetVisibleGraphicsIterator=function(a){this.iterators[a].visible=null};c.prototype.ensureRemoveGraphicsIterator=function(a,b){var c=this.graphics[a];a=this.iterators[a];a.remove||(a.remove=c.visible.iterableRemoveMany(c.remove.data,function(){return b.done}));return a.remove};c.prototype.resetRemoveGraphicsIterator=function(a){this.iterators[a].remove=null};c.prototype.ensureSortGraphicsIterator=function(a,b,c){var d=this.graphics[a];a=this.iterators[a];a.sort||(a.sort=
d.visible.iterableSort(b,function(){return c.done}));return a.sort};c.prototype.resetSortGraphicsIterator=function(a){this.iterators[a].sort=null};c.prototype.collectGraphics3DGraphics=function(a,b,c){var d=a.graphics3DGraphic;if(!d.destroyed){var f=1===b,n=f?d._labelGraphics:d._graphics,f=f?0:this.iconMarginFactor;b=a.info[b];if(d.isVisible(0,3)){for(var d=t.empty(Y),k,h,C=0;C<n.length;C++){var p=n[C];if(this.graphics3DGraphicsLayerSupportsDeconfliction(p)){var q=p.stageObject,v=q.getGeometryRecord(0),
l=v.material,m=this.camera,g=v.geometry.data.getVertexAttr();if(c&&(K.radius=R.earthRadius,w.vec3.sub(B.direction,q.getCenter(),this.camera.eye),w.vec3.copy(B.origin,this.camera.eye),S.intersectRay(K,B,L))){var r=1-Math.abs(Math.tan(w.vec3.angle(q.getCenter(),B.direction)))/this.view.width,r=Math.pow(r,4),u=w.vec3.sqrDist(this.camera.eye,L),z=w.vec3.sqrDist(this.camera.eye,q.getCenter());if(r*z>u){b.culled=!0;return}}if(!h){h=q.getCenter();v=v.origin.vec3;A.transformToWorld(h,v,I);A.transformToView(I,
v,m.viewMatrix,y);l.applyVerticalOffsetTransformation(y,g[H.VertexAttrConstants.NORMAL].data,q.objectTransformation,m,D);if(a.slicePlaneEnabled&&this.slicePlaneViewSpace&&x.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,y)){b.culled=!0;return}q=g[H.VertexAttrConstants.AUXPOS1].data;g="screen"!==l.getParameters().centerOffsetUnits;A.transformToProjection(y,m.projectionMatrix,g?q:X,J);h=A.transformToNDC(J,W);g||(h[0]+=q[0]/m.fullWidth*2,h[1]+=q[1]/m.fullHeight*2);if(-1>h[0]||-1>h[1]||
-1>h[2]||1<=h[0]||1<=h[1])break;k=y[2];!Q.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&b.visible&&(k*=.7)}p=p.getScreenSize(da);p[0]*=m.pixelRatio;p[1]*=m.pixelRatio;T.applyPrecomputedScaleFactorVec2(p,D.factor,p);l=t.offset(l.calculateRelativeScreenBounds(p,D.factorAlignment.scale,Z),G.lerp(0,m.fullWidth,.5+.5*h[0]),G.lerp(0,m.fullHeight,.5+.5*h[1]));0!==f&&(m=f*Math.min(t.width(l),t.height(l)),l[0]-=m,l[1]-=m,l[2]+=m,l[3]+=m);t.expand(d,l)}}null==k?b.culled=!0:(b.xMin=d[0],b.yMin=d[1],b.xMax=d[2],b.yMax=
d[3],b.posView=k,b.culled=!1)}else b.culled=!0}};c.prototype.doesIntersectExistingPoly=function(a,b){var c=a.graphics3DGraphic.graphic.uid;a=a.info[b];for(var e=Math.floor(a.xMin/this.accBinsSizeX);e<=Math.floor(a.xMax/this.accBinsSizeX);e++)if(!(0>e||e>=this.accBinsNumX))for(var f=Math.floor(a.yMin/this.accBinsSizeY);f<=Math.floor(a.yMax/this.accBinsSizeY);f++)if(!(0>f||f>=this.accBinsNumY))for(var n=this.accBins[e][f],k=0;k<n.length;k++){var h=n.data[k],g=h.info[b];if(g&&g.visible&&h.graphics3DGraphic.graphic.uid!==
c&&(this.accNumTests++,!(g.xMin>a.xMax||g.xMax<a.xMin||g.yMin>a.yMax||g.yMax<a.yMin)))return!0}return!1};c.prototype.initBins=function(a,b){if(null==this.accBins){this.accBins=[];for(var c=0;c<this.accBinsNumX;c++){this.accBins.push([]);for(var e=this.accBins[this.accBins.length-1],f=0;f<this.accBinsNumY;f++)e.push(new g)}}for(c=0;c<this.accBinsNumX;c++)for(f=0;f<this.accBinsNumY;f++)this.accBins[c][f].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=b/this.accBinsNumY;this.accNumTests=
0};c.prototype.addToBins=function(a,b){b=a.info[b];for(var c=Math.floor(b.xMin/this.accBinsSizeX);c<=Math.floor(b.xMax/this.accBinsSizeX);c++)if(!(0>c||c>=this.accBinsNumX))for(var e=Math.floor(b.yMin/this.accBinsSizeY);e<=Math.floor(b.yMax/this.accBinsSizeY);e++)0>e||e>=this.accBinsNumY||this.accBins[c][e].push(a)};c.prototype.isFeatureReductionEnabled=function(a){a=a.layer;return!(!a||!a.featureReduction||"selection"!==a.featureReduction.type)};c.prototype.isLabelDeconflictionEnabled=function(a){return a.labelsEnabled};
c.prototype.clearVisibilityFlags=function(a){(a=a.graphics3DCore.graphics3DGraphics)&&a.forEach(function(a){return a.clearVisibilityFlag(3)})};c.prototype.setGraphicVisibility=function(a,b,c){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(3,c,b),1===b&&this.view.labeler.setLabelGraphicVisibility(a,c))};c.prototype.clearGraphicVisibility=function(a,b){a=a.graphics3DGraphic;a.destroyed||a.clearVisibilityFlag(3,b)};return c}();E.Deconflictor=z;var D={factor:{scale:0,factor:0,minPixelSize:0,
paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},da=P.vec2f64.create()});