// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Camera ../../../Viewpoint ../../../core/Accessor ../../../core/Error ../../../core/Handles ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/scheduling ../../../core/screenUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/Extent ../../../geometry/Point ../../../geometry/support/webMercatorUtils ../camera/constraintUtils ../camera/intersectionUtils ./ConstraintsManager ./Frustum ./controllers/PointToPointAnimationController ./controllers/SurfaceCollisionCorrectionController ../support/cameraUtils ../support/PropertiesPool ../support/viewpointUtils ../webgl-engine/lib/Camera ../../animation/easing".split(" "),
function(m,v,F,G,h,q,r,H,n,I,J,K,z,L,M,p,g,A,N,B,O,P,w,C,Q,R,x,D,e,S,y,T,U){Object.defineProperty(v,"__esModule",{value:!0});var k=J.getLogger("esri.views.3d.state.ViewStateManager");m=function(m){function c(a){a=m.call(this)||this;a.propertiesPool=new S.default({frustum:R.default},a);a.handles=new I;a.cameraSetByUser=!1;a.internalSetOrder=[];a.immediateGoToPromise=null;a.animatedGoToPromise=null;a.ready=!1;a.updateDevicePixelRatio=null;return a}G(c,m);Object.defineProperty(c.prototype,"camera",{get:function(){return this.ready?
e.internalToExternal(this.view,this.view.state.camera):this._get("camera")},set:function(a){this.updatePropertyBeforeReady("camera",a)||this.setStateCamera(e.externalToInternal(this.view,a),{applyConstraints:!1})||k.error("#camera\x3d","Invalid camera",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"center",{get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(a){this.updatePropertyBeforeReady("center",a)||(a?
this.isCompatible(a)?this.setStateCamera(this.centerToCamera(a),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.forceUpdate():k.error("#center\x3d","Invalid center",a):k.error("#center\x3d","Center has an incompatible spatial reference (center: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a):k.error("#center\x3d","Center may not be null or undefined"))},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"extent",
{get:function(){return this.ready?e.toExtent(this.view,null,null,null,E):this._get("extent")},set:function(a){this.updatePropertyBeforeReady("extent",a)||(a?this.isCompatible(a)?this.setStateCamera(this.extentToCamera(a),{applyConstraints:!0})||k.error("#extent\x3d","Invalid extent",a):k.error("#extent\x3d","Extent has an incompatible spatial reference (extent: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a):k.error("#extent\x3d","Extent may not be null or undefined"))},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"frustum",{get:function(){var a=this.propertiesPool.get("frustum");a.renderCoordsHelper=this.view.renderCoordsHelper;a.update(this.view.state.camera);return a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasInitialView",{get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"scale",{get:function(){if(!this.ready)return this._get("scale");
var a=this.view.pointsOfInterest.centerOnContent;return e.distanceToScale(this.view,a.distance,a.location.latitude)},set:function(a){this.updatePropertyBeforeReady("scale",a)||this.setStateCamera(this.scaleToCamera(a),{applyConstraints:!0})||k.error("#scale\x3d","Invalid scale",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"padding",{get:function(){if(!this.ready)return this._get("padding");var a=this.view.state.camera,b=a.padding,d=a.pixelRatio,a=this._get("padding"),c=b[0]/
d,f=b[1]/d,e=b[2]/d,b=b[3]/d;return null!=a&&a.top===c&&a.right===f&&a.bottom===e&&a.left===b?a:{top:c,right:f,bottom:e,left:b}},set:function(a){this.updatePropertyBeforeReady("padding",a)||(this.paddingToArray(a,this.view.state.camera.pixelRatio,t),this.view.state.updateCamera(function(a){return a.padding=t}))},enumerable:!0,configurable:!0});c.prototype.paddingToArray=function(a,b,d){a?A.vec4.set(d,a.top||0,a.right||0,a.bottom||0,a.left||0):A.vec4.set(d,0,0,0,0);for(a=0;4>a;a++)d[a]=Math.round(d[a]*
b)};Object.defineProperty(c.prototype,"screenCenter",{get:function(){var a=this.padding;return M.createScreenPoint((this.view.width-(a.left+a.right))/2+a.left,(this.view.height-(a.top+a.bottom))/2+a.top)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"viewpoint",{get:function(){return this.ready?y.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(a){if(!this.updatePropertyBeforeReady("viewpoint",a))if(a)if(this.isCompatible(a))this.setStateCamera(this.viewpointToCamera(a),
{applyConstraints:!a.camera})||k.error("#viewpoint\x3d","Invalid viewpoint",a);else{var b=a.camera?a.camera.position:a.targetGeometry,b=b&&b.spatialReference;k.error("#viewpoint\x3d","Viewpoint has an incompatible spatial reference (viewpoint: "+(b?b.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a)}else k.error("#viewpoint\x3d","Viewpoint may not be null or undefined")},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"zoom",{get:function(){return this.ready?e.scaleToZoom(this.view,
this.scale):this._get("zoom")},set:function(a){this.updatePropertyBeforeReady("zoom",a)||this.setStateCamera(this.zoomToCamera(a),{applyConstraints:!0})||k.error("#zoom\x3d","Invalid zoom",a)},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;this.handles.add([this.view.watch("state.camera",function(b){return a.cameraChangedSync(b)},!0),p.on(this.view,"state.events","before-camera-change",function(b){return a.beforeCameraChangeHandle(b.camera)})]);p.once(this.view,"state.camera",
function(b){return a.updateCameraElevation(b)});this.handles.add(L.addFrameTask({prepare:function(){return a.prepareFrame()}}));this.handles.add(this.view.watch("state.cameraController",function(){a.cameraSetByUser=!0;a.handles.remove(u);a.cancelImmediateGoTo()}));this.handles.add(p.on(this.view,"state.events","camera-projection-changed",function(){return a.notifyChange("scale")}))};c.prototype.destroy=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.propertiesPool&&(this.propertiesPool.destroy(),
this.propertiesPool=null)};c.prototype.init=function(){var a=this;this.constraintsManager=new Q.default({view:this.view});this.prepareFrame();var b=this.getInitialProperties();this.cameraSetByUser=!1;this._set("ready",!0);for(var d=0;d<b.length;d++){var c=b[d];this.set(c.name,c.value)}this.cameraSetByUser||((b=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent)&&this.isCompatible(b)?this.setInitialView(b):"local"===this.view.state.mode&&this.handles.add(p.whenOnce(this.view.basemapTerrain,
"ready",function(){a.handles.remove(u);a.setInitialView(a.view.groundExtent)}),u))};c.prototype.deinit=function(){this.ready&&(this._override("padding",this.padding),this.cancelImmediateGoTo(),this.cancelAnimatedGoTo(),this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove(u),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))};c.prototype.goTo=function(a,b){b=F({animate:!0},b);return b.animate?
this.goToAnimated(a,b):this.goToImmediate(a,b)};c.prototype.debugSetCameraOnContent=function(){this.setStateCamera(C.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})};c.prototype.step=function(a){var b=this.view.state,d=b&&this.view.state.cameraController;d&&(b.updateCamera(function(b){d.stepController(a,b)}),d.steppingFinished&&d.finishController())};c.prototype.cancelImmediateGoTo=function(){var a=this.immediateGoToPromise;a&&(this.immediateGoToPromise=null,a.cancel())};c.prototype.cancelAnimatedGoTo=
function(){var a=this.animatedGoToPromise;a&&(this.animatedGoToPromise=null,a.cancel())};c.prototype.getInitialProperties=function(){for(var a=this,b=new Set,d=[],c=0,f=V;c<f.length;c++){var e=f[c],g=e.propertyName,e=e.overrides,k=b.has(g),h=this._isOverridden(g);!k&&h&&d.push({name:g,value:this._get(g)});this._clearOverride(g);(k||h)&&e.forEach(function(a){return b.add(a)})}return d.sort(function(b,d){b=a.internalSetOrder.indexOf(b.name);d=a.internalSetOrder.indexOf(d.name);return b<d?-1:b>d?1:0})};
c.prototype.setInitialView=function(a){if(a&&!this.cameraSetByUser)if(a instanceof q)this.setStateCamera(e.externalToInternal(this.view,a),{applyConstraints:!1});else if(a instanceof r)if(a.targetGeometry instanceof B){var b=e.fromExtent(this.view,a.targetGeometry,0,.5,e.OrientationMode.LOCKED);this.setStateCamera(e.externalToInternal(this.view,b),{applyConstraints:!0})}else b={applyConstraints:!a.camera},a=this.viewpointToCamera(a),this.setStateCamera(a,b);else b=e.fromExtent(this.view,a,0,.5,e.OrientationMode.LOCKED),
this.setStateCamera(e.externalToInternal(this.view,b),{applyConstraints:!0})};c.prototype.updatePropertyBeforeReady=function(a,b){if(!this.ready){this._override(a,b);var d=this.internalSetOrder.indexOf(a);-1!==d&&(this.internalSetOrder=this.internalSetOrder.splice(d,1));b&&(this.internalSetOrder.push(a),-1!==W.indexOf(a)&&this._override("hasInitialView",!0));return!0}return!1};c.prototype.isCompatible=function(a){return a?a instanceof r?a.camera?this.isCompatible(a.camera):this.isCompatible(a.targetGeometry):
a instanceof q?this.isCompatible(a.position):a.spatialReference&&P.canProject(a.spatialReference,this.view.spatialReference):!1};c.prototype.getPreservingHeadingTilt=function(a){void 0===a&&(a=X);this.cameraSetByUser?(a.heading=this.camera.heading,a.tilt=this.camera.tilt):(a.heading=0,a.tilt=.5);return a};c.prototype.centerPointAtDistanceToCamera=function(a,b,d){void 0===d&&(d=l);var c=this.getPreservingHeadingTilt();return(a=e.getObserverForPointAtDistance(this.view,c.heading,c.tilt,a,b,e.OrientationMode.ADJUST))?
(d.copyFrom(this.view.state.camera),d.eye=a.eye,d.center=a.center,d.up=a.up,d):null};c.prototype.centerToCamera=function(a){var b=this.view.pointsOfInterest.centerOnContent;b.forceUpdate();return this.centerPointAtDistanceToCamera(a,b.distance)};c.prototype.extentToCamera=function(a){var b=this.getPreservingHeadingTilt();a=e.fromExtent(this.view,a,b.heading,b.tilt,e.OrientationMode.ADJUST,E);return e.externalToInternal(this.view,a)};c.prototype.scaleToCamera=function(a){if(null==a)return null;var b=
this.view.pointsOfInterest.centerOnContent;b.forceUpdate();var d=b.renderLocation;a=e.scaleToDistance(this.view,a,b.location.latitude);return this.centerPointAtDistanceToCamera(d,a)};c.prototype.zoomToCamera=function(a){return this.scaleToCamera(e.zoomToScale(this.view,a))};c.prototype.viewpointToCamera=function(a){return(a=y.toCamera(this.view,a))?e.externalToInternal(this.view,a):null};c.prototype.setStateCamera=function(a,b){var d=this;if(!a||!this.view.state.stopActiveCameraController())return!1;
this.cameraSetByUser=!0;this.cancelImmediateGoTo();this.view.state.updateCamera(function(c){c.copyFrom(a);b.applyConstraints&&w.applyAll(d.view,c)});b.applyConstraints||(this.view.state.cameraController=new D.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:a}));return!0};c.prototype.prepareFrame=function(){var a=this.view,b=a.container,d=a.canvas;if(b&&d){K.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();var a=this.view.pixelRatio,c=Math.round(b.clientWidth*a),
b=Math.round(b.clientHeight*a);0!==c&&0!==b&&(d.width=c,d.height=b,this.view.state&&(d=this.view.state.camera,d.fullWidth!==c||d.fullHeight!==b||d.pixelRatio!==a))&&(l.copyFrom(d),l.pixelRatio!==a&&(this.paddingToArray(this.padding,a,t),l.padding=t),l.fullWidth=c,l.fullHeight=b,l.pixelRatio=a,this.view.state.camera=l)}};c.prototype.beforeCameraChangeHandle=function(a){this.updateCameraElevation(a)};c.prototype.cameraChangedSync=function(a){a&&this.view._stage&&this.view._stage.setCamera(a)};c.prototype.updateCameraElevation=
function(a){var b=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,d=this.view.renderCoordsHelper.getAltitude(a.eye),b=b?C.surfaceElevationBelowEye(this.view,a):0;a.relativeElevation=d-b};c.prototype.createGoToCamera=function(a){var b=this;return p.whenOnce(this,"ready",null,!0).then(function(){return y.create(b.view,a)}).then(function(d){var c=!!(a instanceof r&&a.camera||a instanceof q),f=d.camera;if(!b.isCompatible(f))throw d=(d=f.position)&&d.spatialReference,new n("goto:incompatible-spatialreference",
"Resulting camera has an incompatible spatial reference (camera: "+(d?d.wkid:"none")+", view: "+b.view.spatialReference.wkid+")",{camera:f});f=e.externalToInternal(b.view,f);if(!f)throw new n("goto:invalid-camera","Resulting camera is invalid");return{viewpoint:d,camera:f,isFullySpecified:c}})};c.prototype.cancellableGoTo=function(a){var b=this,d;return z.create(function(b,c){d={resolve:b,reject:c};a.asyncResult=d},function(){b.view.state.cameraController===a&&a.active&&a.asyncResult===d&&a.stopController()})};
c.prototype.goToImmediate=function(a,b){var d=this;this.cancelAnimatedGoTo();this.cancelImmediateGoTo();var c=this.createGoToCamera(a).then(function(a){d.immediateGoToPromise===c&&(d.immediateGoToPromise=null);d.setStateCamera(a.camera,{applyConstraints:!a.isFullySpecified})}).catch(function(a){d.immediateGoToPromise===c&&(d.immediateGoToPromise=null);a instanceof n&&a.message&&k.error("#goTo()","Failed to create camera from target, "+a.message[0].toLowerCase()+a.message.slice(1));throw a;});return this.immediateGoToPromise=
c};c.prototype.goToAnimatedBeforeReady=function(a,b){var c=this;this.cancelAnimatedGoTo();var e=p.whenOnce(this.view,"ready").then(function(){if(e===c.animatedGoToPromise)return c.animatedGoToPromise=null,c.goToAnimated(a,b);throw new n("view:goto-cancelled","Cancelled");});return this.animatedGoToPromise=e};c.prototype.goToAnimated=function(a,b){var c=this;this.cancelAnimatedGoTo();if(!this.ready)return this.goToAnimatedBeforeReady(a,b);var e=this.view.state.cameraController,f;e instanceof x.PointToPointAnimationController&&
(e.updateStateFromViewAnimation(),e.active&&(f=e));null==f&&(f=new x.PointToPointAnimationController(this.view.state,this.view.sceneIntersectionHelper));var g=f.viewAnimation;a=this.createGoToCamera(a);var h=a.then(function(a){return a.viewpoint});g.update(h);if(f!==e&&!this.view.state.switchCameraController(f))return g.stop(),k.error("#goTo()","Cannot start an animation while interacting"),z.reject(new n("view:goto-cannot-interrupt","Cannot start an animation while interacting"));var l=g.target,
m=function(){return c.view.state.cameraController===f&&f.viewAnimation.target===l&&f.active};a.then(function(a){var d=a.viewpoint,e=a.camera;a=a.isFullySpecified;if(m()){f.viewAnimation.update(d);l=f.viewAnimation.target;var h;a?(h=new D.SurfaceCollisionCorrectionController({view:c.view,desiredCamera:e}),w.applySurfaceCollision(c.view,e,1)):w.applyAll(c.view,e);f.begin(e,c.internalAnimateOptions(b));return g.when().then(function(){var a=c.view.state.cameraController;h&&(a&&a.active?a instanceof x.PointToPointAnimationController&&
a.viewAnimation.target===l&&(c.view.state.cameraController=h):f.viewAnimation.target===l&&(c.view.state.cameraController=h))})}}).catch(function(a){a instanceof n&&a.message&&k.error("#goTo()","Failed to create camera from target, "+a.message[0].toLowerCase()+a.message.slice(1));if(m())throw c.view.state.cameraController.stopController(),a;});return this.cancellableGoTo(f)};c.prototype.internalAnimateOptions=function(a){var b={};a&&(null!=a.speedFactor&&(b.speedFactor=a.speedFactor),null!=a.duration&&
(b.duration=a.duration/1E3),null!=a.maxDuration&&(b.maxDuration=a.maxDuration/1E3),null!=a.easing&&(b.easing="string"===typeof a.easing?U.named[a.easing]:a.easing));return b};h([g.property({type:q,dependsOn:["view.state.camera","ready"]})],c.prototype,"camera",null);h([g.property({type:O,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],c.prototype,"center",null);h([g.property({type:B,dependsOn:["view.state.camera","ready"]})],c.prototype,"extent",null);h([g.property({readOnly:!0,
dependsOn:["view.state.camera","ready"]})],c.prototype,"frustum",null);h([g.property({readOnly:!0,dependsOn:["view.map.initialViewProperties?.viewpoint"]})],c.prototype,"hasInitialView",null);h([g.property({readOnly:!0,type:Boolean})],c.prototype,"ready",void 0);h([g.property({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],c.prototype,"scale",null);h([g.property({dependsOn:["view.state.camera","ready"]})],c.prototype,"padding",null);h([g.property({readOnly:!0,
dependsOn:["view.width","view.height","padding"]})],c.prototype,"screenCenter",null);h([g.property({constructOnly:!0})],c.prototype,"view",void 0);h([g.property({type:r,dependsOn:["camera","ready"]})],c.prototype,"viewpoint",null);h([g.property({type:Number,dependsOn:["scale"]})],c.prototype,"zoom",null);h([g.property({constructOnly:!0})],c.prototype,"updateDevicePixelRatio",void 0);return c=h([g.subclass("esri.views.3d.state.ViewStateManager")],c)}(g.declared(H));v.ViewStateManager=m;var W="camera viewpoint extent scale center zoom".split(" "),
V=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"center",overrides:[]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],X={heading:0,tilt:0},E=new q,l=new T,t=N.vec4f64.create(),u="pending-initial-view";v.default=m});