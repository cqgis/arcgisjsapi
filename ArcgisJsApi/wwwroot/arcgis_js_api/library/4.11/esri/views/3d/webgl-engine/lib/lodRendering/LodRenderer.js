// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4f64 ../../../../../geometry/support/aaBoundingBox ../../../support/debugFlags ../../../support/buffer/glUtil ../Camera ../DefaultVertexAttributeLocations ../intersectorUtils ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData ./utils ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),
function(C,p,Z,P,u,v,Q,w,D,E,R,A,S,g,T,U,F,B,V,W,X,y,Y){function G(c,a,b,n){B.encodeDoubleVec3(c.modelOrigin,a,b.modelOriginHi,b.modelOriginLo,n);b.model.copyFrom(n,c.model,a);b.modelNormal.copyFrom(n,c.modelNormal,a);c.color&&b.color&&b.color.copyFrom(n,c.color,a);c.featureAttribute&&b.featureAttribute&&b.featureAttribute.copyFrom(n,c.featureAttribute,a)}Object.defineProperty(p,"__esModule",{value:!0});var x=y.assert,H=function(c){var a=c.baseBoundingSphere.radius;c=c.levels.map(function(a){return a.minScreenSpaceRadius});
return new U.LevelSelector(a,c)};p.setLevelSelectorFactory=function(c){H=c};var I=function(){function c(a,b){this.glMaterials={};var c=a.rctx,e=b.geometry;b=b.material;var d=e.data.toRenderData();this.materialRep=a.materialRep;b.setParameterValues({instancedDoublePrecision:!0});a=b.createBufferWriter();var h=a.vertexBufferLayout,f=a.elementCount(d),t=a.allocate(f);a.write({},d,void 0,t,0);this.geometry=e;this.material=b;this.glMaterials=B.acquireGLMaterials(b,this.materialRep);this.vertexBufferLayout=
h;this.vbo=X.createVertex(c,35044,t.buffer);this.vao=new Y(c,A.Default3D,{geometry:E.glLayout(h)},{geometry:this.vbo});this.vertexCount=f}c.prototype.destroy=function(){B.releaseGLMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};Object.defineProperty(c.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0});
c.prototype.intersect=function(a,b,c,e,d,h){var n=this.geometry.id,t=d.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,c,e,function(c,e,f,g,l,z){if(0<=c&&(null==b||b(a.rayBeginPoint,a.rayEndPoint,c))){l={type:"external",metadata:{layerUid:h.layerUid,graphicUid:h.graphicUid(d)}};if(null==a.results.min.drapedLayerOrder||g>=a.results.min.drapedLayerOrder)if(null==a.results.min.dist||c<a.results.min.dist)a.results.min.set(l,t,c,e,a.transform.transform,g,null,n,f),a.results.min.intersector=
"LodRenderer";if(null==a.results.max.drapedLayerOrder||g>=a.results.max.drapedLayerOrder)if(null==a.results.max.dist||c>a.results.max.dist)a.results.max.set(l,t,c,e,a.transform.transform,g,null,n,f),a.results.min.intersector="LodRenderer";a.enable.storeAll&&(z=new S.IntersectorResult(a.results.min.ray),z.set(l,t,c,e,a.transform.transform,g,null,n,f),z.intersector="LodRenderer",a.results.all.push(z))}},null)};return c}();p.LodComponentData=I;var J=function(){function c(a,b){var c=this;this.components=
[];this.minScreenSpaceRadius=b.minScreenSpaceRadius;b.components.forEach(function(b){c.components.push(new I(a,b))})}c.prototype.destroy=function(){this.components.forEach(function(a){a.destroy()})};c.prototype.intersect=function(a,b,c,e,d,h){this.components.forEach(function(n){n.intersect(a,b,c,e,d,h)})};Object.defineProperty(c.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var a=w.empty();this.components.forEach(function(b){w.expand(a,b.boundingInfo.bbMin);w.expand(a,b.boundingInfo.bbMax)});
this._boundingBox=a}return this._boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var a=this.boundingBox,b=v.vec3f64.create();w.center(a,b);this._boundingSphere={center:b,radius:.5*w.diameter(a)}}return this._boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"triangleCount",{get:function(){return this.components.reduce(function(a,b){return a+b.triangleCount},0)},enumerable:!0,configurable:!0});
return c}();p.LodLevelData=J;C=function(){function c(a,b,c,e){var d=this;this._levels=[];this._renderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlaneEnabled=!1;this._enableLevelSelection=!0;this._lastCamera=new R;this._updateCyclesWithStaticCamera=-1;this.didRender=this._needFullCycle=!1;this._symbol=a;this._optionalFields=b;this._metadata=c;this._instanceBufferLayout=V.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:b});this._glInstanceBufferLayout=
E.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new g.InstanceData(this._optionalFields,e);this._instanceData.on("instance-added",function(a){d.requestUpdateCycle()});this._instanceData.on("instance-removed",function(a){d.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",function(a){d.requestUpdateCycle()});this._instanceData.on("instance-visibility-changed",function(a){d.requestUpdateCycle(!0)});this._instanceData.on("instance-highlight-changed",function(a){d.requestUpdateCycle(!0)});
this._enableLevelSelection=1<this._symbol.levels.length;p.lodRenderers.push(this)}c.prototype.destroy=function(){p.lodRenderers.splice(p.lodRenderers.indexOf(this),1)};Object.defineProperty(c.prototype,"levels",{get:function(){return this._levels},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-1].boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-
1].boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-1].components[0].material},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"intersectionHandlerId",{get:function(){return this._metadata.layerUid},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"memoryUsage",{get:function(){var a={cpu:0,gpu:0};this._renderInstanceData.forEach(function(b){b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});this._highlightRenderInstanceData.forEach(function(b){b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});return a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderStats",
{get:function(){var a=this,b=this._instanceData.size,c=[];this._levels.forEach(function(b,d){d=a._renderInstanceData[d].size+a._highlightRenderInstanceData[d].size;b=b.triangleCount;c.push({renderedInstances:d,renderedTriangles:d*b,trianglesPerInstance:b})});return{totalInstances:b,renderedInstances:c.reduce(function(a,b){return a+b.renderedInstances},0),renderedTriangles:c.reduce(function(a,b){return a+b.renderedTriangles},0),levels:c}},enumerable:!0,configurable:!0});c.prototype.initializeRenderContext=
function(a){var b=this,c=a.rctx;this._symbol.levels.forEach(function(e){b._levels.push(new J(a,e));b._renderInstanceData.push(new F.RenderInstanceData(c,b._instanceBufferLayout));b._highlightRenderInstanceData.push(new F.RenderInstanceData(c,b._instanceBufferLayout))});this._levelSelector=H(this)};c.prototype.uninitializeRenderContext=function(a){this.invalidateOctree();this._levels.forEach(function(a){a.destroy()});this._renderInstanceData.forEach(function(a){a.destroy()});this._highlightRenderInstanceData.forEach(function(a){a.destroy()})};
Object.defineProperty(c.prototype,"slots",{get:function(){return[5,7]},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"needsHighlight",{get:function(){return 0<this._highlightRenderInstanceData.reduce(function(a,b){return a+b.size},0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"needsRender",{get:function(){return this.needsUpdates()},enumerable:!0,configurable:!0});c.prototype.resetNeedsRender=function(){this.didRender&&(this.didRender=!1)};c.prototype.prepareRender=
function(a){this.runUpdates(a)};c.prototype.render=function(a){var b=a.rctx,c=5===a.slot?4:7===a.slot?6:null;if(c){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(a.pass))return!1;var e=a.camera,e={view:e.viewMatrix,proj:e.projectionMatrix,origin:[0,0,0],viewInvTransp:e.viewInverseTransposeMatrix,lightingData:a.lightingData,viewport:e.viewport,fovY:e.fovY,nearFar:[e.near,e.far],shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&
a.ssaoHelper.enabled,pixelRatio:e.pixelRatio,slicePlane:a.sliceHelper&&a.sliceHelper.plane,cameraAboveGround:e.aboveGround,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null};b.bindVAO();for(b=0;b<this._levels.length;++b)this.renderLevel(a,c,e,a.isHighlightPass?this._highlightRenderInstanceData[b]:this._renderInstanceData[b],b);return!0}};c.prototype.intersect=function(a,b,c,e,d){var h=this;if(this.baseMaterial.isVisible()){d=v.vec3f64.create();u.vec3.subtract(d,
e,c);var f=function(d){h._instanceData.getCombinedModelTransform(d,K);a.transform.set(K);u.vec3.transformMat4(L,c,a.transform.inverse);u.vec3.transformMat4(M,e,a.transform.inverse);var f=h._instanceData.getState(d),n=h._instanceData.getLodLevel(d);x(f&g.StateFlags.ACTIVE,"invalid instance state");x(0<=n&&n<h._levels.length,"invaid lod level");h._levels[n].intersect(a,b,L,M,d,h._metadata)};this.baseMaterial.getParameters().verticalOffset?this.octree.forEach(f):this.octree.forEachAlongRay(c,d,f)}};
c.prototype.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};c.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()};c.prototype.requestUpdateCycle=function(a){void 0===a&&(a=!1);this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0)};c.prototype.needsUpdates=function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera};c.prototype.runUpdates=function(a){if(!D.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var b=
a.equals(this._lastCamera);this._lastCamera.copyFrom(a);b||this.requestUpdateCycle()}b=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,b)}};Object.defineProperty(c.prototype,"octree",{get:function(){this._octree||(this._octree=this.buildOctree());return this._octree},enumerable:!0,configurable:!0});c.prototype.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};c.prototype.buildOctree=function(){for(var a=new T.InstanceOctree(this._instanceData,
this.baseBoundingSphere),b=this._instanceData,b=b.view?b.view.state:null,c=0;c<this._instanceData.capacity;++c)b.get(c)&g.StateFlags.ACTIVE&&a.addInstance(c);return a};c.prototype.queryDepthRangeOctree=function(a){var b=a.eye,c=a.viewForward,e=this.octree.findClosest(c,"front-to-back",a.frustum),d=this.octree.findClosest(c,"back-to-front",a.frustum);return null!=e&&null!=d?(this._instanceData.view.boundingSphere.getVec(e,m),u.vec3.subtract(m,m,b),e=u.vec3.dot(m,c)-m[3],this._instanceData.view.boundingSphere.getVec(d,
m),u.vec3.subtract(m,m,b),b=u.vec3.dot(m,c)+m[3],{near:Math.max(a.near,e),far:Math.min(a.far,b)}):{near:Infinity,far:-Infinity}};c.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._renderInstanceData.forEach(function(a){a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(function(a){a.startUpdateCylce()})};c.prototype.updateInstances=function(a,b){var c=this._enableLevelSelection,e=this._levelSelector;e.updateCamera(a);this._renderInstanceData.forEach(function(a){a.beginUpdate()});
this._highlightRenderInstanceData.forEach(function(a){a.beginUpdate()});a=this._instanceData;var d=this._instanceData.view,h=a.capacity,f=this._instanceIndex;b=Math.min(a.size,b);for(var t=0;t<b;++t){0===f&&this.startUpdateCycle();var r=d.state.get(f),q=0;if(r&g.StateFlags.ALLOCATED){var k=d.lodLevel.get(f);r&g.StateFlags.ACTIVE&&this._renderInstanceData[k].freeTail();r&g.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[k].freeTail();if(r&g.StateFlags.REMOVE)a.freeInstance(f);else if(r&
g.StateFlags.VISIBLE){k=0;c&&(d.modelOrigin.getVec(f,N),k=e.selectLevel(N,a.getCombinedMedianScaleFactor(f)));q=r&~(g.StateFlags.ACTIVE|g.StateFlags.HIGHLIGHT_ACTIVE|g.StateFlags.TRANSFORM_CHANGED);if(0<=k){var m=this._renderInstanceData[k],l=m.allocateHead();G(d,f,m.view,l);q|=g.StateFlags.ACTIVE;r&g.StateFlags.HIGHLIGHT&&(m=this._highlightRenderInstanceData[k],l=m.allocateHead(),G(d,f,m.view,l),q|=g.StateFlags.HIGHLIGHT_ACTIVE)}d.state.set(f,q);d.lodLevel.set(f,k)}else q=r&~(g.StateFlags.ACTIVE|
g.StateFlags.HIGHLIGHT_ACTIVE|g.StateFlags.TRANSFORM_CHANGED),d.state.set(f,q);this._octree&&(k=!!(r&g.StateFlags.ACTIVE),q=!!(q&g.StateFlags.ACTIVE),!k&&q?this._octree.addInstance(f):k&&!q?this._octree.removeInstance(f):k&&q&&r&g.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(f),this._octree.addInstance(f)));f=(f+1)%h}else f=(f+1)%h,b++}this._instanceIndex=f;this._renderInstanceData.forEach(function(a){a.endUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.endUpdate()})};
c.prototype.renderLevel=function(a,b,c,e,d){var h=this;this._levels[d].components.forEach(function(f){h.renderComponent(a,b,c,e,f,d)})};c.prototype.renderComponent=function(a,b,c,e,d,h){var f=d.glMaterials[a.pass];if(f&&f.beginSlot(b)&&f.isVisible()&&f.isVisibleInPass(a.pass)&&0!==e.size){var g=a.rctx,m=g.capabilities.instancing,n=f.getDrawMode();c.origin=[0,0,0];f.bind(g,c);g.bindVAO(d.vao);b=f.getProgram();y.assertCompatibleVertexAttributeLocations(d.vao,b);a.isHighlightPass&&(g.bindTexture(a.offscreenRenderingHelper?
a.offscreenRenderingHelper.depthTexture:null,5),b.setUniform1i("depthTex",5),b.setUniform4f("highlightViewportPixelSz",0,0,1/c.viewport[2],1/c.viewport[3]));f.bindView(g,c);D.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===a.pass&&(b.setUniform4fv("externalColor",O[Math.min(h,O.length-1)]),b.setUniform1i("colorMixMode",W.colorMixModes.replace));a=e.capacity;h=e.headIndex;b=e.tailIndex;var k=e.firstIndex,p=this._glInstanceBufferLayout,l=function(a,b){y.bindVertexBufferLayout(g,A.Default3D,e.buffer,p,
a);m.drawArraysInstanced(n,0,d.vertexCount,b-a);y.unbindVertexBufferLayout(g,A.Default3D,e.buffer,p)};d.material.getParameters().transparent&&null!=k?h>b?(x(k>=b&&k<=h,"invalid firstIndex"),l(k,h),l(b,k)):h<b&&(k<=h?(x(0<=k&&k<=h,"invalid firstIndex"),l(k,h),l(b,a),l(0,k)):(x(k>=b&&k<=a,"invalid firstIndex"),l(k,a),l(0,h),l(b,k))):h>b?l(b,h):h<b&&(l(0,h),l(b,a));g.bindVAO(null);f.release(g,c)}};return c}();p.LodRenderer=C;p.lodRenderers=[];var N=v.vec3f64.create(),m=Q.vec4f64.create(),K=P.mat4f64.create(),
L=v.vec3f64.create(),M=v.vec3f64.create(),O=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});