// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/scheduling ../../../core/screenUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/Point ../../../geometry/support/aaBoundingRect ../../../symbols/SimpleMarkerSymbol ../state/utils/viewUtils ../support/debugFlags ../support/debugFlags ../support/earthUtils ../support/mathUtils ../support/projectionUtils ../support/stack ../webgl-engine/lib/Intersector ../webgl-engine/lib/localOrigin".split(" "),
function(ea,fa,J,w,K,L,M,N,O,P,Q,R,B,u,S,r,y,p,C,T,f,U,V,W,X,Y,t,x,D,Z,E){var aa=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],ba=O.getLogger("esri.views.3d.OverlayManager"),z,F=function(A){function c(){var a=null!==A&&A.apply(this,arguments)||this;a._handles=new M;a._overlaySR=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._connectedLayers={};a._scale=0;a._placementDirty=!1;a._drawTexturesDirty=!1;a._isSpherical=
!1;a._latestOriginId=0;a._maxResolution=N("esri-mobile")?2048:4096;a.opacity=0;return a}J(c,A);Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;this._stage=this.view._stage;this._renderer=this._stage.getDrapedRenderer();this._renderer.onHasHighlightsChanged=function(){return a.onHasHighlightsChanged()};this._renderer.onContentChanged=function(){return a.setDrawTexturesDirty()};
this._renderer.forceUpdate=function(b){a.updateOverlays(b);a._preRender()};this.groundIntersector=new Z(this.view.viewingMode);this.groundIntersector.enable.backfacesTerrain=!0;this.groundIntersector.enable.invisibleTerrain=!0;this.groundIntersector.enable.hud=!1;this._handles.add(this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],function(){return a.setOverlayPlacementDirty()}));this._handles.add(this.view.on("resize",function(){return a.setOverlayPlacementDirty()}));
this._handles.add(R.addFrameTask({preRender:function(){return a._preRender()}}))};c.prototype.destroy=function(){for(var a in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[a].layerView);this._disposeOverlays();this._handles&&(this._handles.destroy(),this._handles=null)};c.prototype.onHasHighlightsChanged=function(){this.setOverlayPlacementDirty();this.notifyChange("hasHighlights")};c.prototype.hasOverlays=function(){return!!this._overlays};c.prototype.setSpatialReference=function(a,
b){(this._overlaySR=a)?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._longitudeCyclical=(this._isSpherical=b)?a.isWebMercator?new t.Cyclical(-2.0037508342788905E7,2.0037508342788905E7):new t.Cyclical(-180,180):null):(this._disposeOverlays(),this._longitudeCyclical=null)};c.prototype.registerLayerView=function(a){var b=this,e=a.layer.uid;if(this._connectedLayers[e])ba.warn("[OverlayManager#registerLayerView]: Layer "+e+" is already connected");
else{var d=a.on("draped-data-change",function(){return b.setOverlayPlacementDirty()});this._connectedLayers[e]={eventHandles:[d],layerView:a};a.setDrapingExtent&&this._overlays&&[this._overlays.inner,this._overlays.outer].forEach(function(e,d){a.setDrapingExtent(d,e.extent,b._overlaySR,e.resolution,e.renderLocalOrigin,e.pixelRatio)});this.setOverlayPlacementDirty();this._setLayerViewOverlayUpdating(a,!0)}};c.prototype.unregisterLayerView=function(a){for(var b in this._connectedLayers){var e=this._connectedLayers[b];
if(e.layerView===a){if(e.eventHandles)for(var d=0;d<e.eventHandles.length;d++)e.eventHandles[d].remove();delete this._connectedLayers[b];this.setOverlayPlacementDirty();a.destroyed||(a.overlayUpdating=!1)}}};c.prototype.setOverlayPlacementDirty=function(){this._placementDirty||(this._setOverlayUpdating(!0),this._placementDirty=!0)};c.prototype._setLayerViewOverlayUpdating=function(a,b){if(!b||!a.suspended&&a.hasDraped)a.overlayUpdating=b};c.prototype._setOverlayUpdating=function(a){for(var b in this._connectedLayers)this._setLayerViewOverlayUpdating(this._connectedLayers[b].layerView,
a);b=this.view.graphicsView;Q.isSome(b)&&(b.overlayUpdating=a)};c.prototype.updateOverlays=function(a){void 0===a&&(a=this.view.state.camera);if(this._overlaySR){var b;b=P.nextHighestPowerOfTwo(Math.max(a.fullWidth,a.fullHeight)+256);var e=Math.min(b,this._maxResolution);this._computeOverlayExtents(a,b,v);this._overlays||this._initOverlays();this._updateOverlay(this._overlays.inner,0,v.inner,e,1);this._updateOverlay(this._overlays.outer,1,v.outer,e,f.width(v.inner)/f.width(v.outer));this.opacity=
1;this.terrainSurface._updateTileOverlayParams();this._placementDirty=!1;this.setDrawTexturesDirty()}};c.prototype._updateOverlay=function(a,b,e,d,q){var c;a:{c=a.extent;for(var m=W.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS?0:F.EXTENTS_DIFFER_THRESHOLD*Math.max(e[2]-e[0],e[3]-e[1],c[2]-c[0],c[3]-c[1]),g=0;4>g;g++)if(Math.abs(c[g]-e[g])>m){c=!0;break a}c=!1}if(c||d!==a.resolution||a.pixelRatio!==q){f.set(a.extent,e);a.resolution=d;a.pixelRatio=q;q=f.center(a.extent);a.renderLocalOrigin=E.fromValues(q[0],
q[1],0,"OV_"+this._latestOriginId++);for(var h in this._connectedLayers)q=this._connectedLayers[h].layerView,q.setDrapingExtent&&q.setDrapingExtent(b,e,this._overlaySR,d,a.renderLocalOrigin,a.pixelRatio)}};c.prototype.overlaysNeedUpdate=function(){return this._placementDirty&&!!this._overlaySR};c.prototype.updateOpacity=function(a){var b=1;if(this._overlays){var e=this._scale;3.5*a<e&&(b=Math.sqrt(t.clamp((a-e/10)/(e/3.5-e/10),0,1)))}return b};c.prototype.setOverlayParamsOfTile=function(a,b,e){var d=
this._overlays.inner,c=this._overlays.outer;a=f.intersection(a.extent,a.surface.extent,G);this._rectInsideRect(a,d.extent)?(this._setTileOverlayData(a,d,b.overlays[0]),this._invalidateTileOverlayData(b.overlays[1])):this._rectanglesOverlap(a,d.extent)?(this._setTileOverlayData(a,d,b.overlays[0]),this._setTileOverlayData(a,c,b.overlays[1])):(this._rectanglesOverlap(a,c.extent)?this._setTileOverlayData(a,c,b.overlays[0]):this._invalidateTileOverlayData(b.overlays[0]),this._invalidateTileOverlayData(b.overlays[1]));
b.overlayOpacity=void 0!==e?e:1};c.prototype.overlayPixelSizeInMapUnits=function(a){var b;this._overlays&&(b=this._pointIsInExtent(a,this._overlays.inner.extent)?this._overlays.inner:this._overlays.outer);return b?(b.extent[2]-b.extent[0])/b.resolution:0};c.prototype._setTileOverlayData=function(a,b,e){var d=b.extent;e.texScale[0]=(a[2]-a[0])/(d[2]-d[0]);e.texScale[1]=(a[3]-a[1])/(d[3]-d[1]);var c=a[0];if(this._longitudeCyclical){var c=this._longitudeCyclical.minimalMonotonic(d[0],c),f=this._longitudeCyclical.minimalMonotonic(d[0],
a[2]);c>f&&(c=f-(a[2]-a[0]))}e.texOffset[0]=(c-d[0])/(d[2]-d[0]);e.texOffset[1]=(a[1]-d[1])/(d[3]-d[1]);e.renderTargetId=b.valid?b.renderTargetId:null;e.highlightRenderTargetId=b.highlightValid?b.highlightRenderTargetId:null};c.prototype._invalidateTileOverlayData=function(a){a.renderTargetId=null;a.highlightRenderTargetId=null};Object.defineProperty(c.prototype,"test",{get:function(){return{overlays:this._overlays}},enumerable:!0,configurable:!0});c.prototype._createEmptyOverlay=function(a){var b=
this._renderer.createRenderTarget("overlay"+a);a=this._renderer.createHighlightRenderTarget("overlayHighlight"+a);return{extent:f.create(),resolution:0,renderTargetId:b,valid:!1,highlightRenderTargetId:a,highlightValid:!1,renderLocalOrigin:E.fromValues(0,0,0,"O"),pixelRatio:1}};c.prototype._initOverlays=function(){this._overlays={inner:this._createEmptyOverlay(0),outer:this._createEmptyOverlay(1)}};c.prototype._disposeOverlays=function(){this._overlays&&(this._renderer.disposeRenderTarget(this._overlays.inner.renderTargetId),
this._renderer.disposeRenderTarget(this._overlays.inner.highlightRenderTargetId),this._renderer.disposeRenderTarget(this._overlays.outer.renderTargetId),this._renderer.disposeRenderTarget(this._overlays.outer.highlightRenderTargetId),this._overlays=null)};c.prototype._preRender=function(){this._drawTexturesDirty&&(this._drawOverlays(),this._drawTexturesDirty=!1)};c.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty||(this._drawTexturesDirty=!0,this._setOverlayUpdating(!0)):
this.setOverlayPlacementDirty()};c.prototype._intersectGroundFromView=function(a,b,e,d){var c=B.createRenderScreenPointArray3(b*a.fullWidth,e*a.fullHeight,1),c=a.unprojectPoint(c,D.sv3d.get());b=B.createRenderScreenPointArray3(b*a.fullWidth,e*a.fullHeight,0);b=a.unprojectPoint(b,D.sv3d.get());this.groundIntersector.intersect([],b,c,null,a,null,!1);this.view.basemapTerrain.intersect(this.groundIntersector,null,b,c);return this.groundIntersector.results.min.getIntersectionPoint(d)};c.prototype._findHorizonBasedPointOfInterest=
function(a,b,e){var d=.5;if("global"===this.view.viewingMode){d=y.vec3f64.clone(a.eye);r.vec3.normalize(d,d);r.vec3.negate(d,d);b=r.vec3.length(b);b=Math.asin(b/r.vec3.length(a.eye));var c=Math.acos(r.vec3.dot(a.viewForward,d)),d=t.clamp((b-(c-.5*a.fovY))/a.fovY,0,1);b=t.clamp((-b-(c-.5*a.fovY))/a.fovY,0,1);d=1===d&&0===b?.5:b+.55*(d-b)}else d=C.vec4f64.fromValues(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),1,0),d=p.vec4.transformMat4(d,d,a.projectionMatrix)[1],d=t.clamp(.5+.5*d,0,1),d=1===
d||0===d?.5:0<a.eye[2]?.55*d:1-.55*(1-d);return this._intersectGroundFromView(a,.5,d,e)?!0:!1};c.prototype._computeOverlayExtents=function(a,b,e){var d=this.terrainSurface.extent,c=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,l=y.vec3f64.create();this._findHorizonBasedPointOfInterest(a,c,l)||r.vec3.copy(l,c);this._scale=this.view.renderCoordsHelper.getAltitude(a.eye);var m=r.vec3.distance(a.eye,l),c=V.viewAngle(this.view.renderCoordsHelper,c,a.eye),c=Math.PI/2-Math.abs(c-Math.PI/
2);if(X.OVERLAY_SHOW_CENTER){var g=new U({color:[255,0,0],outline:{color:[255,255,255],width:2}}),h=new T;x.vectorToPoint(l,this._renderSR,h,this._overlaySR);g=new K({geometry:h,symbol:g});void 0!==z&&this.view.graphics.remove(z);this.view.graphics.add(g);z=g}this._overlaySREqualsRenderSR||x.vectorToVector(l,this._renderSR,l,this._overlaySR);b=b*a.perRenderPixelRatio*m/2;h=!1;m=Infinity;this._isSpherical&&(this._overlaySR.isWebMercator?(b/=Math.cos(x.webMercator.y2lat(l[1])),m=this.terrainSurface.extent[3],
m*=.999):(h=!0,b/=Y.metersPerDegree,m=90),b>=m&&(b=m,l[1]=0,this._overlaySR.isWebMercator&&(l[0]=0)));g=1;h&&(g=1/Math.max(.2,Math.cos(Math.abs(t.deg2rad(l[1])))),180<b*g&&(g=180/b));var k=b*g,h=e.inner;h[0]=l[0]-k;h[1]=l[1]-b;h[2]=l[0]+k;h[3]=l[1]+b;this._isSpherical&&this._shiftExtentToFitBounds(h,Infinity,m);e=e.outer;f.set(e,h);6*k>d[2]-d[0]?f.set(e,d):c<=.25*Math.PI?(e[0]-=k,e[1]-=b,e[2]+=k,e[3]+=b):(x.vectorToVector(a.eye,this._renderSR,H,this._overlaySR),S.vec2.subtract(n,l,H),a=-Math.atan2(n[1],
n[0])+.125*Math.PI,0>a&&(a+=2*Math.PI),p.vec4.scale(n,aa[Math.floor(a/(.25*Math.PI))],2*b),n[0]*=g,n[2]*=g,p.vec4.add(e,e,n));this._isSpherical&&(e[0]=this._longitudeCyclical.clamp(e[0]),e[2]=this._longitudeCyclical.clamp(e[2]),e[1]=Math.max(e[1],-m),e[3]=Math.min(e[3],m));!this._isSpherical&&d&&(a=f.intersection(h,d,G),d=f.intersection(e,d,ca),f.contains(a,d)&&(e[2]=e[0],e[3]=e[1]))};c.prototype._drawOverlays=function(){var a=!this._overlays.inner.valid||!this._overlays.outer.valid;this._drawOverlay(this._overlays.inner,
0);this._drawOverlay(this._overlays.outer,1);a&&this.terrainSurface._updateTileOverlayParams();this._setOverlayUpdating(!1);this._stage.setNeedsRender()};c.prototype._drawOverlay=function(a,b){var e=this._renderer,d=a.extent,c=a.resolution,l=a.pixelRatio,m=this._longitudeCyclical?d[2]>this._longitudeCyclical.max:!1,g=this._longitudeCyclical?d[0]<this._longitudeCyclical.min:!1;if(m||g){k.views=da;var g=void 0,g=m?this._longitudeCyclical.max-d[0]:this._longitudeCyclical.min-d[0],g=Math.round(g/(d[2]-
d[0])*c),h=k.views[0];p.vec4.set(h.viewport,0,0,g,c);p.vec4.set(h.extent,d[0],d[1],this._longitudeCyclical.max,d[3]);m||(h.extent[0]+=this._longitudeCyclical.range);h=k.views[1];p.vec4.set(h.viewport,g,0,c-g,c);p.vec4.set(h.extent,this._longitudeCyclical.min,d[1],d[2],d[3]);m&&(h.extent[2]-=this._longitudeCyclical.range)}else k.views=I,f.set(k.views[0].extent,d),p.vec4.set(k.views[0].viewport,0,0,c,c);k.width=c;k.height=c;k.pixelRatio=l*this.view.state.camera.pixelRatio;k.index=b;a.valid=e.draw(a.renderTargetId,
k);a.highlightValid=e.drawHighlights(a.highlightRenderTargetId,k)};c.prototype._rectanglesOverlap=function(a,b){return this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],b[2],a[0])||this._longitudeCyclical.contains(b[0],b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):f.intersects(a,b)};c.prototype._rectInsideRect=function(a,b){return this._longitudeCyclical?this._longitudeCyclical.contains(b[0],b[2],a[0])&&this._longitudeCyclical.contains(b[0],b[2],
a[2])&&a[1]>b[1]&&a[3]<b[3]:f.contains(b,a)};c.prototype._pointIsInExtent=function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];var c=a.x;a=a.y;return c>b[0]&&c<b[2]&&a>b[1]&&a<b[3]};c.prototype._shiftExtentToFitBounds=function(a,b,c){var d=0,e=0;a[0]<-b?d=a[0]+b:a[2]>b&&(d=b-a[2]);a[1]<-c?e=a[1]+c:a[3]>c&&(e=c-a[3]);f.offset(a,d,e)};c.EXTENTS_DIFFER_THRESHOLD=1E-5;w([u.property()],c.prototype,"view",void 0);w([u.property()],c.prototype,
"terrainSurface",void 0);w([u.property({type:Boolean})],c.prototype,"hasHighlights",null);return c=w([u.subclass("esri.views.3d.terrain.OverlayManager")],c)}(u.declared(L)),k={width:0,height:0,pixelRatio:0,views:null,index:0},I=[{viewport:f.create(),extent:f.create()}],da=[I[0],{viewport:f.create(),extent:f.create()}],n=C.vec4f64.create(),H=y.vec3f64.create(),v={inner:f.create(),outer:f.create()},G=f.create(),ca=f.create();return F});