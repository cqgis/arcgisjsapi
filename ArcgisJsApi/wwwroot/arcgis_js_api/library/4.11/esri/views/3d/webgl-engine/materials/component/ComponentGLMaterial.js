// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/decorateHelper ../../lib/DefaultTextureUnits ../../lib/GLMaterial ../../lib/ManagingDisposable ./Parameters ../internal/MaterialUtil ../internal/MaterialUtil ../internal/TextureBinding ../../shaders/DefaultPrograms ../../../../webgl/renderState".split(" "),function(g,k,l,v,r,f,w,n,p,m,x,q,h){function y(d){if(d.hasTransparency)return h.separateBlendingParams(770,1,771,771)}function t(d){var a;a=d.parameters.slicePlaneEnabled?
!1:"none"!==d.parameters.cullFace;if(a)return{face:"front"===d.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(k,"__esModule",{value:!0});g=function(d){function a(e,b,c,a){c=d.call(this,b,c)||this;c._passName=e;c.material=b;c._baseColorTexture=new x.TextureBinding(a,b.parameters.baseColorTexture,{textureUniform:"tex",textureSizeUniform:"texSize",textureUnit:r.DefaultTextureUnits.DIFFUSE});c.createPrograms();c.selectPipeline();c.selectSlot();return c}l(a,d);a.prototype.createPrograms=
function(){var e=this;this.programs=p.BindParametersMap.create(this.material.parameters,function(b){return e._createProgram(b)})};a.prototype._createProgram=function(e){var b=this.material.parameters,c=this.material.geometryParameters,a=b.baseColorTexture?c.textureCoordinateRegions?"AtlasTextured":"Textured":"none",d="screen-space"===b.normals||"none"===c.normals?"screenDerivative":"compressed"===c.normals?"compressed":"default";if("color"===this._passName)return this.programRep.getProgram(q.colorPass,
{textureMode:a,vertexColors:c.colors,doubleSided:b.doubleSidedShading,groundNormalShading:"ground"===b.normals,normals:d,componentColor:c.componentData&&!n.isUniformComponentData(b.componentData),textureAlphaMode:"maskBlend",slice:b.slicePlaneEnabled,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO});if("depth"===this._passName||"depthShadowMap"===this._passName)return this.programRep.getProgram(q.depthPass,{textureMode:a,vertexColors:c.colors,groundNormalShading:"ground"===b.normals,normals:d,
componentColor:c.componentData&&!n.isUniformComponentData(b.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this._passName,slice:b.slicePlaneEnabled});if("normal"===this._passName)return this.programRep.getProgram(q.normalPass,{textureMode:a,vertexColors:c.colors,groundNormalShading:"ground"===b.normals,normals:d,componentColor:c.componentData&&!n.isUniformComponentData(b.componentData),textureAlphaMode:"maskBlend",slice:b.slicePlaneEnabled});if("highlight"===this._passName)return this.programRep.getProgram(q.highlightPass,
{textureMode:a,vertexColors:c.colors,groundNormalShading:"ground"===b.normals,normals:d,componentColor:c.componentData&&!n.isUniformComponentData(b.componentData),textureAlphaMode:"maskBlend",slice:b.slicePlaneEnabled})};a.prototype.selectPipeline=function(){var e=this.material.parameters;this.pipelineState="color"===this._passName?h.makePipelineState({blending:y(this.material),culling:t(this.material),polygonOffset:e.polygonOffsetEnabled&&u,stencilTest:e.writeStencil&&{function:{func:519,ref:1,mask:255},
operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:e.writeStencil&&{mask:255},depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams}):h.makePipelineState({culling:t(this.material),polygonOffset:e.polygonOffsetEnabled&&u,depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.material.hasTransparency?6:this.material.parameters.writeStencil?2:4};a.prototype.beginSlot=
function(e){return e===this.slot};a.prototype.getProgram=function(){return this.program||this.getPrograms()[0]};a.prototype.getPrograms=function(){return p.BindParametersMap.programs(this.programs)};a.prototype.updateParameters=function(){this._baseColorTexture.update(this.material.parameters.baseColorTexture);this.createPrograms();this.selectPipeline();this.selectSlot()};a.prototype.bind=function(e,b){var c=this.material.parameters,a=this.program=p.BindParametersMap.lookup(this.programs,b);e.bindProgram(a);
e.setPipelineState(this.pipelineState);a.setUniform3fv("ambient",c.baseColor);a.setUniform3fv("diffuse",c.baseColor);a.setUniform3fv("specular",z);a.setUniform1f("opacity",c.baseColorOpacity);a.setUniform1f("layerOpacity",c.layerOpacity);n.isUniformComponentData(c.componentData)?(a.setUniform4fv("externalColor",c.componentData.externalColor),a.setUniform1i("colorMixMode",m.colorMixModes[c.componentData.externalColorMixMode])):(a.setUniform4fv("externalColor",A),a.setUniform1i("colorMixMode",m.colorMixModes.multiply),
this.material.geometryParameters.componentData&&(c.componentData.updateTexture(),c.componentData.bind(a,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:r.DefaultTextureUnits.COMPONENT_COLOR})));this._baseColorTexture.bind(e,a);a.setUniform1f("textureAlphaCutoff",.1);"depth"!==this._passName&&"depthShadowMap"!==this._passName||a.setUniform2fv("nearFar",b.nearFar);"highlight"===this._passName&&m.bindHighlightRendering(e,b,a)};a.prototype.bindView=function(a,b){a=this.material.parameters;
var c=this.program=p.BindParametersMap.lookup(this.programs,b),e=b.origin;m.bindView(e,b.view,c);m.bindCamPos(e,b.viewInvTransp,c);a.slicePlaneEnabled&&m.bindSlicePlane(e,b.slicePlane,c);"color"===this._passName&&b.shadowMappingEnabled&&b.shadowMap.bindView(c,e);"normal"===this._passName&&c.setUniformMatrix4fv("viewNormal",b.viewInvTransp)};a.prototype.bindInstance=function(a,b){a=this.program;a.setUniformMatrix4fv("model",b.transformation);a.setUniformMatrix4fv("modelNormal",b.transformationNormal)};
v([w.manageDisposal()],a.prototype,"_baseColorTexture",void 0);return a}(f);f=function(d){function a(a,b,c){b=d.call(this,"color",a,b,c)||this;b.material=a;return b}l(a,d);return a}(g);k.GLMaterialColor=f;f=function(d){function a(a,b,c){b=d.call(this,"depth",a,b,c)||this;b.material=a;return b}l(a,d);return a}(g);k.GLMaterialDepth=f;f=function(d){function a(a,b,c){b=d.call(this,"depthShadowMap",a,b,c)||this;b.material=a;return b}l(a,d);return a}(g);k.GLMaterialDepthShadowMap=f;f=function(d){function a(a,
b,c){b=d.call(this,"normal",a,b,c)||this;b.material=a;return b}l(a,d);return a}(g);k.GLMaterialNormal=f;g=function(d){function a(a,b,c){b=d.call(this,"highlight",a,b,c)||this;b.material=a;return b}l(a,d);return a}(g);k.GLMaterialHighlight=g;var A=[1,1,1,1],z=[0,0,0],u={factor:2,units:2}});