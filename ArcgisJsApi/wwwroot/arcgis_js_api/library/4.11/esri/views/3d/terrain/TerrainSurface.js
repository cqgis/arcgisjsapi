// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Handles ../../../core/Logger ../../../core/ObjectPool ../../../core/PooledArray ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingRect ../../../layers/support/LercWorker ../support/Evented ../support/geometryUtils ../support/index ../support/mathUtils ../support/projectionUtils ../support/PromiseLightweight ./ElevationData ./ElevationTileAgent ./MapTileAgent ./OverlayManager ./PlanarTile ./SphericalTile ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./TileGeometryFactory ./TilemapOnlyTile ./tileUtils ./tileUtils ./UpsampleInfo ../../vectorTiles/VectorTileDisplayObject ../../webgl/Texture ../../webgl/Util".split(" "),
function(w,ua,O,m,P,Q,y,R,S,T,z,U,D,k,V,W,X,E,Y,p,F,Z,G,aa,ba,A,H,ca,da,ea,fa,ga,ha,I,ia,d,ja,n,ka,la,v,J,ma,na,oa,K){function L(d,c){return d[0]===c[0]&&d[1]===c[1]&&d[2]===c[2]}function M(d){return d&&("cancel"===d||"cancel"===d.dojoType||"AbortError"===d.name)}function N(d,c){var a=!1;c=c||d;var b=0;for(d=d.children;b<d.length;b++){var f=d[b];if(f){for(var e in f.layerInfo)for(var g in f.layerInfo[e]){var h=f.layerInfo[e][g].upsampleFromTile;if(h&&h.tile===c)return!0}a=a||N(f,c)}}return a}var u=
T.getLogger("esri.views.3d.terrain.TerrainSurface");w=function(w){function c(a,b){b=w.call(this)||this;b.defaultTileBackground=d.DEFAULT_TILE_BACKGROUND;b.hideSkirtsDistanceFromExtentMargin=pa;b.hideSkirtsMinimumCameraTilt=qa;b.hideSkirtsMaximumCameraTilt=ra;b._clippingExtent=null;b._dataExtent=null;b._elevationBounds=[0,0];b._rootExtent=p.create();b._iteratorPool=new z(J.IteratorPreorder);b._postorderIterator=new J.IteratorPostorder;b.visible=!1;b.suspended=!1;b._pendingUpdates=!1;b._lvPendingUpdates=
!1;b._updateNextFrame=0;b._vectorTileLayerRequests=0;b._memoryUsed=0;b._overlayOpacity=1;b._eyePosRenderSR=E.vec3f64.create();b._eyePosSurfaceSR=E.vec3f64.create();b._splitLimits=[0,0,0,0,0,0];b._frustum=G.frustum.create();b._viewProjectionMatrix=W.mat4f64.create();b.tilemapStats={tilemapRequestsSent:0,tilemapRequestsPending:0,tilemapRequestErrors:0,fullTilemaps:0,emptyTilemaps:0,tilesRequested:0,tileRequestsSent:0,tileRequestErrors:0,tilesNotPresent:0};b._layerViews=[[],[]];b._layerIndexByLayerViewId=
[{},{}];b._basemapLayerViewHandles={};b._handles=new S;b._lowPrioUpdates=new U;b._topLevelTilemapOnlyTiles=Array(d.TILEMAP_SIZE_EXP+1);b._upsampleInfoPool=new z(ma);b._getElevationData={spatialReference:null,rootTiles:null};b.loaded=!1;b.maxTextureScaleRaster=1.2;b.maxTextureScaleVector=1.8;b.rootTiles=null;b.backgroundImage=d.DEFAULT_TILE_BACKGROUND;b.backgroundColor=null;b._lercWorker=F.acquireInstance(a.resourceController.scheduler);for(a=0;a<b._topLevelTilemapOnlyTiles.length;a++)b._topLevelTilemapOnlyTiles[a]=
new la([a-d.TILEMAP_SIZE_EXP,0,0],b._upsampleInfoPool);return b}O(c,w);c.prototype.normalizeCtorArgs=function(a,b){this._view=a;this._stage=a._stage;this._set("manifold",b);return{}};c.prototype.initialize=function(){var a=this;this._tilePool="planar"===this.manifold?new z(ga):new z(ha);this._memCache=this._view.resourceController.memoryController.getMemCache("esri.views.3d.terrain",function(b){return a._renderer.releaseTileGeometry(b.renderData)});this._renderer=new ja(this.manifold,this._memCache);
this._renderer.loaded=this._setLoaded.bind(this);this._renderer.install(this._view._stage);D.init(this,"_background",function(){a._renderer.updateTileBackground(a._background)});this._handles.add(this._view.watch("pointsOfInterest",function(b){a._renderer.pointsOfInterest=b}));this._set("overlayManager",new fa({terrainSurface:this,view:this._view}));this._handles.add(this.watch("overlayManager.hasHighlights",this._handleHasHighlights.bind(this)),"overlayManager");var b={layers:this._view.map.allLayers,
layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?new I.SurfaceExtentHelperGlobal(b):new I.SurfaceExtentHelperLocal(b);this._handles.add(D.init(this.extentHelper,"stencilEnabledExtents",function(b){a._renderer.setStencilEnabledLayerExtents(b)}),"extentHelper");b=this._view.defaultsFromMap?new R({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(a){return a.layers}}):
this._view.map.allLayers;b=new ia({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._streamDataSupplier=this._view.resourceController.getStreamDataSupplier(aa.ClientType.TERRAIN);
this._handles.add(this._view.resourceController.scheduler.registerTask(1,function(b){return a._frame(b)},function(){return a.ready}));this._viewChangeUpdate=this._viewChangeUpdate.bind(this);this._view.resourceController.memoryController.events.on("quality-changed",function(){return a._viewChangeUpdate()});this._handles.add([this._view.on("resize",this._viewChangeUpdate),this._view.watch("state.camera",this._viewChangeUpdate,!0),this._view.watch("qualitySettings.tiledSurface.lodBias",this._viewChangeUpdate),
this._view.watch("clippingArea",this._clippingChanged.bind(this))],"view");this._handles.add(this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),"allLayerViews");this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),removed:[],moved:[],target:this._view.allLayerViews});this._updateClippingExtent();this.notifyChange("extent")};c.prototype.destroy=function(){this._handles.destroy();F.releaseInstance(this._lercWorker);this._lercWorker=null;this._removeAllTiles();
this._memCache.destroy();this._memCache=null;this.tilingSchemeLogic.destroy();this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;for(var a in this._basemapLayerViewHandles)this._unregisterTiledLayerView(a);this._streamDataSupplier=null;this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._tilePool.destroy();this._tilePool=null;da.Pool.prune(0);ea.Pool.prune(0);this._renderer.destroy(this._stage);this._renderer=null;this._iteratorPool.destroy();
this._streamDataSupplier=this._stage=this._view=this._iteratorPool=null;this._upsampleInfoPool.destroy();this._upsampleInfoPool=null};Object.defineProperty(c.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"frustum",{get:function(){return this._frustum},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"cullBackFaces",{set:function(a){this._renderer.cullBackFaces=a;this._set("cullBackFaces",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseOpacity",{set:function(a){this._renderer.opaque=1<=a;this._set("baseOpacity",a);this._updateTileTextures(!0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"maxTextureScale",{get:function(){for(var a=
!1,b=!1,f=0,e=this._layerViews[d.LayerClass.MAP];f<e.length;f++){var c=e[f].layer;c.visible&&0!==c.opacity&&("vector-tile"===c.type?a=!0:b=!0)}return a&&!b?this.maxTextureScaleVector:this.maxTextureScaleRaster},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"skirtScale",{set:function(a){this._renderer.skirtScale=a;this._set("skirtScale",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){var a=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{set:function(a){this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"wireframe",{set:function(a){this._renderer.setWireframe(a);this._set("wireframe",
a)},enumerable:!0,configurable:!0});c.prototype.setVisibility=function(a){a!==this.visible&&(this.visible=a,this._renderer.setVisibility(a),this.setUpdatesDisabled(!a),a&&this._viewChangeUpdate())};c.prototype.isVisible=function(){return this.visible&&this.ready};c.prototype.isOpaque=function(){return this._renderer.isOpaque()};c.prototype.setUpdatesDisabled=function(a){(this.suspended=a)||this._viewChangeUpdate()};c.prototype.intersect=function(a,b,f,c){this._renderer.intersect(a,b,f,c,null)};c.prototype.getElevation=
function(a){var b=this._getElevationData.rootTiles;if(!b||!b.length||0===b[0].layerInfo[d.LayerClass.ELEVATION].length)return null;var f=x;if(Array.isArray(a))f=a;else if("point"===a.type&&!A.pointToVector(a,f,this._getElevationData.spatialReference))return u.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(var c=0;c<b.length;c++)if(a=b[c],v.isPosWithinTile(a,f)){for(;a&&!a.renderData;)b=0,f[0]>.5*(a.extent[0]+a.extent[2])&&(b+=1),f[1]<
.5*(a.extent[1]+a.extent[3])&&(b+=2),a=a.children[b];if(b=(b=a.renderData)&&b.geometryState?b.geometryState.samplerData:null)return ka.elevationSampler(f[0],f[1],b);break}return null};c.prototype.getElevationBounds=function(){return this._elevationBounds};c.prototype.getScale=function(a){if(this.tilingScheme){if(!A.pointToVector(a,x,this.spatialReference))return u.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;if(this.rootTiles)for(var b=
0;b<this.rootTiles.length;b++)if(a=this.rootTiles[b],v.isPosWithinTile(a,x)){for(;a.children[0];)b=0,x[0]>a.children[0].extent[2]&&(b+=1),x[1]<a.children[0].extent[1]&&(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.lij[0])}}return 1E100};c.prototype.queryVisibleScaleRange=function(a,b,f,c){b=b?this.tilingScheme.levelAtScale(b):0;f=f?this.tilingScheme.levelAtScale(f):Infinity;var e=this._getLodBias();this._renderer.queryVisibleLevelRange(a,b+e,f+e,c)};c.prototype._setLoaded=function(){this.loaded||
this._set("loaded",!0)};c.prototype._updateTilingSchemeAndExtent=function(){var a=this.tilingSchemeLogic.extent,b=a&&!p.equals(a,this._dataExtent);b&&(this._dataExtent?p.set(this._dataExtent,a):this._dataExtent=p.create(a));var a=this.tilingSchemeLogic.tilingScheme,f=a!==this.tilingScheme;f&&(n.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize[0]),
this.overlayManager.setSpatialReference(a.spatialReference,"spherical"===this.manifold)));(b||f)&&this._updateRootTiles()};c.prototype._acquireTile=function(a,b,f,c){var e=this._tilePool.acquire();B[0]=a;B[1]=b;B[2]=f;e.init(B,c,this);return e};c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,f=this.tilingScheme;if(b&&f){var c=sa,g=f.rootTilesInExtent(b,c,Infinity),h=function(b){b=a._acquireTile(0,b[1],b[2],null);b.shouldSplit(a._splitLimits,a._eyePosRenderSR)===
d.TileUpdate.SPLIT&&b.setPendingUpdate(d.TileUpdate.SPLIT);a._loadTile(b);return b};if(this.rootTiles){if(g.length>d.MAX_ROOT_TILES){u.warn(d.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}var b=this.rootTiles.map(function(a){return a.lij}),l=y.difference(b,g,L);if(0<l.removed.length||0<l.added.length){var r=this.rootTiles.filter(function(b){return-1<y.findIndex(l.removed,L.bind(null,b.lij))?(a._purgeTile(b),!1):!0});l.added.forEach(function(a){return r.push(h(a))});this._setRootTiles(r)}}else g.length>
d.MAX_ROOT_TILES&&(u.warn(d.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),g=f.rootTilesInExtent(b,c,d.MAX_ROOT_TILES)),this._setRootTiles(g.map(function(a){return h(a)}));y.equals(c,this._rootExtent)||(this._rootExtent=p.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.setVisibility(!0);this._viewChangeUpdate();this.overlayManager.setOverlayPlacementDirty();this.notifyChange("ready")}};c.prototype._setRootTiles=function(a){this._set("rootTiles",a);this._getElevationData.rootTiles=a;this._renderer.setRootTiles(this.rootTiles)};
c.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateSkirts(),this._updateOverlayOpacity(this._eyePosSurfaceSR[2]),this._updateTiles())};c.prototype._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.resetPendingUpdate(d.TileUpdate.GEOMETRY)&&this._updateTileGeometry(a)};c.prototype._updateTiles=function(a){void 0===a&&(a=this.rootTiles);if(a){var b=this._iteratorPool.acquire();
b.reset(a);var f=this._splitLimits,c;v.hasVisibleSiblings(a)?(a=this._elevationBounds[0],c=this._elevationBounds[1]):(a=Infinity,c=-Infinity);for(;!b.done;){var g=b.next();this._updateClippingStatus(g);g.updateVisibility();if(g.visible){g.updateScreenDepth(this._viewProjectionMatrix);g.renderData&&(a=Math.min(g.elevationBounds[0],a),c=Math.max(g.elevationBounds[1],c));var h=g.shouldSplit(f,this._eyePosRenderSR);if(h===d.TileUpdate.SPLIT){g.resetPendingUpdate(d.TileUpdate.MERGE);g.isLeaf&&(g.setPendingUpdate(d.TileUpdate.SPLIT),
b.skipSubtree());this._pendingUpdates=this._pendingUpdates||g.hasPendingUpdates;continue}g.resetPendingUpdate(d.TileUpdate.SPLIT)&&g.updateAgentSuspension();h===d.TileUpdate.VSPLITMERGE&&g.updateAgents(d.LayerClass.ELEVATION)}b.skipSubtree();if(!g.renderData){g.setPendingUpdate(d.TileUpdate.MERGE);g.resetPendingUpdate(d.TileUpdate.SPLIT);h=this._iteratorPool.acquire();for(h.resetOne(g);!h.done;){var l=h.next();this._updateClippingStatus(l);l.updateVisibility();l.visible&&l.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(h)}this._pendingUpdates=
this._pendingUpdates||g.hasPendingUpdates}this._iteratorPool.release(b);isFinite(a)&&isFinite(c)&&(this._elevationBounds[0]!==a||this._elevationBounds[1]!==c)&&(this._elevationBounds[0]=a,this._elevationBounds[1]=c,this.emit("elevation-bounds-change",null))}};c.prototype._updateViewDependentParameters=function(){var a=this._view.state.camera,b=Math.tan(.5*a.fovX),c=Math.tan(.5*a.fovY),e=this.tilingScheme.pixelSize,g=Math.pow(2,-this._getLodBias())*a.pixelRatio;this._splitLimits[0]=b;this._splitLimits[1]=
e[0]/a.width*this.maxTextureScale*g;this._splitLimits[2]=c;this._splitLimits[3]=e[1]/a.height*this.maxTextureScale*g;this._splitLimits[4]=this.tilingScheme.getMaxLod();this._splitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias;G.frustum.copy(a.frustum,this._frustum);V.mat4.multiply(this._viewProjectionMatrix,a.projectionMatrix,a.viewMatrix);X.vec3.copy(this._eyePosRenderSR,a.eye);A.vectorToVector(this._eyePosRenderSR,this._view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};
c.prototype._updateSkirts=function(){n.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,this._view.state.camera.near)};c.prototype._setLayerViewsUpdating=function(){for(var a=0;a<d.LayerClass.COUNT;a++)for(var b=this._layerViews[a],c=0;c<b.length;c++)b[c].updatingChanged(this._pendingUpdates)};c.prototype._updateTileGeometry=function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);this._elevationUpdate(a);this._memoryUsed=0};c.prototype._elevationUpdate=function(a){C.spatialReference=
this.spatialReference;C.tile=a;C.extent=a.extent;this.emit("elevation-change",C);p.containsPoint(a.extent,this._eyePosSurfaceSR)&&this._updateSkirts()};c.prototype._frame=function(a){var b=this;this._frameTraversal(a);a.run(function(){v.sortTiles(b._renderer.renderOrder,b._lowPrioUpdates);return!1});this._processElevation(a)&&this._processTextures(a)&&!this._streamDataSupplier.hasPendingDownloads()&&0===this._vectorTileLayerRequests||(this._pendingUpdates=!0);!a.done&&this.isVisible()&&this.overlayManager&&
this.overlayManager.overlaysNeedUpdate()&&(this.overlayManager.updateOverlays(),this._updateOverlayOpacity(this._eyePosSurfaceSR[2]));this._lowPrioUpdates.clear();this._pendingUpdates===this._lvPendingUpdates||!this._pendingUpdates&&20!==++this._updateNextFrame||(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,this._updateNextFrame=0)};c.prototype._frameTraversal=function(a){if(!this.suspended&&this._pendingUpdates){this._lowPrioUpdates.clear();this._pendingUpdates=!1;var b=
this._renderer.resourceCounter,c=b.numTileTexturesComposited,e=this._iteratorPool.acquire();e.reset(this.rootTiles);for(var g=0,h=[];!e.done&&!a.done&&b.numTileTexturesComposited-c<ta;){var l=e.next(),g=g+l.memoryUsed;l.resetPendingUpdate(d.TileUpdate.MERGE)?(this._mergeTile(l),a.madeProgress(),e.skipSubtree()):l.resetPendingUpdate(d.TileUpdate.SPLIT)?(this._splitTile(l)&&(this._pendingUpdates=!0,h.push(l)),a.madeProgress(),e.skipSubtree()):l.hasPendingUpdates&&this._lowPrioUpdates.push(l);this._pendingUpdates=
this._pendingUpdates||l.hasPendingUpdates;e.done&&(e.reset(h),h.length=0)}e.done?this._memoryUsed=g:this._pendingUpdates=!0;this._iteratorPool.release(e)}};c.prototype._processElevation=function(a){for(var b=this,c=function(c){var f=e._lowPrioUpdates.data[c];if(!a.run(function(){if(f.resetPendingUpdate(d.TileUpdate.GEOMETRY))return b._updateTileGeometry(f),!0}))return{value:!1}},e=this,g=0;g<this._lowPrioUpdates.length;++g){var h=c(g);if("object"===typeof h)return h.value}return!0};c.prototype._processTextures=
function(a){for(var b=this,c=function(c){var f=e._lowPrioUpdates.data[c];if(!a.run(function(){return f.resetPendingUpdate(d.TileUpdate.TEXTURE)?(b._renderer.updateTileTexture(f),b._memoryUsed=0,!0):!1}))return{value:!1}},e=this,g=0;g<this._lowPrioUpdates.length;++g){var h=c(g);if("object"===typeof h)return h.value}return!0};c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=p.create(),b=null;A.extentToBoundingRect(this._view.clippingArea,a,this.spatialReference)&&
(b=a);if(y.equals(b,this._clippingExtent))return!1;this._memCache.clear();this._clippingExtent=b;this._renderer.clippingExtent=b;this.notifyChange("extent");this._updateTileOverlayParams();this.overlayManager.setOverlayPlacementDirty();return!0};c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};c.prototype._getLodBias=function(){return this._view.qualitySettings.tiledSurface.lodBias-(1-this._view.resourceController.memoryController.memoryFactor)*d.MAX_MEMORY_LOD_BIAS};
c.prototype._getLodBiasCorrectedScale=function(a){var b=this.tilingScheme.levels;a=ba.clamp(a-this._getLodBias(),0,b.length-1);var c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};c.prototype._cancelTilemapRequests=function(a){for(var b=0;b<d.LayerClass.COUNT;b++){var c=a.layerInfo[b];if(c)for(var e=0;e<c.length;e++){var g=c[e];g.tilemapRequest&&(g.tilemapRequest.cancel(),g.tilemapRequest=null)}}};c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){return a._purgeTile(b)}),
this._setRootTiles(null),this.notifyChange("ready"));for(var b=0;b<this._topLevelTilemapOnlyTiles.length;b++)this._cancelTilemapRequests(this._topLevelTilemapOnlyTiles[b]);this.setVisibility(!1)};c.prototype._purgeChildTiles=function(a){for(var b in a.children){var c=a.children[b];null!=c&&(a.children[b]=null,this._purgeTile(c))}};c.prototype._purgeTile=function(a){this._purgeChildTiles(a);a.unload(this._renderer);this._cancelTilemapRequests(a);a.dispose();this._tilePool.release(a)};c.prototype._splitTile=
function(a){var b=a.lij[0]+1,c=2*a.lij[1],e=2*a.lij[2];a.children[0]=this._createTile(b,c,e,a);a.children[1]=this._createTile(b,c,e+1,a);a.children[2]=this._createTile(b,c+1,e,a);a.children[3]=this._createTile(b,c+1,e+1,a);a.unload(this._renderer);t.spatialReference=this.spatialReference;t.extent=a.extent;t.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",t);return a.children[0].hasPendingUpdate(d.TileUpdate.SPLIT)||a.children[1].hasPendingUpdate(d.TileUpdate.SPLIT)||a.children[2].hasPendingUpdate(d.TileUpdate.SPLIT)||
a.children[3].hasPendingUpdate(d.TileUpdate.SPLIT)};c.prototype._createTile=function(a,b,c,e){n.weakAssert(!!e,"_createTile sanity check");a=this._acquireTile(a,b,c,e);a.updateClippingStatus(this._clippingExtent);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._splitLimits,this._eyePosRenderSR)===d.TileUpdate.SPLIT&&a.setPendingUpdate(d.TileUpdate.SPLIT));this._loadTile(a);return a};c.prototype._mergeTile=function(a){n.weakAssert(!a.renderData,"_mergeTile sanity check");
n.weakAssert(!a.hasPendingUpdate(d.TileUpdate.SPLIT),"_mergeTile sanity check");this._loadTile(a);this._purgeChildTiles(a);t.spatialReference=this.spatialReference;t.extent=a.extent;t.scale=this._getLodBiasCorrectedScale(a.lij[0]);this.emit("scale-change",t)};c.prototype._loadTile=function(a){a.load(this._renderer);this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(a,a.renderData,this._overlayOpacity);this._elevationUpdate(a)};c.prototype._handleHasHighlights=
function(a){this._renderer.setNeedsHighlight(a)};c.prototype._elevationDataUpdated=function(a,b){var c=a.layerInfo[d.LayerClass.ELEVATION][b],e=[a],g=a.lij[0],h=this._iteratorPool.acquire();for(h.reset(e);!h.done;){var l=h.next();l.findElevationBoundsForLayer(b,g);l.computeElevationBounds()}this._iteratorPool.release(h);a.dataArrived(b,d.LayerClass.ELEVATION,c.data);this._updateTiles(e)};c.prototype._handleLayerViewChanges=function(a){var b=this,c=!1;a.added.forEach(function(a){var f=a.layer;n.isTiledLayerView(a)?
(b._registerTiledLayer(a),f.loaded&&(c=!0)):a.supportsDraping&&b.overlayManager&&b.overlayManager.registerLayerView(a)});a.removed.forEach(function(a){n.isTiledLayerView(a)?(c=!0,b._unregisterTiledLayerView(a.uid)):a.supportsDraping&&b.overlayManager&&b.overlayManager.unregisterLayerView(a)});(c=c||0<a.moved.filter(n.isTiledLayerView).length)&&this._updateTiledLayers()};c.prototype._registerTiledLayer=function(a){var b=this,c=[];c.push(a.watch("visible",function(){return b._updateTiledLayers()}));
c.push(a.watch("fullOpacity",function(){return b._updateTileTextures()}));a.on("data-changed",function(){var c=n.isElevationLayerView(a)?d.LayerClass.ELEVATION:d.LayerClass.MAP,f=b._layerIndexByLayerViewId[c][a.uid];null!=f&&b._invalidateLayerData(f,c)});this._basemapLayerViewHandles[a.uid]=c};c.prototype._unregisterTiledLayerView=function(a){var b=this._basemapLayerViewHandles[a];if(b){for(var c=0;c<b.length;c++)b[c].remove();delete this._basemapLayerViewHandles[a]}};c.prototype._updateTiledLayers=
function(){var a=this;if(this.tilingScheme){var b=this._view.allLayerViews,c=[[],[]],e=null,g=p.empty();b.forEach(function(b){var f=b.layer;if(f&&b.visible&&n.isTiledLayerView(b)){var h=b.fullExtent;h?a.tilingScheme.compatibleWith(b.tileInfo)?(p.expand(g,h),n.isElevationLayerView(b)?c[d.LayerClass.ELEVATION].push(b):(Infinity!==b.maxDataLevel&&(null===e||b.maxDataLevel>e)&&(e=b.maxDataLevel),c[d.LayerClass.MAP].push(b))):u.warn("Terrain: tiling scheme of layer "+f.id+" is incompatible with other tiled layers, will not be drawn"):
u.warn("Terrain: Map or elevation layer does not have fullExtent: "+f.id)}},this);for(var b=function(a){var b=h._layerViews[a],f=c[a];f.reverse();var e=f.length,g=b.length!==e,l=Array(e),r=Array(b.length);h._layerIndexByLayerViewId[a]={};for(var k=0;k<e;k++){h._layerIndexByLayerViewId[a][f[k].uid]=k;var m=b.indexOf(f[k]);l[k]=m;k!==m&&(g=!0);-1<m&&(r[m]=k)}if(g){h._topLevelTilemapOnlyTiles.forEach(function(b){return b.modifyLayers(r,l,a)});b=h._postorderIterator;for(b.reset(h.rootTiles);!b.done;)b.next().modifyLayers(r,
l,a);h._layerViews[a]=f;a===d.LayerClass.ELEVATION&&h._memCache.clear();for(b.reset(h.rootTiles);!b.done;)f=b.next(),f.restartAgents(a),a===d.LayerClass.ELEVATION&&f.computeElevationBounds();h._updateTiles()}},h=this,l=0;l<d.LayerClass.COUNT;l++)b(l);this.tilingScheme.levels.length-1<e&&(this.tilingScheme.ensureMaxLod(e),this._viewChangeUpdate())}};c.prototype._hasFixedExtent=function(){return!!this._clippingExtent};c.prototype.layerViewByIndex=function(a,b){return this._layerViews[b][a]};c.prototype.numLayers=
function(a){return this._layerViews[a].length};c.prototype._updateTileTextures=function(a){void 0===a&&(a=!1);a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)a.next().updateTexture();this._iteratorPool.release(a)};c.prototype._invalidateLayerData=function(a,b){var c=this._iteratorPool.acquire();for(c.reset(this.rootTiles);!c.done;)c.next().removeLayerAgent(a,b);for(c.reset(this.rootTiles);!c.done;)c.next().invalidateLayerData(a,b);this._iteratorPool.release(c);b===d.LayerClass.ELEVATION&&
this._memCache.clear()};c.prototype.setPendingUpdates=function(){this._pendingUpdates=!0};c.prototype.requestTileData=function(a,b,c){var f=this;this.tilemapStats.tilesRequested++;var g=this.layerViewByIndex(b,c),h=g.layer;if(h.tilemapCache&&!n.isVectorTileLayerView(g)){var d=this.getTilemapTile(a),r=d.layerInfo[c][b];if(r.tilemap){if(!d.hasDataAvailable(a,b,c))return this.tilemapStats.tilesNotPresent++,this._dispatchDataEvent(a,"dataMissing",c,g,{notInTilemap:!0}),b=new H.default,b.reject(),b}else{r.tilemapRequest||
(r.tilemapRequest=this.requestTilemap(d,b,c,g,h));var k,m=new H.default(function(){return k&&k.cancel()});r.tilemapRequest.catch(function(){}).then(function(){r.tilemapRequest=null;if(!m.isCancelled()){var b=f._layerIndexByLayerViewId[c][g.uid];null!=b&&(d.hasDataAvailable(a,b,c)?(k=f._requestTileData(a,b,c,g),k.then(function(){return m.resolve()})):(f.tilemapStats.tilesNotPresent++,f._dispatchDataEvent(a,"dataMissing",c,g,{notInTilemap:!0}),m.reject()))}});return m}}return this._requestTileData(a,
b,c,g)};c.prototype._requestTileData=function(a,b,c,e){this.tilemapStats.tileRequestsSent++;return c===d.LayerClass.ELEVATION?this._requestElevationTileData(a,b,c,e):this._requestMapTileData(a,b,c,e)};c.prototype._requestElevationTileData=function(a,b,c,e){var f=this;if(n.isElevationLayerView(e)){var h=function(g){var d=f._layerIndexByLayerViewId[c][e.uid];null==d?u.warn("TerrainSurface: received data from unknown layer %d %s",c,a.lij.toString()):(d=a.layerInfo[c][d],f._memoryUsed=0,d.data=ca.create(a.lij,
a.extent,g),f._elevationDataUpdated(a,b),f._pendingUpdates=!0)},l=function(b){M(b)||(f.tilemapStats.tileRequestErrors++,f._dispatchDataEvent(a,"dataMissing",c,e,b))};if(n.useFetchTileForLayer(e.layer))return e.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],d.ELEVATION_NODATA_VALUE).then(function(a){return h(a)},l);var k=e.getTileUrl(a.lij[0],a.lij[1],a.lij[2]),k=this._streamDataSupplier.request(k,"binary");k.then(function(a){return f._lercWorker.decode(a.data,d.noDataValueOpt).then(function(a){return h({values:a.pixelData,
width:a.width,height:a.height,noDataValue:a.noDataValue,minValue:a.minValue,maxValue:a.maxValue})},l)},l);return k}n.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")};c.prototype._requestMapTileData=function(a,b,c,e){var f=this,d=function(b){return f._dispatchDataEvent(a,"dataArrived",c,e,b)};b=function(b){M(b)||(f._dispatchDataEvent(a,"dataMissing",c,e,b),f.tilemapStats.tileRequestErrors++)};if(n.isVectorTileLayerView(e)){var l=e.tileHandler,k=e.schemaHelper.getLevelRowColumn(a.lij);
++this._vectorTileLayerRequests;return l.getVectorTile(k[0],k[1],k[2],0).then(d).catch(b).then(function(){--f._vectorTileLayerRequests})}if(n.useFetchTileForLayer(e.layer)&&n.isTileLayerView(e))return e.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2]).then(d).catch(b);l=e.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);null!=e.refreshInterval&&e.refreshTimestamp&&(l+=(-1<l.indexOf("?")?"\x26":"?")+"_ts\x3d"+e.refreshTimestamp);l=this._streamDataSupplier.request(l,"image");l.then(function(a){return d(a.data)},b);
return l};c.prototype.requestTilemap=function(a,b,c,e,g){var f=this,l=a.lij[0]+d.TILEMAP_SIZE_EXP,k=a.lij[1]<<d.TILEMAP_SIZE_EXP,m=a.lij[2]<<d.TILEMAP_SIZE_EXP;this.tilemapStats.tilemapRequestsSent++;this.tilemapStats.tilemapRequestsPending++;return g.tilemapCache.fetchTilemap(l,k,m,{timeout:6E3}).then(function(d){f.tilemapStats.tilemapRequestsPending--;b=f._layerIndexByLayerViewId[c][e.uid];null!=b&&(a.layerInfo[c][b].tilemap=d)}).catch(function(a){f.tilemapStats.tilemapRequestsPending--;f.tilemapStats.tilemapRequestErrors++})};
c.prototype.getTilemapTile=function(a){var b=a.lij[0];return b>d.TILEMAP_SIZE_EXP?v.getTileNLevelsUp(a,d.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[b]};c.prototype._dispatchDataEvent=function(a,b,c,e,d){e=this._layerIndexByLayerViewId[c][e.uid];if(null!=e)a[b](e,c,d);else u.warn("TerrainSurface: received data from unknown layer")};c.prototype._updateTileOverlayParams=function(){if(this.rootTiles){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.renderData&&
this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(b,b.renderData,this._overlayOpacity)}this._iteratorPool.release(a);this._renderer.setNeedsRender()}};c.prototype._updateOverlayOpacity=function(a){if(this.overlayManager&&(a=this.overlayManager.updateOpacity(a),!isNaN(a))){if(a!==this._overlayOpacity){var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.renderData&&(c.renderData.overlayOpacity=a)}this._iteratorPool.release(b)}this._overlayOpacity=
a;this._renderer.setNeedsRender()}};c.prototype.getStats=function(){var a={numNodes:0,numLeaves:0,numVisible:0,numVisiblePerLevel:[]},b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();a.numNodes++;c.renderData&&(a.numLeaves++,c.visible&&(a.numVisible++,c=c.lij[0],a.numVisiblePerLevel[c]=null==a.numVisiblePerLevel[c]?1:a.numVisiblePerLevel[c]+1))}this._iteratorPool.release(b);return a};c.prototype.getUsedMemory=function(){if(!this.tilingScheme)return 0;if(0<this._memoryUsed)return this._memoryUsed;
var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();this._memoryUsed+=b.memoryUsed}this._iteratorPool.release(a);return this._memoryUsed};c.prototype.getMemoryUsage=function(){if(!this.tilingScheme)return{};var a=0,b=0,c=0,e=0,g=0,h=0,l=this._iteratorPool.acquire();l.reset(this.rootTiles);for(var k=this.tilingScheme.pixelSize,k=k[0]*k[1]*4;!l.done;){for(var m=l.next(),n=N(m),p=0,u=m.layerInfo[d.LayerClass.MAP];p<u.length;p++){var q=u[p],q=q.data,t=0,v=0;q instanceof
oa?t+=K.getGpuMemoryUsage(q):q instanceof HTMLImageElement?v+=k:q instanceof na&&(h+=q.getGpuMemoryUsage(),c+=q.getCpuMemoryUsage());m.renderData||n?(a+=v,e+=t):(b+=v,g+=t)}n=0;for(p=m.layerInfo[d.LayerClass.ELEVATION];n<p.length;n++)q=p[n],q=q.data,a+=q?k:0;m.renderData&&(q=m.renderData.textureDescriptor,e+=q?K.getGpuMemoryUsage(q):0,m=m.renderData.estimatedGeometryMemoryUsage,h+=m,c+=m)}this._iteratorPool.release(l);return{cpuVisibleImageData:a,cpuInvisibleImageData:b,cpuGeometryData:c,gpuVisibleImageData:e,
gpuInvisibleImageData:g,gpuGeometryData:h}};c.prototype.hasPendingUpdates=function(){if(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)return!0;var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)if(a.next().hasPendingUpdates)return this._iteratorPool.release(a),!0;this._iteratorPool.release(a);return!1};c.prototype.getTile=function(a){var b=a.split("/").map(function(a){return+a});if(0===b[0])return this.rootTiles.forEach(function(a){if(a.lij[1]===
b[1]&&a.lij[2]===b[2])return a}),null;var c=Math.pow(2,b[0]),d=Math.floor(b[1]/c),g=Math.floor(b[2]/c),h;this.rootTiles.some(function(a){return a.lij[1]===d&&a.lij[2]===g?(h=a,!0):!1});if(h){for(c=1<<b[0]-1;h.lij[0]<b[0];){var k=b[1]&c?2:0;0<(b[2]&c)&&k++;if(!h.children[k])return console.log("Tile "+a+" doesn't exist, smallest ancestor is "+v.tile2str(h)),null;h=h.children[k];c>>=1}n.weakAssert(h.lij[0]===b[0]&&h.lij[1]===b[1]&&h.lij[2]===b[2],"not the right tile?");return h}return null};c.prototype.setBorders=
function(a){this._renderer.drawBorders=a};c.prototype.setDisableRendering=function(a){this._renderer.disableRendering=a};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{renderer:this._renderer,lercWorker:this._lercWorker,mergeTile:function(b){return a._mergeTile(b)},updateTiles:function(b){return a._updateTiles(b)}}},enumerable:!0,configurable:!0});m([k.property({value:!1})],c.prototype,"cullBackFaces",null);m([k.property({readOnly:!0})],c.prototype,"extent",null);m([k.property({readOnly:!0})],
c.prototype,"loaded",void 0);m([k.property({value:1})],c.prototype,"baseOpacity",null);m([k.property({readOnly:!0})],c.prototype,"overlayManager",void 0);m([k.property({readOnly:!0})],c.prototype,"manifold",void 0);m([k.property()],c.prototype,"maxTextureScaleRaster",void 0);m([k.property()],c.prototype,"maxTextureScaleVector",void 0);m([k.property({readOnly:!0})],c.prototype,"ready",null);m([k.property({value:1})],c.prototype,"renderOrder",null);m([k.property({readOnly:!0})],c.prototype,"rootTiles",
void 0);m([k.property({value:!0})],c.prototype,"skirtScale",null);m([k.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],c.prototype,"spatialReference",null);m([k.property({})],c.prototype,"backgroundImage",void 0);m([k.property({type:P})],c.prototype,"backgroundColor",void 0);m([k.property({dependsOn:["backgroundColor","backgroundImage"]})],c.prototype,"_background",null);m([k.property({value:!1})],c.prototype,"slicePlaneEnabled",null);m([k.property({readOnly:!0})],c.prototype,
"tilingScheme",void 0);m([k.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0);m([k.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],c.prototype,"tilingSchemeDone",void 0);m([k.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0);m([k.property({value:!0})],c.prototype,"velvetOverground",null);m([k.property({value:!1})],c.prototype,"wireframe",null);return c=m([k.subclass("esri.views.3d.terrain.TerrainSurface")],
c)}(k.declared(Q,Z.Evented));var pa=1.2,qa=80/180*Math.PI,ra=110/180*Math.PI,ta=12,x=Y.vec4f64.create(),sa=p.create(),B=[0,0,0],C={spatialReference:null,tile:null,extent:null},t={spatialReference:null,extent:null,scale:0};return w});