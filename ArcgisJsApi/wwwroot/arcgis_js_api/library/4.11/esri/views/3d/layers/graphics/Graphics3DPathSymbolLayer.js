// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/lang ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Point ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(z,w,L,X,D,M,N,E,O,P,q,u,Q,F,R,G,S,T,c,U,V){function W(c,d,a,b){c=c.stageObject;var e=c.getMetadata().pathGeometries,h=c.getGeometryRecords(),H=h.length;l.spatialReference=a.spatialReference;for(var I="absolute-height"!==d.mode,k=0,m=0;m<H;m++){for(var n=h[m].geometry,x=e[n.id],A=0,r=0,u=x.builder.path.vertices;r<u.length;r++){var v=u[r];l.x=v.mapPos[0];l.y=v.mapPos[1];l.z=v.mapPos[2];v.elevation=q.computeElevation(a,l,d,b,I?J:null);I&&(A+=J.terrainElevation)}x.updateElevation(b);n.invalidateBoundingInfo();
c.geometryVertexAttrsUpdated(m);k+=A/x.builder.path.vertices.length}return k/H}Object.defineProperty(w,"__esModule",{value:!0});z=function(l){function d(a,b,e,h){a=l.call(this,a,b,e,h)||this;if(!a._isPropertyDriven("size")&&(b=Q.validateSymbolLayerSize(a._getSymbolSize())))return a._logWarning(b),a.reject(),a;a._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:a._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,
color:!0,opacity:!0,rotation:!1}};a._fastUpdates=a._context.renderer&&a._context.renderer.visualVariables&&0<a._context.renderer.visualVariables.length?F.initFastSymbolUpdatesState(a._context.renderer,a._vvConvertOptions):{enabled:!1};b=a._getStageIdHint();h=a._getMaterialOpacityAndColor();e=E.vec3f64.fromArray(h);h=h[3];e={diffuse:e,ambient:e,opacity:h,transparent:1>h||a._isPropertyDriven("opacity"),vertexColors:!1,slicePlaneEnabled:a._context.slicePlaneEnabled,castShadows:a.symbolLayer.castShadows};
a._fastUpdates.enabled?(D.mixin(e,a._fastUpdates.materialParameters,{size:a._getSize()}),a._material=new V(e,b+"_pathmat")):(e.vertexColors=a._isPropertyDriven("color")||a._isPropertyDriven("opacity"),a._material=new U(e,b+"_pathmat"));a._context.stage.add(G.ModelContentType.MATERIAL,a._material);a._profile=c.Profile.tube(K);b="tube";"profile"in a.symbolLayer&&(b=a.symbolLayer.profile);switch(b){default:a._profile=c.Profile.tube(K);break;case "strip":a._profile=c.Profile.strip();a._material.setParameterValues({cullFace:"none"});
break;case "fence":a._profile=c.Profile.fence();a._material.setParameterValues({cullFace:"none"});break;case "wall":a._profile=c.Profile.wall()}a._extruder=new c.SimpleExtruder;b="simple";"joint"in a.symbolLayer&&(b=a.symbolLayer.joint);switch(b){case "round":a._extruder=new c.RoundExtruder(4);break;case "bevel":a._extruder=new c.BevelExtruder;break;default:a._extruder=new c.SimpleExtruder}a.resolve();return a}L(d,l);d.prototype.destroy=function(){l.prototype.destroy.call(this);this.isFulfilled()||
this.reject();this._material&&(this._context.stage.remove(G.ModelContentType.MATERIAL,this._material.id),this._material=null)};d.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if("polyline"!==b.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+b.geometry.type),null;if(!this._validateGeometry(b.geometry))return null;var e="graphic"+b.uid,c=this.getGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,c,e,b.uid)};d.prototype.layerOpacityChanged=
function(){var a=this._getMaterialOpacity(),b=1>a||this._isPropertyDriven("opacity");this._material.setParameterValues({opacity:a,transparent:b});return!0};d.prototype.layerElevationInfoChanged=function(a,b,c){var e=this;a.forEach(function(a){var c=b(a);c&&(a=e.getGraphicElevationContext(a.graphic),c.needsElevationUpdates=q.needsElevationUpdates3D(a.mode),c.elevationContext.set(a))});return!0};d.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
return!0};d.prototype.pixelRatioChanged=function(a,b){return!0};d.prototype.applyRendererDiff=function(a,b){for(var c in a.diff)switch(c){case "visualVariables":if(F.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))a={},D.mixin(a,this._fastUpdates.materialParameters),this._material.setParameterValues(a);else return!1;break;default:return!1}return!0};d.prototype._getSymbolSize=function(){return this.symbolLayer.size||1};d.prototype._getSize=function(){return this._fastUpdates.enabled&&
this._fastUpdates.visualVariables.size?1:.5*this._getSymbolSize()/this._context.renderCoordsHelper.unitInMeters};d.prototype._createAs3DShape=function(a,b,e,d,l){var h={},k=a.geometry,m=k.paths,n=[],x=[],A=[],r=E.vec3f64.create(),z=this._context.renderSpatialReference===R.SphericalECEFSpatialReference,v=Array(6),k=q.getGeometryVertexData3D(m,k.hasZ,k.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(k,
m,"paths","PathSymbol3DLayer");if(0<m.length){for(var m=k.geometryData.outlines,w=k.eleVertexData,C=k.vertexData,B=0;B<m.length;++B){var y=m[B],g=y.index,f=y.count;if(!(2>f)){if(this._context.clippingExtent&&(q.computeBoundingBox(w,g,f,v),q.boundingBoxClipped(v,this._context.clippingExtent)))continue;q.chooseOrigin(C,g,f,r);q.subtractCoordinates(C,g,f,r);y=N.mat4f64.create();M.mat4.translate(y,y,r);g=new c.Path(C,w,g,f,z,r);g=new c.Builder(g,this._profile,this._extruder);f=null;if(this._fastUpdates.enabled)var t=
this._fastUpdates.visualVariables,f=t.size?u.getAttributeValue(t.size.field,a):0,p=t.color?u.getAttributeValue(t.color.field,a):0,t=t.opacity?u.getAttributeValue(t.opacity.field,a):0,f=new c.FastUpdatePathGeometry(g,f,p,t);else f=1,this._isPropertyDriven("size")?f=b.size[0]:this.symbolLayer.size&&(f=this.symbolLayer.size),f*=.5/this._context.renderCoordsHelper.unitInMeters,p=null,this._isPropertyDriven("color")&&(p=b.color),this._isPropertyDriven("opacity")&&null!=b.opacity&&(p=p?[p[0],p[1],p[2],
b.opacity]:[1,1,1,b.opacity]),f=new c.StaticPathGeometry(g,f,p);g=f.createGeometryData();g=new S(g,d+"path"+B);h[g.id]=f;g.singleUse=!0;n.push(g);x.push(this._material);A.push(y)}}a={layerUid:this._context.layer.uid,graphicUid:l,pathGeometries:h};if(0<n.length)return d=new T({geometries:n,materials:x,transformations:A,castShadow:!0,metadata:a,idHint:d}),n=new P(this,d,n,null,null,W,e),n.alignedTerrainElevation=k.terrainElevation,n.needsElevationUpdates=q.needsElevationUpdates3D(e.mode),n}return null};
return d}(u.Graphics3DSymbolLayer);w.Graphics3DPathSymbolLayer=z;var l=new O,J={verticalDistanceToGround:0,terrainElevation:0},K=10;w.default=z});