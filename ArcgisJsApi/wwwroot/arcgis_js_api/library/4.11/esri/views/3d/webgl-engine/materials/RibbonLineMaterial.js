// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/Logger ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./internal/MaterialUtil ./renderers/InstancedRenderer ./renderers/MergedRenderer ../shaders/RibbonLinePrograms ../../../webgl/renderState".split(" "),
function(O,na,H,W,F,X,g,l,e,P,Y,Q,Z,n,r,aa,ba,R,B){var ca=W.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");O=function(z){function a(a,d){d=z.call(this,d)||this;d.params=r.copyParameters(a,da);"miter"!==d.params.join&&(d.params.miterLimit=0);d.numVertsAtJoin="wall"===d.params.type?2:4;d.numVertsAtCap=2;d.canBeMerged="screen"===d.params.type&&null==d.params.stippleLength;return d}H(a,z);a.prototype.getColor=function(){return this.params.color};a.prototype.dispose=function(){};
a.prototype.setParameterValues=function(a){for(var d in a)n.assert("type"!==d,"RibbonLineMaterial: type cannot be changed after creation"),n.assert("stippleLength"!==d||null!=a[d]===(null!=this.params[d]),"RibbonLineMaterial: stippleLength on/off cannot be changed after creation"),this.params[d]=a[d];"miter"!==this.params.join&&(this.params.miterLimit=0);this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(a,d,b,c,f,h,e,g,n){n?r.intersectDrapedRenderLineGeometry(a,
d,b,c,f,h,this.params.width,e):this.intersectLineGeometry(a,d,b,c,f,h,e)};a.prototype.intersectLineGeometry=function(a,d,b,c,f,h,z,t){if(c.enable.selectionMode&&!Y.isAllHidden(d.componentVisibilities,a.componentOffsets))if(n.isTranslationMatrix(b)){d=a.data;a=d.getVertexAttr()[n.VertexAttrConstants.POSITION].data;d=(d=d.getVertexAttr()[n.VertexAttrConstants.SIZE])&&d.data[0];h=c.camera;t=ea;X.vec2.copy(t,c.point);d=(d+this.params.width*h.pixelRatio)/2+4*h.pixelRatio;g.vec3.set(G[0],t[0]-d,t[1]+d,
0);g.vec3.set(G[1],t[0]+d,t[1]+d,0);g.vec3.set(G[2],t[0]+d,t[1]-d,0);g.vec3.set(G[3],t[0]-d,t[1]-d,0);for(var w=0;4>w;w++)h.unprojectPoint(G[w],u[w]);e.plane.fromPoints(h.eye,u[0],u[1],I);e.plane.fromPoints(h.eye,u[1],u[2],J);e.plane.fromPoints(h.eye,u[2],u[3],K);e.plane.fromPoints(h.eye,u[3],u[0],L);f=Number.MAX_VALUE;for(w=0;w<a.length-5;w+=3)if(m[0]=a[w]+b[12],m[1]=a[w+1]+b[13],m[2]=a[w+2]+b[14],k[0]=a[w+3]+b[12],k[1]=a[w+4]+b[13],k[2]=a[w+5]+b[14],!(0>e.plane.signedDistance(I,m)&&0>e.plane.signedDistance(I,
k)||0>e.plane.signedDistance(J,m)&&0>e.plane.signedDistance(J,k)||0>e.plane.signedDistance(K,m)&&0>e.plane.signedDistance(K,k)||0>e.plane.signedDistance(L,m)&&0>e.plane.signedDistance(L,k))){h.projectPoint(m,C);h.projectPoint(k,D);if(0>C[2]&&0<D[2]){g.vec3.subtract(q,m,k);var p=h.frustum,M=-e.plane.signedDistance(p.planes[4],m),p=M/g.vec3.dot(q,p.planes[4]);g.vec3.scale(q,q,p);g.vec3.add(m,m,q);h.projectPoint(m,C)}else if(0<C[2]&&0>D[2])g.vec3.subtract(q,k,m),p=h.frustum,M=-e.plane.signedDistance(p.planes[4],
k),p=M/g.vec3.dot(q,p.planes[4]),g.vec3.scale(q,q,p),g.vec3.add(k,k,q),h.projectPoint(k,D);else if(0>C[2]&&0>D[2])continue;C[2]=0;D[2]=0;p=e.lineSegment.distance2(e.lineSegment.fromPoints(C,D,S),t);p<f&&(f=p,g.vec3.copy(T,m),g.vec3.copy(U,k))}b=c.rayBeginPoint;c=c.rayEndPoint;f<d*d&&(a=Number.MAX_VALUE,e.lineSegment.closestLineSegmentPoint(e.lineSegment.fromPoints(T,U,S),e.lineSegment.fromPoints(b,c,fa),E)&&(g.vec3.subtract(E,E,b),a=g.vec3.length(E),g.vec3.scale(E,E,1/a),a/=g.vec3.distance(b,c)),
z(a,E))}else ca.error("intersection assumes a translation-only matrix")};a.prototype.createBufferWriter=function(){return"wall"===this.params.type?new ga:new ha(this.canBeMerged)};a.prototype.createRenderer=function(a,d){return this.canBeMerged?new ba(a,d,this):new aa(a,d,this)};a.prototype.getGLMaterials=function(){return{color:ia,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:ja}};a.prototype.getAllTextureIds=function(){return[]};return a}(Z);var ia=function(e){function a(a,d){a=e.call(this,
a,d)||this;a.updateParameters();return a}H(a,e);a.prototype.updateParameters=function(){this.params=r.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.beginSlot=function(a){return a===(this.params.writeDepth?6:9)};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(R.colorPass,{screenScale:"screen"===a.type,wall:"wall"===a.type,stipple:null!=a.stippleLength,slice:a.slicePlaneEnabled});
this.pipelineState=B.makePipelineState({blending:B.separateBlendingParams(770,1,771,771),polygonOffset:a.polygonOffset&&V,depthTest:{func:513},depthWrite:1<=a.color[3]&&a.writeDepth&&B.defaultDepthWriteParams,colorWrite:B.defaultColorWriteParams})};a.prototype.bind=function(a,d){var b=this.program,c=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform4fv("eColor",c.color);b.setUniform1f("miterLimit",c.miterLimit);b.setUniform1f("nearPlane",d.nearFar[0]);b.setUniform1f("pixelRatio",
d.pixelRatio);b.setUniform1f("extLineWidth",c.width);"screen"===c.type&&b.setUniform2fv("screenSize",[d.viewport[2],d.viewport[3]]);null!=c.stippleLength&&b.setUniform1f("stippleLengthDoubleInv",c.stippleLength?1/(2*c.stippleLength):0)};a.prototype.release=function(a){};a.prototype.bindView=function(a,d){a=this.program;var b=this.params;r.bindView(d.origin,d.view,a);b.slicePlaneEnabled&&r.bindSlicePlane(d.origin,d.slicePlane,a)};a.prototype.bindInstance=function(a,d){this.program.setUniformMatrix4fv("model",
d.transformation)};a.prototype.getDrawMode=function(){return 5};return a}(Q),ja=function(e){function a(a,d){a=e.call(this,a,d)||this;a.updateParameters();return a}H(a,e);a.prototype.updateParameters=function(){this.params=r.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.beginSlot=function(a){return 4===a};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(R.highlightPass,
{screenScale:"screen"===a.type,wall:"wall"===a.type,stipple:null!=a.stippleLength,slice:a.slicePlaneEnabled});this.pipelineState=B.makePipelineState({polygonOffset:a.polygonOffset&&V,depthTest:{func:513},depthWrite:1<=a.color[3]&&B.defaultDepthWriteParams,colorWrite:B.defaultColorWriteParams})};a.prototype.bind=function(a,d){var b=this.program,c=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);r.bindHighlightRendering(a,d,b);b.setUniform4fv("eColor",c.color);b.setUniform1f("miterLimit",
c.miterLimit);b.setUniform1f("nearPlane",d.nearFar[0]);b.setUniform1f("pixelRatio",d.pixelRatio);b.setUniform1f("extLineWidth",c.width);"screen"===c.type&&b.setUniform2fv("screenSize",[d.viewport[2],d.viewport[3]]);null!=c.stippleLength&&b.setUniform1f("stippleLengthDoubleInv",c.stippleLength?1/(2*c.stippleLength):0)};a.prototype.release=function(a){};a.prototype.bindView=function(a,d){a=this.program;var b=this.params;r.bindView(d.origin,d.view,a);b.slicePlaneEnabled&&r.bindSlicePlane(d.origin,d.slicePlane,
a)};a.prototype.bindInstance=function(a,d){this.program.setUniformMatrix4fv("model",d.transformation)};a.prototype.getDrawMode=function(){return 5};return a}(Q),da={color:[1,1,1,1],width:0,type:"screen",join:"miter",miterLimit:5,writeDepth:!0,polygonOffset:!1,stippleLength:null,slicePlaneEnabled:!1},N=P.newLayout().vec3f(n.VertexAttrConstants.POSITION).vec2f(n.VertexAttrConstants.UV0).vec3f(n.VertexAttrConstants.AUXPOS1).vec3f(n.VertexAttrConstants.AUXPOS2).vec4f(n.VertexAttrConstants.COLOR).f32(n.VertexAttrConstants.SIZE),
ha=function(){function e(a){this.canBeMerged=a;this.vertexBufferLayout=N;this.numVertsAtJoin=4;this.numVertsAtCap=2}e.prototype.allocate=function(a){return N.createBuffer(a)};e.prototype.elementCount=function(a){a=(a.indices[n.VertexAttrConstants.POSITION].length/2+1-2)*this.numVertsAtJoin+2*this.numVertsAtCap;this.canBeMerged&&(a+=2);return a};e.prototype.write=function(a,e,d,b,c){d=e.vertexAttr[n.VertexAttrConstants.POSITION].data;var f=e.indices&&e.indices[n.VertexAttrConstants.POSITION];f&&f.length!==
2*(d.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");f=e.vertexAttr[n.VertexAttrConstants.COLOR]?e.vertexAttr[n.VertexAttrConstants.COLOR].data:ka;e=e.vertexAttr[n.VertexAttrConstants.SIZE]?e.vertexAttr[n.VertexAttrConstants.SIZE].data:la;var h=d.length/3;a=a.transformation;b=b.position.typedBuffer;var g=0,t=this.vertexBufferLayout.stride/4,w=c*=t;this.canBeMerged&&(c+=t);var p=d[0],m=d[1],k=d[2];if(a)var y=p,l=m,v=k,p=a[0]*y+a[4]*l+a[8]*v+a[12],m=a[1]*y+a[5]*l+a[9]*v+a[13],
k=a[2]*y+a[6]*l+a[10]*v+a[14];var q=d[3],A=d[4],v=d[5];a&&(y=q,l=A,q=a[0]*y+a[4]*l+a[8]*v+a[12],A=a[1]*y+a[5]*l+a[9]*v+a[13],v=a[2]*y+a[6]*l+a[10]*v+a[14]);for(var r=p,z=m,u=k,x=0;x<h;x++)y=3*x,x<h-1&&(q=d[y+3],A=d[y+4],v=d[y+5],a&&(y=q,l=A,q=a[0]*y+a[4]*l+a[8]*v+a[12],A=a[1]*y+a[5]*l+a[9]*v+a[13],v=a[2]*y+a[6]*l+a[10]*v+a[14])),g+=Math.sqrt((r-p)*(r-p)+(z-m)*(z-m)+(u-k)*(u-k)),b[c++]=r,b[c++]=z,b[c++]=u,b[c++]=g,b[c++]=0===x?-1.2:-1,b[c++]=p,b[c++]=m,b[c++]=k,b[c++]=q,b[c++]=A,b[c++]=v,b[c++]=f[0],
b[c++]=f[1],b[c++]=f[2],b[c++]=f[3],b[c++]=e[0],b[c++]=r,b[c++]=z,b[c++]=u,b[c++]=g,b[c++]=0===x?1.2:1,b[c++]=p,b[c++]=m,b[c++]=k,b[c++]=q,b[c++]=A,b[c++]=v,b[c++]=f[0],b[c++]=f[1],b[c++]=f[2],b[c++]=f[3],b[c++]=e[0],0<x&&x<h-1&&(b[c++]=r,b[c++]=z,b[c++]=u,b[c++]=g,b[c++]=-1.2,b[c++]=p,b[c++]=m,b[c++]=k,b[c++]=q,b[c++]=A,b[c++]=v,b[c++]=f[0],b[c++]=f[1],b[c++]=f[2],b[c++]=f[3],b[c++]=e[0],b[c++]=r,b[c++]=z,b[c++]=u,b[c++]=g,b[c++]=1.2,b[c++]=p,b[c++]=m,b[c++]=k,b[c++]=q,b[c++]=A,b[c++]=v,b[c++]=f[0],
b[c++]=f[1],b[c++]=f[2],b[c++]=f[3],b[c++]=e[0]),p=r,m=z,k=u,r=q,z=A,u=v;if(this.canBeMerged){for(x=w;x<w+t;x++)b[x]=b[x+t];d=c-t;for(x=0;x<t;x++)b[c++]=b[d++]}};return e}(),ma=P.newLayout().vec3f(n.VertexAttrConstants.POSITION).vec2f(n.VertexAttrConstants.UV0),ga=function(){function e(){this.vertexBufferLayout=ma;this.numVertsAtCap=this.numVertsAtJoin=2;this.tmpCurrent=l.vec3f64.create();this.tmpLast=l.vec3f64.create()}e.prototype.allocate=function(a){return N.createBuffer(a)};e.prototype.elementCount=
function(a){return(a.indices[n.VertexAttrConstants.POSITION].length/2+1-2)*this.numVertsAtJoin+2*this.numVertsAtCap};e.prototype.write=function(a,e,d,b,c){d=e.vertexAttr[n.VertexAttrConstants.POSITION].data;(e=e.indices&&e.indices[n.VertexAttrConstants.POSITION])&&e.length!==2*(d.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");e=d.length/3;a=a.transformation;var f=0,h=this.tmpCurrent,m=this.tmpLast;g.vec3.set(h,d[0],d[1],d[2]);for(var k=0;k<e;k++){var l=3*k;g.vec3.copy(m,
h);g.vec3.set(h,d[l],d[l+1],d[l+2]);a&&g.vec3.transformMat4(h,h,a);f+=g.vec3.squaredDistance(m,h);b.position.setVec(c,h);b.uv0.set(c,0,f);b.uv0.set(c,1,-1);++c;b.position.setVec(c,h);b.uv0.set(c,0,f);b.uv0.set(c,1,1);++c}};return e}(),V={factor:0,units:-4},ka=[255,255,255,255],la=[0,0,0,0],m=l.vec3f64.create(),k=l.vec3f64.create(),q=l.vec3f64.create(),E=l.vec3f64.create(),ea=l.vec3f64.create(),C=F.createRenderScreenPointArray3(),D=F.createRenderScreenPointArray3(),T=l.vec3f64.create(),U=l.vec3f64.create(),
S=e.lineSegment.create(),fa=e.lineSegment.create(),G=[F.createRenderScreenPointArray3(),F.createRenderScreenPointArray3(),F.createRenderScreenPointArray3(),F.createRenderScreenPointArray3()],u=[l.vec3f64.create(),l.vec3f64.create(),l.vec3f64.create(),l.vec3f64.create()],I=e.plane.create(),J=e.plane.create(),K=e.plane.create(),L=e.plane.create();return O});