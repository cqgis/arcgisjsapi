// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/maybe","../../core/PooledArray"],function(n,l,m,h){Object.defineProperty(l,"__esModule",{value:!0});l.newScheduler=function(g){return new d.Scheduler(g)};l.newBudget=function(g){return new d.Budget(g)};var d;(function(g){var d=function(){function b(a){this._now=a;this._budget=null;this._state=1;this._tasks=new h;this._runQueue=new h;this._idleStateCallbacks=new h;this._forceTask=this._idleUpdatesStartFired=!1;this._safetyBudget=0;this._budget=new g.Budget(a);
var b=this;this._test={state:void 0,idleBudget:100,get budget(){return b._budget.budget},elapsed:0}}b.prototype.registerTask=function(a,b,c){var e=this,f={update:b,needsUpdate:c,priority:a,schedule:a};this._tasks.push(f);return{remove:function(){return e._removeTask(f)},set priority(a){f.priority=a;0!==f.schedule&&(f.schedule=a)}}};b.prototype.registerIdleStateCallbacks=function(a,b){var c=this,e={idleBegin:a,idleEnd:b};this._idleStateCallbacks.push(e);2===this.state&&this._idleUpdatesStartFired&&
e.idleBegin();var f=this;return{remove:function(){return c._removeIdleStateCallbacks(e)},set idleBegin(a){f._idleUpdatesStartFired&&(e.idleEnd(),2===f._state&&a());e.idleBegin=a},set idleEnd(a){e.idleEnd=a}}};Object.defineProperty(b.prototype,"now",{get:function(){return this._now()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return m.isNone(this._test.state)?this._state:this._test.state},set:function(a){this._state!==a&&(this._state=a,2!==this.state&&
this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forEach(function(a){return a.idleEnd()})))},enumerable:!0,configurable:!0});b.prototype.updateBudget=function(a){var b=2===this.state,c=a.frameDuration;switch(this.state){case 2:c=100;break;case 1:c=Math.max(33,a.frameDuration);break;case 0:c=a.frameDuration}this._safetyBudget=b?0:c>2.5*a.tickTime?a.tickTime:5;c-=a.elapsedFrameTime+this._safetyBudget;this._test.elapsed=0;if(!b&&0>c&&!this._forceTask)return this._forceTask=
!0,!1;c=Math.max(c,5);this._budget.reset(c,b);return this._schedule()};b.prototype.frame=function(a){this._forceTask=!1;switch(this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forEach(function(a){return a.idleBegin()}));this._idleFrame();break;case 1:this._movingFrame();break;default:this._run()}this._test.elapsed=this._budget.elapsed};b.prototype._removeIdleStateCallbacks=function(a){this._idleUpdatesStartFired&&a.idleEnd();this._idleStateCallbacks.removeUnordered(a)};
b.prototype._removeTask=function(a){this._tasks.removeUnordered(a);this._runQueue.removeUnordered(a)};b.prototype._idleFrame=function(){this._run()};b.prototype._movingFrame=function(){this._run()};b.prototype._schedule=function(){var a=this;this._runQueue.forEach(function(a){a.needsUpdate()||(k.push(a),a.schedule=a.priority)});this._runQueue.removeUnorderedMany(k.data,k.length);k.clear();for(var b=function(){var b=!1;c._tasks.forEach(function(c){if(c.needsUpdate())switch(b=!0,c.schedule){case 0:break;
case 1:c.schedule=0;a._runQueue.push(c);break;default:--c.schedule}});if(!b)return{value:!1}},c=this;0===this._runQueue.length;){var d=b();if("object"===typeof d)return d.value}return!0};b.prototype._run=function(){for(;0<this._runQueue.length;){var a=this._runQueue.pop();this._budget.resetProgress();a.update(this._budget);a.schedule=a.priority;if(0>=this._budget.remaining)break}};Object.defineProperty(b.prototype,"test",{get:function(){return this._test},enumerable:!0,configurable:!0});return b}();
g.Scheduler=d;var k=new h,d=function(){function b(a){this.now=a;this._budget=this._begin=0;this._didWork=this._idle=!1}b.prototype.run=function(a){if(this.done)return!1;!0===a()&&(this._didWork=!0);return!0};Object.defineProperty(b.prototype,"done",{get:function(){return this._didWork&&this.elapsed>=this._budget},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"budget",{get:function(){return this._budget},enumerable:!0,configurable:!0});b.prototype.madeProgress=function(){this._didWork=
!0};Object.defineProperty(b.prototype,"idleFrame",{get:function(){return this._idle},enumerable:!0,configurable:!0});b.prototype.reset=function(a,b){this._begin=this.now();this._budget=a;this._idle=b;this._didWork=!1};Object.defineProperty(b.prototype,"remaining",{get:function(){return Math.max(this._budget-this.elapsed,0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"elapsed",{get:function(){return this.now()-this._begin},enumerable:!0,configurable:!0});b.prototype.resetProgress=
function(){this._didWork=!1};Object.defineProperty(b.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!0,configurable:!0});return b}();g.Budget=d})(d||(d={}))});