// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../core/maybe ../../core/promiseUtils ../../core/Queue ../../core/scheduling".split(" "),function(n,p,h,k,l,m){return function(){function b(a){var d=this;this._apiPromises=new Map;this._processingItems=new Map;this._isPaused=!1;this._task=this._schedule=null;this._pendingProcessing=0;this.concurrency=1;this.ordered=!1;a.concurrency&&(this.concurrency=a.concurrency);a.ordered&&(this.ordered=!0,this._itemsToProcess=[]);this._queue=new l({peeker:a.peeker});this.process=a.process;
var b=a.scheduler;a.priority&&b&&(this._task=b.registerTask(a.priority,function(a){return d.update(a)},function(){return d.needsUpdate()}))}b.prototype.destroy=function(){this.clear();this._schedule&&(this._schedule.remove(),this._schedule=null);this._task&&(this._task.remove(),this._task=null)};Object.defineProperty(b.prototype,"length",{get:function(){return this._processingItems.size+this._queue.length+this._pendingProcessing},enumerable:!0,configurable:!0});b.prototype.clear=function(){this._queue.clear();
var a=[];this._processingItems.forEach(function(d){return a.push(d.resultPromise)});this._processingItems.clear();a.forEach(function(a){return a.cancel()});a.length=0;this._apiPromises.forEach(function(d){return a.push(d)});this._apiPromises.clear();a.forEach(function(a){return a.cancel()});this._cancelNext()};b.prototype.find=function(a,d){var b=this,e=void 0;this._apiPromises.forEach(function(c,g){a.call(d,g)&&(e=b._apiPromises.get(g).promise)});return e};b.prototype.get=function(a){return(a=this._apiPromises.get(a))&&
a.promise||void 0};b.prototype.isOngoing=function(a){return this._processingItems.has(a)};b.prototype.has=function(a){return this._apiPromises.has(a)};b.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.prototype.push=function(a){var d=this;if(this._apiPromises.has(a))return this._apiPromises.get(a).promise;var b=k.createDeferred(function(b){var c=d._processingItems.get(a);c?c.resultPromise.cancel(b):(d._remove(a),d._scheduleNext())});this._add(a,b);this._scheduleNext();
return b.promise};b.prototype.reset=function(){var a=[];this._processingItems.forEach(function(b){return a.push(b)});this._processingItems.clear();for(var b=0;b<a.length;b++){var f=a[b];f.resultPromise.isFulfilled()?this._processReset(f):(f.isReset=!0,f.resultPromise.cancel())}};b.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())};b.prototype.needsUpdate=function(){return!this._isPaused&&0<this._queue.length&&this._processingItems.size<this.concurrency};b.prototype.update=
function(a){for(;!a.done&&0<this._queue.length&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),a.madeProgress()};b.prototype._scheduleNext=function(){var a=this;this._task||this._isPaused||this._schedule||(this._schedule=m.schedule(function(){a._schedule=null;a._next()}))};b.prototype._next=function(){for(;0<this._queue.length&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())};b.prototype._cancelNext=function(){this._schedule&&(this._schedule.remove(),
this._schedule=null)};b.prototype._processResult=function(a,b){this._remove(a.item);this._scheduleNext();a.dfd.resolve(b)};b.prototype._processError=function(a,b){a.isReset?this._processReset(a):(this._remove(a.item),this._scheduleNext(),a.dfd.reject(b))};b.prototype._processReset=function(a){this._remove(a.item);this._add(a.item,a.dfd);this._scheduleNext()};b.prototype._processOrdered=function(a,b){var d=this;if(a.isReset)this._processReset(a);else{a.result=b;var e=!1;this._processingItems.forEach(function(a){e||
(a.result?d._itemsToProcess.push(a):e=!0)});a=0;for(b=this._itemsToProcess;a<b.length;a++){var c=b[a];!1===c.result.ok?this._processError(c,c.result.error):this._processResult(c,c.result.value)}this._itemsToProcess.length=0}};b.prototype._process=function(a){var b=this;if(!h.isNone(a)){var f=this._apiPromises.get(a);this._pendingProcessing++;var e=this.process(a);this._pendingProcessing--;if(e&&"function"===typeof e.then){var c={item:a,resultPromise:e,result:null,dfd:f,isReset:!1};this._processingItems.set(a,
c);this.ordered?e.then(function(a){return b._processOrdered(c,{ok:!0,value:a})},function(a){return b._processOrdered(c,{ok:!1,error:a})}):e.then(function(a){return b._processResult(c,a)},function(a){return b._processError(c,a)})}else f.resolve(e),this._remove(a)}};b.prototype._add=function(a,b){this._apiPromises.set(a,b);this._queue.push(a)};b.prototype._remove=function(a){this._queue.remove(a);this._apiPromises.delete(a);this._processingItems.delete(a)};Object.defineProperty(b.prototype,"test",{get:function(){var a=
this;return{update:function(b){return a.update(b)}}},enumerable:!0,configurable:!0});return b}()});