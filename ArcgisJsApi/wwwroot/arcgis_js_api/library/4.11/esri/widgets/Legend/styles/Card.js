// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper dojo/i18n!../../../nls/common dojo/i18n!../../Legend/nls/Legend dojox/gfx ../../../core/Handles ../../../core/lang ../../../core/screenUtils ../../../core/accessorSupport/decorators ../../Widget ./support/utils ../support/styleUtils ../../support/colorUtils ../../support/widget".split(" "),function(H,I,z,t,J,A,w,B,C,D,x,p,E,F,u,G,f){var v=window.devicePixelRatio;
return function(y){function g(a){a=y.call(this)||this;a._handles=new C;a._hasIndicators=!1;a._selectedSectionName=null;a._sectionNames=[];a._sectionMap=new Map;a.activeLayerInfos=null;a.layout="stack";a.type="card";a.view=null;return a}z(g,y);g.prototype.postInitialize=function(){var a=this;this.own([this.watch("activeLayerInfos",function(c){a._handles.removeAll();a._watchForSectionChanges(c)})])};g.prototype.destroy=function(){this._handles.destroy();this._handles=null};g.prototype.render=function(){var a=
this,c;this._hasIndicators="auto"===this.layout&&768>=this.view.container.clientWidth||"stack"===this.layout;var d=this.activeLayerInfos,b=d&&d.toArray().map(function(d){return a._renderLegendForLayer(d)}).filter(function(a){return!!a});this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;var e=this._sectionNames.length,d=this._sectionNames.map(function(d,
c){var b;c=D.substitute({index:c+1,total:e},A.pagination.pageText);return f.tsx("div",{key:d,"aria-label":c,title:c,tabIndex:0,onclick:a._selectSection,onkeydown:a._selectSection,bind:a,class:a.classes("esri-legend--card__carousel-indicator",(b={},b["esri-legend--card__carousel-indicator--activated"]=a._selectedSectionName===d,b)),"data-section-name":d})}),d=this._hasIndicators&&1<e?f.tsx("div",{class:"esri-legend--card__carousel-indicator-container",key:"carousel-navigation"},d):null,b=this._hasIndicators?
this._sectionMap.get(this._selectedSectionName):b&&b.length?b:null,m=(c={},c["esri-legend--stacked"]=this._hasIndicators,c);return f.tsx("div",{class:this.classes("esri-legend--card esri-widget",m)},d,b?b:f.tsx("div",{class:"esri-legend--card__message"},w.noLegend))};g.prototype._selectSection=function(a){if(a=a.target.getAttribute("data-section-name"))this._selectedSectionName=a};g.prototype._watchForSectionChanges=function(a){var c=this;this._generateSectionNames();a&&(a.forEach(function(a){var b=
"activeLayerInfo-"+a.layer.uid+"-version-change";c._handles.remove(b);c._watchForSectionChanges(a.children);c._handles.add(a.watch("version",function(){return c._generateSectionNames()}),b)}),this._handles.add(a.on("change",function(){return c._watchForSectionChanges(a)})))};g.prototype._generateSectionNames=function(){this._sectionNames.length=0;this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)};g.prototype._generateSectionNamesForActiveLayerInfo=
function(a){var c=this;a.children.forEach(this._generateSectionNamesForActiveLayerInfo,this);a.legendElements&&a.legendElements.forEach(function(d,b){c._sectionNames.push("esri-legend--card__"+a.layer.uid+"-type-"+d.type+"-"+b)})};g.prototype._renderLegendForLayer=function(a){var c=this,d;if(!a.ready)return null;if(a.children.length)return d=a.children.map(function(a){return c._renderLegendForLayer(a)}).toArray(),f.tsx("div",{key:a.layer.uid,class:this.classes("esri-legend--card__service","esri-legend--card__group-layer")},
f.tsx("div",{class:"esri-legend--card__service-caption-container"},a.title),d);var b=a.legendElements;if(b&&!b.length)return null;var e=b.some(function(a){return"relationship-ramp"===a.type}),b=b.map(function(b,d){return c._renderLegendForElement(b,a,d,e)}).filter(function(a){return!!a});if(!b.length)return null;var m=(d={},d["esri-legend--card__group-layer-child"]=!!a.parent,d);return f.tsx("div",{key:a.layer.uid,class:this.classes("esri-legend--card__service",m)},f.tsx("div",{class:"esri-legend--card__service-caption-container"},
f.tsx("div",{class:"esri-legend--card__service-caption-text"},a.title)),f.tsx("div",{class:"esri-legend--card__service-content"},b))};g.prototype._renderLegendForElement=function(a,c,d,b){var e=this;void 0===b&&(b=!1);var m,n="color-ramp"===a.type,h="opacity-ramp"===a.type,l="size-ramp"===a.type,g=c.layer,k=a.title,r=null;"string"===typeof k?r=k:k&&(r=u.getTitle(k,n||h),r=k.title?k.title+" ("+r+")":r);d="esri-legend--card__"+g.uid+"-type-"+a.type+"-"+d;g=this._hasIndicators?f.tsx("div",null,f.tsx("h3",
{class:this.classes("esri-widget__heading","esri-legend--card__carousel-title")},c.title),f.tsx("h4",{class:this.classes("esri-widget__heading","esri-legend--card__layer-caption")},r)):r?f.tsx("h4",{class:this.classes("esri-widget__heading","esri-legend--card__layer-caption")},r):null;k=null;"symbol-table"===a.type?(l=a.infos.map(function(b,d){return e._renderLegendForElementInfo(b,c,a.legendType,d)}).filter(function(a){return!!a}),l.length&&(k=l[0].properties.classes&&l[0].properties.classes["esri-legend--card__symbol-row"],
b=(m={},m["esri-legend--card__label-container"]=!k&&!b,m["esri-legend--card__relationship-label-container"]=b,m),k=f.tsx("div",{key:d,class:"esri-legend--card__section"},g,f.tsx("div",{class:this.classes(b)},l)))):"color-ramp"===a.type||"opacity-ramp"===a.type||"heatmap-ramp"===a.type?k=f.tsx("div",{key:d,class:"esri-legend--card__section"},g,this._renderLegendForRamp(a)):l?k=f.tsx("div",{key:d,class:"esri-legend--card__section"},g,this._renderSizeRamps(a)):"relationship-ramp"===a.type&&(k=f.tsx("div",
{key:d,class:this.classes("esri-legend--card__section","esri-legend--card__relationship-section")},g,F.renderRelationshipRamp(a,this.id)));if(!k)return null;this._sectionMap.set(d,k);return k};g.prototype._renderLegendForElementInfo=function(a,c,d,b){var e,m,n,h=c.layer;if(a.type)return this._renderLegendForElement(a,c,b);c=u.isImageryStretchedLegend(h,d);if(a.symbol&&a.preview){if(-1===a.symbol.type.indexOf("simple-fill")){if(!a.label)return f.tsx("div",{key:b,bind:a.preview,afterCreate:u.attachToNode});
h=(e={},e["esri-legend--card__symbol-cell"]=this._hasIndicators,e);return f.tsx("div",{key:b,class:this.classes("esri-legend--card__layer-row",(m={},m["esri-legend--card__symbol-row"]=this._hasIndicators,m))},f.tsx("div",{class:this.classes(h),bind:a.preview,afterCreate:u.attachToNode}),f.tsx("div",{class:this.classes("esri-legend--card__image-label",(n={},n["esri-legend--card__label-cell"]=this._hasIndicators,n))},u.getTitle(a.label,!1)||""))}n=m=e=255;var h=0,g=d=c=255,q=0,k=a.symbol.color&&a.symbol.color.a,
r=a.symbol.outline&&a.symbol.outline.color.a;k&&(e=a.symbol.color.r,m=a.symbol.color.g,n=a.symbol.color.b,h=a.symbol.color.a);r&&(c=a.symbol.outline.color.r,d=a.symbol.outline.color.g,g=a.symbol.outline.color.b,q=a.symbol.outline.color.a);var t=a.symbol.color?G.isBright(a.symbol.color):!0,p=t?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)";return f.tsx("div",{key:b,class:"esri-legend--card__layer-row"},f.tsx("div",{class:"esri-legend--card__label-element",styles:{background:k?"rgba("+e+", "+m+", "+
n+", "+h+")":"none",color:t?"black":"white",textShadow:"-1px -1px 0 "+p+",\n                                              1px -1px 0 "+p+",\n                                              -1px 1px 0 "+p+",\n                                              1px 1px 0 "+p,border:r?"1px solid rgba("+c+", "+d+", "+g+", "+q+")":"none"}}," ",a.label," "))}if(a.src)return e=this._renderImage(a,h,c),f.tsx("div",{key:b,class:"esri-legend--card__layer-row"},e,f.tsx("div",{class:"esri-legend--card__image-label"},
a.label||""))};g.prototype._renderImage=function(a,c,d){var b,e=a.label,m=a.src,g=a.opacity;d=(b={},b["esri-legend--card__imagery-layer-image--stretched"]=d,b["esri-legend--card__symbol"]=!d,b);c={opacity:""+(null!=g?g:c.opacity)};return f.tsx("img",{alt:e,src:m,border:0,width:a.width,height:a.height,class:this.classes(d),styles:c})};g.prototype._drawImageOnSizeRamp=function(a,c,d){var b=d.x,e=d.y,f=d.width,g=d.height,h=new Image;h.src=c;h.onload=function(){a.drawImage(h,b,e,f,g);URL.revokeObjectURL(c)}};
g.prototype._attachSizeRampToNode=function(a){var c=a["data-legend-element"].infos,d=c[0],b=c[c.length-1],e=d.symbol,f=b.symbol,g="picture-marker"===e.type;e?-1<e.type.indexOf("3d")?(c=e.symbolLayers&&e.symbolLayers.length)?(c=e.symbolLayers.getItemAt(c-1).get("resource.primitive"),c="triangle"===c||"cone"===c||"tetrahedron"===c):c=void 0:c="triangle"===e.style:c=void 0;var h;e?-1<e.type.indexOf("3d")?(h=e.symbolLayers&&e.symbolLayers.length)?(h=e.symbolLayers.getItemAt(h-1),h=h.resource&&h.resource.primitive,
h="circle"===h||"cross"===h||"kite"===h||"sphere"===h||"cube"===h||"diamond"===h):h=void 0:(h=e.style,h="circle"===h||"diamond"===h||"cross"===h):h=void 0;var l,q;g?(l=e.url,q=f.url):(d.preview&&(d.preview.firstChild.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns","http://www.w3.org/2000/svg"),l=new Blob([d.preview.innerHTML],{type:"image/svg+xml"}),l=URL.createObjectURL(l)),b.preview&&(b.preview.firstChild.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns","http://www.w3.org/2000/svg"),
q=new Blob([b.preview.innerHTML],{type:"image/svg+xml"}),q=URL.createObjectURL(q)));var k=x.pt2px(d.size+d.outlineSize)*v,e=x.pt2px(b.size+b.outlineSize)*v,f=this._hasIndicators?k:k+100*v,g=this._hasIndicators?f+50*v:k,d=document.createElement("canvas");d.width=f;d.height=g;d.style.width=d.width/v+"px";d.style.height=d.height/v+"px";b=d.getContext("2d");this._hasIndicators?(this._drawImageOnSizeRamp(b,l,{x:0,y:0,width:k,height:k}),this._drawImageOnSizeRamp(b,q,{x:f/2-e/2,y:g-e,width:e,height:e}),
b.beginPath(),l=f/2-e/2,q=g-(c?0:h?e/2:e),b.moveTo(0,h?f/2:f),b.lineTo(l,q),l=f/2+e/2,c=g-(c?0:h?e/2:e),b.moveTo(f,h?f/2:f),b.lineTo(l,c)):(this._drawImageOnSizeRamp(b,l,{x:f-k,y:0,width:k,height:k}),this._drawImageOnSizeRamp(b,q,{x:0,y:g/2-e/2,width:e,height:e}),b.beginPath(),l=f-(h||c?k/2:k),b.moveTo(e-(h||c?e/2:0),g/2-e/2),b.lineTo(l,0),c=f-(h?k/2:k),b.moveTo(e-(h?e/2:0),g/2+e/2),b.lineTo(c,g));b.strokeStyle="#ddd";b.stroke();a.appendChild(d)};g.prototype._renderSizeRamps=function(a){var c,d=a.infos,
b=d[0].label,d=d[d.length-1].label;return f.tsx("div",{class:this.classes("esri-legend--card__layer-row",(c={},c["esri-legend--card__size-ramp-row"]=this._hasIndicators,c))},f.tsx("div",{class:"esri-legend--card__ramp-label"},this._hasIndicators?b:d),f.tsx("div",{class:"esri-legend--card__size-ramp-container"},f.tsx("div",{bind:this,"data-legend-element":a,afterCreate:this._attachSizeRampToNode})),f.tsx("div",{class:"esri-legend--card__ramp-label"},this._hasIndicators?d:b))};g.prototype._renderLegendForRamp=
function(a){var c=a.infos,d="heatmap-ramp"===a.type,b=c.length-1,e=2<b&&!d?25*b:100,g=e+20;a=document.createElement("div");a.style.width=g+"px";var n=B.createSurface(a,g,25),h=c.slice(0).reverse();try{h.forEach(function(a,c){a.offset=d?a.ratio:c/b}),d||n.createPath("M0 12.5 L10 0 L10 25 Z").setFill(h[0].color).setStroke(null),n.createRect({x:10,y:0,width:e,height:25}).setFill({type:"linear",x1:10,y1:0,x2:e+10,y2:0,colors:h}).setStroke(null),d||n.createPath("M"+(e+10)+" 0 L"+g+" 12.5 L"+(e+10)+" 25 Z").setFill(h[h.length-
1].color).setStroke(null)}catch(l){n.clear(),n.destroy()}if(!n)return null;e=h.filter(function(a,b){return!!a.label&&0!==b&&b!==h.length-1}).map(function(a){return f.tsx("div",{class:"esri-legend--card__interval-separators-container"},f.tsx("div",{class:"esri-legend--card__interval-separator"},"|"),f.tsx("div",{class:"esri-legend--card__ramp-label"},a.label))});g=c[c.length-1].label;c=c[0].label;return f.tsx("div",{class:"esri-legend--card__layer-row"},f.tsx("div",{class:"esri-legend--card__ramp-label"},
d?w[g]:g),f.tsx("div",{class:"esri-legend--card__symbol-container"},f.tsx("div",{bind:a,afterCreate:u.attachToNode}),e),f.tsx("div",{class:"esri-legend--card__ramp-label"},d?w[c]:c))};t([f.renderable(),p.property()],g.prototype,"activeLayerInfos",void 0);t([p.property()],g.prototype,"layout",void 0);t([p.property({readOnly:!0})],g.prototype,"type",void 0);t([p.property()],g.prototype,"view",void 0);t([f.accessibleHandler()],g.prototype,"_selectSection",null);return g=t([p.subclass("esri.widgets.Legend.styles.Card")],
g)}(p.declared(E))});