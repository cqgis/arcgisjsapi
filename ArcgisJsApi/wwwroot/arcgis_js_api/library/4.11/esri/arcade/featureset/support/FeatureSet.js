// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../support/FeatureSetIterator ../support/IdSet ../support/shared ../support/WhereClause ./ArcadeExporter ./BigDataFeatureSetIterator ./cache ./Guid ./stats ../../../core/promiseUtils ../../../geometry/geometryEngineAsync ../../../geometry/SpatialReference".split(" "),function(D,E,w,x,k,n,y,z,q,A,p,g,r,B){var v=0;return function(){function b(a){this._bigdCacheId=A.raw();this.recentlyUsedQueries=null;this._idstates=[];this._mainSetInUse=this._wset=this._parent=null;this._maxProcessing=
200;this._maxQuery=500;this._totalCount=-1;this._databaseType=k.FeatureServiceDatabaseType.NotEvaluated;this._databaseTypeProbed=null;this.declaredRootClass="esri.arcade.featureset.support.FeatureSet";this._featureCache=[];this.fields=this.types=null;this.objectIdField=this.geometryType="";this.spatialReference=null;this.loaded=this._transparent=this.hasZ=this.hasM=!1;this._loadPromise=null;a&&a.lrucache&&(this.recentlyUsedQueries=a.lrucache)}b.prototype.optimisePagingFeatureQueries=function(a){this._parent&&
this._parent.optimisePagingFeatureQueries(a)};b.prototype._hasMemorySource=function(){return!0};b.prototype.prop=function(a,c){if(void 0===c)return this[a];void 0!==this[a]&&(this[a]=c);return this};b.prototype.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent};b.prototype._ensureLoaded=function(){return this.load()};b.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=g.create(function(c,e){!0===a._parent.loaded?
(a._initialiseFeatureSet(),c(a)):a._parent.load().then(function(){try{a._initialiseFeatureSet(),c(a)}catch(d){e(d)}},e)}));return this._loadPromise};b.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=
this._parent.types):(this.fields=[],this.objectIdField=this.typeIdField="",this.spatialReference=new B({wkid:4326}),this.geometryType=k.layerGeometryEsriConstants.point)};b.prototype.getField=function(a,c){var e;if(c=c||this.fields)a=a.toLowerCase(),c.some(function(c){c&&c.name.toLowerCase()===a&&(e=c);return!!e});return e};b.prototype._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())};
b.prototype._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery};b.prototype._checkCancelled=function(a){if(null!==a&&a.isCanceled())throw Error("Operation has been cancelled.");};b.prototype._canDoAggregates=function(a,c,e,d,b){return null===this._parent?g.resolve(!1):this._parent._canDoAggregates(a,c,e,d,b)};b.prototype._getAggregatePagesDataSourceDefinition=function(a,c,e,d,b,f,l){return null===this._parent?g.reject(Error("Should never be called")):
this._parent._getAggregatePagesDataSourceDefinition(a,c,e,d,b,f,l)};b.prototype._getAgregagtePhysicalPage=function(a,c,e){return null===this._parent?g.reject(Error("Should never be called")):this._parent._getAgregagtePhysicalPage(a,c,e)};b.prototype.databaseType=function(){var a=this;if(this._databaseType===k.FeatureServiceDatabaseType.NotEvaluated){if(null!==q.applicationCache){var c=q.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==c)return c}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;
var e=[{thetype:k.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) \x3d CAST( '2015-01-01' as DATETIME)) AND OBJECTID\x3c0"},{thetype:k.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') \x3d TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID\x3c0"},{thetype:k.FeatureServiceDatabaseType.Standardised,testwhere:"(date '2015-01-01 10:10:10' \x3d date '2015-01-01 10:10:10') AND OBJECTID\x3c0"}],d=!1,b=null;this._databaseTypeProbed=b=g.create(function(c,
h){null!==q.applicationCache&&!1===d&&(q.applicationCache.setDatabaseType(a._cacheableFeatureSetSourceKey(),b),d=!0);a._getDatabaseTypeImpl(e,0).then(function(e){a._databaseType=e;c(a._databaseType)},function(c){null!==q.applicationCache&&q.applicationCache.clearDatabaseType(a._cacheableFeatureSetSourceKey());h(c)})});!1===d&&(q.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),b),d=!0);return this._databaseTypeProbed}return g.resolve(this._databaseType)};b.prototype._cacheableFeatureSetSourceKey=
function(){return"MUSTBESET"};b.prototype._getDatabaseTypeImpl=function(a,c){var e=this;return c>=a.length?g.resolve(k.FeatureServiceDatabaseType.Standardised):this._runDatabaseProbe(a[c].testwhere).then(function(d){return!0===d?a[c].thetype:e._getDatabaseTypeImpl(a,c+1)})};b.prototype._runDatabaseProbe=function(a){return g.reject(Error("Not Implemented"))};b.prototype._featureFromCache=function(a){if(void 0!==this._featureCache[a])return this._featureCache[a]};b.prototype._isInFeatureSet=function(a){return k.IdState.Unknown};
b.prototype._getSet=function(a){throw Error("Not implemented in abstract class");};b.prototype._getFeature=function(a,c,e){var d=this;try{return this._checkCancelled(e),void 0!==this._featureFromCache(c)?g.resolve(this._featureFromCache(c)):this._getFeatures(a,c,this._maxProcessingRate(),e).then(function(){d._checkCancelled(e);return void 0!==d._featureFromCache(c)?d._featureFromCache(c):g.reject(Error("Feature Not Found"))})}catch(h){return g.reject(h)}};b.prototype._getFeatures=function(a,c,e,d){return g.resolve("success")};
b.prototype._getFilteredSet=function(a,c,e,d,b){throw Error("Not implemented in abstract class");};b.prototype._refineSetBlock=function(a,c,e){var d=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQueryRate(),e))return this._expandPagedSet(a,this._maxQueryRate(),0,0,e).then(function(){return d._refineSetBlock(a,c,e)});this._checkCancelled(e);var b=a._candidates.length;this._refineKnowns(a,c);var f=b-a._candidates.length;return 0===a._candidates.length||f>=c?g.resolve(a):this._refineIfParentKnown(a,
c-f,e).then(function(){d._checkCancelled(e);d._refineKnowns(a,c-f);f=b-a._candidates.length;if(f<c&&0<a._candidates.length){var h=c-f,g=d._prepareFetchAndRefineSet(a._candidates,d._maxQueryRate());return d._fetchAndRefineFeatures(g,g.length>h?h:a._candidates.length,e).then(function(){d._checkCancelled(e);d._refineKnowns(a,c-f);return a})}return a})}catch(l){return g.reject(l)}};b.prototype._fetchAndRefineFeatures=function(a,c,e){return null};b.prototype._prepareFetchAndRefineSet=function(a,c){c=[];
for(var e=0;e<a.length;e++)this._isPhysicalFeature(a[e])&&c.push(a[e]);return c};b.prototype._isPhysicalFeature=function(a){return null===this._parent?!0:this._parent._isPhysicalFeature(a)};b.prototype._refineKnowns=function(a,c){var e=0,d=null,b=[];c=this._maxQueryRate();for(var f=0;f<a._candidates.length&&"GETPAGES"!==a._candidates[f];f++){var l=!1,g=this._candidateIdTransform(a._candidates[f]);g!==a._candidates[f]&&(l=!0);var m=this._isInFeatureSet(g);if(m===k.IdState.InFeatureSet)!0===l?0>a._known.indexOf(g)&&
(a._known.push(g),e+=1):(a._known.push(a._candidates[f]),e+=1),null===d?d={start:f,end:f}:d.end===f-1?d.end=f:(b.push(d),d={start:f,end:f});else if(m===k.IdState.NotInFeatureSet)null===d?d={start:f,end:f}:d.end===f-1?d.end=f:(b.push(d),d={start:f,end:f}),e+=1;else if(m===k.IdState.Unknown&&(e+=1,!0===a._ordered))break;if(e>=c)break}null!==d&&b.push(d);for(c=b.length-1;0<=c;c--)a._candidates.splice(b[c].start,b[c].end-b[c].start+1)};b.prototype._refineIfParentKnown=function(a,c,e){var d=this,b=new x([],
[],a._ordered,null);b._candidates=a._candidates.slice(0);return this._parent._refineSetBlock(b,c,e).then(function(c){d._parent._transformSetWithIdChanges(a);return c})};b.prototype._candidateIdTransform=function(a){return this._parent._candidateIdTransform(a)};b.prototype._transformSetWithIdChanges=function(a){this._parent._transformSetWithIdChanges(a)};b.prototype._checkIfNeedToExpandKnownPage=function(a,c,e){if(null===a.pagesDefinition)return!1;e=0;for(var d=a._lastFetchedIndex;d<a._known.length;d++){if("GETPAGES"===
a._known[d])return!0;if(void 0===this._featureCache[a._known[d]]&&(e+=1,e>=c))break}return!1};b.prototype._checkIfNeedToExpandCandidatePage=function(a,c,e){if(null===a.pagesDefinition)return!1;for(var d=e=0;d<a._candidates.length;d++){if("GETPAGES"===a._candidates[d])return!0;e+=1;if(e>=c)break}return!1};b.prototype._expandPagedSet=function(a,c,e,d,b){return null===this._parent?g.reject(Error("Parent Paging not implemented")):this._parent._expandPagedSet(a,c,e,d,b)};b.prototype._expandPagedSetFeatureSet=
function(a,c,e,b,h){var d=this;0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]&&(b=1);0===b&&0<a._candidates.length&&"GETPAGES"===a._candidates[a._candidates.length-1]&&(b=2);return 0===b?g.resolve("finished"):this._getPage(a,b,h).then(function(b){return e+b<c?d._expandPagedSet(a,c,e+b,0,h):"success"})};b.prototype._getPage=function(a,c,e){var b=this,h=1===c?a._known:a._candidates;if(a.pagesDefinition.internal.set.length>a.pagesDefinition.resultOffset||!0===a.pagesDefinition.internal.fullyResolved){--h.length;
for(var f=0,l=0;l<a.pagesDefinition.resultRecordCount&&!(a.pagesDefinition.resultOffset+l>=a.pagesDefinition.internal.set.length);l++)h[h.length]=a.pagesDefinition.internal.set[a.pagesDefinition.resultOffset+l],f++;a.pagesDefinition.resultOffset+=a.pagesDefinition.resultRecordCount;l=!1;!0===a.pagesDefinition.internal.fullyResolved&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset&&(l=!0);!1===l&&h.push("GETPAGES");return g.resolve(f)}return this._getPhysicalPage(a,c,e).then(function(){return b._getPage(a,
c,e)})};b.prototype._getPhysicalPage=function(a,c,e){return null};b.prototype._clonePageDefinition=function(a){return null===this._parent?null:this._parent._clonePageDefinition(a)};b.prototype._first=function(a){var c=this;return this.shouldBeResolvedAsBigData()?this.expressAsArcadeScript().then(function(a){try{a.script+="\n return first("+a.featuresetIdentifier+")";var e=c.sourceGeoAnalyticsProvider();return null===e?g.reject(Error("No Big Data Provider")):e.executeScript(a.script,a.globals,a.spatialReference).then(function(a){return a})}catch(h){return g.reject(h)}}):
this.iterator(a).next()};b.prototype.first=function(a){return this._first(a)};b.prototype._qStat=function(a,c,e,b){var d=this;return this.shouldBeResolvedAsBigData()?this._qBigDataStat(a,c,e,b):this._ensureLoaded().then(function(){return d._stat(a,c,"",null,null,e,b).then(function(f){return!1===f.calculated?d._manualStat(a,c,e,b).then(function(a){return a.result}):f.result})})};b.prototype._manualStat=function(a,c,e,b){switch(a.toLowerCase()){case "count":return p.count(this,b).then(function(a){return{calculated:!0,
result:a}});case "distinct":return p.distinct(this,c,e).then(function(a){return{calculated:!0,result:a}});case "avg":case "mean":return p.mean(this,c,b).then(function(a){return{calculated:!0,result:a}});case "stdev":return p.stdev(this,c,b).then(function(a){return{calculated:!0,result:a}});case "variance":return p.variance(this,c,b).then(function(a){return{calculated:!0,result:a}});case "sum":return p.sum(this,c,b).then(function(a){return{calculated:!0,result:a}});case "min":return p.min(this,c,b).then(function(a){return{calculated:!0,
result:a}});case "max":return p.max(this,c,b).then(function(a){return{calculated:!0,result:a}});default:return g.resolve({calculated:!0,result:0})}};b.prototype._stat=function(a,c,e,b,h,f,l){var d=this;return this._parent._stat(a,c,e,b,h,f,l).then(function(g){return!1===g.calculated?null===h&&""===e&&null===b?d._manualStat(a,c,f,l):{calculated:!1}:g})};b.prototype._unionAllGeomSelf=function(a){var c=this;if(this.shouldBeResolvedAsBigData())return this._qBigDataStat("geometryunion",null,-1,this._defaultTracker(a));
var e=this.iterator(this._defaultTracker(a)),b=[];return g.create(function(a,d){c._unionShapeInBatches(b,e,a,d)})};b.prototype._unionAllGeom=function(a){var c=this;return g.create(function(e,b){var d=c.iterator(c._defaultTracker(a));c._unionShapeInBatches([],d,e,b)})};b.prototype._unionShapeInBatches=function(a,c,e,b){var d=this;c.next().then(function(f){try{null!==f&&null!==f.geometry&&a.push(f.geometry),30<a.length||null===f&&1<a.length?r.union(a).then(function(h){try{null===f?e(h):(a=[h],d._unionShapeInBatches(a,
c,e,b))}catch(t){b(t)}},b):null===f?1===a.length?e(a[0]):e(null):d._unionShapeInBatches(a,c,e,b)}catch(l){b(l)}},b)};b.prototype.iterator=function(a){return this.shouldBeResolvedAsBigData()?new z(this,a):new w(this,a)};b.prototype.intersection=function(a,c){void 0===c&&(c=!1);return b._featuresetFunctions.intersection.bind(this)(a,c)};b.prototype.difference=function(a,c,e){void 0===c&&(c=!1);void 0===e&&(e=!0);return b._featuresetFunctions.difference.bind(this)(a,c,e)};b.prototype.symmetricDifference=
function(a,c,e){void 0===c&&(c=!1);void 0===e&&(e=!0);return b._featuresetFunctions.symmetricDifference.bind(this)(a,c,e)};b.prototype.morphShape=function(a,c,e,d){void 0===e&&(e="unknown");void 0===d&&(d=null);return b._featuresetFunctions.morphShape.bind(this)(a,c,e,d)};b.prototype.morphShapeAndAttributes=function(a,c,e){void 0===e&&(e="unknown");return b._featuresetFunctions.morphShapeAndAttributes.bind(this)(a,c,e)};b.prototype.union=function(a,c){void 0===c&&(c=!1);return b._featuresetFunctions.union.bind(this)(a,
c)};b.prototype.intersects=function(a){return b._featuresetFunctions.intersects.bind(this)(a)};b.prototype.envelopeIntersects=function(a){return b._featuresetFunctions.envelopeIntersects.bind(this)(a)};b.prototype.contains=function(a){return b._featuresetFunctions.contains.bind(this)(a)};b.prototype.overlaps=function(a){return b._featuresetFunctions.overlaps.bind(this)(a)};b.prototype.relate=function(a,c){return b._featuresetFunctions.relate.bind(this)(a,c)};b.prototype.within=function(a){return b._featuresetFunctions.within.bind(this)(a)};
b.prototype.touches=function(a){return b._featuresetFunctions.touches.bind(this)(a)};b.prototype.top=function(a){return b._featuresetFunctions.top.bind(this)(a)};b.prototype.crosses=function(a){return b._featuresetFunctions.crosses.bind(this)(a)};b.prototype.buffer=function(a,c,e,d){void 0===d&&(d=!0);return b._featuresetFunctions.buffer.bind(this)(a,c,e,d)};b.prototype.filter=function(a,c){void 0===c&&(c=null);return b._featuresetFunctions.filter.bind(this)(a,c)};b.prototype.orderBy=function(a){return b._featuresetFunctions.orderBy.bind(this)(a)};
b.prototype.dissolve=function(a,c){return b._featuresetFunctions.dissolve.bind(this)(a,c)};b.prototype.summarize=function(a,c){return b._featuresetFunctions.summarize.bind(this)(a,c)};b.prototype.summarizeBins=function(a,c,e,d){return b._featuresetFunctions.summarizeBins.bind(this)(a,c,e,d)};b.prototype.aggregate=function(a,c){return b._featuresetFunctions.aggregate.bind(this)(a,c)};b.prototype.reduce=function(a,c,b){var e=this;void 0===c&&(c=null);return g.create(function(d,f){e._reduceImpl(e.iterator(e._defaultTracker(b)),
a,c,0,d,f,0)})};b.prototype._reduceImpl=function(a,c,b,d,h,f,l){var e=this;try{l++,1E3<l?setTimeout(function(){l=0;e._reduceImpl(a,c,b,d,h,f,l)}):a.next().then(function(k){try{if(null===k)h(b);else{var m=c(b,k,d,e);g.isThenable(m)?m.then(function(b){e._reduceImpl(a,c,b,d+1,h,f,l)},f):e._reduceImpl(a,c,m,d+1,h,f,l)}}catch(C){f(C)}},f)}catch(m){f(m)}};b.prototype.removeField=function(a){return b._featuresetFunctions.removeField.bind(this)(a)};b.prototype.addField=function(a,c,e){void 0===e&&(e=null);
return b._featuresetFunctions.addField.bind(this)(a,c,e)};b.prototype.sumArea=function(a,c,b){void 0===c&&(c=!1);var e=k.convertSquareUnitsToCode(a);return this.shouldBeResolvedAsBigData()?this._qBigDataStat(c?"sumareageodesic":"sumarea",null,e,null):this.reduce(function(a,b){return null===b.geometry?0:c?r.geodesicArea(b.geometry,e).then(function(c){return a+c}):r.planarArea(b.geometry,e).then(function(c){return a+c})},0,b)};b.prototype.sumLength=function(a,c,b){void 0===c&&(c=!1);var e=k.convertLinearUnitsToCode(a);
return this.shouldBeResolvedAsBigData()?this._qBigDataStat(c?"sumlengthgeodesic":"sumlength",null,e,null):this.reduce(function(a,b){return null===b.geometry?0:c?r.geodesicLength(b.geometry,e).then(function(c){return a+c}):r.planarLength(b.geometry,e).then(function(c){return a+c})},0,b)};b.prototype._substituteVars=function(a,c){if(null!==c){var b={},d;for(d in c)b[d.toLowerCase()]=c[d];a.setVariablesDictionary(b)}};b.prototype.distinct=function(a,c,b,d){void 0===c&&(c=1E3);void 0===b&&(b=null);a=
n.create(a);this._substituteVars(a,b);return this._qStat("distinct",a,c,this._defaultTracker(d))};b.prototype.min=function(a,c,b){void 0===c&&(c=null);a=n.create(a);this._substituteVars(a,c);return this._qStat("min",a,-1,this._defaultTracker(b))};b.prototype.max=function(a,c,b){void 0===c&&(c=null);a=n.create(a);this._substituteVars(a,c);return this._qStat("max",a,-1,this._defaultTracker(b))};b.prototype.avg=function(a,c,b){void 0===c&&(c=null);a=n.create(a);this._substituteVars(a,c);return this._qStat("avg",
a,-1,this._defaultTracker(b))};b.prototype.sum=function(a,c,b){void 0===c&&(c=null);a=n.create(a);this._substituteVars(a,c);return this._qStat("sum",a,-1,this._defaultTracker(b))};b.prototype.stdev=function(a,c,b){void 0===c&&(c=null);a=n.create(a);this._substituteVars(a,c);return this._qStat("stdev",a,-1,this._defaultTracker(b))};b.prototype.variance=function(a,c,b){void 0===c&&(c=null);a=n.create(a);this._substituteVars(a,c);return this._qStat("variance",a,-1,this._defaultTracker(b))};b.prototype.count=
function(a){return this._qStat("count",n.create("1"),-1,this._defaultTracker(a))};b.prototype._defaultTracker=function(a){return a?a:g.createDeferred().promise};b.prototype.forEach=function(a,c){var b=this;return g.create(function(e,h){b._forEachImpl(b.iterator(b._defaultTracker(c)),a,b,e,h,0)})};b.prototype._forEachImpl=function(a,c,b,d,h,f){var e=this;try{f++,1E3<f?setTimeout(function(){f=0;e._forEachImpl(a,c,b,d,h,f)},0):a.next().then(function(l){try{if(null===l)d(b);else{var k=c(l);void 0===k||
null===k?e._forEachImpl(a,c,b,d,h,f):g.isThenable(k)?k.then(function(){try{e._forEachImpl(a,c,b,d,h,f)}catch(u){h(u)}},h):e._forEachImpl(a,c,b,d,h,f)}}catch(u){h(u)}},h)}catch(t){h(t)}};b.prototype.convertToJSON=function(a){for(var c=[],b=[],d=0;d<this.fields.length;d++)c.push(k.esriFieldToJson(this.fields[d]));return this.reduce(function(a){var c={geometry:a.geometry&&a.geometry.toJSON(),attributes:{}},e;for(e in a.attributes)c.attributes[e]=a.attributes[e];b.push(c);return 1},0,a)};b.prototype.canBeBigDataFeatureSet=
function(){return this._parent.canBeBigDataFeatureSet()};b.prototype.shouldBeResolvedAsBigData=function(){return this._parent.shouldBeResolvedAsBigData()};b.prototype.expressAsArcadeScript=function(){var a=this;return this._ensureLoaded().then(function(){try{var c={featuresetIdentifier:"",script:"",spatialReference:a.spatialReference,globals:{},functions:{stack:[],lkp:{}},symbols:{syms:{},featuresetsyms:[],symc:0}};c.script=a.expressAsArcadeScriptImpl(c.functions,c.globals,c.symbols);for(var b="",
d=0,h=c.functions.stack;d<h.length;d++)b+="\n"+h[d].script;c.script=b+c.script;c.featuresetIdentifier=c.symbols.featuresetsyms[c.symbols.featuresetsyms.length-1];return c}catch(f){return g.reject(f)}})};b.prototype.expressAsArcadeScriptImpl=function(a,c,b){return this._parent.expressAsArcadeScriptImpl(a,c,b)+"\n"+this.arcadeScriptStep(a,c,b)};b.prototype.arcadeScriptStep=function(a,c,b){return""};b.prototype.arcadeAssignNextGlobalIdentifier=function(a){for(var c=!1,b="";!1===c;)v++,b="$g_"+v.toString(),
void 0===a.syms[b]&&(c=!0);return b};b.prototype.arcadeAssignNextScriptStepIdentifiers=function(a){for(var c=0===a.featuresetsyms.length?"":a.featuresetsyms[a.featuresetsyms.length-1],b=!1,d="";!1===b;)a.symc++,d="$$c_"+a.symc.toString(),void 0===a.syms[d]&&(b=!0);a.featuresetsyms.push(d);a.syms[d]=d;return{currentFeatureSet:c,newFeatureSet:d}};b.prototype.exportArcadeFunctionAndDependencies=function(a,b,e,d){return y.exportFunctionAsArcade(a,b,e,d)};b.prototype.constructArcadeGeom=function(a,b,e){e=
this.arcadeAssignNextGlobalIdentifier(e);b[e]={name:e,type:"geometry",params:{value:a}};return e};b.prototype._qBigDataStat=function(a,b,e,d){var c=this;void 0===e&&(e=-1);return this.expressAsArcadeScript().then(function(d){try{switch(a.toLowerCase()){case "sumlength":d.script+="\n return length("+d.featuresetIdentifier+","+e.toString()+")";break;case "sumlengthgeodesic":d.script+="\n return lengthgeodetic("+d.featuresetIdentifier+","+e.toString()+")";break;case "sumarea":d.script+="\n return area("+
d.featuresetIdentifier+","+e.toString()+")";break;case "sumareageodesic":d.script+="\n return areageodetic("+d.featuresetIdentifier+","+e.toString()+")";break;case "geometryunion":d.script+="\n return union("+d.featuresetIdentifier+")";break;case "count":d.script+="\n return Count("+d.featuresetIdentifier+")";break;case "distinct":d.script+="\n return Distinct("+d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+'");';break;case "avg":case "mean":d.script+="\n return Average("+
d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+'");';break;case "stdev":d.script+="\n return Stdev("+d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+'");';break;case "variance":d.script+="\n return Variance("+d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+'");';break;case "sum":d.script+="\n return Sum("+d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+
'");';break;case "min":d.script+="\n return Min("+d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+'");';break;case "max":d.script+="\n return Max("+d.featuresetIdentifier+',"'+b.toWhereClause(k.FeatureServiceDatabaseType.Standardised)+'");';break;default:d.script="BADSTAT"}var f=c.sourceGeoAnalyticsProvider();return"BADSTAT"===d.script?g.reject(Error("Stat not supported")):null===f?g.reject(Error("No Big Data Provider")):f.executeScript(d.script,d.globals,d.spatialReference)}catch(t){return g.reject(t)}})};
b.prototype.sourceGeoAnalyticsProvider=function(){return this._parent.sourceGeoAnalyticsProvider()};b.prototype.bigDataCachePipeline=function(a){return"ga_pipeline("+a+",'"+this._bigdCacheId+"')"};b.prototype.castToText=function(){return"object, FeatureSet"};b.prototype.queryAttachments=function(a,b,e,d){return this._parent.queryAttachments(a,b,e,d)};b.prototype.schema=function(){for(var a=[],b=0,e=this.fields;b<e.length;b++)a.push(k.esriFieldToJson(e[b]));return{objectIdField:this.objectIdField,
typeIdField:this.typeIdField,geometryType:void 0===k.layerGeometryEsriConstants[this.geometryType]?"":k.layerGeometryEsriConstants[this.geometryType],hasZ:this.hasZ,hasM:this.hasM,fields:a}};b.prototype.convertToText=function(a,b){var c=this;return"schema"===a?this._ensureLoaded().then(function(){return JSON.stringify(c.schema)}):"featureset"===a?this._ensureLoaded().then(function(){var a=[];return c.reduce(function(b){b=b.toJson();null!==b.geometry&&b.geometry.spatialReference&&delete b.geometry.spatialReference;
a.push(b);return 1},0,b).then(function(){var b=c.schema();b.features=a;b.spatialReference=c.spatialReference.toJSON();return JSON.stringify(c.schema)})}):g.resolve(this.castToText())};b._featuresetFunctions={};b._polyfill={table:null};return b}()});