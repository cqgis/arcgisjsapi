// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../Graphic ./FeatureSetIterator ../../../core/promiseUtils ../../../geometry/support/jsonUtils".split(" "),function(m,n,h,f,k,e,l){return function(g){function d(b,a){b=g.call(this,b,a)||this;b._currentPage=null;b._iteratorStarted=!1;b._indexInCurrentPage=0;b._noMorePages=!1;b._script=null;b._featuresetMoniker="";return b}h(d,g);d.prototype.reset=function(){this._currentPage=null;this._iteratorStarted=!1;this._indexInCurrentPage=0;
this._featuresetMoniker=""};d.prototype.next=function(){var b=this;!1===this._iteratorStarted&&this.requestFirstPage().then(function(){return b.handleFeatureFromPage()});return this.handleFeatureFromPage()};d.prototype.handleFeatureFromPage=function(){var b=this;if(null===this._currentPage)return e.resolve(null);if(this._indexInCurrentPage<this._currentPage.length){this._indexInCurrentPage++;var a=this._currentPage[this._indexInCurrentPage-1];if(null!==a&&!(a instanceof f)){var c=null;null!==a.geometry&&
(c=this._script.spatialReference,c.toJSON?c=c.toJSON():c.toJson&&(c=c.toJson()),a.geometry.spatialReference=c,c=l.fromJSON(a.geometry));a=new f({geometry:c,attributes:a.attributes});this._currentPage[this._indexInCurrentPage-1]=a}return e.resolve(a)}return 0===this._currentPage.length?(this._noMorePages=!0,this._currentPage=null,this._indexInCurrentPage=0,e.resolve(null)):this.requestNextPage().then(function(){return b.handleFeatureFromPage()})};d.prototype.requestFirstPage=function(){var b=this;
this._indexInCurrentPage=0;this._currentPage=[];return this._parent.top(1E3).expressAsArcadeScript().then(function(a){a.script+="\n return "+a.featuresetIdentifier+";\n";b._script=a;a=b._parent.sourceGeoAnalyticsProvider();return null===a?e.reject(Error("No Big Data Provider")):a.executeFeatureSetPageRequest(b._script.script,b._script.globals,b._script.spatialReference,"").then(function(a){b._featuresetMoniker=a.moniker;b._currentPage=a.records;return b._iteratorStarted=!0})})};d.prototype.requestNextPage=
function(){var b=this;this._indexInCurrentPage=0;this._currentPage=[];var a=this._parent.sourceGeoAnalyticsProvider();return null===a?e.reject(Error("No Big Data Provider")):a.executeFeatureSetPageRequest(this._script.script,this._script.globals,this._script.spatialReference,this._featuresetMoniker).then(function(a){b._currentPage=a.records;return!0})};d.prototype.count=function(){var b=this;return-1!==this._parent._totalCount?e.resolve(this._parent._totalCount):this._parent.count().then(function(a){b._parent._totalCount=
a;return b._parent._totalCount})};return d}(k)});