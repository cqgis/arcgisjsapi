// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../support/FeatureSet ../support/IdSet ../support/shared ../support/WhereClause ../../../core/promiseUtils".split(" "),function(u,v,t,r,n,k,m,l){var q=function(g){function c(b){var a=g.call(this,b)||this;a.declaredClass="esri.arcade.featureset.actions.AttributeFilter";a._maxProcessing=1E3;a._parent=b.parentfeatureset;b.whereclause instanceof m?(a._whereclause=b.whereclause,a._whereClauseFunction=null,b=a._whereclause.getFunctions(),a._whereclauseDoesGeometry=
!1,0<=b.indexOf("area")?a._whereclauseDoesGeometry=!0:0<=b.indexOf("length")&&(a._whereclauseDoesGeometry=!0)):(a._whereClauseFunction=b.whereclause,a._whereclause=null);return a}t(c,g);c.prototype._getSet=function(b){var a=this;return null===this._wset?this._ensureLoaded().then(function(){return a._parent._getFilteredSet("",null,!1===a._whereclauseDoesGeometry?a._whereclause:null,null,b)}).then(function(d){a._checkCancelled(b);a._wset=!0===a._whereclauseDoesGeometry||null!==a._whereClauseFunction?
new n(d._candidates.slice(0).concat(d._known.slice(0)),[],d._ordered,a._clonePageDefinition(d.pagesDefinition)):new n(d._candidates.slice(0),d._known.slice(0),d._ordered,a._clonePageDefinition(d.pagesDefinition));return a._wset}):l.resolve(this._wset)};c.prototype._isInFeatureSet=function(b){var a=this._parent._isInFeatureSet(b);if(a===k.IdState.NotInFeatureSet)return a;a=this._idstates[b];return void 0===a?k.IdState.Unknown:a};c.prototype._getFeature=function(b,a,d){return this._parent._getFeature(b,
a,d)};c.prototype._getFeatures=function(b,a,d,e){return this._parent._getFeatures(b,a,d,e)};c.prototype._featureFromCache=function(b){return this._parent._featureFromCache(b)};c.prototype.executeWhereClause=function(b){return this._whereclause.testFeature(b)};c.prototype.executeWhereClauseDeferred=function(b){if(null!==this._whereClauseFunction)try{var a=this._whereClauseFunction(b);return l.isThenable(a)?a:l.resolve(a)}catch(d){return l.reject(d)}return this._whereclause.testFeatureDeferred(b)};
c.prototype._fetchAndRefineFeatures=function(b,a,d){var e=this,c=new n([],b,!1,null),p=Math.min(a,b.length);return this._parent._getFeatures(c,-1,p,d).then(function(){e._checkCancelled(d);if(!1===e._whereclauseDoesGeometry&&null==e._whereClauseFunction){for(var h=0;h<p;h++){var c=e._parent._featureFromCache(b[h]);!0===e.executeWhereClause(c)?e._idstates[b[h]]=k.IdState.InFeatureSet:e._idstates[b[h]]=k.IdState.NotInFeatureSet}return"success"}for(var f=[],h=0;h<p;h++)c=e._parent._featureFromCache(b[h]),
f.push(e.executeWhereClauseDeferred(c));return l.all(f).then(function(d){for(var c=0;c<a;c++)e._idstates[b[c]]=!0===d[c]?k.IdState.InFeatureSet:k.IdState.NotInFeatureSet;return"success"})})};c.prototype._getFilteredSet=function(b,a,d,c,f){var e=this;!0!==this._whereclauseDoesGeometry&&null===this._whereClauseFunction&&(null!==d?null!==this._whereclause&&(d=m.combine(this._whereclause,d)):d=this._whereclause);return this._ensureLoaded().then(function(){return e._parent._getFilteredSet(b,a,d,c,f)}).then(function(a){e._checkCancelled(f);
return!0===e._whereclauseDoesGeometry||null!==e._whereClauseFunction?new n(a._candidates.slice(0).concat(a._known.slice(0)),[],a._ordered,e._clonePageDefinition(a.pagesDefinition)):new n(a._candidates.slice(0),a._known.slice(0),a._ordered,e._clonePageDefinition(a.pagesDefinition))})};c.prototype._stat=function(b,a,d,c,f,g,h){var e=this;if(!0===this._whereclauseDoesGeometry||null!==this._whereClauseFunction)return null===f&&""===d&&null===c?this._manualStat(b,a,g,h):l.resolve({calculated:!1});var k=
this._whereclause;null!==f&&null!==this._whereclause&&(k=m.combine(this._whereclause,f));return this._parent._stat(b,a,d,c,k,g,h).then(function(k){return!1===k.calculated?null===f&&""===d&&null===c?e._manualStat(b,a,g,h):{calculated:!1}:k})};c.prototype._canDoAggregates=function(b,a,c,e,f){if(!0===this._whereclauseDoesGeometry||null!==this._whereClauseFunction)return l.resolve(!1);null!==f?null!==this._whereclause&&(f=m.combine(this._whereclause,f)):f=this._whereclause;return null===this._parent?
l.resolve(!1):this._parent._canDoAggregates(b,a,c,e,f)};c.prototype._getAggregatePagesDataSourceDefinition=function(b,a,c,e,f,g,h){if(null===this._parent)return l.reject(Error("Should never be called"));null!==f?null!==this._whereclause&&(f=m.combine(this._whereclause,f)):f=this._whereclause;return this._parent._getAggregatePagesDataSourceDefinition(b,a,c,e,f,g,h)};c.prototype.arcadeScriptStep=function(b,a,c){b=this.arcadeAssignNextScriptStepIdentifiers(c);a=this._whereclause.toWhereClause(k.FeatureServiceDatabaseType.Standardised);
return"var "+b.newFeatureSet+" \x3d "+this.bigDataCachePipeline("filter( "+b.currentFeatureSet+',"'+a+'")')+";"};return c}(r);r._featuresetFunctions.filter=function(g,c){void 0===c&&(c=null);if("function"===typeof g)return new q({parentfeatureset:this,whereclause:g});if(""===g)return this;g=m.create(g);if(null!==c){var b={},a;for(a in c)b[a.toLowerCase()]=c[a];g.setVariablesDictionary(b)}return new q({parentfeatureset:this,whereclause:g})};return q});