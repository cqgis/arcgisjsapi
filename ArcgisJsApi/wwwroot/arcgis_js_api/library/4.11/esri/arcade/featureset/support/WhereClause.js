// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../../../moment ./shared ./StandardizedFunctions ../../../core/has ../../../core/promiseUtils ../../../core/sql/WhereGrammar ../../../geometry/geometryEngineAsync".split(" "),function(I,J,v,g,q,C,f,G,w){function t(d){if(d){for(var a="",b=0;b<d.length;b++){var c=d[b];""!==c&&(a=""===a?c:D[a]<D[c]?c:a)}return a}return""}function x(d){return v(d,["YYYY-M-D H:m:s","YYYY-M-D H:mZ","YYYY-M-D H:m:sZ","YYYY-M-D H:m","YYYY-m-d"]).toDate()}function y(d){return v(d,["YYYY-M-D"]).toDate()}
function z(d){return Array.isArray(d)?d:[d]}function p(d){return null!==d?!0!==d:null}function E(d,a){return null!=d&&null!=a?!0===d&&!0===a:!1===d||!1===a?!1:null}function F(d,a){return null!=d&&null!=a?!0===d||!0===a:!0===d||!0===a?!0:null}function r(d,a){if(null==d)return null;for(var b=!1,c=0;c<a.length;c++){var e=a[c];if(null==e)b=null;else if(d===e){b=!0;break}}return b}function u(d,a,b){if(null==d)return null;for(var c="",e=0,l=0;l<a.length;l++){var h=a.charAt(l);switch(e){case 0:h===b?e=1:
c=0<="-[]/{}()*+?.\\^$|".indexOf(h)?c+("\\"+h):"%"===h?c+".*":"_"===h?c+".":c+h;break;case 1:c=0<="-[]/{}()*+?.\\^$|".indexOf(h)?c+("\\"+h):c+h,e=0}}return(new RegExp("^"+c+"$")).test(d)}function n(d){return d instanceof Date?d.valueOf():d}function A(d,a,b){if(null==a||null==b)return null;a=n(a);b=n(b);switch(d){case "\x3c\x3e":return a!==b;case "\x3d":return a===b;case "\x3e":return a>b;case "\x3c":return a<b;case "\x3e\x3d":return a>=b;case "\x3c\x3d":return a<=b}}function B(d){for(var a=[],b={},
c=0;c<d.length;c++){var e=d[c],l=e.toLowerCase();void 0===b[l]&&(a.push(e),b[l]=1)}return a}var D={boolean:1,string:2,integer:3,double:4,date:5},H=function(){function d(){}d.makeBool=function(a){return!0===a};d.featureValue=function(a,b){var c=a.attributes[b];if(void 0!==c)return c;for(var e in a.attributes)if(b.toLowerCase()===e.toLowerCase())return a.attributes[e];return null};d.equalsNull=function(a){return null===a};d.applyLike=function(a,b,c){return u(a,b,c)};d.ensureArray=function(a){return z(a)};
d.applyIn=function(a,b){return r(a,b)};d.currentDate=function(){var a=new Date;a.setHours(0,0,0,0);return a};d.currentTimestamp=function(){return new Date};d.compare=function(a,b,c){return A(a,b,c)};d.makeComparable=function(a){return n(a)};d.evaluateFunction=function(a,b){return q.evaluateFunction(a,b)};d.lookup=function(a,b){a=b[a];return void 0===a?null:a};d.between=function(a,b){return null==a||null==b[0]||null==b[1]?null:a>=b[0]&&a<=b[1]};d.notbetween=function(a,b){return null==a||null==b[0]||
null==b[1]?null:a<b[0]||a>b[1]};return d}();return function(){function d(){this.parameters=this.parseTree=null}d.create=function(a){var b=new d;b.parseTree=G.WhereGrammar.parse(a);return b};d.prototype.isStandardized=function(){var a=!0;this.visitAll(this.parseTree,function(b){a&&"function"===b.type&&(a=q.isStandardized(b.name,b.args.value.length))});return a};d.prototype.setVariablesDictionary=function(a){this.parameters=a};d.prototype.testFeature=function(a){return!!this.evaluateNode(this.parseTree,
a)};d.prototype.testFeatureCompiled=function(a){if(C("csp-restrictions"))return this.testFeature(a);void 0===this.parseTree._compiledVersion&&this._compileMe();return!!this.parseTree._compiledVersion(a,this.parameters)};d.prototype._compileMe=function(){var a="return "+this.evaluateNodeToJavaScript(this.parseTree);this.parseTree._compiledVersion=(new Function("feature","lookups",a)).bind(H)};d.prototype.evaluateNodeToJavaScript=function(a){switch(a.type){case "case_expression":var b="";if("simple"===
a.format)for(var c="this.makeComparable("+this.evaluateNodeToJavaScript(a.operand)+")",b="( ",e=0;e<a.clauses.length;e++)b+=" ("+c+" \x3d\x3d\x3d this.makeComparable("+this.evaluateNodeToJavaScript(a.clauses[e].operand)+")) ? ("+this.evaluateNodeToJavaScript(a.clauses[e].value)+") : ";else for(b="( ",e=0;e<a.clauses.length;e++)b+=" this.makeBool("+this.evaluateNodeToJavaScript(a.clauses[e].operand)+")\x3d\x3d\x3dtrue ? ("+this.evaluateNodeToJavaScript(a.clauses[e].value)+") : ";b=null!==a.else?b+
this.evaluateNodeToJavaScript(a.else):b+"null";return b+" )";case "param":return"this.lookup("+JSON.stringify(a.value.toLowerCase())+",lookups)";case "expr_list":b="[";c=0;for(a=a.value;c<a.length;c++)e=a[c],"["!==b&&(b+=","),b+=this.evaluateNodeToJavaScript(e);return b+"]";case "unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(a.expr)+")";case "binary_expr":switch(a.operator){case "AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+
" )";case "OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")))";case "IN":return"this.applyIn("+this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+
this.evaluateNodeToJavaScript(a.right)+"))";case "NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+")))";case "BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(a.left)+
","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+")";case "NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+"))";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"this.compare("+JSON.stringify(a.operator)+","+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "*":return"("+this.evaluateNodeToJavaScript(a.left)+
" * "+this.evaluateNodeToJavaScript(a.right)+")";case "-":return"("+this.evaluateNodeToJavaScript(a.left)+" - "+this.evaluateNodeToJavaScript(a.right)+")";case "+":return"("+this.evaluateNodeToJavaScript(a.left)+" + "+this.evaluateNodeToJavaScript(a.right)+")";case "/":return"("+this.evaluateNodeToJavaScript(a.left)+" / "+this.evaluateNodeToJavaScript(a.right)+")"}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return JSON.stringify(a.value);case "date":return"(new Date("+
y(a.value).getTime().toString()+"))";case "timestamp":return"(new Date("+x(a.value).getTime().toString()+"))";case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?"this.currentDate()":"CURRENT_TIMESTAMP"===a.column.toUpperCase()?"this.currentTimestamp()":"this.featureValue(feature,"+JSON.stringify(a.column)+")";case "function":return"this.evaluateFunction("+JSON.stringify(a.name)+","+this.evaluateNodeToJavaScript(a.args)+")"}throw Error("Unsupported sql syntax "+a.type);};d.prototype.calculateValue=
function(a){return this.evaluateNode(this.parseTree,a)};d.prototype.predictType=function(a,b){void 0===b&&(b={});for(var c={},e={},d={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"},h=0;h<a.length;h++){var f=a[h],
k=d[f.type];c[f.name.toLowerCase()]=void 0===k?"":k}for(f in b)k=d[b[f]],e[f.toLowerCase()]=void 0===k?"":k;switch(this.evaluateType(c,this.parseTree,e)){case "double":return"double";case "integer":return"integer";case "double":return"double";case "date":return"date";case "string":return"string"}return""};d.prototype.evaluateType=function(a,b,c){switch(b.type){case "case_expression":var e=[];if("simple"===b.format)for(var d=0;d<b.clauses.length;d++)e.push(this.evaluateType(a,b.clauses[d].value,c));
else for(d=0;d<b.clauses.length;d++)e.push(this.evaluateType(a,b.else,c));null!==b.else&&e.push(this.evaluateType(a,b.else,c));return t(e);case "param":a=c[b.value.toLowerCase()];if(void 0===a&&this.parameters){b=this.parameters[b.value.toLowerCase()];if(void 0===b||null===b)return"";if("string"===typeof b||b instanceof String)return"string";if("boolean"===typeof b)return"boolean";if(b instanceof Date)return"date";if("number"===typeof b)return 0===b%1?"integer":"double"}return void 0===a?"":a;case "expr_list":e=
[];d=0;for(b=b.value;d<b.length;d++)e.push(this.evaluateType(a,b[d],c));return e;case "unary_expr":return"boolean";case "binary_expr":switch(b.operator){case "AND":return"boolean";case "OR":return"boolean";case "IS":if("null"!==b.right.type)throw Error("Unsupported RHS for IS");return"boolean";case "ISNOT":if("null"!==b.right.type)throw Error("Unsupported RHS for IS");return"boolean";case "IN":return"boolean";case "NOT IN":return"boolean";case "BETWEEN":return"boolean";case "NOTBETWEEN":return"boolean";
case "LIKE":return"boolean";case "NOT LIKE":return"boolean";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"boolean";case "*":case "-":case "+":case "/":return t([this.evaluateType(a,b.left,c),this.evaluateType(a,b.right,c)])}throw Error("Not Supported Operator "+b.operator);case "null":return"";case "bool":return"boolean";case "string":return"string";case "number":return null===b.value?"":0===b.value%1?"integer":"double";case "date":return"date";case "timestamp":return"date";
case "column_ref":if("CURRENT_DATE"===b.column.toUpperCase()||"CURRENT_TIMESTAMP"===b.column.toUpperCase())return"date";a=a[b.column.toLowerCase()];return void 0===a?"":a;case "function":switch(b.name.toLowerCase()){case "position":case "extract":case "char_length":return"integer";case "round":a=this.evaluateType(a,b.args,c);if(a instanceof Array){if(0<a.length)return a[0];break}return a;case "sign":return a=this.evaluateType(a,b.args,c),a instanceof Array&&(a=t(a)),"integer"===a||"double"===a?a:
"double";case "ceiling":case "floor":case "abs":return a=this.evaluateType(a,b.args,c),a instanceof Array?t(a):a;case "area":case "length":case "log":case "log10":case "sin":case "cos":case "tan":case "asin":case "acos":case "atan":case "power":return"double";case "substring":case "trim":case "concat":case "lower":case "upper":return"string";case "truncate":return"double";case "round":if(a=this.evaluateType(a,b.args,c),a instanceof Array){if(0<a.length)return a[0]}else return a}return""}throw Error("Unsupported sql syntax "+
b.type);};d.prototype.calculateValueCompiled=function(a){if(C("csp-restrictions"))return this.calculateValue(a);void 0===this.parseTree._compiledVersion&&this._compileMe();return this.parseTree._compiledVersion(a,this.parameters)};d.prototype.getFunctions=function(){var a=[];this.visitAll(this.parseTree,function(b){"function"===b.type&&a.push(b.name.toLowerCase())});return B(a)};d.prototype.getFields=function(){var a=[];this.visitAll(this.parseTree,function(b){"column_ref"===b.type&&a.push(b.column)});
return B(a)};d.prototype.getVariables=function(){var a=[];this.visitAll(this.parseTree,function(b){"param"===b.type&&a.push(b.value.toLowerCase())});return B(a)};d.prototype.featureValue=function(a,b,c){var e=a.attributes[b];if(void 0!==e)return e;for(var d in a.attributes)if(b.toLowerCase()===d.toLowerCase())return c.column=d,a.attributes[d];return null};d.prototype.visitAll=function(a,b){if(null!=a)switch(b(a),a.type){case "when_clause":this.visitAll(a.operand,b);this.visitAll(a.value,b);break;
case "case_expression":for(var c=0,e=a.clauses;c<e.length;c++){var d=e[c];this.visitAll(d,b)}"simple"===a.format&&this.visitAll(a.operand,b);null!==a.else&&this.visitAll(a.else,b);break;case "expr_list":c=0;for(a=a.value;c<a.length;c++)d=a[c],this.visitAll(d,b);break;case "unary_expr":this.visitAll(a.expr,b);break;case "binary_expr":this.visitAll(a.left,b);this.visitAll(a.right,b);break;case "function":this.visitAll(a.args,b)}};d.prototype.toWhereClause=function(a){return this.evaluateNodeToWhereClause(this.parseTree,
a)};d.prototype.reformulateWithoutField=function(a,b){return d.create(this.evaluateNodeToWhereClause(this.parseTree,g.FeatureServiceDatabaseType.Standardised,a,b))};d.prototype.statisticFunction=function(){if("function"===this.parseTree.type){if(0===this.parseTree.args.value.length)return{name:this.parseTree.name,expr:null};if(1<this.parseTree.args.value.length)throw Error("Statistic does not have 1 or 0 Parameters");var a=new d;a.parseTree=this.parseTree.args.value[0];return{name:this.parseTree.name,
expr:a}}return null};d.prototype.testFeatureDeferred=function(a){return this.evaluateNodeDeferred(this.parseTree,a)};d.prototype.calculateValueDeferred=function(a){return this.evaluateNodeDeferred(this.parseTree,a)};d.prototype.scanForField=function(a){return this.findField(this.parseTree,a)};d.combine=function(a,b,c){void 0===c&&(c="AND");return d.create("(("+a.toWhereClause(g.FeatureServiceDatabaseType.Standardised)+")"+c+"("+b.toWhereClause(g.FeatureServiceDatabaseType.Standardised)+"))")};d.prototype.isSingleField=
function(){return"column_ref"===this.parseTree.type?!0:!1};d.prototype.findField=function(a,b){if(null===a||void 0===a)return!1;switch(a.type){case "when_clause":return this.findField(a.operand,b)||this.findField(a.value,b);case "case_expression":for(var c=0,e=a.clauses;c<e.length;c++){var d=e[c];if(this.findField(d,b))return!0}if("simple"===a.format&&this.findField(a.operand,b)||null!==a.else&&this.findField(a.else,b))return!0;break;case "expr_list":c=0;for(a=a.value;c<a.length;c++)if(d=a[c],this.findField(d,
b))return!0;break;case "unary_expr":return this.findField(a.expr,b);case "binary_expr":return this.findField(a.left,b)||this.findField(a.right,b);case "column_ref":return b.toLowerCase()===a.column.toLowerCase();case "function":return this.findField(a.args,b)}return!1};d.prototype.evaluateNode=function(a,b){switch(a.type){case "case_expression":if("simple"===a.format)for(var c=n(this.evaluateNode(a.operand,b)),e=0;e<a.clauses.length;e++){if(c===n(this.evaluateNode(a.clauses[e].operand,b)))return this.evaluateNode(a.clauses[e].value,
b)}else for(e=0;e<a.clauses.length;e++)if(!0===this.evaluateNode(a.clauses[e].operand,b))return this.evaluateNode(a.clauses[e].value,b);return null!==a.else?this.evaluateNode(a.else,b):null;case "param":return this.parameters[a.value.toLowerCase()];case "expr_list":c=[];e=0;for(a=a.value;e<a.length;e++){var d=a[e];c.push(this.evaluateNode(d,b))}return c;case "unary_expr":return p(this.evaluateNode(a.expr,b));case "binary_expr":switch(a.operator){case "AND":return E(this.evaluateNode(a.left,b),this.evaluateNode(a.right,
b));case "OR":return F(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b));case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return null===this.evaluateNode(a.left,b);case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return null!==this.evaluateNode(a.left,b);case "IN":return c=z(this.evaluateNode(a.right,b)),r(this.evaluateNode(a.left,b),c);case "NOT IN":return c=z(this.evaluateNode(a.right,b)),p(r(this.evaluateNode(a.left,b),c));case "BETWEEN":return c=
this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null==c||null==b[0]||null==b[1]?null:c>=b[0]&&c<=b[1];case "NOTBETWEEN":return c=this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null==c||null==b[0]||null==b[1]?null:c<b[0]||c>b[1];case "LIKE":return u(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b),a.escape);case "NOT LIKE":return p(u(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b),a.escape));case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return A(a.operator,
this.evaluateNode(a.left,b),this.evaluateNode(a.right,b));case "*":return this.evaluateNode(a.left,b)*this.evaluateNode(a.right,b);case "-":return this.evaluateNode(a.left,b)-this.evaluateNode(a.right,b);case "+":return this.evaluateNode(a.left,b)+this.evaluateNode(a.right,b);case "/":return this.evaluateNode(a.left,b)/this.evaluateNode(a.right,b)}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return a.value;case "date":return y(a.value);case "timestamp":return x(a.value);
case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?(d=new Date,d.setHours(0,0,0,0),d):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?new Date:this.featureValue(b,a.column,a);case "function":return b=this.evaluateNode(a.args,b),q.evaluateFunction(a.name,b)}throw Error("Unsupported sql syntax "+a.type);};d.prototype._makeDateString=function(a,b){a=v(a);var c=0===a.minute()&&0===a.hour()&&0===a.second()&&0===a.millisecond();switch(b){case g.FeatureServiceDatabaseType.FILEGDB:case g.FeatureServiceDatabaseType.Standardised:return c?
"date '"+a.format("YYYY-MM-DD")+"'":"date '"+a.format("YYYY-MM-DD HH:mm:ss")+"'";case g.FeatureServiceDatabaseType.Oracle:return c?"TO_DATE('"+a.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+a.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case g.FeatureServiceDatabaseType.SqlServer:return"'"+a.format(c?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case g.FeatureServiceDatabaseType.PGDB:return"#"+a.format(c?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case g.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+
a.format(c?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+a.format("YYYY-MM-DD HH:mm:ss")+"'"}};d.prototype._makeToday=function(a,b){switch(b){case g.FeatureServiceDatabaseType.FILEGDB:case g.FeatureServiceDatabaseType.Standardised:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case g.FeatureServiceDatabaseType.Oracle:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case g.FeatureServiceDatabaseType.SqlServer:return a?"CAST(GETDATE() AS DATE)":"GETDATE()";case g.FeatureServiceDatabaseType.PGDB:return a?
"CURRENT_DATE":"CURRENT_TIMESTAMP";case g.FeatureServiceDatabaseType.Postgres:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";default:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP"}};d.prototype.evaluateNodeToWhereClause=function(a,b,c,d){void 0===c&&(c=null);void 0===d&&(d=null);var e;switch(a.type){case "case_expression":var f=" CASE ";"simple"===a.format&&(f+=this.evaluateNodeToWhereClause(a.operand,b,c,d));for(e=0;e<a.clauses.length;e++)f+=" WHEN "+this.evaluateNodeToWhereClause(a.clauses[e].operand,
b,c,d)+" THEN "+this.evaluateNodeToWhereClause(a.clauses[e].value,b,c,d);null!==a.else&&(f+=" ELSE "+this.evaluateNodeToWhereClause(a.else,b,c,d));return f+" END ";case "param":c=this.parameters[a.value.toLowerCase()];if("string"===typeof c)return"'"+this.parameters[a.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(c instanceof Date)return this._makeDateString(c,b);if(c instanceof Array){a=[];for(e=0;e<c.length;e++)"string"===typeof c[e]?a.push("'"+c[e].toString().replace(/'/g,"''")+"'"):
c[e]instanceof Date?a.push(this._makeDateString(c[e],b)):a.push(c[e].toString());return a}return c.toString();case "expr_list":e=[];f=0;for(a=a.value;f<a.length;f++)e.push(this.evaluateNodeToWhereClause(a[f],b,c,d));return e;case "unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(a.expr,b,c,d)+" ) ";case "binary_expr":switch(a.operator){case "AND":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" AND "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "OR":return" ("+this.evaluateNodeToWhereClause(a.left,
b,c,d)+" OR "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IS NOT NULL )";case "IN":e=[];if("expr_list"===a.right.type)return e=this.evaluateNodeToWhereClause(a.right,b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,
c,d)+" IN ("+e.join(",")+")) ";e=this.evaluateNodeToWhereClause(a.right,b,c,d);return e instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IN ("+e.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" IN ("+e+")) ";case "NOT IN":e=[];if("expr_list"===a.right.type)return e=this.evaluateNodeToWhereClause(a.right,b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT IN ("+e.join(",")+")) ";e=this.evaluateNodeToWhereClause(a.right,b,c,d);return e instanceof Array?
" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT IN ("+e.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT IN ("+e+")) ";case "BETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "NOTBETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "LIKE":return""!==a.escape?
" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") ";case "NOT LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,
b,c,d)+") ";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,d)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,c,d)+") "}throw Error("Not Supported Operator "+a.operator);case "null":return"null";case "bool":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replace(/'/g,"''")+"'";case "timestamp":return this._makeDateString(a.value,b);case "date":return this._makeDateString(a.value,
b);case "number":return a.value.toString();case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?this._makeToday(!0,b):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?this._makeToday(!1,b):c&&c.toLowerCase()===a.column.toLowerCase()?"("+d+")":a.column;case "function":return c=this.evaluateNodeToWhereClause(a.args,b,c,d),this._translateFunctionToDatabaseSpecific(a.name,c,b)}throw Error("Unsupported sql syntax "+a.type);};d.prototype._translateFunctionToDatabaseSpecific=function(a,b,c){switch(a.toLowerCase().trim()){case "abs":if(1!==
b.length)throw Error("Invalid Parameter for call to ABS");return"abs("+b[0]+")";case "ceiling":case "ceil":if(1!==b.length)throw Error("Invalid Parameter for call to CEILING");switch(c){case g.FeatureServiceDatabaseType.Standardised:return"CEILING("+b[0]+")";default:return"CEILING("+b[0]+")"}case "floor":if(1!==b.length)throw Error("Invalid Parameter for call to Floor");return"FLOOR("+b[0]+")";case "log":if(1!==b.length)throw Error("Invalid Parameter for call to LOG");return"LOG("+b[0]+")";case "log10":if(1!==
b.length)throw Error("Invalid Parameter for call to LOG10");return"LOG10("+b[0]+")";case "power":if(2!==b.length)throw Error("Invalid Parameter for call to POWER");return"POWER("+b[0]+","+b[1]+")";case "round":if(2===b.length)return"ROUND("+b[0]+","+b[1]+")";if(1===b.length)return"ROUND("+b[0]+")";throw Error("Invalid Parameter for call to ROUND");case "truncate":if(1>b.length||2<b.length)throw Error("Invalid Parameter for TRUNCATE function");switch(c){case g.FeatureServiceDatabaseType.SqlServer:return"ROUND("+
b[0]+(1===b.length?"0":","+b[1])+",1)";default:return"TRUNCATE("+b[0]+(1===b.length?")":","+b[1]+")")}case "char_length":case "len":if(1!==b.length)throw Error("Invalid Parameter for CHAR_LENGTH function");switch(c){case g.FeatureServiceDatabaseType.SqlServer:return"LEN("+b[0]+")";case g.FeatureServiceDatabaseType.Oracle:return"LENGTH("+b[0]+")";default:return"CHAR_LENGTH("+b[0]+")"}case "concat":if(1>b.length)throw Error("Invalid Parameter for CONCAT function");c="CONCAT(";for(a=0;a<b.length;a++)0!==
a&&(c+=","),c+=b[a];return c+")";case "lower":case "lcase":if(1!==b.length)throw Error("Invalid Parameter for Lower function");return"LOWER("+b[0]+")";case "upper":case "ucase":if(1!==b.length)throw Error("Invalid Parameter for Upper function");return"UPPER("+b[0]+")";case "substring":switch(a="",c){case g.FeatureServiceDatabaseType.Oracle:return a="SUBSTR("+b[0]+","+b[1],3===b.length&&(a+=","+b[2]),a+")";case g.FeatureServiceDatabaseType.SqlServer:return a=3===b.length?"SUBSTRING("+b[0]+","+b[1]+
","+b[2]+")":"SUBSTRING("+b[0]+",  "+b[1]+", LEN("+b[0]+") - "+b[1]+")";default:return a="SUBSTRING("+b[0]+" FROM "+b[1],3===b.length&&(a+=" FOR "+b[2]),a+")"}case "extract":return"EXTRACT("+b[0].replace(/\'/g,"")+" FROM "+b[1]+")"}throw Error("Function Not Recognised");};d.prototype.evaluateWhereClausesSimpleDeferred=function(a,b,c,d,g){var e=this;try{return b>=a.length?null===c?f.resolve(null):this.evaluateNodeDeferred(c,g):this.evaluateNodeDeferred(a[b],g).then(function(h){try{return d===n(h)?
e.evaluateNodeDeferred(a[b].value,g):e.evaluateWhereClausesSimpleDeferred(a,b+1,c,d,g)}catch(k){return f.reject(k)}})}catch(m){return f.reject(m)}};d.prototype.evaluateWhereClausesDeferred=function(a,b,c,d){var e=this;try{return b>=a.length?null===c?f.resolve(null):this.evaluateNodeDeferred(c,d):this.evaluateNodeDeferred(a[b].operand,d).then(function(g){try{if(!0===g)return e.evaluateNodeDeferred(a[b].value,d);e.evaluateWhereClausesDeferred(a,b+1,c,d)}catch(m){return f.reject(m)}})}catch(h){return f.reject(h)}};
d.prototype.evaluateNodeDeferred=function(a,b){var c=this,d;try{var g=void 0;switch(a.type){case "case_expression":return"simple"===a.format?this.evaluateNodeDeferred(a.operand,b).then(function(d){d=n(d);return c.evaluateWhereClausesSimpleDeferred(a.clauses,0,a.else,d,b)}):this.evaluateWhereClausesDeferred(a.clauses,0,a.else,b);case "param":return f.resolve(this.parameters[a.value.toLowerCase()]);case "expr_list":g=[];d=0;for(var h=a.value;d<h.length;d++){var m=h[d];g.push(this.evaluateNodeDeferred(m,
b))}return f.all(g);case "unary_expr":return this.evaluateNodeDeferred(a.value,b).then(function(a){return p(a)});case "binary_expr":switch(a.operator){case "IS":return"null"!==a.right.type?f.reject(Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(a.left,b);case "ISNOT":return"null"!==a.right.type?f.reject(Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(a.left,b).then(function(a){return null!==a});case "LIKE":case "NOT LIKE":case "BETWEEN":case "NOTBETWEEN":case "IN":case "NOT IN":case "AND":case "OR":case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return d=
[this.evaluateNodeDeferred(a.left,b),this.evaluateNodeDeferred(a.right,b)],f.all(d).then(function(b){switch(a.operator){case "LIKE":case "NOT LIKE":return b=u(b[0],b[0],a.escape),"LIKE"===a.operator?b:p(b);case "BETWEEN":var c=b[0];b=b[1];return null==c||null==b[0]||null==b[1]?null:c>=b[0]&&c<=b[1];case "NOTBETWEEN":return c=b[0],b=b[1],null==c||null==b[0]||null==b[1]?null:c<b[0]||c>b[1];case "IN":case "NOT IN":c=b[1]instanceof Array?b[1]:[null];if("IN"===a.operator)return r(b[0],c);if("NOT IN"===
a.operator)return p(r(b[0],c));break;case "AND":return E(b[0],b[1]);case "OR":return F(b[0],b[1]);case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return A(a.operator,b[0],b[1]);case "*":return b[0]*b[1];case "-":return b[0]-b[1];case "+":return b[0]+b[1];case "/":return b[0]/b[1];default:return f.reject(Error("Unrecognised operator"))}});default:return f.reject(Error("Not Supported Operator "+a.operator))}case "null":case "bool":case "string":case "number":return f.resolve(a.value);
case "date":return f.resolve(y(a.value));case "timestamp":return f.resolve(x(a.value));case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?(m=new Date,m.setHours(0,0,0,0),f.resolve(m)):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?f.resolve(new Date):f.resolve(this.featureValue(b,a.column,a));case "function":return this.evaluateNodeDeferred(a.args,b).then(function(d){return c.executeFunctionDeferred(a.name,b,d)});default:return f.reject(Error("Malformed Where Clause"))}}catch(k){return f.reject(k)}};
d.prototype.executeFunctionDeferred=function(a,b,c){var d=0;try{if(q.isStandardized(a,c.length))return f.resolve(q.evaluateFunction(a,c));switch(a.toLowerCase().trim()){case "area":return d=g.convertSquareUnitsToCode(c[0]),a=!1,void 0===c[1]||null===c[1]||"1"!==c[1].toString()&&"true"!==c[1].toString().toLowerCase()&&"geodesic"!==c[1].toString().toLowerCase()||(a=!0),null===b.geometry?f.resolve(0):a?w.geodesicArea(b.geometry,d):w.planarArea(b.geometry,d);case "length":return d=g.convertLinearUnitsToCode(c[0]),
void 0===c[1]||null===c[1]||"1"!==c[1].toString()&&"true"!==c[1].toString().toLowerCase()&&"geodesic"!==c[1].toString().toLowerCase()||(a=!0),null===b.geometry?f.resolve(0):w.planarLength(b.geometry,d);default:return f.reject(Error("Function Not Recognised"))}}catch(l){return f.reject(l)}};return d}()});