// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.11/esri/copyright.txt for details.
//>>built
define("require exports ../Error ../has ../promiseUtils ./Connection ./RemoteClient ./WorkerOwner".split(" "),function(q,b,r,d,k,h,t,u){function l(){if(g)return g;for(var b=m+n,c=[],d=function(b){var a=u.create(b).then(function(c){return f[b]=c});c.push(a)},e=0;e<b;e++)d(e);return g=k.all(c).then(function(){})}Object.defineProperty(b,"__esModule",{value:!0});b.Connection=h;b.RemoteClient=t;(h=d("host-browser")?navigator.hardwareConcurrency:0)||(h=d("safari")&&d("mac")||d("trident")?8:2);var m=d("esri-workers-debug")?
1:Math.max(1,Math.ceil(h/2)),n=d("esri-workers-debug")?1:Math.max(1,Math.floor(h/2)),p=0,f=[];b.initialize=function(){l()};b.openWithPorts=function(a,c){return new b.Connection(a.map(function(a){return new b.RemoteClient(a,c,{})}))};b.open=function(a,c){void 0===c&&(c={});if("string"!==typeof a)return k.reject(new r("workers:undefined-module","modulePath is missing"));var d=c.strategy||"distributed";if("local"===d){var e=c.client;return k.create(function(c){return q([a],function(a){e=e||a;c(b.RemoteClient.connect(a))})}).then(function(a){return new b.Connection([new b.RemoteClient(a,
e,c)])})}return l().then(function(){if("dedicated"===d){var e=m+p++;p%=n;return f[e].open(a).then(function(a){return new b.Connection([new b.RemoteClient(a,c.client,c)])})}return k.all(f.map(function(b){return b.open(a)})).then(function(a){return new b.Connection(a.map(function(a){return new b.RemoteClient(a,c.client,c)}))})})};b.terminate=function(){g&&(g.cancel(),g=null);for(var a=0;a<f.length;a++)f[a]&&f[a].terminate();f.length=0};var g=null});