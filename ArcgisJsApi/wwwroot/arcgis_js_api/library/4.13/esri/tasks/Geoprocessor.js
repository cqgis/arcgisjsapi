// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../request ../core/asyncUtils ../core/compilerUtils ../core/promiseUtils ../core/urlUtils ../core/accessorSupport/decorators ../geometry/Extent ../geometry/SpatialReference ../geometry/support/normalizeUtils ../layers/support/Field ../layers/support/MapImage ./Task ./support/DataFile ./support/FeatureSet ./support/GPMessage ./support/JobInfo ./support/LinearUnit ./support/ParameterValue ./support/RasterData".split(" "),
function(D,O,h,E,k,F,G,q,H,u,n,I,f,J,w,K,x,y,L,v,p,M,r,z,N,A){return function(B){function c(b){b=B.call(this)||this;b._timers=new Map;b.outSpatialReference=null;b.processExtent=null;b.processSpatialReference=null;b.returnFeatureCollection=!1;b.returnM=!1;b.returnZ=!1;b.url=null;return b}E(c,B);c.prototype.destroy=function(){this._timers.forEach(function(b){clearInterval(b)})};c.prototype.cancelJob=function(b,d){var a=this.parsedUrl,e=a.path;d=h({},this.requestOptions,d,{query:h({},a.query,{f:"json"})});
this._clearTimer(b);return q(e+"/jobs/"+b+"/cancel",d).then(function(a){return r.fromJSON(a.data)})};c.prototype.checkJobStatus=function(b,d){var a=this.parsedUrl,e=a.path;d=h({},this.requestOptions,d,{query:h({},a.query,{f:"json"})});return q(e+"/jobs/"+b,d).then(function(a){return r.fromJSON(a.data)})};c.prototype.execute=function(b,d){var a=this;return this._constructRequest("execute",b,d).then(function(b){var e=b.data.messages||[];return{results:(b.data.results||[]).map(a._decode),messages:e.map(function(a){return M.fromJSON(a)})}})};
c.prototype.getResultData=function(b,d,a){var e=this,g=this.parsedUrl,c=g.path;a=h({},this.requestOptions,a,{query:h({},g.query,{returnType:"data",f:"json"})});return q(c+"/jobs/"+b+"/results/"+d,a).then(function(a){return e._decode(a.data)})};c.prototype.getResultImage=function(b,d,a,e){var c=this,l=this.parsedUrl;a=h({},l.query,a.toJSON(),{f:"json"});a=this._gpEncode(a);e=h({},this.requestOptions,e,{query:a});return q(l.path+"/jobs/"+b+"/results/"+d,e).then(function(a){return c._decode(a.data)})};
c.prototype.getResultMapImageLayer=function(b){return G(this,void 0,void 0,function(){var d,a,e,c,l,h,f,C;return F(this,function(g){switch(g.label){case 0:return d=this.parsedUrl,a=d.path,e=d.query,c=a.indexOf("/GPServer/"),l=a.substring(0,c),h=e?"?"+I.objectToQuery(e):"",f=l+"/MapServer/jobs/"+b+h,[4,n.create(function(a){return D(["../layers/MapImageLayer"],a)})];case 1:return C=g.sent(),[2,new C({url:f})]}})})};c.prototype.submitJob=function(b,d){return this._constructRequest("submitJob",b,d).then(function(a){return r.fromJSON(a.data)})};
c.prototype.waitForJobCompletion=function(b,d){var a=this;void 0===d&&(d={});var e=d.interval,c=void 0===e?1E3:e,l=d.signal,h=d.statusCallback;return n.create(function(e,d){n.onAbort(l,function(){a._clearTimer(b);d(n.createAbortError())});a._clearTimer(b);var g=setInterval(function(){a._timers.has(b)||d(n.createAbortError());a._getJobStatus(b,a.requestOptions).then(function(c){var g=c.jobStatus;switch(g){case "job-succeeded":a._clearTimer(b);e(c);break;case "job-submitted":case "job-executing":case "job-waiting":case "job-new":h&&
h(c);break;case "job-cancelled":case "job-cancelling":case "job-deleted":case "job-deleting":case "job-timed-out":case "job-failed":a._clearTimer(b);d(c);break;default:u.neverReached(g)}})},c);a._timers.set(b,g)})};c.prototype._clearTimer=function(b){this._timers.has(b)&&(clearInterval(this._timers.get(b)),this._timers.delete(b))};c.prototype._constructRequest=function(b,d,a){var e=this,c={},l={},f=[];this._collectGeometries(d,f,c);return H.safeCast(K.normalizeCentralMeridian(f)).then(function(g){var f=
e.outSpatialReference,k=e.parsedUrl,m=e.processExtent,t=e.processSpatialReference,n=e.returnFeatureCollection,r=e.returnM,v=e.returnZ,p;for(p in c){var u=c[p];l[p]=g.slice(u[0],u[1])}g=f?f.wkid||f:null;t=t?t.wkid||t:null;m=h({},k.query,m?{context:{extent:m,outSR:g,processSR:t}}:{"env:outSR":g,"env:processSR":t},d,{returnFeatureCollection:n,returnM:r,returnZ:v,f:"json"});m=e._gpEncode(m,null,l);m=h({},e.requestOptions,a,{query:m});return q(k.path+"/"+b,m)})};c.prototype._collectGeometries=function(b,
d,a){for(var e in b){var c=b[e];c&&"object"===typeof c&&c instanceof p&&(c=c.features,a[e]=[d.length,d.length+c.length],c.forEach(function(a){d.push(a.geometry)}))}};c.prototype._decode=function(b){var c=b.dataType,a=N.fromJSON(b);switch(c){case "GPBoolean":case "GPDouble":case "GPLong":case "GPString":break;case "GPDate":a.value=new Date(a.value);break;case "GPDataFile":a.value=v.fromJSON(a.value);break;case "GPLinearUnit":a.value=z.fromJSON(a.value);break;case "GPFeatureRecordSetLayer":case "GPRecordSet":a.value=
b.value.url?v.fromJSON(a.value):p.fromJSON(a.value);break;case "GPRasterData":case "GPRasterDataLayer":b=b.value.mapImage;a.value=b?y.fromJSON(b):A.fromJSON(a.value);break;case "GPField":a.value=x.fromJSON(a.value);break;case "GPMultiValue:GPBoolean":case "GPMultiValue:GPDouble":case "GPMultiValue:GPLong":case "GPMultiValue:GPString":break;case "GPMultiValue:GPDate":a.value=a.value.map(function(a){return new Date(a)});break;case "GPMultiValue:GPDataFile":a.value=a.value.map(function(a){return v.fromJSON(a)});
break;case "GPMultiValue:GPLinearUnit":a.value=a.value.map(function(a){return z.fromJSON(a)});break;case "GPMultiValue:GPFeatureRecordSetLayer":case "GPMultiValue:GPRecordSet":a.value=a.value.map(function(a){return p.fromJSON(a)});break;case "GPMultiValue:GPRasterData":case "GPMultiValue:GPRasterDataLayer":a.value=a.value.map(function(b){return b?y.fromJSON(b):A.fromJSON(a.value)});break;case "GPMultiValue:GPField":a.value=a.value.map(function(a){return x.fromJSON(a)});break;default:u.neverReached(c)}return a};
c.prototype._gpEncode=function(b,c,a){var d=this,g;for(g in b){var f=b[g];Array.isArray(f)?b[g]=JSON.stringify(f.map(function(a){return d._gpEncode({item:a},!0).item},this)):f instanceof Date&&(b[g]=f.getTime())}return this._encode(b,c,a)};c.prototype._getJobStatus=function(b,c){var a=this.parsedUrl;b=a.path+"/jobs/"+b;c=h({},this.requestOptions,c,{query:h({},a.query,{f:"json"})});return q(b,c).then(function(a){return r.fromJSON(a.data)})};k([f.property({type:w})],c.prototype,"outSpatialReference",
void 0);k([f.property({type:J})],c.prototype,"processExtent",void 0);k([f.property({type:w})],c.prototype,"processSpatialReference",void 0);k([f.property()],c.prototype,"returnFeatureCollection",void 0);k([f.property()],c.prototype,"returnM",void 0);k([f.property()],c.prototype,"returnZ",void 0);k([f.property()],c.prototype,"url",void 0);return c=k([f.subclass("esri/tasks/Geoprocessor")],c)}(f.declared(L))});