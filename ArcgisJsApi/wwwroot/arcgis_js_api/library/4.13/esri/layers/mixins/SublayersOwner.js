// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/Collection ../../core/CollectionFlattener ../../core/Error ../../core/lang ../../core/Logger ../../core/accessorSupport/decorators ../../core/accessorSupport/ensureType ../../core/accessorSupport/PropertyOrigin ../support/Sublayer ../support/sublayerUtils".split(" "),function(B,r,u,v,h,l,w,x,t,y,e,z,m,k,n){function p(f,e,b){var a=[],d={};if(!f)return a;
f.forEach(function(c){var g=new k;g.read(c,e);b&&(-1===b.indexOf(g.id)?g.visible=!1:g.visible=!0);d[g.id]=g;null!=c.parentLayerId&&-1!==c.parentLayerId?(c=d[c.parentLayerId],c.sublayers||(c.sublayers=[]),c.sublayers.unshift(g)):a.unshift(g)});return a}function q(f,e){var b=e.get(f.id);b?(t.mixin(f.__accessor__.store._values,b.__accessor__.store._values),b.__accessor__.overridden&&(f.__accessor__.overridden=t.mixin(f.__accessor__.overridden||{},b.__accessor__.overridden)),b.sublayers&&(f.sublayers=
b.sublayers.map(function(a){return q(a,e)}))):f.sublayers&&f.sublayers.forEach(function(a){return q(a,e)});return f}Object.defineProperty(r,"__esModule",{value:!0});var A=y.getLogger("esri.layers.TileLayer");r.SublayersOwner=function(f){return function(f){function b(){for(var a=[],d=0;d<arguments.length;d++)a[d]=arguments[d];var c=f.apply(this,a)||this;c.allSublayers=new w({root:c,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});c.watch("sublayers",function(a,
d){return c._handleSublayersChange(a,d)},!0);return c}v(b,f);b.prototype.readServiceSublayers=function(a,d,c){return p(d.layers,c)};b.prototype.readSublayersFromItemOrWebMap=function(a,d,c){return!d.layers&&d.visibleLayers?d.visibleLayers.map(function(a){return{id:a}}):p(d.layers,c,d.visibleLayers)};b.prototype.readSublayers=function(a,d,c){a=p(d.layers,c);this._updateSublayersForOrigin(m.OriginId.PORTAL_ITEM,a);this._updateSublayersForOrigin(m.OriginId.WEB_MAP,a);this._updateSublayersForOrigin(m.OriginId.WEB_SCENE,
a);return a};b.prototype.writeSublayers=function(a,d,c,g){if(a&&this.serviceSublayers){a=a.slice().reverse().flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray();var b=this.serviceSublayers.flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray().reduce(function(a,g){a.set(g.id,g);return a},new Map),f=!1,e=!0;this.capabilities&&this.capabilities.operations.supportsExportMap&&this.capabilities.exportMap.supportsDynamicLayers?(f=n.isExportDynamic(a,this.serviceSublayers,
this),e=!f&&n.sameStructureAsService(a,this.serviceSublayers)):e=n.sameStructureAsService(a,this.serviceSublayers);d.layers=[];a.forEach(function(a){var c=b.get(a.id),c=u({writeAsDynamic:f,writeOverridesOnly:e,serviceSublayer:c},g);a=a.write({},c);(!e||e&&1<Object.keys(a).length)&&d.layers.push(a)});a=a.filter(function(a){return a.visible}).map(function(a){return a.id});"tile"!==this.type&&(d.visibleLayers=a)}};b.prototype.findSublayerById=function(a){return this.allSublayers.find(function(d){return d.id===
a})};b.prototype.createServiceSublayers=function(){return this.serviceSublayers.map(function(a){return a.clone()})};b.prototype._updateSublayersForOrigin=function(a,d){var c=this.__accessor__.store;if(c.has("sublayers",a)){var g=c.get("sublayers",a).flatten(function(a){return a.sublayers});if(g.every(function(a){return!a.__accessor__.store._values.hasOwnProperty("minScale")})){var b=g.reduce(function(a,g){a.set(g.id,g);return a},new Map);d=d.map(function(a){return q(a.clone(),b)});c.set("sublayers",
new (l.ofType(k))(d),a)}}};b.prototype._handleSublayersChange=function(a,b){var c=this;b&&(b.forEach(function(a){a.parent=null;a.layer=null}),this._sublayersHandles.forEach(function(a){return a.remove()}),this._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c}),this._sublayersHandles=[a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})],"tile"===this.type&&this._sublayersHandles.push(a.on("before-changes",
function(a){A.error(new x("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{layer:c}));a.preventDefault()})))};h([e.property({readOnly:!0})],b.prototype,"allSublayers",void 0);h([e.property({readOnly:!0,type:l.ofType(k)})],b.prototype,"serviceSublayers",void 0);h([e.reader("service","serviceSublayers",["layers"])],b.prototype,"readServiceSublayers",null);h([e.property({value:null,type:l.ofType(k),json:{type:[Number],write:{target:"subLayerIds",
allowNull:!0}}})],b.prototype,"sublayers",void 0);h([e.reader(["web-map","web-scene","portal-item"],"sublayers",["layers","visibleLayers"])],b.prototype,"readSublayersFromItemOrWebMap",null);h([e.reader("service","sublayers",["layers"])],b.prototype,"readSublayers",null);h([e.writer("sublayers",{layers:{type:[k]},visibleLayers:{type:[z.Integer]}})],b.prototype,"writeSublayers",null);return b=h([e.subclass("esri.layers.mixins.SublayersOwner")],b)}(e.declared(f))}});