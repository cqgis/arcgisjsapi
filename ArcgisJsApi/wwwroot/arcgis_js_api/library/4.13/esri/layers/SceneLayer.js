// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../PopupTemplate ../renderers ../request ../core/asyncUtils ../core/Error ../core/Logger ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/urlUtils ../core/watchUtils ../core/accessorSupport/decorators ../core/accessorSupport/PropertyOrigin ../core/accessorSupport/utils ./FeatureLayer ./Layer ./mixins/ArcGISService ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/ScaleRangeLayer ./mixins/SceneService ./support/commonProperties ./support/commonProperties ./support/FeatureReduction ./support/FeatureReductionSelection ./support/fieldProperties ./support/FieldsIndex ./support/fieldUtils ./support/I3SLayerDefinitions ./support/LabelClass ./support/labelingInfo ./support/RangeInfo ../portal/PortalItem ../renderers/support/jsonUtils ../renderers/support/styleUtils ../support/popupUtils ../tasks/support/Query".split(" "),
function(u,la,z,I,e,n,g,J,K,x,r,h,L,M,N,p,O,P,c,l,Q,A,R,S,T,U,V,W,m,X,Y,Z,aa,ba,B,q,ca,C,da,ea,fa,ga,ha,ia){function D(c,b,a){c&&((c=fa.read(c,b,a)||void 0)||k.error("Failed to create renderer",{rendererDefinition:c,layer:this,context:a}));return c}var ja=["3DObject","Point"],k=L.getLogger("esri.layers.SceneLayer"),F=aa.defineFieldProperties(),G={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",points:"points","features-points":"points",lines:"lines",
"features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},ka={"mesh-pyramids":"mesh",points:"point",lines:"polyline",polygons:"polygon"};return function(E){function b(a,d){a=E.call(this)||this;a.featureReduction=null;a.rangeInfos=null;a.operationalLayerType="ArcGISSceneServiceLayer";a.type="scene";a.fields=null;a.outFields=null;a.nodePages=null;a.materialDefinitions=null;a.textureSetDefinitions=null;a.geometryDefinitions=null;a.serviceUpdateTimeStamp=null;a.definitionExpression=
null;a.path=null;a.labelsVisible=!0;a.labelingInfo=null;a.legendEnabled=!0;a.cachedDrawingInfo={color:!1};a.popupEnabled=!0;a.popupTemplate=null;a.objectIdField=null;a.objectIdFilter=null;a._fieldUsageInfo={};a.screenSizePerspectiveEnabled=!0;return a}I(b,E);b.prototype.normalizeCtorArgs=function(a,d){return"string"===typeof a?z({url:a},d):a};b.prototype.getField=function(a){return this.fieldsIndex.get(a)};b.prototype.getFieldDomain=function(a){return(a=this.getField(a))&&a.domain?a.domain:null};
Object.defineProperty(b.prototype,"fieldsIndex",{get:function(){return new ba(this.fields)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"elevationInfo",{set:function(a){this._set("elevationInfo",a);this.loaded&&this._validateElevationInfo()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"geometryType",{get:function(){return ka[this.profile]||"mesh"},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderer",{set:function(a){B.fixRendererFields(a,
this.fields);this._set("renderer",a)},enumerable:!0,configurable:!0});b.prototype.readCachedDrawingInfo=function(a,d){if(null==a||"object"!==typeof a)a={};null==a.color&&(a.color=!1);return a};Object.defineProperty(b.prototype,"defaultPopupTemplate",{get:function(){return this.associatedLayer||this.attributeStorageInfo?this.createPopupTemplate():null},enumerable:!0,configurable:!0});b.prototype.readObjectIdField=function(a,d){!a&&d.fields&&d.fields.some(function(d){"esriFieldTypeOID"===d.type&&(a=
d.name);return!!a});return a||void 0};b.prototype.readProfile=function(a,d){a=d.store.profile;if(null!=a&&G[a])return G[a];k.error("Unknown or missing profile",{profile:a,layer:this});return"mesh-pyramids"};b.prototype.load=function(a){var d=this,b=M.isSome(a)?a.signal:null;a=r.safeCast(this.loadFromPortal({supportedTypes:["Scene Service"]},a)).then(function(){return r.safeCast(d._fetchService(b))},function(){return r.safeCast(d._fetchService(b))}).then(function(){return p.all([d._verifyRootNodeAndUpdateExtent(d.nodePages,
b),d._setAssociatedFeatureLayer(b)])}).then(function(){return d._validateElevationInfo()}).then(function(){return d._applyAssociatedLayerOverrides()}).then(function(){return d._populateFieldUsageInfo()}).then(function(){return ga.loadStyleRenderer(d,{origin:"service"},b)}).then(function(){return B.fixRendererFields(d.renderer,d.fields)});this.addResolvingPromise(a);return this.when()};b.prototype.importLayerViewModule=function(a){return g(this,void 0,void 0,function(){return n(this,function(d){return"2d"===
a.type?[2,p.reject(new h("scene-layer:view-not-supported","SceneLayer is only supported in 3D"))]:null==this.profile||"mesh-pyramids"===this.profile?[2,p.create(function(a){return u(["../views/3d/layers/SceneLayerView3D"],a)})]:[2,p.create(function(a){return u(["../views/3d/layers/SceneLayerGraphicsView3D"],a)})]})})};b.prototype.createQuery=function(){var a=new ia;"mesh"!==this.geometryType&&(a.returnGeometry=!0,a.returnZ=!0);a.where=this.definitionExpression||"1\x3d1";a.sqlFormat="standard";return a};
b.prototype.queryExtent=function(a,d){var b=this;return this._getAssociatedLayerForQuery().then(function(f){return f.queryExtent(a||b.createQuery(),d)})};b.prototype.queryFeatureCount=function(a,d){var b=this;return this._getAssociatedLayerForQuery().then(function(f){return f.queryFeatureCount(a||b.createQuery(),d)})};b.prototype.queryFeatures=function(a,d){var b=this;return this._getAssociatedLayerForQuery().then(function(f){return f.queryFeatures(a||b.createQuery(),d)}).then(function(a){if(a&&a.features)for(var d=
0,f=a.features;d<f.length;d++){var c=f[d];c.layer=b;c.sourceLayer=b}return a})};b.prototype.queryObjectIds=function(a,d){var b=this;return this._getAssociatedLayerForQuery().then(function(f){return f.queryObjectIds(a||b.createQuery(),d)})};b.prototype.getFieldUsageInfo=function(a){var d={supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1};return this.loaded?this._fieldUsageInfo[a]||d:(k.error("#getFieldUsageInfo()","Unavailable until layer is loaded"),d)};b.prototype.createPopupTemplate=
function(a){return ha.createPopupTemplate(this,a)};b.prototype._getAssociatedLayerForQuery=function(){var a=this;if(!this.loaded)return this.load().then(function(){return a._getAssociatedLayerForQuery()});var d=this.associatedLayer;return null!=d?p.resolve(d):p.reject(new h("scenelayer:query-not-available","SceneLayer queries are not available without associated feature layer"))};b.prototype.hasCachedStatistics=function(a){return null!=this.statisticsInfo&&this.statisticsInfo.some(function(d){return d.name===
a})};b.prototype.queryCachedStatistics=function(a,d){return g(this,void 0,void 0,function(){var b,c,e,y,H;return n(this,function(f){switch(f.label){case 0:return[4,this.load(d)];case 1:f.sent();if(!this.statisticsInfo)throw new h("scenelayer:no-cached-statistics","Cached statistics are not available for this layer");b=this.fieldsIndex.get(a);if(!b)throw new h("scenelayer:field-unexisting","Field '"+a+"' does not exist on the layer");c=0;for(e=this.statisticsInfo;c<e.length;c++)if(y=e[c],y.name===
b.name)return H=O.join(this.parsedUrl.path,y.href),[2,x(H,{query:{f:"json"},responseType:"json",signal:d?d.signal:null}).then(function(a){return a.data})];throw new h("scenelayer:no-cached-statistics","Cached statistics for this attribute are not available");}})})};b.prototype._validateLayer=function(a){if(a.layerType&&-1===ja.indexOf(a.layerType))throw new h("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",{layerType:a.layerType});if(isNaN(this.version.major)||
isNaN(this.version.minor))throw new h("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});if(1<this.version.major)throw new h("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});a=this.normalReferenceFrame;var b=this.spatialReference,f=!1,c=!1;if(null==a)c=f=!0;else switch(b=b&&b.isGeographic,a){case "east-north-up":case "earth-centered":f=
!0;c=b;break;case "vertex-reference-frame":f=!0;c=!b;break;default:f=!1}if(!f)throw new h("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!c)throw new h("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.");};b.prototype._populateFieldUsageInfo=function(){this._fieldUsageInfo={};if(this.fields)for(var a=function(a){var d=!(!b.attributeStorageInfo||!b.attributeStorageInfo.some(function(b){return b.name===
a.name})),c=!!(b.associatedLayer&&b.associatedLayer.fields&&b.associatedLayer.fields.some(function(b){return b&&a.name===b.name}));b._fieldUsageInfo[a.name]={supportsLabelingInfo:d,supportsRenderer:d,supportsPopupTemplate:d||c,supportsLayerQuery:c}},b=this,c=0,e=this.fields;c<e.length;c++)a(e[c])};b.prototype._applyAssociatedLayerOverrides=function(){if(this.associatedLayer){if(this.associatedLayer.fields){for(var a=null,b=0,c=this.associatedLayer.fields;b<c.length;b++){var e=c[b];this.getField(e.name)||
(a||(a=this.fields?this.fields.slice():[]),a.push(e.clone()))}a&&this._set("fields",a)}a=["popupTemplate","popupEnabled"];b=Q.getProperties(this);for(c=0;c<a.length;c++)e=a[c],this._buddyIsMoreImportant(e)&&(b.setDefaultOrigin(this.associatedLayer.originOf(e)),b.set(e,this.associatedLayer[e]),b.setDefaultOrigin("user"))}};b.prototype._setAssociatedFeatureLayer=function(a){return g(this,void 0,void 0,function(){var b;return n(this,function(d){switch(d.label){case 0:return[4,this._fetchAssociatedFeatureLayer(a)];
case 1:return this.associatedLayer=b=d.sent(),[2]}})})};b.prototype._fetchAssociatedFeatureLayer=function(a){return g(this,void 0,void 0,function(){var b;return n(this,function(d){switch(d.label){case 0:if(-1===["mesh-pyramids","points"].indexOf(this.profile))return[2,null];d.label=1;case 1:return d.trys.push([1,4,,5]),[4,this.portalItem&&this.portalItem.isResolved()?this._fetchAssociatedFeatureLayerFromRelatedItems(this.portalItem,a):this._fetchAssociatedFeatureLayerFromUrl(a)];case 2:return b=d.sent(),
[4,b.load({signal:a})];case 3:return[2,d.sent()];case 4:return d.sent(),this._logWarningOnPopupEnabled(),[2,null];case 5:return[2]}})})};b.prototype._logWarningOnPopupEnabled=function(){var a=this;P.whenValidOnce(this,["popupTemplate","popupEnabled"],function(){return a.popupEnabled&&null!=a.popupTemplate}).then(function(){return function(){var b="this SceneLayer: "+a.title;null==a.attributeStorageInfo?k.warn("Associated FeatureLayer could not be loaded and no binary attributes found. Popups will not work on "+
b):k.info("Associated FeatureLayer could not be loaded. Falling back to binary attributes for Popups on "+b)}})};b.prototype._fetchAssociatedFeatureLayerFromRelatedItems=function(a,b){return g(this,void 0,void 0,function(){var d,c;return n(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),[4,a.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:b})];case 1:return d=e.sent(),(c=d.filter(function(a){return"Feature Service"===a.type})[0])?[4,this._fetchAssociatedFeatureLayerFromPortalItem(new ea({id:c.id,
portal:c.portal}),b)]:[3,3];case 2:return[2,e.sent()];case 3:throw Error();case 4:return e.sent(),[2,this._fetchAssociatedFeatureLayerFromUrl(b)];case 5:return[2]}})})};b.prototype._fetchAssociatedFeatureLayerFromPortalItem=function(a,b){return g(this,void 0,void 0,function(){var c;return n(this,function(d){switch(d.label){case 0:return[4,a.load({signal:b})];case 1:return d.sent(),[4,this._findMatchingAssociatedSublayerUrl(a.url,b)];case 2:return c=d.sent(),[2,new A({url:c,portalItem:a})]}})})};b.prototype._fetchAssociatedFeatureLayerFromUrl=
function(a){return g(this,void 0,void 0,function(){var b;return n(this,function(c){switch(c.label){case 0:return[4,this._findMatchingAssociatedSublayerUrl(null,a)];case 1:return b=c.sent(),[2,new A({url:b})]}})})};b.prototype._findMatchingAssociatedSublayerUrl=function(a,b){void 0===a&&(a=null);return g(this,void 0,void 0,function(){var c,d,e,h,g,k,l,m,q,r,w,t,v,u;return n(this,function(f){switch(f.label){case 0:c=this.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);if(!c)return[2,
p.reject()];null==a&&(a=c[1]+"/FeatureServer");d=a.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1");e={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:b};h=c[1]+"/SceneServer";g=parseInt(c[2],10);k=x(h,e).catch(function(a){return{data:{layers:null}}});l=x(d,e);return[4,p.all([l,k])];case 1:m=f.sent();q=m[0];r=m[1];w=r.data&&r.data.layers;t=q.data&&q.data.layers;if(!Array.isArray(t))throw Error("expected layers array");if(Array.isArray(w))for(v=0;v<Math.min(w.length,t.length);v++){if(u=
w[v],u.id===g)return[2,d+"/"+t[v].id]}else if(g<t.length)return[2,d+"/"+t[g].id];throw Error("could not find matching associated sublayer");}})})};b.prototype._buddyIsMoreImportant=function(a){if(!this.associatedLayer)return!1;var b=l.nameToId(this.originOf(a));a=l.nameToId(this.associatedLayer.originOf(a));return null!=a&&a<=l.OriginId.SERVICE?null==b||b<l.OriginId.SERVICE:null!=a&&a<=l.OriginId.PORTAL_ITEM?null==b||b<l.OriginId.PORTAL_ITEM:!1};b.prototype._validateElevationInfo=function(){var a=
this.elevationInfo;a&&("mesh-pyramids"===this.profile&&"absolute-height"!==a.mode&&k.warn(".elevationInfo\x3d","Mesh scene layers only support absolute-height elevation mode"),a.featureExpressionInfo&&"0"!==a.featureExpressionInfo.expression&&k.warn(".elevationInfo\x3d","Scene layers do not support featureExpressionInfo"))};e([c.property({types:{key:"type",base:Y.default,typeMap:{selection:Z.default}},json:{origins:{"web-scene":{read:{source:"layerDefinition.featureReduction"},write:{target:"layerDefinition.featureReduction"}}}}})],
b.prototype,"featureReduction",void 0);e([c.property({type:[da.default],json:{read:!1,origins:{"web-scene":{read:{source:"layerDefinition.rangeInfos"},write:{target:"layerDefinition.rangeInfos"}}}}})],b.prototype,"rangeInfos",void 0);e([c.property({json:{read:!1}})],b.prototype,"associatedLayer",void 0);e([c.property({type:["show","hide"]})],b.prototype,"listMode",void 0);e([c.property({type:["ArcGISSceneServiceLayer"]})],b.prototype,"operationalLayerType",void 0);e([c.property({json:{read:!1},readOnly:!0})],
b.prototype,"type",void 0);e([c.property(z({},F.fields,{readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}}))],b.prototype,"fields",void 0);e([c.property({readOnly:!0,dependsOn:["fields"]})],b.prototype,"fieldsIndex",null);e([c.property(F.outFields)],b.prototype,"outFields",void 0);e([c.property({type:q.I3SNodePageDefinition,readOnly:!0})],b.prototype,"nodePages",void 0);e([c.property({type:[q.I3SMaterialDefinition],readOnly:!0})],b.prototype,"materialDefinitions",void 0);e([c.property({type:[q.I3STextureSetDefinition],
readOnly:!0})],b.prototype,"textureSetDefinitions",void 0);e([c.property({type:[q.I3SGeometryDefinition],readOnly:!0})],b.prototype,"geometryDefinitions",void 0);e([c.property({readOnly:!0})],b.prototype,"serviceUpdateTimeStamp",void 0);e([c.property({readOnly:!0})],b.prototype,"attributeStorageInfo",void 0);e([c.property({readOnly:!0})],b.prototype,"statisticsInfo",void 0);e([c.property({type:String,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],
b.prototype,"definitionExpression",void 0);e([c.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],b.prototype,"path",void 0);e([c.property(m.elevationInfo)],b.prototype,"elevationInfo",null);e([c.property({type:String,dependsOn:["profile"]})],b.prototype,"geometryType",null);e([c.property(m.labelsVisible)],b.prototype,"labelsVisible",void 0);e([c.property({type:[ca],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:C.reader},write:{target:"drawingInfo.labelingInfo",
enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:C.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],b.prototype,"labelingInfo",void 0);e([c.property(m.legendEnabled)],b.prototype,"legendEnabled",void 0);e([c.property(m.opacityDrawingInfo)],b.prototype,"opacity",void 0);e([c.property({types:K.webSceneRendererTypes,json:{origins:{service:{read:{source:"drawingInfo.renderer",reader:D}}},read:{source:"layerDefinition.drawingInfo.renderer",reader:D},write:{target:"layerDefinition.drawingInfo.renderer"}},
value:null})],b.prototype,"renderer",null);e([c.property({json:{read:!1}})],b.prototype,"cachedDrawingInfo",void 0);e([c.reader("service","cachedDrawingInfo")],b.prototype,"readCachedDrawingInfo",null);e([c.property(m.popupEnabled)],b.prototype,"popupEnabled",void 0);e([c.property({type:J,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],b.prototype,"popupTemplate",void 0);e([c.property({readOnly:!0,json:{read:!1},dependsOn:["fields","title","attributeStorageInfo","associatedLayer"]})],
b.prototype,"defaultPopupTemplate",null);e([c.property({type:String,json:{read:!1}})],b.prototype,"objectIdField",void 0);e([c.reader("service","objectIdField",["objectIdField","fields"])],b.prototype,"readObjectIdField",null);e([c.property({json:{read:!1}})],b.prototype,"objectIdFilter",void 0);e([c.property({type:String,json:{read:!1}})],b.prototype,"profile",void 0);e([c.reader("service","profile",["store.profile"])],b.prototype,"readProfile",null);e([c.property({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},
read:!1}})],b.prototype,"normalReferenceFrame",void 0);e([c.property(X.screenSizePerspectiveEnabled)],b.prototype,"screenSizePerspectiveEnabled",void 0);return b=e([c.subclass("esri.layers.SceneLayer")],b)}(c.declared(V.ScaleRangeLayer(W.SceneService(S.ArcGISService(T.OperationalLayer(U.PortalLayer(N.MultiOriginJSONMixin(R))))))))});