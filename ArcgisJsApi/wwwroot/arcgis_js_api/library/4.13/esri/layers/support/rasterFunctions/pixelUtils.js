// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define(["require","exports","../PixelBlock"],function(G,H,C){function D(a,d){a=Math.min(Math.max(a,-100),100);d=Math.min(Math.max(d,-100),100);var e,l,c=new Uint8Array(256);for(e=0;256>e;e++)0<a&&100>a?l=(200*e-25500+510*d)/(2*(100-a))+128:0>=a&&-100<a?l=(200*e-25500+510*d)*(100+a)/2E4+128:100===a?(l=200*e-25500+256*(100-a)+510*d,l=0<l?255:0):-100===a&&(l=128),c[e]=255<l?255:0>l?0:l;return c}function E(a,d,e,l,c,p,f,g){return{xmin:c<=e*a?0:c<e*a+a?c-e*a:a,ymin:p<=l*d?0:p<l*d+d?p-l*d:d,xmax:c+f<=e*
a?0:c+f<e*a+a?c+f-e*a:a,ymax:p+g<=l*d?0:p+g<l*d+d?p+g-l*d:d}}var A=function(a){return a&&"esri.layers.support.PixelBlock"===a.declaredClass&&a.pixels&&0<a.pixels.length},F={createColormapLUT:function(a){if(a){var d=a.colormap;if(d&&0!==d.length){var d=d.sort(function(a,b){return a[0]-b[0]}),e=0;0>d[0][0]&&(e=d[0][0]);var l=Math.max(256,d[d.length-1][0]-e+1),c=new Uint8Array(4*l),p=[],f=0,g=0,h=5===d[0].length;if(65536<l)return d.forEach(function(a){p[a[0]-e]=h?a.slice(1):a.slice(1).concat([255])}),
{indexed2DColormap:p,offset:e,alphaSpecified:h};if(a.fillUnspecified)for(a=d[g],f=a[0]-e;f<l;f++)c[4*f]=a[1],c[4*f+1]=a[2],c[4*f+2]=a[3],c[4*f+3]=h?a[4]:255,f===a[0]-e&&(a=g===d.length-1?a:d[++g]);else for(f=0;f<d.length;f++)a=d[f],g=4*(a[0]-e),c[g]=a[1],c[g+1]=a[2],c[g+2]=a[3],c[g+3]=h?a[4]:255;return{indexedColormap:c,offset:e,alphaSpecified:h}}}},createContrastBrightnessLUT:D,createStretchLUT:function(a){var d=a.minCutOff,e=a.maxCutOff,l=a.gamma,c=a.pixelType,p=a.outMin||0,f=a.outMax||255;if(-1===
["u8","u16","s8","s16"].indexOf(c))return null;var g=d.length,h,k=0;"s8"===c?k=-127:"s16"===c&&(k=-32767);var b=256;-1<["u16","s16"].indexOf(c)&&(b=65536);for(var m=[],n=f-p,c=0;c<g;c++)m[c]=e[c]-d[c];h=l&&l.length>=g;var q=[];if(h)for(c=0;c<g;c++)q[c]=1<l[c]?2<l[c]?6.5+Math.pow(l[c]-2,2.5):6.5+100*Math.pow(2-l[c],4):1;var r,t=[],w,u,v;if(h)for(c=0;c<g;c++){v=[];for(h=0;h<b;h++)w=h+k,r=(w-d[c])/m[c],u=1,1<l[c]&&(u-=Math.pow(1/n,r*q[c])),v[h]=w<e[c]&&w>d[c]?Math.floor(u*n*Math.pow(r,1/l[c]))+p:w>=
e[c]?f:p;t[c]=v}else for(c=0;c<g;c++){v=[];for(h=0;h<b;h++)w=h+k,v[h]=w<=d[c]?p:w>=e[c]?f:Math.floor((w-d[c])/m[c]*n)+p;t[c]=v}if(null!=a.contrastOffset)for(a=D(a.contrastOffset,a.brightnessOffset),c=0;c<g;c++)for(v=t[c],h=0;h<b;h++)v[h]=a[v[h]];return{lut:t,offset:k}},colorize:function(a,d){if(!A(a)||!d&&(d.indexedColormap||d.indexed2DColormap))return a;var e=a.clone(),l=e.pixels,c=e.mask,p=e.width*e.height;if(1!==l.length)return a;var f=d.indexedColormap;a=d.indexed2DColormap;var g=d.offset;d=d.alphaSpecified;
var h=f.length-1,k=0,l=l[0],b=new Uint8Array(l.length),m=new Uint8Array(l.length),n=new Uint8Array(l.length),q=0;if(f)if(c)for(k=0;k<p;k++)c[k]&&(q=4*(l[k]-g),q<g||q>h?c[k]=0:(b[k]=f[q],m[k]=f[q+1],n[k]=f[q+2],c[k]=f[q+3]));else{c=new Uint8Array(p);for(k=0;k<p;k++)q=4*(l[k]-g),q<g||q>h?c[k]=0:(b[k]=f[q],m[k]=f[q+1],n[k]=f[q+2],c[k]=f[q+3]);e.mask=c}else if(c)for(k=0;k<p;k++)c[k]&&(f=a[l[k]],b[k]=f[0],m[k]=f[1],n[k]=f[2],c[k]=f[3]);else{c=new Uint8Array(p);for(k=0;k<p;k++)f=a[l[k]],b[k]=f[0],m[k]=
f[1],n[k]=f[2],c[k]=f[3];e.mask=c}e.pixels=[b,m,n];e.statistics=null;e.pixelType="u8";e.maskIsAlpha=d;return e},estimateStatisticsHistograms:function(a){if(!A(a))return null;var d=a.pixels,e=a.mask,l=a.pixelType,c=a.statistics;a=a.width*a.height;var p=d.length,f,g,h,k,b,m=[],n=[],q,r,t;for(k=0;k<p;k++){q=new Uint32Array(256);t=d[k];if("u8"===l)if(f=-.5,g=255.5,e)for(b=0;b<a;b++)e[b]&&q[t[b]]++;else for(b=0;b<a;b++)q[t[b]]++;else{f=c[k].minValue;g=c[k].maxValue;h=(g-f)/256;r=new Uint32Array(257);if(e)for(b=
0;b<a;b++)e[b]&&r[Math.floor((t[b]-f)/h)]++;else for(b=0;b<a;b++)r[Math.floor((t[b]-f)/h)]++;for(b=0;255>b;b++)q[b]=r[b];q[255]=r[255]+r[256]}m.push({min:f,max:g,size:256,counts:q});for(b=t=r=h=0;256>b;b++)h+=q[b],r+=b*q[b];r/=h;for(b=0;256>b;b++)t+=q[b]*Math.pow(b-r,2);q=Math.sqrt(t/(h-1));h=(g-f)/256;b=(r+.5)*h+f;q*=h;n.push({min:f,max:g,avg:b,stddev:q})}return{statistics:n,histograms:m}},extractBands:function(a,d){return!d||!A(a)||d&&d.some(function(d){return d>a.pixels.length})?a:new C({pixelType:a.pixelType,
width:a.width,height:a.height,mask:a.mask,validPixelCount:a.validPixelCount,maskIsAlpha:a.maskIsAlpha,pixels:d.map(function(d){return a.pixels[d]}),statistics:a.statistics&&d.map(function(d){return a.statistics[d]})})},stretch:function(a,d){if(!A(a))return null;a=a.clone();var e=a.pixels,l=a.mask,c=d.minCutOff,p=d.maxCutOff,f=d.gamma,g=d.outMin||0;d=d.outMax||255;var h=a.width*a.height,k=e.length,b,m,n,q,r,t=d-g,w=[];for(b=0;b<k;b++)w[b]=p[b]-c[b];m=f&&f.length>=k;var u=[];if(m)for(b=0;b<k;b++)u[b]=
1<f[b]?2<f[b]?6.5+Math.pow(f[b]-2,2.5):6.5+100*Math.pow(2-f[b],4):1;if(m)if(null!=l)for(m=0;m<h;m++){if(l[m])for(b=0;b<k;b++)n=e[b][m],r=(n-c[b])/w[b],q=1,1<f[b]&&(q-=Math.pow(1/t,r*u[b])),e[b][m]=n<p[b]&&n>c[b]?Math.floor(q*t*Math.pow(r,1/f[b]))+g:n>=p[b]?d:g}else for(m=0;m<h;m++)for(b=0;b<k;b++)n=e[b][m],r=(n-c[b])/w[b],q=1,1<f[b]&&(q-=Math.pow(1/t,r*u[b])),e[b][m]=n<p[b]&&n>c[b]?Math.floor(q*t*Math.pow(r,1/f[b]))+g:n>=p[b]?d:g;else if(null!=l)for(m=0;m<h;m++){if(l[m])for(b=0;b<k;b++)n=e[b][m],
e[b][m]=n<p[b]&&n>c[b]?Math.floor((n-c[b])/w[b]*t)+g:n>=p[b]?d:g}else for(m=0;m<h;m++)for(b=0;b<k;b++)n=e[b][m],e[b][m]=n<p[b]&&n>c[b]?Math.floor((n-c[b])/w[b]*t)+g:n>=p[b]?d:g;a.pixelType="u8";a.updateStatistics();return a},lookupPixels:function(a,d){if(!A(a))return null;var e=a.pixels,l=a.mask,c=a.width*a.height,p=e.length,f=d.lut;d=d.offset;var g,h;f&&1===f[0].length&&(f=e.map(function(a){return f}));var k=[],b,m,n;if(d)if(null==l)for(g=0;g<p;g++){b=e[g];m=f[g];n=new Uint8Array(c);for(h=0;h<c;h++)n[h]=
m[b[h]-d];k.push(n)}else for(g=0;g<p;g++){b=e[g];m=f[g];n=new Uint8Array(c);for(h=0;h<c;h++)l[h]&&(n[h]=m[b[h]-d]);k.push(n)}else if(null==l)for(g=0;g<p;g++){b=e[g];m=f[g];n=new Uint8Array(c);for(h=0;h<c;h++)n[h]=m[b[h]];k.push(n)}else for(g=0;g<p;g++){b=e[g];m=f[g];n=new Uint8Array(c);for(h=0;h<c;h++)l[h]&&(n[h]=m[b[h]]);k.push(n)}a=new C({width:a.width,height:a.height,pixels:k,mask:l,pixelType:"u8"});a.updateStatistics();return a},remapColor:function(a,d){if(!A(a))return null;a=a.clone();var e=
a.width*a.height,l=d.length,c=Math.floor(l/2),p=d[Math.floor(c)],f=a.pixels[0],g,h,k,b,m,n,q=!1,r=new Uint8Array(e),t=new Uint8Array(e),w=new Uint8Array(e),u=a.mask,v=4===d[0].mappedColor.length;u||(u=new Uint8Array(e),u.fill(v?255:1),a.mask=u);for(m=0;m<e;m++)if(u[m]){g=f[m];q=!1;n=c;h=p;k=0;for(b=l-1;1<b-k;){if(g===h.value){q=!0;break}g>h.value?k=n:b=n;n=Math.floor((k+b)/2);h=d[Math.floor(n)]}q||(g===d[k].value?(h=d[k],q=!0):g===d[b].value?(h=d[b],q=!0):g<d[k].value?(q=!1,h=null):g>d[k].value&&
(g<d[b].value?(h=d[k],q=!0):b===l-1?(q=!1,h=null):(h=d[b],q=!0)));q?(r[m]=h.mappedColor[0],t[m]=h.mappedColor[1],w[m]=h.mappedColor[2],u[m]=h.mappedColor[3]):r[m]=t[m]=w[m]=u[m]=0}a.pixels=[r,t,w];a.mask=u;a.pixelType="u8";a.maskIsAlpha=v;return a},mosaic:function(a,d,e,l){var c=a.filter(function(a){return A(a)})[0];if(null==c)return null;var p=l?l.width:d.width;l=l?l.height:d.height;var f=c.width,g=c.height,h=d.width/f;d=d.height/g;var k=e?e.x:0;e=e?e.y:0;var b=c.getPixelArrayConstructor(c.pixelType),
m=c.pixels.length,c=[],n,q,r,t,w,u,v,x,y,z;for(w=0;w<m;w++){q=new b(p*l);for(u=0;u<d;u++)for(v=0;v<h;v++)if(r=a[u*h+v])for(n=r.pixels[w],z=E(f,g,v,u,k,e,p,l),x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*p+(v*f-k),t=x*f,y=z.xmin;y<z.xmax;y++)q[r+y]=n[t+y];c.push(q)}var B;if(a.some(function(a){return a&&a.mask&&0<a.mask.length}))for(B=new Uint8Array(p*l),u=0;u<d;u++)for(v=0;v<h;v++)if(b=(r=a[u*h+v])?r.mask:null,z=E(f,g,v,u,k,e,p,l),b)for(x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*p+(v*f-k),t=x*f,y=z.xmin;y<z.xmax;y++)B[r+
y]=b[t+y];else if(r)for(x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*p+(v*f-k),t=x*f,y=z.xmin;y<z.xmax;y++)B[r+y]=1;else for(x=z.ymin;x<z.ymax;x++)for(r=(u*g+x-e)*p+(v*f-k),t=x*f,y=z.xmin;y<z.xmax;y++)B[r+y]=0;a=new C({width:p,height:l,pixels:c,mask:B});a.updateStatistics();return a},mosaicPixelData:function(a,d){if(!a||0===a.length)return null;var e=a.filter(function(a){return a.pixelBlock})[0];if(!e)return null;var l=(e.extent.xmax-e.extent.xmin)/e.pixelBlock.width,c=(e.extent.ymax-e.extent.ymin)/e.pixelBlock.height,
p=.01*Math.min(l,c),f=a.sort(function(a,b){return Math.abs(a.extent.ymax-b.extent.ymax)>p?b.extent.ymax-a.extent.ymax:Math.abs(a.extent.xmin-b.extent.xmin)>p?a.extent.xmin-b.extent.xmin:0}),g=Math.min.apply(null,f.map(function(a){return a.extent.xmin})),h=Math.min.apply(null,f.map(function(a){return a.extent.ymin})),k=Math.max.apply(null,f.map(function(a){return a.extent.xmax})),b=Math.max.apply(null,f.map(function(a){return a.extent.ymax}));a={x:Math.round((d.xmin-g)/l),y:Math.round((b-d.ymax)/c)};
g={width:Math.round((k-g)/l),height:Math.round((b-h)/c)};l={width:Math.round((d.xmax-d.xmin)/l),height:Math.round((d.ymax-d.ymin)/c)};if(Math.round(g.width/e.pixelBlock.width)*Math.round(g.height/e.pixelBlock.height)!==f.length||0>a.x||0>a.y||g.width<l.width||g.height<l.height)return null;e=f.map(function(a){return a.pixelBlock});e=F.mosaic(e,g,a,l);return{extent:d,pixelBlock:e}}};return F});