// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../geometry ../../Graphic ../../symbols ../../core/Collection ../../core/compilerUtils ../../core/Error ../../core/Evented ../../core/Handles ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/support/coordsUtils ../../layers/GraphicsLayer ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../views/3d/interactive/editingTools/graphicReshape3D/isSupportedGraphic ../../views/3d/interactive/editingTools/graphicTransform3D/isSupportedGraphic ../../views/draw/Draw ../../views/draw/support/createUtils ./support/OperationHandle".split(" "),
function(F,ea,v,T,r,w,x,C,t,D,U,V,W,X,M,Y,z,G,E,J,p,P,Z,N,O,H,Q,aa,ba,n,I){function K(p,d){var a=p.history.undo.pop().updates,b=[];d.forEach(function(c,e){e=a[e];var y={};null!=e&&(z.isSome(e.geometry)&&(y.geometry=c.geometry,c.geometry=e.geometry),z.isSome(e.symbol)&&(y.symbol=c.symbol,c.symbol=e.symbol),b.push(y))});p.history.redo.push({updates:b})}function L(p,d){var a=p.history.redo.pop().updates,b=[];d.forEach(function(c,e){e=a[e];var y={};null!=e&&(z.isSome(e.geometry)&&(y.geometry=c.geometry,
c.geometry=e.geometry),z.isSome(e.symbol)&&(y.symbol=c.symbol,c.symbol=e.symbol),b.push(y))});p.history.undo.push({updates:b})}function A(p){return{updates:p.map(function(d){return{geometry:d.geometry}})}}function S(p){return{updates:p.map(function(d){return{symbol:d.symbol}})}}function B(p){p.canUndo()?p.complete():p.cancel()}var ca=Y.getLogger("esri.widgets.Sketch.SketchViewModel"),da=["Backspace","Delete"];return function(R){function d(a){a=R.call(this,a)||this;a._activeFillGraphic=null;a._activeLineGraphic=
null;a._centerIndicatorGraphic=null;a._centerSymbol=new H({style:"cross",size:6,color:[255,255,255]});a._defaultSegmentOffset=48;a._handles=new M;a._internalGraphicsLayer=new Z({listMode:"hide"});a._lineGraphic=null;a._operationHandle=null;a._vertexGraphics=[];a._viewHandles=new M;a._highlightHandlesByGraphic=new M;a._doUnnormalization=!1;a.activeFillSymbol=new N({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}});a.activeLineSymbol=new O({color:[12,207,255,1],width:2,style:"dash"});
a.activePointSymbol=new H({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}});a.activeVertexSymbol=new H({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}});a.createGraphic=null;a.defaultUpdateOptions={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform"};a.layer=null;a.pointSymbol=new H({style:"circle",size:6,color:[255,255,255],
outline:{color:[50,50,50],width:1}});a.polygonSymbol=new N({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}});a.polylineSymbol=new O({color:[130,130,130,1],width:2});a.updateGraphics=new U;a.updateOnGraphicClick=!0;a.updatePointSymbol=new H({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}});a.updatePolygonSymbol=new N({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}});a.updatePolylineSymbol=new O({color:[12,207,255],width:2});a.vertexSymbol=new H({style:"circle",
size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}});return a}T(d,R);d.prototype.initialize=function(){var a=this;this._handles.add([J.watch(this,"layer",function(){return a.cancel()}),J.on(this,"view.map.layers","change",function(b){0<=b.removed.indexOf(a.layer)&&a.cancel()}),J.on(this,"layer.graphics","change",function(b){if(z.isSome(a._operationHandle)){var c=0;for(b=b.removed;c<b.length;c++){var e=b[c];a.updateGraphics.includes(e)&&(1<a.updateGraphics.length?a._operationHandle.removeFromSelection(e):
B(a._operationHandle))}}})].concat(this._generateSceneViewHighlightHandles()))};d.prototype.destroy=function(){this.cancel();this._handles.removeAll();this._handles=null;this._viewHandles.removeAll();this._viewHandles=null;this._highlightHandlesByGraphic.removeAll();this._highlightHandlesByGraphic=null;this._removeDefaultLayer();this._draw&&this._draw.destroy();this._set("view",null);this.emit("destroy")};Object.defineProperty(d.prototype,"_defaultUpdateTool",{get:function(){return"3d"===this.view.type?
"move":"transform"},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"_draw",{get:function(){return"ready"===this.state||"active"===this.state?new ba({view:this.view}):null},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"activeComponent",{get:function(){return this._operationHandle?
this._operationHandle.activeComponent:null},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"state",{get:function(){var a=!(!this.get("view.ready")||!this.layer),b=this._operationHandle;return a&&b?"active":a?"ready":"disabled"},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"view",{get:function(){return this._get("view")},set:function(a){var b=this,c=this._get("view");if(c){var e=c.map;c.container&&(c.cursor=null);e&&e.remove(this._internalGraphicsLayer);this._viewHandles.removeAll();
this.cancel()}this._doUnnormalization=null!=a&&"3d"===a.type&&"global"===a.viewingMode;this._handles.remove("view-ready");a&&this._handles.add(J.when(a,"ready",function(c){b._viewHandles.removeAll();c&&b._viewHandles.add(b._generateViewHandles(a))},!0),"view-ready");this._set("view",a)},enumerable:!0,configurable:!0});d.prototype.cancel=function(){this._operationHandle&&this._operationHandle.cancel()};d.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()};d.prototype.create=
function(a,b){var c=this;if("disabled"===this.state)this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel.");else if(this.cancel(),a){var e=this._setupCreateOperation(a,b);e&&(this.view.map.add(this._internalGraphicsLayer),b=function(){if(e===c._operationHandle){var b=e.cancelled?"cancel":"complete",g=c.createGraphic;c._operationHandle.destroy();c._operationHandle=
null;c._set("createGraphic",null);c.view&&c.view.map&&c.view.map.remove(c._internalGraphicsLayer);e.cancelled||c.layer.add(g);c._emitCreateEvent({graphic:g,state:b,tool:a,toolEventInfo:null})}},e.on("complete",b),e.on("cancel",b),this._operationHandle=e)}else this._logError("sketch:missing-parameter","Missing parameter 'tool'.")};d.prototype.update=function(a,b){return x(this,void 0,void 0,function(){var c,e,d,g,f,l,h,k=this;return w(this,function(y){switch(y.label){case 0:c=this;e=c.layer;d=c.state;
g=c.view;if("disabled"===d)return e||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),g||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2];this.cancel();f=Array.isArray(a)?a:[a];return f&&f.length?(l=f.some(function(a){return a.layer!==e?(k._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):z.isNone(a.geometry)?(k._logError("sketch:invalid-parameter",
"Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"!==g.type||g.spatialReference.equals(a.geometry.spatialReference)?!1:(k._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0)}))?[2]:[4,this._setupUpdateOperation(f,b)]:(this._logError("sketch:missing-parameter","Missing parameter 'graphics'."),[2]);case 1:h=y.sent();if(!h)return[2];this.view.map.add(this._internalGraphicsLayer);
this._emitUpdateEvent({graphics:f,state:"start",tool:h.tool,toolEventInfo:null});this._setUpdateOperationHandle(h);return[2]}})})};d.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()};d.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()};d.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())};d.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())};d.prototype.toggleUpdateTool=
function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()};d.prototype._hitTest=function(a){return x(this,void 0,void 0,function(){var b;return w(this,function(c){switch(c.label){case 0:return[4,this.view.hitTest(a)];case 1:return b=c.sent(),"2d"===this.view.type?[2,b]:0<b.results.length?[2,{screenPoint:a,results:[b.results[0]]}]:[2,{screenPoint:a,results:[]}]}})})};d.prototype._generateViewHandles=function(a){var b=this;return[a.on("click",function(a){if(!b.view.toolViewManager.handlesClickEvent(a)){var c=
b._operationHandle,d=b.defaultUpdateOptions,g=b.layer,f=b.state,l=b.updateGraphics,h=b.updateOnGraphicClick,c="active"===f&&"create"===c.type;"disabled"!==f&&!c&&h&&b._hitTest(E.createScreenPointFromEvent(a)).then(function(a){a=a.results;a.length?a.some(function(a){if(a.graphic){a=a.graphic;if(-1<l.indexOf(a))return!0;if(a.layer===g)return b.update([a],v({},d)),!0}return!1}):"active"===f&&b.cancel()})}})]};d.prototype._setupCreateOperation=function(a,b){if(a){var c;switch(a){case "point":c=this._setupCreatePointOperation(a,
b);break;case "multipoint":c=this._setupCreateMultipointOperation(a,b);break;case "polygon":case "polyline":c=this._setupCreatePolyOperation(a,b);break;case "rectangle":c=this._setupCreateRectangleOperation(a,b);break;case "circle":c=this._setupCreateCircleOperation(a,b)}return c}};d.prototype._setupCreatePointOperation=function(a,b){var c=this;b=this._draw.create(a,b);var e=[b.on("cursor-update",function(a){z.isSome(a.coordinates)?c._displayCrosshairCursor():c._displayDefaultCursor()}),b.on("draw-complete",
function(a){a=a.coordinates;a=new C.Point(a[0],a[1],c.view.spatialReference);a=new t(a,c.pointSymbol);c._set("createGraphic",a);g&&g.complete()})],d=[this.view.on("key-down",function(a){"Escape"===a.key&&g&&g.cancel()})],g=this._operationHandleForCreateAction(b,e.concat(d),a);return g};d.prototype._setupCreateMultipointOperation=function(a,b){var c=this;b=this._draw.create(a,b);var e=null,d=[],g=this._operationHandleForCreateAction(b,d,a);d.push(b.on("vertex-add",function(b){var f=b.type,h=b.vertices,
k=h[b.vertexIndex];e=b;c._drawMultipointGraphic(h,!0);c._emitCreateEvent({graphic:c.createGraphic,state:1===h.length?"start":"active",tool:a,toolEventInfo:{added:k,type:f}})}),b.on("vertex-remove",function(b){var f=b.type,h=b.vertices,k=h[b.vertexIndex];e=b;c._drawMultipointGraphic(h,!0);c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,toolEventInfo:{removed:k,type:f}})}),b.on("vertex-update",function(b){var f=b.type,h=b.vertices,k=h[b.vertexIndex];e=b;c._drawMultipointGraphic(h,
!0);c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,toolEventInfo:{type:f,updated:k}})}),b.on("cursor-update",function(a){e=a}),b.on("draw-complete",function(a){a=a.vertices.slice(0);(a=n.createMultipoint(a,c.view.spatialReference))?(c.createGraphic&&(c.createGraphic.geometry=a),g&&g.complete()):g&&g.cancel()}),b.on("undo",function(a){a=a.vertices;var b=e&&"cursor-update"!==e.type;c._resetCreateOperationGraphics();a.length&&c._drawMultipointGraphic(a,b)}),b.on("redo",function(a){a=
a.vertices;var b=e&&"cursor-update"!==e.type;c._resetCreateOperationGraphics();a.length&&c._drawMultipointGraphic(a,b)}));d.push(this.view.on("pointer-move",function(a){return c._displayCrosshairCursor()}),this.view.on("key-down",function(a){return c._getCommonUpdateOperationKeyDownHandlers(g,a)}));return g};d.prototype._setupCreatePolyOperation=function(a,b){var c=this,e=null;"polyline"===a?e=this._draw.create(a,b):"polygon"===a&&(e=this._draw.create(a,b));var d=new C.Point,g=null,f=!1;b=[e.on("vertex-add",
function(b){var e=b.type,h=b.vertices,u=h[b.vertexIndex];c._snap(a,h,f);g=b;c._drawVertexGraphics(a,h,{userClicked:!0});c._emitCreateEvent({graphic:c.createGraphic,state:1===h.length?"start":"active",tool:a,toolEventInfo:{added:u,type:e}})}),e.on("vertex-remove",function(b){var e=b.type,h=b.vertices,u=h[b.vertexIndex];c._snap(a,h,f);g=b;c._drawVertexGraphics(a,h,{userClicked:!0});c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,toolEventInfo:{removed:u,type:e}})}),e.on("vertex-update",
function(b){var e=b.type,h=b.vertices,u=h[b.vertexIndex];c._snap(a,h,f);g=b;c._drawVertexGraphics(a,h,{userClicked:!0});c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,toolEventInfo:{type:e,updated:u}})}),e.on("cursor-update",function(b){var e=b.type,h=b.vertices;b.mapPoint&&(c._snap(a,h,f),g=b,d=b.mapPoint,c._drawVertexGraphics(a,h,{userClicked:!1}),1<h.length&&c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,toolEventInfo:{coordinates:h[h.length-1],type:e}}))}),
e.on("draw-complete",function(b){b=b.vertices.slice(0);var e=null;"polyline"===a?e=n.createPolyline([b],c.view.spatialReference,c._doUnnormalization):"polygon"===a&&(e=n.createPolygon([b],c.view.spatialReference,c._doUnnormalization,!0));e?(c.createGraphic.geometry=e,m&&m.complete()):m&&m.cancel()}),e.on("undo",function(b){b=b.vertices;var e=g&&"cursor-update"!==g.type;c._resetCreateOperationGraphics();c._snap(a,b,f);b.length&&c._drawVertexGraphics(a,b,{userClicked:e})}),e.on("redo",function(b){b=
b.vertices;var e=g&&"cursor-update"!==g.type;c._resetCreateOperationGraphics();c._snap(a,b,f);b.length&&c._drawVertexGraphics(a,b,{userClicked:e})})];var l=[this.view.on("pointer-move",function(a){c.view.toMap(E.createScreenPoint(a.x,a.y))?c._displayCrosshairCursor():c._displayDefaultCursor()}),this.view.on("key-down",function(b){var h=e.vertices.slice(0),k=g&&"cursor-update"!==g.type;"Control"!==b.key||f||"2d"!==c.view.type?"z"===b.key&&m&&m.canUndo()?(b.stopPropagation(),m.undo()):"r"===b.key&&
m&&m.canRedo()?(b.stopPropagation(),m.redo()):"Escape"===b.key&&m&&m.cancel():(f=!0,c._snap(a,h,!k),c._drawVertexGraphics(a,h,{userClicked:k}))}),this.view.on("key-up",function(b){var h=e.vertices.slice(0),k=g&&"cursor-update"!==g.type;"Control"===b.key&&f&&(k||(h.pop(),h.push([d.x,d.y]),c._drawVertexGraphics(a,h,{userClicked:k})),f=!1)})];if("polygon"===a){var h=function(a,b,e){if(!a||!a.layer||!a.visible)return!1;a=c.view.toScreen(a.geometry);return c._isWithinScreenDistance(a,b,e)},k=function(a){if(!(2>=
c._vertexGraphics.length))return h(c._vertexGraphics[0],a,c._getVertexIntersectDistance())};l.push(this.view.on("pointer-move",function(a){var b=k(a);c._highlightHandlesByGraphic.forEach(function(a){return b?a.pause():a.resume()})}),this.view.on("pointer-down",function(a){k(a)?(a.stopPropagation(),e.complete()):c._vertexGraphics.some(function(b){return h(b,a,c._getVertexIntersectDistance())})&&a.stopPropagation()}))}var m=this._operationHandleForCreateAction(e,b.concat(l),a);return m};d.prototype._setupCreateCircleOperation=
function(a,b){var c=this,e=this._draw.create(a,b),d=!1,g=!0;b=[e.on("vertex-add",function(b){var e=b.type,h=b.vertices;b=h[b.vertexIndex];c._drawSegmentGraphic(a,h,{centered:g,constrained:d});c._emitCreateEvent({graphic:c.createGraphic,state:1===h.length?"start":"active",tool:a,toolEventInfo:{added:b,type:e}})}),e.on("cursor-update",function(b){var e=b.type;b=b.vertices;c._drawSegmentGraphic(a,b,{centered:g,constrained:d});2===b.length&&c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,
toolEventInfo:{coordinates:b[b.length-1],type:e}})}),e.on("draw-complete",function(a){a=a.vertices.slice(0);var b=null,b=n.createViewAlignedCoordinateSystem(c.view,a[0]);1===a.length?(a.push([a[0][0]+c._defaultSegmentOffset*c.view.resolution,a[0][1]]),b=n.createCircle(a,b,!0)):b=d?n.createEllipse(a,b,g):n.createCircle(a,b,g);c.createGraphic?c.createGraphic.geometry=b:(c._removeCreateGraphic(),c._set("createGraphic",new t(b,c.polygonSymbol)));l&&l.complete()})];var f=[this.view.on("pointer-move",function(a){c.view.toMap(E.createScreenPoint(a.x,
a.y))?c._displayCrosshairCursor():c._displayDefaultCursor()}),this.view.on("key-down",function(b){"Control"!==b.key||d?"Alt"===b.key&&g?(g=!1,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d})):"Escape"===b.key&&l&&l.cancel():(d=!0,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d}))}),this.view.on("key-up",function(b){"Control"===b.key?(d=!1,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d})):"Alt"===b.key&&(g=!0,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d}))})],
l=this._operationHandleForCreateAction(e,b.concat(f),a);return l};d.prototype._setupCreateRectangleOperation=function(a,b){var c=this,e=this._draw.create(a,b),d=!1,g=!1;b=[e.on("vertex-add",function(b){var e=b.type,h=b.vertices;b=h[b.vertexIndex];c._drawSegmentGraphic(a,h,{centered:g,constrained:d});c._emitCreateEvent({graphic:c.createGraphic,state:1===h.length?"start":"active",tool:a,toolEventInfo:{added:b,type:e}})}),e.on("cursor-update",function(b){var e=b.type;b=b.vertices;c._drawSegmentGraphic(a,
b,{centered:g,constrained:d});2===b.length&&c._emitCreateEvent({graphic:c.createGraphic,state:"active",tool:a,toolEventInfo:{coordinates:b[b.length-1],type:e}})}),e.on("draw-complete",function(a){a=a.vertices.slice(0);var b=null,b=n.createViewAlignedCoordinateSystem(c.view,a[0]);1===a.length&&(g=d=!1);b=d?n.createSquare(a,b,g):n.createRectangle(a,b,g);c.createGraphic?c.createGraphic.geometry=b:(c._removeCreateGraphic(),c._set("createGraphic",new t(b,c.polygonSymbol)));l&&l.complete()})];var f=[this.view.on("pointer-move",
function(a){c.view.toMap(E.createScreenPoint(a.x,a.y))?c._displayCrosshairCursor():c._displayDefaultCursor()}),this.view.on("key-down",function(b){"Control"!==b.key||d?"Alt"!==b.key||g?"Escape"===b.key&&l&&l.cancel():(g=!0,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d})):(d=!0,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d}))}),this.view.on("key-up",function(b){"Control"===b.key?(d=!1,c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d})):"Alt"===b.key&&(g=!1,
c._drawSegmentGraphic(a,e.vertices,{centered:g,constrained:d}))})],l=this._operationHandleForCreateAction(e,b.concat(f),a);return l};d.prototype._setupUpdateOperation=function(a,b){return x(this,void 0,void 0,function(){var c,e,d,g,f,l,h,k,m,u,q;return w(this,function(y){c=this;e=c._defaultUpdateTool;d=c.defaultUpdateOptions;g=c.layer;f=c.view;l=v({},d,b);h=l.tool||e;k=0;for(m=a;k<m.length;k++)u=m[k],g.remove(u),g.add(u);if("3d"===f.type){a=a.filter(function(a){return z.isSome(a.geometry)&&!a.geometry.hasZ&&
"mesh"!==a.geometry.type});if("reshape"===h&&1<a.length)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null];if("move"===h||1<a.length)return[2,this._setupMoveOrTransform3DOperation(a,l,f)];if(1===a.length){u=a[0];q=z.get(u.geometry,"type");if("point"===q)return[2,aa.isSupportedGraphic(u)?this._setupPointTransform3DOperation(u,l,f):this._setupMoveOrTransform3DOperation(a,l,f)];if("reshape"===h&&Q.isSupportedGraphic(u))return[2,this._setupReshape3DOperation(u,
l,f)];if("transform"===h)return[2,this._setupMoveOrTransform3DOperation(a,l,f,"transform")]}return[2,null]}if("move"===h)return[2,this._setupMoveOperation(a,l,f)];if(1<a.length)return"reshape"===h?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):[2,this._setupTransformOrReshapeOperation(a,h,l,f)];if(1===a.length){u=a[0];q=z.get(u.geometry,"type");if("point"===q||"multipoint"===q)return[2,this._setupMoveOperation(a,l,f)];if("transform"===
h||"reshape"===h)return[2,this._setupTransformOrReshapeOperation(a,h,l,f)]}return[2,null]})})};d.prototype._setupMoveOrTransform3DOperation=function(a,b,c,e,d){void 0===e&&(e="move");void 0===d&&(d=!1);return x(this,void 0,void 0,function(){var g,f,l,h,k=this;return w(this,function(m){switch(m.label){case 0:return[4,G.create(function(a){F(["../../views/3d/interactive/editingTools"],a)})];case 1:return g=m.sent().GraphicMove3DTool,f=new g({view:c}),this.view.tools.add(f),f.graphics.addMany(a),d||this.updateGraphics.addMany(a),
l=[],h=new I.OperationHandle({activeComponent:f,tool:e,type:"update",onEnd:function(){l.forEach(function(a){return a.remove()});l.length=0;k.view.tools.remove(f);f.destroy()},undo:function(){K(h,k.updateGraphics.toArray());k._emitUndoEvent({graphics:k.updateGraphics.toArray(),tool:e})},redo:function(){L(h,k.updateGraphics.toArray());k._emitRedoEvent({graphics:k.updateGraphics.toArray(),tool:e})},addToSelection:function(a){k.updateGraphics.push(a);f.graphics.push(a);k._emitUpdateEvent({graphics:k.updateGraphics.toArray(),
state:"active",tool:k.activeTool,toolEventInfo:{added:[a],type:"selection-change"}})},removeFromSelection:function(a){var b=k.updateGraphics.indexOf(a);h.history.undo.forEach(function(a){return a.updates.splice(b,1)});h.history.redo.forEach(function(a){return a.updates.splice(b,1)});k.updateGraphics.remove(a);0===k.updateGraphics.length?B(h):f.graphics.remove(a)},toggleTool:function(){return x(k,void 0,void 0,function(){var a,d;return w(this,function(f){switch(f.label){case 0:if(1!==this.updateGraphics.length||
!1===b.toggleToolOnClick||"transform"!==e)return[2];a=this.updateGraphics.getItemAt(0);return Q.isSupportedGraphic(a)?[4,this._setupReshape3DOperation(a,b,c,!0)]:[2];case 1:return d=f.sent(),h.onEnd(),h.destroy(),this._setUpdateOperationHandle(d),[2]}})})}}),l.push.apply(l,this._getHandlesForComponent(h).concat([this.view.on("click",function(a){return k._getCommonUpdateOperationClickHandlers(h,a)}),this.view.on("key-down",function(a){return k._getCommonUpdateOperationKeyDownHandlers(h,a)})])),[2,
h]}})})};d.prototype._setupPointTransform3DOperation=function(a,b,c){return x(this,void 0,void 0,function(){var e,d,g,f,l,h,k,m=this;return w(this,function(u){switch(u.label){case 0:return e="transform",d=b.enableRotation,g=b.enableScaling,[4,G.create(function(a){F(["../../views/3d/interactive/editingTools"],a)})];case 1:return f=u.sent().GraphicTransform3DTool,l=new f({view:c,enableRotation:d,enableScaling:g}),this.view.tools.add(l),l.graphic=a,this.updateGraphics.add(a),h=[],k=new I.OperationHandle({activeComponent:l,
tool:e,type:"update",onEnd:function(){h.forEach(function(a){return a.remove()});h.length=0;m.view.tools.remove(l);l.destroy()},undo:function(){K(k,m.updateGraphics.toArray());m._emitUndoEvent({graphics:m.updateGraphics.toArray(),tool:e})},redo:function(){L(k,m.updateGraphics.toArray());m._emitRedoEvent({graphics:m.updateGraphics.toArray(),tool:e})},addToSelection:function(a){return x(m,void 0,void 0,function(){var e;return w(this,function(h){switch(h.label){case 0:return this.updateGraphics.add(a),
[4,this._setupMoveOrTransform3DOperation(this.updateGraphics.toArray(),b,c,"transform",!0)];case 1:return e=h.sent(),k.onEnd(),k.destroy(),this._setUpdateOperationHandle(e),[2]}})})}}),h.push.apply(h,this._getHandlesForComponent(k).concat([this.view.on("click",function(a){return m._getCommonUpdateOperationClickHandlers(k,a)}),this.view.on("key-down",function(a){return m._getCommonUpdateOperationKeyDownHandlers(k,a)})])),[2,k]}})})};d.prototype._setupMoveOperation=function(a,b,c){return x(this,void 0,
void 0,function(){var e,d,g,f,l,h,k=this;return w(this,function(m){switch(m.label){case 0:return e=[],d="move",a.forEach(function(a){e.push(new t(a.geometry,a.symbol,a.attributes));a.symbol=k._getUpdateSymbol(a.geometry)}),this.updateGraphics.addMany(a),g=[c.on("click",function(a){return k._getCommonUpdateOperationClickHandlers(l,a,b)}),c.on("key-down",function(a){return k._getCommonUpdateOperationKeyDownHandlers(l,a)}),c.on("key-down",function(a){"Control"!==a.key||a.repeat||(f.enableMoveAllGraphics=
!f.enableMoveAllGraphics)}),c.on("key-up",function(a){"Control"===a.key&&(f.enableMoveAllGraphics=!f.enableMoveAllGraphics)})],[4,this._getGraphicMover(a,b,c)];case 1:return f=m.sent(),l=new I.OperationHandle({activeComponent:f,tool:d,type:"update",onEnd:function(){h.forEach(function(a){return a.remove()});g.forEach(function(a){return a.remove()});h=[];g=[];f.destroy();k._internalGraphicsLayer&&k._internalGraphicsLayer.removeMany(k.updateGraphics.toArray());k.updateGraphics.forEach(function(a,b){a.symbol=
e[b].symbol})},undo:function(){K(l,k.updateGraphics.toArray());k._emitUndoEvent({graphics:k.updateGraphics.toArray(),tool:d})},redo:function(){L(l,k.updateGraphics.toArray());k._emitRedoEvent({graphics:k.updateGraphics.toArray(),tool:d})},addToSelection:function(a){e.push(new t(a.geometry,a.symbol,a.attributes));a.symbol=k._getUpdateSymbol(a.geometry);k.updateGraphics.push(a);f.graphics=k.updateGraphics.toArray();k._emitUpdateEvent({graphics:k.updateGraphics.toArray(),state:"active",tool:k.activeTool,
toolEventInfo:{added:[a],type:"selection-change"}})},removeFromSelection:function(a){var b=k.updateGraphics.indexOf(a);l.history.undo.forEach(function(a){return a.updates.splice(b,1)});l.history.redo.forEach(function(a){return a.updates.splice(b,1)});var c=e.splice(b,1)[0];a.symbol=c.symbol;k.updateGraphics.remove(a);0===k.updateGraphics.length?B(l):f.graphics=k.updateGraphics.toArray()}}),h=this._getHandlesForComponent(l),[2,l]}})})};d.prototype._setupReshape3DOperation=function(a,b,c,e){void 0===
e&&(e=!1);return x(this,void 0,void 0,function(){var d,g,f,l,h,k=this;return w(this,function(m){switch(m.label){case 0:return d="reshape",[4,G.create(function(a){F(["../../views/3d/interactive/editingTools"],a)})];case 1:return g=m.sent().GraphicReshape3DTool,f=new g({view:c,graphic:a}),c.tools.add(f),e||this.updateGraphics.add(a),l=[],h=new I.OperationHandle({activeComponent:f,tool:d,type:"update",onEnd:function(){l.forEach(function(a){return a.remove()});l.length=0;c.tools.remove(f);f.destroy()},
undo:function(){K(h,k.updateGraphics.toArray());k._emitUndoEvent({graphics:k.updateGraphics.toArray(),tool:d})},redo:function(){L(h,k.updateGraphics.toArray());k._emitRedoEvent({graphics:k.updateGraphics.toArray(),tool:d})},addToSelection:function(a){return x(k,void 0,void 0,function(){var e;return w(this,function(d){switch(d.label){case 0:return this.updateGraphics.add(a),[4,this._setupMoveOrTransform3DOperation(this.updateGraphics.toArray(),b,c,"transform",!0)];case 1:return e=d.sent(),h.onEnd(),
h.destroy(),this._setUpdateOperationHandle(e),[2]}})})},toggleTool:function(){return x(k,void 0,void 0,function(){var a;return w(this,function(e){switch(e.label){case 0:return!1===b.toggleToolOnClick?[2]:[4,this._setupMoveOrTransform3DOperation(this.updateGraphics.toArray(),b,c,"transform",!0)];case 1:return a=e.sent(),h.onEnd(),h.destroy(),this._setUpdateOperationHandle(a),[2]}})})}}),l.push.apply(l,this._getHandlesForComponent(h).concat([c.on("click",function(a){return k._getCommonUpdateOperationClickHandlers(h,
a)}),c.on("key-down",function(a){return k._getCommonUpdateOperationKeyDownHandlers(h,a)})])),[2,h]}})})};d.prototype._setupTransformOrReshapeOperation=function(a,b,c,e){return x(this,void 0,void 0,function(){var d,g,f,l,h,k,m,p,q,r,n=this;return w(this,function(y){switch(y.label){case 0:return d=c.multipleSelectionEnabled,g=void 0===d?!0:d,f=c.toggleToolOnClick,l=void 0===f?!0:f,h=[],a.forEach(function(a){h.push(new t(a.geometry,a.symbol,a.attributes));a.symbol=n._getUpdateSymbol(a.geometry)}),this.updateGraphics.addMany(a),
k=[e.on("click",function(a){n._hitTest(E.createScreenPointFromEvent(a)).then(function(b){if(q)if(b=b.results,b.length){var c=q.activeComponent,e=a.native&&a.native.shiftKey;b.some(function(a){if(a.graphic){a=a.graphic;if(g&&e&&c&&"box"===c.type&&!c.isUIGraphic(a))return q.addToSelection(a),!0;if(c&&"box"===c.type&&c.isUIGraphic(a))return!1!==l&&1===n.updateGraphics.length&&(a=n.updateGraphics.getItemAt(0).geometry,"extent"===z.get(a,"type")?n._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."):
q.toggleTool()),!0;if(c&&"reshape"===c.type){if(a===c.graphic)return!1!==l&&q.toggleTool(),!0;if(c.isUIGraphic(a)||a.layer===n._internalGraphicsLayer)return!0}else a.layer===n.layer&&B(q)}return!1})?a.stopPropagation():B(q)}else B(q)})}),e.on("key-down",function(a){return n._getCommonUpdateOperationKeyDownHandlers(q,a)}),e.on("key-down",function(a){"Control"===a.key&&!a.repeat&&q&&(a=q.activeComponent)&&"box"===a.type&&(a.preserveAspectRatio=!a.preserveAspectRatio)}),e.on("key-up",function(a){"Control"===
a.key&&q&&(a=q.activeComponent)&&"box"===a.type&&(a.preserveAspectRatio=!a.preserveAspectRatio)})],"transform"!==b?[3,2]:[4,this._getBox(a,c,e)];case 1:return p=y.sent(),[3,4];case 2:return[4,this._getReshape(a,c,e)];case 3:p=y.sent(),y.label=4;case 4:return m=p,q=new I.OperationHandle({activeComponent:m,type:"update",onEnd:function(){r.forEach(function(a){return a.remove()});k.forEach(function(a){return a.remove()});r=[];k=[];q.activeComponent.destroy();n._internalGraphicsLayer.removeMany(n.updateGraphics.toArray());
n.updateGraphics.forEach(function(a,b){h[b]&&h[b].symbol&&(a.symbol=h[b].symbol)})},undo:function(){K(q,n.updateGraphics.toArray());q.refreshComponent();n._emitUndoEvent({graphics:n.updateGraphics.toArray(),tool:q.tool})},redo:function(){L(q,n.updateGraphics.toArray());q.refreshComponent();n._emitRedoEvent({graphics:n.updateGraphics.toArray(),tool:q.tool})},addToSelection:function(a){var b=q.activeComponent;h.push(new t(a.geometry,a.symbol,a.attributes));a.symbol=n._getUpdateSymbol(a.geometry);n.updateGraphics.add(a);
b.graphics=n.updateGraphics.toArray();b.refresh();q.resetHistory();n._emitUpdateEvent({graphics:n.updateGraphics.toArray(),state:"active",tool:n.activeTool,toolEventInfo:{added:[a],type:"selection-change"}})},removeFromSelection:function(a){var b=q.activeComponent,c=n.updateGraphics.indexOf(a);q.history.undo.forEach(function(a){return a.updates.splice(c,1)});q.history.redo.forEach(function(a){return a.updates.splice(c,1)});var e=h.splice(c,1)[0];a.symbol=e.symbol;n.updateGraphics.remove(a);0===n.updateGraphics.length?
B(q):b.graphics=n.updateGraphics.toArray()},toggleTool:function(){return x(n,void 0,void 0,function(){var b;return w(this,function(h){switch(h.label){case 0:if(1<this.updateGraphics.length)return[2];b=null;return"transform"!==q.tool?[3,2]:[4,this._getReshape(a,c,e)];case 1:return b=h.sent(),[3,4];case 2:return"reshape"!==q.tool?[3,4]:[4,this._getBox(a,c,e)];case 3:b=h.sent(),h.label=4;case 4:return q.activeComponent.destroy(),q.activeComponent=b,q.activeComponent&&(r.forEach(function(a){return a.remove()}),
r=this._getHandlesForComponent(q)),[2]}})})}}),r=this._getHandlesForComponent(q),[2,q]}})})};d.prototype._getGraphicMover=function(a,b,c){return x(this,void 0,void 0,function(){var e,d,g,f=this;return w(this,function(l){switch(l.label){case 0:return e=b.enableMoveAllGraphics,d=void 0===e?!0:e,[4,G.create(function(a){return F(["../../views/draw/support/GraphicMover"],a)})];case 1:return g=l.sent(),[2,new g({enableMoveAllGraphics:d,graphics:a,view:c,callbacks:{onGraphicMoveStart:function(a){var b=a.dx,
c=a.dy;a=a.graphic;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:a,type:"move-start"}})},onGraphicMove:function(a){var b=a.dx,c=a.dy;a=a.graphic;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:a,type:"move"}})},onGraphicMoveStop:function(a){var b=a.dx,c=a.dy;a=a.graphic;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",
tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:a,type:"move-stop"}})},onGraphicPointerOver:function(a){return f._displayDefaultCursor()},onGraphicPointerOut:function(a){return f._displayDefaultCursor()}}})]}})})};d.prototype._getBox=function(a,b,c){return x(this,void 0,void 0,function(){var e,d,g,f,l,h,k,m=this;return w(this,function(n){switch(n.label){case 0:return e=b.enableRotation,d=void 0===e?!0:e,g=b.enableScaling,f=void 0===g?!0:g,l=b.preserveAspectRatio,h=void 0===l?!1:l,[4,G.create(function(a){return F(["../../views/draw/support/Box"],
a)})];case 1:return k=n.sent(),[2,new k({graphics:a,enableRotation:d,enableScaling:f,preserveAspectRatio:h,layer:this._internalGraphicsLayer,view:c,callbacks:{onMoveStart:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onMove:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onMoveStop:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),
state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onScaleStart:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onScale:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onScaleStop:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onRotateStart:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),
state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onRotate:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})},onRotateStop:function(a){return m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:v({},a)})}}})]}})})};d.prototype._getReshape=function(a,b,c){return x(this,void 0,void 0,function(){var e,d,g,f=this;return w(this,function(l){switch(l.label){case 0:return e=
b.enableMidpoints,d=void 0===e?!0:e,[4,G.create(function(a){return F(["../../views/draw/support/Reshape"],a)})];case 1:return g=l.sent(),[2,new g({enableMidpoints:d,graphic:a[0],layer:this._internalGraphicsLayer,view:c,callbacks:{onReshapeStart:function(a){return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:v({},a)})},onReshape:function(a){return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:v({},
a)})},onReshapeStop:function(a){var b=a.mover;a=a.type;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{mover:b,type:a}})},onMoveStart:function(a){var b=a.dx,c=a.dy,e=a.mover;a=a.type;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:e,type:a}})},onMove:function(a){var b=a.dx,c=a.dy,e=a.mover;a=a.type;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),
state:"active",tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:e,type:a}})},onMoveStop:function(a){var b=a.dx,c=a.dy,e=a.mover;a=a.type;return f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:e,type:a}})},onVertexAdd:function(a){var b=a.type;a=a.added.map(function(a){return P.geometryToCoordinates(a.geometry)});f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{added:a,type:b}})},
onVertexRemove:function(a){var b=a.type;a=a.removed.map(function(a){return P.geometryToCoordinates(a.geometry)});f._emitUpdateEvent({graphics:f.updateGraphics.toArray(),state:"active",tool:f.activeTool,toolEventInfo:{removed:a,type:b}})}}})]}})})};d.prototype._getHandlesForComponent=function(a){var b=this,c=a.activeComponent;switch(c.type){case "graphic-mover":return[c.on("graphic-move-start",function(b){return a.addToHistory(A(b.allGraphics))})];case "box":return[c.on("move-start",function(b){return a.addToHistory(A(b.graphics))}),
c.on("rotate-start",function(b){return a.addToHistory(A(b.graphics))}),c.on("scale-start",function(b){return a.addToHistory(A(b.graphics))})];case "reshape":return[c.on("move-start",function(b){return a.addToHistory(A([b.mover]))}),c.on("reshape-start",function(b){return a.addToHistory(A([b.graphic]))}),c.on("vertex-add",function(b){return a.addToHistory(A([b.oldGraphic]))}),c.on("vertex-remove",function(b){return a.addToHistory(A([b.oldGraphic]))})];case "move-3d":return[c.on("graphic-move-start",
function(c){a.addToHistory(A(c.allGraphics));b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{dx:0,dy:0,mover:0<c.allGraphics.length?c.allGraphics[0]:null,type:"move-start"}})}),c.on("graphic-move",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{dx:a.dx,dy:a.dy,mover:0<a.allGraphics.length?a.allGraphics[0]:null,type:"move"}})}),c.on("graphic-move-stop",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),
state:"active",tool:b.activeTool,toolEventInfo:{dx:0,dy:0,mover:0<a.allGraphics.length?a.allGraphics[0]:null,type:"move-stop"}})}),c.on("click",function(){return a.toggleTool()})];case "transform-3d":return[c.on("graphic-translate-start",function(c){a.addToHistory(A([c.graphic]));b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:c.graphic,dx:0,dy:0,type:"move-start"}})}),c.on("graphic-translate-stop",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),
state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,dx:0,dy:0,type:"move-stop"}})}),c.on("graphic-rotate-start",function(c){a.addToHistory(S([c.graphic]));b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:c.graphic,angle:0,type:"rotate-start"}})}),c.on("graphic-rotate-stop",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,angle:0,type:"rotate-stop"}})}),
c.on("graphic-scale-start",function(c){a.addToHistory(S([c.graphic]));b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:c.graphic,xScale:1,yScale:1,type:"scale-start"}})}),c.on("graphic-scale-stop",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,xScale:1,yScale:1,type:"scale-stop"}})}),c.on("graphic-translate",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),
state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,dx:a.dx,dy:a.dy,type:"move"}})}),c.on("graphic-rotate",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,angle:a.angle,type:"rotate"}})}),c.on("graphic-scale",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,xScale:a.scale,yScale:a.scale,type:"scale"}})})];case "reshape-3d":return[c.on("reshape-start",
function(c){a.addToHistory(A([c.graphic]));c.isDragging&&(c=c.fromTranslation?{mover:c.graphic,dx:0,dy:0,type:"move-start"}:{mover:c.graphic,type:"reshape-start"},b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:c}))}),c.on("vertex-move",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,type:"reshape"}})}),c.on("translate",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),
state:"active",tool:b.activeTool,toolEventInfo:{mover:a.graphic,dx:a.dxScreen,dy:a.dyScreen,type:"move"}})}),c.on("reshape-stop",function(a){a.isDragging&&(a=a.fromTranslation?{mover:a.graphic,dx:0,dy:0,type:"move-stop"}:{mover:a.graphic,type:"reshape-stop"},b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:a}))}),c.on("vertex-add",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{added:a.coords,
type:"vertex-add"}})}),c.on("vertex-remove",function(a){b._emitUpdateEvent({graphics:b.updateGraphics.toArray(),state:"active",tool:b.activeTool,toolEventInfo:{removed:a.coords,type:"vertex-remove"}})}),c.on("click",function(){return a.toggleTool()})];case "draw":return null;default:V.neverReached(c)}};d.prototype._setUpdateOperationHandle=function(a){var b=this;this._operationHandle=a;var c=this.view,e=c.map,d=c.popup,g=!0;d&&(g=d.autoOpenEnabled,d.autoOpenEnabled=!1);c=function(){if(a===b._operationHandle){var c=
a.cancelled?"cancel":"complete",l=b.updateGraphics.toArray(),h=b._operationHandle.tool;b._operationHandle.destroy();b._operationHandle=null;b._internalGraphicsLayer.removeMany(b.updateGraphics.toArray());b.updateGraphics.removeAll();e&&e.remove(b._internalGraphicsLayer);d&&(d.autoOpenEnabled=g);b._emitUpdateEvent({graphics:l,state:c,tool:h,toolEventInfo:null})}};a.on("complete",c);a.on("cancel",c)};d.prototype._getCommonUpdateOperationClickHandlers=function(a,b,c){var e=this,d=E.createScreenPointFromEvent(b),
g=this.view.toolViewManager.handlesClickEvent(b);this._hitTest(d).then(function(d){d=d.results;if(d.length||g){var f=b.native&&b.native.shiftKey,h=c?!!c.multipleSelectionEnabled:!0;d.some(function(b){return b.graphic&&(b=b.graphic,h&&f&&b.layer===e.layer)?(-1===e.updateGraphics.indexOf(b)?a.addToSelection(b):a.removeFromSelection(b),!0):!1})?b.stopPropagation():g||(d.some(function(a){return a.graphic&&-1<e.updateGraphics.indexOf(a.graphic)})?b.stopPropagation():B(a))}else B(a)})};d.prototype._getCommonUpdateOperationKeyDownHandlers=
function(a,b){if(a){var c=b.key;"z"===c&&a.canUndo()?(b.stopPropagation(),a.undo()):"r"===c&&a.canRedo()?(b.stopPropagation(),a.redo()):"Escape"===c?B(a):0<=da.indexOf(c)&&this._onDeleteKey()}};d.prototype._onDeleteKey=function(){if(this._operationHandle&&"update"===this._operationHandle.type){var a=this.activeComponent;a&&"reshape"!==a.type&&"reshape-3d"!==a.type&&(a=this.updateGraphics.toArray(),this.layer.removeMany(a),this._emitDeleteEvent({graphics:a,tool:this.activeTool}))}};d.prototype._getCreateSymbol=
function(a,b){void 0===b&&(b=!1);b="3d"!==this.view.type&&b;switch(a.type){case "point":case "multipoint":return b?this.activePointSymbol:this.pointSymbol;case "polyline":return b?this.activeLineSymbol:this.polylineSymbol;case "polygon":return b?this.activeFillSymbol:this.polygonSymbol}return null};d.prototype._getUpdateSymbol=function(a){if(z.isNone(a))return null;switch(a.type){case "point":case "multipoint":return this.updatePointSymbol;case "polyline":return this.updatePolylineSymbol;case "polygon":case "extent":return this.updatePolygonSymbol}return null};
d.prototype._drawMultipointGraphic=function(a,b){var c=null;!b&&1<a.length?(c=a.slice(0),c.pop(),c=n.createMultipoint(c,this.view.spatialReference)):c=n.createMultipoint(a,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=c:this._set("createGraphic",new t(c,this.pointSymbol));b&&1===a.length&&this._internalGraphicsLayer.add(this.createGraphic)};d.prototype._drawVertexGraphics=function(a,b,c){c=!(!c||!c.userClicked);var e="polygon"===a,d=e?this.polygonSymbol:this.polylineSymbol;
if(1===b.length){this._removeLineGraphic();this._removeActiveLineGraphic();a=b[0];var g=a[0],f=a[1],l=new C.Point(g,f,this.view.spatialReference),e=e?n.createPolygon([b],this.view.spatialReference,this._doUnnormalization,!0):n.createPolyline([b],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length?this._vertexGraphics[0].geometry=l:this._vertexGraphics.push(new t(l,this.activeVertexSymbol));this.createGraphic?this.createGraphic.geometry=e:this._set("createGraphic",new t(e,
d));c&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===b.length)d=b[1],g=d[0],f=d[1],a=new C.Point(g,f,this.view.spatialReference),g=this.vertexSymbol,d=n.createPolyline([b],this.view.spatialReference,this._doUnnormalization),e=e?n.createPolygon([b],this.view.spatialReference,this._doUnnormalization,!0):n.createPolyline([b],this.view.spatialReference,this._doUnnormalization),this._vertexGraphics.length||(b=b[0],l=new C.Point(b[0],b[1],this.view.spatialReference),b=new t(l,g),
this._vertexGraphics.push(b)),1===this._vertexGraphics.length?(b=this._vertexGraphics[0],a=new t(a,g),this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(a),this._internalGraphicsLayer.remove(b),this._internalGraphicsLayer.add(b)):this._vertexGraphics[1].geometry=a,this._showActiveLineGraphic(d),b=this._vertexGraphics[0],c&&(this._activeLineGraphic.symbol=this.polylineSymbol,b.symbol=this.vertexSymbol,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?
this.createGraphic.geometry=e:this._set("createGraphic",new t(e,this.polygonSymbol)),this._internalGraphicsLayer.remove(b),this._internalGraphicsLayer.add(b);else if(2<b.length){e=e?n.createPolygon([b],this.view.spatialReference,this._doUnnormalization,!0):n.createPolyline([b],this.view.spatialReference,this._doUnnormalization);"polygon"===a&&this._showFillGraphic(e);a=b.map(function(a){return[a[0],a[1]]});g=a.pop();l=[a[a.length-1],g];g=n.createPolyline([a],this.view.spatialReference,this._doUnnormalization);
l=n.createPolyline([l],this.view.spatialReference,this._doUnnormalization);this._showLineGraphic(g);this._showActiveLineGraphic(l);for(l=0;l<a.length;l++)(g=this._vertexGraphics[l])?g.symbol=c||l!==this._vertexGraphics.length-1?this.vertexSymbol:this.activeVertexSymbol:(f=b[l],g=f[0],f=f[1],this._showVertexGraphic(new C.Point(g,f,this.view.spatialReference)));c?(this._activeLineGraphic.symbol=this.polylineSymbol,c=b[b.length-1],g=c[0],f=c[1],this._showVertexGraphic(new C.Point(g,f,this.view.spatialReference))):
this._activeLineGraphic.symbol=this.activeLineSymbol;this.createGraphic?this.createGraphic.geometry=e:(this._removeCreateGraphic(),this._set("createGraphic",new t(e,d)));c=0;for(e=this._vertexGraphics;c<e.length;c++)b=e[c],this._internalGraphicsLayer.remove(b),this._internalGraphicsLayer.add(b)}};d.prototype._drawSegmentGraphic=function(a,b,c){if(b.length){var e=n.createViewAlignedCoordinateSystem(this.view,b[0]),d=!(!c||!c.centered);c=!(!c||!c.constrained);var g=null;1===b.length?this._removeCenterIndicatorGraphic():
("rectangle"===a?g=c?n.createSquare(b,e,d):n.createRectangle(b,e,d):"circle"===a&&(g=c?n.createEllipse(b,e,d):n.createCircle(b,e,d)),g.extent&&g.extent.center&&this._showCenterIndicatorGraphic(g.extent.center));g?this.createGraphic?this.createGraphic.geometry=g:(this._removeCreateGraphic(),this._set("createGraphic",new t(g,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}};d.prototype._showCenterIndicatorGraphic=function(a){this._centerIndicatorGraphic?
this._centerIndicatorGraphic.geometry=a:(this._centerIndicatorGraphic=new t(a,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))};d.prototype._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)};d.prototype._showActiveLineGraphic=function(a){this._activeLineGraphic?this._activeLineGraphic.geometry=a:(this._activeLineGraphic=
new t(a,this.activeLineSymbol),this._internalGraphicsLayer.graphics.add(this._activeLineGraphic,0))};d.prototype._showFillGraphic=function(a){this._activeFillGraphic?this._activeFillGraphic.geometry=a:(this._activeFillGraphic=new t(a,this._getCreateSymbol(a,!0)),this._internalGraphicsLayer.add(this._activeFillGraphic))};d.prototype._showLineGraphic=function(a){this._lineGraphic?this._lineGraphic.geometry=a:(this._lineGraphic=new t(a,this.polylineSymbol),this._internalGraphicsLayer.graphics.add(this._lineGraphic,
0))};d.prototype._showVertexGraphic=function(a,b){a=new t(a,b?this.activeVertexSymbol:this.vertexSymbol);this._vertexGraphics.push(a);this._internalGraphicsLayer.add(a)};d.prototype._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic();this._removeLineGraphic();this._removeActiveLineGraphic();this._removeVertexGraphics()};d.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))};d.prototype._removeCreateOperationGraphics=
function(){this._removeCenterIndicatorGraphic();this._removeActiveLineGraphic();this._removeActiveFillGraphic();this._removeLineGraphic();this._removeVertexGraphics()};d.prototype._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)};d.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),
this._activeFillGraphic.destroy(),this._activeFillGraphic=null)};d.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)};d.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(function(a){return a.destroy()}),this._vertexGraphics=[])};d.prototype._removeDefaultLayer=function(){this._internalGraphicsLayer&&
(this.view&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)};d.prototype._operationHandleForCreateAction=function(a,b,c){var e=this;return new I.OperationHandle({activeComponent:this._draw,tool:c,type:"create",onEnd:function(){b.forEach(function(a){return a.remove()});b.length=0;e._removeCreateOperationGraphics();e._internalGraphicsLayer&&e._internalGraphicsLayer.remove(e.createGraphic);e._displayDefaultCursor()},undo:function(){a.undo();
e._emitUndoEvent({graphics:[e.createGraphic],tool:c})},redo:function(){a.redo();e._emitRedoEvent({graphics:[e.createGraphic],tool:c})},canUndo:function(){return a&&a.canUndo()},canRedo:function(){return a&&a.canRedo()}})};d.prototype._snap=function(a,b,c){c&&this._snapLastVertexToAxis(b);"polygon"===a&&this._snapLastPolygonVertexToFirst(b)};d.prototype._snapLastPolygonVertexToFirst=function(a){if(!(2>=a.length)){var b=a[0];a=a[a.length-1];var c=this.view.toScreen(new C.Point(b[0],b[1],this.view.spatialReference)),
e=this.view.toScreen(new C.Point(a[0],a[1],this.view.spatialReference));this._isWithinScreenDistance(c,e,this._getVertexIntersectDistance())&&(a[0]=b[0],a[1]=b[1])}};d.prototype._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?E.pt2px(this.vertexSymbol.size)/2+3:3};d.prototype._isWithinScreenDistance=function(a,b,c){var e=a.x-b.x;a=a.y-b.y;return Math.sqrt(e*e+a*a)<=c};d.prototype._snapLastVertexToAxis=function(a){if(!(2>a.length)){var b=a.pop(),
c=a[a.length-1],e=n.createViewAlignedCoordinateSystem(this.view,c),c=e.mapToLocal(c),b=e.mapToLocal(b),d=Math.abs(b.x-c.x),g=Math.abs(b.y-c.y),e=e.localToMap(n.makeSurfacePoint(d>g?b.x:c.x,d>g?c.y:b.y));a.push(e)}};d.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")};d.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)};d.prototype._logError=
function(a,b,c){ca.error(new W(a,b,c))};d.prototype._generateSceneViewHighlightHandles=function(){var a=this,b=function(b,e){var c=a.view;if(c&&"2d"!==c.type){var d=c.allLayerViews.find(function(a){return a.layer.uid===e.uid});d&&(b.added&&b.added.forEach(function(b){a._highlightHandlesByGraphic.add(d.highlight(b),b.uid)}),b.removed&&b.removed.forEach(function(b){a._highlightHandlesByGraphic.remove(b.uid)}))}};return[this.updateGraphics.on("after-add",function(c){b({added:[c.item]},a.layer)}),this.updateGraphics.on("after-remove",
function(c){b({removed:[c.item]},a.layer)}),this._internalGraphicsLayer.graphics.on("after-add",function(c){b({added:[c.item]},a._internalGraphicsLayer)}),this._internalGraphicsLayer.graphics.on("after-remove",function(c){b({removed:[c.item]},a._internalGraphicsLayer)}),J.on(this,"view.allLayerViews","change",function(c){if(c.added){var e=0;for(c=c.added;e<c.length;e++){var d=c[e];d.layer===a.layer?b({added:a.updateGraphics.toArray(),removed:[]},d.layer):d.layer===a._internalGraphicsLayer&&b({added:a._internalGraphicsLayer.graphics.toArray(),
removed:[]},d.layer)}}})]};d.prototype._emitCreateEvent=function(a){this.emit("create",v({},a,{type:"create"}))};d.prototype._emitUpdateEvent=function(a){this.emit("update",v({},a,{type:"update"}))};d.prototype._emitUndoEvent=function(a){this.emit("undo",v({},a,{type:"undo"}))};d.prototype._emitRedoEvent=function(a){this.emit("redo",v({},a,{type:"redo"}))};d.prototype._emitDeleteEvent=function(a){this.emit("delete",v({},a,{type:"delete"}))};r([p.property({dependsOn:["state"],readOnly:!0})],d.prototype,
"_draw",null);r([p.property()],d.prototype,"_operationHandle",void 0);r([p.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],d.prototype,"activeTool",null);r([p.property()],d.prototype,"activeFillSymbol",void 0);r([p.property()],d.prototype,"activeLineSymbol",void 0);r([p.property()],d.prototype,"activePointSymbol",void 0);r([p.property()],d.prototype,"activeVertexSymbol",void 0);r([p.property({readOnly:!0})],d.prototype,"createGraphic",void 0);r([p.property()],d.prototype,
"defaultUpdateOptions",void 0);r([p.property()],d.prototype,"layer",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"pointSymbol",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"polygonSymbol",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"polylineSymbol",void 0);r([p.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],d.prototype,"state",null);r([p.property({readOnly:!0})],d.prototype,"updateGraphics",void 0);r([p.property()],d.prototype,
"updateOnGraphicClick",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"updatePointSymbol",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"updatePolygonSymbol",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"updatePolylineSymbol",void 0);r([p.property({types:D.symbolTypes})],d.prototype,"vertexSymbol",void 0);r([p.property({value:null})],d.prototype,"view",null);r([p.property()],d.prototype,"cancel",null);r([p.property()],d.prototype,"complete",null);r([p.property()],
d.prototype,"create",null);r([p.property()],d.prototype,"update",null);r([p.property()],d.prototype,"undo",null);r([p.property()],d.prototype,"redo",null);r([p.property()],d.prototype,"canUndo",null);r([p.property()],d.prototype,"canRedo",null);r([p.property()],d.prototype,"toggleUpdateTool",null);return d=r([p.subclass("esri.widgets.Sketch.SketchViewModel")],d)}(p.declared(X.EventedAccessor))});