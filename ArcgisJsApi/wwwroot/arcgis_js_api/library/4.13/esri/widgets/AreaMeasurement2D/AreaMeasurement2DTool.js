// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../Graphic ../../core/Handles ../../core/promiseUtils ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/Point ../../geometry/Polygon ../../geometry/Polyline ../../geometry/projection ../../geometry/SpatialReference ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../symbols/SimpleMarkerSymbol ../../views/2d/draw/Draw ../../views/interactive/GraphicManipulator ../../views/interactive/InteractiveToolBase ../../views/interactive/interactiveToolUtils".split(" "),
function(K,L,C,q,r,D,E,p,g,y,F,z,f,v,e,A,t,G,H,I,w){function J(e,b,f,a){var d=new t({style:"circle",color:a.handleColor,size:a.handleWidth,outline:{type:"simple-line",width:0}});a=new t({style:"circle",color:a.handleColor,size:1.5*a.handleWidth,outline:{type:"simple-line",width:0}});e=new r({geometry:e,symbol:d});return new H.GraphicManipulator({view:b,layer:f,graphic:e,focusedSymbol:a})}return function(t){function b(a){a=t.call(this,a)||this;a._drawActive=!1;a._handles=new D;a._graphicsLayer=new A({listMode:"hide"});
a._manipulatorLayer=new A({listMode:"hide"});a._vertices=[];return a}C(b,t);x=b;b.prototype.initialize=function(){var a=this,d=this.view;this._draw=new G({view:d});d.map.addMany([this._graphicsLayer,this._manipulatorLayer]);d.focus();this._handles.add([this.watch("viewModel.unit",function(){0<a._vertices.length&&a._updateGraphics()}),this.watch("projectionEngineRequired",function(d){d&&a._loadProjectionEngine()})]);this.projectionEngineRequired&&this._loadProjectionEngine()};b.prototype.destroy=function(){this.detach();
this._handles.removeAll();this._graphicsLayer.removeAll();var a=this.viewModel,d=a.view.map;d.remove(this._graphicsLayer);d.remove(this._manipulatorLayer);a.measurement=null;this._draw&&(this._draw.destroy(),this._draw=null);this._handles&&(this._handles.destroy(),this._handles=null);this._graphicsLayer&&(this._graphicsLayer.destroy(),this._graphicsLayer=null);this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)};Object.defineProperty(b.prototype,"editable",{set:function(a){this._set("editable",
a);a||this._draw.reset()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"projectionEngineRequired",{get:function(){var a=this.view;if(!a)return!1;a=a.spatialReference;if(!a)return!1;var d=a.isGeographic,b=a.isWebMercator,f=a.isWGS84;return d&&!f&&!e.isSupported(a)||!d&&!b},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"projectionEngineSupported",{get:function(){return f.isSupported()},enumerable:!0,configurable:!0});b.prototype.onShow=function(){this._graphicsLayer.visible=
!0};b.prototype.onHide=function(){this._graphicsLayer.visible=!1};b.prototype.reset=function(){this._vertices=[];this._graphicsLayer.removeAll();this.viewModel.measurement=null;this._draw.reset();this._drawActive=!1;this._updateSketch([])};b.prototype.newMeasurement=function(){this.reset();w.setActive(this,!0);this._startSketch()};b.prototype.clearMeasurement=function(){this.reset();w.setActive(this,!1);this.cursor=null};b.updateViewModelAndCreateGraphics=function(a,d){var b=d.geodesicDistanceThreshold,
m=d.palette,h=d.view.spatialReference,k=m.fillColor,B=m.pathColor,m=m.pathWidth;if(2===a.length){d=new z({paths:a,spatialReference:h});k=void 0;if(h.isGeographic)e.isSupported(h)?k=e.geodesicDensify(d,1E5):(a=f.project(d,v.WGS84),d=e.geodesicDensify(a,1E5),k=f.project(d,h));else if(h.isWebMercator)k=g.geodesicDensify(d,1E5,"meters");else{var n=g.planarLength(d,"meters");n>=b?(a=f.project(d,v.WGS84),d=e.geodesicDensify(a,1E5),k=f.project(d,h)):k=d}return[new r({geometry:k,symbol:{type:"simple-line",
color:B,width:m}})]}a.push(a[0]);var l=new z({paths:[a],spatialReference:h}),u=new F({rings:[a],spatialReference:h}),c=a=null;if(h.isGeographic)if(e.isSupported(h)){a=e.geodesicDensify(l,1E5);c=e.geodesicDensify(u,1E5);c=g.simplify(c);if(!c)return null;b=e.geodesicLengths([l],"meters")[0];l=e.geodesicAreas([c],"square-meters")[0]}else{a=v.WGS84;b=f.project(l,a);c=f.project(u,a);a=e.geodesicDensify(b,1E5);c=e.geodesicDensify(c,1E5);c=g.simplify(c);if(!c)return null;b=e.geodesicLengths([b],"meters")[0];
l=e.geodesicAreas([c],"square-meters")[0];a=f.project(a,h);c=f.project(c,h)}else if(h.isWebMercator){a=g.geodesicDensify(l,1E5,"meters");c=g.geodesicDensify(u,1E5,"meters");c=g.simplify(c);if(!c)return null;b=g.geodesicLength(l,"meters");l=g.geodesicArea(c,"square-meters")}else if(n=g.planarLength(l,"meters"),n>=b){a=v.WGS84;b=f.project(l,a);c=f.project(u,a);a=e.geodesicDensify(b,1E5);c=e.geodesicDensify(c,1E5);c=g.simplify(c);if(!c)return null;b=e.geodesicLengths([b],"meters")[0];l=e.geodesicAreas([c],
"square-meters")[0];a=f.project(a,h);c=f.project(c,h)}else{a=l;c=g.simplify(u);if(!c)return null;b=n;l=g.planarArea(c,"square-meters")}d.measurement={geometry:c,area:l,perimeter:b};return[new r({geometry:c,symbol:{type:"simple-fill",color:k,outline:{type:"simple-line",width:0}}}),new r({geometry:a,symbol:{type:"simple-line",color:B,width:m}}),new r({geometry:c.centroid,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:d.measurementLabel.area,font:{size:14,family:"sans-serif"}}})]};
b.prototype.onInputEvent=function(a){"pointer-move"===a.type&&this._updateCursor()};b.prototype._loadProjectionEngine=function(){return this.projectionEngineSupported&&!f.isLoaded()?f.load():E.resolve()};b.prototype._startSketch=function(){var a=this;this._drawActive=!0;var b=this._draw.create("polyline",{mode:"click"});b.on("vertex-add vertex-update vertex-remove cursor-update undo redo".split(" "),function(b){return a._updateSketch(b.vertices)});b.on("draw-complete",function(){return a._stopSketch()})};
b.prototype._stopSketch=function(){3>this._vertices.length?this.newMeasurement():(this.manipulators.forEach(function(a){a.manipulator.interactive=!0}),w.setActive(this,!1),this._drawActive=!1)};b.prototype._updateSketch=function(a){var b=this;if(!this.projectionEngineRequired||f.isLoaded())if(2>a.length)this._vertices=[],this.manipulators.removeAll(),this._graphicsLayer.removeAll();else{for(var e=this.view.spatialReference;this._vertices.length>a.length;){var m=this._vertices.pop().manipulatorId;
this.manipulators.remove(m)}for(var m=function(d){var c=a[d],g=c[0],c=c[1],f=new y({x:g,y:c,spatialReference:e}),k=J(f,h.view,h._manipulatorLayer,h.viewModel.palette),f=h.manipulators.add(k);k.on("drag",function(){var a=k.graphic.geometry;b._vertices[d].coord=[a.x,a.y];b._updateGraphics()});h._vertices.push({manipulatorId:f,coord:[g,c]})},h=this,k=this._vertices.length;k<a.length;k++)m(k);var m=this._vertices.length-1,k=this._vertices[m],g=a[m],n=g[0],g=g[1];if(k.coord[0]!==n||k.coord[1]!==g)k.coord=
[n,g],n=new y({x:n,y:g,spatialReference:e}),this.manipulators.findById(k.manipulatorId).graphic.geometry=n;var l=this._drawActive?this._vertices[m].manipulatorId:null;this.manipulators.forEach(function(a){a.manipulator.interactive=null==l||a.id!==l});this._updateGraphics()}};b.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null};b.prototype._updateGraphics=function(){this._graphicsLayer.removeAll();var a=this.viewModel,b=this._vertices.map(function(a){return a.coord});
(a=x.updateViewModelAndCreateGraphics(b,a))&&this._graphicsLayer.addMany(a)};var x;q([p.property({constructOnly:!0})],b.prototype,"view",void 0);q([p.property({constructOnly:!0})],b.prototype,"viewModel",void 0);q([p.property()],b.prototype,"cursor",void 0);q([p.property({value:!0})],b.prototype,"editable",null);q([p.property({dependsOn:["view","view.spatialReference"],readOnly:!0})],b.prototype,"projectionEngineRequired",null);q([p.property({readOnly:!0})],b.prototype,"projectionEngineSupported",
null);return b=x=q([p.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],b)}(p.declared(I.InteractiveToolBase))});