// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../Graphic ../../symbols ../../core/Handles ../../core/promiseUtils ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/Point ../../geometry/Polyline ../../geometry/projection ../../geometry/SpatialReference ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../views/2d/draw/Draw ../../views/interactive/GraphicManipulator ../../views/interactive/InteractiveToolBase ../../views/interactive/interactiveToolUtils".split(" "),
function(F,G,w,k,n,m,x,y,d,p,t,z,l,u,g,v,A,B,C,q){function D(d,b,l,a){var E=new m.SimpleMarkerSymbol({style:"circle",color:a.handleColor,size:a.handleWidth,outline:{type:"simple-line",width:0}});a=new m.SimpleMarkerSymbol({style:"circle",color:a.handleColor,size:1.5*a.handleWidth,outline:{type:"simple-line",width:0}});d=new n({geometry:d,symbol:E});return new B.GraphicManipulator({view:b,layer:l,graphic:d,focusedSymbol:a})}return function(m){function b(a){a=m.call(this,a)||this;a._drawActive=!1;a._handles=
new x;a._polylineLayer=new v({listMode:"hide"});a._manipulatorLayer=new v({listMode:"hide"});a._vertices=[];return a}w(b,m);r=b;b.prototype.initialize=function(){var a=this,b=this.view;this._draw=new A({view:b});b.map.addMany([this._polylineLayer,this._manipulatorLayer]);b.focus();this._handles.add([this.watch("viewModel.unit",function(){0<a._vertices.length&&a._updatePolylines()}),this.watch("projectionEngineRequired",function(b){b&&a._loadProjectionEngine()})]);this.projectionEngineRequired&&this._loadProjectionEngine()};
b.prototype.destroy=function(){this.detach();this._handles.removeAll();this._polylineLayer.removeAll();var a=this.viewModel,b=a.view.map;b.remove(this._polylineLayer);b.remove(this._manipulatorLayer);a.measurement=null;this._draw&&(this._draw.destroy(),this._draw=null);this._handles&&(this._handles.destroy(),this._handles=null);this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null);this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)};Object.defineProperty(b.prototype,
"editable",{set:function(a){this._set("editable",a);a||this._draw.reset()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"projectionEngineRequired",{get:function(){var a=this.view;if(!a)return!1;a=a.spatialReference;if(!a)return!1;var b=a.isGeographic,e=a.isWebMercator,h=a.isWGS84;return b&&!h&&!g.isSupported(a)||!b&&!e},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"projectionEngineSupported",{get:function(){return l.isSupported()},enumerable:!0,configurable:!0});
b.prototype.onShow=function(){this._polylineLayer.visible=!0};b.prototype.onHide=function(){this._polylineLayer.visible=!1};b.prototype.reset=function(){this._vertices=[];this._polylineLayer.removeAll();this.viewModel.measurement=null;this._draw.reset();this._drawActive=!1;this._updateSketch([])};b.prototype.newMeasurement=function(){this.reset();q.setActive(this,!0);this._startSketch()};b.prototype.clearMeasurement=function(){this.reset();q.setActive(this,!1);this.cursor=null};b.updateViewModelAndCreateGraphics=
function(a,b){var e=b.geodesicDistanceThreshold,h=b.palette,f=b.view.spatialReference;a=new z({paths:[a],spatialReference:f});if(f.isGeographic)if(g.isSupported(f))e=g.geodesicLengths([a],"meters")[0],f=g.geodesicDensify(a,1E5);else var e=l.project(a,u.WGS84),c=g.geodesicDensify(e,1E5),e=g.geodesicLengths([e],"meters")[0],f=l.project(c,f);else f.isWebMercator?(e=p.geodesicLength(a,"meters"),f=p.geodesicDensify(a,1E5,"meters")):(c=p.planarLength(a,"meters"),c>=e?(e=l.project(a,u.WGS84),c=g.geodesicDensify(e,
1E5),e=g.geodesicLengths([e],"meters")[0],f=l.project(c,f)):(e=c,f=a));b.measurement={geometry:f,length:e};e=h.pathSecondaryColor;c=h.pathWidth;return[new n({geometry:f,symbol:{type:"simple-line",cap:"butt",join:"round",color:h.pathPrimaryColor,width:c}}),new n({geometry:f,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:e,width:c-2}}),new n({geometry:a.extent.center,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:b.measurementLabel,font:{size:14,
family:"sans-serif"}}})]};b.prototype.onInputEvent=function(a){"pointer-move"===a.type&&this._updateCursor()};b.prototype._loadProjectionEngine=function(){return this.projectionEngineSupported&&!l.isLoaded()?l.load():y.resolve()};b.prototype._startSketch=function(){var a=this;this._drawActive=!0;var b=this._draw.create("polyline",{mode:"click"});b.on("vertex-add vertex-update vertex-remove cursor-update undo redo".split(" "),function(b){return a._updateSketch(b.vertices)});b.on("draw-complete",function(){return a._stopSketch()})};
b.prototype._stopSketch=function(){this.manipulators.forEach(function(a){a.manipulator.interactive=!0});q.setActive(this,!1);this._drawActive=!1};b.prototype._updateSketch=function(a){var b=this;if(!this.projectionEngineRequired||l.isLoaded())if(2>a.length)this._vertices=[],this.manipulators.removeAll(),this._polylineLayer.removeAll();else{for(var e=this.view.spatialReference;this._vertices.length>a.length;){var h=this._vertices.pop().manipulatorId;this.manipulators.remove(h)}for(var h=function(d){var c=
a[d],g=c[0],c=c[1],h=new t({x:g,y:c,spatialReference:e}),k=D(h,f.view,f._manipulatorLayer,f.viewModel.palette),h=f.manipulators.add(k);k.on("drag",function(){var a=k.graphic.geometry;b._vertices[d].coord=[a.x,a.y];b._updatePolylines()});f._vertices.push({manipulatorId:h,coord:[g,c]})},f=this,c=this._vertices.length;c<a.length;c++)h(c);var h=this._vertices.length-1,c=this._vertices[h],d=a[h],g=d[0],d=d[1];if(c.coord[0]!==g||c.coord[1]!==d)c.coord=[g,d],g=new t({x:g,y:d,spatialReference:e}),this.manipulators.findById(c.manipulatorId).graphic.geometry=
g;var k=this._drawActive?this._vertices[h].manipulatorId:null;this.manipulators.forEach(function(a){a.manipulator.interactive=null==k||a.id!==k});this._updatePolylines()}};b.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null};b.prototype._updatePolylines=function(){this._polylineLayer.removeAll();var a=this.viewModel,b=this._vertices.map(function(a){return a.coord});(a=r.updateViewModelAndCreateGraphics(b,a))&&this._polylineLayer.addMany(a)};var r;k([d.property({constructOnly:!0})],
b.prototype,"view",void 0);k([d.property({constructOnly:!0})],b.prototype,"viewModel",void 0);k([d.property()],b.prototype,"cursor",void 0);k([d.property({value:!0})],b.prototype,"editable",null);k([d.property({dependsOn:["view","view.spatialReference"],readOnly:!0})],b.prototype,"projectionEngineRequired",null);k([d.property({readOnly:!0})],b.prototype,"projectionEngineSupported",null);return b=r=k([d.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],b)}(d.declared(C.InteractiveToolBase))});