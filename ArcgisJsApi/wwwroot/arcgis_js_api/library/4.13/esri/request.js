// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ./core/tsSupport/assignHelper ./core/tsSupport/awaiterHelper ./core/tsSupport/generatorHelper @dojo/framework/shim/global ./config ./kernel ./core/Error ./core/has ./core/lang ./core/promiseUtils ./core/string ./core/urlUtils @dojo/framework/shim/Promise".split(" "),function(E,ha,K,u,D,z,A,v,H,B,L,C,T,n){function w(a,b){var c=C.createAbortController();return C.create(function(d,h){U(c.signal,a,b).then(d).catch(h)},function(){c.abort()})}function U(a,b,c){return u(this,void 0,
void 0,function(){var d,h,e,f,k,g,l,m;return D(this,function(t){switch(t.label){case 0:return d=n.isDataProtocol(b),(h=n.isBlobProtocol(b))||d||(b=n.normalize(b)),e={url:b,requestOptions:K({},c)},(f=n.getInterceptor(b))?[4,V(f,e)]:[3,2];case 1:k=t.sent();if(null!=k)return[2,{data:k,getHeader:I,requestOptions:e.requestOptions,url:e.url}];f.after||f.error||(f=null);t.label=2;case 2:b=e.url;c=e.requestOptions;if("image"===c.responseType){if(B("host-webworker"))throw x("request:invalid-parameters",Error("responseType 'image' is not supported in Web Workers or Node environment"),
e);}else if(d)throw x("request:invalid-parameters",Error("Data URLs are not supported for responseType \x3d "+c.responseType),e);if("head"===c.method){if(c.body)throw x("request:invalid-parameters",Error("body parameter cannot be set when method is 'head'"),e);if(d||h)throw x("request:invalid-parameters",Error("data and blob URLs are not supported for method 'head'"),e);}return[4,W()];case 3:t.sent();if(F)return[2,F.execute(b,c)];g=C.createAbortController();C.onAbort(a,function(){return g.abort()});
C.onAbort(c,function(){return g.abort()});l={controller:g,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:f,params:e,redoRequest:!1,useIdentity:A.request.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1};return[4,X(l)];case 4:return m=t.sent(),f&&f.after&&f.after(m),[2,m]}})})}function Y(a){n.isBlobProtocol(a)||n.isDataProtocol(a)||(a=n.getOrigin(a))&&-1===w._corsServers.indexOf(a)&&w._corsServers.push(a)}function Z(a){a=n.getOrigin(a);return!a||T.endsWith(a,".arcgis.com")||
-1!==w._corsServers.indexOf(a)||n.isTrustedServer(a)}function M(){var a;try{a=new DOMException("Aborted","AbortError")}catch(b){a=Error("Aborted"),a.name="AbortError"}return a}function x(a,b,c,d){var h="Error",e={url:c.url,requestOptions:c.requestOptions,getHeader:I,ssl:!1};if(b instanceof H)return b.details?(b.details=L.clone(b.details),b.details.url=c.url,b.details.requestOptions=c.requestOptions):b.details=e,b;if(b){c=d&&function(a){return d.headers.get(a)};var f=d&&d.status,k=b.message;k&&(h=
k);c&&(e.getHeader=c);e.httpStatus=(null!=b.httpCode?b.httpCode:b.code)||f||0;e.subCode=b.subcode;e.messageCode=b.messageCode;e.messages="string"===typeof b.details?[b.details]:b.details}a=new H(a,h,e);b&&"cancel"===b.dojoType&&(a.dojoType="cancel");return a}function W(){return u(this,void 0,void 0,function(){var a;return D(this,function(b){switch(b.label){case 0:return B("host-webworker")?F?[3,2]:[4,new Promise(function(a,b){E(["./core/workers/request"],a,b)})]:[3,3];case 1:F=b.sent(),b.label=2;
case 2:return[3,6];case 3:if(w._abortableFetch)return[3,6];if(!B("esri-abortable-fetch")||!B("esri-native-promise")&&(13>B("safari")||13>B("ios")))return[3,4];w._abortableFetch=z.default.fetch.bind(z.default);return[3,6];case 4:return a=w,[4,new Promise(function(a,b){E(["whatwg-fetch"],a,b)})];case 5:a._abortableFetch=b.sent().fetch,b.label=6;case 6:return[2]}})})}function J(){return u(this,void 0,void 0,function(){return D(this,function(a){switch(a.label){case 0:return v.id?[3,2]:[4,new Promise(function(a,
c){E(["./identity/IdentityManager"],a,c)})];case 1:a.sent(),a.label=2;case 2:return[2]}})})}function aa(a){return u(this,void 0,void 0,function(){var b,c,d,h,e,f,k,g;return D(this,function(l){switch(l.label){case 0:b=a.params.url;c=a.params.requestOptions;d=a.controller.signal;h=c.body;k=f=e=null;P&&"HTMLFormElement"in z.default&&(h instanceof FormData?e=h:h instanceof HTMLFormElement&&(f=h,e=new FormData(f)));"string"===typeof h&&(k=h);a.fetchOptions={cache:c.cacheBust&&!w._abortableFetch.polyfill?
"no-cache":"default",credentials:"same-origin",headers:c.headers||{},method:"head"===c.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:d};if(e||k)a.fetchOptions.body=e||k;"anonymous"===c.authMode&&(a.useIdentity=!1);a.hasToken=!!(/token=/i.test(b)||c.query&&c.query.token||e&&e.get&&e.get("token")||f&&f.elements.token);if(!a.useIdentity||a.hasToken||a.credentialToken||Q(b)||C.isAborted(d))return[3,11];g=void 0;return"immediate"!==c.authMode?[3,3]:[4,J()];case 1:return l.sent(),[4,v.id.getCredential(b,
{signal:d})];case 2:return g=l.sent(),a.credential=g,[3,10];case 3:return"no-prompt"!==c.authMode?[3,9]:[4,J()];case 4:l.sent(),l.label=5;case 5:return l.trys.push([5,7,,8]),[4,v.id.getCredential(b,{prompt:!1,signal:d})];case 6:return g=l.sent(),a.credential=g,[3,8];case 7:return l.sent(),[3,8];case 8:return[3,10];case 9:v.id&&(g=v.id.findCredential(b)),l.label=10;case 10:g&&(a.credentialToken=g.token,a.useSSL=!!g.ssl),l.label=11;case 11:return[2]}})})}function Q(a){return ba.some(function(b){return b.test(a)})}
function ca(a){return u(this,void 0,void 0,function(){var b,c,d,h,e,f,k,g,l,m,t,r,u,z,F,G,E,y,q,H,I,J,L,M,O,N;return D(this,function(p){switch(p.label){case 0:b=a.params.url;c=a.params.requestOptions;d=a.fetchOptions;h=n.isBlobProtocol(b)||n.isDataProtocol(b);e=c.responseType||"json";f=h?0:null!=c.timeout?c.timeout:A.request.timeout;k=!1;if(!h){a.useSSL&&(b=n.toHTTPS(b));c.cacheBust&&"default"===d.cache&&(b=n.addQueryParameter(b,"request.preventCache",Date.now()));g=K({},c.query);a.credentialToken&&
(g.token=a.credentialToken);l=n.objectToQuery(g);B("esri-url-encodes-apostrophe")&&(l=l.replace(/'/g,"%27"));m=b.length+1+l.length;t=void 0;k="post"===c.method||!!c.body||m>A.request.maxUrlLength;if(r=c.useProxy||!!n.getProxyRule(b))u=n.getProxyUrl(b),t=u.path,!k&&t.length+1+m>A.request.maxUrlLength&&(k=!0),u.query&&(g=K({},u.query,g));if("HEAD"===d.method&&(k||r)){if(k){if(m>A.request.maxUrlLength)throw x("request:invalid-parameters",Error("URL exceeds maximum length"),a.params);throw x("request:invalid-parameters",
Error("cannot use POST request when method is 'head'"),a.params);}if(r)throw x("request:invalid-parameters",Error("cannot use proxy when method is 'head'"),a.params);}k?(d.method="POST",c.body?b=n.addQueryParameters(b,g):(d.body=n.objectToQuery(g),d.headers["Content-Type"]="application/x-www-form-urlencoded")):b=n.addQueryParameters(b,g);r&&(a.useProxy=!0,b=t+"?"+b);g.token&&P&&d.body instanceof FormData&&(z=d.body,z.set?z.set("token",g.token):z.append("token",g.token));c.hasOwnProperty("withCredentials")?
a.withCredentials=c.withCredentials:n.isTrustedServer(b)?a.withCredentials=!0:v.id&&(F=v.id.findServerInfo(b))&&F.webTierAuth&&(a.withCredentials=!0);a.withCredentials&&(d.credentials="include")}G=0;E=!1;0<f&&(G=setTimeout(function(){E=!0;a.controller.abort()},f));p.label=1;case 1:return p.trys.push([1,24,25,26]),"image"!==c.responseType||"default"!==d.cache||"GET"!==d.method||k||da(c.headers)||!h&&!a.useProxy&&A.request.proxyUrl&&!Z(b)?[3,3]:[4,R(b,a)];case 2:return q=p.sent(),[3,23];case 3:return[4,
w._abortableFetch(b,d)];case 4:y=p.sent();a.useProxy||Y(b);if(!y.ok||"HEAD"===d.method)return[3,23];H=e;switch(H){case "array-buffer":return[3,5];case "blob":return[3,7];case "image":return[3,7];case "document":return[3,9];case "json":return[3,11];case "xml":return[3,13]}return[3,15];case 5:return[4,y.arrayBuffer()];case 6:return q=p.sent(),[3,17];case 7:return[4,y.blob()];case 8:return q=p.sent(),[3,17];case 9:return I=S,[4,y.text()];case 10:return q=I.apply(void 0,[p.sent(),"text/html"]),[3,17];
case 11:return[4,y.text()];case 12:return J=p.sent(),q=JSON.parse(J||null),[3,17];case 13:return L=S,[4,y.text()];case 14:return q=L.apply(void 0,[p.sent(),"application/xml"]),[3,17];case 15:return[4,y.text()];case 16:return q=p.sent(),[3,17];case 17:G&&(clearTimeout(G),G=0);M=y.headers.get("Content-Type");if(!/application\/json|text\/plain/i.test(M)||!(q instanceof ArrayBuffer&&750>=q.byteLength||q instanceof Blob&&750>=q.size))return[3,21];p.label=18;case 18:return p.trys.push([18,20,,21]),[4,(new Response(q)).json()];
case 19:return O=p.sent(),O.error&&(q=O),[3,21];case 20:return p.sent(),[3,21];case 21:return"image"===e&&q instanceof Blob?[4,R(URL.createObjectURL(q),a,!0)]:[3,23];case 22:q=p.sent(),p.label=23;case 23:return[3,26];case 24:N=p.sent();if("AbortError"===N.name){if(E)throw Error("Timeout exceeded");throw C.createAbortError("Request canceled");}if(!y&&N instanceof TypeError&&A.request.proxyUrl&&!c.body&&"post"!==c.method&&"head"!==c.method&&!a.useProxy)a.redoRequest=!0,n.addProxyRule({proxyUrl:A.request.proxyUrl,
urlPrefix:n.removeFile(n.urlToObject(b).path)});else throw N;return[3,26];case 25:return G&&clearTimeout(G),[7];case 26:return[2,[y,q]]}})})}function V(a,b){return u(this,void 0,void 0,function(){var c,d,h;return D(this,function(e){switch(e.label){case 0:if(null!=a.responseData)return[2,a.responseData];a.headers&&(b.requestOptions.headers=K({},b.requestOptions.headers,a.headers));a.query&&(b.requestOptions.query=K({},b.requestOptions.query,a.query));if(!a.before)return[3,5];d=c=void 0;e.label=1;case 1:return e.trys.push([1,
3,,4]),[4,a.before(b)];case 2:return d=e.sent(),[3,4];case 3:return h=e.sent(),c=x("request:interceptor",h,b),[3,4];case 4:if(d instanceof Error||d instanceof H)c=x("request:interceptor",d,b);if(c)throw a.error&&a.error(c),c;return[2,d];case 5:return[2]}})})}function da(a){if(a)for(var b=0,c=Object.getOwnPropertyNames(a);b<c.length;b++)if(a[c[b]])return!0;return!1}function S(a,b){var c;try{c=(new DOMParser).parseFromString(a,b)}catch(d){}if(!c||c.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");
return c}function X(a){return u(this,void 0,void 0,function(){var b,c,d,h,e,f,k,g,l,m,t;return D(this,function(r){switch(r.label){case 0:return[4,aa(a)];case 1:r.sent(),r.label=2;case 2:r.trys.push([2,8,,9]),r.label=3;case 3:return[4,ca(a)];case 4:b=r.sent(),c=b[0],d=b[1],r.label=5;case 5:return[4,ea(a,c,d)];case 6:if(!r.sent())return[3,3];r.label=7;case 7:return[3,9];case 8:throw h=r.sent(),e=x("request:server",h,a.params,c),e.details.ssl=a.useSSL,a.interceptor&&a.interceptor.error&&a.interceptor.error(e),
e;case 9:return f=a.params.url,/\/sharing\/rest\/(accounts|portals)\/self/i.test(f)&&!a.hasToken&&!a.credentialToken&&d&&d.user&&d.user.username&&!n.isTrustedServer(f)&&(k=n.getOrigin(f,!0))&&A.request.trustedServers.push(k),(g=a.credential)&&v.id&&(m=(l=v.id.findServerInfo(g.server))&&l.owningSystemUrl)&&(m=m.replace(/\/?$/,"/sharing"),(t=v.id.findCredential(m,g.userId))&&-1===v.id._getIdenticalSvcIdx(m,t)&&t.resources.unshift(m)),[2,{data:d,getHeader:c?function(a){return c.headers.get(a)}:I,requestOptions:a.params.requestOptions,
ssl:a.useSSL,url:a.params.url}]}})})}function ea(a,b,c){return u(this,void 0,void 0,function(){var d,h,e,f,k,g,l;return D(this,function(m){switch(m.label){case 0:if(a.redoRequest)return a.redoRequest=!1,[2,!1];if(!b)return[2,!0];if(!b.ok)throw Error("Unable to load "+b.url+" status: "+b.status);c&&c.error&&(d=L.mixin(Error(),c.error));d&&(h=Number(d.code),e=d.hasOwnProperty("subcode")?Number(d.subcode):null,f=(f=d.messageCode)&&f.toUpperCase());k=a.params.requestOptions.authMode;return 403===h&&(4===
e||d.message&&-1<d.message.toLowerCase().indexOf("ssl")&&-1===d.message.toLowerCase().indexOf("permission"))?a.useSSL?[3,6]:(a.useSSL=!0,[2,!1]):[3,1];case 1:return!a.useIdentity||"no-prompt"===k&&498!==h||-1===fa.indexOf(h)||Q(a.params.url)||!(403!==h||-1===ga.indexOf(f)&&(null==e||2===e&&a.credentialToken))?[3,6]:[4,J()];case 2:m.sent(),m.label=3;case 3:return m.trys.push([3,5,,6]),[4,v.id.getCredential(a.params.url,{error:x("request:server",d,a.params),prompt:"no-prompt"!==k,signal:a.controller.signal,
token:a.credentialToken})];case 4:return g=m.sent(),a.credential=g,a.credentialToken=g.token,a.useSSL=a.useSSL||g.ssl,[2,!1];case 5:l=m.sent();if("no-prompt"===k)return a.credential=null,a.credentialToken=null,[2,!1];d=l;return[3,6];case 6:if(d)throw d;return[2,!0]}})})}function R(a,b,c){void 0===c&&(c=!1);return C.create(function(d,h){var e=b.controller.signal;if(C.isAborted(e))return h(M());var f=new Image;f.crossOrigin=b.withCredentials?"use-credentials":"anonymous";var k=function(){m();h(Error("Unable to load "+
a))},g=function(){m();d(f)},l=function(){m();f.src="";h(M())},m=function(){B("esri-image-decode")||(f.removeEventListener("error",k),f.removeEventListener("load",g));e.removeEventListener("abort",l);c&&URL.revokeObjectURL(a)};f.alt="";f.src=a;B("esri-image-decode")?f.decode().then(g,k):(f.addEventListener("error",k),f.addEventListener("load",g));e.addEventListener("abort",l)})}var F,P="FormData"in z.default,fa=[499,498,403,401],ga=["COM_0056","COM_0057","SB_0008"],ba=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,
/\/rest\/info/i],I=function(){return null};w._abortableFetch=null;w._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];return w});