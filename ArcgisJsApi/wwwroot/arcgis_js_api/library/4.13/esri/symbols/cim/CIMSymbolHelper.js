// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../Color ../../core/Logger ../../geometry/support/jsonUtils ../cim/CIMCursor ../cim/CIMEffects ../cim/CIMOperators ../cim/CIMPlacements ./CIMSymbolDrawHelper ./packingUtils".split(" "),function(l,q,B,C,t,u,x,D,y,v,E){function w(e,b){switch(b.type){case "CIMSymbolReference":var a={type:"point",x:0,y:0};e.drawSymbol(b.symbol,a);break;case "CIMPointSymbol":a={type:"point",x:0,y:0};e.drawSymbol(b,a);break;case "CIMVectorMarker":a=new y.Placement,e.drawMarker(b,a)}return e.envelope()}
Object.defineProperty(q,"__esModule",{value:!0});var z=Math.PI,F=z/2,A=C.getLogger("esri.symbols.cim.CIMSymbolHelper");l=function(){function e(){}e.getEnvelope=function(b){var a=new v.EnvDrawHelper;if(Array.isArray(b)){for(var d=void 0,c=0;c<b.length;c++){var g=b[c];d?d.union(w(a,g)):d=w(a,g)}return d}return w(a,b)};e.getTextureAnchor=function(b){b=this.getEnvelope(b);if(!b||0>=b.width||0>=b.height)return[0,0];var a=96/72;return[(b.x+.5*b.width)*a/(b.width*a+2),-(b.y+.5*b.height)*a/(b.height*a+2)]};
e.rasterize=function(b,a,d){void 0===d&&(d=!0);var c=this.getEnvelope(a);if(!c||0>=c.width||0>=c.height)return[null,0,0];var g=96/72,f=(c.x+.5*c.width)*g,e=-(c.y+.5*c.height)*g;b.width=c.width*g+2;b.height=c.height*g+2;c=b.getContext("2d");g=v.Transformation.createScale(g,-g);g.translate(.5*b.width-f,.5*b.height-e);f=new v.CanvasDrawHelper(c,g);switch(a.type){case "CIMPointSymbol":f.drawSymbol(a,{type:"point",x:0,y:0});break;case "CIMVectorMarker":e=new y.Placement,f.drawMarker(a,e)}a=c.getImageData(0,
0,b.width,b.height);a=new Uint8Array(a.data);if(d)for(d=void 0,c=0;c<a.length;c+=4)d=a[c+3]/255,a[c]*=d,a[c+1]*=d,a[c+2]*=d;return[a,b.width,b.height]};e.fromSimpleMarker=function(b){var a,d,c=b.style;if("circle"===c||"esriSMSCircle"===c){a=Math.acos(.995);d=Math.ceil(z/a/4);0===d&&(d=1);a=F/d;d*=4;c=[];c.push([50,0]);for(var g=1;g<d;g++)c.push([50*Math.cos(g*a),-50*Math.sin(g*a)]);c.push([50,0]);a={rings:[c]};d={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===c||"esriSMSCross"===c)a=0,a={rings:[[[a,
50],[a,a],[50,a],[50,-a],[a,-a],[a,-50],[-a,-50],[-a,-a],[-50,-a],[-50,a],[-a,a],[-a,50],[a,50]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("diamond"===c||"esriSMSDiamond"===c)a={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===c||"esriSMSSquare"===c)a={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===c||"esriSMSX"===c)a=0,a={rings:[[[0,a],[50-a,50],[50,50-a],[a,0],[50,a-50],[50-
a,-50],[0,-a],[a-50,-50],[-50,a-50],[-a,0],[-50,50-a],[a-50,50],[0,a]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("triangle"===c||"esriSMSTriangle"===c)d=2/3*100,c=d-100,a={rings:[[[-57.735026918962575,c],[0,d],[57.735026918962575,c],[-57.735026918962575,c]]]},d={xmin:-57.735026918962575,ymin:c,xmax:57.735026918962575,ymax:d};var f;a&&d&&(f=[{type:"CIMSolidFill",enable:!0,color:b.color}],b.outline&&f.push({type:"CIMSolidStroke",enable:!0,width:b.outline.width,color:b.outline.color}),f={type:"CIMPointSymbol",
symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:b.angle,size:b.size,offsetX:b.xoffset,offsetY:b.yoffset,frame:d,markerGraphics:[{type:"CIMMarkerGraphic",geometry:a,symbol:{type:"CIMPolygonSymbol",symbolLayers:f}}]}]});return f};e.getFillColor=function(b){if(!b)return null;switch(b.type){case "CIMPolygonSymbol":if(b.symbolLayers){var a=0;for(b=b.symbolLayers;a<b.length;a++){var d=e.getFillColor(b[a]);if(null!=d)return d}}break;case "CIMTextSymbol":return e.getFillColor(b.symbol);case "CIMSolidFill":return b.color}};
e.getStrokeColor=function(b){if(b)switch(b.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(b.symbolLayers){var a=0;for(b=b.symbolLayers;a<b.length;a++){var d=e.getStrokeColor(b[a]);if(void 0!==d)return d}}break;case "CIMTextSymbol":return e.getStrokeColor(b.symbol);case "CIMSolidStroke":return b.color}};e.getStrokeWidth=function(b){if(b)switch(b.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(b.symbolLayers){var a=0;for(b=b.symbolLayers;a<b.length;a++){var d=e.getStrokeWidth(b[a]);if(void 0!==
d)return d}}break;case "CIMTextSymbol":return e.getStrokeWidth(b.symbol);case "CIMSolidStroke":case "CIMGradientStroke":case "CIMPictureStroke":return b.width}};e.getSize=function(b){if(b)switch(b.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":var a=0;if(b.symbolLayers){var d=0;for(b=b.symbolLayers;d<b.length;d++){var c=e.getSize(b[d]);c>a&&(a=c)}}return a;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":return b.width;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":return b.size}};
e.getMarkerScaleRatio=function(b){if(b)switch(b.type){case "CIMVectorMarker":if(!1!==b.scaleSymbolsProportionally&&b.frame)return b.size/(b.frame.ymax-b.frame.ymin)}return 1};e.executeEffects=function(b,a,d){void 0===d&&(d=!1);var c=96/72,g=b?b.length:0;g&&d&&--g;for(d=0;d<g;++d){var f=b[d];if(f){var e=D.getEffectOperator(f);e&&(a=e.execute(a,f,c))}}return a};e.processEffects=function(b,a,d){var c;b.effects&&0<b.effects.length&&(c=u.deltaEncodeGeometry(d),c=new x.SimpleGeometryCursor(c),c=e.executeEffects(b.effects,
c));b=b.symbolLayers[a];b.effects&&0<b.effects.length&&(a=!1,"CIMGeometricEffectDashes"===b.effects[b.effects.length-1].type&&(a=!0),c||(c=u.deltaEncodeGeometry(d),c=new x.SimpleGeometryCursor(c)),c=e.executeEffects(b.effects,c,a));if(!c)return d;d=[];for(b=c.next();b;)d.push(b),b=c.next();c=d.length;switch(c){case 0:return null;case 1:return u.deltaEncodeGeometry(d[0]);default:b=d[0];for(a=1;a<c;++a){var g=d[a];t.isPolygon(b)&&t.isPolygon(g)&&Array.prototype.push.apply(b.rings,g.rings);t.isPolyline(b)&&
t.isPolyline(g)&&Array.prototype.push.apply(b.paths,g.paths)}return u.deltaEncodeGeometry(b)}};return e}();q.CIMSymbolHelper=l;l=function(){function e(){}e.rasterizeSimpleFill=function(b,a){"solid"!==a&&"none"!==a&&"esriSFSSolid"!==a&&"esriSFSNull"!==a||console.error("Unexpected: style does not require rasterization");b.width=8;b.height=8;var d=b.getContext("2d");d.strokeStyle="#FFFFFF";d.lineWidth=1;d.beginPath();if("vertical"===a||"cross"===a||"esriSFSCross"===a||"esriSFSVertical"===a)d.moveTo(0,
0),d.lineTo(0,8);if("horizontal"===a||"cross"===a||"esriSFSCross"===a||"esriSFSHorizontal"===a)d.moveTo(0,0),d.lineTo(8,0);if("forward-diagonal"===a||"diagonal-cross"===a||"esriSFSDiagonalCross"===a||"esriSFSForwardDiagonal"===a)d.moveTo(0,0),d.lineTo(8,8);if("backward-diagonal"===a||"diagonal-cross"===a||"esriSFSBackwardDiagonal"===a||"esriSFSDiagonalCross"===a)d.moveTo(8,0),d.lineTo(0,8);d.stroke();a=d.getImageData(0,0,b.width,b.height);a=new Uint8Array(a.data);for(var c=0;c<a.length;c+=4)d=a[c+
3]/255,a[c]*=d,a[c+1]*=d,a[c+2]*=d;return[a,b.width,b.height]};e.rasterizeSimpleLine=function(b,a,d){switch(d){case "butt":d="Butt";break;case "square":d="Square";break;default:d="Round"}var c="Butt"===d;switch(a){case "dash":case "esriSLSDash":a=c?[4,3]:[3,4];break;case "dash-dot":case "esriSLSDashDot":a=c?[4,3,1,3]:[3,4,0,4];break;case "dot":case "esriSLSDot":a=c?[1,3]:[0,4];break;case "long-dash":case "esriSLSLongDash":a=c?[8,3]:[7,4];break;case "long-dash-dot":case "esriSLSLongDashDot":a=c?[8,
3,1,3]:[7,4,0,4];break;case "long-dash-dot-dot":case "esriSLSDashDotDot":a=c?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case "short-dash":case "esriSLSShortDash":a=c?[4,1]:[3,2];break;case "short-dash-dot":case "esriSLSShortDashDot":a=c?[4,1,1,1]:[3,2,0,2];break;case "short-dash-dot-dot":case "esriSLSShortDashDotDot":a=c?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case "short-dot":case "esriSLSShortDot":a=c?[1,1]:[0,2];break;case "solid":case "esriSLSSolid":case "none":A.error("Unexpected: style does not require rasterization");
a=[0,0];break;default:A.error("Tried to rasterize SLS, but found an unexpected style: "+a+"!"),a=[0,0]}return this.rasterizeDash(b,a,d)};e.rasterizeDash=function(b,a,d){b="Butt"===d;var c="Square"===d;d=!b&&!c;for(var g=0,f=0;f<a.length;f++)var e=a[f],g=g+e;for(var g=15*g,m=31*g,f=new Float32Array(m),h=d?225:15,e=0;e<m;++e)f[e]=h;for(var h=m=0,l=!0,q=0;q<a.length;q++){for(var e=a[q],m=h,h=h+15*e,n=m;n<h;){for(var r=0;31>r;){var e=r*g+n,p=d?(r-15)*(r-15):Math.abs(r-15);f[e]=l?b?Math.max(Math.max(m+
7.5-n,p),Math.max(n-h+7.5,p)):p:d?Math.min((n-m)*(n-m)+p,(n-h)*(n-h)+p):c?Math.min(Math.max(n-m,p),Math.max(h-n,p)):Math.min(Math.max(n-m+7.5,p),Math.max(h+7.5-n,p));r++}n++}l=!l}a=f.length;b=new Uint8Array(4*a);for(e=0;e<a;++e)E.packFloatRGBA((d?Math.sqrt(f[e]):f[e])/15,b,4*e);return[b,g,31]};return e}();q.SymbolHelper=l;l=function(){function e(){}e.findApplicableOverrides=function(b,a,d){if(a){if(b.primitiveName){for(var c=!1,g=0;g<d.length;g++){var f=d[g];if(f.primitiveName===b.primitiveName){c=
!0;break}}if(!c)for(c=0;c<a.length;c++)f=a[c],f.primitiveName===b.primitiveName&&d.push(f)}switch(b.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(b.effects)for(c=0,g=b.effects;c<g.length;c++)f=g[c],e.findApplicableOverrides(f,a,d);if(b.symbolLayers)for(f=0,b=b.symbolLayers;f<b.length;f++)e.findApplicableOverrides(b[f],a,d);break;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":case "CIMSolidFill":case "CIMPictureFill":case "CIMHatchFill":case "CIMGradientFill":case "CIMVectorMarker":case "CIMCharacterMarker":case "CIMPictureMarker":if(b.effects)for(c=
0,g=b.effects;c<g.length;c++)f=g[c],e.findApplicableOverrides(f,a,d);b.markerPlacement&&e.findApplicableOverrides(b.markerPlacement,a,d);if("CIMVectorMarker"===b.type){if(b.markerGraphics)for(f=0,b=b.markerGraphics;f<b.length;f++)c=b[f],e.findApplicableOverrides(c,a,d),e.findApplicableOverrides(c.symbol,a,d)}else"CIMCharacterMarker"===b.type?e.findApplicableOverrides(b.symbol,a,d):"CIMHatchFill"===b.type&&e.findApplicableOverrides(b.lineSymbol,a,d)}}};e.applyOverrides=function(b,a,d,c){if(a){if(b.primitiveName)for(var g=
0;g<a.length;g++){var f=a[g];if(f.primitiveName===b.primitiveName){var k;k=(k=f.propertyName)?k.charAt(0).toLowerCase()+k.substr(1):k;c&&c.push({cim:b,nocapPropertyName:k,value:b[k]});f.expression&&(f.value=e.toValue(f.propertyName,f.expression));if(d){for(var m=!1,h=0,l=d;h<l.length;h++)l[h].primitiveName===b.primitiveName&&(m=!0);m||d.push(f)}b[k]=f.value}}switch(b.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(b.effects)for(f=0,k=b.effects;f<k.length;f++)g=k[f],e.applyOverrides(g,
a,d,c);if(b.symbolLayers)for(g=0,b=b.symbolLayers;g<b.length;g++)e.applyOverrides(b[g],a,d,c);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(b.effects)for(f=0,k=b.effects;f<k.length;f++)g=k[f],e.applyOverrides(g,a,d,c);if("CIMVectorMarker"===b.type&&b.markerGraphics)for(g=0,b=b.markerGraphics;g<b.length;g++)f=b[g],e.applyOverrides(f,a,d,c),e.applyOverrides(f.symbol,a,d,c)}}};e.restoreOverrides=function(b){for(var a=0;a<b.length;a++){var d=b[a];d.cim[d.nocapPropertyName]=
d.value}};e.buildOverrideKey=function(b){for(var a="",d=0;d<b.length;d++){var c=b[d];void 0!==c.value&&(a+=""+c.primitiveName+c.propertyName+JSON.stringify(c.value))}return a};e.toValue=function(b,a){return"DashTemplate"===b?a.split(" ").map(function(a){return Number(a)}):"Color"===b?(b=(new B(a)).toRgba(),b[3]*=255,b):a};return e}();q.OverrideHelper=l});