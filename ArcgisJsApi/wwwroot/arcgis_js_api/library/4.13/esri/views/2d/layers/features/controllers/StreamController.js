// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/asyncUtils ../../../../../core/Error ../../../../../core/has ../../../../../core/iteratorUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/executeTileQuery ../../../../../layers/graphics/data/StreamStore ../../../../../layers/graphics/sources/connections/GeoEventConnection ./BaseController ./support/DispatchQueue".split(" "),
function(q,r,B,g,J,m,n,l,C,K,D,k,v,h,E,w,F,G,H,I){Object.defineProperty(r,"__esModule",{value:!0});q=function(p){function b(){var a=null!==p&&p.apply(this,arguments)||this;a.type="stream";a._tileDispatchMap=new Map;a._updateIntervalId=0;return a}B(b,p);b.prototype.initialize=function(){var a=this,c=this.service,b=c.objectIdField,e=c.timeInfo,f=c.maximumTrackPoints,d=c.purgeOptions;this.connection=new G.default(c.source,this.spatialReference,c.serviceFilter);this._set("store",new F.default(b,e,this.geometryInfo,
f,d));this.connection.on("feature",function(c){return a._onFeature(c)});this.store.events.on("update",function(c){return a._onUpdate(c.addOrUpdated,c.removed)});["connectionStatus","errorString"].forEach(function(c){a.watch("connection."+c,function(b){return a.remoteClient.invoke("setProperty",{propertyName:c,value:b})})});this._updateIntervalId=setInterval(function(){return a.store.checkForUpdates()},64);this._set("queryEngine",this._createQueryEngine(this.store));this._shouldPushDataReceived=this.service.enableDataRecieved};
b.prototype.destroy=function(){clearInterval(this._updateIntervalId);this.connection.destroy();this.queryEngine.destroy();this._tileDispatchMap.forEach(function(a){return a.destroy()})};Object.defineProperty(b.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0});b.prototype.update=function(a,c){return n(this,void 0,void 0,function(){var b,e,f=this;return m(this,function(d){switch(d.label){case 0:return this.validateConfig(a,
c),b=this.renderer.getAttributeHash(),this._set("config",a),[4,this.updatePixelBuffer()];case 1:d.sent();if("heatmap"===this.renderer.type)return[2];if(b===this.renderer.getAttributeHash())return[3,3];e=this.queryEngine.featureStore;return[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 2:d.sent(),e.forEach(function(a){return f.attributeStore.setAttributeData(a.localId,a,f.geometryInfo,f.viewParams)}),d.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];
case 4:return d.sent(),[4,this.attributeStore.sendUpdates()];case 5:return d.sent(),[2]}})})};b.prototype.invalidate=function(){this._repushActiveTiles()};b.prototype.onEdits=function(a){};b.prototype.queryFeatures=function(a){return l.safeCast(this.queryEngine.executeQuery(a))};b.prototype.queryFeatureCount=function(a){return l.safeCast(this.queryEngine.executeQueryForCount(a))};b.prototype.queryObjectIds=function(a){return l.safeCast(this.queryEngine.executeQueryForIds(a))};b.prototype.queryExtent=
function(a){return l.safeCast(this.queryEngine.executeQueryForExtent(a))};b.prototype.queryLatestObservations=function(a){return n(this,void 0,void 0,function(){return m(this,function(c){if(!this.service.timeInfo.trackIdField)throw C("mapview-no-trackIdField","queryLatestObservation can only be used with services that define a TrackIdField");return[2,this.queryEngine.executeQueryForLatestObservations(a)]})})};b.prototype.redraw=function(){};b.prototype.refresh=function(){};b.prototype.setViewState=
function(a){var c=this,b=this.viewState&&this.viewState.scale;this.inherited(arguments);b!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(a){return c.attributeStore.setAttributeData(a.localId,a,c.geometryInfo,c.viewParams)}),this.attributeStore.sendUpdates())};b.prototype.onTileUpdate=function(a){var c=this,b=a.added;a.removed.forEach(function(a){return c._handleTileRemove(a)});b.forEach(function(a){return c._handleTileAdd(a)})};b.prototype.enableEvent=
function(a){"data-received"===a.name&&(this._shouldPushDataReceived=a.value)};b.prototype._onFeature=function(a){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry}});try{var c=this.geometryInfo,b=E.convertFromFeature(a,c.geometryType,c.hasZ,c.hasM,this.store.objectIdField);this.store.add(b)}catch(e){}};b.prototype._createStoreWithFeatures=function(a){if(k.isNone(a))return null;var b=this._createFeatureStore(!1);
b.addMany(a);return b};b.prototype._onUpdate=function(a,b){return n(this,void 0,void 0,function(){var c,e,f=this;return m(this,function(d){switch(d.label){case 0:return k.isSome(a)&&a.forEach(function(a){return f.onFeatureAdd(a)}),c=this._createStoreWithFeatures(a),e=this._createStoreWithFeatures(b),this.attributeStore.sendUpdates(),this.processor.supportsTileUpdates?[4,this._updateActiveTiles(c,e)]:[3,2];case 1:return d.sent(),[3,3];case 2:this._repushActiveTiles(),d.label=3;case 3:return k.isSome(b)&&
b.forEach(function(a){return f.onFeatureRemove(a)}),[2]}})})};b.prototype._handleTileAdd=function(a){if(this._tileDispatchMap.has(a.id)){var b=this._tileDispatchMap.get(a.id);b.up()}else b=new I.default,this._tileDispatchMap.set(a.id,b);this._queryTileFeatures(a,!0,this.queryEngine)};b.prototype._handleTileRemove=function(a){this._tileDispatchMap.get(a.id).destroy();this._tileDispatchMap.delete(a.id)};b.prototype._anyUpdatesQueued=function(){return D.valuesOfMap(this._tileDispatchMap).some(function(a){return a.hasAction()})};
b.prototype._updateActiveTiles=function(a,b){return n(this,void 0,void 0,function(){var c,e,f=this;return m(this,function(d){switch(d.label){case 0:return c=k.applySome(a,function(a){return f._createQueryEngine(a)}),e=k.applySome(b,function(a){return f._createQueryEngine(a)}),[4,v.all(this.tileStore.tiles.map(function(a){return f._queryTileFeatures(a,!1,c,e)}))];case 1:return d.sent(),[2]}})})};b.prototype._repushActiveTiles=function(){for(var a=0,b=this.tileStore.tiles;a<b.length;a++)this._queryTileFeatures(b[a],
!0,this.queryEngine)};b.prototype._queryTileFeatures=function(a,b,h,e){return n(this,void 0,void 0,function(){var c,d,g,l,p,t,q,r,x,y,u,z,A=this;return m(this,function(f){c={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]}};d=this.queryInfo;g=d.returnCentroid;l=d.returnGeometry;p=this._pixelBuffer;t={returnCentroid:g,returnGeometry:l,pixelBuffer:p};q=this._tileDispatchMap.get(a.id);r=k.applySome(h,function(b){return w.executeTileQuery(b,
a,t)});x=k.mapOr(r,[],function(a){return a.features});y=k.mapOr(e,[],function(b){return w.executeTileQueryForIds(b,a,t)}).map(function(a){return A.attributeStore.getLocalId(a)});u=v.createResolver();z=function(d){return n(A,void 0,void 0,function(){return m(this,function(e){switch(e.label){case 0:return[4,this.processor.onTileData(a,{addOrUpdate:x,remove:y,clear:b,transformParams:c},{signal:d})];case 1:return e.sent(),u.resolve(),[2]}})})};q.enqueue(z);return[2,u.promise]})})};g([h.property()],b.prototype,
"connection",void 0);g([h.property()],b.prototype,"service",void 0);g([h.property({readOnly:!0})],b.prototype,"store",void 0);g([h.property({readOnly:!0})],b.prototype,"queryEngine",void 0);g([h.property()],b.prototype,"updating",null);return b=g([h.subclass("esri.views.2d.layers.features.controllers.StreamController")],b)}(h.declared(H.default));r.default=q});