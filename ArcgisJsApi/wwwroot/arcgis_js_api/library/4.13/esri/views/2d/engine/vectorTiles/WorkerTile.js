// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/asyncUtils ../../../../core/maybe ../../../../core/ObjectPool ../../../../core/promiseUtils ./BackgroundBucket ./CircleBucket ./FillBucket ./GeometryUtils ./IndexMemoryBuffer ./LineBucket ./Placement ./SymbolBucket ./TileParser ./VertexMemoryBuffer ../../tiling/enums".split(" "),function(P,Q,E,F,G,v,H,u,I,J,K,w,h,L,M,N,O,k,q){return function(){function d(){this.rotation=0;this.status=
q.TileStatus.INITIALIZED;this._symbolBuckets=[];this.placementEngine=new M.PlacementEngine;this.fillVertexBuffer=new k.FillVertexBuffer(!1);this.fillDDVertexBuffer=new k.FillVertexBuffer(!0);this.fillIndexBuffer=new h.TriangleIndexBuffer;this.outlineVertexBuffer=new k.OutlineVertexBuffer(!1);this.outlineDDVertexBuffer=new k.OutlineVertexBuffer(!0);this.outlineIndexBuffer=new h.TriangleIndexBuffer;this.lineVertexBuffer=new k.LineVertexBuffer(!1);this.lineDDVertexBuffer=new k.LineVertexBuffer(!0);this.lineIndexBuffer=
new h.TriangleIndexBuffer;this.iconVertexBuffer=new k.SymbolVertexBuffer(!1);this.iconDDVertexBuffer=new k.SymbolVertexBuffer(!0);this.iconIndexBuffer=new h.TriangleIndexBuffer;this.textVertexBuffer=new k.SymbolVertexBuffer(!1);this.textDDVertexBuffer=new k.SymbolVertexBuffer(!0);this.textIndexBuffer=new h.TriangleIndexBuffer;this.circleVertexBuffer=new k.CircleVertexBuffer;this.circleIndexBuffer=new h.TriangleIndexBuffer}d.prototype.initialize=function(e,g,a,f){void 0===f&&(f=0);this.tileKey=e;this.refKeys=
g;this._workerTileHandler=a;this.rotation=f;this.placementEngine.setAngle(w.C_DEG_TO_RAD*f)};d.prototype.release=function(){this.tileKey="";this.refKeys=null;this.status=q.TileStatus.INITIALIZED;this.rotation=0;this.resetData();this._workerTileHandler=null};d.prototype.resetData=function(){this.fillVertexBuffer.reset();this.fillDDVertexBuffer.reset();this.fillIndexBuffer.reset();this.outlineVertexBuffer.reset();this.outlineDDVertexBuffer.reset();this.outlineIndexBuffer.reset();this.lineVertexBuffer.reset();
this.lineDDVertexBuffer.reset();this.lineIndexBuffer.reset();this.iconVertexBuffer.reset();this.iconDDVertexBuffer.reset();this.iconIndexBuffer.reset();this.textVertexBuffer.reset();this.textDDVertexBuffer.reset();this.textIndexBuffer.reset();this.circleVertexBuffer.reset();this.circleIndexBuffer.reset();this.placementEngine.reset();this._symbolBuckets.length=0};d.prototype.reparse=function(e){this.resetData();return this.setDataAndParse(this._data,e)};d.prototype.setDataAndParse=function(e,g){var a=
this,f=g&&g.signal;if(v.isSome(f)){var d=function(){f.removeEventListener("abort",d);a.status=q.TileStatus.INVALID};f.addEventListener("abort",d)}this._data=e;return G.safeCast(this._parse(e,g)).then(function(e){a.status=q.TileStatus.READY;for(var g=new Uint32Array([1,a.fillVertexBuffer.sizeInBytes,2,a.fillDDVertexBuffer.sizeInBytes,3,a.fillIndexBuffer.sizeInBytes,4,a.outlineVertexBuffer.sizeInBytes,5,a.outlineDDVertexBuffer.sizeInBytes,6,a.outlineIndexBuffer.sizeInBytes,7,a.lineVertexBuffer.sizeInBytes,
8,a.lineDDVertexBuffer.sizeInBytes,9,a.lineIndexBuffer.sizeInBytes,10,a.iconVertexBuffer.sizeInBytes,11,a.iconDDVertexBuffer.sizeInBytes,12,a.iconIndexBuffer.sizeInBytes,13,a.textVertexBuffer.sizeInBytes,14,a.textDDVertexBuffer.sizeInBytes,15,a.textIndexBuffer.sizeInBytes,16,a.circleVertexBuffer.sizeInBytes,17,a.circleIndexBuffer.sizeInBytes]),c=[],d=e.length,f=0;f<d;f++){var b=e[f];if(b instanceof K)c.push(b.layerIndex),c.push(1),c.push(b.fillIndexStart),c.push(b.fillIndexCount),c.push(b.outlineIndexStart),
c.push(b.outlineIndexCount);else if(b instanceof L)c.push(b.layerIndex),c.push(2),c.push(b.lineIndexStart),c.push(b.lineIndexCount);else if(b instanceof N){c.push(b.layerIndex);c.push(3);c.push(b.sdfMarker?1:0);var n=b.markerPageMap;c.push(n.size);n.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])});b=b.glyphsPageMap;c.push(b.size);b.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])})}else b instanceof J?(c.push(b.layerIndex),c.push(4),c.push(b.circleIndexStart),c.push(b.circleIndexCount)):
b instanceof I&&(c.push(b.layerIndex),c.push(0))}e=new Uint32Array(c);var d=a.fillVertexBuffer.toBuffer(),f=a.fillDDVertexBuffer.toBuffer(),b=a.fillIndexBuffer.toBuffer(),n=a.outlineVertexBuffer.toBuffer(),k=a.outlineDDVertexBuffer.toBuffer(),m=a.outlineIndexBuffer.toBuffer(),h=a.lineVertexBuffer.toBuffer(),l=a.lineDDVertexBuffer.toBuffer(),A=a.lineIndexBuffer.toBuffer(),B=a.iconVertexBuffer.toBuffer(),u=a.iconDDVertexBuffer.toBuffer(),x=a.iconIndexBuffer.toBuffer(),v=a.textVertexBuffer.toBuffer(),
w=a.textDDVertexBuffer.toBuffer(),y=a.textIndexBuffer.toBuffer(),C=a.circleVertexBuffer.toBuffer(),D=a.circleIndexBuffer.toBuffer();return{result:{bufferDataInfo:g.buffer,bucketDataInfo:e.buffer,bufferData:[d,f,b,n,k,m,h,l,A,B,u,x,v,w,y,C,D]},transferList:[d,f,b,n,k,m,h,l,A,B,u,x,v,w,y,C,D,g.buffer,e.buffer]}})};d.prototype.addBucket=function(e){this._symbolBuckets.push(e)};d.prototype.updateSymbols=function(e,g){var a=this,f=this._symbolBuckets;if(!f||0===f.length)return u.resolve();var d=g&&g.signal;
if(v.isSome(d)){var k=function(){d.removeEventListener("abort",k);a.status=q.TileStatus.INVALID};d.addEventListener("abort",k)}this.rotation=e;var p=this.placementEngine;p.reset();p.setAngle(e/256*360*w.C_DEG_TO_RAD);var c=this.iconVertexBuffer;c.reset();var h=this.iconDDVertexBuffer;h.reset();var r=this.iconIndexBuffer;r.reset();var b=this.textVertexBuffer;b.reset();g=this.textDDVertexBuffer;g.reset();e=this.textIndexBuffer;e.reset();for(var n=[],t=0;t<f.length;t++){var m=f[t];if(m&&m.layer){var z=
m.layer;if(m=m.copy(z.hasDataDrivenIcon?h:c,r,z.hasDataDrivenText?g:b,e,p))n.push(m),m.updateSymbols()}}if(this.status===q.TileStatus.INVALID||this.status===q.TileStatus.INITIALIZED||0===c.sizeInBytes&&0===h.sizeInBytes&&0===r.sizeInBytes&&0===b.sizeInBytes&&0===g.sizeInBytes&&0===e.sizeInBytes)return u.reject();for(var f=new Uint32Array([10,c.sizeInBytes,11,h.sizeInBytes,12,r.sizeInBytes,13,b.sizeInBytes,14,g.sizeInBytes,15,e.sizeInBytes]),l=[],t=0;t<n.length;t++)p=n[t],l.push(p.layerIndex),l.push(3),
l.push(p.sdfMarker?1:0),m=p.markerPageMap,l.push(m.size),m.forEach(function(a,b){l.push(b);l.push(a[0]);l.push(a[1])}),p=p.glyphsPageMap,l.push(p.size),p.forEach(function(a,b){l.push(b);l.push(a[0]);l.push(a[1])});n=new Uint32Array(l);c=c.toBuffer();h=h.toBuffer();r=r.toBuffer();b=b.toBuffer();g=g.toBuffer();e=e.toBuffer();return u.resolve({result:{bufferDataInfo:f.buffer,bucketDataInfo:n.buffer,bufferData:[c,h,r,b,g,e]},transferList:[c,h,r,b,g,e,f.buffer,n.buffer]})};d.prototype.setObsolete=function(){this.status=
q.TileStatus.INVALID};d.prototype.getLayers=function(){return this._workerTileHandler.getLayers()};d.prototype.getWorkerTileHandler=function(){return this._workerTileHandler};d.prototype._parse=function(e,d){return F(this,void 0,void 0,function(){var a;return E(this,function(f){if(0===Object.keys(e).length)return[2,[]];this.status=q.TileStatus.MODIFIED;a=new O(e,this,d.client);return[2,a.parse(d)]})})};d.pool=new H(d);return d}()});