// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/Error ../../../../../core/HandleOwner ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/data/attributeSupport ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/graphics/data/QueryEngine ../../../../../layers/support/FeatureProcessing ../../../../../layers/support/FieldsIndex ../../../../../renderers/support/jsonUtils ../../../../../tasks/support/QuantizationParameters ../../../../../tasks/support/Query ../../../engine ../support/AttributeStore ../support/pixelBuffering".split(" "),
function(p,f,d,k,m,u,v,n,w,K,x,q,h,c,y,r,z,A,B,C,D,E,F,G,H){function I(c){var b=c&&c.getSymbols();return"backgroundFillSymbol"in c&&null!=c.backgroundFillSymbol||b.some(function(a){return"simple-fill"===a.type||"picture-fill"===a.type})}function J(c,b,a){function l(a){if(!a)return!1;a=a.type;return"simple-marker"===a||"picture-marker"===a||"text"===a||"web-style"===a||"cim"===a}if("esriGeometryPolygon"===b&&c.labelingInfo)return!0;if("esriGeometryPolygon"!==b)return!1;switch(a.type){case "simple":return l(a.symbol);
case "unique-value":return l(a.defaultSymbol)||a.uniqueValueInfos.some(function(a){return l(a.symbol)});case "class-breaks":return l(a.defaultSymbol)||a.classBreakInfos.some(function(a){return l(a.symbol)});default:return!0}}Object.defineProperty(f,"__esModule",{value:!0});var t=x.getLogger("esri.views.2d.layers.features.controllers.BaseController");f.needsGeometry=function(c,b){switch(c){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryMultipoint":return!0;case "esriGeometryPolygon":return I(b);
default:return t.error(new n("mapview-invalid-type",c+" is not supported")),!1}};p=function(f){function b(){var a=null!==f&&f.apply(this,arguments)||this;a._processingInMainThread=!1;a._availableFields=[];a._pixelBuffer=0;a.config=null;a.processor=null;a.remoteClient=null;a.service=null;a.tileStore=null;a.filters=Array(F.definitions.MAX_FILTERS);return a}u(b,f);b.prototype.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])};b.prototype.startup=function(){return m(this,
void 0,void 0,function(){return k(this,function(a){switch(a.label){case 0:return this._initAttributeStore(),[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 1:return a.sent(),[4,h.all([this.attributeStore.updateFilters(this),this.updatePixelBuffer()])];case 2:return a.sent(),[2]}})})};b.prototype.destroy=function(){this.attributeStore.destroy()};Object.defineProperty(b.prototype,"arcadeInfo",{get:function(){return{geometryType:this.service.geometryType,fields:this.service.fields,
spatialReference:this.spatialReference}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fieldsIndex",{get:function(){return new B(this.service.fields)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"geometryInfo",{get:function(){return{geometryType:this.service.geometryType,hasZ:!1,hasM:!1}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"returnCentroid",{get:function(){return this._get("returnCentroid")||J(this.config,this.service.geometryType,
this.renderer)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"queryInfo",{get:function(){var a=null;if("heatmap"!==this.renderer.type){var b=this.renderer.visualVariables;b&&b.some(function(b){if("size"===b.type&&b.field&&!b.normalizationField)return a=[b.field+" DESC"],!0})}return{returnCentroid:this.returnCentroid,returnGeometry:!0,outFields:this.availableFields,orderByFields:a,definitionExpression:this.config.definitionExpression,gdbVersion:this.config.gdbVersion,historicMoment:this.config.historicMoment}},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderer",{get:function(){return this.config?C.fromJSON(this.config.renderer):(t.error("mapview-controller","Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"processing",{get:function(){return A.fromWorker(this.config.processing)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"availableFields",{get:function(){var a=this,b=this.config.availableFields.filter(function(b){return-1===
a._availableFields.indexOf(b)});return this._availableFields=this._availableFields.concat(b)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"spatialReference",{get:function(){return this.tileStore.tileScheme.spatialReference},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewParams",{get:function(){return{viewingMode:"",scale:this.viewState&&this.viewState.scale||1}},enumerable:!0,configurable:!0});b.prototype.getObjectId=function(a){return this.attributeStore.getFeatureId(a)};
b.prototype.getLocalId=function(a){return this.attributeStore.getLocalId(a)};b.prototype.mapValidLocalIds=function(a){var b=this;return a.map(function(a){return b.attributeStore.getLocalId(a)}).filter(function(a){return null!=a})};b.prototype.setViewState=function(a){this._set("viewState",a)};b.prototype.updatePixelBuffer=function(){return m(this,void 0,void 0,function(){var a;return k(this,function(b){switch(b.label){case 0:return[4,H.computePxBuffer(this.renderer,this.service.geometryType)];case 1:return a=
b.sent(),this._pixelBuffer=Math.max(this._pixelBuffer,a),[2]}})})};b.prototype.setHighlight=function(a){return m(this,void 0,void 0,function(){return k(this,function(b){return[2,this.attributeStore.setHighlight(a)]})})};b.prototype.validateConfig=function(a,b){b=0;for(a=a.filters;b<a.length;b++){var g=a[b];if(q.isSome(g)&&g.where)try{y.validateWhere(this.fieldsIndex,g.where)}catch(e){throw new n("mapview-bad-filter",e.message,{filter:g,missingFields:e.details});}}};b.prototype.onFeatureAdd=function(a){a.localId=
this.attributeStore.createLocalId(a.objectId);this.attributeStore.setAttributeData(a.localId,a,this.geometryInfo,this.viewParams)};b.prototype.onFeatureRemove=function(a){this.attributeStore.freeLocalId(a.objectId)};b.prototype.enableEvent=function(a){};b.prototype._initAttributeStore=function(){var a=this;this.attributeStore=new G.default(v({type:"remote"},"heatmap"===this.renderer.type?{initialize:function(a,b){return h.resolve()},update:function(a,b){return h.resolve()},render:function(){return h.resolve()}}:
{initialize:function(b,g){return a.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",b,{signal:g})},update:function(b,g){return a.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",b,{signal:g})},render:function(){return a.remoteClient.invoke("tileRenderer.featuresView.requestRender")}}))};b.prototype._createQueryEngine=function(a){void 0===a&&(a=this._createFeatureStore());var b=this.queryInfo,g=b.gdbVersion,c=b.historicMoment;return new z.default({definitionExpression:b.definitionExpression,
fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,gdbVersion:g,historicMoment:null!=c&&new Date(c),featureStore:a,timeInfo:this.service.timeInfo})};b.prototype._createTempQueryEngine=function(a){void 0===a&&(a=this._createFeatureStore(!1));return this._createQueryEngine(a)};b.prototype._createFeatureStore=function(a){void 0===a&&(a=!0);var b={geometryType:this.service.geometryType,
hasM:!1,hasZ:!1};if(a){a=this.onFeatureAdd.bind(this);var c=this.onFeatureRemove.bind(this);return new r.default(b,a,c)}return new r.default(b)};b.prototype._createDefaultQuery=function(a){var b=this,c=new E;c.outSpatialReference=this.spatialReference;var e=a.outFields,d=a.orderByFields,f=this.config,h=f.gdbVersion,k=f.historicMoment,f=f.definitionExpression;this.processing&&(e=e&&e.filter(function(a){return!b.processing.getField(a)}),d=d&&d.filter(function(a){return!b.processing.getField(a)}));e=
.75<=e.length/this.service.fields.length?["*"]:e;c.gdbVersion=h;c.historicMoment=null!=k?new Date(k):null;c.outFields=e;c.where=f||"1\x3d1";c.returnGeometry=a.returnGeometry;c.returnCentroid=a.returnCentroid;c.orderByFields=d;c.start=a.resultOffset;c.num=a.num;return c};b.prototype._createQuery=function(a,b,c,e,d,f){var g=this.service.geometryType;e=this._createDefaultQuery(e);e.maxRecordCountFactor=d;e.returnExceededLimitFeatures=f;e.resultType="tile";e.geometry=a;if(this.service.capabilities.query.supportsQuantization)e.quantizationParameters=
new D.default({mode:"view",originPosition:"upper-left",tolerance:c,extent:b}),"esriGeometryPolyline"===g&&(e.maxAllowableOffset=c);else if("esriGeometryPolyline"===g||"esriGeometryPolygon"===g)e.maxAllowableOffset=c;return e};b.prototype._applyProcessing=function(a,b){var c=this.processing;if(!c)return h.resolve(a);if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:a},b);try{var d=c.process(a,c.options);return d?"then"in d?d:h.resolve(d):h.reject(new n("FeatureLayer",
"invalid processing.process() method, returns nothing"))}catch(L){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:a},b)}};b.prototype.hasGeometryFilter=function(){return this.filters.some(function(a){return q.isSome(a)&&!!a.geometry})};d([c.property({readOnly:!0,dependsOn:["config","service","spatialReference"]})],b.prototype,"arcadeInfo",null);d([c.property()],b.prototype,"config",void 0);d([c.property({readOnly:!0,dependsOn:["service"]})],b.prototype,
"fieldsIndex",null);d([c.property({readOnly:!0,dependsOn:["service"]})],b.prototype,"geometryInfo",null);d([c.property({readOnly:!0,dependsOn:["config"]})],b.prototype,"returnCentroid",null);d([c.property({readOnly:!0,dependsOn:["config","availableFields"]})],b.prototype,"queryInfo",null);d([c.property({dependsOn:["config"],readOnly:!0})],b.prototype,"renderer",null);d([c.property()],b.prototype,"processor",void 0);d([c.property({readOnly:!0,dependsOn:["config"]})],b.prototype,"processing",null);
d([c.property({readOnly:!0,dependsOn:["config"]})],b.prototype,"availableFields",null);d([c.property({constructOnly:!0})],b.prototype,"remoteClient",void 0);d([c.property({constructOnly:!0})],b.prototype,"service",void 0);d([c.property({dependsOn:["tileStore"]})],b.prototype,"spatialReference",null);d([c.property({constructOnly:!0})],b.prototype,"tileInfo",void 0);d([c.property({constructOnly:!0})],b.prototype,"tileStore",void 0);d([c.property()],b.prototype,"filters",void 0);d([c.property({readOnly:!0})],
b.prototype,"viewState",void 0);d([c.property({readOnly:!0,dependsOn:["viewState"]})],b.prototype,"viewParams",null);return b=d([c.subclass("esri.views.2d.layers.features.controllers.BaseController")],b)}(c.declared(w.HandleOwner));f.default=p});