// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/Handles ../../../core/accessorSupport/decorators ../../../geometry/support/webMercatorUtils ./BitmapTileLayerView2D ./LayerView2D ../tiling/TileInfoView ../tiling/TileQueue ../tiling/TileStrategy ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),function(z,A,m,g,k,l,n,e,p,q,r,t,u,v,
w,x){var y=[102113,102100,3857,3785,900913];return function(h){function b(){var a=null!==h&&h.apply(this,arguments)||this;a._handles=new n;a._tileStrategy=null;a._fetchQueue=null;a._tileRequests=new Map;a.layer=null;return a}m(b,h);Object.defineProperty(b.prototype,"tileMatrixSet",{get:function(){if(this.layer.activeLayer.tileMatrixSetId)return this.layer.activeLayer.tileMatrixSet;var a=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);if(!a)return null;this.layer.activeLayer.tileMatrixSetId=
a.id;return a},enumerable:!0,configurable:!0});b.prototype.hitTest=function(a,c){return null};b.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")};b.prototype.attach=function(){var a=this,c=this.layer.activeLayer,b=this.tileMatrixSet;if(b){var d=b.tileInfo.spatialReference,c=c.fullExtent&&c.fullExtent.clone();d.isWebMercator?c=p.geographicToWebMercator(c):d.isWGS84||(c=b.fullExtent);
this._tileInfoView=new t(b.tileInfo,c);this._fetchQueue=new u({tileInfoView:this._tileInfoView,process:function(c){return a.fetchTile(c)}});this._tileStrategy=new v({cachePolicy:"keep",acquireTile:function(c){return a.acquireTile(c)},releaseTile:function(c){return a.releaseTile(c)},tileInfoView:this._tileInfoView});this._handles.add(this.watch("layer.activeLayer.styleId, tileMatrixSet",function(){return a._refresh()}));this.inherited(arguments)}};b.prototype.detach=function(){this.inherited(arguments);
this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this._fetchQueue=this._tileStrategy=this._tileInfoView=null};b.prototype.moveStart=function(){this.requestUpdate()};b.prototype.viewChange=function(){this.requestUpdate()};b.prototype.moveEnd=function(){this.requestUpdate()};b.prototype.doRefresh=function(a){return l(this,void 0,void 0,function(){return k(this,function(a){if(this.updateRequested||this.suspended)return[2];this._refresh();return[2]})})};b.prototype.isUpdating=
function(){return 0<this._fetchQueue.length};b.prototype.acquireTile=function(a){var c=this,b,d=this._bitmapView.createTile(a),f=d.bitmap;b=this._tileInfoView.getTileCoords([0,0],d.key);f.x=b[0];f.y=b[1];f.resolution=this._tileInfoView.getTileResolution(d.key);b=this._tileInfoView.tileInfo.size;f.width=b[0];f.height=b[1];this._tileInfoView.getTileCoords(f,d.key);var e={id:a.id,fulfilled:!1,promise:this._fetchQueue.push(d.key).then(function(a){d.bitmap.source=a;d.once("attach",function(){return c.requestUpdate()});
c._bitmapView.addChild(d)}).catch(function(a){d.bitmap.source=null;d.once("attach",function(){return c.requestUpdate()});c._bitmapView.addChild(d)})};e.promise.then(function(){return e.fulfilled=!0},function(){return e.fulfilled=!0});this._tileRequests.set(d,e);this.requestUpdate();return d};b.prototype.releaseTile=function(a){var c=this._tileRequests.get(a);c.fulfilled||this._fetchQueue.abort(c.id);this._tileRequests.delete(a);this._bitmapView.removeChild(a);this.requestUpdate()};b.prototype.fetchTile=
function(a){return l(this,void 0,void 0,function(){return k(this,function(c){return[2,this.layer.fetchTile(a.level,a.row,a.col)]})})};b.prototype.canResume=function(){var a=this.inherited(arguments);return a?null!==this.tileMatrixSet:a};b.prototype._refresh=function(){var a=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(c){if(c.bitmap.source){c.bitmap.source=null;var b={id:c.key.id,fulfilled:!1,promise:a._fetchQueue.push(c.key).then(function(b){c.bitmap.source=b;c.requestRender();
a.notifyChange("updating")})};b.promise.then(function(){return b.fulfilled=!0},function(){return b.fulfilled=!0});a._tileRequests.set(c,b)}});this.notifyChange("updating")};b.prototype._getTileMatrixSetBySpatialReference=function(a){var b=this.view.spatialReference,e=a.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===b.wkid});!e&&b.isWebMercator&&(e=a.tileMatrixSets.find(function(a){return-1<y.indexOf(a.tileInfo.spatialReference.wkid)}));return e};g([e.property({dependsOn:["tileMatrixSet"]})],
b.prototype,"suspended",void 0);g([e.property({readOnly:!0,dependsOn:["view.spatialReference","layer.activeLayer"]})],b.prototype,"tileMatrixSet",null);return b=g([e.subclass("esri.views.2d.layers.WMTSLayerView2D")],b)}(e.declared(x.RefreshableLayerView(q.BitmapTileLayerView2D(r.LayerView2D(w)))))});