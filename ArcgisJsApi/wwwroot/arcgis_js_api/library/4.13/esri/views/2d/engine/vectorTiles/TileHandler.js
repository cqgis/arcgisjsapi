// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../request ../../../../core/asyncUtils ../../../../core/has ../../../../core/ItemCache ../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/requireUtils ../../../../core/workers ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ./VectorTileDisplayObject ../../tiling/TileKey module".split(" "),function(y,
J,q,m,l,t,z,A,B,C,n,D,E,u,F,G,H,v,w,r,I){var x=new B(10),p=new Map;return function(){function e(a,f,d,b,c){this._vectorTileLayer=a;this.devicePixelRatio=f;this.allowUpdates=d;this._container=b;this._memCache=c;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._updateToAbortController=new Map;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map}e.prototype.destroy=function(){this._updateToAbortController&&this._updateToAbortController.forEach(function(a){return a.abort()});
this._ongoingTileRequests&&this.abortAll();this._connection&&(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(e.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,
"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});e.prototype.start=function(a){return l(this,void 0,void 0,function(){var f,d,b,c,k,g=this;return m(this,function(h){f=this._vectorTileLayer.sourceNameToSource;d=[];for(b in f)d.push(this._fetchTileMap(f[b],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){g._spriteMosaic=new H(1024,1024,250);g._spriteMosaic.setSpriteSource(a)});
c=this._vectorTileLayer.styleRepository;k=new G(c.glyphs);this._glyphMosaic=new F(1024,1024,k);this._broadcastPromise=z.safeCast(E.open(D.getAbsMid("./WorkerTileHandler",y,I),{client:this,scheduler:a.scheduler,signal:a.signal})).then(function(b){g._connection=b;return n.all(g._connection.broadcast("setLayers",c.styleJSON,q({},a)))});return[2,n.all(d)]})})};e.prototype.updateStyle=function(){return l(this,void 0,void 0,function(){var a,f=this;return m(this,function(d){switch(d.label){case 0:return[4,
this._broadcastPromise];case 1:return d.sent(),this._updateToAbortController.forEach(function(a){return a.abort()}),this._updateToAbortController.clear(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=n.create(function(b,c){n.all(f._connection.broadcast("updateStyle",a.styleJSON)).then(b,c)}),[2,this._broadcastPromise]}})})};e.prototype.abortTileUpdate=function(a){this._updateToAbortController.has(a)&&(this._updateToAbortController.get(a).abort(),this._updateToAbortController.delete(a))};
e.prototype.updateTile=function(a,f){return l(this,void 0,void 0,function(){var d,b,c,k,g=this;return m(this,function(h){switch(h.label){case 0:return this.allowUpdates&&a.isReady?[4,this._broadcastPromise]:[2,null];case 1:h.sent();d=Math.round(u.degToByte(f.state.rotation));if(a.rotation===d)return[2,null];c=a.key;this._updateToAbortController.has(c.id)&&(b=this._updateToAbortController.get(c.id),b.abort(),this._updateToAbortController.delete(c.id));b=n.createAbortController();a.rotation=d;k=a.client.invoke("updateSymbols",
{key:a.id,rotation:d},{signal:b.signal}).then(function(b){g._updateToAbortController.delete(c.id);a.isReady&&a.updateSymbolData(b);return b}).catch(function(a){n.isAbortError(a)||g._updateToAbortController.delete(c.id)});this._updateToAbortController.set(a.id,b);return[2,k]}})})};e.prototype.updateTileData=function(a){for(var f=a.tileId,d=this._container.children,b,c=0;c<d.length;c++)if(b=d[c],b.id===f){b.updateTileData(a.tileData);break}};e.prototype.getVectorTile=function(a,f,d){return l(this,void 0,
void 0,function(){var b,c,k,g,h;return m(this,function(e){switch(e.label){case 0:return b=new r(a,f,d,0),this._memCache&&(c=this._memCache.get(b.id))?(c.reference(),[2,c]):[4,this._getVectorTileData(b,null)];case 1:k=e.sent();if(this._memCache&&(g=this._memCache.get(b.id)))return g.reference(),[2,g];h=w.pool.acquire(b,this._vectorTileLayer.tileInfo,this._vectorTileLayer.styleRepository,0);k&&k.tileData?(h.setData(k.tileData,k.client),this._memCache&&(h.reference(),this._memCache.put(h.key.id,h,h.getMemoryUsage()*
h.referenced,C.MIN_PRIORITY))):h.setData(null,null);return[2,h]}})})};e.prototype.releaseVectorTile=function(a){!this._memCache||a.release()?w.pool.release(a):this._memCache.updateSize(a.key.id,a,a.getMemoryUsage()*a.referenced)};e.prototype.fetchTileData=function(a,f){return l(this,void 0,void 0,function(){var d,b,c,k;return m(this,function(g){switch(g.label){case 0:return[4,this._getRefKeys(a,f)];case 1:d=g.sent();b=this._vectorTileLayer.sourceNameToSource;c=[];for(k in b)c.push(k);return[2,this._getSourcesData(c,
d,f)]}})})};e.prototype.parseTileData=function(a,f,d){return l(this,void 0,void 0,function(){var b,c,k,g,h,e,l,n;return m(this,function(m){switch(m.label){case 0:b=a&&a.data;if(!b)return[2,null];c=b.sourceName2DataAndRefKey;k=b.transferList;return 0===Object.keys(c).length?[2,null]:[4,this._broadcastPromise];case 1:return m.sent(),g=Math.round(u.degToByte(f)),h=this._connection.getAvailableClient(),[4,h.invoke("createTileAndParse",{key:a.key.id,rotation:g,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:c},
q({},d,{transferList:k}))];case 2:e=m.sent();if(A("esri-vector-tiles-debug")){l={};for(n in c)l[n]=c[n].refKey;return[2,{tileData:e,client:h,refKeys:l}]}return[2,{tileData:e,client:h}]}})})};Object.defineProperty(e.prototype,"updating",{get:function(){return 0<this._ongoingTileRequests.size},enumerable:!0,configurable:!0});e.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};
e.prototype.getSprites=function(a){var f=this;return this._spriteSourcePromise.then(function(){return f._spriteMosaic.getSpriteItems(a)})};e.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.tileID,a.font,a.codePoints)};e.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};e.prototype._getTilePayload=function(a,f,d){return l(this,void 0,void 0,function(){var b,c,e,g,h;return m(this,function(k){switch(k.label){case 0:return b=r.pool.acquire(a.id),
c=this._vectorTileLayer.sourceNameToSource,e=c[f],g=e.getSourceTileUrl(b.level,b.row,b.col),r.pool.release(b),[4,t(g,q({responseType:"array-buffer"},d))];case 1:return h=k.sent(),[2,{protobuff:h.data,sourceName:f}]}})})};e.prototype._fetchTileMap=function(a,f){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return n.resolve();var d=x.get(a.tileMapURL);if(d)return a.tileIndex=d,n.resolve();if(p.has(a.tileMapURL))return p.get(a.tileMapURL).then(function(b){a.tileIndex=new v(b.data)});
f=t(a.tileMapURL,f);f.then(function(b){a.tileIndex=new v(b.data);p["delete"](a.tileMapURL);x.put(a.tileMapURL,a.tileIndex)});p.set(a.tileMapURL,f);return f};e.prototype._getRefKeys=function(a,f){return l(this,void 0,void 0,function(){var d,b,c,e,g;return m(this,function(h){d=this._vectorTileLayer.sourceNameToSource;b=[];for(c in d)e=d[c],g=e.getRefKey(a,f),b.push(g);return[2,n.eachAlways(b)]})})};e.prototype._getSourcesData=function(a,f,d){return l(this,void 0,void 0,function(){var b,c,e,g,h,l,p;
return m(this,function(k){switch(k.label){case 0:b=[];for(c=0;c<f.length;c++)null==f[c].value||null==a[c]?b.push(null):(e=this._getTilePayload(f[c].value,a[c],d),b.push(e));return[4,n.eachAlways(b)];case 1:g=k.sent();h={};l=[];for(c=0;c<g.length;c++)g[c].value&&g[c].value&&g[c].value.protobuff&&0<g[c].value.protobuff.byteLength&&(p=f[c].value.id,h[g[c].value.sourceName]={refKey:p,protobuff:g[c].value.protobuff},l.push(g[c].value.protobuff));return[2,{sourceName2DataAndRefKey:h,transferList:l}]}})})};
e.prototype._getVectorTileData=function(a,f){return l(this,void 0,void 0,function(){var d,b,c,e,g,h=this;return m(this,function(k){d=a.id;if(this._ongoingTileRequests.has(d))return[2,this._ongoingTileRequests.get(d)];b=new AbortController;c={signal:b.signal};e=f&&f.signal;g=this._getParsedVectorTileData(a,c).then(function(a){h._ongoingTileRequests.delete(d);h._ongoingRequestToController.delete(d);return a}).catch(function(){h._ongoingTileRequests.delete(d);h._ongoingRequestToController.delete(d);
return null});this._ongoingTileRequests.set(d,g);this._ongoingRequestToController.set(d,b);if(e)n.onAbort(e,function(){b.abort();h._ongoingTileRequests.delete(d);h._ongoingRequestToController.delete(d)});return[2,g]})})};e.prototype._getParsedVectorTileData=function(a,e){return l(this,void 0,void 0,function(){var d;return m(this,function(b){switch(b.label){case 0:return[4,this.fetchTileData(a,e)];case 1:return d=b.sent(),[2,this.parseTileData({key:a,data:d},0,e)]}})})};return e}()});