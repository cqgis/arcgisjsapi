// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/screenUtils ../../../../../../core/libs/gl-matrix-2/mat2d ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../../../../../symbols/cim/enums ../../color ../../number ../../materialKey/MaterialKey ./util ./WGLBaseMarkerTemplate ./WGLDynamicMeshTemplate ../../util/Result".split(" "),
function(u,z,D,E,F,n,A,G,l,B,H,q,h,C,e,I,J,K){Object.defineProperty(z,"__esModule",{value:!0});var L=3.14159265359/180,b=B.vec2f32.create(),k=G.mat2df32.create(),M=F.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");u=function(u){function p(b,c){var d=u.call(this,c)||this;d._cimMarkerLayer=c;var h=0;e.isFunction(c.color)||(h=q.premultiplyAlphaRGBA(c.color));d._dynamicPropertyMap.set("_fillColor",function(a,f,b){return e.isFunction(c.color)?q.premultiplyAlphaRGBA(c.color(a,f,b)):h});
var a=0;e.isFunction(c.outlineColor)||(a=q.premultiplyAlphaRGBA(c.outlineColor));d._dynamicPropertyMap.set("_outlineColor",function(b,f,w){return e.isFunction(c.outlineColor)?q.premultiplyAlphaRGBA(c.outlineColor(b,f,w)):a});var m;e.isFunction(c.size)||(m=n.pt2px(c.size));d._dynamicPropertyMap.set("_size",function(a,f,b){return e.isFunction(c.size)?n.pt2px(c.size(a,f,b)):m});var k;e.isFunction(c.scaleX)||(k=c.scaleX);d._dynamicPropertyMap.set("_scaleX",function(a,b,d){return e.isFunction(c.scaleX)?
c.scaleX(a,b,d):k});var r;e.isFunction(c.offsetX)||(r=n.pt2px(c.offsetX));d._dynamicPropertyMap.set("xOffset",function(a,b,d){return e.isFunction(c.offsetX)?n.pt2px(c.offsetX(a,b,d)):r});var g;e.isFunction(c.offsetY)||(g=n.pt2px(c.offsetY));d._dynamicPropertyMap.set("yOffset",function(a,b,d){return e.isFunction(c.offsetY)?n.pt2px(c.offsetY(a,b,d)):g});var t;e.isFunction(c.outlineWidth)||(t=n.pt2px(c.outlineWidth));d._dynamicPropertyMap.set("_outlineWidth",function(a,b,d){return e.isFunction(c.outlineWidth)?
n.pt2px(c.outlineWidth(a,b,d)):t});var l;e.isFunction(c.rotation)||(l=c.rotation);d._dynamicPropertyMap.set("_angle",function(a,b,d){return e.isFunction(c.rotation)?c.rotation(a,b,d):l});d._bitSet=(c.alignment===H.Alignment.MAP?1:0)|(c.colorLocked?1:0)<<1|(c.scaleSymbolsProportionally?1:0)<<3;d._materialKey=C.createMaterialKey(d.geometryType,b,!1);return d}D(p,u);p.fromCIMMarker=function(b,c){return new p(b,c)};p.prototype.bindFeature=function(e,c,d){var u=this,a=this._dynamicPropertyMap;a&&a.forEach(function(a,
b){u[b]=a(e,c,d)});a=this._cimMarkerLayer.materialHash;a=a(e,c,d);if((a=this._materialCache.get(a))&&K.ok(a.spriteMosaicItem)&&a.spriteMosaicItem){var a=a.spriteMosaicItem,m=this._cimMarkerLayer.sizeRatio,v=a.width/a.height*this._scaleX,r=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,g=this._size,t=g*v,p=this.xOffset,q=this.yOffset,f=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/n.pt2px(this._cimMarkerLayer.frameHeight):1,w=this._outlineWidth*
f,z=n.pt2px(this._cimMarkerLayer.referenceSize),x=0,f=0,y=this._cimMarkerLayer.anchorPoint;y&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(x=-y.x/(this._size*v),f=y.y/this._size):(x=y.x,f=y.y));this._sizeOutlineWidth=h.i8888to32(Math.round(Math.sqrt(256*t)),Math.round(Math.sqrt(256*g)),Math.round(Math.sqrt(256*w)),Math.round(Math.sqrt(256*z)));A.mat2d.identity(k);A.mat2d.translate(k,k,B.vec2f32.fromValues(p,-q));r&&A.mat2d.rotate(k,k,L*r);v=a.rect.x;r=a.rect.y;p=v+a.rect.width;q=r+a.rect.height;
x=.5-((.5+x)*a.width+1)/a.rect.width;f=.5-((.5+f)*a.height+1)/a.rect.height;w=Math.round(64*m);t*=a.rect.width/a.width*m;g*=a.rect.height/a.height*m;m=(x-.5)*t;f=(f-.5)*g;this._bitestAndDistRatio=h.i8888to32(0,0,this._bitSet,w);l.vec2.set(b,m,f);l.vec2.transformMat2d(b,b,k);this._offsetUpperLeft=h.i1616to32(16*b[0],16*b[1]);this._texUpperLeft=h.i1616to32(v,r);l.vec2.set(b,m+t,f);l.vec2.transformMat2d(b,b,k);this._offsetUpperRight=h.i1616to32(16*b[0],16*b[1]);this._texUpperRight=h.i1616to32(p,r);l.vec2.set(b,
m,f+g);l.vec2.transformMat2d(b,b,k);this._offsetBottomLeft=h.i1616to32(16*b[0],16*b[1]);this._texBottomLeft=h.i1616to32(v,q);l.vec2.set(b,m+t,f+g);l.vec2.transformMat2d(b,b,k);this._offsetBottomRight=h.i1616to32(16*b[0],16*b[1]);this._texBottomRight=h.i1616to32(p,q);g=C.MarkerMaterialKey.load(this._materialKey);g.sdf=a.sdf;g.pattern=!0;g.textureBinding=a.textureBinding;this._materialKey=g.data}else M.error(E("mapview-cim","Encountered an error when binding feature"))};return p}(I.default(J.default));
z.default=u});