// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat2d ../../../../core/libs/gl-matrix-2/mat2df32 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/boundsUtils ../../../../geometry/support/intersects ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtils ../../../../geometry/support/spatialReferenceUtils ../../../../geometry/support/spatialReferenceUtils ../../engine".split(" "),
function(ja,r,Y,q,p,Z,g,t,A,aa,K,L,u,M,ba,ca,n){function N(a,d,c,b,f){var e,k,m=q.pt2px(c.xoffset),h=q.pt2px(c.yoffset),w=v*c.angle;f*=v;switch(c.type){case "simple-marker":e=k=q.pt2px(c.size);break;case "picture-marker":e=q.pt2px(c.width),k=q.pt2px(c.height)}c=p.mat2d.identity(E);p.mat2d.translate(c,c,g.vec2.set(l,a,d));p.mat2d.rotate(c,c,f-w);p.mat2d.scale(c,c,g.vec2.set(l,b,-b));p.mat2d.translate(c,c,g.vec2.set(l,m,-h));a=[0,0];g.vec2.transformMat2d(a,g.vec2.set(l,-.5*e,-.5*k),c);d=[0,0];g.vec2.transformMat2d(d,
g.vec2.set(l,-.5*e,.5*k),c);b=[0,0];g.vec2.transformMat2d(b,g.vec2.set(l,.5*e,-.5*k),c);m=[0,0];g.vec2.transformMat2d(m,g.vec2.set(l,.5*e,.5*k),c);return{rings:[[a,b,m,d,a]]}}function O(a,d,c,b,f){var e=n.CIMSymbolHelper.getEnvelope(c.data);if(!e)return null;c=q.pt2px(e.width);var k=q.pt2px(e.height),m=q.pt2px(e.x),e=q.pt2px(e.y),h=0*v,w=v*f;f=p.mat2d.identity(E);p.mat2d.translate(f,f,g.vec2.set(l,a,d));p.mat2d.rotate(f,f,w-h);p.mat2d.scale(f,f,g.vec2.set(l,b,b));a=[0,0];g.vec2.transformMat2d(a,g.vec2.set(l,
m,e+k),f);d=[0,0];g.vec2.transformMat2d(d,g.vec2.set(l,m,e),f);b=[0,0];g.vec2.transformMat2d(b,g.vec2.set(l,m+c,e+k),f);k=[0,0];g.vec2.transformMat2d(k,g.vec2.set(l,m+c,e),f);return{rings:[[a,b,k,d,a]]}}function P(a,d,c,b,f,e){var k=n.alignmentUtils.getYAnchorDirection(c.verticalAlignment||"baseline"),m="baseline"===(c.verticalAlignment||"baseline"),h=q.pt2px(c.xoffset),w=q.pt2px(c.yoffset),Q=q.pt2px(c.font.size)/24,R=4*Q,k=m?25*Q:b[1]+(1+k)*b[3]*.5;c=v*c.angle;m=v*e;e=p.mat2d.identity(E);p.mat2d.translate(e,
e,g.vec2.set(l,a,d));p.mat2d.rotate(e,e,m-c);p.mat2d.scale(e,e,g.vec2.set(l,f,-f));p.mat2d.translate(e,e,g.vec2.set(l,h,-w));p.mat2d.translate(e,e,g.vec2.set(l,-R,-R-k));a=[0,0];g.vec2.transformMat2d(a,g.vec2.set(l,b[0],b[1]),e);d=[0,0];g.vec2.transformMat2d(d,g.vec2.set(l,b[0],b[1]+b[3]),e);f=[0,0];g.vec2.transformMat2d(f,g.vec2.set(l,b[0]+b[2],b[1]),e);h=[0,0];g.vec2.transformMat2d(h,g.vec2.set(l,b[0]+b[2],b[1]+b[3]),e);return{rings:[[a,f,h,d,a]]}}function F(a,d,c){if(!c||0===c.glyphMosaicItems.length)return a;
var b=n.bidiText(d.text),f=b[0],b=b[1],e=n.alignmentUtils.getJustification(d.horizontalAlignment||"center"),k=n.alignmentUtils.getXAnchorDirection(d.horizontalAlignment||"center");c=(new n.TextShapingNew([c.glyphMosaicItems],n.definitions.TEXT_MAX_WIDTH,n.definitions.TEXT_LINE_HEIGHT,n.definitions.TEXT_SPACING,[0,.5*-G],.5*(1-k),0,e)).getShaping(f,b);f=n.fontUtils.getFontDecorationTop(d.font.decoration);isNaN(f)||n.TextShapingNew.addDecoration(c,f);c=n.TextShapingNew.getBox(c);d=q.pt2px(d.font.size)/
S;a[0]=d*c.x;a[1]=d*c.y;a[2]=d*c.width;a[3]=d*c.height;return a}function x(a,d){return Math.ceil((a-d)/(2*d))}function da(a,d){var c;c=u.isPolygon(a)?a.rings:a.paths;for(var b=0;b<c.length;b++)for(var f=0,e=c[b];f<e.length;f++)e[f][0]+=d;return a}function ea(a,d){if(!d)return a;var c=fa(a,d).map(function(b){return b.extent});return 2>c.length?c[0]||a:2<c.length?(a.xmin=d.valid[0],a.xmax=d.valid[1],a):{rings:c.map(function(b){return[[b.xmin,b.ymin],[b.xmin,b.ymax],[b.xmax,b.ymax],[b.xmax,b.ymin],[b.xmin,
b.ymin]]})}}function fa(a,d){var c=[],b=a.ymin,f=a.ymax,e=a.xmax-a.xmin,k=a.xmin,m=a.xmax,h,g=d.valid,n=g[0],l=g[1];h=T(a.xmin,d);var p=h.x,g=h.frameId;h=T(a.xmax,d);d=h.x;a=h.frameId;h=p===d&&0<e;if(e>2*l){e={xmin:k<m?p:d,ymin:b,xmax:l,ymax:f};k={xmin:n,ymin:b,xmax:k<m?d:p,ymax:f};m={xmin:0,ymin:b,xmax:l,ymax:f};b={xmin:n,ymin:b,xmax:0,ymax:f};f=[];n=[];B(e,m)&&f.push(g);B(e,b)&&n.push(g);B(k,m)&&f.push(a);B(k,b)&&n.push(a);for(l=g+1;l<a;l++)f.push(l),n.push(l);c.push({extent:e,frameIds:[g]},{extent:k,
frameIds:[a]},{extent:m,frameIds:f},{extent:b,frameIds:n})}else p>d||h?c.push({extent:{xmin:p,ymin:b,xmax:l,ymax:f},frameIds:[g]},{extent:{xmin:n,ymin:b,xmax:d,ymax:f},frameIds:[a]}):c.push({extent:{xmin:p,ymin:b,xmax:d,ymax:f},frameIds:[g]});return c}function T(a,d){var c=d.valid;d=c[0];var b=c[1],c=2*b,f=0;a>b?(d=Math.ceil(Math.abs(a-b)/c),a-=d*c,f=d):a<d&&(d=Math.ceil(Math.abs(a-d)/c),a+=d*c,f=-d);return{x:a,frameId:f}}function B(a,d){var c=d.xmin,b=d.ymin,f=d.xmax;d=d.ymax;return C(a,c,b)&&C(a,
c,d)&&C(a,f,d)&&C(a,f,b)}function C(a,d,c){return d>=a.xmin&&d<=a.xmax&&c>=a.ymin&&c<=a.ymax?!0:!1}function U(a,d,c){if(Array.isArray(a)){var b=a[0];if(b>d){var f=x(b,d);a[0]=b+-2*f*d}else b<c&&(f=x(b,c),a[0]=b+-2*f*c)}else b=a.x,b>d?(f=x(b,d),a.x+=-2*f*d):b<c&&(f=x(b,c),a.x+=-2*f*c);return a}Object.defineProperty(r,"__esModule",{value:!0});var v=Math.PI/180,ga=n.definitions.TEXT_MAX_WIDTH,G=n.definitions.TEXT_LINE_HEIGHT,ha=n.definitions.TEXT_SPACING,E=Z.mat2df32.create(),l=t.vec2f32.create(),y=
aa.create();r.getBounds=function(a,d,c,b,f,e,k,g){if(!b||!c)return a[0]=a[1]=a[2]=a[3]=0,d[0]=d[1]=d[2]=d[3]=0,a;if(u.isPoint(b)){k=b.x;b=b.y;"text"===c.type&&0===d[2]&&0===d[3]&&F(d,c,f);var h;switch(c.type){case "simple-marker":case "picture-marker":h=N(k,b,c,e,0);break;case "text":h=P(k,b,c,d,e,0);break;case "cim":h=O(k,b,c,e,0)}for(e=d=0;e<h.rings[0].length-1;e++)c=h.rings[0][e],c=(k-c[0])*(k-c[0])+(b-c[1])*(b-c[1]),d=Math.max(d,c);d=Math.sqrt(d);e=M.normalizeMapX(k-d,g);k=M.normalizeMapX(k+d,
g);e>k&&(g=ca.getInfo(g))&&(e=g.valid,g=e[1],e=e[0],k=g);a[0]=e;a[1]=b-d;a[2]=k;a[3]=b+d}else{K.getBoundsXY(a,b);b=d[0];if(0===b){a:switch(b=0,c.type){case "simple-fill":case "picture-fill":b=c.outline;if(!b){b=0;break a}b=b.width;break;case "simple-line":b=c.width;break;case "simple-marker":b=c.size;break;case "picture-marker":b=Math.max(c.width,c.height);break;case "text":b=[0,0,0,0];F(b,c,f);b=Math.max(b[0],b[1]);break;case "cim":b=n.CIMSymbolHelper.getEnvelope(c.data),b=Math.sqrt(b.width*b.width+
b.height*b.height)}d[0]=b}b=e*b/2;a[0]-=b;a[1]-=b;a[2]+=b;a[3]+=b}return a};r.isMarkerSymbol=function(a){return"simple-marker"===a||"picture-marker"===a||"text"===a};r.graphicGeometryToNumber=function(a){switch(Y.expect(a.geometry).type){case "polyline":return 1;case "polygon":case "extent":return 2}return 0};var H=t.vec2f32.create(),V=t.vec2f32.create(),W=t.vec2f32.create(),z=t.vec2f32.create(),I=t.vec2f32.create(),X=t.vec2f32.create(),J=t.vec2f32.create();r.isPointOnPolyline=function(a,d,c,b){g.vec2.set(W,
d,c);a=a.paths;for(var f,e,k,m,h,l,n,p,q=Infinity,r=0;r<a.length;r++){var t=a[r];if(!(2>t.length))for(var u=1;u<t.length;u++)f=t[u-1][0],k=t[u-1][1],e=t[u][0],m=t[u][1],h=Math.min(f,e)-b,l=Math.min(k,m)-b,n=Math.max(f,e)+b,p=Math.max(k,m)+b,d<h||d>n||c<l||c>p||(g.vec2.set(H,f,k),g.vec2.set(V,e,m),g.vec2.subtract(z,V,H),g.vec2.subtract(I,H,W),g.vec2.scale(X,z,g.vec2.dot(z,I)/g.vec2.dot(z,z)),g.vec2.subtract(J,I,X),f=g.vec2.dot(J,J),q>f&&(q=f))}return Math.sqrt(q)<=b};r.getMarkerSymbolBounds=N;r.getCIMMarkerBounds=
O;r.getTextSymbolBounds=P;r.normalizeCentralMeridian=function(a){var d,c,b,f,e,g=null;if(!a)return null;d=a.spatialReference;c=ba.getInfo(d);e=d.isWebMercator?102100:4326;b=D[e].maxX;f=D[e].minX;d=D[e].plus180Line;e=D[e].minus180Line;var m,h=a.toJSON();if(!c)return h;"mesh"===a.type?m=h:u.isPoint(h)?m=U(h,b,f):u.isMultipoint(h)?(h.points=h.points.map(function(a){return U(a,b,f)}),m=h):u.isExtent(h)?m=ea(h,c):u.isPolygon(h)||u.isPolyline(h)?(K.getBoundsXY(y,h),a={xmin:y[0],ymin:y[1],xmax:y[2],ymax:y[3]},
c=2*x(a.xmin,f)*b,h=0===c?h:da(h,c),a.xmin+=c,a.xmax+=c,L.extentIntersectsPolyline(a,d)&&a.xmax!==b?g=h:L.extentIntersectsPolyline(a,e)&&a.xmin!==f?g=h:m=h):m=a.clone();return null!==g?(new ia).cut(g,b):m};var S=24;r.getTextSymbolSize=F;r.getTextSymbolEstimatedSize=function(a,d,c){var b=n.bidiText(d.text),f=b[0],b=b[1],e=n.alignmentUtils.getJustification(d.horizontalAlignment||"center"),g=n.alignmentUtils.getXAnchorDirection(d.horizontalAlignment||"center");c=(new n.TextShapingNew([],ga,G,ha,[0,.5*
-G],.5*(1-g),0,e)).getEstimatedShaping(f,b,c);c=n.TextShapingNew.getBox(c);d=q.pt2px(d.font.size)/S;a[0]=d*c.x;a[1]=d*c.y;a[2]=d*c.width;a[3]=d*c.height;return a};var D={102100:{maxX:2.0037508342788905E7,minX:-2.0037508342788905E7,plus180Line:{paths:[[[2.0037508342788905E7,-2.0037508342788905E7],[2.0037508342788905E7,2.0037508342788905E7]]],spatialReference:A.WebMercator},minus180Line:{paths:[[[-2.0037508342788905E7,-2.0037508342788905E7],[-2.0037508342788905E7,2.0037508342788905E7]]],spatialReference:A.WebMercator}},
4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:A.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:A.WGS84}}},ia=function(){function a(){}a.prototype.cut=function(a,c){var b;if(a.rings)this.closed=!0,b=a.rings,this.minPts=4;else if(a.paths)this.closed=!1,b=a.paths,this.minPts=2;else return null;var d=b.length;c*=-2;for(var e=0;e<d;e++){var g=b[e];if(g&&g.length>=this.minPts){for(var m=[],h=0;h<g.length;h++){var l=g[h];m.push([l[0]+c,l[1]])}b.push(m)}}this.closed?
a.rings=b:a.paths=b;return a};return a}()});