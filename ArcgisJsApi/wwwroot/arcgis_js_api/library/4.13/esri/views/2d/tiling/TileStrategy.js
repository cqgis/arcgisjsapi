// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ./TileCache ./TileCoverage ./TileKey".split(" "),function(B,C,D,v,z,w){var k=new w(0,0,0,0),e=new Map,l=[],n=[];return function(){function f(a){var d=this;this._previousScale=Number.POSITIVE_INFINITY;this.cachePolicy="keep";this.coveragePolicy="closest";this.resampling=!0;this.tileIndex=new Map;this.tiles=[];this.buffer=192;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this.resampling=null==
a.resampling||!!a.resampling;a.cachePolicy&&(this.cachePolicy=a.cachePolicy);a.coveragePolicy&&(this.coveragePolicy=a.coveragePolicy);null!=a.buffer&&(this.buffer=a.buffer);a.cacheSize&&(this._tileCache=new v.default(a.cacheSize,this.tileInfoView,function(a){d.releaseTile(a)}))}f.prototype.destroy=function(){this.tileIndex.clear()};f.prototype.update=function(a){var d=this,b=this.resampling,g=this.tileIndex,m=this.tileInfoView.getTileCoverage(a.state,this.buffer,this.coveragePolicy);n.length=0;l.length=
0;e.clear();if(m){var f=this.tileInfoView.tileInfo,t=f.minScale,p=f.maxScale,c=m.spans,x=m.lodInfo,q=x.level,r=a.state,h=r.scale,f=r.center,r=r.resolution,y=!a.stationary&&h>this._previousScale;this._previousScale=h;this.tiles.length=0;if(!b&&(h>t||h<p))return this.tiles.length=0,e.clear(),g.forEach(function(a){d.releaseTile(a)}),g.clear(),n.length=0,l.length=0,e.clear(),z.pool.release(m),!0;g.forEach(function(a){return a.visible=!0});p=t=0;if(0<c.length)for(h=0;h<c.length;h++){a=c[h];for(var v=a.row,
w=a.colTo,u=a.colFrom;u<=w;u++)if(t++,a=k.set(q,v,x.normalizeCol(u),x.getWorldForColumn(u)).id,g.has(a))b=g.get(a),b.isReady?(e.set(a,b),p++):y||this._addParentTile(a,e);else{b=void 0;if(this._tileCache&&this._tileCache.has(a)){if(b=this._tileCache.pop(a),this.tileIndex.set(a,b),b.isReady){e.set(a,b);p++;continue}}else b=this.acquireTile(k),this.tileIndex.set(a,b);y||this._addParentTile(a,e)}}var A=p===t;g.forEach(function(a,b){k.set(b);if(!e.has(b)){var c=d.tileInfoView.intersects(m,k);!c||!y&&A?
"purge"===d.cachePolicy?k.level===q&&c||l.push(b):(k.level>q||!c)&&l.push(b):a.isReady?n.push(b):k.level>q&&l.push(b)}});for(c=0;c<n.length;c++)a=n[c],(b=g.get(a))&&b.isReady&&e.set(a,b);for(c=0;c<l.length;c++)a=l[c],b=g.get(a),this._tileCache?this._tileCache.add(b):this.releaseTile(b),g["delete"](a);e.forEach(function(a){return d.tiles.push(a)});g.forEach(function(a){e.has(a.key.id)||(a.visible=!1)});this._tileCache&&this._tileCache.prune(q,f,r);z.pool.release(m);return A}};f.prototype.clear=function(){var a=
this,d=this.tileIndex;d.forEach(function(b){a.releaseTile(b)});d.clear()};f.prototype._addParentTile=function(a,d){for(var b=null;;){a=this.tileInfoView.getTileParentId(a);if(!a)break;if(this.tileIndex.has(a)){if((b=this.tileIndex.get(a))&&b.isReady){d.has(b.key.id)||d.set(b.key.id,b);break}}else if(this._tileCache&&this._tileCache.has(a)&&(b=this._tileCache.pop(a),this.tileIndex.set(a,b),b&&b.isReady)){d.has(b.key.id)||d.set(b.key.id,b);break}}};return f}()});