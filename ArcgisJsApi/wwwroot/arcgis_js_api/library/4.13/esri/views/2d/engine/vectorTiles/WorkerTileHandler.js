// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/promiseUtils ./WorkerTile ./style/StyleRepository ../../tiling/enums".split(" "),function(q,r,e,l,f,p){return function(){function b(){this._tiles=new Map;this._spriteInfo={};this._glyphInfo={}}b.prototype.reset=function(){this._spriteInfo={};this._glyphInfo={};var a=this._tiles;a.forEach(function(a){return a.setObsolete()});a.clear();return e.resolve()};b.prototype.getLayers=function(){return this._layers};b.prototype.setLayers=function(a){this._layers=(new f(a)).layers;
return e.resolve({data:""})};b.prototype.createTileAndParse=function(a,b){for(var c=this,k=a.key,g=a.cacheTile,d=l.pool.acquire(),h={},m=0,n=Object.keys(a.sourceName2DataAndRefKey);m<n.length;m++){var f=n[m];h[f]=a.sourceName2DataAndRefKey[f].refKey}d.initialize(k,h,this,a.rotation);return d.setDataAndParse(a.sourceName2DataAndRefKey,b).then(function(a){g&&d.status!==p.TileStatus.INVALID&&c._tiles.set(k,d);return a}).catch(function(a){d.setObsolete();l.pool.release(d);if(c._tiles.has(d.tileKey))c._tiles["delete"](d.tileKey);
return e.reject(a)}).catch(function(a){return a}).then(function(a){g||l.pool.release(d);return a})};b.prototype.updateSymbols=function(a,b){var c=this._tiles.get(a.key);return c?c.updateSymbols(a.rotation,b):e.reject()};b.prototype.updateStyle=function(a,b){this._layers=(new f(a)).layers;this._tiles.forEach(function(a,e){a.reparse(b).then(function(c){b.client.invoke("updateTileData",{tileId:a.tileKey,tileData:c.result})})});return e.resolve({data:""})};b.prototype.destructTileData=function(a){this._tiles.has(a)&&
(l.pool.release(this._tiles.get(a)),this._tiles["delete"](a));return e.resolve()};b.prototype.fetchSprites=function(a,b,c){var k=[],g=this._spriteInfo;a.forEach(function(a){void 0===g[a]&&k.push(a)});return 0===k.length?e.resolve():b.invoke("getSprites",k,{signal:c&&c.signal}).then(function(a){for(var b in a)g[b]=a[b]})};b.prototype.getSpriteItems=function(){return this._spriteInfo};b.prototype.fetchGlyphs=function(a,b,c,f,g){var d=[],h=this._glyphInfo[b];h?c.forEach(function(a){h[a]||d.push(a)}):
(h=this._glyphInfo[b]=[],c.forEach(function(a){return d.push(a)}));return 0===d.length?e.resolve():f.invoke("getGlyphs",{tileID:a,font:b,codePoints:d},g).then(function(a){for(var b=0;b<a.length;b++)a[b]&&(h[b]=a[b])})};b.prototype.getGlyphItems=function(a){return this._glyphInfo[a]};return b}()});