// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../config ../../../../request ../../../../core/asyncUtils ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./util/Result ./util/symbolUtils".split(" "),
function(L,M,x,r,t,y,z,A,l,B,u,v,C,D,h,k,E,F,G,H,I,J,m){var w=C.vec2f32.create(),q=B.getLogger("esri.views.2d.engine.webgl.TextureManager"),K=function(){function e(a,c,d){this.mosaicType=a;this.page=c;this.sdf=d}e.fromMosaic=function(a,c){return new e(a,c.page,c.sdf)};return e}();return function(){function e(){this._invalidFontsMap=new Map;this._sdfConverter=new H.default(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._rasterizer=new D.default;this._spriteMosaic=new I(2048,2048,
500);this._glyphSource=new G(y.fontsUrl+"/{fontstack}/{range}.pbf");this._glyphMosaic=new F(1024,1024,this._glyphSource)}Object.defineProperty(e.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});e.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._rasterizer=this._glyphMosaic=
this._spriteMosaic=null};e.prototype._hashMosaic=function(a,c){return 1|a<<1|(c.sdf?1:0)<<2|c.page<<3};e.prototype._setTextureBinding=function(a,c){var d=this._hashMosaic(a,c);this._hashToBindingIndex.has(d)||(a=K.fromMosaic(a,c),this._hashToBindingIndex.set(d,this._bindingInfos.length+1),this._bindingInfos.push(a));c.textureBinding=this._hashToBindingIndex.get(d)};e.prototype.rasterizeItem=function(a,c,d){var b=this;void 0===c&&(c=null);return a?a.type&&-1!==a.type.toLowerCase().indexOf("3d")?(q.error(new l("mapview-invalid-type",
"MapView does not support 3d symbol type: "+a.type,a)),u.resolve({glyphMosaicItems:[],spriteMosaicItem:null})):!a.type||"text"!==a.type&&"esriTS"!==a.type&&"CIMTextSymbol"!==a.type?A.safeCast(this._rasterizeSpriteSymbol(a,d)).then(function(a){J.ok(a)&&a&&b._setTextureBinding(k.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}):this._rasterizeTextSymbol(a,c,d).then(function(a){a.forEach(function(a){return b._setTextureBinding(k.MosaicType.GLYPH,a)});return{glyphMosaicItems:a}}):(q.error(new l("mapview-null-resource",
"Unable to rasterize null resource")),u.resolve(null))};e.prototype.bindTextures=function(a,c,d,b){void 0===b&&(b=1);if(0!==d.textureBinding){var f=this._bindingInfos[d.textureBinding-1];d=f.page;switch(f.mosaicType){case k.MosaicType.SPRITE:f=this.sprites.getWidth(d)/b;b=this.sprites.getHeight(d)/b;b=v.vec2.set(w,f,b);this._bindSpritePage(a,d,h.TEXTURE_BINDING_SPRITE_ATLAS,9729);c.setUniform1i("u_texture",h.TEXTURE_BINDING_SPRITE_ATLAS);c.setUniform2fv("u_mosaicSize",b);break;case k.MosaicType.GLYPH:f=
this.glyphs.width/b;b=this.glyphs.height/b;b=v.vec2.set(w,f,b);this._bindGlyphsPage(a,d,h.TEXTURE_BINDING_GLYPH_ATLAS);c.setUniform1i("u_texture",h.TEXTURE_BINDING_GLYPH_ATLAS);c.setUniform2fv("u_mosaicSize",b);break;default:q.error("mapview-texture-manager","Cannot handle unknown type "+f.mosaicType)}}};e.prototype._bindSpritePage=function(a,c,d,b){b||(b=9729);this._spriteMosaic.bind(a,b,c,d)};e.prototype._bindGlyphsPage=function(a,c,d){this._glyphMosaic.bind(a,9729,c,d)};e.prototype._rasterizeTextSymbol=
function(a,c,d){var b=this,f=E.getFullyQualifiedFontName(a.font);a=this._invalidFontsMap.has(f);return this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":f,c,d).catch(function(a){q.error(new l("mapview-invalid-resource","Couldn't find font "+f+". Falling back to Arial Unicode MS Regular"));b._invalidFontsMap.set(f,!0);return b._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",c,d)})};e.prototype._rasterizeSpriteSymbol=function(a,c){return r(this,void 0,void 0,function(){var d,b,f,e,
n,p;return t(this,function(g){g="CIMSolidStroke"===a.type||"CIMSolidFill"===a.type?!0:a&&(m.isFillSymbol(a)||m.isLineSymbol(a))&&"style"in a&&("solid"===a.style||"esriSFSSolid"===a.style||"esriSLSSolid"===a.style||"none"===a.style||"esriSFSNull"===a.style||"esriSLSNull"===a.style);if(g)return[2,null];d=m.keyFromSymbol(a);return this._spriteMosaic.has(d)?[2,this._spriteMosaic.getSpriteItem(d)]:"simple-marker"!==a.type&&"esriSMS"!==a.type||!a.path?a.url||a.imageData?[2,this._handleImage(a,d,c)]:(b=
this._rasterizer.rasterizeJSONResource(a))?(f=b.size,e=b.image,n=b.sdf,p=b.simplePattern,[2,this._addItemToMosaic(d,f,e,!m.isMarkerSymbol(a),n,p)]):[2,new l("TextureManager","unrecognized or null rasterized image")]:[2,this._handleSVG(a,d,c)]})})};e.prototype._handleSVG=function(a,c,d){return r(this,void 0,void 0,function(){var b,f;return t(this,function(e){switch(e.label){case 0:return b=[126,126],[4,this._sdfConverter.draw(a.path,d)];case 1:return f=e.sent(),[2,this._addItemToMosaic(c,b,new Uint32Array(f.buffer),
!1,!0,!0)]}})})};e.prototype._handleImage=function(a,c,d){return r(this,void 0,void 0,function(){var b,e,g,n,p,h,k;return t(this,function(f){switch(f.label){case 0:b=a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url,f.label=1;case 1:return f.trys.push([1,3,,4]),[4,z(b,x({responseType:"image"},d))];case 2:return e=f.sent().data,g=this._rasterizer.rasterizeImageResource(e,a.colorSubstitutions),n=g.size,p=g.sdf,h=g.image,[2,this._addItemToMosaic(c,n,h,!m.isMarkerSymbol(a),p,!1)];case 3:return k=
f.sent(),u.isAbortError(k)?[3,4]:[2,new l("mapview-invalid-resource","Could not fetch requested resource at "+b)];case 4:return[2,void 0]}})})};e.prototype._addItemToMosaic=function(a,c,d,b,e,g){return this._spriteMosaic.addSpriteItem(a,c,d,b,e,g)};return e}()});