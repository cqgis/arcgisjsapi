// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Extent ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../engine ../../viewStateUtils ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(F,G,H,v,w,x,d,y,k,a,q,z,A,B,C,m,D,E){var e=z.create(),f=[0,0],r=new E(0,0,0,0);return function(t){function c(c){var b=t.call(this,c)||this;b._imagePromise=null;b.hidpi=!1;b.imageMaxWidth=2048;b.imageMaxHeight=2048;b.imageRotationSupported=!1;b.imageNormalizationSupported=!1;b.update=k.debounce(function(c){return w(b,void 0,void 0,function(){var b,g,a,n,d,e,u,p,l,h=this;return v(this,function(I){b=c.state;g=A.getInfo(b.spatialReference);a=this.hidpi?c.pixelRatio:1;if(!c.stationary||this.destroyed)return[2];
this.imageRotationSupported?(f[0]=b.size[0],f[1]=b.size[1]):m.getOuterSize(f,b);n=Math.floor(f[0]*a)>this.imageMaxWidth||Math.floor(f[1]*a)>this.imageMaxHeight;d=g&&(b.extent.xmin<g.valid[0]||b.extent.xmax>g.valid[1]);e=!this.imageNormalizationSupported&&d;u=!n&&!e;p=this.imageRotationSupported?b.rotation:0;u?this._imagePromise=this._singleExport(b,f,p,a):(l=Math.min(this.imageMaxWidth,this.imageMaxHeight),e&&(l=Math.min(b.worldScreenWidth,l)),this._imagePromise=this._tiledExport(b,l,p,a));return[2,
this._imagePromise.then(function(b){h._imagePromise=null;var c=h.container.children.slice();h.container.removeAllChildren();b.forEach(h.container.addChild,h.container);h.disposeSource&&c.forEach(function(b){h.disposeSource(b.source)},h)}).catch(function(b){h._imagePromise=null;if(!k.isAbortError(b))throw b;})]})})});return b}x(c,t);c.prototype.destroy=function(){};Object.defineProperty(c.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0});c.prototype.updateExports=
function(c){for(var b=0,g=this.container.children;b<g.length;b++){var a=g[b];if(!a.visible||!a.attached)break;c(a)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(a.invalidateTexture(),a.requestRender())}};c.prototype._export=function(c,b,a,d,e){var g=this;return k.resolve().then(function(){return g.fetchSource(c,Math.floor(b*e),Math.floor(a*e),{rotation:d,pixelRatio:e})}).then(function(a){a=new C.Bitmap(a);a.x=c.xmin;a.y=c.ymax;a.resolution=c.width/b;a.rotation=d;a.pixelRatio=
e;return a})};c.prototype._singleExport=function(a,b,c,d){m.getBBox(e,a.center,a.resolution,b);a=new q(e[0],e[1],e[2],e[3],a.spatialReference);return this._export(a,b[0],b[1],c,d).then(function(b){return[b]})};c.prototype._tiledExport=function(a,b,c,d){var g=this,f=B.create({size:b,spatialReference:a.spatialReference,scales:[a.scale]}),n=new D(f),f=n.getTileCoverage(a);if(!f)return null;var m=[];f.forEach(function(f,k,p,l){r.set(f,k,p,l);n.getTileBounds(e,r);f=new q(e[0],e[1],e[2],e[3],a.spatialReference);
m.push(g._export(f,b,b,c,d))});return k.all(m)};d([a.property()],c.prototype,"_imagePromise",void 0);d([a.property()],c.prototype,"container",void 0);d([a.property()],c.prototype,"disposeSource",void 0);d([a.property()],c.prototype,"fetchSource",void 0);d([a.property()],c.prototype,"hidpi",void 0);d([a.property()],c.prototype,"imageMaxWidth",void 0);d([a.property()],c.prototype,"imageMaxHeight",void 0);d([a.property()],c.prototype,"imageRotationSupported",void 0);d([a.property()],c.prototype,"imageNormalizationSupported",
void 0);d([a.property()],c.prototype,"requestUpdate",void 0);d([a.property({dependsOn:["_imagePromise"]})],c.prototype,"updating",null);return c=d([a.subclass("esri.views.2d.layers.support.ExportStrategy")],c)}(a.declared(y))});