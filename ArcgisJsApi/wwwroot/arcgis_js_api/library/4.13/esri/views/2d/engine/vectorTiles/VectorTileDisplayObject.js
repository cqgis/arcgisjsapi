// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/ObjectPool ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../geometry/support/spatialReferenceUtils ../../../webgl ../../engine ./RenderBucket".split(" "),function(A,B,t,u,v,w,x,d,y,p){var z="fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer".split(" ");
return function(r){function c(){for(var a,k=[],b=0;b<arguments.length;b++)k[b]=arguments[b];b=r.call(this)||this;b._renderBuckets=[];b._vectorTileData=null;b._symbolUpdateData=null;b._memoryUsed=-1;b.coords=[0,0];b.bounds=[0,0,0,0];b.tileTransform={transform:v.mat4f32.create(),displayCoord:w.vec2f32.create()};b.stencilData={mask:0,reference:0};b._referenced=0;b.triangleCount=0;0<k.length&&(a=b.acquire).call.apply(a,[b].concat(k));return b}t(c,r);Object.defineProperty(c.prototype,"stencilRef",{get:function(){return this.stencilData.reference},
enumerable:!0,configurable:!0});c.prototype.acquire=function(a,k,b,f){this.key=a;this._referenced=1;this._memoryUsed=-1;this._vectorTileData=this._symbolUpdateData=null;var e=k.lodAt(a.level),e=null!==e?e.resolution:0,q=k.size[0]*e,g=k.origin,c=a.col*q,h=a.row*q,d=k.spatialReference,n=0;d&&(d._isWrappable?d._isWrappable():d.isWrappable)&&(d=x.getInfo(d),n=d.valid[1]-d.valid[0]);c=g.x+c+a.world*n;g=g.y-h;this.coords[0]=c;this.coords[1]=g;this.bounds[0]=c;this.bounds[1]=g;this.bounds[2]=c+q;this.bounds[3]=
g-q;this.widthInPixels=k.size[1];this.coordRange=4096;this.resolution=e;this.rotation=f;this.styleLayers=b;this.id=a.id};c.prototype.setData=function(a,k,b){this._vectorTileData=a;this.client=k;this.refKeys=b;this._memoryUsed=-1};c.prototype.updateSymbolData=function(a){a&&(this._symbolUpdateData=a,this.requestRender())};c.prototype.updateTileData=function(a){this._vectorTileData=a;this.stage.requestRender();this._memoryUsed=-1};c.prototype.dispose=function(){for(var a=0,k="fillVertexArrayObject fillDDVertexArrayObject outlineVertexArrayObject lineVertexArrayObject lineDDVertexArrayObject iconVertexArrayObject iconDDVertexArrayObject textVertexArrayObject textDDVertexArrayObject circleVertexArrayObject fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer texture".split(" ");a<
k.length;a++){var b=k[a];this[b]&&(this[b].dispose(),this[b]=null)}this._renderBuckets.length=0;this._memoryUsed=-1};c.prototype.release=function(){return 0===--this._referenced?(this.dispose(),this.attached=!1,this.stage=null,!0):!1};c.prototype.reference=function(){++this._referenced};Object.defineProperty(c.prototype,"referenced",{get:function(){return this._referenced},enumerable:!0,configurable:!0});c.prototype.getMemoryUsage=function(){var a=this;-1===this._memoryUsed&&(this._memoryUsed=z.reduce(function(k,
b){return a[b]?k+a[b].size:k},0),this.texture&&(this._memoryUsed+=this.texture.descriptor.width*this.texture.descriptor.height*4),this._vectorTileData&&this._vectorTileData.bufferData&&(this._memoryUsed+=this._vectorTileData.bufferData.reduce(function(a,b){return a+b.byteLength},0)+this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength));return this._memoryUsed/(this._referenced||1)};c.prototype.attach=function(){return this._vectorTileData?(this.ready(),!0):
!1};c.prototype.attachWithContext=function(a){this.stage={context:a};this.attached=this.attach()};c.prototype._commitChanges=function(){this._vectorTileData&&(this.dispose(),this._createRenderBuckets(),this._createBufferObjects(),this._vectorTileData=null,this._memoryUsed=-1)};c.prototype._createRenderBuckets=function(){for(var a=new Uint32Array(this._vectorTileData.bucketDataInfo),k=a.length,b=0;b<k;){var f=a[b];switch(a[b+1]){case 0:var e=new p.BackgroundRenderBucket;e.layerID=f;this._renderBuckets.push(e);
b+=2;break;case 1:e=new p.FillRenderBucket;e.layerID=f;e.triangleElementStart=a[b+2];e.triangleElementCount=a[b+3];e.outlineElementStart=a[b+4];e.outlineElementCount=a[b+5];this._renderBuckets.push(e);b+=6;break;case 2:e=new p.LineRenderBucket;e.layerID=f;e.triangleElementStart=a[b+2];e.triangleElementCount=a[b+3];this._renderBuckets.push(e);b+=4;break;case 3:e=new p.SymbolRenderBucket;e.layerID=f;e.isSDF=0!==a[b+2];var d=b+3,f=a[d];d++;for(var g=0;g<f;g++){var c=a[d],h=a[d+1],m=a[d+2];e.markerPerPageElementsMap.set(c,
[h,m]);d+=3}var n=a[d];d++;for(g=0;g<n;g++)c=a[d],h=a[d+1],m=a[d+2],e.glyphPerPageElementsMap.set(c,[h,m]),d+=3;this._renderBuckets.push(e);b+=5+3*f+3*n;break;case 4:e=new p.CircleRenderBucket;e.layerID=f;e.triangleElementStart=a[b+2];e.triangleElementCount=a[b+3];this._renderBuckets.push(e);b+=4;break;default:console.error("Bad bucket type!"),b+=2}}};c._createBufferToObject=function(){var a=[];a[1]={create:d.BufferObject.createVertex,var:"fillVertexBuffer"};a[2]={create:d.BufferObject.createVertex,
var:"fillDDVertexBuffer"};a[3]={create:d.BufferObject.createIndex,var:"fillIndexBuffer"};a[4]={create:d.BufferObject.createVertex,var:"outlineVertexBuffer"};a[5]={create:d.BufferObject.createVertex,var:"outlineDDVertexBuffer"};a[6]={create:d.BufferObject.createIndex,var:"outlineIndexBuffer"};a[7]={create:d.BufferObject.createVertex,var:"lineVertexBuffer"};a[8]={create:d.BufferObject.createVertex,var:"lineDDVertexBuffer"};a[9]={create:d.BufferObject.createIndex,var:"lineIndexBuffer"};a[10]={create:d.BufferObject.createVertex,
var:"iconVertexBuffer"};a[11]={create:d.BufferObject.createVertex,var:"iconDDVertexBuffer"};a[12]={create:d.BufferObject.createIndex,var:"iconIndexBuffer"};a[13]={create:d.BufferObject.createVertex,var:"textVertexBuffer"};a[14]={create:d.BufferObject.createVertex,var:"textDDVertexBuffer"};a[15]={create:d.BufferObject.createIndex,var:"textIndexBuffer"};a[16]={create:d.BufferObject.createVertex,var:"circleVertexBuffer"};a[17]={create:d.BufferObject.createIndex,var:"circleIndexBuffer"};return a};c.prototype._createBufferObjects=
function(){for(var a=this.stage.context,d=new Uint32Array(this._vectorTileData.bufferDataInfo),b=d.length,f=0;f<b;f+=2){var e=f/2;if(!(0>=d[f+1]||0===this._vectorTileData.bufferData[e].byteLength)){var q=d[f],g=c.bufferToObject[q];g?this[g.var]?this[g.var].setData(this._vectorTileData.bufferData[e]):this[g.var]=g.create(a,35044,this._vectorTileData.bufferData[e]):console.error("Bad buffer type "+q)}}};c.prototype.detach=function(){this.isReady&&this.client&&this.client.invoke("destructTileData",this.id);
this.dispose();r.prototype.detach.call(this)};c.prototype.doRender=function(a){if(this.visible&&this.isReady){var d=this.stage.context,b=a.renderer;if(d&&b){this._commitChanges();var f=a.drawphase;this._symbolUpdateData&&(this._updateSymbolData(a,this._symbolUpdateData),this._symbolUpdateData=null);d.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var e=this.styleLayers,c=void 0!==a.layerOpacity?a.layerOpacity:1;if(0!==c){var g=this._renderBuckets.length;if(1===f)for(var l=
g-1;0<=l;l--){var h=this._renderBuckets[l],m=e.layers[h.layerID];if(!h||!m)break;1!==h.type&&0!==h.type||!h.hasData()||(this.triangleCount+=b.renderBucket(d,h,a.displayLevel,a.requiredLevel,f,this,m,c))}else for(l=0;l<g;l++){h=this._renderBuckets[l];m=e.layers[h.layerID];if(!h||!m)break;h.hasData()&&(this.triangleCount+=b.renderBucket(d,h,a.displayLevel,a.requiredLevel,f,this,m,c))}}}}};c.prototype._updateSymbolData=function(a,c){if(!c||!c.bucketDataInfo)return!0;a=new Uint32Array(c.bucketDataInfo);
var b=a.length;if(0===b)return!0;this._memoryUsed=-1;if(!this.isReady)return this.requestRender(),!1;for(var f=this.stage.context,e=new Uint32Array(c.bufferDataInfo),k=e.length,g=0,l=0;l<k;l+=2,g++)switch(e[l]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconVertexBuffer=d.BufferObject.createVertex(f,35044,c.bufferData[g]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconDDVertexBuffer=
d.BufferObject.createVertex(f,35044,c.bufferData[g]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.iconIndexBuffer=d.BufferObject.createIndex(f,35044,c.bufferData[g]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null);this.textVertexBuffer=d.BufferObject.createVertex(f,35044,c.bufferData[g]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null);this.textDDVertexBuffer=
d.BufferObject.createVertex(f,35044,c.bufferData[g]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=d.BufferObject.createIndex(f,35044,c.bufferData[g])}c=[];for(f=0;f<this._renderBuckets.length;f++)this._renderBuckets[f]instanceof p.SymbolRenderBucket||c.push(this._renderBuckets[f]);this._renderBuckets=c;for(f=0;f<b;){k=a[f];e=new p.SymbolRenderBucket;e.layerID=k;e.isSDF=0!==a[f+2];this.styleLayers.layers.length>e.layerID&&this.styleLayers.layers[e.layerID].type===
e.type&&c.push(e);var h=f+3,k=a[h];h++;for(g=0;g<k;g++){var l=a[h],m=a[h+1],n=a[h+2];e.markerPerPageElementsMap.set(l,[m,n]);h+=3}var r=a[h];h++;for(g=0;g<r;g++)l=a[h],m=a[h+1],n=a[h+2],e.glyphPerPageElementsMap.set(l,[m,n]),h+=3;f+=5+3*k+3*r}this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),
this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null);return!0};c.pool=new u(c);c.bufferToObject=c._createBufferToObject();return c}(y.DisplayObject)});