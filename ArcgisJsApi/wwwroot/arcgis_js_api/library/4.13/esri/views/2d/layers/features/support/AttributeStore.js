// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../layers/support/FieldsIndex ../../../../../support/arcadeOnDemand ../../../../webgl ../../../engine ../../../arcade/utils ../../../engine/webgl/definitions ../tileRenderers/support/visualVariablesUtils @dojo/framework/shim/Promise".split(" "),
function(D,A,p,n,v,t,E,F,g,r,G,H,M,k,I,B,J){Object.defineProperty(A,"__esModule",{value:!0});var q=E.getLogger("esri.views.layers.2d.features.support.AttributeStore"),u=k.debug.createDebugLogger(k.debug.DEBUG_ATTR_UPDATES,q),x=function(c,a){return function(b,e,d){var f;try{f=a(b,e,d)}catch(m){f=NaN}return(null===f||isNaN(f)||Infinity===f)&&c||f}},y=t("esri-shared-array-buffer"),z=t("esri-webgl-texture-float"),K=t("esri-webgl-max-texture-size"),C=t("esri-atomics"),L=function(){function c(a,b,e,d){this.texelSize=
4;var f=d.pixelType,c=d.layout;this.textureOnly=(d=d.textureOnly)||!1;this.pixelType=f;this._ctype=b;this.layout=c;this._resetRange();this._shared=a;d||(this.data=this._initData(f,e,a,b))}Object.defineProperty(c.prototype,"buffer",{get:function(){return g.andThen(this.data,function(a){return a.buffer})},enumerable:!0,configurable:!0});c.prototype.getData=function(a,b){return g.expect(this.data)[a*this.texelSize+b]};c.prototype.setData=function(a,b,e,d){void 0===d&&(d=!0);0===(this.layout&1<<b)?q.error("mapview-attributes-store",
"Tried to set a value for a texel's readonly component"):(this.data[a*this.texelSize+b]=e,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))};c.prototype.lock=function(){this._shared&&C&&Atomics.store(this.data,0,1)};c.prototype.unlock=function(){this._shared&&C&&Atomics.store(this.data,0,0)};c.prototype.expand=function(a){if(!this.textureOnly){a=this._initData(this.pixelType,a,this._shared,this._ctype);var b=g.expect(this.data);a.set(b);this.data=a}};c.prototype.toMessage=
function(){var a=this.dirtyStart,b=this.dirtyEnd,e=this.texelSize;if(a>b)return null;this._resetRange();var d=!this._shared&&"local"!==this._ctype,f=this.pixelType,c=this.layout,h=g.expect(this.data);if(!h.slice){if(!d)return{start:a,end:b,data:null,pixelType:f,layout:c};e=new (k.Utils.getPixelArrayCtor(this.pixelType))(Array.prototype.slice.call(this.data,a*e,(b+1)*e));return{start:a,end:b,data:e,pixelType:f,layout:c}}e=d&&h.slice(a*e,(b+1)*e)||null;return{start:a,end:b,data:e,pixelType:f,layout:c}};
c.prototype._initData=function(a,b,e,d){e=e&&"local"!==d?SharedArrayBuffer:ArrayBuffer;a=k.Utils.getPixelArrayCtor(a);b=new a(new e(b*b*4*a.BYTES_PER_ELEMENT));for(a=0;a<b.length;a+=4)b[a+1]=255;return b};c.prototype._resetRange=function(){this.dirtyStart=4294967295;this.dirtyEnd=0};return c}();t=function(){function c(a){this._attributeComputeMap=new Map;this._blocks=[];this._idMap=new Map;this._localToObjectId=new Map;this._filters=Array(k.definitions.MAX_FILTERS);this._freeList=[];this._abortController=
r.createAbortController();this._hasScaleExpr=!1;this._size=32;this._idCounter=1;this._idsToHighlight=new Set;var b=z?5126:5121;u("Creating AttributeStore "+(y?"with":"without")+" shared memory");this._client=a;this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:b,layout:15},{pixelType:b,layout:15}];this._blocks=this._blockDescriptors.map(function(a){return null})}c.prototype.destroy=function(){this._abortController.abort()};Object.defineProperty(c.prototype,
"hasScaleExpr",{get:function(){return this._hasScaleExpr},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_signal",{get:function(){return this._abortController.signal},enumerable:!0,configurable:!0});c.prototype.createLocalId=function(a){if(!this._idMap.has(a)){var b=this._getFreeId();this._idMap.set(a,-1===b?0:b);this._localToObjectId.set(b,a)}return this._idMap.get(a)};c.prototype.freeLocalId=function(a){var b=this._idMap.get(a);this._idMap.delete(a);this._localToObjectId.delete(b);
this._freeList.push(b)};c.prototype.getFeatureId=function(a){return this._localToObjectId.get(a)};c.prototype.getLocalId=function(a){return this._idMap.has(a)?this._idMap.get(a):null};c.prototype.setHighlight=function(a){return n(this,void 0,void 0,function(){var b,e,d,c,m,h,l=this;return p(this,function(f){switch(f.label){case 0:this._getBlock(0).lock();this._idsToHighlight.forEach(function(a){if(a=l.getLocalId(a)){var b=l._getBlock(0).getData(a,0);l._getBlock(0).setData(a,0,b&-2)}});this._idsToHighlight.clear();
b=0;for(e=a;b<e.length;b++)d=e[b],this._idsToHighlight.add(d);for(c=0;c<a.length;c++)m=this.getLocalId(a[c]),null!=m&&(h=this._getBlock(0).getData(m,0),this._getBlock(0).setData(m,0,h|1));this._getBlock(0).unlock();return[4,this.sendUpdates()];case 1:return f.sent(),[2]}})})};c.prototype.addHighlight=function(a){return n(this,void 0,void 0,function(){return p(this,function(a){return[2]})})};c.prototype.removeHighlight=function(a){return n(this,void 0,void 0,function(){return p(this,function(a){return[2]})})};
c.prototype.updateFilters=function(a){return n(this,void 0,void 0,function(){var b,e,d,c,m,h,l=this;return p(this,function(f){switch(f.label){case 0:return b=a.config,e=a.service,d=a.spatialReference,c=b.filters,m=b.definitionExpression,h=c.map(function(b,c){return l._updateFilter(a,b,c,e,m,d)}),[4,r.all(h)];case 1:return f.sent(),[2]}})})};c.prototype.setAttributeBindings=function(a,b){return n(this,void 0,void 0,function(){return p(this,function(e){this._hasScaleExpr=!1;switch(a.type){case "simple":case "class-breaks":case "unique-value":case "dictionary":return[2,
this._bindVVEvaluators(a.visualVariables,b)];case "dot-density":return[2,this._bindDDEvaluators(a.attributes,b)];case "heatmap":break;default:q.error(v("attribute-store","Found invalid renderer type: "+a))}return[2]})})};c.prototype.setData=function(a,b,e,d){this._getBlock(b).setData(a,e,d)};c.prototype.setAttributeData=function(a,b,e,d){var c=this;this._getBlock(0).setData(a,0,this._getFilterFlags(b));var m=z?1:2;this._attributeComputeMap.forEach(function(f,l){var h=l*m%4;l=c._getBlock(Math.floor(l*
m/4)+B.ATTRIBUTE_DATA_VV);f=f(b,{$view:d},e);if(z)l.setData(a,h,f);else if(f===k.definitions.NAN_MAGIC_NUMBER)l.setData(a,h,255),l.setData(a,h+1,255);else{f=F.clamp(Math.round(f),-32767,32766)+32768;var g=(f&65280)>>8;l.setData(a,h,f&255);l.setData(a,h+1,g)}})};c.prototype.sendUpdates=function(){var a=this;if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=r.createResolver(),this._nextUpdate.promise;var b={blocks:this._blocks.map(function(a){return g.isSome(a)?
a.toMessage():null})};return this._currUpdate=this._createResources().then(function(){var e=a._client.update(b,a._signal).then(function(){a._currUpdate=null;if(a._nextUpdate){var b=a._nextUpdate;a._nextUpdate=null;a.sendUpdates().then(function(){return b.resolve()})}});a._client.render();return e})};c.prototype._createResources=function(){var a=this;if(g.isSome(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(B.ATTRIBUTE_DATA_ANIMATION);u("Initializing AttributeStore");
var b={shared:y&&"local"!==this._client.type,size:this._size,blocks:g.mapMany(this._blocks,function(a){return{textureOnly:a.textureOnly,buffer:a.buffer,pixelType:a.pixelType}})};this._createResourcesPromise=b=this._client.initialize(b,this._signal);b.then(function(){return g.isNone(a._createResourcesPromise)?a._createResources():void 0});return b};c.prototype._getBlock=function(a){var b=this._blocks[a];if(g.isSome(b))return b;u("Initializing AttributeBlock at index "+a);b=new L(y,this._client.type,
this._size,this._blockDescriptors[a]);this._blocks[a]=b;this._createResourcesPromise=null;return b};c.prototype._expand=function(){if(this._size<K){var a=this._size<<=1;u("Expanding block size to",a,this._blocks);g.forEachSome(this._blocks,function(b){return b.expand(a)});this._createResourcesPromise=null;this._size=a;return 0}q.error(v("mapview-limitations","Maximum number of onscreen features exceeded."));return-1};c.prototype._getFreeId=function(){return this._freeList.length?this._freeList.pop():
this._idCounter>=this._size*this._size&&this._expand()?-1:this._idCounter++};c.prototype._updateFilter=function(a,b,e,c,f,m){return n(this,void 0,void 0,function(){var d,l,k,n,q,t,r,u,v,w=this;return p(this,function(h){switch(h.label){case 0:d=this._filters[e];l=g.isSome(d)&&d.hash;if(l===JSON.stringify(b))return[2];k=1<<e+1;return g.isNone(b)?(this._filters[e]=null,this._idMap.forEach(function(a){var b=w._getBlock(0).getData(a,0);w._getBlock(0).setData(a,0,b|k)}),[2]):[4,a.queryObjectIds(b)];case 1:return n=
h.sent(),b.hiddenIds&&b.hiddenIds.length&&(n=n.filter(function(a){return-1===b.hiddenIds.indexOf(a)})),q=n.map(function(a){return w._idMap.get(a)}),[4,this._getFilter(e,c)];case 2:t=h.sent();t.update(b,f,m);this._getBlock(0).lock();this._idMap.forEach(function(a){var b=w._getBlock(0).getData(a,0);w._getBlock(0).setData(a,0,b&~k)});for(r=0;r<q.length;r++)u=q[r],null!=u&&(v=this._getBlock(0).getData(u,0),this._getBlock(0).setData(u,0,v|k));this._getBlock(0).unlock();return[2]}})})};c.prototype._getFilter=
function(a,b){return n(this,void 0,void 0,function(){var e,c,f;return p(this,function(d){switch(d.label){case 0:return e=this._filters[a],g.isSome(e)?[2,e]:[4,new Promise(function(a,b){D(["../../../../../layers/graphics/data/FeatureFilter"],a,b)})];case 1:return c=d.sent().default,f=new c({geometryType:b.geometryType,hasM:!1,hasZ:!1,timeInfo:b.timeInfo,fieldsIndex:new G(b.fields)}),this._filters[a]=f,[2,f]}})})};c.prototype._getFilterFlags=function(a){for(var b=0,c=0;c<this._filters.length;c++)var d=
this._filters[c],d=g.isNone(d)||d.check(a),b=b|(d?1:0)<<c;a=this.getFeatureId(a.localId);a=this._idsToHighlight.has(a)?1:0;return b<<1|a};c.prototype._bindVVEvaluators=function(a,b){return n(this,void 0,void 0,function(){var c,d=this;return p(this,function(e){switch(e.label){case 0:this._attributeComputeMap.clear();if(!g.isSome(a))return[3,2];c=r.all(a.map(function(a){return n(d,void 0,void 0,function(){var c,d;return p(this,function(e){switch(e.label){case 0:return c=k.Utils.getVVType(a.type),[4,
this._createGetValueFunction(a,b)];case 1:return d=e.sent(),g.isSome(d)&&this._attributeComputeMap.set(c,d),[2]}})})}));return[4,c];case 1:e.sent(),e.label=2;case 2:return[2]}})})};c.prototype._bindDDEvaluators=function(a,b){return n(this,void 0,void 0,function(){var c,d,f,m=this;return p(this,function(e){switch(e.label){case 0:return this._attributeComputeMap.clear(),a.length>k.definitions.DOT_DENSITY_MAX_FIELDS&&q.warn("mapview-invalid-value","DotDensityRenderer supports a maximum of "+k.definitions.DOT_DENSITY_MAX_FIELDS+
" attribtues, but found "+a.length),[4,r.all(a.map(function(a){return m._createNormalizedFunction(a,b)}))];case 1:c=e.sent().map(function(a){return x(0,a)});for(d=0;d<k.definitions.DOT_DENSITY_MAX_FIELDS;d++)(f=d<a.length&&c[d])?this._attributeComputeMap.set(d,f):this._attributeComputeMap.has(d)&&this._attributeComputeMap.delete(d);return[2]}})})};c.prototype._createGetValueFunction=function(a,b){return n(this,void 0,void 0,function(){var c,d,f,m,h,l,g;return p(this,function(e){switch(e.label){case 0:if("size"!==
a.type)return[3,2];c=k.getTypeOfSizeVisualVariable(a);if(c===k.enums.WGLVVFlag.SIZE_SCALE_STOPS)return[2,null];f=(d=c===k.enums.WGLVVFlag.SIZE_UNIT_VALUE)&&function(b){return J.getVisualVariableSizeValueRepresentationRatio(b,a.valueRepresentation)};m=x;h=[k.definitions.NAN_MAGIC_NUMBER];return[4,this._createNormalizedFunction(a,b,f)];case 1:return[2,m.apply(void 0,h.concat([e.sent()]))];case 2:return l=x,g=[k.definitions.NAN_MAGIC_NUMBER],[4,this._createNormalizedFunction(a,b)];case 3:return[2,l.apply(void 0,
g.concat([e.sent()]))]}})})};c.prototype._createNormalizedFunction=function(a,b,c){return n(this,void 0,void 0,function(){var d,e,g;return p(this,function(f){switch(f.label){case 0:if(d=a.field){if("string"===typeof d)return(e=a.normalizationField)?[2,function(a){if(a.attributes[d]&&a.attributes[e])return a=a.attributes[d]/a.attributes[e],c?c(a):a}]:[2,c?function(a){return c(a.attributes[d])}:function(a){return a.attributes[d]}];q.error(v("mapview-rendering:invalid-type","The field for a vv must be a string or a number, but got "+
typeof d));return[2,function(a){}]}if(!a.valueExpression)return[3,2];this._hasScaleExpr=this._hasScaleExpr||-1!==a.valueExpression.indexOf("scale");return[4,H.createVVExpression(a.valueExpression,b.spatialReference,b.fields)];case 1:return g=f.sent(),[2,I.callWithOptimizedFeature.bind(null,g)];case 2:return q.error("Unable to create a normalized function for visual variable: "+a),[2,function(a){}]}})})};return c}();A.default=t});