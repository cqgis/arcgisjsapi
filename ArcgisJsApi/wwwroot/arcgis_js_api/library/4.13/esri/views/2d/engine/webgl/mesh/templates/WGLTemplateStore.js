// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/awaiterHelper ../../../../../../core/tsSupport/generatorHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/cim/cimAnalyzer ../../../../../../symbols/support/defaults ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/BidiText ../../util/Lock ../../util/Result".split(" "),
function(w,q,g,h,C,D,k,E,t,F,G,H,u,x,v,y,I,z,l){function n(b,a){var e=b.length;b.push(null);a.then(function(a){return b[e]=a});return b}function A(b){return!!(b&1)}Object.defineProperty(q,"__esModule",{value:!0});var m=D.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),B=[];q.isDynamicId=A;w=function(){function b(a,e){this._templateIdCounter=this._idCounter=0;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=
new Map;this._cimAnalyses=[];this._lock=new z.default;this._fetchResource=a;this._joinOnUTurn=e}Object.defineProperty(b.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});b.prototype.createTemplateGroup=function(a,e,c,d){return g(this,void 0,void 0,function(){var r,b,p;return h(this,function(f){switch(f.label){case 0:return[4,this._initErrorTemplates()];case 1:f.sent();r=JSON.stringify(a);if(this._symbolToTemplate.has(r))return[2,this._symbolToTemplate.get(r)];b=[];return e?[4,this._createMeshTemplates(b,e,c,d,!0)]:[3,3];case 2:f.sent(),f.label=3;case 3:return[4,this._createMeshTemplates(b,
a,c,d,!1)];case 4:return f.sent(),p=this._createGroupId("cim"===a.type),this._idToTemplateGroup.set(p,b),this._symbolToTemplate.set(r,p),[2,p]}})})};b.prototype.getCIMMosaicItem=function(a,e){var c=this,d=this._createTemplateId(),b=k.create(function(a){return c._idToResolver.set(d,a)});this._fetchQueue.push({symbol:a,id:d,glyphIds:e});return b};b.prototype.getTemplateGroup=function(a){return this._idToTemplateGroup.has(a)?this._idToTemplateGroup.get(a):B};b.prototype.getDynamicTemplateGroup=function(a){if(!this._idToTemplateGroup.has(a))return B;
A(a)||m.error("mapview-template-store","Id "+a+" does not refer to a dynamic template");return this._idToTemplateGroup.get(a)};b.prototype.finalize=function(a){return this._fetchQueue.length||this._lock.isHeld()?z.withLock(this._lock,this._fetchAllQueuedResources.bind(this),a):k.resolve()};b.prototype._initErrorTemplates=function(){return g(this,void 0,void 0,function(){var a,e,c,d;return h(this,function(b){switch(b.label){case 0:if(this._errorTemplates)return[2];a=this._createMeshTemplates([],t.errorPolygonSymbol2D,
null,null,!1);e=this._createMeshTemplates([],t.errorPointSymbol2D,null,null,!1);c=this._createMeshTemplates([],t.errorPolylineSymbol2D,null,null,!1);return[4,k.all([a,e,c])];case 1:return d=b.sent(),this._errorTemplates={fill:d[0],marker:d[1],line:d[2]},[2]}})})};b.prototype._fetchAllQueuedResources=function(a){var e=this;if(!this._fetchQueue.length)return k.resolve();var c=this._fetchQueue,d=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return k.all(d).then(function(){return e._fetchResource(c,
a).then(function(a){for(var c=0;c<a.length;c++){var d=a[c],b=d.id,d=d.mosaicItem;e._idToResolver.get(b)(d);e._idToResolver.delete(b)}})}).catch(function(a){k.isAbortError(a)?e._fetchQueue=e._fetchQueue.concat(c):m.error(C("mapview-template-store","Unable to fetch requested texture resources",a))})};b.prototype._createGroupId=function(a){return this._idCounter++<<1|(a?1:0)};b.prototype._createTemplateId=function(){return this._templateIdCounter++};b.prototype._getCodepoints=function(a){a=I.bidiText(a.text)[0];
for(var e=[],c=0;c<a.length;c++)e.push(a.charCodeAt(c));return e};b.prototype._getMosaicItem=function(a){var e=this,c=this._createTemplateId(),d="text"===a.type&&this._getCodepoints(a),b=k.create(function(a){return e._idToResolver.set(c,a)});this._fetchQueue.push({symbol:a.toJSON(),id:c,glyphIds:d});return b};b.prototype._createSMS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().spriteMosaicItem,
l.ok(c,m)?[2,v.default.fromSimpleMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createPMS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().spriteMosaicItem,l.ok(c,m)?[2,v.default.fromPictureMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createSFS=function(a,e,c){return g(this,void 0,void 0,function(){var d,b;return h(this,function(f){switch(f.label){case 0:return[4,
this._getMosaicItem(a)];case 1:return d=f.sent().spriteMosaicItem,b=a,l.ok(d,m)?[2,u.default.fromSimpleFill(e,b,d,c)]:[2,this._fillError]}})})};b.prototype._createPFS=function(a,e,c){return g(this,void 0,void 0,function(){var d,b;return h(this,function(f){switch(f.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=f.sent().spriteMosaicItem,b=a,l.ok(d,m)?[2,u.default.fromPictureFill(e,b,d,c)]:[2,this._fillError]}})})};b.prototype._createSLS=function(a,e,c){return g(this,void 0,void 0,function(){var d,
b;return h(this,function(f){switch(f.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=f.sent().spriteMosaicItem,b=a,l.ok(d,m)?[2,x.default.fromSimpleLine(e,c,b,d,this._joinOnUTurn)]:[2,this._lineError]}})})};b.prototype._createTS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().glyphMosaicItems,[2,y.default.fromText(e,a,c)]}})})};b.prototype._createCIMText=function(a,
e){return g(this,void 0,void 0,function(){var c,d,b,f,p,g;return h(this,function(h){switch(h.label){case 0:if("function"===typeof a.materialHash)return[2,k.resolve(H.default.fromCIMText(e,a))];c=[];if(d=a.text)for(b=d.length,f=0;f<b;f++)p=d.charCodeAt(f),c.push(p);a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim,c)];case 1:return g=h.sent().glyphMosaicItems,l.ok(g,m)?[2,y.default.fromCIMText(e,a,g)]:[2,this._textError]}})})};b.prototype._createCIMFill=function(a,b){return g(this,
void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,l.ok(c,m)?[2,u.default.fromCIMFill(b,a,c,!1)]:[2,this._fillError]}})})};b.prototype._createCIMLine=function(a,b){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,k.resolve(F.default.fromCIMLine(b,a))];a.cim.mosaicHash=
a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,l.ok(c,m)?[2,x.default.fromCIMLine(b,a,c,!1,this._joinOnUTurn)]:[2,this._lineError]}})})};b.prototype._createCIMMarker=function(a,b){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,k.resolve(G.default.fromCIMMarker(b,a))];a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,
l.ok(c,m)?[2,v.default.fromCIMMarker(b,a,c)]:[2,this._markerError]}})})};b.prototype._createCIM=function(a,b){return g(this,void 0,void 0,function(){var c,d,e=this;return h(this,function(f){c=a.templateHash;if(this._cimTemplateCache.has(c))return[2,this._cimTemplateCache.get(c)];switch(a.type){case "marker":d=this._createCIMMarker(a,b);break;case "line":d=this._createCIMLine(a,b);break;case "fill":d=this._createCIMFill(a,b);break;case "text":d=this._createCIMText(a,b)}d.then(function(a){return e._cimTemplateCache.set(c,
a)});return[2,d]})})};b.prototype._getCIMSymbolLayers=function(a,b,c){return g(this,void 0,void 0,function(){var d,e;return h(this,function(f){switch(f.label){case 0:return d=[],e=[],d.push(E.analyzeCIMSymbol(a.data,b,c,e)),[4,k.all(d)];case 1:return f.sent(),[2,e]}})})};b.prototype._createCIMMeshTemplates=function(a,b,c,d){return g(this,void 0,void 0,function(){var e,f,g,m,k,l,q;return h(this,function(h){switch(h.label){case 0:return f=(e=c)?e.fieldMap:null,g=b,[4,this._getCIMSymbolLayers(g,f,d)];
case 1:m=h.sent();k=0;for(l=m;k<l.length;k++)q=l[k],n(a,this._createCIM(q,c));return[2]}})})};b.prototype._createMeshTemplates=function(a,b,c,d,k){return g(this,void 0,void 0,function(){var e,g,l;return h(this,function(f){switch(f.label){case 0:if(-1!==b.type.indexOf("3d"))return m.error("3D symbols are not supported with MapView"),[2,a];e=b.type;switch(e){case "cim":return[3,1];case "simple-marker":return[3,3];case "picture-marker":return[3,4];case "simple-fill":return[3,5];case "picture-fill":return[3,
6];case "simple-line":return[3,7];case "text":return[3,8]}return[3,9];case 1:return[4,this._createCIMMeshTemplates(a,b,c,d)];case 2:return f.sent(),[2,a];case 3:return[2,n(a,this._createSMS(b,c))];case 4:return[2,n(a,this._createPMS(b,c))];case 5:return g=b,n(a,this._createSFS(g,c,k)),g.outline&&n(a,this._createSLS(g.outline,c,!0)),[2,a];case 6:return l=b,n(a,this._createPFS(l,c,k)),l.outline&&n(a,this._createSLS(l.outline,c,!0)),[2,a];case 7:return[2,n(a,this._createSLS(b,c,!1))];case 8:return[2,
n(a,this._createTS(b,c))];case 9:return m.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),[2,a]}})})};return b}();q.WGLTemplateStore=w});