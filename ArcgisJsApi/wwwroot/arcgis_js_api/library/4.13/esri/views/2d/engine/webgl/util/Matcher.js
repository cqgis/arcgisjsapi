// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/support/cimSymbolUtils ../../../arcade/utils".split(" "),function(g,l,C,x,h,q,I,E,r,F){Object.defineProperty(l,"__esModule",{value:!0});var G=q.getLogger("esri/views/2d/engine/webgl/util/Matcher");g=function(){function f(){this._defaultResult=
null}f.fromBasicRenderer=function(b,a,k){return h(this,void 0,void 0,function(){var d,c,e;return x(this,function(t){switch(t.label){case 0:return[4,r.expandSymbols(b.getSymbols())];case 1:return d=t.sent(),c=new f,d.length?[4,a.createTemplateGroup(d[0],null,b,k)]:[3,3];case 2:e=t.sent(),c.setDefault(e),t.label=3;case 3:return[2,c]}})})};f.prototype.size=function(){return 1};f.prototype.getDefault=function(){return this._defaultResult};f.prototype.setDefault=function(b){this._defaultResult=b};f.prototype.match=
function(b,a,k,d,c){return this.getDefault()};f.prototype.analyze=function(b,a,k,d,c){return h(this,void 0,void 0,function(){return x(this,function(a){return[2]})})};return f}();l.FeatureMatcher=g;q=function(f){function b(a,k,d,c){var b=f.call(this)||this;b._intervals=[];b._isMaxInclusive=k;c?b._getValue=F.callWithFeature.bind(null,c):a&&a.length?"function"===typeof a?(b._field=null,b._getValue=a):(b._field=a,b._normalizationInfo=d,b._getValue=b._getValueFromField.bind(b)):b._field=null;return b}
C(b,f);b.fromCBRenderer=function(a,k,d){return h(this,void 0,void 0,function(){var c,f,t,H,y,B,z,u,n,p,v,w,D,A,g,m,h,l,q;return x(this,function(e){switch(e.label){case 0:return c=a.isMaxInclusive,f=a.normalizationField,t=a.normalizationTotal,H=a.normalizationType,y=a.field,B={normalizationField:f,normalizationTotal:t,normalizationType:H},(n=z=a.valueExpression)?[4,E.createRendererExpression(z,d.spatialReference,d.fields)]:[3,2];case 1:n=e.sent(),e.label=2;case 2:return u=n,p=new b(y,c,B,u),[4,r.expandSymbol(a.backgroundFillSymbol)];
case 3:v=e.sent(),w=0,D=a.classBreakInfos,e.label=4;case 4:if(!(w<D.length))return[3,8];A=D[w];return[4,r.expandSymbol(A.symbol)];case 5:return g=e.sent(),[4,k.createTemplateGroup(g,v,a,d)];case 6:m=e.sent(),h={min:A.minValue,max:A.maxValue},p.add(h,m),e.label=7;case 7:return w++,[3,4];case 8:return[4,r.expandSymbol(a.defaultSymbol)];case 9:return(l=e.sent())?[4,k.createTemplateGroup(l,v,a,d)]:[3,11];case 10:q=e.sent(),p.setDefault(q),e.label=11;case 11:return[2,p]}})})};b.prototype.add=function(a,
b){this._intervals.push({interval:a,result:b});this._intervals.sort(function(a,c){return a.interval.min-c.interval.min})};b.prototype.size=function(){return f.prototype.size.call(this)+this._intervals.length};b.prototype.match=function(a,b,d,c,e){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:e},d,c);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(b=0;b<this._intervals.length;b++)if(c=this._intervals[b],d=c.interval,c=c.result,e=this._isMaxInclusive?a<=
d.max:a<d.max,a>=d.min&&e)return c;return this.getDefault()};b.prototype._needsNormalization=function(){var a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};b.prototype._getValueFromField=function(a){var b=a.attributes[this._field];if(!this._needsNormalization())return b;var d=this._normalizationInfo,c=d.normalizationField,e=d.normalizationTotal,d=d.normalizationType;a=!!c&&a.attributes[c];if(d)switch(d){case "field":return(a||void 0)&&b/a;case "log":return Math.log(b)*
Math.LOG10E;case "percent-of-total":return b/e*100;default:G.error("Found unknown normalization type: "+d)}else G.error("Normalization is required, but no type was set!")};return b}(g);l.IntervalMatcher=q;q=function(f){function b(a,b,d){var c=f.call(this)||this;c._resultsMap=new Map;d?c._getValue=F.callWithFeature.bind(null,d):a&&a.length?"function"===typeof a[0]?(c._fields=null,c._getValue=a[0]):(c._fields=a,c._seperator=b||"",c._getValue=c._getValueFromFields.bind(c)):c._fields=null;return c}C(b,
f);b.fromUVRenderer=function(a,k,d){return h(this,void 0,void 0,function(){var c,e,f,g,y,B,z,u,n,p,v,w,h,A,l;return x(this,function(m){switch(m.label){case 0:return c=a.uniqueValueInfos,e=a.fieldDelimiter,f=[a.field],g=a.valueExpression,a.field2&&f.push(a.field2),a.field3&&f.push(a.field3),[4,r.expandSymbol(a.backgroundFillSymbol)];case 1:return y=m.sent(),(z=g)?[4,E.createRendererExpression(g,d.spatialReference,d.fields)]:[3,3];case 2:z=m.sent(),m.label=3;case 3:B=z,u=new b(f,e,B),n=0,p=c,m.label=
4;case 4:if(!(n<p.length))return[3,8];v=p[n];return[4,r.expandSymbol(v.symbol)];case 5:return w=m.sent(),[4,k.createTemplateGroup(w,y,a,d)];case 6:h=m.sent(),u.add(v.value,h),m.label=7;case 7:return n++,[3,4];case 8:return[4,r.expandSymbol(a.defaultSymbol)];case 9:return(A=m.sent())?[4,k.createTemplateGroup(a.defaultSymbol,y,a,d)]:[3,11];case 10:l=m.sent(),u.setDefault(l),m.label=11;case 11:return[2,u]}})})};b.prototype.add=function(a,b){this._resultsMap.set(a.toString(),b)};b.prototype.size=function(){return f.prototype.size.call(this)+
this._resultsMap.size};b.prototype.match=function(a,b,d,c,e){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:e},d,c);if(!a&&(null===a||void 0===a))return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};b.prototype._getValueFromFields=function(a){for(var b=[],d=0,c=this._fields;d<c.length;d++)b.push(a.attributes[c[d]]);return b.join(this._seperator)};return b}(g);l.MapMatcher=q;g=function(f){function b(a,b,d){var c=f.call(this)||
this;c._fidToAttributeHash=new Map;c._attributeHashToGroup=new Map;c._renderer=a;c._fieldMap=a.fieldMap;c._templates=b;c._info=d;return c}C(b,f);b.fromDictionaryRenderer=function(a,f,d){return h(this,void 0,void 0,function(){return x(this,function(c){a.fetchResources({spatialReference:d.spatialReference,fields:d.fields});return[2,new b(a,f,d)]})})};b.prototype.analyze=function(a,b,d,c,f){return h(this,void 0,void 0,function(){var d,e,k,g,h,l,n=this;return x(this,function(p){switch(p.label){case 0:d=
[];e=function(b){var e=b.attributes[a],g=k._fidToAttributeHash.get(e),h=k._hashAttributes(b);if(g===h)return"continue";k._fidToAttributeHash.set(e,h);k._attributeHashToGroup.has(h)||(b=k._renderer.getSymbolAsync(b,{scale:c&&c.scale,viewingMode:c&&c.viewingMode,spatialReference:k._info.spatialReference,abortOptions:f,fields:k._info.fields}).then(function(a){return n._templates.createTemplateGroup(a,null,n._renderer,n._info).then(function(a){return n._attributeHashToGroup.set(h,a)})}),d.push(b))};k=
this;g=0;for(h=b;g<h.length;g++)l=h[g],e(l);return[4,I.all(d)];case 1:return p.sent(),[2]}})})};b.prototype.match=function(a,b,d,c,e){a=this._fidToAttributeHash.get(b.attributes[a]);return this._attributeHashToGroup.get(a)};b.prototype._hashAttributes=function(a){var b="",d;for(d in this._fieldMap)b+=". "+a.attributes[this._fieldMap[d]];return b};return b}(g);l.DictionaryMatcher=g});