// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../core/mathUtils ../../../../core/maybe ../../../../core/string ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../glTF/DefaultLoadingContext ../../glTF/esriProvidedModelParameters ../../glTF/loader ../../glTF/internal/indexUtils ./wosrLoader ../../support/buffer/BufferView ../../support/buffer/math ../../support/buffer/utils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(ga,A,ha,Q,V,D,W,f,X,J,R,q,E,F,Y,N,Z,H,aa,t,v,w,ba,ca,B,K,S){function T(d){var l=d.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return l?{fileType:"gltf",url:l[1],specifiedLodIndex:null!=l[4]?Number(l[4]):null}:d.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:d,specifiedLodIndex:null}:{fileType:"unknown",url:d,specifiedLodIndex:null}}function O(d,l,c){var x=d.model,p=R.mat4f64.create(),h=[],C=new Map,m=new Map;x.lods.forEach(function(d,q){if(void 0===c||q===c){var E=0,r={name:d.name,
stageResources:{textures:[],materials:[],geometries:[]},lodThreshold:f.isSome(d.lodThreshold)?d.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:F.empty()};h.push(r);d.parts.forEach(function(b){var c=b.material+(b.attributes.normal?"_normal":"")+(b.attributes.color?"_color":"")+(b.attributes.texCoord0?"_texCoord0":"")+(b.attributes.tangent?"_tangent":""),a=x.materials.get(b.material),h=f.isSome(b.attributes.texCoord0),n=f.isSome(b.attributes.normal);if(!C.has(c)){if(h){if(f.isSome(a.textureColor)&&
!m.has(a.textureColor)){var e=x.textures.get(a.textureColor),g=D({},e.parameters,{preMultiplyAlpha:!0});m.set(a.textureColor,new B(e.data,a.textureColor,g))}f.isSome(a.textureNormal)&&!m.has(a.textureNormal)&&(e=x.textures.get(a.textureNormal),g=D({},e.parameters,{preMultiplyAlpha:!0}),m.set(a.textureNormal,new B(e.data,a.textureNormal,g)));f.isSome(a.textureOcclusion)&&!m.has(a.textureOcclusion)&&(e=x.textures.get(a.textureOcclusion),g=D({},e.parameters,{preMultiplyAlpha:!0}),m.set(a.textureOcclusion,
new B(e.data,a.textureOcclusion,g)));f.isSome(a.textureEmissive)&&!m.has(a.textureEmissive)&&(e=x.textures.get(a.textureEmissive),g=D({},e.parameters,{preMultiplyAlpha:!0}),m.set(a.textureEmissive,new B(e.data,a.textureEmissive,g)));f.isSome(a.textureMetallicRoughness)&&!m.has(a.textureMetallicRoughness)&&(e=x.textures.get(a.textureMetallicRoughness),g=D({},e.parameters,{preMultiplyAlpha:!0}),m.set(a.textureMetallicRoughness,new B(e.data,a.textureMetallicRoughness,g)))}var y=K.COLOR_GAMMA,e=Math.pow(a.color[0],
1/y),g=Math.pow(a.color[1],1/y),u=Math.pow(a.color[2],1/y),k=Math.pow(a.emissiveFactor[0],1/y),q=Math.pow(a.emissiveFactor[1],1/y),y=Math.pow(a.emissiveFactor[2],1/y);C.set(c,new K(D({transparent:"BLEND"===a.alphaMode,textureAlphaMode:da(a.alphaMode),textureAlphaCutoff:a.alphaCutoff,diffuse:[e,g,u],ambient:[e,g,u],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",cullFace:a.doubleSided?"none":"back",vertexColors:!!b.attributes.color,vertexTangents:!!b.attributes.tangent,
normals:n?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:f.isSome(a.textureColor)&&h?m.get(a.textureColor).id:void 0,colorMixMode:a.colorMixMode,normalTextureId:f.isSome(a.textureNormal)&&h?m.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:f.isSome(a.textureOcclusion)&&h?m.get(a.textureOcclusion).id:void 0,emissiveTextureId:f.isSome(a.textureEmissive)&&h?m.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:f.isSome(a.textureMetallicRoughness)&&
h?m.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[k,q,y],metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,usePBR:!0},l),c))}a:{n=b.indices||b.attributes.position.count;switch(b.primitiveType){case 4:e=H.trianglesToTriangles(n);break a;case 5:e=H.triangleStripToTriangles(n);break a;case 6:e=H.triangleFanToTriangles(n);break a}e=void 0}g={};u={};n=b.attributes.position.count;k=w.createBuffer(t.BufferViewVec3f,n);v.vec3.transformMat4(k,b.attributes.position,b.transform);
u.position={data:k.typedBuffer,size:k.elementCount};g.position=e;f.isSome(b.attributes.normal)&&(k=w.createBuffer(t.BufferViewVec3f,n),J.mat4.invert(p,b.transform),J.mat4.transpose(p,p),v.vec3.transformMat4(k,b.attributes.normal,p),u.normal={data:k.typedBuffer,size:k.elementCount},g.normal=e);f.isSome(b.attributes.tangent)&&(k=w.createBuffer(t.BufferViewVec4f,n),J.mat4.invert(p,b.transform),J.mat4.transpose(p,p),v.vec4.transformMat4(k,b.attributes.tangent,p),u.aTangent={data:k.typedBuffer,size:k.elementCount},
g.aTangent=e);f.isSome(b.attributes.texCoord0)&&(k=w.createBuffer(t.BufferViewVec2f,n),w.vec2.normalizeIntegerBuffer(k,b.attributes.texCoord0),u.uv0={data:k.typedBuffer,size:k.elementCount},g.uv0=e);f.isSome(b.attributes.color)&&(k=w.createBuffer(t.BufferViewVec4u8,n),4===b.attributes.color.elementCount?b.attributes.color instanceof t.BufferViewVec4f?v.vec4.scale(k,b.attributes.color,255):b.attributes.color instanceof t.BufferViewVec4u8?w.vec4.copy(k,b.attributes.color):b.attributes.color instanceof
t.BufferViewVec4u16&&v.vec4.scale(k,b.attributes.color,1/256):(w.vec4.fill(k,255,255,255,255),q=new t.BufferViewVec3u8(k.buffer,0,4),b.attributes.color instanceof t.BufferViewVec3f?v.vec3.scale(q,b.attributes.color,255):b.attributes.color instanceof t.BufferViewVec3u8?w.vec3.copy(q,b.attributes.color):b.attributes.color instanceof t.BufferViewVec3u16&&v.vec3.scale(q,b.attributes.color,1/256)),u.color={data:k.typedBuffer,size:k.elementCount},g.color=e);b=new ba(new ca.GeometryData(u,g),"gltf_"+d.name+
"_"+E++);r.stageResources.geometries.push(b);r.stageResources.materials.push(C.get(c));h&&(f.isSome(a.textureColor)&&r.stageResources.textures.push(m.get(a.textureColor)),f.isSome(a.textureNormal)&&r.stageResources.textures.push(m.get(a.textureNormal)),f.isSome(a.textureOcclusion)&&r.stageResources.textures.push(m.get(a.textureOcclusion)),f.isSome(a.textureEmissive)&&r.stageResources.textures.push(m.get(a.textureEmissive)),f.isSome(a.textureMetallicRoughness)&&r.stageResources.textures.push(m.get(a.textureMetallicRoughness)));
r.numberOfVertices+=n;c=b.boundingInfo;F.expand(r.boundingBox,c.getBBMin());F.expand(r.boundingBox,c.getBBMax())})}});return h}function da(d){switch(d){case "BLEND":return"blend";case "MASK":return"mask";case "OPAQUE":return"opaque";default:return"blend"}}function ea(d){var l=d.model.lods.length;d.meta.isEsriSymbolResource&&d.model.lods.forEach(function(c){if(!f.isSome(c.lodThreshold)){var d=(c.name||"").replace("Imposter","Realistic_LOD0").split("_LOD")[0],p=c.parts.reduce(function(c,d){return c+
d.attributes.position.count},0);c.lodThreshold=fa(d,p,l)}})}function fa(d,l,c){void 0===d&&(d="");if(1===c)return null;if(d in N.lodThresholdLUT){c=N.lodThresholdLUT[d].vertexCounts;d=N.lodThresholdLUT[d].thresholds;var f=c.length;if(1>=f)return null;if(l<=c[0]){var p=(c[1]-c[0])/(d[1]-d[0]);l-=c[0];return Math.max(0,d[0]+l*p)}if(l>=c[f-1])return p=(c[f-1]-c[f-2])/(d[f-1]-d[f-2]),l-=c[f-1],d[f-1]+l*p;for(var h=1;h<c.length;++h){var q=c[h-1],m=c[h],f=d[h-1],p=d[h];if(l<m)return l=(l-q)/(m-q),f*(1-
l)+p*l}}return null}Object.defineProperty(A,"__esModule",{value:!0});A.fetch=function(d,l){void 0===l&&(l={});return V(this,void 0,void 0,function(){var c,x,p,h,C,m,v,B,A,r;return Q(this,function(b){switch(b.label){case 0:return c=T(d),"wosr"!==c.fileType?[3,2]:[4,aa.load(c.url,l)];case 1:return x=b.sent(),[2,{lods:[x],referenceBoundingBox:x.boundingBox,isEsriSymbolResource:!1,isWosr:!0}];case 2:return p=new Y.DefaultLoadingContext(l.streamDataRequester),[4,Z.load(p,c.url,l)];case 3:h=b.sent();a:if(b=
h,b.meta.isEsriSymbolResource)for(var F=0,a=b.model.lods;F<a.length;F++){var L=a[F],n;b:{var e=L.name,g=b.meta.uri;void 0===e&&(e="");void 0===g&&(g="");n=X.endsWith(e,"Imposter");e=e.split("__")[0];if(-1!==g.indexOf("/RealisticTrees/")&&(g=N.treeParamsTable[e])){n={crownCenter:g.center,crownDimensions:g.radius,imposter:n};break b}n=void 0}if(!n)break a;b.customMeta.esriTreeRendering=!0;g=0;for(L=L.parts;g<L.length;g++){var e=L[g],y=e.attributes.normal;if(f.isNone(y))break a;for(var u=e.attributes.position,
k=u.count,H=E.vec3f64.create(),K=E.vec3f64.create(),G=E.vec3f64.create(),M=w.createBuffer(t.BufferViewVec4u8,k),U=w.createBuffer(t.BufferViewVec3f,k),P=J.mat4.invert(R.mat4f64.create(),e.transform),Q=q.vec3.transformMat4(E.vec3f64.create(),n.crownCenter,P),P=q.vec3.transformMat4(E.vec3f64.create(),n.crownDimensions,P),z=0;z<k;z++){u.getVec(z,K);y.getVec(z,H);q.vec3.subtract(G,K,Q);q.vec3.divide(G,G,P);var I=W.clamp(q.vec3.length(G),0,1),I=.6+.4*I*I;q.vec3.lerp(G,G,H,.2);U.setVec(z,G);M.set(z,0,255*
I);M.set(z,1,255*I);M.set(z,2,255*I);M.set(z,3,255)}e.attributes.normal=U;e.attributes.color=M}}ea(h);C=D({},l.materialParamsMixin,{treeRendering:h.customMeta.esriTreeRendering},h.meta.isEsriSymbolResource?l.usePBR?!0===h.customMeta.esriTreeRendering?S.defaultPBRTreeMaterialParameters:S.defaultPBRMaterialParameters:{usePBR:!1}:{usePBR:!0});if(null!=c.specifiedLodIndex)return m=O(h,C,c.specifiedLodIndex),v=m[0].boundingBox,0!==c.specifiedLodIndex&&(B=O(h,C,c.specifiedLodIndex),v=B[0].boundingBox),
[2,{lods:m,referenceBoundingBox:v,isEsriSymbolResource:h.meta.isEsriSymbolResource,isWosr:!1}];A=O(h,C);r=A[0].boundingBox;return[2,{lods:A,referenceBoundingBox:r,isEsriSymbolResource:h.meta.isEsriSymbolResource,isWosr:!1}]}})})};A.parseUrl=T;A.gltfToEngineResources=O});