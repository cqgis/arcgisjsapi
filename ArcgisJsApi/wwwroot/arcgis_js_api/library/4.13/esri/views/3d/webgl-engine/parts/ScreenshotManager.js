// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../lib/AutoDisposable ../../../support/screenshotUtils ../../../webgl/FramebufferObject".split(" "),function(m,p,q,t,u,v,w,r,x,n,y){Object.defineProperty(p,"__esModule",{value:!0});m=function(m){function f(a,d,b,c,e){void 0===c&&(c=null);void 0===e&&
(e=!0);var g=m.call(this)||this;g._rctx=a;g._renderScene=d;g._requestRenderScene=b;g._renderOverlay=c;g.supersample=e;g._screenshotQueue=[];return g}t(f,m);f.prototype.dispose=function(){this._rctx=null};f.prototype.takeScreenshot=function(a){var d=this;this._requestRenderScene();var b=w.createResolver(function(){d._screenshotQueue=d._screenshotQueue.filter(function(a){return a.resolver!==b})});this._screenshotQueue.push({settings:a,resolver:b});return b.promise};f.prototype.update=function(a){if(0!==
this._screenshotQueue.length){for(var d=0,b=this._screenshotQueue;d<b.length;d++){var c=b[d];if(this.isDisposed)c.resolver.reject();else{var e=q({},c.settings,{pixelRatio:c.settings.pixelRatio*a.viewCamera.pixelRatio}),g=this._ensureScreenshotEncodeCanvas(),f=this._renderScreenshot(a,e),e=n.encodeResult(f,e,g,{flipY:!0,premultipliedAlpha:!0});c.resolver(e)}}this._screenshotQueue=[]}};f.prototype._renderScreenshotOverlay=function(a,d,b){if(!v.isNone(this._renderOverlay)){a.width=d.width;a.height=d.height;
var c=a.getContext("2d"),e=b.pixelRatio;c.save();c.translate(0,d.height);c.scale(1,-1);b.region&&c.translate(-b.region.x,-b.region.y);c.scale(e,e);this._renderOverlay(a,d);c.restore()}};f.prototype._readbackScreenshot=function(a){return a.resample?this._readbackScreenshotResampled(a):this._readbackScreenshotImmediate(a)};f.prototype._readbackScreenshotResampled=function(a){var d=a.framebufferWidth,b=a.framebufferHeight,c=a.region,e=a.resample,g=this._ensureScreenshotEncodeCanvas(),f=n.createEmptyImageData(d,
b,g);this._rctx.gl.readPixels(0,0,d,b,6408,5121,new Uint8Array(f.data.buffer));this._renderScreenshotOverlay(g,f,q({},a,{region:null}));a=n.createEmptyImageData(c.width,c.height,g);return n.resampleHermite(f,a,!0,e.region.x,b-(e.region.y+e.region.height),e.region.width,e.region.height)};f.prototype._readbackScreenshotImmediate=function(a){var d=a.framebufferHeight,b=a.region,c=this._ensureScreenshotEncodeCanvas(),e=n.createEmptyImageData(b.width,b.height,c);this._rctx.gl.readPixels(b.x,d-(b.y+b.height),
b.width,b.height,6408,5121,new Uint8Array(e.data.buffer));this._renderScreenshotOverlay(c,e,a);return e};f.prototype._renderScreenshot=function(a,d){var b=null,c=a.viewCamera,e=d.framebufferWidth,f=d.framebufferHeight,l=!1,k=a.frameHasSlicePlane&&d.disableSlice;if(k=e!==c.fullWidth||f!==c.fullHeight||k){var h=c.clone();h.fullWidth=e;h.fullHeight=f;h.pixelRatio=d.pixelRatio;b=c.fovX-h.fovX;l=c.fovY-h.fovY;0>b&&b<l?h.fovX=c.fovX:0>l&&l<b&&(h.fovY=c.fovY);a.drapedRenderer.forceUpdate&&a.drapedRenderer.forceUpdate(h);
l=!0;b=new y(this._rctx,{width:h.fullWidth,height:h.fullHeight,colorTarget:0,depthStencilTarget:3});this._renderScene(b,h,d.disableSlice)}d=this._readbackScreenshot(d);if(k&&!this._rctx.contextAttributes.alpha)for(k=3;k<d.data.length;k+=4)d.data[k]=255;b&&b.dispose();this._rctx.bindFramebuffer(null);l&&a.drapedRenderer.forceUpdate&&a.drapedRenderer.forceUpdate(c);return d};f.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));
return this._screenshotEncodeCanvas};return f=u([r.subclass("esri.views.3d.webgl-engine.parts.ScreenshotManager")],f)}(r.declared(x.AutoDisposable));p.ScreenshotManager=m});