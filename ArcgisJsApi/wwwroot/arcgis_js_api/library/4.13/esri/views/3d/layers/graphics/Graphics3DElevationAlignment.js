// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/iteratorUtils ../../../../core/PooledArray ../../../../core/accessorSupport/decorators ../../../../geometry/support/aaBoundingRect ../../../support/index".split(" "),function(A,B,q,p,r,t,u,v,w,m,d,x){var z=function(){function c(){this.extents=new w({allocator:function(b){return b||d.create()}});
this.tempExtent=d.create();this.dirty=!1}Object.defineProperty(c.prototype,"length",{get:function(){return this.extents.length},enumerable:!0,configurable:!0});c.prototype.clear=function(){this.extents.clear()};c.prototype.add=function(b){this.contains(b)||(this.removeContained(b),d.set(this.extents.pushNew(),b),this.dirty=!0)};c.prototype.pop=function(){this.dirty&&(this.mergeTight(),this.dirty=!1);return this.extents.pop()};c.prototype.mergeTight=function(){for(var b=this.extents,a=this.tempExtent,
e=!1;!e;)for(var e=!0,n=0;n<b.length;++n){for(var c=n,f=b.data[c],k=d.area(f),g=!1,l=b.length-1;l>c;--l){var h=b.data[l],y=d.area(h);d.expand(f,h,a);h=k+y;.05>(d.area(a)-h)/h&&(d.set(f,a),k=d.area(f),b.swapElements(l,b.length-1),b.pop(),g=!0)}if(g){e=!1;break}}};c.prototype.containsPoint=function(b){return this.extents.some(function(a){return d.containsPoint(a,b)})};c.prototype.contains=function(b){return this.extents.some(function(a){return d.contains(a,b)})};c.prototype.removeContained=function(b){for(var a=
this.extents.length-1;0<=a;--a)d.contains(b,this.extents.data[a])&&this.extents.removeUnorderedIndex(a)};return c}();return function(c){function b(){var a=null!==c&&c.apply(this,arguments)||this;a.dirtyExtents=new z;a.globalDirty=!1;a.dirtyGraphicsSet=new Set;a.handles=new u;a.updateElevation=!1;a.layerView=null;a.graphicsCore=null;a.events=new t;return a}q(b,c);Object.defineProperty(b.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0});b.prototype.setup=
function(a,b,c,d){var e=this;this.layerView=a;this.queryGraphicUIDsInExtent=b;this.graphicsCore=c;this.elevationProvider=d;a=this.layerView.view.resourceController.scheduler;this.handles.add([d.on("elevation-change",function(a){("scene"!==a.context||c.layer.elevationInfo&&"relative-to-scene"===c.layer.elevationInfo.mode)&&e.elevationUpdateHandler(a)}),this.layerView.watch("suspended",function(){return e.suspendedChange()}),a.registerTask(x.Task.ELEVATION_ALIGNMENT,function(a){return e.update(a)},
function(){return e.needsUpdate()})])};b.prototype.destroy=function(){this.dirtyGraphicsSet=null;this.handles.destroy();this.queryGraphicUIDsInExtent=this.graphicsCore=this.layerView=this.handles=null};b.prototype.clear=function(){this.dirtyGraphicsSet.clear();this.notifyChange("updating")};b.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))};b.prototype.elevationInfoChange=
function(){this.globalDirty=!0;this.notifyChange("updating")};b.prototype.needsUpdate=function(){return this.dirtyGraphicsSet&&0<this.dirtyGraphicsSet.size||this.dirtyExtents&&0<this.dirtyExtents.length||this.globalDirty};b.prototype.update=function(a){this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,a.madeProgress());for(;this.needsUpdate()&&!a.done;)this._updateDirtyGraphics(a),this._updateDirtyExtents(a);this.layerView.view.deconflictor.setDirty();this.notifyChange("updating")};
b.prototype._updateDirtyGraphics=function(a){for(var b=this,c=this.layerView.view,d=this.graphicsCore.stageLayer.id,f=this.layerView.labeling,k=function(){var e=Math.min(g.dirtyGraphicsSet.size,100);v.everySet(g.dirtyGraphicsSet,function(d){var f=b.graphicsCore.getGraphics3DGraphicById(d);b.dirtyGraphicsSet.delete(d);f&&f.alignWithElevation(b.elevationProvider,c.renderCoordsHelper,b.graphicsCore.asyncUpdates);a.madeProgress();return 0<--e&&!a.done});c._stage.processDirtyLayer(d);f&&f.processStageDirty()},
g=this;0<this.dirtyGraphicsSet.size&&!a.done;)k()};b.prototype._updateDirtyExtents=function(a){for(var b=this;0<this.dirtyExtents.length&&100>this.dirtyGraphicsSet.size&&!a.done;){var c=this.dirtyExtents.pop();this.events.hasEventListener("invalidate-elevation")&&this.events.emit("invalidate-elevation",{extent:c,spatialReference:this.spatialReference});this.queryGraphicUIDsInExtent(c,this.spatialReference,function(a){var c=b.graphicsCore.getGraphics3DGraphicById(a);c&&c.needsElevationUpdates()&&b.dirtyGraphicsSet.add(a)});
a.madeProgress()}};b.prototype.markAllGraphicsElevationDirty=function(){var a=this;this.dirtyExtents.clear();this.dirtyGraphicsSet.clear();this.graphicsCore.graphics3DGraphics.forEach(function(b,c){a.dirtyGraphicsSet.add(c)})};b.prototype.elevationUpdateHandler=function(a){var b=a.extent;this.layerView.suspended?this.updateElevation||(a=this.graphicsCore.computedExtent)&&b[2]>a.xmin&&b[0]<a.xmax&&b[3]>a.ymin&&b[1]<a.ymax&&(this.updateElevation=!0):(-Infinity===b[0]?this.globalDirty=!0:this.dirtyExtents.add(b),
this.spatialReference=a.spatialReference,this.notifyChange("updating"))};p([m.property({readOnly:!0})],b.prototype,"updating",null);return b=p([m.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],b)}(m.declared(r))});