// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/maybe ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ./featureExpressionInfoUtils ./Graphics3DGraphicElevationContext ./graphicUtils".split(" "),function(l,G,H,A,B,h,y,m,e,C,D,E){function z(c){return c.isVisible?c.getParameters().transparent?1:2:0}l=function(){function c(a,
b,u,x,n,d,e,g,f){this._edgeState=g;this.type="object3d";this._addedToStage=!1;this.alignedTerrainElevation=0;this.needsElevationUpdates=!1;this.graphics3DSymbolLayer=a;this.uniqueMaterials=x;this.uniqueGeometries=u;this.uniqueTextures=n;this.stageObject=b;this.elevationAligner=d;this.elevationContext=new D(e);this.stageLayer=this.stage=null;this._visible=!1;this.visibilityMode=null!=f?f:c.VisibilityModes.HIDE_FACERANGE}Object.defineProperty(c.prototype,"isElevationSource",{get:function(){return!(!this.stageObject.metadata||
!this.stageObject.metadata.isElevationSource)},enumerable:!0,configurable:!0});c.prototype.initialize=function(a,b){this.stageLayer=a;this.stage=b;if(this.uniqueMaterials)for(a=0;a<this.uniqueMaterials.length;a++)b.add(3,this.uniqueMaterials[a]);if(this.uniqueGeometries)for(a=0;a<this.uniqueGeometries.length;a++)b.add(2,this.uniqueGeometries[a]);if(this.uniqueTextures)for(a=0;a<this.uniqueTextures.length;a++)b.add(4,this.uniqueTextures[a]);b.add(1,this.stageObject)};c.prototype.layerOpacityChanged=
function(a,b){if(!h.isNone(this._edgeState)){for(var c=z(this._edgeState.baseMaterial),e=!1,n=0,d=this._edgeState.edgeMaterials;n<d.length;n++){var g=d[n];g.objectTransparency!==c&&(g.objectTransparency=c,e=!0)}e&&this.resetEdgeObject(b);this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[a])}};c.prototype.slicePlaneEnabledChanged=function(a,b){h.isNone(this._edgeState)||(this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,
{slicePlaneEnabled:a},!b),this._edgeState.slicePlaneEnabled=a)};c.prototype.setVisibility=function(a){if(null!=this.stage){if(this._visible!==a){(this._visible=a)?this._addedToStage?this.stageObject.unhideAllComponents():(this.stageLayer.addObject(this.stageObject),this._addedToStage=!0):this.visibilityMode===c.VisibilityModes.HIDE_FACERANGE?this.stageObject.hideAllComponents():(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1);if(h.isSome(this._edgeState)){var b=this.stage.renderView.ensureEdgeView();
b.hasObject(this.stageObject)?b.updateObjectVisibility(this.stageObject,a):a&&this.addEdgeObject(b,this._edgeState,!1)}return!0}return!1}};Object.defineProperty(c.prototype,"visible",{get:function(){return this._visible},enumerable:!0,configurable:!0});c.prototype.destroy=function(){var a=this.stage;if(this.stageLayer){if(this.uniqueMaterials)for(var b=0;b<this.uniqueMaterials.length;b++)a.remove(3,this.uniqueMaterials[b].id);if(this.uniqueGeometries)for(b=0;b<this.uniqueGeometries.length;b++)a.remove(2,
this.uniqueGeometries[b].id);if(this.uniqueTextures)for(b=0;b<this.uniqueTextures.length;b++)a.remove(4,this.uniqueTextures[b].id)}a.remove(1,this.stageObject.id);this._addedToStage&&(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1);a=this.stage.renderView.ensureEdgeView();a.hasObject(this.stageObject)&&a.removeObject(this.stageObject);this.stageObject.dispose();this._visible=!1;this.stage=this.stageLayer=null};c.prototype.alignWithElevation=function(a,b,c,e){null!=this.elevationAligner&&
(C.setContextFeature(this.elevationContext.featureExpressionInfoContext,c),a=this.elevationAligner(this,this.elevationContext,a,b),null!=a&&(this.alignedTerrainElevation=a),this.resetEdgeObject(e))};c.prototype.getBSRadius=function(){return this.stageObject.getBSRadius()};c.prototype.getCenterObjectSpace=function(a){void 0===a&&(a=m.vec3f64.create());return y.vec3.copy(a,this.stageObject.getCenter(!0))};c.prototype.getBoundingBoxObjectSpace=function(a){void 0===a&&(a=e.create());var b=this.stageObject;
a||(a=e.create());e.setMin(a,b.getBBMin(!0));e.setMax(a,b.getBBMax(!0));return a};c.prototype.getProjectedBoundingBox=function(a,b,c,x,n){return B(this,void 0,void 0,function(){var d,l,h,f,v,w,k,m,q,u;return A(this,function(r){switch(r.label){case 0:d=this.getBoundingBoxObjectSpace(n);l=F;h=e.isPoint(d)?1:l.length;for(f=0;f<h;f++)v=l[f],g[0]=d[v[0]],g[1]=d[v[1]],g[2]=d[v[2]],y.vec3.transformMat4(g,g,this.stageObject.objectTransformation),p[3*f+0]=g[0],p[3*f+1]=g[1],p[3*f+2]=g[2];if(!a(p,0,h))return[2,
null];e.empty(d);w=null;this.calculateRelativeScreenBounds&&(w=this.calculateRelativeScreenBounds());for(f=0;f<3*h;f+=3){for(k=0;3>k;k++)d[k]=Math.min(d[k],p[f+k]),d[k+3]=Math.max(d[k+3],p[f+k]);w&&c.push({location:p.slice(f,f+3),screenSpaceBoundingRect:w})}if(!b||!b.service||"absolute-height"===this.elevationContext.mode)return[3,5];e.center(d,t);m="relative-to-scene"===this.elevationContext.mode?"scene":"ground";q=void 0;if(!b.useViewElevation)return[3,1];q=b.service.getElevation(t[0],t[1],m);return[3,
4];case 1:return r.trys.push([1,3,,4]),u=E.demResolutionForBoundingBox(d,b),[4,b.service.queryElevation(t[0],t[1],x,u,m)];case 2:return q=r.sent(),[3,4];case 3:return r.sent(),q=null,[3,4];case 4:e.offset(d,0,0,-this.alignedTerrainElevation+q),r.label=5;case 5:return[2,d]}})})};c.prototype.addHighlight=function(a,b){b=this.stageObject.highlightAllComponents(b);a.addObject(this.stageObject,b)};c.prototype.removeHighlight=function(a){a.removeObject(this.stageObject)};c.prototype.resetEdgeObject=function(a){if(!h.isNone(this._edgeState)){var b=
this.stage.renderView.ensureEdgeView();b.removeObject(this.stageObject);this._visible&&this.addEdgeObject(b,this._edgeState,a)}};c.prototype.addEdgeObject=function(a,b,c){for(var e=z(b.baseMaterial),g=0,d=b.edgeMaterials;g<d.length;g++)d[g].objectTransparency=e;a.addObject(this.stageObject,b.edgeMaterials,{slicePlaneEnabled:b.slicePlaneEnabled},!c,b.addObjectSettings)};return c}();(function(c){c=c.VisibilityModes||(c.VisibilityModes={});c[c.REMOVE_OBJECT=0]="REMOVE_OBJECT";c[c.HIDE_FACERANGE=1]="HIDE_FACERANGE"})(l||
(l={}));var p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],g=m.vec3f64.create(),t=m.vec3f64.create(),F=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];return l});