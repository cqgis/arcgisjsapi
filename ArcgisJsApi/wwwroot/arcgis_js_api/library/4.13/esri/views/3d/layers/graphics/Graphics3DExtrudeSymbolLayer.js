// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../core/Error ../../../../core/maybe ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../layers/graphics/dehydratedFeatures ../../../../renderers/support/renderingInfoUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/edgeUtils ../../support/projectionUtils ../../support/buffer/BufferView ../../support/buffer/math/vec3 ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(N,O,fa,ga,ha,ia,ja,J,ka,la,ma,R,L,y,m,na,oa,pa,H,qa,S,ra,T,U,V,sa,ta,ua,C,va,W){function wa(h,d,a,b,n,c,e,g,t,q,A,l,k,m){var z=a.length/3,r=0;A+=2*b.count;var f=b.index,x=b.count,p=t,w=A;y.vec3.copy(u,k);var v=0<l?1:-1,f=3*f,P=p;k=3*P;for(var B=p+x,p=3*B,D=0;D<x;++D)m&&(u[0]=h[f+0],u[1]=h[f+1],u[2]=h[f+2],y.vec3.normalize(u,u)),n[k+0]=h[f+0],n[k+1]=h[f+1],n[k+2]=h[f+2],c[k+0]=d[f+0],c[k+1]=d[f+1],c[k+2]=d[f+2],e[k+0]=-v*u[0],e[k+1]=-v*u[1],e[k+2]=-v*u[2],g[P]=0,n[p+0]=h[f+0]+l*u[0],n[p+1]=
h[f+1]+l*u[1],n[p+2]=h[f+2]+l*u[2],c[p+0]=d[f+0],c[p+1]=d[f+1],c[p+2]=d[f+2],e[p+0]=v*u[0],e[p+1]=v*u[1],e[p+2]=v*u[2],g[B]=l,k+=3,p+=3,f+=3,P+=1,B+=1;f=0;k=3*w;p=3*(w+z);k=3*(w+z);p=3*w;h=X;d=Y;0>l&&(h=Y,d=X);for(D=0;D<z;++D)q[k+0]=a[f+h[0]],q[k+1]=a[f+h[1]],q[k+2]=a[f+h[2]],q[p+0]=a[f+d[0]]+x,q[p+1]=a[f+d[1]]+x,q[p+2]=a[f+d[2]]+x,k+=3,p+=3,f+=3;t+=2*b.count;A=A+2*z-(2*b.count+2*z);Z(n,c,g,e,r,b.pathLengths[0],b.count,t,q,A,l);t+=4*b.pathLengths[0];A+=2*b.pathLengths[0];r+=b.pathLengths[0];for(a=
1;a<b.pathLengths.length;++a)Z(n,c,g,e,r,b.pathLengths[a],b.count,t,q,A,l),t+=4*b.pathLengths[a],A+=2*b.pathLengths[a],r+=b.pathLengths[a]}function M(h,d,a,b,n,c,e){b[c]=b[e];e*=3;c*=3;h[c+0]=h[e+0];h[c+1]=h[e+1];h[c+2]=h[e+2];d[c+0]=d[e+0];d[c+1]=d[e+1];d[c+2]=d[e+2];a[c+0]=n[0];a[c+1]=n[1];a[c+2]=n[2]}function Z(h,d,a,b,n,c,e,g,t,q,A){var l=n,k=n+1,u=n+e,z=n+e+1,r=g,f=g+1,x=g+2*c;g=g+2*c+1;0>A&&(l=n+e+1,z=n);q*=3;for(var p=0;p<c;++p){p===c-1&&(0<A?(k=n,z=n+e):(k=n,l=n+e));var w=h,v=l,m=k,B=u,D=
F,v=3*v,m=3*m,B=3*B;y.vec3.set(Q,w[v++],w[v++],w[v++]);y.vec3.set(aa,w[m++],w[m++],w[m++]);y.vec3.set(ba,w[B++],w[B++],w[B++]);y.vec3.subtract(ca,aa,Q);y.vec3.subtract(da,ba,Q);y.vec3.cross(D,da,ca);y.vec3.normalize(D,D);M(h,d,b,a,F,r,l);M(h,d,b,a,F,f,k);M(h,d,b,a,F,x,u);M(h,d,b,a,F,g,z);t[q++]=r;t[q++]=x;t[q++]=g;t[q++]=r;t[q++]=g;t[q++]=f;l++;k++;u++;z++;r+=2;f+=2;x+=2;g+=2}}function xa(h,d,a,b){h=h.stageObject;K.spatialReference=a.spatialReference;for(var n=h.geometryRecords,c=n.length,e="absolute-height"!==
d.mode,g=0,t=h.objectTransformation,q=R.mat4.invert(L.mat4f64.create(),t),m=0;m<c;m++){var l=n[m].geometry;l.invalidateBoundingInfo();for(var k=l.data.getVertexAttr(),l=k[C.VertexAttrConstants.POSITION].data,u=k[C.VertexAttrConstants.SIZE].data,k=k.mapPos.data,z=l.length/3,r=0,f=0,x=!1,p=0,w=0;w<z;w++){K.x=k[f];K.y=k[f+1];K.z=k[f+2];G[0]=l[r];G[1]=l[r+1];G[2]=l[r+2];var v=H.computeElevation(a,K,d,b,e?ea:null);e&&(p+=ea.terrainElevation);y.vec3.set(E,l[r+0],l[r+1],l[r+2]);y.vec3.transformMat4(E,E,
t);b.setAltitude(v+u[r/3],E);y.vec3.transformMat4(E,E,q);l[r]=E[0];l[r+1]=E[1];l[r+2]=E[2];v=.01/b.unitInMeters;if(Math.abs(G[0]-l[r])>v||Math.abs(G[1]-l[r+1])>v||Math.abs(G[2]-l[r+2])>v)x=!0;f+=3;r+=3}x&&h.geometryVertexAttrsUpdated(m);g+=p/z}return g/c}Object.defineProperty(O,"__esModule",{value:!0});var E=m.vec3f64.create(),u=m.vec3f64.create(),X=[0,2,1],Y=[0,1,2],K=na.makeDehydratedPoint(0,0,0,null),ea={verticalDistanceToGround:0,terrainElevation:0};N=function(h){function d(a,b,d,c){return h.call(this,
a,b,d,c)||this}fa(d,h);d.prototype.doLoad=function(){return ha(this,void 0,void 0,function(){var a,b,d,c,e,g;return ga(this,function(h){if(!this._isPropertyDriven("size")&&(a=S.validateSymbolLayerSize(this._getSymbolSize())))throw new ja("graphics3dextrudesymbollayer:invalid-size",a);b=J.get(this.symbolLayer,"material","color");d=this._getCombinedOpacityAndColor(b);c=m.vec3f64.fromArray(d);e=d[3];g={diffuse:c,ambient:c,opacity:e,transparent:1>e||this._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,
castShadows:this.symbolLayer.castShadows};this._material=new va(ia({},g,W.returnDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled),{offsetTransparentBackfaces:!0}),this._getIdHint("_3dlinemat"));this._context.stage.add(3,this._material);return[2]})})};d.prototype.destroy=function(){h.prototype.destroy.call(this);this._material&&this._context.stage.remove(3,this._material.id)};d.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if(!this._validateGeometryType(b.geometry,
d.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var h="graphic"+b.uid,c=this._getVertexOpacityAndColor(a.renderingInfo,Float32Array,255),e=this.getGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,c,e,h,b.uid)};d.prototype.layerOpacityChanged=function(a,b){var d=this,c=J.get(this.symbolLayer,"material","color"),c=this._getCombinedOpacity(c),h=1>c||this._isPropertyDriven("opacity");this._material.setParameterValues({opacity:c,transparent:h});
var g=this._getLayerOpacity();a.forEach(function(a){a=b(a);J.isSome(a)&&a.layerOpacityChanged(g,d._context.isAsync)});return!0};d.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,H.needsElevationUpdates3D)};d.prototype.slicePlaneEnabledChanged=function(a,b){var d=this;this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});a.forEach(function(a){a=b(a);J.isSome(a)&&a.slicePlaneEnabledChanged(d._context.slicePlaneEnabled,
d._context.isAsync)});return!0};d.prototype.physicalBasedRenderingChanged=function(a,b){this._material.setParameterValues(W.returnDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled));return!0};d.prototype.pixelRatioChanged=function(a,b){return!0};d.prototype._getExtrusionSize=function(a){a=a.size&&this._isPropertyDriven("size")?oa.getDriverAxisSizeValue(a.size,2):this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};d.prototype._getSymbolSize=function(){return this.symbolLayer.size||
1};d.prototype._createAs3DShape=function(a,b,d,c,h,g){var e=H.getGeometryAsPolygon(a.geometry);a=e.rings;var n=[],u=[],l=[],k=Array(6),y=this._context.renderSpatialReference===T.SphericalECEFSpatialReference,z=this._getExtrusionSize(b),r=m.vec3f64.create();y||this._context.renderCoordsHelper.worldUpAtPosition(null,r);b=H.getGeometryVertexData3D(a,e.hasZ,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c);this._logGeometryCreationWarnings(b,
a,"rings","ExtrudeSymbol3DLayer");if(0===a.length||!a.some(function(a){return 0<a.length}))return null;var f=S.computeCentroid(e);if(J.isNone(f))return null;a=L.mat4f64.create();T.computeLinearTransformation(e.spatialReference,[f.x,f.y,0],a,this._context.renderSpatialReference);var x=L.mat4f64.create();R.mat4.invert(x,a);var p=ma.mat3f64.create();la.mat3.normalFromMat4(p,x);for(var w=b.geometryData.polygons,v=b.eleVertexData,C=b.vertexData,e=C.length/3,B=new Float64Array(18*e),D=new Float64Array(18*
e),E=new Float64Array(18*e),G=new Float64Array(6*e),I=0,e=function(a){var b=w[a],c=b.count,e=b.index;if(F._context.clippingExtent&&(H.computeBoundingBox(v,e,c,k),H.boundingBoxClipped(k,F._context.clippingExtent)))return"continue";var f=new Float64Array(v.buffer,3*e*B.BYTES_PER_ELEMENT,3*c),g=b.holeIndices.map(function(a){return a-e}),f=ka(f,g,3);if(0===f.length)return"continue";var g=new Uint32Array(6*c+2*f.length),m=6*c,q=3*B.BYTES_PER_ELEMENT,q=new U.BufferViewVec3f64(B.buffer,I*q,q,(I+m)*q),t=
3*D.BYTES_PER_ELEMENT,t=new U.BufferViewVec3f64(D.buffer,I*t,t,(I+m)*t),A=new Float64Array(E.buffer,3*I*E.BYTES_PER_ELEMENT,3*m),m=new Float64Array(G.buffer,1*I*G.BYTES_PER_ELEMENT,1*m);wa(C,v,f,b,q.typedBuffer,A,t.typedBuffer,m,0,g,0,z,r,y);V.transformMat4(q,q,x);V.transformMat3(t,t,p);I+=6*c;b=F._createExtrudeGeometry(g,{positions:q.typedBuffer,elevation:A,normals:t.typedBuffer,heights:m},d);a=new sa(b,h+"path"+a);a.singleUse=!0;n.push(a);u.push(F._material);l.push(L.mat4f64.create())},F=this,f=
0;f<w.length;++f)e(f);if(0===n.length)return null;g=new ua({geometries:n,materials:u,transformations:l,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:g,isElevationSource:!0},idHint:h});g.objectTransformation=a;a=this._createEdgeMaterial();a=J.isSome(a)?{baseMaterial:this._material,edgeMaterials:[a],slicePlaneEnabled:this._context.slicePlaneEnabled}:null;g=new pa(this,g,n,null,null,xa,c,a);g.alignedTerrainElevation=b.terrainElevation;g.needsElevationUpdates=H.needsElevationUpdates3D(c.mode);
return g};d.prototype._createExtrudeGeometry=function(a,b,d){for(var c=a.length,e=new Uint32Array(c),g=0;g<c;g++)e[g]=0;c={};g={};c[C.VertexAttrConstants.POSITION]=a;c[C.VertexAttrConstants.NORMAL]=a;c[C.VertexAttrConstants.COLOR]=e;g[C.VertexAttrConstants.POSITION]={size:3,data:b.positions};g[C.VertexAttrConstants.NORMAL]={size:3,data:b.normals};g[C.VertexAttrConstants.COLOR]={size:4,data:d};g[C.VertexAttrConstants.SIZE]={size:1,data:b.heights};b.elevation&&(g.mapPos={size:3,data:b.elevation},c.mapPos=
a);return new ta.GeometryData(g,c)};d.prototype._createEdgeMaterial=function(){var a={opacity:this._getLayerOpacity()};return ra.createMaterial(this.symbolLayer,a)};d.validGeometryTypes=["polygon","extent"];return d}(qa.default);O.Graphics3DExtrudeSymbolLayer=N;var F=m.vec3f64.create(),Q=m.vec3f64.create(),aa=m.vec3f64.create(),ba=m.vec3f64.create(),ca=m.vec3f64.create(),da=m.vec3f64.create(),G=m.vec3f64.create();O.default=N});