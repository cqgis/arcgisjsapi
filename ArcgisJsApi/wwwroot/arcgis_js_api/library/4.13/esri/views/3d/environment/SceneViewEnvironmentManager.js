// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Color ../../../core/Evented ../../../core/Handles ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ./EnvironmentRenderer ../support/earthUtils ../support/projectionUtils ../support/sunUtils ../webgl-engine/lighting/Lightsources ../../../webscene/background/ColorBackground".split(" "),
function(e,l,y,h,z,A,B,C,D,r,t,m,f,g,k,u,E,v,n,p,q,F){Object.defineProperty(l,"__esModule",{value:!0});var w=k.vec3f64.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);e=function(e){function b(a){a=e.call(this)||this;a._referencePointUpdateDelay=200;a._referencePointUpdateInterval=3E3;a._referencePointUpdateDistThreshold=1E6;a._referencePosUpdateQuery=null;a._referencePosMapCoordsRequested=null;a._viewHandles=new D;a._preserveAbsoluteDateTime=!1;a._trackingEnabled=!1;a._viewConnected=
!1;a._referencePosResetPreserveAbsoluteTime=!1;a.referencePosUpdateTimer=null;a._referencePosWGS84Comparable=null;a._referencePosMapCoords=null;a._mainLight=new q.MainLight;a._ambientLight=new q.AmbientLight;a._moonLight=new q.FillLight;a._renderer=null;a._resetReferencePosition();return a}y(b,e);b.prototype.destroy=function(){this._viewHandles.destroy();this.disposeRendering()};Object.defineProperty(b.prototype,"updating",{get:function(){return this._viewConnected?!!(!this.disableQueries&&(this._referencePosUpdateQuery||
this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating):!1},enumerable:!0,configurable:!0});b.prototype.updateReadyChange=function(a){a&&!this._viewConnected?(this._viewConnected=!0,this.connectView(this.view),this.notifyChange("updating")):!a&&this._viewConnected&&(this._viewConnected=!1,this.disconnectView(this.view),this.notifyChange("updating"))};b.prototype.disposeRendering=function(){this._renderer&&(this._renderer.destroy(),this._renderer=null);this._resetReferencePosition()};
b.prototype.connectView=function(a){var d=this;this._renderer=new E({view:a});this._viewHandles.add([this.view.watch("environment.lighting.date",function(a){return d._lightingDateHandler(a)},!0),this.view.watch("interacting,stationary",this._interactingStationaryHandler.bind(this)),this.view.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.background.color"],function(){return d._updateRenderParamsHandler()},!0),this.view.watch("spatialReference",
function(){return d._resetReferencePosition()},!0),m.init(this.view,"viewingMode",function(){return d._resetReferencePosition()},!0),m.init(this.view,"environment.lighting.cameraTrackingEnabled",function(a){return d._updateCameraTracking(a)},!0),m.init(this,"view.state.camera",function(){return d._cameraHandler(null)},!0),this.watch("disableQueries",function(){return d._cameraHandler(null)})]);this._updateRenderParamsHandler();this._updateLightParams();this._cameraHandler()};b.prototype._updateCameraTracking=
function(a){if(this._trackingEnabled=a)this._cameraHandler();else if(a=this.get("view.environment.lighting"))a.positionTimezoneInfo.autoUpdated=!1};b.prototype.disconnectView=function(a){this.disposeRendering();this._viewHandles.removeAll()};b.prototype._lightingDateHandler=function(a){if(a){var d=this.view.environment.lighting;if(!d.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;if(!n.canProjectToWGS84ComparableLonLat(this.view.spatialReference)){var c=this.view.camera.position;
if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(c)){this._requestReferencePositionUpdate(c);return}}this._preupdateTracking(a);this._referencePosWGS84Comparable&&(c=v.positionToTimezone(this._referencePosWGS84Comparable,x),r.isSome(c)&&(d.autoUpdate(null,c),this._trackingEnabled&&(d.positionTimezoneInfo.autoUpdated=!0)))}this._updateLightParams(a)}};b.prototype._preupdateTracking=function(a){!this._trackingEnabled&&this.get("view.environment.lighting.cameraTrackingEnabled")&&
this._cameraHandler(a)};b.prototype._cameraHandler=function(a){void 0===a&&(a=null);if(this.view.ready){var d=this.view.camera;d&&(this._cameraHandlerClientSide(d,a)||this._cameraHandlerServerSide(d,a))}};b.prototype._cameraHandlerClientSide=function(a,d){if(!n.canProjectToWGS84ComparableLonLat(this.view.spatialReference))return!1;a=a.position;this._referencePosWGS84Comparable||(this._referencePosWGS84Comparable=k.vec3f64.create());n.pointToWGS84ComparableLonLat(a,this._referencePosWGS84Comparable);
this._autoUpdateTimezone(this._referencePosWGS84Comparable,d)||this._updateLightParams(d);return!0};b.prototype._cameraHandlerServerSide=function(a,d){a=a.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(a))&&this._requestReferencePositionUpdate(a,!0);this.view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=a.z*this.view.mapCoordsHelper.unitInMeters,this._referencePosChanged())};b.prototype._interactingStationaryHandler=
function(){!this.view.interacting&&this.view.stationary&&this._executePendingReferencePositionUpdate()};b.prototype._updateLightParams=function(a){var d=this.view.environment.lighting;a=a||d.date;var d=this.view._stage,c;this._referencePosWGS84Comparable?(c=p.computeColorAndIntensity(a,this._referencePosWGS84Comparable),p.computeDirection(a,this._referencePosWGS84Comparable,this.view.viewingMode,c.diffuse.direction)):c={diffuse:{color:[1,1,1],intensity:.55,direction:w},ambient:{color:[1,1,1],intensity:.55},
noonFactor:.5,globalFactor:0};g.vec3.scale(this._mainLight.intensity,c.diffuse.color,c.diffuse.intensity*Math.PI);g.vec3.negate(this._mainLight.direction,c.diffuse.direction);g.vec3.scale(this._ambientLight.intensity,c.ambient.color,c.ambient.intensity);g.vec3.lerp(this._moonLight.intensity,G,H,c.globalFactor);g.vec3.scale(this._moonLight.intensity,this._moonLight.intensity,(1-.5*c.globalFactor)*(1-.4*c.noonFactor*(1-c.globalFactor)));g.vec3.copy(this._moonLight.direction,c.diffuse.direction);d.setLighting({lights:[this._mainLight,
this._ambientLight,this._moonLight],globalFactor:c.globalFactor,groundLightingFactor:1-c.noonFactor});this._updateRenderParamsHandler()};b.prototype._autoUpdateTimezone=function(a,d){void 0===d&&(d=null);if(!this.view.get("environment.lighting.cameraTrackingEnabled"))return!1;var c=I;c.setTime((d||this.view.environment.lighting.date).getTime());a=v.positionToTimezone(a,x);if(r.isNone(a))return!1;var b=this.view.environment.lighting.positionTimezoneInfo;if(!b.autoUpdated)b=a;else if(b.hours===a.hours&&
b.minutes===a.minutes&&b.seconds===a.seconds)return!1;var e=c.getUTCHours()-(a.hours-b.hours),f=c.getUTCMinutes()-(a.minutes-b.minutes),b=c.getUTCSeconds()-(a.seconds-b.seconds);c.setUTCHours(e);c.setUTCMinutes(f);c.setUTCSeconds(b);return d?!1:this.view.environment.lighting.autoUpdate(c,a)};b.prototype._updateRenderParamsHandler=function(){var a=this.view._stage;if(a){var d=this._referencePosWGS84Comparable?p.computeShadowsEnabled(this._referencePosWGS84Comparable,this.view.viewingMode):!0,c=this.view.environment.background,
c=c instanceof F?{type:"color",color:u.vec4f64.fromArray(B.toUnitRGBA(c.color))}:{type:"color",color:u.vec4f64.fromValues(0,0,0,1)};a.renderView.setRenderParameters({shadowMap:this.view.environment.lighting.directShadowsEnabled&&d,ssao:this.view.environment.lighting.ambientOcclusionEnabled,background:c})}};b.prototype._resetReferencePosition=function(){this._cancelReferencePosUpdates();this._referencePosWGS84Comparable=this._referencePosResetPreserveAbsoluteTime=this._referencePosMapCoordsRequested=
this._referencePosMapCoords=null;this.notifyChange("updating")};b.prototype._requestReferencePositionUpdate=function(a,d){var c=this;void 0===d&&(d=!1);if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(a):this._referencePosMapCoordsRequested=a.clone(),this._referencePosResetPreserveAbsoluteTime=!!d,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&!this.view.interacting&&this.view.stationary)){var b=this._referencePosUpdateQuery=
t.after(this._referencePointUpdateDelay).then(function(){if(c._referencePosUpdateQuery===b)return c._doReferencePositionUpdateQuery(function(){return c._referencePosUpdateQuery!==b})}).catch(function(a){"mapcoordshelper:missing-geometry-service"===a.name&&(c.disableQueries=!0)}).then(function(){c._referencePosUpdateQuery===b&&(c._referencePosUpdateQuery=null,c.referencePosUpdateTimer||c._executePendingReferencePositionUpdate(),c.notifyChange("updating"))}),e=this.referencePosUpdateTimer=t.after(this._referencePointUpdateInterval).then(function(){c.referencePosUpdateTimer===
e&&(c.referencePosUpdateTimer=null,c._referencePosUpdateQuery||c._executePendingReferencePositionUpdate())});this.notifyChange("updating")}};b.prototype._doReferencePositionUpdateQuery=function(a){return A(this,void 0,void 0,function(){var d,c;return z(this,function(b){switch(b.label){case 0:return this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=
this._referencePosMapCoordsRequested.clone(),this._referencePosMapCoordsRequested=this._referencePosResetPreserveAbsoluteTime=null,[4,this.view.mapCoordsHelper.toGeographic(this._referencePosMapCoords)];case 1:return d=b.sent(),a()||isNaN(d[0])||isNaN(d[1])||(c=this._referencePosMapCoords.z*this.view.mapCoordsHelper.unitInMeters,this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=d[0],this._referencePosWGS84Comparable[1]=d[1],this._referencePosWGS84Comparable[2]=c):this._referencePosWGS84Comparable=
[d[0],d[1],c],this._referencePosChanged()),[2]}})})};b.prototype._executePendingReferencePositionUpdate=function(){var a=this._referencePosMapCoordsRequested;a&&this._requestReferencePositionUpdate(a,this._referencePosResetPreserveAbsoluteTime)};b.prototype._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams()};b.prototype._exceedsReferencePosDistThreshold=function(a){return this._referencePosMapCoords?
(a=this._referencePosMapCoords.distance(a),this.view.mapCoordsHelper&&(a*=this.view.mapCoordsHelper.unitInMeters),a>this._referencePointUpdateDistThreshold):!0};b.prototype._cancelReferencePosUpdates=function(){this.referencePosUpdateTimer=this._referencePosUpdateQuery=null};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{renderer:this._renderer,set referencePointUpdateInterval(b){a._referencePointUpdateInterval=b},set referencePointUpdateDistThreshold(b){a._referencePointUpdateDistThreshold=
b},set referencePosUpdateTimer(b){a.referencePosUpdateTimer=b},set referencePointUpdateDelay(b){a._referencePointUpdateDelay=b}}},enumerable:!0,configurable:!0});b.FIXED_LIGHT_DIRECTION=w;h([f.property({type:Boolean,dependsOn:["disableQueries","_renderer.updating"],readOnly:!0})],b.prototype,"updating",null);h([f.property()],b.prototype,"disableQueries",void 0);h([f.property({constructOnly:!0})],b.prototype,"view",void 0);h([f.property()],b.prototype,"_renderer",void 0);return b=h([f.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],
b)}(f.declared(C.EventedAccessor));l.SceneViewEnvironmentManager=e;var I=new Date,x={hours:0,minutes:0,seconds:0},G=k.vec3f64.fromValues(.22,.22,.33),H=k.vec3f64.fromValues(.22,.22,.22);l.default=e});