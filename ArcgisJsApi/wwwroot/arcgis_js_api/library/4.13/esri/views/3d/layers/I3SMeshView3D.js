// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Color ../../../Graphic ../../../core/asyncUtils ../../../core/Collection ../../../core/has ../../../core/iteratorUtils ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/requireUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/aaBoundingBox ../../../layers/graphics/controllers/I3SOnDemandController ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeUtils ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/edgeUtils ./support/layerViewUpdatingProperties ./support/symbolColorUtils ../support/debugFlags ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../webgl-engine/lib/Geometry ../webgl-engine/lib/Layer ../webgl-engine/lib/Object3D ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/TextureBackedBuffer/BufferManager ../webgl-engine/materials/component/index module @dojo/framework/shim/Promise".split(" "),
function(R,y,D,ha,m,ia,ja,ka,E,la,ma,na,S,oa,H,n,A,pa,qa,T,ra,sa,ta,h,U,ua,va,B,wa,V,xa,ya,za,W,X,Aa,Ba,Ca,k,Da,K,Y,Ea,C,M,Fa,N,Ga,Ha,Ia,Ja,O,Z,P,Ka,aa,La){function ba(k){var h=k.metallicRoughness;return h&&0<=h.baseColorTextureId||h&&0<=h.metallicRoughnessTextureId||0<=k.normalTextureId||0<=k.emissiveTextureId||0<=k.occlusionTextureId}function ca(k){return n.isSome(k)&&T.isArrayBuffer(k.data)}function da(k,h){for(var c=1024,a=0;a<k.length;a++)var b=k[a],c=c+(b.interleavedVertexData.byteLength+(b.indices?
b.indices.byteLength:0)),c=c+(b.positionData.data.byteLength+b.positionData.indices.byteLength);if(n.isSome(h))for(k=0;k<h.length;k++)a=h[k],n.isSome(a)&&T.isArrayBuffer(a.data)&&(c+=a.data.byteLength);return c}function ea(k,h){return 104857600<h.byteSize?(F.warn("Node is too big to store in IndexedDB cache: "+k.id+" ("+h.byteSize+" bytes)"),!1):0<h.byteSize}Object.defineProperty(y,"__esModule",{value:!0});var F=oa.getLogger("esri.views.3d.layers.SceneLayerView3D"),fa=[1,1,1,1],Ma=function(){return function(){}}();
y.I3SMeshView3D=function(y){return function(y){function c(){var a=null!==y&&y.apply(this,arguments)||this;a._layerUid="";a._highlights=new Aa(a);a._elevationProvider=null;a._worker=new W;a._workerThread=null;a._nodeId2Meta=new Map;a._addTasks=new Map;a._rendererVersion=0;a._rendererFields=null;a._colorVariable=null;a._opacityVariable=null;a._symbolInfos=new Map;a._idbCache=new Da.IDBCache("esri-scenelayer-cache","geometries");a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;
a._layerUrl="";a._cacheKeySuffix=null;a._tmpAttributeOnlyGraphic=new E(null,null,{});return a}ha(c,y);Object.defineProperty(c.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"rendererTextureUsage",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)?31:12},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=ra.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=za.getMetersPerUnit(a.unit);return(a.offset||0)*d/b}return 0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useCompressedTextures",{get:function(){var a=this.layer.version,a=!na("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.renderView.has("s3tc")&&a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},
enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;ta.open(pa.getAbsMid("./SceneLayerWorker",R,La)).then(function(b){a.destroyed?b.close():a._workerThread=b});k.checkSceneLayerValid(this.layer);k.checkSceneLayerCompatibleWithView(this.layer,this.view);this._layerUid=this.layer.uid;this._layerUrl=this.layer.parsedUrl.path;this._controller=new wa({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;if(this._isIntegratedMesh||
!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var b=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(b&&b.faceRange&&b.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,
function(b){return a._deleteNodeStageData(b)});this._addThisLayerToStage();this._elevationProvider=new Ba({layerView:this,stageLayer:this._stageLayer});this.updatingHandles.add(this,"view.clippingArea",function(){return a._clippingAreaChanged()},2);this.updatingHandles.add(this,"fullOpacity",function(b){return a._opacityChange(b)});this.updatingHandles.add(this,"slicePlaneEnabled",function(b){return a._slicePlaneEnabledChange(b)});this.updatingHandles.add(this,"elevationOffset",function(b,e){return a._reloadAll(e)});
this.updatingHandles.add(this,"filter",function(){return a._filterChange()},2);this.view.watch("qualitySettings.physicallyBasedRenderingEnabled",function(b){return a._enablePhysicalBasedRendering(b)});b=function(){a._reloadAll();a._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",b);this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",b);this.updatingHandles.add(this,"suspended",function(b){return a._suspendedChange(b)},2);this.handles.add(sa.init(M,"I3S_TREE_SHOW_TILES",
function(b){if(b&&!a._treeDebugger){var d=a._controller.crsIndex;(new Promise(function(a,b){R(["./support/I3STreeDebugger"],a,b)})).then(function(b){b=b.I3STreeDebugger;!a._treeDebugger&&M.I3S_TREE_SHOW_TILES&&(a._treeDebugger=new b({lv:a,view:a.view,nodeSR:d}))})}else b||!a._treeDebugger||M.I3S_TREE_SHOW_TILES||(a._treeDebugger.destroy(),a._treeDebugger=null)}));this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(function(a){return F.warn("Failed to initialize IndexedDB cache: "+
a)});this._componentColorManager=this._hasSymbolColors?new Ka.BufferManager(this._stage.renderView.renderingContext):null};c.prototype.destroy=function(){this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._memCache=null;this._removeThisLayerFromStage();this._stage=null;this._idbCache&&(this._idbCache.destroy(),this._idbCache=null);this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);null!=
this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};c.prototype.memEstimateTextureRemoved=function(a){a=
a.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};c.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};c.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};c.prototype.isNodeLoaded=function(a){return this._nodeId2Meta.has(a)};c.prototype.getUsedMemory=function(){var a=0;this._nodeId2Meta.forEach(function(b){return a+=
b.node.memory});return a};c.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0};c.prototype.ignoresMemoryFactor=function(){return!1};c.prototype._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)};c.prototype.getStats=function(){var a={index:0,nodes:this._nodeId2Meta.size.toString(),
"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};this._controller&&(this._cachingEnabled()&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a};c.prototype._addThisLayerToStage=function(){var a=""+this.layer.uid;this._stageLayer=a=new Ia(a,{},a);this._stage.add(0,a);
this._stage.addToViewContent([a.id])};c.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var a=this._stage;this._removeAllNodeDataFromStage();P.verify(0===this._nodeId2Meta.size);a.remove(0,this._stageLayer.id);this._stageLayer=void 0;this.gpuMemoryEstimate=0}};c.prototype.getLoadedAttributes=function(a){if((a=this._nodeId2Meta.get(a))&&a.attributeInfo)return a.attributeInfo.loadedAttributes};c.prototype.getAttributeData=function(a){if((a=this._nodeId2Meta.get(a))&&a.attributeInfo)return a.attributeInfo.attributeData};
c.prototype.setAttributeData=function(a,b){if(a=this._nodeId2Meta.get(a))a.attributeInfo=b,a.cachedRendererVersion=this._getInvalidRendererVersion(),a.filteredIds=null,this._updateEngineObject(a)};c.prototype.getLoadedNodeIds=function(){var a=[];this._nodeId2Meta.forEach(function(b){return a.push(b.node.id)});return a.sort()};c.prototype.getLoadedNodes=function(){var a=[];this._nodeId2Meta.forEach(function(b){return a.push(b.node)});return a};c.prototype.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach(function(b,
d){return a.push(d)})};c.prototype._calcEngineMaterialTransparencyParams=function(a,b,d){void 0===b&&(b=!1);void 0===d&&(d=!1);if(this._isIntegratedMesh)return{baseColorOpacity:1,layerOpacity:1,forceTransparency:!1};var e=this.fullOpacity,f=H.clamp(a.metallicRoughness.baseColorFactor[3],0,1);return{baseColorOpacity:f,layerOpacity:e,forceTransparency:1>f||1>e||!b&&"blend"===a.alphaMode||d}};c.prototype._getMaterialParameters=function(a,b,d){var e=a.metallicRoughness.baseColorFactor,f=this._isIntegratedMesh,
c=this._calcEngineMaterialTransparencyParams(a),l=this.rendererTextureUsage,p=function(a){if(0!==(a&l))a:{if(!n.isNone(b))for(var e=0;e<b.length;e++){var f=b[e];if(n.isSome(f)&&0!==(f.usage&a)){a=d[e].id;break a}}a=null}else a=null;return a};return D({usePBR:!f&&(a.isSchematic?this.view.qualitySettings.physicallyBasedRenderingEnabled:!0),baseColor:[e[0],e[1],e[2]],metallicFactor:a.metallicRoughness.metallicFactor,roughnessFactor:a.metallicRoughness.roughnessFactor,emissiveFactor:a.emissiveFactor,
reflectanceFactor:a.isSchematic?.2:.5,baseColorTexture:p(1),metallicRoughnessTexture:p(2),normalTexture:p(4),emissiveTexture:p(16),occlusionTexture:p(8),doubleSidedShading:a.doubleSided,cullFace:a.cullFace,writeStencil:f,receiveSSAO:!f,normals:f?"ground":"vertex"},c)};c.prototype._getGeometryParameters=function(a){return{textureCoordinates:a.hasTexture,textureCoordinateRegions:a.hasTexture&&a.hasRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?
"none":a.hasNormals?"compressed":"screen-space"}};c.prototype._createTexture=function(a,b,d,e){if(n.isNone(d)||null==d.data)return null;var f=d.data,c=b.wrapTextures;b=d.usage&1?"opaque"===b.alphaMode?3:4:3;var l=!0,p;d.encoding===k.DDS_ENCODING_STRING?p=Z.DDS_ENCODING:l=H.isPowerOfTwo(f.width)&&H.isPowerOfTwo(f.height);l=(e?this._enableAtlasMipMaps:this._enableMipMaps)&&l;d=new Z(f,a.id+"/"+d.id,{mipmap:l,wrap:e||!c?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:e&&l&&this._disableAtlasAnisotropy,
encoding:p,noUnpackFlip:!0,components:b});this._stage.add(4,d);a.memory+=this.memEstimateTextureAdded(d);return d};c.prototype._getVertexBufferLayout=function(a,b){a={hasTexture:ba(a.params.material),hasNormals:null!=b.vertexAttributes.normal,hasRegions:null!=b.vertexAttributes.region};return Ga.glLayout(aa.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(a)))};c.prototype._createEngineMaterial=function(a,b,d,e){var f=this,c=b.params.material,l=e.some(function(a){return"region"===
a.name});b=n.isSome(d)?d.map(function(b){return f._createTexture(a,c,b,l)}):[];e=e.some(function(a){return"normalCompressed"===a.name});var p=ba(c);d=this._getMaterialParameters(c,d,b);e=this._getGeometryParameters({hasTexture:p,hasRegions:l,hasNormals:e});d=aa.ComponentMaterial.create(d,e,""+a.id);d.metadata={material:c,textures:b,isSchematic:c.isSchematic};return d};c.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){var b=
K.attributeLookup(a.attributes,this._getObjectIdField()),d=null;S.everyMap(this._nodeId2Meta,function(a,f){f=a.featureIds.indexOf(b);if(-1===f)return!0;d={node:a.node,index:f};return!1});return d};c.prototype._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.index);if(!a)return[];for(var d=[],e=this._getObjectIdField(),f=0;f<b.length;f++){var c=K.attributeLookup(b[f].attributes,e),c=a.featureIds.indexOf(c);-1!==c&&d.push(c)}return d};c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);
if(!a)return A.reject();var b=this._nodeId2Meta.get(a.node.index).engineObject;a=this._boundingBoxCornerPoints(a.index,b,new Float64Array(24));if(N.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=B.empty(),B.expandWithBuffer(b,a,0,8),A.resolve({boundingBox:b,screenSpaceObjects:[]})};c.prototype.whenGraphicAttributes=function(a,b){var d=this;return k.whenGraphicAttributes(this.layer,a,this._getObjectIdField(),b,function(a){for(var b=new Map,e=[],c=0;c<
a.length;c++){var p=a[c],I=d._findGraphicNodeAndIndex(p),k=b.get(I.node);k||(k={node:I.node,indices:[],graphics:[]},e.push(k));k.indices.push(I.index);k.graphics.push(p)}return e},{ignoreUnavailableFields:!0,populateObjectId:!0})};c.prototype.getGraphicFromStageObject=function(a,b){if(this._isIntegratedMesh)return null;var d=this._getMetadata(a);a=a.getComponentFromTriangleNr(0,b);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?this._createGraphic(a,d):null};c.prototype.hasStageObject=function(a){var b=
a.getMetadata();return(b=this._nodeId2Meta.get(b.nodeIndex))&&b.engineObject===a};c.prototype._getMetadata=function(a){a=a.getMetadata();return this._nodeId2Meta.get(a.nodeIndex)};c.prototype._getCacheKey=function(a){return this._layerUrl+"/v6/"+a.id+this._cacheKeySuffix};c.prototype._getMemCacheKey=function(a,b){void 0===b&&(b=this.elevationOffset);return a+"#"+b};c.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};
c.prototype.loadCachedGPUData=function(a){return this._memCache.pop(this._getMemCacheKey(a.index))};c.prototype.loadMissingTextures=function(a,b,d,e){var c=this,g=a.filter(function(a,d){if(0===(a.usage&c.rendererTextureUsage))return!1;if(n.isNone(b))return!0;a=k.selectEncoding(a.encodings,c.useCompressedTextures);d=b[d];return n.isNone(d)||null==d.data||a&&d.encoding!==a.encoding?!0:!1});return 0===g.length?A.resolve(!1):d(g,e).then(function(d){for(var e=0,c=0;c<a.length;c++)e<d.length&&d[e].id===
a[c].id&&(b[c]=d[e],e++);return!0})};c.prototype.loadCachedNodeData=function(a,b,d){var e=this;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(a),b).then(function(c){if(null==c)return null;if(c.nodeVersion!==a.version)return e._idbCache.remove(e._getCacheKey(a)),null;a.obb||(a.obb=Fa.clone(c.nodeObb),e._controller.updateVisibility(a.index));return e.loadMissingTextures(c.requiredTextures,c.textureData,d,b).then(function(d){d&&e._idbCache.initialized&&n.isSome(c.textureData)&&(c.byteSize=
da(c.transformedGeometries,c.textureData),c.textureData.every(ca)&&ea(a,c)&&e._idbCache.put(e._getCacheKey(a),c).catch(function(b){return F.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+b)}));A.throwIfAborted(b);return c})}):A.resolve(null)};c.prototype.addNodeData=function(a,b){var d=this;if(0===b.allGeometryData.length||0===b.allGeometryData[0].geometries.length)return A.resolve();1!==b.allGeometryData.length&&console.warn("Node with",b.allGeometryData.length,"geometries is unsupported");
return this._addData(a,b.attributeDataInfo,function(){return d._transformNode(a,b).then(function(b){return d._controller.reschedule(a.index,b)}).then(function(e){a.obb||(a.obb=e.obb,d._controller.updateVisibility(a.index));b.allGeometryData[0].componentOffsets=e.componentOffsets;e.featureIds&&(b.allGeometryData[0].featureIds=Array.prototype.slice.call(e.featureIds));e={geometryData:b.allGeometryData[0],transformedGeometries:e.transformedGeometries,requiredTextures:b.requiredTextures,textureData:b.textureData,
nodeVersion:a.version,nodeObb:a.obb,byteSize:d._cachingEnabled()?da(e.transformedGeometries,b.textureData):0};if(ea(a,e)&&d._idbCache.initialized){var c=n.isSome(e.textureData)?e.textureData.map(function(a){return ca(a)?a:null}):null;d._idbCache.put(d._getCacheKey(a),D({},e,{textureData:c})).catch(function(b){return F.warn("Failed to store node in IndexedDB cache: "+a.id+": "+b)})}return d._addCachedNodeData(a,e)})})};c.prototype._transformNode=function(a,b){for(var d=this,e=b.allGeometryData[0].geometries,
c=Array(e.length),g=0;g<e.length;++g)c[g]=this._getVertexBufferLayout(e[g],b.geometryIndex);var l={geometryBuffer:b.geometryBuffer,geometryData:b.allGeometryData[0],geometryIndex:b.geometryIndex,layouts:c,mbs:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};
return this._workerThread?this._workerThread.invoke("process",l,{transferList:[b.geometryBuffer]}):W.ensureDracoDecoder(l).then(function(){return d._controller.reschedule(a.index,l).then(function(a){return d._worker.transform(a)})})};c.prototype.addCachedGPUData=function(a,b,d){if(this._controller.isGeometryVisible(a)){this._nodeId2Meta.set(a.index,b);this.updateNodeStatus(a.index,d);b.engineObject.setHidden(b.engineObject.geometryRecords[0],!1);a=0;for(d=b.engineObject.geometryRecords;a<d.length;a++){var e=
d[a].material;e.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled,usePBR:!this._isIntegratedMesh&&(e.metadata.isSchematic?this.view.qualitySettings.physicallyBasedRenderingEnabled:!0)})}this._updateEngineObject(b);this._highlights.objectCreated(b.engineObject);this._treeDebugger&&this._treeDebugger.update()}else d=this._controller.indexDepth-a.level,this._memCache.put(this._getMemCacheKey(a.index),b,a.memory,d)};c.prototype.addCachedNodeData=function(a,b,d){var e=this;return this._addData(a,
d,function(){return e._addCachedNodeData(a,b)})};c.prototype._addCachedNodeData=function(a,b){var d=this;if(this.suspended||!this._controller.isGeometryVisible(a))return A.resolve();var e=b.geometryData,c=b.transformedGeometries,g=n.isSome(b.textureData)?b.textureData.filter(function(a){return n.isSome(a)&&0!==(a.usage&d.rendererTextureUsage)}):null,l=new Map;l.set(1,{});l.set(2,{});l.set(3,{});var p=0,k=!1;a.memory=0;var h=e.componentOffsets,t=e.geometries,e=e.featureIds,r=null,w=null;if(this._hasSymbolColors)for(var r=
this._componentColorManager.getBuffer(e.length),w=new Uint16Array(e.length),q=0;q<e.length;q++)w[q]=r.acquireIndex();for(var q=a.id+"|"+e[0],m=[],u=[],y=[],z=[],B=this.view,C,D=0;D<t.length;D++){var G=t[D],x=c[p++],E=this._createEngineMaterial(a,G,g,x.layout);C=x.corMatrices.globalTrafo;k=k||x.hasColors;x=new O(new Float32Array(x.interleavedVertexData),x.layout,x.positionData,h||O.DefaultOffsets,x.indices||O.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(x,w);var G=null!=G.transformation?
U.mat4f64.clone(G.transformation):Na,L=m.length,x=new Ha(x,q+(0<L?"_"+L:"")),L=B.renderSpatialReference;m.push(x);y.push(G);z.push(E);G=Ca.createOrigin(a.mbs,this.elevationOffset,this._controller.crsIndex,L);u.push(G);a.memory+=this.memEstimateGeometryAdded(x.data);l.get(3)[E.id]=E;l.get(2)[x.id]=x}var J=new Ja({idHint:a.id,geometries:m,materials:z,transformations:y,origins:u,castShadow:!0,metadata:{nodeIndex:a.index,layerUid:this._layerUid}});J.objectTransformation=C;l.get(1)[J.id]=J;var H=this._addTasks.get(a.index),
v=new Ma;v.node=a;v.engineObject=J;v.featureIds=e;v.componentColorBuffer=r;v.componentIndices=w;v.cachedRendererVersion=this._getInvalidRendererVersion();v.cachedSymbolInfos=[];v.attributeInfo=H.attributeInfo;!this._hasTextures&&b.requiredTextures.some(function(a){return 0!==(a.usage&19)})&&(this._hasTextures=!0);this._hasColors||(this._hasColors=k);this._hasData=!0;this.notifyChange("hasTexturesOrVertexColors");var K=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(v).then(function(){var b=
d._stageLayer,e=d._stage,c=l.get(1),f;for(f in c)c.hasOwnProperty(f)&&b.addObject(c[f]);l.forEach(function(a,b){for(var d in a)a.hasOwnProperty(d)&&null==e.getContent(b,d)&&e.add(b,a[d])});d._nodeId2Meta.has(a.index)&&(F.warn("Removing duplicated node"),d._deleteNodeStageData(d._nodeId2Meta.get(a.index)));d._nodeId2Meta.set(a.index,v);if(d.suspended)d._removeNodeStageData(a.index,d.elevationOffset);else{v.attributeInfo=H.attributeInfo;v.cachedRendererVersion===d._rendererVersion&&K===d.slicePlaneEnabled||
d._addOrUpdateEdgeRendering(v);d._setObjectSymbology(v);d._applyFiltersToNode(v)&&d._updateEdgeRendering(v);d.visibleGeometryChanged(J);d._highlights.objectCreated(J);b=0;for(c=v.engineObject.geometryRecords;b<c.length;b++)c[b].material.updateParameters({slicePlaneEnabled:d.slicePlaneEnabled});d._markParentsAsHole(a.index);d._treeDebugger&&d._treeDebugger.update()}})};c.prototype._addData=function(a,b,d){var e=this,c=this._addTasks.get(a.index);c?c.attributeInfo=b:(c=D({},A.createResolver(),{attributeInfo:b}),
this._addTasks.set(a.index,c),d().then(c.resolve,c.reject).then(function(){return e._addTasks.delete(a.index)}).catch(function(b){e._addTasks.delete(a.index);throw b;}));return c.promise};c.prototype._markParentsAsHole=function(a){if(this._isIntegratedMesh){var b=this._controller;for(a=b.getParentIndex(a);a;a=b.getParentIndex(a))this.updateNodeStatus(a,"hole")}};c.prototype._clippingAreaChanged=function(){var a=B.create();N.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?
this._clippingArea=a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};c.prototype._filterChange=function(){this._applyFilters(!1)};c.prototype._applyFilters=function(a){var b=this;this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(a){b._applyFiltersToNode(a)&&(b._addOrUpdateEdgeRendering(a),b.visibleGeometryChanged(a.engineObject))})};c.prototype.getFilters=
function(){var a=this,b=[];this._clippingArea&&b.push(function(b,e){return a._boundingboxFilter(b,e,a._clippingArea)});return b};c.prototype.addSqlFilter=function(a,b,d,e){var c=this;b&&d&&a.push(function(a,f){return c._sqlFilter(a,f,b,d,e)})};c.prototype._sqlFilter=function(a,b,d,e,c){var f={},l=this._createLayerGraphic(f),p=this.layer.objectIdField,I=b.featureIds,h=b.attributeInfo.attributeData;e.every(function(a){return null!=h[a]||a===p})&&k.filterInPlace(a,I,function(a){f[p]=I[a];for(var b=0;b<
e.length;b++){var g=e[b];g!==p&&(f[g]=k.getCachedAttributeValue(h[g],a))}try{return d.testFeature(l)}catch(q){return c(q),!1}})};c.prototype._boundingboxNodeTest=function(a,b){N.mbsToMbs(a.node.mbs,this._controller.crsIndex,ga,this.view.renderSpatialReference);return k.intersectBoundingBoxWithMbs(b,ga)};c.prototype._boundingboxFeatureTest=function(a,b,d){return B.intersects(d,a.engineObject.geometryRecords[0].geometry.getComponentAABB(b,Oa))};c.prototype._boundingboxFilter=function(a,b,d){var c=this,
f=this._boundingboxNodeTest(b,d);if(3!==f)if(0===f)a.length=0;else if(b.engineObject.geometryRecords[0].geometry.componentCount===b.featureIds.length){var g=k.getClipAABB(d,b.engineObject);k.filterInPlace(a,b.featureIds,function(a){return c._boundingboxFeatureTest(b,a,g)})}};c.prototype._addOrUpdateEdgeRendering=function(a,b){void 0===b&&(b=!0);if(!this._edgeView)return A.resolve();var d=a.engineObject,c=this._edgeView.hasObject(d),f=this._extractObjectEdgeMaterials(a);a=f.perFeatureEdgeMaterials;
var g={slicePlaneEnabled:this.slicePlaneEnabled};if(f.hasEdges)if(f=!d.isHidden(d.geometryRecords[0]),c)this._edgeView.updateAllComponentMaterials(d,a,g,b),this._edgeView.updateObjectVisibility(d,f);else{if(f)return la.safeCast(this._edgeView.addObject(d,a,g,!1))}else c&&this._edgeView.removeObject(d);return A.resolve()};c.prototype._removeEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.engineObject)&&this._edgeView.removeObject(a.engineObject)};c.prototype._applyFiltersToNode=
function(a){var b=a.engineObject,d=b.areAllComponentsVisible();b.unhideAllComponents();if(0===this._filters.length)return!d;var c=a.featureIds;if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters;a=a.filteredIds;if(a===c)return!d;for(var d=b.geometryRecords[0],f=0,g=0;g<c.length;g++){var l=c[g];f>=a.length||a[f]!==l?b.setComponentVisibility(d,g,!1):f++}return!0};c.prototype._computeFilteredIds=function(a){for(var b=a.featureIds.slice(),
d=0,c=this._filters;d<c.length;d++)(0,c[d])(b,a);return b.length===a.featureIds.length?a.featureIds:b};c.prototype._removeAllNodeDataFromStage=function(a){var b=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(d,c){return b._removeNodeStageData(c,a)})};c.prototype.removeNodeData=function(a,b){for(var d=this.elevationOffset;0<a.length&&!b.done;){var c=a.pop();this._removeNodeStageData(c,d);b.madeProgress()}};c.prototype._removeNodeStageData=function(a,b){var d=this._nodeId2Meta.get(a);
if(d){var c=d.engineObject;c.setHidden(c.geometryRecords[0],!0);this.visibleGeometryChanged(c);this._removeEdgeRendering(d);this._nodeId2Meta.delete(a);this._highlights.objectDeleted(c);c=this._controller.indexDepth-d.node.level+1;this._memCache.put(this._getMemCacheKey(a,b),d,d.node.memory,c);this._treeDebugger&&this._treeDebugger.update()}};c.prototype._deleteNodeStageData=function(a){var b=this._stage,d=this._stageLayer,c=a.engineObject;this._edgeView&&this._edgeView.removeObject(c);d.removeObject(c);
for(var d=0,f=c.geometryRecords;d<f.length;d++){var g=f[d];this.memEstimateGeometryRemoved(g.geometry.data);b.remove(2,g.geometry.id);this._removeMaterial(g.material,b)}if(a.componentIndices){for(d=0;d<a.componentIndices.length;d++)a.componentColorBuffer.releaseIndex(a.componentIndices[d]);this._componentColorManager.garbageCollect()}b.remove(1,c.id)};c.prototype._removeMaterial=function(a,b){b.remove(3,a.id);var d=0;for(a=a.metadata.textures;d<a.length;d++){var c=a[d];c&&(this.memEstimateTextureRemoved(c),
b.remove(4,c.id))}};c.prototype.updateNodeStatus=function(a,b){if(a=this._nodeId2Meta.get(a)){b="hole"===b;var d=0;for(a=a.engineObject.geometryRecords;d<a.length;d++)a[d].material.updateParameters({polygonOffsetEnabled:b})}};c.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)};c.prototype._rendererChange=function(a){return ja(this,void 0,void 0,function(){var b,d,c,f,g,l,p,h;return ia(this,function(e){switch(e.label){case 0:this._currentRenderer=a;this.notifyChange("rendererTextureUsage");
this._rendererVersion=k.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;if(!a)return[3,2];b=this;d=k.findFieldsCaseInsensitive;return[4,a.getRequiredFields(this.layer.fields)];case 1:b._rendererFields=d.apply(void 0,[e.sent(),this.layer.fields]),e.label=2;case 2:if(a&&"visualVariables"in a&&a.visualVariables)for(c=0,f=a.visualVariables;c<f.length;c++)g=f[c],"color"===g.type?this._colorVariable=g:"opacity"===g.type?this._opacityVariable=g:
F.warn("Unsupported visual variable type for 3D Object Scene Services: "+g.type);if(a)for(l=0,p=a.getSymbols();l<p.length;l++)h=p[l],"mesh-3d"!==h.type&&F.error("Symbols of type '"+h.type+"' are not supported for 3D Object Scene Services.");this._controller&&this._controller.requestUpdate();return[2]}})})};c.prototype._getSymbolInfos=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolInfos};c.prototype._getSymbolColors=
function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolColors};c.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var b=a.featureIds?a.featureIds.length:1,c={},e=this._tmpAttributeOnlyGraphic;e.attributes=c;var f=this._currentRenderer,g=a.attributeInfo.attributeData,l=null!=a.featureIds?this.layer.objectIdField:null,p=null!=g?this._rendererFields:
null;null==a.cachedSymbolColors&&(a.cachedSymbolColors=new Uint8Array(4*a.featureIds.length));for(var h=a.cachedSymbolColors,m=!0,t=0;t<b;t++){null!=l&&(c[l]=a.featureIds[t]);if(null!=p)for(var r=0,w=p;r<w.length;r++){var q=w[r];g[q]&&(c[q]=k.getCachedAttributeValue(g[q],t))}w=f&&f.getSymbol(e,{arcadeUtils:xa});r=null;w instanceof ya&&(this._symbolInfos.has(w.id)||this._symbolInfos.set(w.id,k.getSymbolInfo(w)),r=this._symbolInfos.get(w.id));a.cachedSymbolInfos[t]=r;var n=q=null,u=!0,w=!0;f&&"visualVariables"in
f&&(this._colorVariable&&(u=V.getColor(this._colorVariable,e,{color:Pa}))&&(q=Q,q[0]=u.r/255,q[1]=u.g/255,q[2]=u.b/255,this._opacityVariable||null===u.a||(n=u.a)),this._opacityVariable&&(n=V.getOpacity(this._opacityVariable,e)));r&&r.material?(u=r.material,q=null==q||null==n?X.overrideColor(q,n,u.color,u.alpha,fa,Q):X.overrideColor(q,n,null,null,fa,Q),C.encodeSymbolColor(q,u.colorMixMode,h,4*t),u=r.castShadows):(C.encodeSymbolColor(null,null,h,4*t),u=!0);if(0<t&&m){for(r=4*(t-1);r<4*t;r++)h[r]!==
h[r+4]&&(m=!1);u!==w&&(m=!1)}w=u}a.uniformSymbolColor=m}};c.prototype._extractObjectEdgeMaterials=function(a){var b=a.engineObject,c=a.featureIds?a.featureIds.length:1,e=Array(c),f=Y.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),g={opacity:this.fullOpacity,objectTransparency:2};if(0<a.engineObject.geometryRecords.length){var l=a.engineObject.geometryRecords[0].material;g.objectTransparency=l.isVisible()?l.hasTransparency?1:2:0}var l=!1,k=null,h=null;a=this._getSymbolInfos(a);for(var m=0;m<
c;m++){var t=a[m];b.getComponentVisibility(b.geometryRecords[0],m)&&t?(h!==t&&(h=t,(k=Y.createMaterialFromEdges(t.edges,g))&&(l=!0)),e[m]=n.isSome(k)?k:f):e[m]=f}return{hasEdges:l,perFeatureEdgeMaterials:e}};c.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors){var b=a.featureIds?a.featureIds.length:1,c=this._getSymbolColors(a);if(a.uniformSymbolColor){var e=C.decodeSymbolColor(c,0),f=e.color,g=e.colorMixMode,e=!0;a.cachedSymbolInfos[0]&&(e=a.cachedSymbolInfos[0].castShadows);for(var l=
0,k=a.engineObject.geometryRecords;l<k.length;l++)b=k[l],b=b.material,b.updateParameters({componentData:{castShadows:e,externalColor:f,externalColorMixMode:g}});f=1>f[3];this._updateObjectOpacity(a.engineObject,!f&&"replace"===g,f)}else{for(var f=a.componentColorBuffer.textureBuffer,k=l=e=!0,h=0;h<b;h++){var g=4*h,m=a.componentIndices[h],n=1;a.cachedSymbolInfos[h]&&(n=!0===a.cachedSymbolInfos[h].castShadows?1:0);f.setData(m,0,c[g],c[g+1],c[g+2]&254|n,c[g+3]);m=C.isOpaqueSymbolColor(c,g);e=e&&m;l=
l&&!m;g=C.decodeSymbolColorMixMode(c,g);k=k&&2===g}g=0;for(c=a.engineObject.geometryRecords;g<c.length;g++)b=c[g],b=b.material,h="blend"!==b.metadata.material.alphaMode,b.updateParameters({componentData:{textureBuffer:f},useVertexTransparencyDiscards:!e&&!l&&h});this._updateObjectOpacity(a.engineObject,e&&k,!e);this._stage.renderView.setNeedsRender()}this._updateEdgeRendering(a)}};c.prototype._setComponentIndices=function(a,b){for(var c=a.getAttribute(P.VertexAttrConstants.COMPONENTINDEX),e=c.data,
f=c.offsetIdx,c=c.strideIdx,g=a.getIndices(P.VertexAttrConstants.COMPONENTINDEX),l=0;l<b.length;l++)for(var k=a.componentOffsets[l+1],h=a.componentOffsets[l];h<k;h++)e[f+g[h]*c]=b[l]};c.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){var b=this;this._nodeId2Meta.forEach(function(a){b._updateObjectOpacity(a.engineObject);b._updateEdgeRendering(a)})};
c.prototype._updateObjectOpacity=function(a,b,c){var d=0;for(a=a.geometryRecords;d<a.length;d++){var f=a[d].material,g=f.metadata;void 0!==b&&(g.allSymbolsOpaqueReplace=b);void 0!==c&&(g.someSymbolsTransparent=c);g=this._calcEngineMaterialTransparencyParams(g.material,g.allSymbolsOpaqueReplace,g.someSymbolsTransparent);f.updateParameters(g)}};c.prototype._updateEngineObject=function(a){this._setObjectSymbology(a);this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this.visibleGeometryChanged(a.engineObject)};
c.prototype._slicePlaneEnabledChange=function(a){var b=this,c={slicePlaneEnabled:a};this._stageLayer.isSliceable=a;this._nodeId2Meta.forEach(function(a){for(var d=0,e=a.engineObject.geometryRecords;d<e.length;d++)e[d].material.updateParameters(c);b._updateEdgeRendering(a,!1)})};c.prototype._enablePhysicalBasedRendering=function(a){var b=this,c={usePBR:!0};this._nodeId2Meta.forEach(function(a){var d=0;for(a=a.engineObject.geometryRecords;d<a.length;d++){var e=a[d].material;c.usePBR=!b._isIntegratedMesh&&
(e.metadata.isSchematic?b.view.qualitySettings.physicallyBasedRenderingEnabled:!0);e.updateParameters(c)}})};c.prototype._updateEdgeRendering=function(a,b){void 0===b&&(b=!0);this._edgeView&&this._edgeView.hasObject(a.engineObject)&&this._addOrUpdateEdgeRendering(a,b)};c.prototype._forAllFeatures=function(a,b,c){var d=this;void 0===c&&(c=0);S.everyMap(this._nodeId2Meta,function(e,g){if(n.isSome(b))switch(b(e)){case 0:return!1;case 2:return!0}return 0!==d._forAllFeaturesOfNode(e,a,c)})};c.prototype._forAllFeaturesOfNode=
function(a,b,c){void 0===c&&(c=0);var d=a.featureIds,f=a.engineObject.geometryRecords[0],g=2===c&&this._clippingArea?k.getClipAABB(this._clippingArea,a.engineObject):null,h=g?this._boundingboxNodeTest(a,this._clippingArea):3;if(0===h)return 1;for(var m=0;m<d.length;m++)if(a.engineObject.getComponentVisibility(f,m)||1===c||2===c&&(3===h||this._boundingboxFeatureTest(a,m,g))){var n=b(d[m],m,a,f);switch(n){case 0:return n}}return 1};c.prototype._createGraphic=function(a,b){var c={};null!=b.featureIds&&
(c[this._getObjectIdField()]=b.featureIds[a]);b=b.attributeInfo.attributeData;if(null!=b)for(var e=0,f=Object.keys(b);e<f.length;e++){var g=f[e];c[g]=k.getCachedAttributeValue(b[g],a)}return this._createLayerGraphic(c)};c.prototype._boundingBoxCornerPoints=function(a,b,c){a=b.geometries[0].getComponentAABB(a,Qa);for(var d=0;8>d;++d)z[0]=d&1?a[0]:a[3],z[1]=d&2?a[1]:a[4],z[2]=d&4?a[2]:a[5],ua.vec3.transformMat4(z,z,b.objectTransformation),c[3*d]=z[0],c[3*d+1]=z[1],c[3*d+2]=z[2];return c};c.prototype.highlight=
function(a,b){var c=this;void 0===b&&(b={});var e=this._highlights;"number"===typeof a?a=[a]:a instanceof E?a=[a]:a instanceof ma&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof E){a=a.map(function(a){return K.attributeLookup(a.attributes,c._getObjectIdField())});var f=e.acquireSet(b);b=f.set;f=f.handle;e.setFeatureIds(b,a);return f}if("number"===typeof a[0])return f=e.acquireSet(b),b=f.set,f=f.handle,e.setFeatureIds(b,a),f}return Ra};c.prototype.visibleGeometryChanged=function(a){var b=
this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=qa.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null}))};c.prototype.test=function(){var a=this;return{controller:this._controller,get visibleObjectIds(){var b=[];a._forAllFeatures(function(a,c,f,g){f.engineObject.isHidden(g)||f.engineObject.areAllComponentsHidden()||
!f.engineObject.getComponentVisibility(g,c)||b.push(a);return 1});b.sort(function(a,b){return a-b});return b},get numNodes(){return a._nodeId2Meta.size}}};m([h.property()],c.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);m([h.property()],c.prototype,"view",void 0);m([h.property()],c.prototype,"layer",void 0);m([h.property()],c.prototype,"_controller",void 0);m([h.property({dependsOn:["updatingMeshView3D"]})],c.prototype,"updating",void 0);m([h.property({dependsOn:["_controller.updating",
"_visibleGeometryChangedSchedulerHandle"]})],c.prototype,"updatingMeshView3D",null);m([h.property({dependsOn:["_controller.rootNodeVisible"]})],c.prototype,"suspended",void 0);m([h.property(Ea.updatingPercentage)],c.prototype,"updatingPercentage",void 0);m([h.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],c.prototype,"updatingPercentageValue",void 0);m([h.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null);m([h.property({readOnly:!0})],c.prototype,"rendererTextureUsage",
null);m([h.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null);m([h.property({type:Boolean})],c.prototype,"slicePlaneEnabled",void 0);m([h.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null);m([h.property({dependsOn:["layer.version"]})],c.prototype,"useCompressedTextures",null);return c=m([h.subclass("esri.views.3d.layers.I3SMeshView3D")],
c)}(h.declared(y))};var Na=U.mat4f64.create(),z=va.vec3f64.create(),Qa=B.create(),Oa=B.create(),Q=[0,0,0,0],Pa=new ka([0,0,0,0]),ga=[0,0,0,0],Ra={remove:function(){},pause:function(){},resume:function(){}}});