// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/assignHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingBox ../support/imageUtils ../support/buffer/BufferView ./PatchGeometryFactory ./PatchRenderData ./TileRenderer ./tileUtils ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/tracer ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainRendererPrograms ../../webgl/renderState ../../webgl/Util".split(" "),
function(J,qa,T,U,t,V,W,X,K,A,l,Y,L,Z,r,p,M,m,E,aa,ba,N,ca,da,u,ea,O,fa,F,ga,B,n,v,ha){var ia=ga.assert,ja=L.mat4f64.create(),G=Z.vec2f64.create(),H=E.create(),y=m.vec4f64.create(),z=m.vec4f64.create(),P=m.vec4f64.create(),ka=function(){return function(){this.extent=m.vec4f64.create();this.maxLevel=this.minLevel=0;this.callback=null}}();J=function(m){function b(a){a=m.call(this,a)||this;a.tileSize=256;a.rctx=null;a.renderDataPool=new K(ca.PatchRenderData);a.patchGroups=new A({allocator:function(a){return a||
{root:null,origin:null,patches:new A}},deallocator:function(a){a.root=null;a.origin=null;a.patches.clear();return a}});a.patchGroupsDirty=!0;a.patchGroupsMap=new Map;a.tileIterator=new u.IteratorPreorder;a.highestVisibleLODTile=null;a.visible=!0;a.debugScreenSizePerspective=!1;a._opaque=!0;a._skirtScale=1;a._renderPatchBorders=!1;a._renderingDisabled=!1;a.backfaceCullingEnabled=!1;a._renderOrder=1;a._velvetOvergroundEnabled=!0;a.hasOverlays=!1;a._slicePlaneEnabled=!1;a._wireframeEnabled=!1;a.castShadows=
!0;a.receiveShadows=!1;a.emptyTex=null;a.tileRenderer=null;a.tileBackgroundInitialized=!1;a.stencilEnabledLayerExtents=[];a.numTrianglesRendered=0;a.numTilesRendered=0;a.numTilesCulled=0;a.numOriginsRendered=0;a.clippingExtent=null;a.needsHighlight=!1;a.visibleScaleRangeQueries=new A({initialSize:10});a.visibleScaleRangeQueriesInvPtr=0;a.visibleScaleRangeQueryQueue=new A({initialSize:30});a.visibleScaleRangeQueryPool=new K(ka,!1);return a}T(b,m);b.prototype.destroy=function(){N.clearCaches()};b.prototype.install=
function(a){a.addRenderPlugin([4,9],this);this.drapedRenderer=a.renderView.getDrapedRenderer()};b.prototype.uninstall=function(a){a.removeRenderPlugin(this)};Object.defineProperty(b.prototype,"updating",{get:function(){return!this.tileBackgroundInitialized},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this._renderingDisabled},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"renderingDisabled",{set:function(a){this._renderingDisabled=!!a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"opaque",{get:function(){return this._opaque&&!this._slicePlaneEnabled},set:function(a){this._opaque!==a&&(this._opaque=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"skirtScale",{set:function(a){this._skirtScale=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"renderPatchBorders",{set:function(a){this._renderPatchBorders!==a&&(this._renderPatchBorders=a,this._updatePrograms())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"cullBackFaces",{set:function(a){this.backfaceCullingEnabled=a;this._updatePrograms();this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderOrder",{get:function(){return this._renderOrder},set:function(a){this._renderOrder=a;this.setNeedsRender()},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"velvetOvergroundEnabled",{set:function(a){this._velvetOvergroundEnabled!==a&&(this._velvetOvergroundEnabled=a,this._updatePrograms())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return O.TERRAIN_ID},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=
a,this._updatePrograms())},enumerable:!0,configurable:!0});b.prototype.setRootTiles=function(a){this.rootTiles=a;this.setNeedsRender()};b.prototype.setNeedsHighlight=function(a){this.needsHighlight=a;this.setNeedsRender()};b.prototype.setStencilEnabledLayerExtents=function(a){this.stencilEnabledLayerExtents=a;this.setNeedsRender()};b.prototype.setTileSize=function(a){this.tileSize=a;this.tileRenderer&&(this.tileRenderer.tileSize=a);this.setNeedsRender()};b.prototype.loadCachedElevationData=function(a){ia(null===
a.renderData);var c=u.tile2str(a);if(c=this.memCache.pop(c)){a.renderData=c.renderData;a.renderData.tile=a;a.renderData.localOrigin=this._getLocalOriginOfTile(a);for(var f=0;f<c.upsampleLIJs.length;f++){var g=u.findParentByLIJ(a,c.upsampleLIJs[f]);a.layerInfo[0][f].setUpsampleInfo(a,g)}}return null!=c};b.prototype.loadTile=function(a){a.renderData||(a.renderData=this.renderDataPool.acquire(),a.renderData.init(a),a.renderData.localOrigin=this._getLocalOriginOfTile(a),this.updateTileGeometry(a));this.updateTileTexture(a)};
b.prototype.queryVisibleLevelRange=function(a,c,f,g){var b=this.visibleScaleRangeQueryPool.acquire();M.vec4.copy(b.extent,a);b.minLevel=c?c:-Number.MAX_VALUE;b.maxLevel=null!=f?f:Number.MAX_VALUE;b.callback=g;this.visibleScaleRangeQueryQueue.push(b);this.setNeedsRender()};b.prototype.updateTileTexture=function(a){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(a),a.resetPendingUpdate(32))};b.prototype.updateTileGeometry=function(a){for(var c=0,f=a.layerInfo[0];c<
f.length;c++)f[c].pendingUpdates&=-17;a.renderData.updateGeometry(this.rctx,this._wireframeEnabled)&&this.setNeedsRender()};b.prototype.unloadTile=function(a,c){if(a.renderData){a.renderData.releaseTexture();if(c){c={renderData:a.renderData,upsampleLIJs:[]};for(var f=0,b=a.layerInfo[0];f<b.length;f++){var e=b[f].upsampleFromTile.tile.lij;c.upsampleLIJs.push([e[0],e[1],e[2]])}this.memCache.put(u.tile2str(a),c,a.renderData.estimatedGeometryMemoryUsage)}else this.releaseTileGeometry(a.renderData);a.renderData=
null;a.setMemoryDirty();this.setNeedsRender()}};b.prototype._getLocalOriginOfTile=function(a){var c=Math.max(0,7*Math.floor((a.lij[0]-3)/7));if("spherical"===this.manifold&&0===c)return p.vec3f64.ZEROS;for(;a.parent&&a.lij[0]>c;)a=a.parent;return a.centerAtSeaLevel};b.prototype.setVisibility=function(a){this.visible=a;this.setNeedsRender()};b.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,
numOriginsRendered:this.numOriginsRendered}};b.prototype.setDebugScreenSizePerspective=function(a){a!==this.debugScreenSizePerspective&&(this.debugScreenSizePerspective=a,this._updatePrograms())};b.prototype.setWireframe=function(a){var c=this;this._wireframeEnabled!==a&&(this._wireframeEnabled=a,this.rootTiles&&(u.traverseTilesPreorder(this.rootTiles,function(f){f.renderData&&f.renderData.updateGeometry(c.rctx,a)}),this.setNeedsRender()))};b.prototype.setNeedsRender=function(a){void 0===a&&(a=1);
this.patchGroupsDirty=!0;this._initContext.requestRender(a)};b.prototype.setTileBackground=function(a){this.tileBackground=a;this._updateTileBackground()};b.prototype.initializeRenderContext=function(a){var c=this;this._initContext=a;this.rctx=a.rctx;a=this.programRep=a.programRep;this._updatePrograms();this.tileRenderer=new da(this.rctx,this.tileSize,a,function(){return c.setNeedsRender()});this.tileBackground&&this._updateTileBackground();this.emptyTex=ea.createEmptyTexture(this.rctx)};b.prototype.uninitializeRenderContext=
function(a){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null);this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)};b.prototype.intersect=function(a,c,f,b,e){if(this.rootTiles&&(!a.enable.selectOpaqueTerrainOnly||!a.enable.selectionMode||this._opaque)){var g=la,Q=ma;r.vec3.subtract(g,b,f);r.vec3.set(Q,1/g[0],1/g[1],1/g[2]);var I=a.results.min,h=a.results.max,p=a.results.terrain,q=null,m=this.clippingExtent,k=this.tileIterator;k.reset(this.rootTiles);e=function(){var e=
k.next();if(null===e.renderData)return"continue";if(a.enable.invisibleTerrain){if(!e.visible&&m&&!e.intersectsExtent(m))return"continue"}else if(!e.visible)return"continue";var d=e.renderData.geometryInfo,w=-R._skirtScale*d.skirtLength;if(0!==w){var x=e.up;E.offset(d.boundingBox,w*x[0],w*x[1],w*x[2],H);E.expandWithBuffer(H,d.boundingBox,0,2)}var x=0===w?d.boundingBox:H,l=e.renderData.localOrigin;r.vec3.subtract(C,f,l);if(!B.intersectAabbInvDir(x,C,Q,a.tolerance))return"continue";var t=function(a,
c,f,b){a.set(void 0,u.tile2str(c),f,b,ja,void 0);a.intersector=na;a.target=oa},x=function(d,k,l){0<=d&&(a.enable.backfacesTerrain||0>r.vec3.dot(k,g))&&(a.enable.invisibleTerrain||!a.enable.selectionMode||null==c||c(f,b,d))&&((null==p.dist||d<p.dist)&&t(p,e,d,k),a.enable.storeTerrainResults&&(a.enable.storeAll&&(X.isNone(q)?(q=new O.IntersectorResult(a.ray),t(q,e,d,k),a.results.all.push(q)):d<q.dist&&t(q,e,d,k)),(null==I.dist||d<I.dist)&&t(I,e,d,k),(null==h.dist||d>h.dist)&&t(h,e,d,k)))},n=pa;r.vec3.subtract(n,
b,l);var l=d.indices,v=d.vertexAttributes,y={data:v.getField("position",ba.BufferViewVec3f).typedBuffer,size:3,offsetIdx:0,strideIdx:v.stride/4},d=d.numWithoutSkirtIndices/3;B.intersectTriangles(C,n,0,d,l,y,null,x);0!==w&&N.intersectSkirts(C,n,d,l.length/3,l,v,"spherical"===R.manifold?function(a){return r.vec3.scale(a,a,w/r.vec3.length(a))}:function(a){return r.vec3.set(a,0,0,w)},x)};for(var R=this;!k.done;)e()}};b.prototype.render=function(a){if(a.slot!==(this.opaque?4:9))return!1;F.trace("# BEGIN RENDER TERRAIN");
var c=a.pass,f=1===a.scenelightingData.globalFactor,b=this._updatePatchGroups();h.overlayEnabled=!1;h.used=!0;switch(c){case 0:h.overlayEnabled=!0;h.used=!1;c=a.shadowMap&&a.shadowMap.enabled;this.receiveShadows!==c&&(this.receiveShadows=c,this._updatePrograms());c=!this.drapedRenderer.isEmpty();c!==this.hasOverlays&&(this.hasOverlays=c,this._updatePrograms());this._renderMaterialPass(a,this.programs.color,b,h);break;case 3:this.castShadows&&f&&this._renderAuxiliaryPass(a,this.programs.depthShadowMap,
b,h);break;case 1:this._renderAuxiliaryPass(a,this.programs.depth,b,h);break;case 2:this._renderAuxiliaryPass(a,this.programs.normal,b,h);break;case 4:this.needsHighlight&&(h.overlayEnabled=!0,this._renderAuxiliaryPass(a,this.programs.highlight,b,h),a.rctx.clearSafe(256))}F.trace("# END RENDER TERRAIN");0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender();return!0};b.prototype._renderMaterialPass=function(a,c,f,b){var e=this,d=a.camera;a.rctx.bindProgram(c);a.shadowMap&&a.shadowMap.bind(c);
a.ssaoHelper&&a.ssaoHelper.setUniforms(c);c.setUniform1i("tex",0);this._bindOverlayUniforms(c);c.setUniformMatrix4fv("viewNormal",d.viewInverseTransposeMatrix);c.setUniformMatrix4fv("proj",d.projectionMatrix);a.scenelightingData.setUniforms(c,!0);d=d.viewMatrix;r.vec3.set(D,d[12],d[13],d[14]);r.vec3.normalize(D,D);c.setUniform3fv("viewDirection",D);this.numOriginsRendered=this.numTrianglesRendered=this.numTilesCulled=this.numTilesRendered=0;this._prepareScaleRangeQueries();this.opaque?this._renderPatchGroups(a,
c,f,b):a.offscreenRenderingHelper.renderToTargets(function(){return e._renderPatchGroups(a,c,f,b)},a.offscreenRenderingHelper.tmpColor,a.offscreenRenderingHelper.mainDepth,[0,0,0,0]);this._processScaleRangeQueries()};b.prototype._renderAuxiliaryPass=function(a,c,b,g){a.rctx.bindProgram(c);if(4===a.pass){var f=a.offscreenRenderingHelper;a.rctx.bindTexture(f.depthTexture,5);c.setUniform1i("depthTex",5);c.setUniform4f("highlightViewportPixelSz",0,0,1/f.width,1/f.height)}else if(c.setUniformMatrix4fv("viewNormal",
a.camera.viewInverseTransposeMatrix),1===a.pass||3===a.pass)G[0]=a.camera.near,G[1]=a.camera.far,c.setUniform2fv("nearFar",G);this._renderPatchGroupsAuxiliary(a,c,b,g)};b.prototype._updateTileBackground=function(){var a=this;if(this.tileRenderer){var c=function(){a.tileBackgroundInitialized=!0;a.rootTiles&&u.traverseTilesPreorder(a.rootTiles,function(c){return a.tileRenderer.updateTileTexture(c)});a.setNeedsRender()};if("string"===typeof this.tileBackground){var b=this.tileBackground;aa.requestImage(b).then(function(f){b===
a.tileBackground&&a.tileRenderer&&(a.tileRenderer.setBackground(f),c())})}else{var g=this.tileBackground?V.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(g);c()}}};b.prototype._updatePatchGroups=function(){var a=this,c=this.patchGroups;if(!this.patchGroupsDirty)return c;this.highestVisibleLODTile=null;this._renderCollectOrigins(c);if(0!==this.renderOrder){for(var b=0;b<c.length;b++)u.sortTiles(this.renderOrder,c.data[b].patches);c.sort(function(c,b){var f=a.renderOrder;
c=0===c.patches.length?-f:0===b.patches.length?f:u.compareTiles(c.patches.data[0],b.patches.data[0],f);return c})}this.patchGroupsDirty=!1;return c};b.prototype._renderCollectOrigins=function(a){var c=this.rootTiles,b="spherical"===this.manifold;a.clear();for(var g=0;g<c.length;g++){var e=c[g],d=a.pushNew();d.root=e;d.origin=b?p.vec3f64.ZEROS:e.centerAtSeaLevel;d.patches.clear();this._renderCollectOriginsForRoot(a,d)}};b.prototype._renderCollectOriginsForRoot=function(a,c){var b=this.tileIterator;
b.resetOne(c.root);var g=this.patchGroupsMap;g.clear();for(g.set(c.origin,c);!b.done;){c=b.next();var e=c.renderData;if(e&&!c.visible)this.numTilesCulled++,b.skipSubtree();else{if(0===c.lij[0]%7){var d=a.pushNew();d.root=c;d.origin=c.centerAtSeaLevel;g.set(c.centerAtSeaLevel,d);d.patches.clear()}if(!c.rendered)this.numTilesCulled++;else if(e){(d=g.get(e.localOrigin))&&d.patches.push(c);if(!this.highestVisibleLODTile||c.vlevel>this.highestVisibleLODTile.vlevel)this.highestVisibleLODTile=c;b.skipSubtree()}}}};
b.prototype._scaleQueriesForTile=function(a){var c=a.extent;a=a.lij[0];for(var b=0;b<this.visibleScaleRangeQueriesInvPtr;){var g=this.visibleScaleRangeQueries.data[b],e=g.extent;a>=g.minLevel&&a<=g.maxLevel&&e[0]<=c[2]&&e[2]>=c[0]&&e[1]<=c[3]&&e[3]>=c[1]?(this.visibleScaleRangeQueries.swapElements(b,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):b++}};b.prototype._tileIntersectsStencilEnabledLayer=function(a){for(var c=this.stencilEnabledLayerExtents,b=0;b<c.length;b++)if(a.intersectsExtent(c[b]))return!0;
return!1};b.prototype._renderPatchGroupsAuxiliary=function(a,c,b,g){a.rctx.setPipelineState(this.defaultPipelineState);var f=0<this.stencilEnabledLayerExtents.length;c.setUniformMatrix4fv("proj",a.camera.projectionMatrix);c.setUniform1f("skirtScale",this._skirtScale);g.overlayEnabled&&this._bindOverlayUniforms(c);for(var d=0;d<b.length;d++){var l=b.data[d];this._bindViewForPatchGroup(c,l,a.camera.eye,a.camera.viewMatrix);for(var h=0;h<l.patches.length;h++)this._renderPatch(a.rctx,c,l.patches.data[h],
4,f,g)}a.rctx.bindVAO(null)};b.prototype._renderPatchGroups=function(a,c,b,g){var f=a.rctx,d=a.camera,l=d.viewMatrix;f.setPipelineState(this.defaultPipelineState);if(this.debugScreenSizePerspective&&this.pointsOfInterest){var h=fa.getSettings("spherical"===this.manifold?"global":"local");h.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:d.fovY});B.bindScreenSizePerspective(h,c,"screenSizePerspective")}h=0<this.stencilEnabledLayerExtents.length;c.setUniform1f("skirtScale",
this._skirtScale);for(var t=this._wireframeEnabled?1:4,p=0;p<b.length;p++){var q=b.data[p],r=q.patches;if(0!==r.length){this._bindViewForPatchGroup(c,q,d.eye,l);var k=a.sliceHelper&&a.sliceHelper.plane;k&&B.bindSlicePlane(q.origin,k,c);a.shadowMap&&a.shadowMap.bindView(c,q.origin);this.numOriginsRendered++;for(q=0;q<r.length;q++){k=r.data[q];F.trace("# RENDER TILE "+u.tile2str(k)+", screenDepth:"+k.screenDepth);var m=k.renderData.geometryInfo.uvOffsetAndScale,n=k.renderData.texOffsetAndScale;M.vec4.set(P,
m[0]*n[2]+n[0],m[1]*n[3]+n[1],m[2]*n[2],m[3]*n[3]);c.setUniform4fv("texOffsetAndScale",P);f.bindTexture(k.renderData.textureReference,0);c.setUniform1f("opacity",k.renderData.opacity);m=this._renderPatch(f,c,k,t,h,g);k.renderOrder=this.numTilesRendered;this.numTilesRendered++;this.numTrianglesRendered+=m/3;this._scaleQueriesForTile(k)}}}f.bindVAO(null)};b.prototype._renderPatch=function(a,c,b,g,e,d){d.overlayEnabled&&(this._bindOverlayTextures(c,b.renderData.overlays,d.used),c.setUniform1f("overlayOpacity",
b.renderData.overlayOpacity));e&&a.setPipelineState(this._tileIntersectsStencilEnabledLayer(b)?this.stencilPipelineState:this.defaultPipelineState);e=0===this._skirtScale?b.renderData.geometryInfo.numWithoutSkirtIndices:b.renderData.vao.indexBuffer.size;a.bindVAO(b.renderData.vao);ha.assertCompatibleVertexAttributeLocations(b.renderData.vao,c);a.drawElements(g,e,b.renderData.vao.indexBuffer.indexType,0);return e};b.prototype._bindViewForPatchGroup=function(a,c,b,g){a.setUniform3fv("origin",c.origin);
Y.mat4.translate(S,g,c.origin);a.setUniformMatrix4fv("view",S);a.setUniform3f("camPos",b[0]-c.origin[0],b[1]-c.origin[1],b[2]-c.origin[2])};b.prototype._bindOverlayUniforms=function(a){a.setUniform1i("ovInnerColorTex",1);a.setUniform1i("ovOuterColorTex",2);a.setUniform1i("ovInnerWaterTex",3);a.setUniform1i("ovOuterWaterTex",4)};b.prototype._bindOverlayTextures=function(a,b,f){for(var c=0;2>c;c++){var e=2*c,d=b[c],h=f?d.highlightRenderTargetId:d.renderTargetId;h?(y[e]=d.texOffset[0],y[e+1]=d.texOffset[1],
z[e]=d.texScale[0],z[e+1]=d.texScale[1],e=this.drapedRenderer.getRenderTargetTexture(h),this.rctx.bindTexture(e,1+c),(d=d.waterMaskRenderTargetId)?(d=this.drapedRenderer.getRenderTargetTexture(d),this.rctx.bindTexture(d,3+c)):this.rctx.bindTexture(this.emptyTex,3+c)):(y[e]=0,y[e+1]=0,z[e]=0,z[e+1]=0,this.rctx.bindTexture(this.emptyTex,1+c),this.rctx.bindTexture(this.emptyTex,3+c))}a.setUniform4fv("overlayTexOffset",y);a.setUniform4fv("overlayTexScale",z)};b.prototype._updatePrograms=function(){var a=
this.programRep;this.programs={color:a.getProgram(n.colorPass,{overlay:this.hasOverlays,atmosphere:"spherical"===this.manifold&&this._velvetOvergroundEnabled,tileBorders:this._renderPatchBorders,receiveShadows:this.receiveShadows,screenSizePerspective:this.debugScreenSizePerspective,slice:this._slicePlaneEnabled}),normal:a.getProgram(n.normalPass,{alphaZero:!0}),depth:a.getProgram(n.depthPass,{shadowMap:!1}),depthShadowMap:a.getProgram(n.depthPass,{shadowMap:!0}),highlight:a.getProgram(n.highlightPass,
{})};this.defaultPipelineState=v.makePipelineState({culling:this.backfaceCullingEnabled&&v.backFaceCullingParams,depthTest:{func:513},depthWrite:v.defaultDepthWriteParams,colorWrite:v.defaultColorWriteParams});this.stencilPipelineState=v.makePipelineState(U({},this.defaultPipelineState,{stencilTest:{function:{func:517,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7680}}}));this.setNeedsRender()};b.prototype.releaseTileGeometry=function(a){a.releaseGeometry()&&this.setNeedsRender();this.renderDataPool.release(a)};
b.prototype._prepareScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,c=this.visibleScaleRangeQueryQueue;a.length<a.data.length&&0<c.length;){var b=c.pop();a.push(b)}this.visibleScaleRangeQueriesInvPtr=a.length};b.prototype._processScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,c=this.visibleScaleRangeQueryPool,b=0;b<a.length;b++){var g=a.data[b];c.release(g);g.callback(b>=this.visibleScaleRangeQueriesInvPtr);g.callback=null}a.clear()};Object.defineProperty(b.prototype,
"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0});t([l.property()],b.prototype,"tileBackgroundInitialized",void 0);t([l.property({constructOnly:!0})],b.prototype,"manifold",void 0);t([l.property({constructOnly:!0})],b.prototype,"memCache",void 0);t([l.property({readOnly:!0,dependsOn:["tileBackgroundInitialized"]})],b.prototype,"updating",null);return b=t([l.subclass("esri.views.3d.terrain.TerrainRenderer")],b)}(l.declared(W));var h={overlayEnabled:!1,used:!0},
S=L.mat4f64.create(),D=p.vec3f64.create(),la=p.vec3f64.create(),ma=p.vec3f64.create(),C=p.vec3f64.create(),pa=p.vec3f64.create(),na="TerrainRenderer",oa={type:"external"};return J});