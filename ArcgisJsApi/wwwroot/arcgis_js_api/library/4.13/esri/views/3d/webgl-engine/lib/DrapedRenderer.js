// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../support/debugFlags ../../webgl-engine/lib/intersectorUtils ./Camera ./DefaultVertexBufferLayouts ./DrapedUpdates ./glUtil3D ./GridLocalOriginFactory ./Renderer ../lighting/Lightsources ../materials/ColorMaterial ../materials/HUDMaterial ../materials/RibbonLineMaterial ../shaders/MiscPrograms ../../../webgl/FramebufferObject ../../../webgl/renderState ../../../webgl/Texture ../../../webgl/Util".split(" "),
function(v,O,r,l,z,w,A,B,C,D,E,F,G,H,I,J,K,L,M,t,N,x){v=function(){function a(b,c,g,e,f,d){var a=this;this._renderTargets={};this._clearColor=z.vec4f64.fromValues(0,0,0,0);this._uniqueIdx=0;this._localOrigins=new F;this._rctx=b;this._canvas=c;this._programRep=g;this._modelDirtySet=d;this._modelDirtySet.onMaterialChanged=function(){return a._emitContentChanged()};this._renderer=new G(g,e,f,this._rctx,"draped",function(){return a._emitContentChanged()});this._updates=new D.DrapedUpdates(this._renderer,
{emitContentChanged:function(){return a._emitContentChanged()},emitUpdatingChanged:function(){return a._emitUpdatingChanged()}});this._renderer.onHasHighlightsChanged=function(b){if(a.onHasHighlightsChanged)a.onHasHighlightsChanged(b)};this._renderer.setLighting({lights:[new H.AmbientLight(l.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0})}a.prototype.dispose=function(){for(var b in this._renderTargets)this._renderTargets[b].dispose();this._renderTargets=null;this._renderer.dispose();
this._renderer=null;this._updates.dispose();this._updates=null};a.prototype.disposeRenderTarget=function(b){var c=this._renderTargets[b];c&&c.dispose();delete this._renderTargets[b]};Object.defineProperty(a.prototype,"updating",{get:function(){return this._updates.updating},enumerable:!0,configurable:!0});a.prototype.commitChanges=function(){this._updates.commitChanges()};a.prototype.getRenderTargetTexture=function(b){return(b=this._renderTargets[b])?b.colorTexture:null};a.prototype.addRenderGeometries=
function(b){for(var c=0;c<b.length;c++){var a=b[c];null==a.origin&&(a.origin=this._localOrigins.getOrigin(a.center));a.idx=this._uniqueIdx++}this._updates.add(b)};a.prototype.removeRenderGeometries=function(b){this._updates.remove(b)};a.prototype.updateRenderGeometries=function(b,c){this._updates.modify(b,c)};a.prototype.updateRenderOrder=function(b){0<b.size&&(this._renderer.modifyRenderOrder(b),this._emitContentChanged())};a.prototype.setBackgroundColor=function(b){this._clearColor=b;this._emitContentChanged()};
a.prototype.updateHighlights=function(b){this._updates.modify(b,16)};a.prototype.isEmpty=function(){return this._renderer.isEmpty()&&!w.OVERLAY_DRAW_TEST_TEXTURE};a.prototype.processDirtyMaterials=function(){var b=this._modelDirtySet.getDirtyMaterials();b&&this._renderer.modify(null,0,null,0,null,0,b);this._modelDirtySet.clearDirtyMaterials()};Object.defineProperty(a.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"hasWater",{get:function(){return this._renderer.hasWater},enumerable:!0,configurable:!0});a.prototype.draw=function(b,c){return this.drawPass(0,b,c)};a.prototype.drawNormals=function(b,c){return this.drawPass(2,b,c)};a.prototype.drawHighlights=function(b,c){return this.drawPass(4,b,c)};a.prototype.drawPass=function(b,c,a){this._pixelRatio=a.pixelRatio*Math.abs(a.views[0].extent[2]-a.views[0].extent[0])/Math.abs(a.views[0].viewport[2]-a.views[0].viewport[0]);if(this.isEmpty()||4===b&&!this.hasHighlights||
2===b&&!this.hasWater)return!1;this.processDirtyMaterials();if(!a.views.some(function(b){return b.extent[0]!==b.extent[2]&&b.extent[1]!==b.extent[3]}))return!1;c=this._renderTargets[c];if(!c)return!1;var e=this._rctx,f=a.width,d=a.height;c.width===f&&c.height===d||c.resize(f,d);var h=u.camera;u.fbo=c;h.near=1;h.far=1E4;h.pixelRatio=a.pixelRatio||1;e.bindFramebuffer(c);e.setClearColor.apply(e,this._clearColor);e.clearSafe(16384);for(var k=0;k<a.views.length;k++){var g=a.views[k];h.viewport=g.viewport;
r.mat4.ortho(h.projectionMatrix,0,g.extent[2]-g.extent[0],0,g.extent[3]-g.extent[1],h.near,h.far);r.mat4.identity(h.viewMatrix);r.mat4.translate(h.viewMatrix,h.viewMatrix,[-g.extent[0],-g.extent[1],0]);h.setGLViewport(this._rctx);w.OVERLAY_DRAW_TEST_TEXTURE&&this._drawTestTexture(f,d,y[a.index%y.length]);this._renderer.renderPass(b,u)}e.bindFramebuffer(null);e.setViewport(0,0,this._canvas.width,this._canvas.height);c.colorTexture.descriptor.hasMipmap&&c.colorTexture.generateMipmap();return!0};a.prototype._drawTestTexture=
function(b,a,g){var c=this._rctx;if(!this._testPatternTexture){for(var f=new Uint8Array(b*a*4),d=0,h=0;h<a;h++)for(var k=0;k<b;k++){var n=Math.floor(k/10),m=Math.floor(h/10);2>n||2>m||10*n>b-20||10*m>a-20?(f[d++]=255,f[d++]=255,f[d++]=255,f[d++]=255):(f[d++]=255,f[d++]=255,f[d++]=255,n&1&&m&1?f[d++]=k&1^h&1?0:255:f[d++]=n&1^m&1?0:128)}this._testPatternTexture=new N(c,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:b,height:a},f);this._testPatternProgram=this._programRep.getProgram(L.texOnly);
this._testPatternPipelineState=t.makePipelineState({blending:t.separateBlendingParams(770,1,771,771),colorWrite:t.defaultColorWriteParams});this._quadVAO=E.createQuadVAO(c,C.Pos3Tex)}b=this._testPatternProgram;c.bindProgram(b);c.setPipelineState(this._testPatternPipelineState);b.setUniform4f("color",g[0],g[1],g[2],1);b.setUniform1i("tex",0);c.bindTexture(this._testPatternTexture,0);c.bindVAO(this._quadVAO);c.drawArrays(5,0,x.vertexCount(this._quadVAO,"geometry"))};a.prototype.updateLogic=function(b){return this._renderer.updateLogic(b)};
a.prototype._emitContentChanged=function(){if(this.onContentChanged)this.onContentChanged()};a.prototype._emitUpdatingChanged=function(){if(this.onUpdatingChanged)this.onUpdatingChanged()};a.prototype.createRenderTarget=function(b,a,g,e){for(var c=b,d=0;this._renderTargets[c];)c=b+"_"+ ++d;this._renderTargets[c]=M.createWithAttachments(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:e,hasMipmap:a,maxAnisotropy:g,width:0,height:0},{colorTarget:0,depthStencilTarget:0});
return c};a.prototype.getGpuMemoryUsage=function(){var b=0,a;for(a in this._renderTargets)b+=x.getGpuMemoryUsage(this._renderTargets[a]);return b};a.prototype.intersect=function(b,a,g){var c=this,f=0;this._renderer.forEachRenderGeometry(function(d){if(!g||g(d)){if(d.material instanceof I||d.material instanceof K||d.material instanceof J){var e=d.transformation[12],k=d.transformation[13];p[0]=a[0]-e;p[1]=a[1]-k;p[2]=1;q[0]=a[0]-e;q[1]=a[1]-k;q[2]=0;d.pixelRatio=c._pixelRatio;d.material.intersect(d,
null,d.getShaderTransformation(),b,p,q,function(a,e,g,h,k,l){c.addIntersectionResult(g,d.material.renderPriority,f,b,d.data.layerUid,d.data.graphicUid)},d.calculateShaderTransformation,!0)}f++}})};a.prototype.addIntersectionResult=function(a,c,g,e,f,d){var b={type:"external",metadata:{layerUid:f,graphicUid:d}};f=function(d){d.set(b,null,e.results.terrain.dist,e.results.terrain.normal,e.results.terrain.transformation,c,null,null,a,g);d.intersector="DrapedRenderer"};(null==e.results.min.drapedLayerOrder||
c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||e.results.terrain.dist<=e.results.min.dist)&&f(e.results.min);(null==e.results.max.drapedLayerOrder||c<e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||e.results.terrain.dist>e.results.max.dist)&&f(e.results.max);e.enable.storeAll&&(d=new A.IntersectorResult(e.ray),f(d),e.results.all.push(d))};Object.defineProperty(a.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!0,configurable:!0});return a}();
var y=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],u={fbo:null,camera:new B.default,lightDirection:l.vec3f64.fromValues(0,0,1)},p=l.vec3f64.create(),q=l.vec3f64.create();return v});