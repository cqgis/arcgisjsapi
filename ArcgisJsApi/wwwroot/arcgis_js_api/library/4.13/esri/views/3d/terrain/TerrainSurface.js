// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/asyncUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/scheduling ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingRect ../../../layers/support/LercWorker ../../../layers/support/TilemapCache ../../2d/engine/vectorTiles/VectorTileDisplayObject ../support/debugFlags ../support/geometryUtils ../support/projectionUtils ./ElevationBounds ./ElevationData ./ElevationTileAgent ./MapTileAgent ./OverlayManager ./PlanarPatch ./SphericalPatch ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./Tile ./TilemapOnlyTile ./tileUtils ./tileUtils ./UpsampleInfo ../../support/index ../../webgl/Texture ../../webgl/Util @dojo/framework/shim/Promise".split(" "),
function(W,z,X,Y,g,Z,aa,J,ba,ca,da,ea,fa,ga,K,D,L,w,ha,M,d,ia,ja,ka,N,la,t,O,x,ma,E,P,F,na,Q,oa,pa,qa,ra,sa,R,ta,r,ua,n,va,wa,y,S,xa,ya,za,T){function U(d,c){return d[0]===c[0]&&d[1]===c[1]&&d[2]===c[2]}function V(d,c){var a=!1;c=c||d;var b=0;for(d=d.children;b<d.length;b++){var f=d[b];if(f){for(var h=0;h<f.layerInfo.length;h++)for(var k=0,e=f.layerInfo[h];k<e.length;k++){var l=e[k].upsampleFromTile;if(l&&l.tile===c)return!0}a=a||V(f,c)}}return a}function A(d){return d.isLeaf?!1:d.children[0].shouldRender||
d.children[1].shouldRender||d.children[2].shouldRender||d.children[3].shouldRender||A(d.children[0])||A(d.children[1])||A(d.children[2])||A(d.children[3])}var u=fa.getLogger("esri.views.3d.terrain.TerrainSurface");z=function(z){function c(a,b){b=z.call(this)||this;b.defaultTileBackground=r.DEFAULT_TILE_BACKGROUND;b.hideSkirtsDistanceFromExtentMargin=Aa;b.hideSkirtsMinimumCameraTilt=Ba;b.hideSkirtsMaximumCameraTilt=Ca;b._clippingExtent=null;b._dataExtent=null;b._elevationBounds=new na.ElevationBounds;
b._rootExtent=t.create();b._iteratorPool=new D(S.IteratorPreorder);b._postorderIterator=new S.IteratorPostorder;b._visible=!1;b._pendingUpdates=!1;b._asyncWorkItems=0;b._usedMemory=B;b._isFrameProcessing=!1;b._viewChangeUpdateDirty=!1;b._overlayOpacity=1;b._eyePosRenderSR=N.vec3f64.create();b._eyePosSurfaceSR=N.vec3f64.create();b._splitLimits=new va.SplitLimits;b._snapLevel=Infinity;b._frustum=P.frustum.create();b._viewProjectionMatrix=ja.mat4f64.create();b._layerViews=[[],[]];b._layerIndexByLayerViewId=
[new Map,new Map];b._basemapLayerViewHandles=new Map;b._handles=new ea;b._lowPrioUpdates=new L;b._topLevelTilemapOnlyTiles=[];b._upsampleInfoPool=new D(xa);b._visibleLevels=new L({deallocator:null});b._getElevationData={spatialReference:null,rootTiles:null};b.maxTextureScale=1.2;b.rootTiles=null;b.backgroundImage=r.DEFAULT_TILE_BACKGROUND;b.backgroundColor=null;b._scheduledLayerViewChangesHandle=null;b._lercWorker=O.acquireInstance(a.resourceController.scheduler);return b}Y(c,z);c.prototype.normalizeCtorArgs=
function(a,b){this._view=a;this._stage=a._stage;this._set("manifold",b);return{}};c.prototype.initialize=function(){var a=this;this._tilePool="planar"===this.manifold?new D(ra.PlanarPatch):new D(sa.SphericalPatch);this._memCache=this._view.resourceController.memoryController.getMemCache("esri.views.3d.terrain",function(b){return a._renderer.releaseTileGeometry(b.renderData)});this._renderer=new ua({manifold:this.manifold,memCache:this._memCache});this._renderer.install(this._view._stage);M.init(this,
"_background",function(){a._renderer.setTileBackground(a._background)});this._handles.add([this._view.watch("pointsOfInterest",function(b){a._renderer.pointsOfInterest=b}),M.init(E,"TERRAIN_TILE_TREE_SHOW_TILES",function(b){b&&!a._treeDebugger?(new Promise(function(a,b){W(["../layers/support/TerrainTileTree3DDebugger"],a,b)})).then(function(b){b=b.TerrainTileTree3DDebugger;!a._treeDebugger&&E.TERRAIN_TILE_TREE_SHOW_TILES&&(a._treeDebugger=new b({view:a._view}))}):b||!a._treeDebugger||E.TERRAIN_TILE_TREE_SHOW_TILES||
(a._treeDebugger.destroy(),a._treeDebugger=null)})]);this._set("overlayManager",new qa.OverlayManager({terrainSurface:this,view:this._view}));this._handles.add(this.watch("overlayManager.hasHighlights",function(b){return a._handleHasHighlights(b)}),"overlayManager");var b={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?new R.SurfaceExtentHelperGlobal(b):new R.SurfaceExtentHelperLocal(b);
this._handles.add(M.init(this.extentHelper,"stencilEnabledExtents",function(b){a._renderer.setStencilEnabledLayerExtents(b)}),"extentHelper");b=this._view.defaultsFromMap?new ca({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(a){return a.layers}}):this._view.map.allLayers;b=new ta({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",
this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._streamDataRequester=this._view.resourceController.createStreamDataRequester(0);this._handles.add(this._view.resourceController.scheduler.registerTask(ya.Task.TERRAIN_SURFACE,function(b){return a._frame(b)},function(){return a.updating}));this._view.resourceController.memoryController.events.on("quality-changed",
function(){return a._viewChangeUpdate()});this._handles.add([this._view.on("resize",function(){return a._viewChangeUpdate()}),this._view.watch("state.camera",function(){return a._viewChangeUpdate()},!0),this._view.watch("qualitySettings.tiledSurface.lodBias",function(){return a._viewChangeUpdate()}),this._view.watch("qualitySettings.tiledSurface.reduceTileLevelDifferences",function(){return a._viewChangeUpdate()}),this._view.watch("clippingArea",function(){return a._clippingChanged()})]);this._handles.add(this._view.allLayerViews.on("after-changes",
function(){return a._scheduleLayerViewChangesUpdate()}));this._handleLayerViewChanges();this._updateClippingExtent();this.notifyChange("extent")};c.prototype.destroy=function(){var a=this;this._handles.destroy();O.releaseInstance(this._lercWorker);this._lercWorker=null;this._removeAllTiles();this._memCache.destroy();this._memCache=null;this.tilingSchemeLogic.destroy();this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;this._basemapLayerViewHandles.forEach(function(b,
f){return a._unregisterTiledLayerView(f)});this._streamDataRequester=null;this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._tilePool.destroy();this._tilePool=null;oa.Pool.prune(0);pa.Pool.prune(0);this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);this._renderer.uninstall(this._stage);this._renderer.destroy();this._renderer=null;this._iteratorPool.destroy();this._stage=this._view=this._iteratorPool=null;this._upsampleInfoPool.destroy();
this._upsampleInfoPool=null};Object.defineProperty(c.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"frustum",{get:function(){return this._frustum},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"snapLevel",{get:function(){return Math.round(this._snapLevel)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"cullBackFaces",{set:function(a){this._renderer.cullBackFaces=a;this._set("cullBackFaces",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return!(!(this._pendingUpdates||this._renderer.updating||this._scheduledLayerViewChangesHandle)||!this.ready||this._get("suspended"))},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseOpacity",{set:function(a){var b=this._renderer.opaque;this._renderer.opaque=1<=a;this._set("baseOpacity",a);this._updateTileTextures(b!==this._renderer.opaque)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"skirtScale",{set:function(a){this._renderer.skirtScale=a;this._set("skirtScale",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){var a=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:
this.backgroundImage},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{set:function(a){this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOvergroundEnabled=a);this._set("velvetOverground",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"wireframe",{set:function(a){this._renderer.setWireframe(a);
this._set("wireframe",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"visible",{set:function(a){a!==this._visible&&(this._visible=a,this._renderer.setVisibility(a),this.suspended=!a)},enumerable:!0,configurable:!0});c.prototype.isOpaque=function(){return this._renderer.opaque};Object.defineProperty(c.prototype,"suspended",{set:function(a){this._set("suspended",a);this._viewChangeUpdate()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"reduceTileLevelDifferences",
{get:function(){return this._view.qualitySettings.tiledSurface.reduceTileLevelDifferences},enumerable:!0,configurable:!0});c.prototype.intersect=function(a,b,f,c){this._renderer.intersect(a,b,f,c,null)};c.prototype.getElevation=function(a){var b=this._getElevationData.rootTiles;if(!b||!b.length||0===b[0].layerInfo[0].length)return null;var f=C;if(Array.isArray(a))f=a;else if("point"===a.type&&!F.pointToVector(a,f,this._getElevationData.spatialReference))return u.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),
null;for(var c=0;c<b.length;c++)if(a=b[c],a.containsPoint(f)){for(;a&&!a.rendered&&!a.isLeaf;)b=0,f[0]>.5*(a.extent[0]+a.extent[2])&&(b+=1),f[1]<.5*(a.extent[1]+a.extent[3])&&(b+=2),a=a.children[b];if(b=(b=a.renderData)&&b.geometryState?b.geometryState.samplerData:null)return Q.sample(f[0],f[1],b);break}return null};Object.defineProperty(c.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!0,configurable:!0});c.prototype.getScale=function(a){if(this.tilingScheme){if(!F.pointToVector(a,
C,this.spatialReference))return u.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;var b=this.rootTiles;if(b)for(var f=0;f<b.length;f++)if(a=b[f],a.containsPoint(C)){for(;null!=a.children[0];)b=0,C[0]>a.children[0].extent[2]&&(b+=1),C[1]<a.children[0].extent[1]&&(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.level)}}return 1E100};c.prototype.queryVisibleScaleRange=function(a,b,f,c){b=b?this.tilingScheme.levelAtScale(b):0;
f=f?this.tilingScheme.levelAtScale(f):Infinity;var h=this._getLodBias();this._renderer.queryVisibleLevelRange(a,b+h,f+h,c)};c.prototype._updateTilingSchemeAndExtent=function(){var a=this.tilingSchemeLogic.extent,b=a&&!t.equals(a,this._dataExtent);b&&(this._dataExtent?t.set(this._dataExtent,a):this._dataExtent=t.create(a));var a=this.tilingSchemeLogic.tilingScheme,f=a!==this.tilingScheme;f&&(n.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",
a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference,"spherical"===this.manifold)));(b||f)&&this._updateRootTiles()};c.prototype._acquireTile=function(a,b,f,c){var h=this._tilePool.acquire();G[0]=a;G[1]=b;G[2]=f;h.init(G,c,this);return h};c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,f=this.tilingScheme;if(b&&f){this._memCache.clear();var c=Da,k=
f.rootTilesInExtent(b,c,Infinity),e=function(b){b=a._acquireTile(0,b[1],b[2],null);1===b.shouldSplit(a._splitLimits,a._eyePosRenderSR,0)&&b.setPendingUpdate(1);a._loadTile(b);return b};if(this.rootTiles){if(k.length>r.MAX_ROOT_TILES){u.warn(r.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}var b=this.rootTiles.map(function(a){return a.lij}),l=J.difference(b,k,U);if(0<l.removed.length||0<l.added.length){var m=this.rootTiles.filter(function(b){return-1<J.findIndex(l.removed,U.bind(null,b.lij))?(a._purgeTile(b),
!1):!0});l.added.forEach(function(a){return m.push(e(a))});this._setRootTiles(m)}}else k.length>r.MAX_ROOT_TILES&&(u.warn(r.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),k=f.rootTilesInExtent(b,c,r.MAX_ROOT_TILES)),this._setRootTiles(k.map(function(a){return e(a)}));t.equals(c,this._rootExtent)||(this._rootExtent=t.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.visible=!0;this._viewChangeUpdate();this.overlayManager.setOverlayPlacementDirty();this.notifyChange("ready")}};c.prototype._setRootTiles=
function(a){this._set("rootTiles",a);this._getElevationData.rootTiles=a;this._renderer.setRootTiles(this.rootTiles);this._updateTiles(a)};c.prototype._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};c.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._isFrameProcessing?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),
this._updateSkirts(),this.updateOverlayOpacity(),this._updateTiles(this.rootTiles)))};c.prototype._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.resetPendingUpdate(16)&&this._updateTileGeometry(a)};c.prototype._updateTiles=function(a){if(a){var b=this._iteratorPool.acquire();b.reset(a);var f;y.hasVisibleSiblings(a)?(a=this._elevationBounds.min,f=this._elevationBounds.max):(a=Infinity,f=-Infinity);for(;!b.done;){var c=b.next();this._updateClippingStatus(c);c.updateVisibility();
c.setPendingUpdate(8);if(c.visible){c.updateScreenDepth(this._viewProjectionMatrix);c.renderData&&(a=Math.min(c.elevationBounds[0],a),f=Math.max(c.elevationBounds[1],f));var k=c.shouldSplit(this._splitLimits,this._eyePosRenderSR,0);if(1===k){c.resetPendingUpdate(4);c.isLeaf&&(c.setPendingUpdate(1),b.skipSubtree());this._pendingUpdates=this._pendingUpdates||c.updating;continue}c.resetPendingUpdate(1)&&c.updateAgentSuspension();2===k&&c.updateAgents(0)}b.skipSubtree();if(!c.isLeaf){c.setPendingUpdate(4);
c.resetPendingUpdate(1);k=this._iteratorPool.acquire();for(k.resetOne(c);!k.done;){var e=k.next();this._updateClippingStatus(e);e.updateVisibility();e.visible&&e.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(k)}this._pendingUpdates=this._pendingUpdates||c.updating}this._iteratorPool.release(b);isFinite(a)&&isFinite(f)&&(this._elevationBounds.min!==a||this._elevationBounds.max!==f)&&(this._elevationBounds.min=a,this._elevationBounds.max=f,this.emit("elevation-bounds-change",
null))}};c.prototype._updateViewDependentParameters=function(){var a=this._view.state.camera,b=Math.tan(.5*a.fovX),f=Math.tan(.5*a.fovY),c=this.tilingScheme.pixelSize,k=Math.pow(2,-this._getLodBias())*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=b;this._splitLimits.fovY=f;this._splitLimits.relativeWidthLimit=c/a.width*this.maxTextureScale*k;this._splitLimits.relativeHeightLimit=c/a.height*this.maxTextureScale*k;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();
this._splitLimits.angledSplitBias=this._view.qualitySettings.tiledSurface.angledSplitBias;P.frustum.copy(a.frustum,this._frustum);ia.mat4.multiply(this._viewProjectionMatrix,a.projectionMatrix,a.viewMatrix);ka.vec3.copy(this._eyePosRenderSR,a.eye);F.vectorToVector(this._eyePosRenderSR,this._view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};c.prototype._updateSnapLevel=function(){if(this.reduceTileLevelDifferences){var a=E.TESTS_DISABLE_UPDATE_THRESHOLDS?0:.1,b=this._findSnapLevel();
Math.abs(this._snapLevel-b)<a||(a=this._snapLevel,this._snapLevel=b,a!==this._snapLevel&&this._updateTiles(this.rootTiles))}};c.prototype._findSnapLevel=function(){if(0>=this._visibleLevels.length)return this._snapLevel;var a=this._visibleLevels,b=Math.round(a.length*(Math.abs(this._view.camera.tilt-90)/90*.4+.3));if(b>=a.length)return this._snapLevel;a.sort(function(a,b){return a-b});for(var f=0,c=b;c<a.length;++c)f+=a.getItemAt(c);c=a.getItemAt(Math.round(.95*a.length)-1);b=f/(a.length-b);a.clear();
return Math.max(b,c-1)};c.prototype._updateSkirts=function(){n.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,this._view.state.camera.near)};c.prototype._updateRender=function(a){a.rendered&&!a.shouldRender&&(A(a)?this._loadChildren(a):a.isLeaf&&a.parent&&a.parent.shouldRender&&this._loadParent(a))};c.prototype._updateTileGeometry=function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);this._elevationUpdate(a);this._usedMemory=B};c.prototype._elevationUpdate=function(a){H.spatialReference=
this.spatialReference;H.tile=a;H.extent=a.extent;this.emit("elevation-change",H);t.containsPoint(a.extent,this._eyePosSurfaceSR)&&this._updateSkirts()};c.prototype._frame=function(a){var b=this;this._isFrameProcessing=!0;this._frameTraversal(a);a.run(function(){y.sortTiles(b._renderer.renderOrder,b._lowPrioUpdates);return!1});a.run(function(){return b._processElevation(a)});a.run(function(){return b._processTextures(a)});0!==this._asyncWorkItems&&(this._pendingUpdates=!0);this._lowPrioUpdates.clear();
this._isFrameProcessing=!1;this._runViewChangeUpdateIfDirty();this.notifyChange("updating")};c.prototype._frameTraversal=function(a){var b=this;if(!this.suspended&&this._pendingUpdates){this._pendingUpdates=!1;this._lowPrioUpdates.clear();var f=this._iteratorPool.acquire(),c=this._eyePosRenderSR;f.reset(this.rootTiles,c);var k=0,e=!1,l=!1,m=[];this._visibleLevels.clear();for(var d=function(){},p=this.reduceTileLevelDifferences?function(a){a.visible&&1!==a.shouldSplit(b._splitLimits,c,1)&&a.parent&&
1===a.parent.shouldSplit(b._splitLimits,c,1)&&b._visibleLevels.push(a.level)}:d;!f.done&&!a.done;){var g=f.next(),k=k+g.usedMemory;p(g);g.resetPendingUpdate(4)?(this._mergeTile(g),l=!0,a.madeProgress(),f.skipSubtree()):g.resetPendingUpdate(1)&&(this._splitTile(g)&&m.push(g),e=!0,a.madeProgress());g.resetPendingUpdate(8)&&(this._updateRender(g),a.madeProgress());g.hasPendingUpdates&&this._lowPrioUpdates.push(g);this._pendingUpdates=this._pendingUpdates||g.updating;f.done&&(f.reset(m),m.length=0,p!==
d&&(this._updateSnapLevel(),p=d))}this._pendingUpdates=this._pendingUpdates||!f.done||0<this._lowPrioUpdates.length;e||l?this._treeDebugger&&this._treeDebugger.update():f.done&&(this._usedMemory=k);this._iteratorPool.release(f);this._visibleLevels.clear()}};c.prototype._processElevation=function(a){var b=this;this._lowPrioUpdates.some(function(c){if(a.done)return!0;c.resetPendingUpdate(16)&&(b._updateTileGeometry(c),a.madeProgress());return!1});return a.hasProgressed};c.prototype._processTextures=
function(a){var b=this;this._lowPrioUpdates.some(function(c){if(a.done)return!0;c.resetPendingUpdate(32)&&(b._renderer.updateTileTexture(c),b._usedMemory=B,a.madeProgress());return!1});return a.hasProgressed};c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=t.create(),b=null;F.extentToBoundingRect(this._view.clippingArea,a,this.spatialReference)&&(b=a);if(t.equals(b,this._clippingExtent))return!1;this._memCache.clear();this._clippingExtent=b;this._renderer.clippingExtent=
b;this.notifyChange("extent");this.updateTileOverlayParams();this.overlayManager.setOverlayPlacementDirty();return!0};c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};c.prototype._getLodBias=function(){return this._view.qualitySettings.tiledSurface.lodBias-(1-this._view.resourceController.memoryController.memoryFactor)*r.MAX_MEMORY_LOD_BIAS};c.prototype._getLodBiasCorrectedScale=function(a){var b=this.tilingScheme.levels;a=ga.clamp(a-this._getLodBias(),
0,b.length-1);var c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};c.prototype._cancelTilemapRequests=function(a){var b=0;for(a=a.layerInfo;b<a.length;b++){var c=a[b];if(c)for(var h=0;h<c.length;h++)c[h].abortTilemapRequest()}};c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){return a._purgeTile(b)}),this._setRootTiles(null),this.notifyChange("ready"));for(var b=0,c=this._topLevelTilemapOnlyTiles;b<c.length;b++){var h=
c[b];K.isSome(h)&&this._cancelTilemapRequests(h)}this.visible=!1};c.prototype._purgeChildTiles=function(a){if(a.isLeaf)return!1;var b=this._purgeTile(a.children[0]),b=this._purgeTile(a.children[1])||b,b=this._purgeTile(a.children[2])||b,b=this._purgeTile(a.children[3])||b;a.unsetChildren();return b};c.prototype._purgeTile=function(a){var b=this._purgeChildTiles(a)||a.rendered;a.unload(this._renderer);this._cancelTilemapRequests(a);a.dispose();this._tilePool.release(a);return b};c.prototype._splitTile=
function(a){n.weakAssert(a.isLeaf,"tile that is already split should not be split again!");var b=a.level+1,c=2*a.lij[1],h=2*a.lij[2];a.setChildren(this._createTile(b,c,h,a),this._createTile(b,c,h+1,a),this._createTile(b,c+1,h,a),this._createTile(b,c+1,h+1,a));a.setPendingUpdate(8);a.updateAgentSuspension();q.spatialReference=this.spatialReference;q.extent=a.extent;q.scale=this._getLodBiasCorrectedScale(b);this._pendingUpdates=!0;this.emit("scale-change",q);return a.children[0].hasPendingUpdate(1)||
a.children[1].hasPendingUpdate(1)||a.children[2].hasPendingUpdate(1)||a.children[3].hasPendingUpdate(1)};c.prototype._createTile=function(a,b,c,h){n.weakAssert(!!h,"_createTile sanity check");a=this._acquireTile(a,b,c,h);a.updateClippingStatus(this._clippingExtent);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),1===a.shouldSplit(this._splitLimits,this._eyePosRenderSR,0)&&a.setPendingUpdate(1));return a};c.prototype._mergeTile=function(a){n.weakAssert(!a.hasPendingUpdate(1),"_mergeTile sanity check");
this._purgeChildTiles(a)&&(n.weakAssert(!a.renderData,"_mergeTile sanity check"),this._loadTile(a));q.spatialReference=this.spatialReference;q.extent=a.extent;q.scale=this._getLodBiasCorrectedScale(a.level);this._pendingUpdates=!0;this.emit("scale-change",q)};c.prototype._loadChildren=function(a){n.weakAssert(a.rendered,"parent should be rendered");a.unload(this._renderer);this._loadTile(a.children[0]);this._loadTile(a.children[1]);this._loadTile(a.children[2]);this._loadTile(a.children[3])};c.prototype._loadParent=
function(a){a=a.parent;this._unloadChildren(a);this._loadTile(a)};c.prototype._unloadChildren=function(a){a.isLeaf||(this._unloadChildren(a.children[0]),a.children[0].unload(this._renderer),this._unloadChildren(a.children[1]),a.children[1].unload(this._renderer),this._unloadChildren(a.children[2]),a.children[2].unload(this._renderer),this._unloadChildren(a.children[3]),a.children[3].unload(this._renderer))};c.prototype._loadTile=function(a){a.load(this._renderer);a.setPendingUpdate(8);this.overlayManager&&
this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(a,a.renderData,this._overlayOpacity);this._elevationUpdate(a)};c.prototype._handleHasHighlights=function(a){this._renderer.setNeedsHighlight(a)};c.prototype._elevationDataUpdated=function(a,b){var c=a.layerInfo[0][b],h=[a],k=a.level,e=this._iteratorPool.acquire();for(e.reset(h);!e.done;){var l=e.next();l.findElevationBoundsForLayer(b,k);l.computeElevationBounds()}this._iteratorPool.release(e);a.dataArrived(b,0,c.data);this._updateTiles(h)};
c.prototype._scheduleLayerViewChangesUpdate=function(){var a=this;this._scheduledLayerViewChangesHandle||(this._scheduledLayerViewChangesHandle=ha.schedule(function(){return a._handleLayerViewChanges()}),this._handles.add(this._scheduledLayerViewChangesHandle,"scheduledLayerViewChangesHandle"))};c.prototype._handleLayerViewChanges=function(){var a=this;this._handles.remove("scheduledLayerViewChangesHandle");this._scheduledLayerViewChangesHandle=null;for(var b=!1,c=new Set,h=-1,k=0,e=this._view.allLayerViews.items;k<
e.length;k++){var l=e[k];c.add(l.uid);if(n.isTiledLayerView(l))if(this._basemapLayerViewHandles.has(l.uid)){var d=this.layerClassFromLayerView(l),l=this._layerIndexByLayerViewId[d].get(l.uid);l<h&&(b=!0);h=l}else this._registerTiledLayerView(l),l.layer.loaded&&(b=!0)}this._basemapLayerViewHandles.forEach(function(f,e){c.has(e)||(a._unregisterTiledLayerView(e),b=!0)});this.overlayManager&&this.overlayManager.updateLayerViews(c);b&&this._updateTiledLayers()};c.prototype.layerClassFromLayerView=function(a){return n.isElevationLayerView(a)?
0:1};c.prototype._registerTiledLayerView=function(a){var b=this,c=[],h=this.layerClassFromLayerView(a);c.push(a.watch("suspended",function(){return b._updateTiledLayers()}));c.push(a.watch("fullOpacity",function(){return b._updateTileTextures(!1)}));c.push(a.layer.watch("scaleRangeId",function(){return b._restartAllAgents(h)}));a.on("data-changed",function(){var c=b._layerIndexByLayerViewId[h].get(a.uid);null!=c&&b._invalidateLayerData(c,h)});this._basemapLayerViewHandles.set(a.uid,c)};c.prototype._unregisterTiledLayerView=
function(a){var b=this._basemapLayerViewHandles.get(a);if(b){for(var c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};c.prototype._updateTiledLayers=function(){var a=this;if(this.tilingScheme&&!this._view.suspended){var b=this._view.allLayerViews,c=[[],[]],h=null,k=t.empty();b.forEach(function(b){var f=b.layer;if(f&&!b.suspended&&n.isTiledLayerView(b)){var e=b.fullExtent;e?a.tilingScheme.compatibleWith(b.tileInfo)?(t.expand(k,e),f=a.layerClassFromLayerView(b),1===f&&(e=b.displayLevelRange,
Infinity!==e.maxLevel&&(null===h||e.maxLevel>h)&&(h=e.maxLevel)),c[f].push(b)):u.warn("Terrain: tiling scheme of layer "+f.id+" is incompatible with other tiled layers, will not be drawn"):u.warn("Terrain: Map or elevation layer does not have fullExtent: "+f.id)}});for(b=0;2>b;b++){var e=this._layerViews[b],d=c[b];d.reverse();var m=d.length,g=e.length!==m,p=Array(m),r=Array(e.length);this._layerIndexByLayerViewId[b].clear();for(var v=0;v<m;v++){this._layerIndexByLayerViewId[b].set(d[v].uid,v);var q=
e.indexOf(d[v]);p[v]=q;v!==q&&(g=!0);-1<q&&(r[q]=v)}if(g){e=0;for(m=this._topLevelTilemapOnlyTiles;e<m.length;e++)g=m[e],K.isSome(g)&&g.modifyLayers(r,p,b);e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(r,p,b);this._layerViews[b]=d;0===b&&this._memCache.clear();this._restartAllAgents(b);this._updateTiles(this.rootTiles)}}this.tilingScheme.ensureMaxLod(h)&&this._viewChangeUpdate()}};c.prototype._restartAllAgents=function(a){var b=this._postorderIterator;for(b.reset(this.rootTiles);!b.done;){var c=
b.next();c.restartAgents(a);0===a&&c.computeElevationBounds()}};c.prototype._hasFixedExtent=function(){return!!this._clippingExtent};c.prototype.layerViewByIndex=function(a,b){return this._layerViews[b][a]};c.prototype.numLayers=function(a){return this._layerViews[a].length};c.prototype._updateTileTextures=function(a){var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.updateAgents(1);a?this.renderer.updateTileTexture(c):c.updateRenderData(1)}this._iteratorPool.release(b)};
c.prototype._invalidateLayerData=function(a,b){var c=this._iteratorPool.acquire();for(c.reset(this.rootTiles);!c.done;)c.next().removeLayerAgent(a,b);for(c.reset(this.rootTiles);!c.done;)c.next().invalidateLayerData(a,b);this._iteratorPool.release(c);0===b&&this._memCache.clear()};c.prototype.requestRender=function(a){void 0===a&&(a=1);this.renderer.setNeedsRender(a)};c.prototype.setPendingUpdates=function(){this._pendingUpdates||(this._pendingUpdates=!0,this.notifyChange("updating"))};c.prototype.requestTileData=
function(a,b,c,h){var f=this,e=this.layerViewByIndex(b,c),d=e.layer;if(d.tilemapCache&&!n.isVectorTileLayerView(e)){var m=this.getTilemapTile(a),g=m.layerInfo[c][b];if(g.tilemap){if(!m.hasDataAvailable(a,b,c))return this._dispatchDataEvent(a,"dataMissing",c,e,{notInTilemap:!0}),w.reject()}else return g.tilemapRequestPromise||(g.tilemapRequestAbort=w.createAbortController(),g.tilemapRequestPromise=this.requestTilemap(m,b,c,e,d,{signal:g.tilemapRequestAbort.signal})),++this._asyncWorkItems,g.tilemapRequestPromise.catch(function(){}).then(function(){--f._asyncWorkItems;
g.tilemapRequestPromise=null;g.tilemapRequestAbort=null;w.throwIfAborted(h);var b=f._layerIndexByLayerViewId[c].get(e.uid);if(null!=b){if(m.hasDataAvailable(a,b,c))return f._requestTileData(a,b,c,e,h);f._dispatchDataEvent(a,"dataMissing",c,e,{notInTilemap:!0});return w.reject()}})}return this._requestTileData(a,b,c,e,h)};c.prototype._requestTileData=function(a,b,c,h,d){return 0===c?this._requestElevationTileData(a,b,c,h,d):this._requestMapTileData(a,c,h,d)};c.prototype._requestElevationTileData=function(a,
b,c,h,d){var f=this;if(n.isElevationLayerView(h)){var g=function(e){--f._asyncWorkItems;var d=f._layerIndexByLayerViewId[c].get(h.uid);null==d?u.warn("TerrainSurface: received data from unknown layer %d %s",c,a.lij.toString()):(f._usedMemory=B,f._pendingUpdates=!0,a.layerInfo[c][d].data=Q.create(a.lij,a.extent,e),f._elevationDataUpdated(a,b))},k=function(b){--f._asyncWorkItems;w.isAbortError(b)||f._dispatchDataEvent(a,"dataMissing",c,h,b)};++this._asyncWorkItems;if(n.useFetchTileForLayer(h.layer))return h.layer.fetchTile(a.lij[0],
a.lij[1],a.lij[2],{noDataValue:r.ELEVATION_NODATA_VALUE,signal:d.signal}).then(function(a){return g(a)},k);var q=h.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._streamDataRequester.request(q,"binary",d).then(function(a){return f._lercWorker.decode(a,{noDataValue:r.ELEVATION_NODATA_VALUE},d.signal)}).then(function(a){g({values:a.pixelData,width:a.width,height:a.height,noDataValue:a.noDataValue,minValue:a.minValue,maxValue:a.maxValue})}).catch(function(a){return k(a)})}n.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")};
c.prototype._requestMapTileData=function(a,b,c,h){var f=this;++this._asyncWorkItems;var e=function(e){--f._asyncWorkItems;f._dispatchDataEvent(a,"dataArrived",b,c,e)},d=function(e){--f._asyncWorkItems;w.isAbortError(e)||f._dispatchDataEvent(a,"dataMissing",b,c,e)};if(n.isVectorTileLayerView(c)){var g=c.tileHandler,q=c.schemaHelper.getLevelRowColumn(a.lij);return ba.safeCast(g.getVectorTile(q[0],q[1],q[2])).then(function(a){w.isAborted(h)?--f._asyncWorkItems:e(a)},d)}if(n.useFetchTileForLayer(c.layer)&&
n.isTileLayerView(c))return c.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],h).then(e,d);g=c.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);null!=c.refreshInterval&&c.refreshTimestamp&&(g+=(-1<g.indexOf("?")?"\x26":"?")+"_ts\x3d"+c.refreshTimestamp);return this._streamDataRequester.request(g,"image",h).then(e,d)};c.prototype.requestTilemap=function(a,b,c,d,g,e){var f=this;return g.tilemapCache.fetchTilemap(a.lij[0]+x.TILEMAP_SIZE_EXP,Math.round(a.lij[1]*Math.pow(2,x.TILEMAP_SIZE_EXP)),Math.round(a.lij[2]*Math.pow(2,
x.TILEMAP_SIZE_EXP)),X({},e,{timeout:6E3})).then(function(e){b=f._layerIndexByLayerViewId[c].get(d.uid);null!=b&&(a.layerInfo[c][b].tilemap=e)}).catch(function(a){})};c.prototype.getTilemapTile=function(a){var b=a.level;if(b>x.TILEMAP_SIZE_EXP)return y.getTileNLevelsUp(a,x.TILEMAP_SIZE_EXP);var c=this._topLevelTilemapOnlyTiles[b];if(K.isSome(c))return c;a=y.getRootTile(a);c=x.TILEMAP_SIZE_EXP-b+a.level;c=new wa([b-x.TILEMAP_SIZE_EXP,a.lij[1]/Math.pow(2,c),a.lij[2]/Math.pow(2,c)],this._upsampleInfoPool,
[this._layerViews[0].length,this._layerViews[1].length]);return this._topLevelTilemapOnlyTiles[b]=c};c.prototype._dispatchDataEvent=function(a,b,c,d,g){d=this._layerIndexByLayerViewId[c].get(d.uid);if(null!=d)a[b](d,c,g);else u.warn("TerrainSurface: received data from unknown layer")};c.prototype.updateTileOverlayParams=function(){if(this.rootTiles){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(b,
b.renderData,this._overlayOpacity)}this._iteratorPool.release(a);this._renderer.setNeedsRender()}};c.prototype.updateOverlayOpacity=function(){if(this.overlayManager){var a=this.overlayManager.updateOpacity(this._eyePosSurfaceSR[2]);if(!isNaN(a)&&a!==this._overlayOpacity){var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.renderData&&(c.renderData.overlayOpacity=a)}this._iteratorPool.release(b);this._overlayOpacity=a;this._renderer.setNeedsRender()}}};c.prototype.getStats=
function(){var a={numNodes:0,numLeaves:0,numVisible:0,numRendered:0,numVisiblePerLevel:[],numLoadedPerLevel:[]},b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();a.numNodes++;c.isLeaf&&a.numLeaves++;var d=c.level;c.rendered&&(a.numRendered++,a.numLoadedPerLevel[d]=(a.numLoadedPerLevel[d]||0)+1);c.visible&&(a.numVisible++,a.numVisiblePerLevel[d]=(a.numVisiblePerLevel[d]||0)+1)}this._iteratorPool.release(b);return a};c.prototype.getUsedMemory=function(){if(!this.tilingScheme)return 0;
if(this._usedMemory===B){var a=this._iteratorPool.acquire();a.reset(this.rootTiles);for(this._usedMemory=0;!a.done;){var b=a.next();this._usedMemory+=b.usedMemory}this._iteratorPool.release(a)}return this._usedMemory};c.prototype.getMemoryUsage=function(){if(!this.tilingScheme)return{};var a=0,b=0,c=0,d=this._iteratorPool.acquire();d.reset(this.rootTiles);for(var g=this.tilingScheme.pixelSize,g=g*g*4;!d.done;){for(var e=d.next(),l=V(e),m=0,q=e.layerInfo[1];m<q.length;m++){var p=q[m],p=p.data,n=0,
r=0;p instanceof za?n+=T.getGpuMemoryUsage(p):p instanceof HTMLImageElement?r+=g:p instanceof ma&&(c+=p.getMemoryUsage());e.renderData||l?(a+=r,a+=n):(b+=r,b+=n)}l=0;for(m=e.layerInfo[0];l<m.length;l++)p=m[l],p=p.data,a+=p?g:0;e.renderData&&(p=e.renderData.textureDescriptor,a+=p?T.getGpuMemoryUsage(p):0,e=e.renderData.estimatedGeometryMemoryUsage,c+=e,c+=e)}this._iteratorPool.release(d);return{visibleImageData:a,invisibleImageData:b,geometryData:c}};c.prototype.getTile=function(a){var b=a.split("/").map(function(a){return+a});
if(0===b[0])return J.find(this.rootTiles,function(a){return a.lij[1]===b[1]&&a.lij[2]===b[2]});var c=Math.pow(2,b[0]),d=Math.floor(b[1]/c),g=Math.floor(b[2]/c),e;this.rootTiles.some(function(a){return a.lij[1]===d&&a.lij[2]===g?(e=a,!0):!1});if(e){for(c=1<<b[0]-1;e.lij[0]<b[0];){var l=b[1]&c?2:0;0<(b[2]&c)&&l++;if(!e.children[l])return console.log("Tile "+a+" doesn't exist, smallest ancestor is "+y.tile2str(e)),null;e=e.children[l];c>>=1}n.weakAssert(e.lij[0]===b[0]&&e.lij[1]===b[1]&&e.lij[2]===b[2],
"not the right tile?");return e}return null};c.prototype.setBorders=function(a){this._renderer.renderPatchBorders=a};c.prototype.setDisableRendering=function(a){this._renderer.renderingDisabled=a};c.prototype.getRenderedTiles=function(){I.clear();var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.visible&&b.rendered&&I.push(b)}this._iteratorPool.release(a);y.sortTiles(this.renderOrder,I);return I.toArray()};Object.defineProperty(c.prototype,"test",{get:function(){var a=
this;return{renderer:this._renderer,lercWorker:this._lercWorker,mergeTile:function(b){return a._mergeTile(b)},updateTiles:function(b){return a._updateTiles(b)}}},enumerable:!0,configurable:!0});g([d.property()],c.prototype,"_renderer",void 0);g([d.property({value:!1})],c.prototype,"cullBackFaces",null);g([d.property({readOnly:!0})],c.prototype,"extent",null);g([d.property({readOnly:!0,dependsOn:["ready","_renderer.updating","_scheduledLayerViewChangesHandle"]})],c.prototype,"updating",null);g([d.property({value:1})],
c.prototype,"baseOpacity",null);g([d.property({readOnly:!0})],c.prototype,"overlayManager",void 0);g([d.property({readOnly:!0})],c.prototype,"manifold",void 0);g([d.property()],c.prototype,"maxTextureScale",void 0);g([d.property({readOnly:!0})],c.prototype,"ready",null);g([d.property({value:1})],c.prototype,"renderOrder",null);g([d.property({readOnly:!0})],c.prototype,"rootTiles",void 0);g([d.property({value:!0})],c.prototype,"skirtScale",null);g([d.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],
c.prototype,"spatialReference",null);g([d.property({})],c.prototype,"backgroundImage",void 0);g([d.property({type:Z})],c.prototype,"backgroundColor",void 0);g([d.property({dependsOn:["backgroundColor","backgroundImage"]})],c.prototype,"_background",null);g([d.property({value:!1})],c.prototype,"slicePlaneEnabled",null);g([d.property({readOnly:!0})],c.prototype,"tilingScheme",void 0);g([d.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0);
g([d.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],c.prototype,"tilingSchemeDone",void 0);g([d.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0);g([d.property({value:!0})],c.prototype,"velvetOverground",null);g([d.property({value:!1})],c.prototype,"wireframe",null);g([d.property({value:!1})],c.prototype,"suspended",null);g([d.property()],c.prototype,"_scheduledLayerViewChangesHandle",void 0);return c=g([d.subclass("esri.views.3d.terrain.TerrainSurface")],c)}(d.declared(da.EventedMixin(aa)));
var Aa=1.2,Ba=80/180*Math.PI,Ca=110/180*Math.PI,B=-1,C=la.vec4f64.create(),Da=t.create(),G=[0,0,0],I=new L,H={spatialReference:null,tile:null,extent:null,context:"ground"},q={spatialReference:null,extent:null,scale:0};return z});