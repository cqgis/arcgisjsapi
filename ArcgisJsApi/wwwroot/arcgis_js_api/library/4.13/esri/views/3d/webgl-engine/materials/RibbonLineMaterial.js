// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/Logger ../../../../core/mathUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/MaterialUtil ./renderers/InstancedRenderer ./renderers/MergedRenderer ../shaders/RibbonLinePrograms ../../../webgl/renderState".split(" "),
function(O,ra,H,V,W,X,F,Y,h,m,k,Z,aa,P,ba,I,ca,x,da,ea,d,B){function Q(d,a){a.vvSizeEnabled&&(d.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),d.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),d.setUniform3fv("vvSizeOffset",a.vvSizeOffset),d.setUniform3fv("vvSizeFactor",a.vvSizeFactor));a.vvColorEnabled&&(d.setUniform1fv("vvColorValues",a.vvColorValues),d.setUniform4fv("vvColorColors",a.vvColorColors));a.vvOpacityEnabled&&(d.setUniform1fv("vvOpacityValues",a.vvOpacityValues),d.setUniform1fv("vvOpacityOpacities",
a.vvOpacityOpacities))}var fa=W.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");O=function(m){function a(b,c){c=m.call(this,c)||this;c.params=x.copyParameters(b,ga);"miter"!==c.params.join&&(c.params.miterLimit=0);c.params.transparent=1>c.params.color[3]||c.params.transparent;c.canBeMerged=null==c.params.stippleLength;c.layout=c.createLayout();return c}H(a,m);a.prototype.dispose=function(){};a.prototype.setParameterValues=function(b){for(var c in b)I.assert("cap"!==c,"RibbonLineMaterial: cap cannot be changed after creation"),
I.assert("stippleLength"!==c||null!=b[c]===(null!=this.params[c]),"RibbonLineMaterial: stippleLength on/off cannot be changed after creation"),this.params[c]=b[c];"miter"!==this.params.join&&(this.params.miterLimit=0);this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(b,c,a,d,e,l,f,h,k){k?x.intersectDrapedRenderLineGeometry(b,c,a,d,e,l,this.params.width,f):this.intersectLineGeometry(b,c,a,d,e,l,this.params.width,f)};a.prototype.intersectLineGeometry=
function(b,c,a,D,e,l,f,m,q){if(D.enable.selectionMode&&!aa.isAllHidden(c.componentVisibilities,b.componentOffsets))if(I.isTranslationMatrix(a)){c=b.data.getVertexAttr();b=c[d.VertexAttrConstants.POSITION].data;this.params.vvSizeEnabled?f*=X.clamp(this.params.vvSizeOffset[0]+c[d.VertexAttrConstants.SIZEFEATUREATTRIBUTE].data[0]*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]):c[d.VertexAttrConstants.SIZE]&&(f*=c[d.VertexAttrConstants.SIZE].data[0]);e=D.camera;
l=ha;Y.vec2.copy(l,D.point);f=f*e.pixelRatio/2+4*e.pixelRatio;h.vec3.set(G[0],l[0]-f,l[1]+f,0);h.vec3.set(G[1],l[0]+f,l[1]+f,0);h.vec3.set(G[2],l[0]+f,l[1]-f,0);h.vec3.set(G[3],l[0]-f,l[1]-f,0);for(q=0;4>q;q++)e.unprojectPoint(G[q],y[q]);k.plane.fromPoints(e.eye,y[0],y[1],K);k.plane.fromPoints(e.eye,y[1],y[2],L);k.plane.fromPoints(e.eye,y[2],y[3],M);k.plane.fromPoints(e.eye,y[3],y[0],N);c=Number.MAX_VALUE;for(q=0;q<b.length-5;q+=3)if(r[0]=b[q]+a[12],r[1]=b[q+1]+a[13],r[2]=b[q+2]+a[14],t[0]=b[q+3]+
a[12],t[1]=b[q+4]+a[13],t[2]=b[q+5]+a[14],!(0>k.plane.signedDistance(K,r)&&0>k.plane.signedDistance(K,t)||0>k.plane.signedDistance(L,r)&&0>k.plane.signedDistance(L,t)||0>k.plane.signedDistance(M,r)&&0>k.plane.signedDistance(M,t)||0>k.plane.signedDistance(N,r)&&0>k.plane.signedDistance(N,t))){e.projectPoint(r,C);e.projectPoint(t,A);if(0>C[2]&&0<A[2]){h.vec3.subtract(u,r,t);var g=e.frustum,J=-k.plane.signedDistance(g.planes[4],r),g=J/h.vec3.dot(u,g.planes[4]);h.vec3.scale(u,u,g);h.vec3.add(r,r,u);e.projectPoint(r,
C)}else if(0<C[2]&&0>A[2])h.vec3.subtract(u,t,r),g=e.frustum,J=-k.plane.signedDistance(g.planes[4],t),g=J/h.vec3.dot(u,g.planes[4]),h.vec3.scale(u,u,g),h.vec3.add(t,t,u),e.projectPoint(t,A);else if(0>C[2]&&0>A[2])continue;C[2]=0;A[2]=0;g=k.lineSegment.distance2(k.lineSegment.fromPoints(C,A,R),l);g<c&&(c=g,h.vec3.copy(S,r),h.vec3.copy(T,t))}a=D.rayBeginPoint;D=D.rayEndPoint;c<f*f&&(b=Number.MAX_VALUE,k.lineSegment.closestLineSegmentPoint(k.lineSegment.fromPoints(S,T,R),k.lineSegment.fromPoints(a,D,
ia),E)&&(h.vec3.subtract(E,E,a),b=h.vec3.length(E),h.vec3.scale(E,E,1/b),b/=h.vec3.distance(a,D)),m(b,E))}else fa.error("intersection assumes a translation-only matrix")};a.prototype.createLayout=function(){var b=Z.newLayout().vec3f(d.VertexAttrConstants.POSITION).f32(d.VertexAttrConstants.SUBDIVISIONFACTOR).vec2f(d.VertexAttrConstants.UV0).vec3f(d.VertexAttrConstants.AUXPOS1).vec3f(d.VertexAttrConstants.AUXPOS2);this.params.vvSizeEnabled?b.f32(d.VertexAttrConstants.SIZEFEATUREATTRIBUTE):b.f32(d.VertexAttrConstants.SIZE);
this.params.vvColorEnabled?b.f32(d.VertexAttrConstants.COLORFEATUREATTRIBUTE):b.vec4f(d.VertexAttrConstants.COLOR);this.params.vvOpacityEnabled&&b.f32(d.VertexAttrConstants.OPACITYFEATUREATTRIBUTE);return b};a.prototype.createBufferWriter=function(){return new ja(this.layout,this.params)};a.prototype.createRenderer=function(b,a){return this.canBeMerged?new ea(b,a,this,d.vertexAttributeLocations):new da(b,a,this,d.vertexAttributeLocations)};a.prototype.getGLMaterials=function(){return{color:ka,depthShadowMap:void 0,
normal:void 0,depth:void 0,highlight:la}};return a}(ba.Material);var ka=function(h){function a(b){b=h.call(this,b)||this;b.updateParameters();return b}H(a,h);a.prototype.updateParameters=function(){this.params=x.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.beginSlot=function(b){return b===(this.params.writeDepth?7:10)};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(d.colorPass,
{stipple:null!=b.stippleLength,slice:b.slicePlaneEnabled,join:b.join,cap:b.cap,vvSize:b.vvSizeEnabled,vvColor:b.vvColorEnabled,vvOpacity:b.vvOpacityEnabled});this.pipelineState=B.makePipelineState({blending:B.separateBlendingParams(770,1,771,771),polygonOffset:b.polygonOffset&&U,depthTest:{func:513},depthWrite:!b.transparent&&b.writeDepth&&B.defaultDepthWriteParams,colorWrite:B.defaultColorWriteParams})};a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);
c.setUniform1f("symbolLineWidth",d.width);c.setUniform4fv("symbolColor",d.color);c.setUniform1f("miterLimit",d.miterLimit);c.setUniform1f("nearPlane",a.nearFar[0]);c.setUniform1f("pixelRatio",a.pixelRatio);c.setUniform2fv("screenSize",[a.viewport[2],a.viewport[3]]);null!=d.stippleLength&&c.setUniform1f("stippleLengthDoubleInv",d.stippleLength?1/(2*d.stippleLength):0);Q(c,d)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params;x.bindView(a.origin,a.view,
b);c.slicePlaneEnabled&&x.bindSlicePlane(a.origin,a.slicePlane,b)};a.prototype.bindInstance=function(b,a){this.program.setUniformMatrix4fv("model",a.transformation)};a.prototype.getDrawMode=function(){return 5};return a}(P),la=function(h){function a(b){b=h.call(this,b)||this;b.updateParameters();return b}H(a,h);a.prototype.updateParameters=function(){this.params=x.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.beginSlot=function(b){return 5===b};a.prototype.getProgram=
function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(d.highlightPass,{stipple:null!=b.stippleLength,slice:b.slicePlaneEnabled,join:b.join,cap:b.cap,vvSize:b.vvSizeEnabled,vvColor:b.vvColorEnabled,vvOpacity:b.vvOpacityEnabled});this.pipelineState=B.makePipelineState({polygonOffset:b.polygonOffset&&U,depthTest:{func:513},depthWrite:!b.transparent&&b.writeDepth&&B.defaultDepthWriteParams,colorWrite:B.defaultColorWriteParams})};
a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);x.bindHighlightRendering(b,a,c);c.setUniform1f("symbolLineWidth",d.width);c.setUniform4fv("symbolColor",d.color);c.setUniform1f("miterLimit",d.miterLimit);c.setUniform1f("nearPlane",a.nearFar[0]);c.setUniform1f("pixelRatio",a.pixelRatio);c.setUniform2fv("screenSize",[a.viewport[2],a.viewport[3]]);null!=d.stippleLength&&c.setUniform1f("stippleLengthDoubleInv",d.stippleLength?1/(2*
d.stippleLength):0);Q(c,d)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params;x.bindView(a.origin,a.view,b);c.slicePlaneEnabled&&x.bindSlicePlane(a.origin,a.slicePlane,b)};a.prototype.bindInstance=function(b,a){this.program.setUniformMatrix4fv("model",a.transformation)};a.prototype.getDrawMode=function(){return 5};return a}(P),ga=V({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stippleLength:null,slicePlaneEnabled:!1,
vvFastUpdate:!1,transparent:!1},ca.Default),ja=function(){function k(a,b){this.parms=b;this.numJoinSubdivisions=this.numCapSubdivisions=0;this.canBeMerged=!1;this.vertexBufferLayout=a;this.canBeMerged=null==this.parms.stippleLength;switch(this.parms.cap){case "butt":this.numCapSubdivisions=0;break;case "square":this.numCapSubdivisions=1;break;case "round":this.numCapSubdivisions=ma}switch(this.parms.join){case "miter":case "bevel":this.numJoinSubdivisions=0;break;case "round":this.numJoinSubdivisions=
na}}k.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};k.prototype.elementCount=function(a){var b=a.indices[d.VertexAttrConstants.POSITION].length/2+1,c=2*(2*this.numCapSubdivisions+2);if(a.vertexAttr[d.VertexAttrConstants.SUBDIVISIONS]){a=a.vertexAttr[d.VertexAttrConstants.SUBDIVISIONS].data;for(var g=1;g<b-1;++g)c+=4+2*a[g]}else c+=(b-2)*(2*this.numJoinSubdivisions+4);this.canBeMerged&&(c+=2);return c};k.prototype.write=function(a,b,c,g){var k=this,e=oa,l=pa,f=qa,m=
b.vertexAttr[d.VertexAttrConstants.POSITION].data,q=b.indices&&b.indices[d.VertexAttrConstants.POSITION];q&&q.length!==2*(m.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");q=null;b.vertexAttr[d.VertexAttrConstants.SUBDIVISIONS]&&(q=b.vertexAttr[d.VertexAttrConstants.SUBDIVISIONS].data);var r=1,t=0;this.parms.vvSizeEnabled?t=b.vertexAttr[d.VertexAttrConstants.SIZEFEATUREATTRIBUTE].data[0]:b.vertexAttr[d.VertexAttrConstants.SIZE]&&(r=b.vertexAttr[d.VertexAttrConstants.SIZE].data[0]);
var u=[1,1,1,1],x=0;this.parms.vvColorEnabled?x=b.vertexAttr[d.VertexAttrConstants.COLORFEATUREATTRIBUTE].data[0]:b.vertexAttr[d.VertexAttrConstants.COLOR]&&(u=b.vertexAttr[d.VertexAttrConstants.COLOR].data);var y=0;this.parms.vvOpacityEnabled&&(y=b.vertexAttr[d.VertexAttrConstants.OPACITYFEATUREATTRIBUTE].data[0]);b=m.length/3;a=a.transformation;var n=new Float32Array(c.buffer),v=0;c=this.vertexBufferLayout.stride/4;var p=g*c,B=p,w=function(a,b,c,d,e,f){n[p++]=b[0];n[p++]=b[1];n[p++]=b[2];n[p++]=
d;n[p++]=e;n[p++]=f;n[p++]=a[0];n[p++]=a[1];n[p++]=a[2];n[p++]=c[0];n[p++]=c[1];n[p++]=c[2];k.parms.vvSizeEnabled?n[p++]=t:n[p++]=r;k.parms.vvColorEnabled?n[p++]=x:(n[p++]=u[0],n[p++]=u[1],n[p++]=u[2],n[p++]=u[3]);k.parms.vvOpacityEnabled&&(n[p++]=y)};this.canBeMerged&&(p+=c);h.vec3.set(e,m[0],m[1],m[2]);a&&h.vec3.transformMat4(e,e,a);h.vec3.set(f,m[3],m[4],m[5]);a&&h.vec3.transformMat4(f,f,a);h.vec3.copy(l,e);for(g=0;g<this.numCapSubdivisions;++g){var z=1-g/this.numCapSubdivisions;w(e,l,f,z,v,-4);
w(e,l,f,z,v,4)}w(e,l,f,0,v,-4);w(e,l,f,0,v,4);h.vec3.copy(e,l);h.vec3.copy(l,f);for(g=1;g<b-1;g++){z=3*g;h.vec3.set(f,m[z+3],m[z+4],m[z+5]);a&&h.vec3.transformMat4(f,f,a);v+=h.vec3.distance(e,l);w(e,l,f,0,v,-1);w(e,l,f,0,v,1);for(var C=q?q[g]:this.numJoinSubdivisions,A=0;A<C;++A)z=(A+1)/(C+1),w(e,l,f,z,v,-2),w(e,l,f,z,v,2);w(e,l,f,1,v,-2);w(e,l,f,1,v,2);h.vec3.copy(e,l);h.vec3.copy(l,f)}v+=h.vec3.distance(e,l);w(e,l,f,0,v,-5);w(e,l,f,0,v,5);for(g=0;g<this.numCapSubdivisions;++g)z=(g+1)/this.numCapSubdivisions,
w(e,l,f,z,v,-5),w(e,l,f,z,v,5);if(this.canBeMerged){for(g=B;g<B+c;g++)n[g]=n[g+c];e=p-c;for(g=0;g<c;g++)n[p++]=n[e++]}};return k}(),U={factor:0,units:-4},ma=3,na=1,r=m.vec3f64.create(),t=m.vec3f64.create(),u=m.vec3f64.create(),E=m.vec3f64.create(),ha=m.vec3f64.create(),C=F.createRenderScreenPointArray3(),A=F.createRenderScreenPointArray3(),S=m.vec3f64.create(),T=m.vec3f64.create(),R=k.lineSegment.create(),ia=k.lineSegment.create(),oa=m.vec3f64.create(),pa=m.vec3f64.create(),qa=m.vec3f64.create(),
G=[F.createRenderScreenPointArray3(),F.createRenderScreenPointArray3(),F.createRenderScreenPointArray3(),F.createRenderScreenPointArray3()],y=[m.vec3f64.create(),m.vec3f64.create(),m.vec3f64.create(),m.vec3f64.create()],K=k.plane.create(),L=k.plane.create(),M=k.plane.create(),N=k.plane.create();return O});