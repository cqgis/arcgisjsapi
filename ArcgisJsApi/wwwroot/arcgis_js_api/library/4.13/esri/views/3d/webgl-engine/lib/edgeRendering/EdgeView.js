// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/arrayUtils ../../../../../core/mathUtils ../../../../../core/promiseUtils ../../../../../core/requireUtils ../../../../../core/typedArrayUtil ../../../../../core/workers ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../support/buffer/BufferView ../../../support/buffer/utils ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../PreinterleavedGeometryData ../TextureBackedBuffer/BufferManager ./bufferLayouts ./edgeBufferWriters ./EdgeProcessingWorker ./EdgeRenderer ./strokes ./util ../../../../webgl/BufferObject ../../../../webgl/renderState ../../../../webgl/VertexArrayObject module".split(" "),
function(R,H,J,n,B,S,K,L,T,M,U,I,G,N,V,W,X,Y,Z,O,aa,A,P,ba,x,ca,t,E,u,Q,da){Object.defineProperty(H,"__esModule",{value:!0});J=function(){function d(a,c,b){this.rctx=a;this.programRepository=c;this.callbacks=b;this.profilingCallback=null;this.perObjectData=new Map;this.renderers=new Map;this.localOrigins=new Z.LocalOriginManager(new X);this.gpuMemoryUsage=this.numberOfRenderedEdges=0;this.worker=new ba;this.workerThread=null;this.destroyed=!1;this.tmpModelPosition=N.vec3f64.create();this.tmpCameraPosition=
N.vec3f64.create();this.componentColorManager=new aa.BufferManager(this.rctx,2)}d.prototype.initialize=function(){var a=this;U.open(T.getAbsMid("./EdgeProcessingWorker",R,da)).then(function(b){a.destroyed?b.close():a.workerThread=b});for(var c=A.VertexLayout.createBuffer(4),b=0;4>b;b++)c.sideness.set(b,0,0===b||3===b?0:1),c.sideness.set(b,1,0===b||1===b?0:1);this.verticesBufferObject=E.createVertex(this.rctx,35044,c.buffer);this.pipelineState=(c=this.rctx.capabilities.blendMinMax)?u.makePipelineState({blending:u.separateBlendingParams(1,
1,0,1,32774,c.MAX),depthTest:{func:515},colorWrite:u.defaultColorWriteParams}):u.makePipelineState({depthTest:{func:515},depthWrite:u.defaultDepthWriteParams,colorWrite:u.defaultColorWriteParams})};d.prototype.destroy=function(){this.destroyed||(this.workerThread&&(this.workerThread.close(),this.workerThread=null),this.verticesBufferObject&&(this.verticesBufferObject.dispose(),this.verticesBufferObject=null),this.destroyed=!0)};d.prototype.getUsedMemory=function(){return this.gpuMemoryUsage};Object.defineProperty(d.prototype,
"numberOfRenderedPrimitives",{get:function(){return this.numberOfRenderedEdges},enumerable:!0,configurable:!0});d.prototype.shouldRender=function(){return 0<this.renderers.size};d.prototype.addObject=function(a,c,b,e,k){return n(this,void 0,void 0,function(){var f,d,m,g,h,p,q;return B(this,function(l){switch(l.label){case 0:if(this.hasObject(a))return[2];f=[];m={loaded:L.create(function(a){return d=a}),renderables:[]};this.perObjectData.set(a,m);if(k&&k.mergeGeometries&&1<a.geometries.length&&this.canMergeGeometries(a))f.push(this.addObjectMergedGeometries(a,
m,c,b));else for(g=0;g<a.geometries.length;g++)h=a.geometries[g],p=a.geometryRecords[g],q=p.material,q.supportsEdges&&(h.data instanceof O?f.push(this.addGeometryPreinterleaved(a,m,h.data,p,c,b,e)):f.push(this.addGeometryNonPreinterleaved(a,m,h.data,p,c[0],b,e)));return[4,L.all(f)];case 1:return l.sent(),this.callbacks.setNeedsRender(),d(),[2]}})})};d.prototype.hasObject=function(a){return this.perObjectData.has(a)};d.prototype.updateAllComponentOpacities=function(a,c){return n(this,void 0,void 0,
function(){var b,e,k=this;return B(this,function(f){switch(f.label){case 0:return b=c instanceof Array?function(a){return c[a]}:function(){return c},[4,this.getObjectEntry(a)];case 1:return e=f.sent(),e.renderables.forEach(function(a){for(var c=a.components.meta.length,e=0;e<c;e++){var h=b(e),f=a.components.meta[e],d=f.index;f.material.opacity=h;a.components.buffer.textureBuffer.setDataElement(d,1,3,255*h)}k.updateTransparency(a)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateAllComponentMaterials=
function(a,c,b,e){return n(this,void 0,void 0,function(){var k,f,d,m,g=this;return B(this,function(h){switch(h.label){case 0:return k=!!b.slicePlaneEnabled,f=t.determineRendererType(c),d=x.EdgeRenderer.getKey(f,k),[4,this.getObjectEntry(a)];case 1:return m=h.sent(),m.renderables.forEach(function(a){if(d!==a.rendererKey){var b=g.renderers.get(a.rendererKey),h=g.acquireRenderer(f,k);b.removeRenderable(a);b.refCount.decrement();a.rendererKey=d;h.addRenderable(a)}for(b=0;b<c.length;b++)a.components.meta[b].material=
c[b];e&&g.updateComponentBuffer(a.components);g.updateTransparency(a)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateObjectVisibility=function(a,c){return n(this,void 0,void 0,function(){var b;return B(this,function(e){switch(e.label){case 0:return[4,this.getObjectEntry(a)];case 1:return b=e.sent(),b.renderables.forEach(function(a){a.visible=c}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.removeObject=function(a){var c=this,b=this.perObjectData.get(a);b&&(this.perObjectData.delete(a),
b.loaded.then(function(){b.renderables.forEach(function(a){c.removeRenderable(a)});c.callbacks.setNeedsRender()}))};d.prototype.getObjectEntry=function(a){return n(this,void 0,void 0,function(){var c;return B(this,function(b){switch(b.label){case 0:c=this.perObjectData.get(a);if(!c)throw"no object";return[4,c.loaded];case 1:return b.sent(),[2,c]}})})};d.prototype.removeAll=function(){var a=this;this.perObjectData.forEach(function(c,b){a.removeObject(b)})};d.prototype.render=function(a,c){var b=this;
this.localOrigins.updateViewMatrices(a.view);this.renderers.forEach(function(a){0===a.refCount.value&&(b.renderers.delete(a.key),a.dispose())});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var e=0,k=0;this.renderers.forEach(function(a){return a.forEachRenderable(function(a){e+=a.statistics.averageEdgeLength;k++},c)});if(0!==k){var f=a.view,d=40*e/k,m=t.estimateLengthAtDistance(a.viewport[3],a.fovY,1,3.5*a.pixelRatio),g={distanceFalloffFactor:d,minimumEdgeLength:m,
transparency:c};this.rctx.setPipelineState(this.pipelineState);this.updateObjectCameraDistances(a);this.numberOfRenderedEdges=0;this.renderers.forEach(function(c){b.renderRegularEdges(c,a,g);b.renderSilhouetteEdges(c,a,g)});a.view=f}};d.prototype.updateTransparency=function(a){var c=t.determineEdgeTransparency(a.components.meta),b=t.determineObjectTransparency(a.components.meta);if(c!==a.edgeTransparency||b!==a.objectTransparency)a.edgeTransparency=c,a.objectTransparency=b,this.renderers.get(a.rendererKey).setRenderablesDirty()};
d.prototype.computeModelTransformWithLocalOrigin=function(a,c,b){a.getCombinedStaticTransformation(c,b);c.origin?this.localOrigins.register(c.origin):(a=G.vec3.set(this.tmpModelPosition,b[12],b[13],b[14]),c.origin=this.localOrigins.acquire(a));Y.applyToModelMatrix(c.origin.vec3,b);return b};d.prototype.updateComponentBuffer=function(a){var c=a.meta;a=a.buffer;for(var b=0;b<c.length;b++){var e=c[b].material,k=c[b].index,d=K.clamp(Math.round(e.size*x.LINE_WIDTH_FRACTION_FACTOR),0,255),D=K.clamp(e.extensionLength,
-x.EXTENSION_LENGTH_OFFSET,255-x.EXTENSION_LENGTH_OFFSET)+x.EXTENSION_LENGTH_OFFSET,m="solid"===e.type?0:1,g=255*e.opacity,e=e.color;a.textureBuffer.setData(k,0,255*e[0],255*e[1],255*e[2],255*e[3]);a.textureBuffer.setData(k,1,d,D,m,g)}};d.prototype.createComponentBuffers=function(a){for(var c=[],b=this.componentColorManager.getBuffer(a.length),e=0;e<a.length;e++){var k=a[e],d=b.acquireIndex();c.push({index:d,material:k})}a={meta:c,buffer:b};this.updateComponentBuffer(a);return a};d.prototype.extractEdges=
function(a,c,b,e,k){return this.worker.process({data:c,originalIndices:k,writerSettings:a,skipDeduplicate:b},e?null:this.workerThread)};d.prototype.createEdgeResources=function(a){var c={};if(0<a.regular.lodInfo.lengths.length){var b=new Q(this.rctx,A.EdgeShaderAttributeLocations,{vertices:A.glVertexLayout,instances:P.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:E.createVertex(this.rctx,35044,a.regular.instancesData.buffer)});c.regular={vao:b,lod:a.regular.lodInfo}}0<
a.silhouette.lodInfo.lengths.length&&(b=new Q(this.rctx,A.EdgeShaderAttributeLocations,{vertices:A.glVertexLayout,instances:P.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:E.createVertex(this.rctx,35044,a.silhouette.instancesData.buffer)}),c.silhouette={vao:b,lod:a.silhouette.lodInfo});return c};d.prototype.disposeEdgeResources=function(a){a.regular&&(a.regular.vao.vertexBuffers.instances.dispose(),a.regular.vao.dispose(!1),a.regular.vao=null);a.silhouette&&(a.silhouette.vao.vertexBuffers.instances.dispose(),
a.silhouette.vao.dispose(!1),a.silhouette.vao=null)};d.prototype.addGeometryNonPreinterleaved=function(a,c,b,e,k,d,D){return n(this,void 0,void 0,function(){var f,g,h,p;return B(this,function(m){f=b.getAttribute("position");g=this.computeModelTransformWithLocalOrigin(a,e,I.mat4f64.create());h=e.origin;p={position:f,indices:b.getIndices("position"),modelTransform:g,origin:h};return[2,this.addNonPreinterleaved(c,p,k,d,D)]})})};d.prototype.addNonPreinterleaved=function(a,c,b,e,k){void 0===k&&(k=!1);
return n(this,void 0,void 0,function(){var d,D,m,g,h,p,q,l,C,v,z,F,r,y,w;return B(this,function(f){switch(f.label){case 0:d=this.acquireRenderer(b.type,e.slicePlaneEnabled||!1);D=c.modelTransform;m=c.origin;g=c.indices;h=c.position;p=h.data.length/h.strideIdx;q=A.EdgeInputBufferLayout.createBuffer(p);for(l=0;l<p;l++)q.position.set(l,0,h.data[h.offsetIdx+l*h.strideIdx+0]),q.position.set(l,1,h.data[h.offsetIdx+l*h.strideIdx+1]),q.position.set(l,2,h.data[h.offsetIdx+l*h.strideIdx+2]);C=this.createComponentBuffers([b]);
t.fillComponenBufferIndices(C.meta,[0,q.componentIndex.count],q.componentIndex);return[4,this.extractEdges(d.writerSettings,q,!1,k,g)];case 1:return v=f.sent(),z=this.createEdgeResources(v),F=z.regular,r=z.silhouette,y=(F?F.vao.size:0)+(r?r.vao.size:0),w={regular:F,silhouette:r,transform:{modelMatrix:D,origin:m},statistics:{gpuMemoryUsage:y,averageEdgeLength:v.averageEdgeLength},components:C,visible:!0,edgeTransparency:t.determineEdgeTransparency(C.meta),objectTransparency:t.determineObjectTransparency(C.meta),
distanceToCamera:0,rendererKey:d.key},a.renderables.push(w),d.addRenderable(w),this.gpuMemoryUsage+=y,[2]}})})};d.prototype.addGeometryPreinterleaved=function(a,c,b,e,k,d,D){return n(this,void 0,void 0,function(){var f,g,h,p,q,l,C,v,z,F,r,y,w,n,x,u;return B(this,function(m){switch(m.label){case 0:f=b.getAttribute("position");if(!f||!M.isFloat32Array(f.data))return console.warn("Geometry has no float32 `position` attribute, skipping it."),[2];g=t.determineRendererType(k);h=this.acquireRenderer(g,d.slicePlaneEnabled||
!1);p=this.computeModelTransformWithLocalOrigin(a,e,I.mat4f64.create());q=e.origin;l=b.getIndices("position");C=new V.BufferViewVec3f(f.data.buffer,4*f.offsetIdx,4*f.strideIdx);v=A.EdgeInputBufferLayout.createBuffer(C.count);W.vec3.copy(v.position,C);z=this.createComponentBuffers(k);t.fillComponenBufferIndices(z.meta,b.componentOffsets,v.componentIndex,l);F=b.hasPositionData;return[4,this.extractEdges(h.writerSettings,v,F,D,l)];case 1:return r=m.sent(),y=this.createEdgeResources(r),w=y.regular,n=
y.silhouette,x=(w?w.vao.size:0)+(n?n.vao.size:0),u={regular:w,silhouette:n,transform:{modelMatrix:p,origin:q},statistics:{gpuMemoryUsage:x,averageEdgeLength:r.averageEdgeLength},components:z,visible:!a.isHidden(e),edgeTransparency:t.determineEdgeTransparency(z.meta),objectTransparency:t.determineObjectTransparency(z.meta),distanceToCamera:0,rendererKey:h.key},c.renderables.push(u),h.addRenderable(u),this.gpuMemoryUsage+=x,[2]}})})};d.prototype.canMergeGeometries=function(a){for(var c=null,b=null,
e=0;e<a.geometries.length;e++){var d=a.geometryRecords[e];if(d.material.supportsEdges){if(a.geometries[e].data instanceof O)return!1;if(!c)c=d.transformation;else if(!S.equals(c,d.transformation))return!1;if(!b&&d.origin)b=d;else if(b&&d.origin&&b.origin.id!==d.origin.id)return!1}}return!0};d.prototype.addObjectMergedGeometries=function(a,c,b,e){return n(this,void 0,void 0,function(){var d,f,n,m,g,h,p,q,l,t,v,z,x,r,y,w,u,A,G,E,H;return B(this,function(k){switch(k.label){case 0:d=new Map;f=0;m=n=null;
for(g=0;g<a.geometries.length;g++)if(h=a.geometries[g],p=a.geometryRecords[g],q=p.material,q.supportsEdges&&(!m&&p.origin&&(m=p),l=h.data.getIndices("position"),f+=l?l.length:0,l&&null==n||n===Uint16Array))n=M.isUint16Array(l)?Uint16Array:Uint32Array;t=f?new n(f):null;v=[];for(g=z=0;g<a.geometries.length;g++)if(h=a.geometries[g],x=a.geometryRecords[g],q=x.material,q.supportsEdges){r=h.data.getAttribute("position");l=h.data.getIndices("position");y=d.get(r.data);if(null==y){y=v.length/3;for(w=r.offsetIdx;w<
r.data.length;w+=r.strideIdx)v.push(r.data[w+0]),v.push(r.data[w+1]),v.push(r.data[w+2]);d.set(r.data,y)}if(l)for(u=0;u<l.length;u++)t[z++]=y+l[u]}A=m||a.geometryRecords[0];G=this.computeModelTransformWithLocalOrigin(a,A,I.mat4f64.create());E=A.origin;for(g=0;g<a.geometryRecords.length;g++)a.geometryRecords[g].origin=E;H={position:{data:v,offsetIdx:0,strideIdx:3},indices:t,modelTransform:G,origin:E};return[4,this.addNonPreinterleaved(c,H,b[0],e)];case 1:return k.sent(),[2]}})})};d.prototype.acquireRenderer=
function(a,c){var b=x.EdgeRenderer.getKey(a,c),d=this.renderers.get(b);this.strokesTexture||(this.strokesTexture=ca.generateStrokesTexture(this.rctx));d||(d=new x.EdgeRenderer(this.rctx,this.programRepository,{type:a,slicePlaneEnabled:c,strokesTexture:this.strokesTexture}),this.renderers.set(b,d));d.refCount.increment();return d};d.prototype.removeRenderable=function(a){var c=this.renderers.get(a.rendererKey);c.removeRenderable(a);c.refCount.decrement();this.disposeEdgeResources(a);this.localOrigins.release(a.transform.origin);
this.gpuMemoryUsage-=a.statistics.gpuMemoryUsage;for(var c=0,b=a.components.meta;c<b.length;c++)a.components.buffer.releaseIndex(b[c].index)};d.prototype.updateObjectCameraDistances=function(a){var c=this;a=a.viewInvTransp;G.vec3.set(this.tmpCameraPosition,a[3],a[7],a[11]);this.perObjectData.forEach(function(a,d){var b=G.vec3.distance(d.getCenter(),c.tmpCameraPosition);a.renderables.forEach(function(a){return a.distanceToCamera=b})})};d.prototype.renderRegularEdges=function(a,c,b){var d=this;a.bindRegularEdges(c,
b);a.forEachRenderable(function(e){if(e.visible&&e.regular){var f=t.computeEdgeCount(e.regular.lod.lengths,e.distanceToCamera,b);c.view=d.localOrigins.getViewMatrix(e.transform.origin);a.renderRegularEdges(e,c,f);d.numberOfRenderedEdges+=f}},b.transparency)};d.prototype.renderSilhouetteEdges=function(a,c,b){var d=this;a.bindSilhouetteEdges(c,b);a.forEachRenderable(function(e){if(e.visible&&e.silhouette){var f=t.computeEdgeCount(e.silhouette.lod.lengths,e.distanceToCamera,b);c.view=d.localOrigins.getViewMatrix(e.transform.origin);
a.renderSilhouetteEdges(e,c,f);d.numberOfRenderedEdges+=f}},b.transparency)};return d}();H.EdgeView=J});