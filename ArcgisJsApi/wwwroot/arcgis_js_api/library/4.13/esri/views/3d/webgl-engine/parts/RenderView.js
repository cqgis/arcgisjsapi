// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/has ../../../../core/Logger ../../../../core/now ../../../../core/scheduling ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/animationUtils ../lib/AutoDisposable ../lib/Camera ../lib/DrapedRenderer ../lib/GLMaterialRep ../lib/ProgramRepository ../lib/Renderer ../lib/TextureRepository ../lib/tracer ./ScreenshotManager ../shaders/globalOptions ../../../webgl/context-util ../../../webgl/RenderingContext".split(" "),
function(H,I,n,p,e,q,r,t,J,u,h,v,w,f,x,y,z,A,B,C,k,D,E,F,G){var l=t.getLogger("esri.views.3d.webgl-engine.parts.View");return function(m){function b(a,b,g,d){var c=m.call(this)||this;c._stage=b;c._camera=new x.default(v.vec3f64.fromValues(0,100,-100));c._needsUpdate=!0;c._needsRender=!0;c._idleSuspend=!0;c._logicUpdateLast=0;c._stats={renderGeometriesTotal:0,renderGeometriesVisible:0,renderTimeTotal:0,renderTimeLast:0,frameCount:0};c._container=a;c._initializeContext(d);a=E.glslifyGlobalOptions({viewingMode:d.viewingMode});
c._programRepository=new A(c._rctx,a);c._textureRepository=new C(c._stage.getAll(4),c._programRepository,function(){return c._camera.viewport},c._rctx,function(){c._textureRepositoryHasNewLoadedTextures=!0});c._materialRepository=new z(c._textureRepository,c._programRepository);c._initializeViewportCamera();c._drapedRenderer=new y(c._rctx,c._canvas,c._programRepository,c._materialRepository,c._textureRepository,g);c._renderer=new B(c._programRepository,c._materialRepository,c._textureRepository,c._rctx,
"scene",function(a){void 0===a&&(a=1);return c.setNeedsRender(a)},c._stage);c._screenshotManager=new D.ScreenshotManager(c._rctx,c._render.bind(c),function(){return c.setNeedsRender()},d.screenshot.renderOverlay);c._registerFrameTask();return c}p(b,m);b.prototype.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this.inherited(arguments)};b.prototype.getCombinedStats=function(){var a=
this._rctx.gl,b={},g=this._renderer.getCombinedStats(),d;for(d in g)b[d]=g[d];b.renderGeometriesTotal=this._stats.renderGeometriesTotal;b.renderGeometriesVisible=this._stats.renderGeometriesVisible;void 0!==a.getUsedTextureMemory&&(b.textureMemory=a.getUsedTextureMemory());void 0!==a.getUsedRenderbufferMemory&&(b.renderbufferMemory=a.getUsedRenderbufferMemory());void 0!==a.getUsedVBOMemory&&(b.VBOMemory=a.getUsedVBOMemory());if(void 0!==a.getUsedTextureMemoryStats){var a=a.getUsedTextureMemoryStats(),
c;for(c in a)b["texMem type: "+c]=a[c]}return b};b.prototype.setNeedsRender=function(a){void 0===a&&(a=1);1===a?(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};Object.defineProperty(b.prototype,"canRender",{get:function(){var a=this._camera;return 0<a.fullWidth&&0<a.fullHeight&&this._renderer.canRender},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"needsUpdate",{get:function(){return this._needsUpdate||!this._idleSuspend||this._textureRepositoryHasNewLoadedTextures},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this.needsUpdate||this._renderer.updating||0<this._textureRepository.getLoadingCount()||this._drapedRenderer.updating||this._stage.dirty},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._renderer.edgeView},enumerable:!0,configurable:!0});b.prototype.setRenderParameters=
function(a){this.setNeedsRender();void 0!==a.idleSuspend&&(this._idleSuspend=!!a.idleSuspend);this._renderer.setRenderParams(a)};b.prototype.getRenderParameters=function(){var a=this._renderer.getRenderParams();a.anisotropicFiltering=this._textureRepository.getMaxAnisotropy();a.idleSuspend=this._idleSuspend;return a};Object.defineProperty(b.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!0,configurable:!0});b.prototype.has=function(a){return"s3tc"===a?!!this._rctx.capabilities.compressedTextureS3TC:
"shaderTextureLOD"===a?!!this._rctx.capabilities.shaderTextureLOD:!1};b.prototype.modify=function(a,b,g,d){this._renderer.modify(a,a.length,b,b.length,g,g.length,d)};b.prototype.setCamera=function(a){this._camera.copyFrom(a);this.setNeedsRender()};b.prototype.getCamera=function(){return this._camera};b.prototype.getCanvas=function(){return this._canvas};b.prototype.getDrapedRenderer=function(){return this._drapedRenderer};b.prototype.takeScreenshot=function(a){return this._screenshotManager.takeScreenshot(a)};
Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderer.renderPlugins},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!0,configurable:!0});b.prototype.getGpuMemoryUsage=function(){return n({},this._renderer.getGpuMemoryUsage(),{draped:this._drapedRenderer?this._drapedRenderer.getGpuMemoryUsage():0})};b.prototype._registerFrameTask=function(){var a=this,b={viewCamera:this._camera,frameHasSlicePlane:!1,
drapedRenderer:this._drapedRenderer};this._frameTask=u.addFrameTask({preRender:function(b){k.begin();var d=!1;a._stage.processDirty();a._drapedRenderer.commitChanges();var c=b.time-a._logicUpdateLast;c>w.DESIRED_ANIMATION_MS&&(d=a._renderer.updateLogic({dt:c,camera:a._stage.getCamera()})||d,a._logicUpdateLast=b.time);d&&a.setNeedsRender(0)},render:function(){(a.needsUpdate||a._needsRender)&&a.canRender&&(a._needsRender=!1,a._needsUpdate=!1,a._textureRepositoryHasNewLoadedTextures=!1,a._render(null,
a._camera,!1))},postRender:function(){a.notifyChange("updating");k.end()},update:function(){b.viewCamera=a._camera;b.frameHasSlicePlane=a._renderer.hasSlicePlane;b.drapedRenderer=a._drapedRenderer;a._screenshotManager.update(b)}})};b.prototype._initializeViewportCamera=function(){var a=this._container.getBoundingClientRect(),b=this.getCamera();b.viewport[2]=a.width;b.viewport[3]=a.height;this.setCamera(b)};b.prototype._initializeContext=function(a){this._canvas=a.canvas;this._canvas||(this._canvas=
document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var b=k.instrumentContext(F.createContextOrErrorHTML(this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil},a.renderContext));this._rctx=new G(b,{disabledExtensions:a.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.debugWebGLExtensions||{}});this._load3DExtensions(this._rctx);!a.alpha&&this._rctx.contextAttributes.alpha&&l.error("WebGL context has alpha channel even though no alpha channel was requested");
!this._rctx.contextAttributes.alpha&&11<=r("safari")&&(this._container.style.backgroundColor="black");this._container.appendChild(this._canvas)};b.prototype._render=function(a,b,e){this._renderer.setLighting(this._stage.lighting);this._rctx.bindFramebuffer(a);b.setGLViewport(this._rctx);this._renderer.render({fbo:a,camera:b,disableSlice:e,lightDirection:this._stage.mainLightDirection})};b.prototype._load3DExtensions=function(a){a=a.capabilities;a.standardDerivatives&&a.shaderTextureLOD&&a.instancing&&
a.textureFilterAnisotropic||l.error("required WebGL extensions are not supported!")};e([h.property({type:Boolean,readOnly:!0})],b.prototype,"updating",null);e([f.autoDispose()],b.prototype,"_rctx",void 0);e([f.autoDispose()],b.prototype,"_container",void 0);e([f.autoDispose()],b.prototype,"_canvas",void 0);e([f.autoDispose()],b.prototype,"_programRepository",void 0);e([f.autoDispose()],b.prototype,"_renderer",void 0);e([f.autoDispose()],b.prototype,"_drapedRenderer",void 0);e([f.autoDispose()],b.prototype,
"_screenshotManager",void 0);return b=e([h.subclass("esri.views.3d.webgl-engine.parts.RenderView")],b)}(h.declared(f.AutoDisposableMixin(q)))});