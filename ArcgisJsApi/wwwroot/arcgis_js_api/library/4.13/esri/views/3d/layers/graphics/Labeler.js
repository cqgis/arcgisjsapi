// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/graphics/dehydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./graphicSymbolUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../../support/index".split(" "),
function(w,x,A,q,p,r,B,y,C,u,l,t,D,E,F,G,H,I,J,K,z,L,M,N,O){Object.defineProperty(x,"__esModule",{value:!0});w=function(v){function d(){var a=null!==v&&v.apply(this,arguments)||this;a.idHint="__labeler";a._dirty=!1;a.labels=new Map;a.labelsToAdd=new Map;a.labelsToRemove=new Map;a.labelingContexts=[];return a}A(d,v);d.prototype.setup=function(){var a=this;this.handles||(this.handles=new C,this.handles.add([this.view.watch("state.camera",function(){return a.setDirty()}),this.view.watch("pixelRatio",
function(){return a.resetAllLabels()})]));this.textTextureAtlas||(this.textTextureAtlas=new N.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new z(this.view._stage),this.calloutMaterialCollection=new z(this.view._stage));this.handles.add(this.view.resourceController.scheduler.registerTask(O.Task.LABELER,function(b){return a.update(b)},function(){return a.needsUpdate()}))};d.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.textTextureAtlas&&
(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=[];this.labels.clear();this.labelsToAdd.clear();this.labelsToRemove.clear()};d.prototype.isActiveLabelingContext=function(a){return a.active&&this.labelsEnabled(a)};d.prototype.activateLabelingContext=function(a){var b=
this;a.labels.forEach(function(a,e){b.labels.set(e,a);a.graphics3DGraphic.setVisibilityFlag(0,!0,1)});a.active=!0};d.prototype.deactivateLabelingContext=function(a){var b=this;a.labels.forEach(function(a,e){a.graphics3DGraphic.setVisibilityFlag(0,!1,1);a.rendered&&b.labelsToRemove.set(e,a);b.labels.delete(e);b.labelsToAdd.delete(e)});a.active=!1};d.prototype.addLabelTextureToAtlas=function(a){for(var b=0;b<a.graphics3DGraphic._labelGraphics.length;b++){var c=a.graphics3DGraphic._labelGraphics[b];
if(c._labelClass){var e=a.textRenderers[c._labelIndex];e&&this.textTextureAtlas.addTextTexture(e,c.stageObject)}}a.rendered=!0};d.prototype.removeLabelTextureFromAtlas=function(a){for(var b=a.graphics3DGraphic,c=0;c<b._labelGraphics.length;c++){var e=b._labelGraphics[c];e._labelClass&&(e=a.textRenderers[e._labelIndex])&&this.textTextureAtlas.removeTextTexture(e,b._labelGraphics[c].stageObject)}a.rendered=!1};d.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty};d.prototype.update=
function(a){for(var b=this,c=this._dirty=!1,e=function(e){if(!f.isActiveLabelingContext(e))return"continue";if(!f.hasValidLabelClassContext(e)){if(f.hasInvalidLabelClassContext(e))return f.deactivateLabelingContext(e),"continue";f.createLabelClassContext(e);if(f.hasPendingLabelClassContext(e))return f._dirty=!0,"continue";if(!f.hasValidLabelClassContext(e))return"continue"}e.labelsToInitialize.forEach(function(f,d){b.ensureGraphics3DResources(f)&&(b.labels.set(d,f),c=!0);(f.visible&&f.hasTextTextureResources||
!f.visible&&f.hasGraphics3DResources)&&e.labelsToInitialize.delete(d);a&&(a.madeProgress(),a.done&&(b._dirty=!0))})},f=this,d=0,k=this.labelingContexts;d<k.length;d++)e(k[d]);a&&c&&this.view.deconflictor.setDirty();this.labelsToRemove.forEach(function(a){return b.removeLabelTextureFromAtlas(a)});this.labelsToRemove.clear();this.labelsToAdd.forEach(function(a){return b.addLabelTextureToAtlas(a)});this.labelsToAdd.clear();this._dirty||this.notifyChange("updating")};d.prototype.hasPendingLabelClassContext=
function(a){return a.labelClassPromise&&!!a.labelClassAbortController};d.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};d.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};d.prototype.createLabelClassContextAsync=function(a){return r(this,void 0,void 0,function(){var b,c,e,f,d,k=this;return p(this,function(g){switch(g.label){case 0:return b=a.labelClassAbortController.signal,[4,a.layer.when()];case 1:g.sent();
l.throwIfAborted(b);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();c=a.graphics3DCore;e=c.layer;f=e.labelingInfo&&e.labelingInfo.filter(function(a){return!!a.symbol});if(!f||0===f.length)return[2,null];d=Array(f.length);return[4,y.forEach(f,function(e,f){return r(k,void 0,void 0,function(){var g,n,k,h;return p(this,function(m){switch(m.label){case 0:return g=e.symbol,n=H.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(g)),[4,n.load()];case 1:m.sent();l.throwIfAborted(b);k=null;if(!F.isCalloutSupport(g)||
!g.hasVisibleCallout())return[3,3];k=G.make(g,c.symbolCreationContext);return[4,k.load()];case 2:m.sent(),l.throwIfAborted(b),m.label=3;case 3:return[4,y.result(E.createLabelFunction(e,a.layer.fields.map(function(a){return a.toJSON()}),this.view.spatialReference))];case 4:return h=m.sent(),l.throwIfAborted(b),!0===h.ok&&(d[f]={labelClass:e,labelFunction:h.value,graphics3DSymbol:n,graphics3DCalloutSymbolLayer:k,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(n.symbol)}),
[2]}})})})];case 2:return g.sent(),l.throwIfAborted(b),a.labelClassContexts=d,[2]}})})};d.prototype.createLabelClassContext=function(a){return r(this,void 0,void 0,function(){var b=this;return p(this,function(c){a.labelClassPromise||(a.labelClassPromise=this.createLabelClassContextAsync(a).catch(function(b){if(l.isAbortError(b))throw b;a.labelClassContexts=null}).then(function(){a.labelClassAbortController=null;b.notifyChange("updating")}),this.notifyChange("updating"));return[2,a.labelClassPromise]})})};
d.prototype.createTextRenderParameters=function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?M.default.fromSymbol(a,this.view.pixelRatio):null};d.prototype.destroyLabelClassContext=function(a){for(var b=0,c=a.labelClassContexts;b<c.length;b++){var e=c[b];--e.graphics3DSymbol.referenced;e.graphics3DSymbol=null}b=a.labelClassAbortController;a.labelClassAbortController=l.createAbortController();b&&b.abort();a.labelClassContexts=[];a.labelClassPromise=null;this.notifyChange("updating")};
d.prototype.createTextSymbolGraphic=function(a,b,c,e,f){a={text:a.text,centerOffset:c.centerOffset,translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,anchor:c.anchor,centerOffsetUnits:c.centerOffsetUnits,verticalOffset:c.verticalOffset,debugDrawBorder:J.LABELS_SHOW_BORDER,displayWidth:a.displayWidth,displayHeight:a.displayHeight};h.graphic=b;h.renderingInfo=null;h.layer=e;return f.createLabel(h,a,this.hudMaterialCollection,this.textTextureAtlas)};d.prototype.createLineCalloutGraphic=
function(a,b,c,e,f){b={symbol:b,translation:e.translation,elevationOffset:e.elevationOffset,screenOffset:e.screenOffset,centerOffset:e.centerOffset,centerOffsetUnits:e.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};h.graphic=a;h.renderingInfo=b;h.layer=f;return c.createGraphics3DGraphic(h)};d.prototype.ensureGraphics3DResources=function(a){var b=a.graphics3DGraphic;if(b.destroyed||a.hasGraphics3DResources)return!1;this.ensureTextTextureResources(a);var c=a.labelingContext,e=
!1,f=b.graphic,d=c.labelClassContexts,k=c.layer,n=this.labelsEnabled(c);if(!d||0===d.length||!b._graphics[0])return!1;for(var h=0;h<d.length;h++){var l=d[h],t=l.labelClass,q=a.textRenderers[h];if(q){var m=l.graphics3DSymbol,p=null;m.symbol&&"label-3d"===m.symbol.type&&(p=m.symbol);var r=m.symbolLayers[0],m=I.get({graphics3DGraphic:b,labelSymbol:p,labelClass:l.labelClass});if(r&&!u.isNone(m)){if(e=this.createTextSymbolGraphic(q,f,m,k,r)){if(e._labelClass=t,e._labelIndex=h,b.addLabelGraphic(e,c.stageLayer,
this.view._stage),b.setVisibilityFlag(0,n,1),b.clearVisibilityFlag(1,1),b.setVisibilityFlag(3,!1,1),e=!0,l.graphics3DCalloutSymbolLayer&&m.hasLabelVerticalOffset&&(f=this.createLineCalloutGraphic(f,p,l.graphics3DCalloutSymbolLayer,m,k)))l.calloutSymbolLayerIndex=b._labelGraphics.length,b.addLabelGraphic(f,c.stageLayer,this.view._stage)}else return!1;break}}}c.scaleVisibility&&e&&c.scaleVisibility.updateGraphicLabelScaleVisibility(b);return a.hasGraphics3DResources=!0};d.prototype.destroyGraphics3DResources=
function(a){for(var b=a.labelingContext.labelClassContexts,c=0,e=a.graphics3DGraphic._labelGraphics;c<e.length;c++){var d=e[c];if(null!=d._labelClass){var g=b[d._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=g)g.onRemoveGraphic(d)}}a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};d.prototype.ensureTextTextureResources=function(a){if(!a.hasTextTextureResources){var b=a.labelingContext,c=b.labelClassContexts,e=a.graphics3DGraphic.graphic;if(c&&0!==c.length){for(var d=0;d<
c.length;d++){var g=c[d];a.textRenderers[d]=null;if(g.textRenderParameters){var k=g.labelFunction,n=void 0;if("arcade"===k.type){var h=D.hydrateGraphic(e,b.layer);try{n=k.evaluate(h)}catch(P){n=null}}else n=k.evaluate(e);u.isNone(n)||""===n||(a.textRenderers[d]=new L.default(n,g.textRenderParameters))}}a.hasTextTextureResources=!0}}};d.prototype.destroyTextTextureResources=function(a){a.textRenderers=[];a.hasTextTextureResources=!1};d.prototype.addGraphic=function(a,b){var c={hasGraphics3DResources:!1,
hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:a,graphics3DGraphic:b,textRenderers:[]};b=b.graphic.uid;a.labels.set(b,c);this.isActiveLabelingContext(a)&&this.hasValidLabelClassContext(a)&&this.ensureGraphics3DResources(c)?this.labels.set(b,c):a.labelsToInitialize.set(b,c);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};d.prototype.removeGraphic=function(a,b){b=b.graphic.uid;var c=a.labels.get(b);c&&(this.destroyGraphic(c,b),a.labels.delete(b),a.labelsToInitialize.delete(b),
this.setDirty(a.graphics3DCore.asyncUpdates),this.view.deconflictor.setDirty())};d.prototype.labelsEnabled=function(a){return!0===a.layer.labelsVisible&&null!=a.layer.labelingInfo&&0<a.layer.labelingInfo.length};d.prototype.destroyGraphic=function(a,b){this.labels.has(b)&&(this.labels.delete(b),this.labelsToAdd.delete(b),this.labelsToRemove.delete(b));a.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(a),this.destroyTextTextureResources(a));a.hasGraphics3DResources&&this.destroyGraphics3DResources(a)};
d.prototype.labelingInfoChange=function(a,b){return r(this,void 0,void 0,function(){var c,e,d,g;return p(this,function(f){if(b){c=0;for(e=b;c<e.length;c++)if(d=e[c],g=a.labels.get(d))this.removeGraphic(a,g.graphics3DGraphic),this.addGraphic(a,g.graphics3DGraphic);return[2]}this.visibilityInfoChange(a);this.resetLabels(a);return[2,this.createLabelClassContext(a)]})})};d.prototype.globalPropertyChanged=function(a,b){for(var c=function(c){var d=new Map;b.labels.forEach(function(a){a=a.graphics3DGraphic;
d.set(a.graphic.uid,a)});u.expect(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,d,function(a){return a._labelGraphics[0]});c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,d,function(a){return a._labelGraphics[c.calloutSymbolLayerIndex]})},e=0,d=b.labelClassContexts;e<d.length;e++)c(d[e])};d.prototype.visibilityInfoChange=function(a){var b=a.layer.labelsVisible;b&&!a.active&&this.activateLabelingContext(a);!b&&a.active&&this.deactivateLabelingContext(a);
this.setDirty(a.graphics3DCore.asyncUpdates)};d.prototype.resetAllLabels=function(){for(var a=0,b=this.labelingContexts;a<b.length;a++)this.resetLabels(b[a])};d.prototype.resetLabels=function(a){var b=this;a.labels.forEach(function(c,d){b.destroyGraphic(c,d);c.visible=!1;c.rendered=!1;a.labelsToInitialize.set(d,c)});this.destroyLabelClassContext(a);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};d.prototype.findLabelingContext=function(a){for(var b=0,c=this.labelingContexts;b<
c.length;b++){var d=c[b];if(d.graphics3DCore===a)return d}return null};d.prototype.addGraphicsOwner=function(a,b){var c=this;if(!this.findLabelingContext(a)){var d=a.layer,f={graphics3DCore:a,layer:d,scaleVisibility:b,active:a.layer.labelsVisible,labelClassPromise:null,labelClassAbortController:l.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new K(this.idHint+"_"+d.uid,{isPickable:!0},d.uid)};this.view._stage.add(0,f.stageLayer);this.view._stage.addToViewContent([f.stageLayer.id]);
this.labelingContexts.push(f);this.setDirty();return{addGraphic:function(a){return c.addGraphic(f,a)},removeGraphic:function(a){return c.removeGraphic(f,a)},featureReductionChange:function(){},layerLabelsEnabled:function(){return c.labelsEnabled(f)},labelingInfoChange:function(a){return c.labelingInfoChange(f,a)},elevationInfoChange:function(){return c.globalPropertyChanged("elevationInfo",f)},slicePlaneEnabledChange:function(){return c.globalPropertyChanged("slicePlaneEnabled",f)},visibilityInfoChange:function(){return c.visibilityInfoChange(f)},
reset:function(){return c.resetLabels(f)},clear:function(){},processStageDirty:function(){return c.view._stage.processDirtyLayer(f.stageLayer.id)}}}};d.prototype.removeGraphicsOwner=function(a){var b=this,c=this.findLabelingContext(a);c&&(a=this.labelingContexts.indexOf(c),this.labelingContexts.splice(a,1),c.labels.forEach(function(a){return b.removeGraphic(c,a.graphics3DGraphic)}),a=c.stageLayer.id,this.view._stage.removeFromViewContent([a]),this.view._stage.remove(0,a),c.stageLayer=null,this.setDirty())};
d.prototype.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;var c=this.labels.get(a);c&&(b&&!c.rendered?(this.labelsToAdd.set(a,c),this.labelsToRemove.delete(a),c.hasTextTextureResources||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this.labelsToRemove.set(a,c),this.labelsToAdd.delete(a)),c.visible=b,this.setDirty(c.labelingContext.graphics3DCore.asyncUpdates))};Object.defineProperty(d.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},
enumerable:!0,configurable:!0});d.prototype.setDirty=function(a){void 0===a&&(a=!0);var b=this._dirty;this._dirty||(this._dirty=!0);a||this.update(null);b!==this._dirty&&this.notifyChange("updating")};Object.defineProperty(d.prototype,"updating",{get:function(){var a=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.labelingContexts.some(function(b){return a.hasPendingLabelClassContext(b)})},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"test",
{get:function(){return{textTextureAtlas:this.textTextureAtlas}},enumerable:!0,configurable:!0});q([t.property({constructOnly:!0})],d.prototype,"view",void 0);q([t.property()],d.prototype,"textTextureAtlas",void 0);q([t.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating"]})],d.prototype,"updating",null);return d=q([t.subclass("esri.views.3d.layers.graphics.Labeler")],d)}(t.declared(B));x.Labeler=w;var h={graphic:null,renderingInfo:null,layer:null}});