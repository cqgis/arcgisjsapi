// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/Logger ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./internal/bufferWriterUtils ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/NativeLinePrograms ../../../webgl/renderState".split(" "),
function(F,ba,A,M,q,N,f,d,b,G,O,H,P,y,Q,n,R,I,x){var S=M.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");F=function(l){function a(e,c){c=l.call(this,c)||this;c.params=n.copyParameters(e,T);return c}A(a,l);a.prototype.setParameterValues=function(e){var c=this.params,a;for(a in e)c[a]=e[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(e,a,b,f,g,h,l,k,U){U?this.intersectLineGeometry(e,a,b,f,g,h,l):n.intersectDrapedRenderLineGeometry(e,
a,b,f,g,h,1,l)};a.prototype.intersectLineGeometry=function(e,a,p,l,m,d,n,k){if(l.enable.selectionMode&&!O.isAllHidden(a.componentVisibilities,e.componentOffsets))if(y.isTranslationMatrix(p)){a=e.data.getVertexAttr().position.data;m=l.camera;d=V;N.vec2.copy(d,l.point);f.vec3.set(z[0],d[0]-2,d[1]+2,0);f.vec3.set(z[1],d[0]+2,d[1]+2,0);f.vec3.set(z[2],d[0]+2,d[1]-2,0);f.vec3.set(z[3],d[0]-2,d[1]-2,0);for(k=0;4>k;k++)m.unprojectPoint(z[k],t[k]);b.plane.fromPoints(m.eye,t[0],t[1],B);b.plane.fromPoints(m.eye,
t[1],t[2],C);b.plane.fromPoints(m.eye,t[2],t[3],D);b.plane.fromPoints(m.eye,t[3],t[0],E);e=Number.MAX_VALUE;for(k=0;k<a.length-5;k+=3)if(g[0]=a[k]+p[12],g[1]=a[k+1]+p[13],g[2]=a[k+2]+p[14],h[0]=a[k+3]+p[12],h[1]=a[k+4]+p[13],h[2]=a[k+5]+p[14],!(0>b.plane.signedDistance(B,g)&&0>b.plane.signedDistance(B,h)||0>b.plane.signedDistance(C,g)&&0>b.plane.signedDistance(C,h)||0>b.plane.signedDistance(D,g)&&0>b.plane.signedDistance(D,h)||0>b.plane.signedDistance(E,g)&&0>b.plane.signedDistance(E,h))){m.projectPoint(g,
u);m.projectPoint(h,v);if(0>u[2]&&0<v[2]){f.vec3.subtract(r,g,h);var c=m.frustum,q=-b.plane.signedDistance(c.planes[4],g),c=q/f.vec3.dot(r,c.planes[4]);f.vec3.scale(r,r,c);f.vec3.add(g,g,r);m.projectPoint(g,u)}else if(0<u[2]&&0>v[2])f.vec3.subtract(r,h,g),c=m.frustum,q=-b.plane.signedDistance(c.planes[4],h),c=q/f.vec3.dot(r,c.planes[4]),f.vec3.scale(r,r,c),f.vec3.add(h,h,r),m.projectPoint(h,v);else if(0>u[2]&&0>v[2])continue;u[2]=0;v[2]=0;c=b.lineSegment.distance2(b.lineSegment.fromPoints(u,v,J),
d);c<e&&(e=c,f.vec3.copy(K,g),f.vec3.copy(L,h))}p=l.rayBeginPoint;l=l.rayEndPoint;4>e&&(e=Number.MAX_VALUE,b.lineSegment.closestLineSegmentPoint(b.lineSegment.fromPoints(K,L,J),b.lineSegment.fromPoints(p,l,W),w)&&(f.vec3.subtract(w,w,p),e=f.vec3.length(w),f.vec3.scale(w,w,1/e),e/=f.vec3.distance(p,l)),n(e,w))}else S.error("intersection assumes a translation-only matrix")};a.prototype.createBufferWriter=function(){return new X(this.params)};a.prototype.createRenderer=function(a,c){return new R(a,c,
this)};a.prototype.getGLMaterials=function(){return{color:Y,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:Z}};return a}(P.Material);var Y=function(b){function a(a){a=b.call(this,a)||this;a.updateParameters();return a}A(a,b);a.prototype.updateParameters=function(){this.params=n.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(I.colorPass,{slice:a.slicePlaneEnabled,vertexColors:this.params.vertexColors});
this.pipelineState=x.makePipelineState({blending:1>a.color[3]&&x.separateBlendingParams(770,1,771,771),depthTest:{func:513},depthWrite:x.defaultDepthWriteParams,colorWrite:x.defaultColorWriteParams})};a.prototype.beginSlot=function(a){return 5===a};a.prototype.getProgram=function(){return this.program};a.prototype.bind=function(a,c){c=this.program;var e=this.params;a.bindProgram(c);a.setPipelineState(this.pipelineState);c.setUniform4fv("constantColor",e.color)};a.prototype.release=function(a){};a.prototype.bindView=
function(a,c){a=this.program;var e=this.params;n.bindView(c.origin,c.view,a);e.slicePlaneEnabled&&n.bindSlicePlane(c.origin,c.slicePlane,a)};a.prototype.bindInstance=function(a,c){this.program.setUniformMatrix4fv("model",c.transformation)};a.prototype.getDrawMode=function(){return 1};return a}(H),Z=function(b){function a(a){a=b.call(this,a)||this;a.updateParameters();return a}A(a,b);a.prototype.updateParameters=function(){this.params=n.copyParameters(this.material.getParameters());this.selectProgram()};
a.prototype.beginSlot=function(a){return 5===a};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){this.program=this.programRep.getProgram(I.highlightPass,{slice:this.params.slicePlaneEnabled,vertexColors:this.params.vertexColors});this.pipelineState=x.makePipelineState({depthTest:{func:513},colorWrite:x.defaultColorWriteParams})};a.prototype.bind=function(a,c){a.bindProgram(this.program);a.setPipelineState(this.pipelineState);n.bindHighlightRendering(a,c,
this.program)};a.prototype.release=function(a){};a.prototype.bindView=function(a,c){a=this.program;var b=this.params;n.bindView(c.origin,c.view,a);b.slicePlaneEnabled&&n.bindSlicePlane(c.origin,c.slicePlane,a)};a.prototype.bindInstance=function(a,c){this.program.setUniformMatrix4fv("model",c.transformation)};a.prototype.getDrawMode=function(){return 1};return a}(H),T={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1},aa=G.newLayout().vec3f(y.VertexAttrConstants.POSITION),X=function(){function b(a){this.vertexBufferLayout=
G.newLayout().vec3f(y.VertexAttrConstants.POSITION);a.vertexColors&&(this.vertexBufferLayout=aa.vec4u8(y.VertexAttrConstants.COLOR))}b.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};b.prototype.elementCount=function(a){return a.indices[y.VertexAttrConstants.POSITION].length};b.prototype.write=function(a,b,c,d){Q.writeDefaultAttributes(b,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,c,d)};return b}(),g=d.vec3f64.create(),h=d.vec3f64.create(),r=d.vec3f64.create(),
w=d.vec3f64.create(),u=q.createRenderScreenPointArray3(),v=q.createRenderScreenPointArray3(),K=d.vec3f64.create(),L=d.vec3f64.create(),J=b.lineSegment.create(),W=b.lineSegment.create(),V=d.vec3f64.create(),z=[q.createRenderScreenPointArray3(),q.createRenderScreenPointArray3(),q.createRenderScreenPointArray3(),q.createRenderScreenPointArray3()],t=[d.vec3f64.create(),d.vec3f64.create(),d.vec3f64.create(),d.vec3f64.create()],B=b.plane.create(),C=b.plane.create(),D=b.plane.create(),E=b.plane.create();
return F});