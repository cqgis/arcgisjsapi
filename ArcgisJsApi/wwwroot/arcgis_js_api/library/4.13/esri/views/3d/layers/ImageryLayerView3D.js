// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ./DynamicLayerView3D ../../layers/ImageryLayerView".split(" "),function(t,u,n,l,g,h,m,p,d,q,r){return function(e){function b(){var a=null!==e&&e.apply(this,arguments)||this;a.updateWhenStationary=!0;a.redrawDebounced=m.debounce(function(c){return h(a,
void 0,void 0,function(){var a=this;return g(this,function(b){this.redraw(function(c,b){return a.redrawImage(c,{signal:b})},c);return[2]})})},2E3);return a}n(b,e);b.prototype.initialize=function(){var a=this;this.handles.add([p.whenOnce(this.view.basemapTerrain,"ready",function(){return a.initializeMaximumDataResolution()}),this.layer.on("redraw",function(){return a.redrawDebounced()})]);this.updatingHandles.add(this.layer,"exportImageServiceParameters.version",function(c){a.updatingHandles.addPromise(a.refreshDebounced())});
this.updatingHandles.add(this,"timeExtent",function(){return a.updatingHandles.addPromise(a.refreshDebounced())})};b.prototype.initializeMaximumDataResolution=function(){var a=this.view.basemapTerrain.spatialReference,c=this.layer.fullExtent;c&&a.equals(c.spatialReference)&&(this.maximumDataResolution={x:this.layer.pixelSizeX,y:this.layer.pixelSizeY})};b.prototype.getFetchOptions=function(){return{timeExtent:this.timeExtent}};b.prototype.processResult=function(a,c,b){return h(this,void 0,void 0,function(){return g(this,
function(f){switch(f.label){case 0:if(!c.imageElement)return[3,1];a.image=c.imageElement;return[3,3];case 1:return a.image=document.createElement("canvas"),a.pixelData=c.pixelData,[4,this.redrawImage(a,{signal:b})];case 2:f.sent(),f.label=3;case 3:return[2]}})})};b.prototype.redrawImage=function(a,b){return h(this,void 0,void 0,function(){var c,f,h,d,k,e;return g(this,function(g){switch(g.label){case 0:if(!(a.image instanceof HTMLCanvasElement&&a.pixelData))return[2,m.reject()];c=a.image;f=c.getContext("2d");
return[4,this.layer.applyRenderer(a.pixelData,b)];case 1:return h=g.sent(),d=this.layer.applyFilter(h),k=d.pixelBlock,c.width=k.width,c.height=k.height,e=f.createImageData(k.width,k.height),e.data.set(d.pixelBlock.getAsRGBA()),f.putImageData(e,0,0),[2]}})})};l([d.property()],b.prototype,"layer",void 0);return b=l([d.subclass("esri.views.3d.layers.ImageryLayerView3D")],b)}(d.declared(r.ImageryLayerView(q)))});