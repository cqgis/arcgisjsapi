// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/extendsHelper ../../../../../core/mathUtils ../../../../../core/PooledArray ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f64 ../../materials/internal/MaterialUtil ../../shaders/EdgeRendererPrograms".split(" "),function(k,e,l,v,n,g,p,q,r,m){Object.defineProperty(e,"__esModule",{value:!0});e.LINE_WIDTH_FRACTION_FACTOR=8;e.EXTENSION_LENGTH_OFFSET=128;var t={type:"uber",
slicePlaneEnabled:!1,strokesTexture:null},u=function(){function c(){this._value=0}Object.defineProperty(c.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0});c.prototype.increment=function(){this._value++};c.prototype.decrement=function(){this._value--};return c}();k=function(){function c(a,b,d){var h,f,e;this.rctx=a;this.programRepository=b;this.refCount=new u;this.renderables=new Set;this.sortedRenderables=(h={},h[1]=(f={},f[1]=new g,f[2]=new g,f),h[2]=(e={},e[1]=
new g,e[2]=new g,e),h);this.renderablesDirty=!1;this.depthBiasZ=-4E-4;this.depthBiasXY=.5;this.tmpViewToWorldNormalMatrix=q.mat3f64.create();this.settings=l({},t,d);this.key=c.getKey(this.settings.type,this.settings.slicePlaneEnabled);this.writerSettings={variants:this.settings.strokesTexture.variants};this.createPrograms()}c.prototype.dispose=function(){for(var a in this.programs){var b=this.programs[a];b&&(this.programRepository.decreaseRefCount(b),this.programs[a]=null)}};c.prototype.addRenderable=
function(a){this.renderables.add(a);this.renderablesDirty=!0};c.prototype.removeRenderable=function(a){this.renderables.delete(a);this.renderablesDirty=!0};c.prototype.setRenderablesDirty=function(){this.renderablesDirty=!0};c.prototype.forEachRenderable=function(a,b){this.renderablesDirty&&this.sortRenderables();this.sortedRenderables[b][1].forEach(a);this.sortedRenderables[b][2].forEach(a)};c.prototype.bindRegularEdges=function(a,b){this.bind(this.programs.regular,a,b)};c.prototype.bindSilhouetteEdges=
function(a,b){this.bind(this.programs.silhouette,a,b)};c.prototype.bind=function(a,b,d){this.rctx.bindProgram(a);a.setUniformMatrix4fv("uProj",b.proj);a.setUniform2f("uDepthBias",this.depthBiasXY,this.depthBiasZ);a.setUniform2f("uPixelToNDC",2/b.viewport[2],2/b.viewport[3]);a.setUniform2f("uNDCToPixel",b.viewport[2]/2,b.viewport[3]/2);a.setUniform1f("uDistanceFalloffFactor",d.distanceFalloffFactor);a.setUniform2f("uViewportDimInv",1/b.viewport[2],1/b.viewport[3]);a.setUniform1f("uPixelRatio",b.pixelRatio||
1)};c.prototype.renderRegularEdges=function(a,b,d){this.render(this.programs.regular,a,a.regular.vao,b,d)};c.prototype.renderSilhouetteEdges=function(a,b,d){this.render(this.programs.silhouette,a,a.silhouette.vao,b,d)};c.prototype.render=function(a,b,d,c,e){this.setUniforms(a,b,c);this.rctx.bindVAO(d);this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,e)};c.prototype.setUniforms=function(a,b,d){b.components.buffer.textureBuffer.bind(a,e.componentDataBindParameters);a.setUniformMatrix4fv("uView",
d.view);a.setUniformMatrix4fv("uModel",b.transform.modelMatrix);var c=d.viewInvTransp,f=p.mat3.fromMat4(this.tmpViewToWorldNormalMatrix,c);a.setUniform3f("uCameraPosition",c[3],c[7],c[11]);a.setUniformMatrix3fv("uViewToWorldNormalMatrix",f);"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(a);a.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(d.fovY/2)/(d.viewport[3]/2));a.setUniform3fv("uLocalOrigin",b.transform.origin.vec3);this.settings.slicePlaneEnabled&&r.bindSlicePlane(b.transform.origin.vec3,
d.slicePlane,a)};c.prototype.setSketchUniforms=function(a){var b=this.settings.strokesTexture,c=b.texture;this.rctx.bindTexture(c,0);a.setUniform1i("uStrokesTexture",0);a.setUniform2f("uStrokesTextureScale",1/c.descriptor.width,1/c.descriptor.height);a.setUniform1f("uStrokesLog2Resolution",n.log2(b.resolution));a.setUniform1f("uStrokesNormalizationScale",b.normalizationScale);a.setUniform1f("uStrokesAmplitude",b.amplitude);a.setUniform1f("uStrokeVariants",b.variants)};c.prototype.getOptions=function(a){return l({},
a,{antialiasing:!!this.rctx.capabilities.blendMinMax,mode:this.settings.type,slice:this.settings.slicePlaneEnabled})};c.prototype.createPrograms=function(){var a=this.programRepository.getProgram(m.program,this.getOptions({silhouette:!1})),b=this.programRepository.getProgram(m.program,this.getOptions({silhouette:!0}));this.programRepository.increaseRefCount(a);this.programRepository.increaseRefCount(b);this.programs={regular:a,silhouette:b}};c.prototype.sortRenderables=function(){var a=this;this.renderablesDirty=
!1;this.sortedRenderables[1][1].clear();this.sortedRenderables[1][2].clear();this.sortedRenderables[2][1].clear();this.sortedRenderables[2][2].clear();this.renderables.forEach(function(b){switch(b.objectTransparency){case 1:case 2:switch(b.edgeTransparency){case 1:case 2:a.sortedRenderables[b.objectTransparency][b.edgeTransparency].push(b)}}});var b=function(a,b){return a.transform.origin.id<b.transform.origin.id?-1:a.transform.origin.id>b.transform.origin.id?1:0};this.sortedRenderables[1][1].sort(b);
this.sortedRenderables[1][2].sort(b);this.sortedRenderables[2][1].sort(b);this.sortedRenderables[2][2].sort(b)};c.getKey=function(a,b){return"edges-t:"+a+":"+b};return c}();e.EdgeRenderer=k;e.componentDataBindParameters={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2}});