// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../Color ../../../../core/lang ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ./ElevationAligners ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lodResourceUtils ./objectResourceUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/lib/Util ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(H,I,V,J,K,W,L,P,r,Q,t,R,m,g,u,v,X,Y,Z,n,aa,y,S,ba,M,ca,A,T,da,ea,B,fa,N){Object.defineProperty(I,"__esModule",{value:!0});H=function(C){function c(b,a,d,f){b=C.call(this,b,a,d,f)||this;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;return b}V(c,C);c.prototype.getCachedSize=function(){var b=this._symbolSize;return{width:b[0],depth:b[1],height:b[2]}};c.prototype.doLoad=function(b){return K(this,void 0,void 0,function(){var a,d,f,e;return J(this,function(c){switch(c.label){case 0:a=
this._getIdHint("_objectmat");if(!this._isPropertyDriven("size")&&(d=y.validateSymbolLayerSize(this.symbolLayer)))throw Error();f=this.symbolLayer;return this.isByResource?[4,this._prepareModelResources(f.resource.href,b)]:[3,2];case 1:return c.sent(),[3,4];case 2:return e=f.resource?f.resource.primitive:X.defaultPrimitive,[4,this._preparePrimitiveResources(e,a)];case 3:c.sent(),c.label=4;case 4:return[2]}})})};Object.defineProperty(c.prototype,"isByResource",{get:function(){return!(!this.symbolLayer.resource||
!this.symbolLayer.resource.href)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0});c.prototype._preparePrimitiveResources=function(b,a){return K(this,void 0,void 0,function(){var d,f,c,h,k,z,p,l,w,q,D,E;return J(this,function(e){if(!M.isValidPrimitive(b))throw Error("Unknown object symbol primitive: "+b);d=this.symbolLayer;this._resourceBoundingBox=v.create(M.primitiveBoundingBox(b));this._resourceSize=
g.vec3f64.fromArray(v.size(this._resourceBoundingBox));this._symbolSize=g.vec3f64.fromArray(y.computeSizeWithResourceSize(this._resourceSize,d));this._isWosr=this._isEsriSymbolResource=!1;f=r.get(this.symbolLayer,"material","color");c=this._getCombinedOpacity(f);h={specular:[0,0,0],opacity:c,transparent:1>c||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:g.vec3f64.ONES,diffuse:g.vec3f64.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows};
k=this.symbol;"point-3d"===k.type&&k.verticalOffset&&(z=k.verticalOffset,p=z.screenLength,l=z.minWorldLength,w=z.maxWorldLength,h.verticalOffset={screenLength:Q.pt2px(p),minWorldLength:l||0,maxWorldLength:null!=w?w:Infinity},h.castShadows=!1);this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._isPropertyDriven("color")?h.externalColor=u.vec4f64.ONES:(q=r.isSome(d.material)&&d.material.color,D=r.isSome(q)?L.toUnitRGBA(q):
u.vec4f64.ONES,h.externalColor=D);this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(P.mixin(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));E=new fa(W({},h,N.returnDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled),{offsetTransparentBackfaces:this.symbolLayer.isPrimitive}),
a);this._lodResources=M.primitiveLodResources(b,E,a);this._originalOpacities=B.materialsFromLodResources(this._lodResources).map(function(){return 1});if(!this._lodResources)throw Error("Unknown object symbol primitive: "+b);this._finalizeSymbolResources();this._initializeLodRenderer();this.complexity=this.computeComplexity();return[2]})})};c.prototype._prepareModelResources=function(b,a){return K(this,void 0,void 0,function(){var d,f,c,h,k,z,p,l,w,q,D,E,m,n,u,x,t,C=this;return J(this,function(e){switch(e.label){case 0:return d=
["transformation"],f={instanced:d,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},c={materialParamsMixin:f,streamDataRequester:this._context.streamDataRequester},this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(P.mixin(c.materialParamsMixin,this._fastUpdates.materialParameters),d.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&
(d.push("color"),this._optionalFields.push("color")),h=this.symbol,"point-3d"===h.type&&h.verticalOffset&&(k=h.verticalOffset,z=k.screenLength,p=k.minWorldLength,l=k.maxWorldLength,c.materialParamsMixin.verticalOffset={screenLength:Q.pt2px(z),minWorldLength:p||0,maxWorldLength:null!=l?l:Infinity},c.materialParamsMixin.castShadows=!1),c.signal=a,c.usePBR=this._context.physicalBasedRenderingEnabled,[4,ba.fetch(b,c)];case 1:return w=e.sent(),this._isEsriSymbolResource=w.isEsriSymbolResource,this._isWosr=
w.isWosr,q=S.makeLodResources(w.lods),S.fillEstimatedMinScreenSpaceRadius(q),q.levels.sort(function(a,b){return a.minScreenSpaceRadius-b.minScreenSpaceRadius}),q.levels[0].minScreenSpaceRadius=Math.min(2,q.levels[0].minScreenSpaceRadius),this._lodResources=q,D=this._context,E=this.symbolLayer.material,m=this._getExternalColorParameters(E),n=r.get(this.symbolLayer,"material","color"),u=this._getCombinedOpacity(n,{hasIntrinsicColor:!0}),x=this._isPropertyDriven("opacity"),t=B.materialsFromLodResources(this._lodResources),
this._originalOpacities=t.map(function(a){return a.getParameters().opacity||1}),t.forEach(function(a){var b=a.getParameters();a.setParameterValues(m);var d=b.opacity*u;a.setParameterValues({opacity:d,transparent:1>d||x||b.transparent});D.screenSizePerspectiveEnabled&&a.setParameterValues({screenSizePerspective:D.sharedResources.screenSizePerspectiveSettings})}),this._resourceBoundingBox=w.referenceBoundingBox,this._resourceSize=g.vec3f64.fromArray(v.size(this._resourceBoundingBox)),this._pivotOffset=
g.vec3f64.fromArray(this._lodResources.levels[0].pivotOffset),this._symbolSize=g.vec3f64.fromArray(y.computeSizeWithResourceSize(this._resourceSize,this.symbolLayer)),A.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions())&&t.forEach(function(a){return a.setParameterValues(C._fastUpdates.materialParameters)}),this._finalizeSymbolResources(),this._initializeLodRenderer(),this.complexity=this.computeComplexity(),[2]}})})};c.prototype._finalizeSymbolResources=
function(){var b=this._context.stage;this._materials=B.materialsFromLodResources(this._lodResources);this._materials.forEach(function(a){b.add(3,a)});this._textures=B.texturesFromLodResources(this._lodResources);this._textures.forEach(function(a){b.add(4,a)});this._geometries=B.geometriesFromLodResources(this._lodResources);this._geometries.forEach(function(a){b.add(2,a)})};c.prototype._initializeLodRenderer=function(){var b=this,a=this._context.stage;this._lodRenderer=new ea.LodRenderer(this._lodResources,
this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:function(a){return b._instanceIndexToGraphicUid.get(a)}},this._fastUpdates.enabled?{applyTransform:function(a,f,c){a.getFeatureAttribute(f,F);t.mat4.copy(c,A.evaluateModelTransform(b._fastUpdates.materialParameters,F,c))},scaleFactor:function(a,c,e){c.getFeatureAttribute(e,F);return A.evaluateModelTransformScale(a,b._fastUpdates.materialParameters,F)}}:null);this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;a.addRenderPlugin(this._lodRenderer.slots,
this._lodRenderer)};c.prototype._getExternalColorParameters=function(b){var a={};this._isPropertyDriven("color")?a.externalColor=u.vec4f64.ONES:r.isSome(b)&&r.isSome(b.color)?a.externalColor=L.toUnitRGBA(b.color):(a.externalColor=u.vec4f64.ONES,a.colorMixMode="ignore");return a};c.prototype.destroy=function(){C.prototype.destroy.call(this);var b=this._context.stage;this._lodRenderer&&(b.removeRenderPlugin(this._lodRenderer),this._lodRenderer.destroy());this._materials&&this._materials.forEach(function(a){return b.remove(3,
a.id)});this._textures&&this._textures.forEach(function(a){return b.remove(4,a.id)});this._geometries&&this._geometries.forEach(function(a){return b.remove(2,a.id)})};c.prototype.createGraphics3DGraphic=function(b){var a=b.graphic;if(!this._validateGeometry(a.geometry))return null;var d=n.placePointOnGeometry(a.geometry);if(r.isNone(d))return this.logger.warn("unsupported geometry type for icon symbol: "+a.geometry.type),null;var c=this.getGraphicElevationContext(a);return this._createAs3DShape(a,
d,b.renderingInfo,c,a.uid)};c.prototype.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};c.prototype.graphicLayerToGraphicId=function(b){return 0};c.prototype.layerOpacityChanged=function(){var b=this,a=this._isPropertyDriven("opacity"),d=this.isByResource;this._materials.forEach(function(c,e){var f=r.get(b.symbolLayer,"material","color");e=b._getCombinedOpacity(f,{hasIntrinsicColor:d})*b._originalOpacities[e];c.setParameterValues({opacity:e,transparent:1>
e||a})});return!0};c.prototype.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,n.needsElevationUpdates3D)};c.prototype.slicePlaneEnabledChanged=function(b,a){var d=this;this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;this._materials.forEach(function(a){a.setParameterValues({slicePlaneEnabled:d._context.slicePlaneEnabled})});return!0};c.prototype.physicalBasedRenderingChanged=function(b,a){var d=this;this._materials.forEach(function(a){d.isByResource?
d._isEsriSymbolResource&&!d._isWosr&&a.setParameterValues(N.returnDefaultPBRMaterialParameters(d._context.physicalBasedRenderingEnabled,a.getParameters().treeRendering)):a.setParameterValues(N.returnDefaultPBRMaterialParameters(d._context.physicalBasedRenderingEnabled))});return!0};c.prototype.pixelRatioChanged=function(b,a){return!0};c.prototype.applyRendererDiff=function(b,a){var d=this,c;for(c in b.diff)switch(c){case "visualVariables":if(A.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions()))this._materials.forEach(function(a){return a.setParameterValues(d._fastUpdates.materialParameters)}),
this._lodRenderer.notifyShaderTransformationChanged();else return!1;break;default:return!1}return!0};c.prototype.computeComplexity=function(){if(!this._lodResources)return C.prototype.computeComplexity.call(this);var b=B.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(a,b){return a+b.data.getIndices(da.VertexAttrConstants.POSITION).length},0)/3,a=ca.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,
estimated:!1,memory:a}};c.prototype._createAs3DShape=function(b,a,d,c,e){b=this.getFastUpdateAttrValues(b);var f=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?y.mixinColorAndOpacity(d.color,d.opacity):null,k=this._context.clippingExtent;T.pointToVector(a,x,this._context.elevationProvider.spatialReference);if(k&&!n.pointInBox2D(x,k))return null;var k=this._requiresTerrainElevation(c),g=this._computeGlobalTransform(a,c,O,k?G:null);d=this._computeLocalTransform(this.symbolLayer,d,U);var p=
this._lodRenderer.instanceData,l=p.addInstance();this._instanceIndexToGraphicUid.set(l,e);p.setLocalTransform(l,d,!1);p.setGlobalTransform(l,g);b&&p.setFeatureAttribute(l,b);f&&p.setColor(l,f);e=new Z(this,l,Y.perLodInstanceElevationAligner,c);k&&(e.alignedTerrainElevation=G.terrainElevation);e.needsElevationUpdates=n.needsElevationUpdates3D(c.mode);n.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);return e};c.prototype._computeGlobalTransform=function(b,a,d,c){a=n.computeElevation(this._context.elevationProvider,
b,a,this._context.renderCoordsHelper,c);x[0]=b.x;x[1]=b.y;x[2]=a;T.computeLinearTransformation(b.spatialReference,x,d,this._context.renderSpatialReference);return d};c.prototype._computeLocalTransform=function(b,a,d){t.mat4.identity(d);this._applyObjectRotation(a,!1,d);this._applyObjectRotation(b,!0,d);this._applyObjectScale(a,d);this._applyAnchor(b,d);return d};c.prototype._applyObjectScale=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._isPropertyDriven("size")&&
b.size?b.size:this._symbolSize,b=y.computeObjectScale(b,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||t.mat4.scale(a,a,b))};c.prototype.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}};c.prototype.updateGeometry=function(b,a){var d=a&&n.placePointOnGeometry(a);if(r.isNone(d))return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==
a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(d,b.elevationContext,O,a?G:null);a&&(b.alignedTerrainElevation=G.terrainElevation);this._lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,O,!0);n.extendPointGraphicElevationContext(b,d,this._context.elevationProvider);return!0};c.prototype._preparePatchTransform=function(b,a){var d=this;if(a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition){var c=function(a,b,c){return(null!=
a&&"complete"===a.type?a.newValue:b)||c},e=c(a.heading,this.symbolLayer.heading,0),h=c(a.tilt,this.symbolLayer.tilt,0),k=c(a.roll,this.symbolLayer.roll,0),m=c(a.width,this.symbolLayer.width,void 0),p=c(a.height,this.symbolLayer.height,void 0),l=c(a.depth,this.symbolLayer.depth,void 0),n=c(a.anchor,this.symbolLayer.anchor,void 0),c=c(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;
var q={heading:e,tilt:h,roll:k,anchor:n,anchorPosition:c};1===this.loadStatus&&b.symbolLayerStatePatches.push(function(){d._symbolSize=g.vec3f64.fromArray(y.computeSizeWithResourceSize(d._resourceSize,{width:m,height:p,depth:l,isPrimitive:d.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push(function(a,b){b=d._computeLocalTransform(q,b,U);d._lodRenderer.instanceData.setLocalTransform(a.instanceIndex,b,!0)})}};c.prototype._preparePatchColor=function(b,a){var c=this;if(a.material&&"partial"===
a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type)){var f=a.color.newValue,e=r.isSome(f)?L.toUnitRGBA(f):u.vec4f64.ONES;delete a.color;b.graphics3DGraphicPatches.push(function(a,b){if(c._hasPerInstanceColor())c._lodRenderer.instanceData.setColor(a.instanceIndex,e);else for(a=0,b=c._materials;a<b.length;a++)b[a].setParameterValues({externalColor:e})})}};c.prototype._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};c.prototype._applyObjectRotation=function(b,
a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return y.computeObjectRotation(b.heading,b.tilt,b.roll,c)};c.prototype._computeAnchor=function(b){var a=g.vec3f64.create();switch(b.anchor){case "center":m.vec3.copy(a,v.center(this._resourceBoundingBox));m.vec3.negate(a,a);break;case "top":var c=v.center(this._resourceBoundingBox);m.vec3.set(a,-c[0],-c[1],-this._resourceBoundingBox[5]);break;case "bottom":c=v.center(this._resourceBoundingBox);m.vec3.set(a,-c[0],
-c[1],-this._resourceBoundingBox[2]);break;case "relative":var c=v.center(this._resourceBoundingBox),f=v.size(this._resourceBoundingBox);b=(b=b.anchorPosition)?g.vec3f64.fromValues(b.x,b.y,b.z):g.vec3f64.ZEROS;m.vec3.multiply(a,f,b);m.vec3.add(a,a,c);m.vec3.negate(a,a);break;default:this._pivotOffset?m.vec3.negate(a,this._pivotOffset):m.vec3.copy(a,g.vec3f64.ZEROS)}return a};c.prototype._applyAnchor=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b))&&
t.mat4.translate(a,a,b)};c.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};c.prototype._fastVisualVariableConvertOptions=function(){var b=this._resourceBoundingBox?g.vec3f64.fromArray(v.size(this._resourceBoundingBox)):g.vec3f64.ONES,a=this._resourceBoundingBox?this._computeAnchor(this.symbolLayer):g.vec3f64.ZEROS,c=this._context.renderCoordsHelper.unitInMeters,f=y.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,
c),e=g.vec3f64.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:b,symbolSize:this._symbolSize||g.vec3f64.ONES,unitInMeters:c,transformation:{anchor:a,scale:f,rotation:e}}};return c}(aa.default);I.Graphics3DObjectSymbolLayer=H;var x=g.vec3f64.create(),U=R.mat4f64.create(),O=R.mat4f64.create(),F=u.vec4f64.create(),G={verticalDistanceToGround:0,terrainElevation:0};I.default=H});