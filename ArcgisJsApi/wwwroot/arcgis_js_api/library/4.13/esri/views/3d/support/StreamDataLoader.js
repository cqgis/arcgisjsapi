// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../request ../../../core/Accessor ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/now ../../../core/promiseUtils ../../../core/accessorSupport/decorators ./AsyncQuotaRoundRobinQueue ../webgl-engine/lib/Util ../../../views/support/Scheduler".split(" "),function(e,g,n,r,t,u,v,w,x,p,q,k,m,y,z,A){Object.defineProperty(g,"__esModule",{value:!0});
e=function(e){function b(){var a=null!==e&&e.apply(this,arguments)||this;a.tasks=new Map;a.doneQueue=[];a.updating=!1;return a}r(b,e);b.prototype.setup=function(a,c){var f=this;this.loadQueue=new y.AsyncQuotaRoundRobinQueue(function(a,c){return f.startLoading(a,c)},function(a,c){return f.doneLoadingCallback(a,c)},a);c&&(this.taskHandle=c.registerTask(A.Task.STREAM_DATA_LOADER,function(a){return f.update(a)},function(){return 0<f.doneQueue.length}))};b.prototype.destroy=function(){this.taskHandle&&
(this.taskHandle.remove(),this.taskHandle=null);this.tasks.forEach(function(a){a.abortController&&a.abortController.abort()});this.loadQueue.clear();this.tasks=this.doneQueue=this.loadQueue=null};Object.defineProperty(b.prototype,"busy",{get:function(){return this.loadQueue.busy},enumerable:!0,configurable:!0});b.prototype.request=function(a,c,f,d){var b=this,l=k.createResolver();l.__signal=p.isSome(d)?d.signal:null;var e=p.isSome(d)&&d.uid||a,g=this.createOrUpdateTask(a,c,f,e,l);k.onAbort(d,function(){return b.cancelRequest(g,
l)});return l.promise};b.prototype.createTask=function(a,c,b,d,h){a={url:a,docType:c,clientType:b,key:d,result:null,status:1,resourceRequest:null,abortController:null,resolvers:[],_cancelledInQueue:!1,startTime:0,duration:0,size:0};this.updateTask(a,h);this.tasks.set(d,a);1===this.tasks.size&&this._set("updating",!0);this.loadQueue.push(a);return a};b.prototype.cancelRequest=function(a,c){v.removeUnordered(a.resolvers,c);c.reject(k.createAbortError());0===a.resolvers.length&&(2===a.status&&(a.status=
4,this.loadQueue.workerCancelled(a),a.abortController.abort(),a.resourceRequest=null,a.abortController=null),a.status=4,this.tasks.delete(a.key),0===this.tasks.size&&this._set("updating",!1))};b.prototype.taskKey=function(a,c,b){return a+":"+c+":"+b};b.prototype.updateTask=function(a,c){a.resolvers.push(c)};b.prototype.createOrUpdateTask=function(a,c,b,d,h){d=this.taskKey(d,c,b);var f=this.tasks.get(d);return f?(this.updateTask(f,h),f):this.createTask(a,c,b,d,h)};b.prototype.doneLoadingCallback=function(a,
c){z.assert(2===a.status);a.status=3;this.taskHandle?this.doneQueue.push({task:a,err:c}):this.doneLoading(a,c)};b.prototype.update=function(a){for(;!a.done&&0<this.doneQueue.length;){var c=this.doneQueue.shift();3!==c.task.status&&(c.err=c.err||k.createAbortError());this.doneLoading(c.task,c.err);a.madeProgress()}};b.prototype.doneLoading=function(a,c){for(var b=a.result instanceof HTMLImageElement?0:a.resolvers.length,d=0,h=a.resolvers;d<h.length;d++){var e=h[d];if(c)k.isAbortError(c)?e.reject(c):
e.reject(new w("stream-data-loader:request-error","Failed to request resource at '"+a.url+"'. "+c,{url:a.url,error:c}));else{--b;var g=0>=b?a.result:x.clone(a.result);e.resolve(g)}}this.tasks.delete(a.key);0===this.tasks.size&&this._set("updating",!1)};b.prototype.startLoading=function(a,c){if(4===a.status)return!1;a.status=2;var b,d;switch(a.docType){case "binary":d="array-buffer";b=0;break;case "image":d="image";break;default:d="json"}a.startTime=q();a.abortController=k.createAbortController();
a.resourceRequest=t(a.url,{responseType:d,timeout:b,signal:a.abortController.signal});a.resourceRequest.then(function(b){a.duration=q()-a.startTime;a.size="binary"===a.docType?b.data.byteLength:0;a.result=b.data;a.abortController=null;c(a)},function(b){2===a.status&&c(a,b)});return!0};Object.defineProperty(b.prototype,"test",{get:function(){return{loadQueue:this.loadQueue}},enumerable:!0,configurable:!0});n([m.property({readOnly:!0})],b.prototype,"updating",void 0);return b=n([m.subclass("esri.views.3d.support.StreamDataLoader")],
b)}(m.declared(u));g.StreamDataLoader=e;g.default=e});