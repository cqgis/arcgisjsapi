// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/mathUtils ../../../core/maybe ../../../core/scheduling ../../../core/screenUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/Point ../../../geometry/support/aaBoundingRect ../../../symbols/SimpleMarkerSymbol ../state/utils/viewUtils ../support/animationUtils ../support/debugFlags ../support/debugFlags ../support/earthUtils ../support/mathUtils ../support/projectionUtils ../support/stack ../webgl-engine/lib/Intersector ../webgl-engine/lib/localOrigin ../../support/Scheduler".split(" "),
function(C,D,M,v,N,O,P,Q,w,R,S,T,E,u,U,t,z,r,F,V,g,W,X,Y,Z,aa,ba,G,y,H,ca,I,da){function ea(g,c){for(var a=Z.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1E-5*Math.max(g[2]-g[0],g[3]-g[1],c[2]-c[0],c[3]-c[1]),b=0;4>b;b++)if(Math.abs(c[b]-g[b])>a)return!0;return!1}Object.defineProperty(D,"__esModule",{value:!0});var fa=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],B;C=function(A){function c(){var a=null!==A&&A.apply(this,
arguments)||this;a._handles=new P;a._overlaySR=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._connectedLayers=new Map;a._overlays=null;a._renderedAltitude=0;a._placementDirty=!1;a._drawTexturesDirty=!1;a._drawTexturesAnimateDirty=!1;a._isSpherical=!1;a._latestOriginId=0;a._maxResolution=Q("esri-mobile")?2048:4096;a._animationTimeLast=0;a.opacity=0;return a}M(c,A);Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0});
c.prototype.initialize=function(){var a=this;this._stage=this.view._stage;this._renderer=this._stage.renderView.getDrapedRenderer();this._renderer.onHasHighlightsChanged=function(){return a.onHasHighlightsChanged()};this._renderer.onContentChanged=function(){return a.setDrawTexturesDirty()};this._renderer.onUpdatingChanged=function(){return a._setOverlayUpdating()};this._renderer.forceUpdate=function(b){a.updateOverlays(b);a._drawOverlayTextures()};this.groundIntersector=new ca(this.view.viewingMode);
this.groundIntersector.enable.backfacesTerrain=!0;this.groundIntersector.enable.invisibleTerrain=!0;this.groundIntersector.enable.hud=!1;this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],function(){return a.setOverlayPlacementDirty()}),this.terrainSurface.on("elevation-change",function(){return a.setOverlayPlacementDirty()}),this.view.on("resize",function(){return a.setOverlayPlacementDirty()}),this.watch("suspended",
function(){return a._setOverlayUpdating()},!0),T.addFrameTask({preRender:function(b){a.hasOverlays()&&(a._dispatchRendererUpdate(b),a._drawOverlayTextures())}}),this.view.resourceController.scheduler.registerTask(da.Task.OVERLAY_MANAGER,function(){return a.updateOverlays()},function(){return a.needsUpdate()})])};c.prototype.destroy=function(){var a=this;this._connectedLayers.forEach(function(b){return a._unregisterLayerView(b.layerView)});this._disposeOverlays();this._handles&&(this._handles.destroy(),
this._handles=null)};c.prototype.onHasHighlightsChanged=function(){this.setOverlayPlacementDirty();this.notifyChange("hasHighlights")};c.prototype.hasOverlays=function(){return!!this._overlays};c.prototype.setSpatialReference=function(a,b){(this._overlaySR=a)?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._longitudeCyclical=(this._isSpherical=b)?a.isWebMercator?new G.Cyclical(-2.0037508342788905E7,2.0037508342788905E7):new G.Cyclical(-180,
180):null):(this._disposeOverlays(),this._longitudeCyclical=null)};c.prototype.updateLayerViews=function(a){for(var b=this,d=0,e=this.view.allLayerViews.items;d<e.length;d++){var c=e[d];"supportsDraping"in c&&c.supportsDraping&&!this._connectedLayers.has(c.uid)&&this._registerLayerView(c)}this._connectedLayers.forEach(function(d,e){d=d.layerView;a.has(e)||b._unregisterLayerView(d)})};c.prototype._registerLayerView=function(a){var b=this,d=a.uid,e=a.on("draped-data-change",function(){return b.setOverlayPlacementDirty()});
this._connectedLayers.set(d,{eventHandles:[e],layerView:a});a.setDrapingExtent&&this._overlays&&this._overlays.forEach(function(d,e){a.setDrapingExtent(e,d.extent,b._overlaySR,d.resolution,d.renderLocalOrigin,d.pixelRatio)});this.setOverlayPlacementDirty();this._setLayerViewOverlayUpdating(a,this.layerViewOverlayUpdating)};c.prototype._unregisterLayerView=function(a){var b=this;this._connectedLayers.forEach(function(d,e){if(d.layerView===a){if(d.eventHandles)for(var c=0;c<d.eventHandles.length;c++)d.eventHandles[c].remove();
b._connectedLayers.delete(e);b.setOverlayPlacementDirty();a.destroyed||b._setLayerViewOverlayUpdating(a,!1)}})};c.prototype.setOverlayPlacementDirty=function(){this._placementDirty||(this._placementDirty=!0,this._setOverlayUpdating())};c.prototype.updateOverlays=function(a){void 0===a&&(a=this.view.state.camera);if(this._overlaySR){var b;b=w.nextHighestPowerOfTwo(Math.max(a.fullWidth,a.fullHeight)+256);var d=Math.min(b,this._maxResolution);this._computeOverlayExtents(a,b,x);this._initOverlays();this._updateOverlay(0,
x.inner,d,1);this._updateOverlay(1,x.outer,d,g.width(x.inner)/g.width(x.outer));this.opacity=1;this.terrainSurface.updateTileOverlayParams();this._placementDirty=!1;this.setDrawTexturesDirty();this.terrainSurface.updateOverlayOpacity()}};c.prototype._updateOverlay=function(a,b,d,e){var c=this,f=this._overlays[a];if(ea(b,f.extent)||d!==f.resolution||f.pixelRatio!==e)g.set(f.extent,b),f.resolution=d,f.pixelRatio=e,e=g.center(f.extent),f.renderLocalOrigin=I.fromValues(e[0],e[1],0,"OV_"+this._latestOriginId++),
this._connectedLayers.forEach(function(e){e=e.layerView;e.setDrapingExtent&&e.setDrapingExtent(a,b,c._overlaySR,d,f.renderLocalOrigin,f.pixelRatio)})};c.prototype.needsUpdate=function(){return this._placementDirty&&!!this._overlaySR&&!this._get("suspended")&&this.terrainSurface.ready};c.prototype.updateOpacity=function(a){return this._overlays?this._getAltitudeBasedOpacity(a,this._renderedAltitude):1};c.prototype._getAltitudeBasedOpacity=function(a,b){return 3.5*a<b?Math.sqrt(w.clamp((a-b/10)/(b/
3.5-b/10),0,1)):1};c.prototype.setOverlayParamsOfTile=function(a,b,d){var e=this._overlays[0],c=this._overlays[1];a=g.intersection(a.extent,a.surface.extent,J);this._rectInsideRect(a,e.extent)?(this._setTileOverlayData(a,e,b.overlays[0]),this._invalidateTileOverlayData(b.overlays[1])):this._rectanglesOverlap(a,e.extent)?(this._setTileOverlayData(a,e,b.overlays[0]),this._setTileOverlayData(a,c,b.overlays[1])):(this._rectanglesOverlap(a,c.extent)?this._setTileOverlayData(a,c,b.overlays[0]):this._invalidateTileOverlayData(b.overlays[0]),
this._invalidateTileOverlayData(b.overlays[1]));b.overlayOpacity=void 0!==d?d:1};c.prototype.overlayPixelSizeInMapUnits=function(a){if(!this._overlays)return 0;var b=this._overlays[0],d=this._overlays[1];a=this._pointIsInExtent(a,b.extent)?b:d;return(a.extent[2]-a.extent[0])/a.resolution};c.prototype._setTileOverlayData=function(a,b,d){var e=b.extent;d.texScale[0]=(a[2]-a[0])/(e[2]-e[0]);d.texScale[1]=(a[3]-a[1])/(e[3]-e[1]);var c=a[0];if(this._longitudeCyclical){var c=this._longitudeCyclical.minimalMonotonic(e[0],
c),f=this._longitudeCyclical.minimalMonotonic(e[0],a[2]);c>f&&(c=f-(a[2]-a[0]))}d.texOffset[0]=(c-e[0])/(e[2]-e[0]);d.texOffset[1]=(a[1]-e[1])/(e[3]-e[1]);d.renderTargetId=b.valid?b.renderTargetId:null;d.highlightRenderTargetId=b.highlightValid?b.highlightRenderTargetId:null;d.waterMaskRenderTargetId=b.waterMaskValid?b.waterMaskRenderTargetId:null};c.prototype._invalidateTileOverlayData=function(a){a.renderTargetId=null;a.highlightRenderTargetId=null;a.waterMaskRenderTargetId=null};c.prototype._createEmptyOverlay=
function(a){var b=this._renderer.createRenderTarget("overlay"+a,!0,8,9987),d=this._renderer.createRenderTarget("overlayHighlight"+a,!1,8,9987);a=this._renderer.createRenderTarget("overlayWaterMask"+a,!0,8,9987);return{extent:g.create(),resolution:0,renderTargetId:b,valid:!1,highlightRenderTargetId:d,highlightValid:!1,waterMaskRenderTargetId:a,waterMaskValid:!1,renderLocalOrigin:I.fromValues(0,0,0,"O"),pixelRatio:1}};c.prototype._initOverlays=function(){this._overlays||(this._overlays=[this._createEmptyOverlay(0),
this._createEmptyOverlay(1)])};c.prototype._disposeOverlays=function(){var a=this;this._overlays&&(this._overlays.forEach(function(b){a._renderer.disposeRenderTarget(b.renderTargetId);a._renderer.disposeRenderTarget(b.highlightRenderTargetId);a._renderer.disposeRenderTarget(b.waterMaskRenderTargetId)}),this._overlays=null)};c.prototype._dispatchRendererUpdate=function(a){var b=a.time-this._animationTimeLast;b<Y.DESIRED_DRAPED_ANIMATION_MS||(this._animationTimeLast=a.time,this._renderer.updateLogic({dt:b,
camera:this._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0))};c.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty||(this._drawTexturesDirty=!0,this._setOverlayUpdating()):this.setOverlayPlacementDirty()};c.prototype._intersectGroundFromView=function(a,b,d,e){var c=E.createRenderScreenPointArray3(b*a.fullWidth,d*a.fullHeight,1),c=a.unprojectPoint(c,H.sv3d.get());b=E.createRenderScreenPointArray3(b*a.fullWidth,d*a.fullHeight,0);b=a.unprojectPoint(b,H.sv3d.get());
this.groundIntersector.intersect([],b,c,null,a,null,!1);this.view.basemapTerrain.intersect(this.groundIntersector,null,b,c);return this.groundIntersector.results.min.getIntersectionPoint(e)};c.prototype._setLayerViewOverlayUpdating=function(a,b){"overlayUpdating"in a&&(a.overlayUpdating=b)};Object.defineProperty(c.prototype,"layerViewOverlayUpdating",{get:function(){return this.needsUpdate()||this._drawTexturesDirty||this._renderer.updating},enumerable:!0,configurable:!0});c.prototype._setOverlayUpdating=
function(){var a=this,b=this.layerViewOverlayUpdating;this._connectedLayers.forEach(function(d){return a._setLayerViewOverlayUpdating(d.layerView,b)});var d=this.view.graphicsView;S.isSome(d)&&(d.overlayUpdating=b)};c.prototype._findHorizonBasedPointOfInterest=function(a,b,d){var e=.5;if("global"===this.view.viewingMode){e=z.vec3f64.clone(a.eye);t.vec3.normalize(e,e);t.vec3.negate(e,e);b=t.vec3.length(b);b=Math.asin(b/t.vec3.length(a.eye));var c=Math.acos(t.vec3.dot(a.viewForward,e)),e=w.clamp((b-
(c-.5*a.fovY))/a.fovY,0,1);b=w.clamp((-b-(c-.5*a.fovY))/a.fovY,0,1);e=1===e&&0===b?.5:b+.55*(e-b)}else e=F.vec4f64.fromValues(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),1,0),e=r.vec4.transformMat4(e,e,a.projectionMatrix)[1],e=w.clamp(.5+.5*e,0,1),e=1===e||0===e?.5:0<a.eye[2]?.55*e:1-.55*(1-e);return this._intersectGroundFromView(a,.5,e,d)?!0:!1};c.prototype._computeOverlayExtents=function(a,b,d){var c=this.terrainSurface.extent,k=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,
f=z.vec3f64.create();this._findHorizonBasedPointOfInterest(a,k,f)||t.vec3.copy(f,k);this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(a.eye);var h=t.vec3.distance(a.eye,f),k=X.viewAngle(this.view.renderCoordsHelper,k,a.eye),k=Math.PI/2-Math.abs(k-Math.PI/2);if(aa.OVERLAY_SHOW_CENTER){var m=new W({color:[255,0,0],outline:{color:[255,255,255],width:2}}),l=new V;y.vectorToPoint(f,this._renderSR,l,this._overlaySR);m=new N({geometry:l,symbol:m});void 0!==B&&this.view.graphics.remove(B);this.view.graphics.add(m);
B=m}this._overlaySREqualsRenderSR||y.vectorToVector(f,this._renderSR,f,this._overlaySR);b=b*a.perRenderPixelRatio*h/2;l=!1;h=Infinity;this._isSpherical&&(this._overlaySR.isWebMercator?(b/=Math.cos(y.webMercator.y2lat(f[1])),h=this.terrainSurface.extent[3],h*=.999):(l=!0,b/=ba.metersPerDegree,h=90),b>=h&&(b=h,f[1]=0,this._overlaySR.isWebMercator&&(f[0]=0)));m=1;l&&(m=1/Math.max(.2,Math.cos(Math.abs(R.deg2rad(f[1])))),180<b*m&&(m=180/b));var n=b*m,l=d.inner;l[0]=f[0]-n;l[1]=f[1]-b;l[2]=f[0]+n;l[3]=
f[1]+b;this._isSpherical&&this._shiftExtentToFitBounds(l,Infinity,h);d=d.outer;g.set(d,l);6*n>c[2]-c[0]?g.set(d,c):k<=.25*Math.PI?(d[0]-=n,d[1]-=b,d[2]+=n,d[3]+=b):(y.vectorToVector(a.eye,this._renderSR,K,this._overlaySR),U.vec2.subtract(p,f,K),a=-Math.atan2(p[1],p[0])+.125*Math.PI,0>a&&(a+=2*Math.PI),r.vec4.scale(p,fa[Math.floor(a/(.25*Math.PI))],2*b),p[0]*=m,p[2]*=m,r.vec4.add(d,d,p));this._isSpherical&&(d[0]=this._longitudeCyclical.clamp(d[0]),d[2]=this._longitudeCyclical.clamp(d[2]),d[1]=Math.max(d[1],
-h),d[3]=Math.min(d[3],h));!this._isSpherical&&c&&(a=g.intersection(l,c,J),c=g.intersection(d,c,ga),g.contains(a,c)&&(d[2]=d[0],d[3]=d[1]))};c.prototype._drawOverlayTextures=function(){if(this._drawTexturesDirty||this._drawTexturesAnimateDirty){var a=this._drawOverlay(0),b=this._drawOverlay(1);0!==a&&0!==b||this.terrainSurface.updateTileOverlayParams();this._drawTexturesDirty?(this._drawTexturesAnimateDirty=this._drawTexturesDirty=!1,this._setOverlayUpdating(),this.terrainSurface.requestRender(),
this.terrainSurface.setPendingUpdates()):(this._drawTexturesAnimateDirty=!1,this._setOverlayUpdating(),this.terrainSurface.requestRender(0))}};c.prototype._drawOverlay=function(a){var b=this._overlays[a],d=b.valid,c=b.highlightValid,p=b.waterMaskValid,f=b.extent,h=b.resolution,m=b.pixelRatio,l=this._longitudeCyclical?f[2]>this._longitudeCyclical.max:!1,n=this._longitudeCyclical?f[0]<this._longitudeCyclical.min:!1;if(l||n){k.views=ha;var n=Math.round((l?this._longitudeCyclical.max-f[0]:this._longitudeCyclical.min-
f[0])/(f[2]-f[0])*h),q=k.views[0];r.vec4.set(q.viewport,0,0,n,h);r.vec4.set(q.extent,f[0],f[1],this._longitudeCyclical.max,f[3]);l||(q.extent[0]+=this._longitudeCyclical.range);q=k.views[1];r.vec4.set(q.viewport,n,0,h-n,h);r.vec4.set(q.extent,this._longitudeCyclical.min,f[1],f[2],f[3]);l&&(q.extent[2]-=this._longitudeCyclical.range)}else k.views=L,g.set(k.views[0].extent,f),r.vec4.set(k.views[0].viewport,0,0,h,h);k.width=h;k.height=h;k.pixelRatio=m*this.view.state.camera.pixelRatio;k.index=a;h=this._renderer;
a=h.draw(b.renderTargetId,k);f=h.drawHighlights(b.highlightRenderTargetId,k);h=h.drawNormals(b.waterMaskRenderTargetId,k);b.valid=a;b.highlightValid=f;b.waterMaskValid=h;return a!==d||f!==c||h!==p?0:1};c.prototype._rectanglesOverlap=function(a,b){return this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],b[2],a[0])||this._longitudeCyclical.contains(b[0],b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):g.intersects(a,b)};c.prototype._rectInsideRect=
function(a,b){return this._longitudeCyclical?this._longitudeCyclical.contains(b[0],b[2],a[0])&&this._longitudeCyclical.contains(b[0],b[2],a[2])&&a[1]>b[1]&&a[3]<b[3]:g.contains(b,a)};c.prototype._pointIsInExtent=function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];var c=a.x;a=a.y;return c>b[0]&&c<b[2]&&a>b[1]&&a<b[3]};c.prototype._shiftExtentToFitBounds=function(a,b,c){var d=0,k=0;a[0]<-b?d=a[0]+b:a[2]>b&&(d=b-a[2]);a[1]<-c?k=a[1]+c:
a[3]>c&&(k=c-a[3]);g.offset(a,d,k)};Object.defineProperty(c.prototype,"test",{get:function(){return{overlays:this._overlays,renderer:this._renderer}},enumerable:!0,configurable:!0});v([u.property()],c.prototype,"view",void 0);v([u.property()],c.prototype,"terrainSurface",void 0);v([u.property({readOnly:!0,aliasOf:"terrainSurface.suspended"})],c.prototype,"suspended",void 0);v([u.property({type:Boolean})],c.prototype,"hasHighlights",null);return c=v([u.subclass("esri.views.3d.terrain.OverlayManager")],
c)}(u.declared(O));D.OverlayManager=C;var k={width:0,height:0,pixelRatio:0,views:null,index:0},L=[{viewport:g.create(),extent:g.create()}],ha=[L[0],{viewport:g.create(),extent:g.create()}],p=F.vec4f64.create(),K=z.vec3f64.create(),x={inner:g.create(),outer:g.create()},J=g.create(),ga=g.create()});