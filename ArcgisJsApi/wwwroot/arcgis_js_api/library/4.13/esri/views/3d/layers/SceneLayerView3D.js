// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../geometry ../../../Graphic ../../../core/arrayUtils ../../../core/asyncUtils ../../../core/iteratorUtils ../../../core/Logger ../../../core/maybe ../../../core/unitUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/webMercatorUtils ../../../layers/support/fieldUtils ../../../tasks/support/Query ./I3SMeshView3D ./LayerView3D ./i3s/I3SGeometryUtil ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ./support/layerViewUpdatingProperties ./support/PopupSceneLayerView ../support/projectionUtils ../../layers/LayerView ../../layers/support/FeatureFilter ../../support/index".split(" "),
function(X,Y,Z,C,d,D,E,t,F,G,n,H,I,h,J,e,K,p,q,u,x,v,L,M,m,N,O,P,y,Q,R,S,T,z,U,V,W){var l=I.getLogger("esri.views.3d.layers.SceneLayerView3D"),A=R.defineFieldProperties(),B=[0,0,0,0];return function(w){function a(){var b=null!==w&&w.apply(this,arguments)||this;b._queryEngine=null;b.lodFactor=1;b.progressiveLoadFactor=1;b._elevationContext="scene";b._isIntegratedMesh=!1;b._asyncModuleLoading=0;b._projectionEngineLoaded=!1;return b}C(a,w);Object.defineProperty(a.prototype,"filter",{set:function(b){if(h.isNone(b))this._set("filter",
null);else{var c=["contains","intersects","disjoint"];b.timeExtent?(l.warn("Filters with a timeExtent are not supported for mesh scene layers"),this._set("filter",null)):b.spatialRelationship&&-1===c.indexOf(b.spatialRelationship)?(l.warn("Filters with spatialRelationship other than "+c.join(", ")+" are not supported for mesh scene layers"),this._set("filter",null)):this._set("filter",b)}},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"parsedFilterWhereClause",{get:function(){var b=
h.isSome(this.filter)?this.filter.where:null;if(!b)return null;try{return K.WhereClause.create(b,this.layer.fieldsIndex)}catch(c){l.error("Failed to parse filter where clause: "+c)}return null},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"parsedFilterGeometry",{get:function(){var b=this;if(h.isNone(this.filter))return null;var c=this.filter,f=c.geometry,a=c.distance;if(!a)return f;if(!this._geometryEngine)return null;c=c.units||J.getUnitString(f.spatialReference);if(f.spatialReference.isWGS84)return this._geometryEngine.geodesicBuffer(f,
a,c);if(u.canProject(f,t.SpatialReference.WGS84))return u.project(this._geometryEngine.geodesicBuffer(u.project(f,t.SpatialReference.WGS84),a,c),f.spatialReference);if(!p.isSupported())return l.error("Filter by geodesic buffer (distance) unsupported due to lack of projection support."),null;if(!this._projectionEngineLoaded&&(this._loadAsyncModule(p.load()).then(function(){b._set("_projectionEngineLoaded",!0)}),!this._projectionEngineLoaded))return null;var g=null;try{g=p.project(f,t.SpatialReference.WGS84)}catch(r){}if(g)try{g=
p.project(this._geometryEngine.geodesicBuffer(g,a,c),f.spatialReference)}catch(r){g=null}g||l.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry ("+f.spatialReference.wkid+") to WGS84.");return g},enumerable:!0,configurable:!0});a.prototype.initialize=function(){for(var b=this,c=0,a=["layer.renderer","definitionExpressionFields","filter"];c<a.length;c++){var k=a[c];this.updatingHandles.add(this,k,function(){return b._updateRequiredFields()})}this._updateRequiredFields();
this.updatingHandles.add(this.layer,"rangeInfos",function(c){return b._rangeInfosChanged(c)},2);this.updatingHandles.add(this.layer,"renderer",function(c){return b._rendererChange(c)},2);c=0;for(a=["parsedDefinitionExpression","layer.objectIdFilter","filter","parsedFilterWhereClause","parsedFilterGeometry"];c<a.length;c++)k=a[c],this.updatingHandles.add(this,k,function(){return b._filterChange()})};a.prototype.destroy=function(){};a.prototype._updateRequiredFields=function(){return E(this,void 0,
void 0,function(){var b,c,a,k,g,r,e,d;return D(this,function(f){switch(f.label){case 0:return b=this,a=c=b.layer,k=a.fields,g=a.renderer,r=b.definitionExpressionFields,e=b.filter,d=new Set,g?[4,g.collectRequiredFields(d,k)]:[3,2];case 1:f.sent(),f.label=2;case 2:return h.isSome(e)?[4,x.collectFilterFields(d,c,e)]:[3,4];case 3:f.sent(),f.label=4;case 4:return x.collectFields(d,k,r),this._set("requiredFields",H.valuesOfSet(d).sort()),[2]}})})};a.prototype._rangeInfosChanged=function(b){null!=b&&0<b.length&&
l.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};a.prototype.createQuery=function(){var b={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return h.isSome(this.filter)?this.filter.createQuery(b):new v(b)};a.prototype.queryExtent=function(b){return n.safeCast(this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(b)))};a.prototype.queryFeatureCount=function(b){return n.safeCast(this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(b)))};
a.prototype.queryFeatures=function(b){return n.safeCast(this._ensureQueryEngine().executeQuery(this._ensureQuery(b)))};a.prototype.queryObjectIds=function(b){return n.safeCast(this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(b)))};a.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};a.prototype._createQueryEngine=function(){var b=this,c=this._createGetFeatureExtent();return new N.default({layerView:this,
task:W.Task.FEATURE_QUERY_ENGINE,spatialIndex:new P.default({featureAdapter:new O.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:c}),forAllFeatures:function(c,a){return b._forAllFeatures(function(b,a,f){return c({id:b,index:a,meta:f})},a,2)},getFeatureExtent:c,sourceSpatialReference:y.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})};a.prototype._createGetFeatureExtent=function(){var b=
this,a=new Float64Array(24),f=this.view.renderSpatialReference,k=this.view.spatialReference;return function(c){if(!c.meta.featureExtents){var d=new Float64Array(6*c.meta.featureIds.length);c.meta.featureExtents=d;for(var g=0;g<d.length;g+=6)d[g]=Number.POSITIVE_INFINITY}d=new Float64Array(c.meta.featureExtents.buffer,6*c.index*Float64Array.BYTES_PER_ELEMENT,6);return d[0]===Number.POSITIVE_INFINITY?(b._boundingBoxCornerPoints(c.index,c.meta.engineObject,a),z.bufferToBuffer(a,f,0,a,k,0,8)?q.expandWithBuffer(q.NEGATIVE_INFINITY,
a,0,8,d):q.set(d,q.ZERO)):d}};a.prototype.highlight=function(b,a){void 0===a&&(a={});var c=this._highlights;if(b instanceof v){var d=c.acquireSet(a),g=d.set,d=d.handle;this.queryObjectIds(b).then(function(b){return c.setFeatureIds(g,b)});return d}return this.inherited(arguments)};a.prototype._createLayerGraphic=function(b){b=new F(null,null,b);b.layer=this.layer;b.sourceLayer=this.layer;return b};a.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};
a.prototype.isUpdating=function(){return this.updatingMeshView3D||0<this._asyncModuleLoading};a.prototype.getFilters=function(){var b=this,a=this.inherited(arguments);if(this.layer.objectIdFilter){var f=new Float64Array(this.layer.objectIdFilter.ids),d="include"===this.layer.objectIdFilter.method;f.sort();a.push(function(a){return b._objectIdFilter(f,d,a)})}this.addSqlFilter(a,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError);if(h.isSome(this.filter)){if(h.isSome(this.parsedFilterGeometry)){var g=
this.parsedFilterGeometry;a.push(function(a,c){return b._maskFilter(a,c,g)})}if(this.filter.objectIds){var e=new Float64Array(this.filter.objectIds);e.sort();a.push(function(a){return b._objectIdFilter(e,!0,a)})}}h.isSome(this.parsedFilterWhereClause)&&this.addSqlFilter(a,this.parsedFilterWhereClause,this.parsedFilterWhereClause.fieldNames,this.logError);return a};a.prototype._maskFilter=function(a,c,d){if(!h.isNone(this.filter)){z.mbsToMbs(c.node.mbs,this._controller.crsIndex,B,d.spatialReference||
this.view.spatialReference);var b=m.acquireMaskFilterContext(this.filter.spatialRelationship,this.view,d,c.engineObject);d=m.intersectMaskWithMbs(b,B);switch(m.getIntersectRelation(b,d)){case 1:a.length=0;return;case 0:return}c.engineObject.geometryRecords[0].geometry.componentCount===c.featureIds.length&&y.filterInPlace(a,c.featureIds,function(a){return m.filterMask(a,b)})}};a.prototype._filterChange=function(){var a=this;h.isSome(this.filter)&&this.filter.geometry&&!this._geometryEngine?this._loadAsyncModule(m.loadGeometryEngine()).then(function(b){a.destroyed||
(a._set("_geometryEngine",b),a._applyFilters(!0))}):this.inherited(arguments)};a.prototype._loadAsyncModule=function(a){var b=this;this._set("_asyncModuleLoading",this._asyncModuleLoading+1);var d=function(){return b._set("_asyncModuleLoading",b._asyncModuleLoading-1)};return a.then(function(a){d();return a},function(a){d();throw a;})};a.prototype._objectIdFilter=function(a,c,d){for(var b=0,e=0;b<d.length;)0<=G.binaryIndexOf(a,d[b])===c&&(d[e]=d[b],e++),b++;d.length=e};a.prototype._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(h.isNone(a)?
this.createQuery():v.from(a))};d([e.property()],a.prototype,"layer",void 0);d([e.property({dependsOn:["updatingMeshView3D","_asyncModuleLoading"]})],a.prototype,"updating",void 0);d([e.property({dependsOn:["_controller.rootNodeVisible"]})],a.prototype,"suspended",void 0);d([e.property(S.updatingPercentage)],a.prototype,"updatingPercentage",void 0);d([e.property({type:V})],a.prototype,"filter",null);d([e.property({readOnly:!0,dependsOn:["filter.where"]})],a.prototype,"parsedFilterWhereClause",null);
d([e.property({readOnly:!0,dependsOn:["filter.geometry","filter.distance","filter.units","_geometryEngine","_projectionEngineLoaded"]})],a.prototype,"parsedFilterGeometry",null);d([e.property(A.requiredFields)],a.prototype,"requiredFields",void 0);d([e.property(A.availableFields)],a.prototype,"availableFields",void 0);d([e.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],a.prototype,"lodFactor",void 0);d([e.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],
a.prototype,"updatingPercentageValue",void 0);d([e.property({readOnly:!0})],a.prototype,"_asyncModuleLoading",void 0);d([e.property({readOnly:!0})],a.prototype,"_geometryEngine",void 0);d([e.property({readOnly:!0})],a.prototype,"_projectionEngineLoaded",void 0);return a=d([e.subclass("esri.views.3d.layers.SceneLayerView3D")],a)}(e.declared(L.I3SMeshView3D(Q.DefinitionExpressionSceneLayerView(T.PopupSceneLayerView(M.LayerView3D(U))))))});