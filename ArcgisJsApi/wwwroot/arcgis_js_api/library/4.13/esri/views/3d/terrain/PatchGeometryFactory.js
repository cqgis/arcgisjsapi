// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/mathUtils ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../geometry/support/aaBoundingBox ../support/earthUtils ../support/buffer/BufferPool ../support/buffer/InterleavedLayout ./ElevationData ./TerrainConst ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil".split(" "),function(na,N,ha,R,V,W,X,O,ia,ja,Y,M,Z,ka){function aa(a,c,m,h){var t=0<(m&2),I=c+(h?1024:0)+(t?2048:
0),n=S.get(I);if(!n){var n=c-1,A=c-1,l=c*c,b=2*n+2*A,E=n*A*6,B=6*b,F=6*(2*n+A-1);h&&(E*=2,B*=2,F*=2);for(var b=65536<l+b?new Uint32Array(E+B):new Uint16Array(E+B),u=0,k=0,d=E,f,q,g,r,y=0,p=0;p<=A;p++){t&&(y=0===p?F:p===A?-F:0);for(var d=d+y,e=0;e<=n;e++)g=T(e,p,n,A),-1<g&&(r=0===p&&e!==n?1:e===n&&p!==A?n+1:p===A&&0!==e?-1:0===e&&0!==p?-(n+1):0,0!==r&&(f=u,q=l+g,g=l+(0===e&&1===p?0:g+1),r=u+r,h?(b[d+0]=f,b[d+1]=q,b[d+2]=q,b[d+3]=g,b[d+4]=g,b[d+5]=f,b[d+6]=g,b[d+7]=r,b[d+8]=r,b[d+9]=f,b[d+10]=f,b[d+
11]=g,d+=12):(b[d+0]=f,b[d+1]=q,b[d+2]=g,b[d+3]=g,b[d+4]=r,b[d+5]=f,d+=6))),++u,e<n&&p<A&&(f=p*(n+1)+e,q=f+1,g=q+(n+1),r=g-1,h?(b[k+0]=f,b[k+1]=q,b[k+2]=q,b[k+3]=g,b[k+4]=g,b[k+5]=f,b[k+6]=g,b[k+7]=r,b[k+8]=r,b[k+9]=f,b[k+10]=f,b[k+11]=g,k+=12):(b[k+0]=f,b[k+1]=q,b[k+2]=g,b[k+3]=g,b[k+4]=r,b[k+5]=f,k+=6));d-=y}n={values:b,numSurfaceIndices:E,numSkirtIndices:B};S.set(I,n)}a.indices=n.values;a.numSurfaceIndices=n.numSurfaceIndices;a.numSkirtIndices=n.numSkirtIndices;a.numWithoutSkirtIndices=a.numSurfaceIndices+
(m?6*(c-1)*(h?2:1):0)}function U(a,c,m,h){a<h[0]&&(h[0]=a);a>h[3]&&(h[3]=a);c<h[1]&&(h[1]=c);c>h[4]&&(h[4]=c);m<h[2]&&(h[2]=m);m>h[5]&&(h[5]=m)}function ba(a,c){var m=c>a?1:0;return 2+4*m+(1-2*m)*(a+c)}function T(a,c,m,h){return 0===c?a:a===m?m+c:c===h?m+h+(m-a):0===a&&0<c?2*m+h+(h-c):-1}Object.defineProperty(N,"__esModule",{value:!0});var la=ja.newLayout().vec3f(Z.VertexAttrConstants.POSITION).vec2f(Z.VertexAttrConstants.UV0),P=new ia.BufferPool(function(a){return la.createBuffer(a)},function(a){return a.count});
N.clearCaches=function(){P.clear();S.clear()};N.releaseGeometry=function(a){P.release(a.vertexAttributes);a.vertexAttributes=null;a.indices=null};N.createSphericalGlobePatch=function(a,c,m,h,t,I,n){var A=t[0],l=t[1],b=t[2];t=t[3];var E=.1*O.earthRadius*(t-l),B=a.numVertsPerRow-1,F=a.numVertsPerRow-1,u=a.numVertsPerRow*a.numVertsPerRow,k=P.acquire(u+(2*B+2*F)),d=k.position.typedBuffer,f=k.uv0.typedBuffer,q=h.geometryInfo.boundingBox;X.empty(q);var g=c[2]-c[0],r=c[3]-c[1],y=b-A,b=m[0],p=m[1];m=m[2];
for(var e=0;e<=B;e++){var C=e/B,z=A+C*y;ca[e]=Math.sin(z);da[e]=Math.cos(z);ea[e]=C;fa[e]=c[0]+C*g}A=I&&!!(n&1);g=I&&!!(n&2);for(z=y=0;z<=F;z++){var v=z/F,e=ha.lerp(l,t,v),G=Math.cos(e),J=Math.sin(e),K=void 0;I?(K=O.halfEarthRadius*Math.log((1+J)/(1-J)),v=(K-c[1])/r):K=180*e/Math.PI;for(e=0;e<=B;e++){var C=ea[e],w=ca[e],L=da[e],H=O.earthRadius;a.samplerData&&(H+=Y.sample(fa[e],K,a.samplerData)||0);L=L*G*H-b;w=w*G*H-p;H=J*H-m;U(L,w,H,q);var D=M.GEOMETRY_VERTEX_STRIDE*y;d[D+0]=L;d[D+1]=w;d[D+2]=H;f[D+
0]=C;f[D+1]=v;D=T(e,z,B,F);if(-1<D){var D=M.GEOMETRY_VERTEX_STRIDE*(u+D),x=A&&0===z?-1:g&&z===F?1:0,L=0===x?L:-b,w=0===x?w:-p,H=0===x?H:O.earthRadius*x-m;d[D+0]=L;d[D+1]=w;d[D+2]=H;f[D+0]=0===x?ba(C,v):C;f[D+1]=0===x?E:v;0!==x&&U(L,w,H,q)}++y}}h.geometryInfo.numVertsPerRow=a.numVertsPerRow;h.geometryInfo.vertexAttributes=k;h.geometryInfo.skirtLength=E;W.vec4.set(h.geometryInfo.uvOffsetAndScale,0,0,1,1);aa(h.geometryInfo,a.numVertsPerRow,I?n:0,a.wireframe)};N.createPlanarGlobePatch=function(a,c,m,
h){var t=c[0],v=c[1],n=c[2]-t,A=c[3]-v,l=a.clippingArea,b=l?Math.max(0,(l[0]-c[0])/n):0,E=l?Math.max(0,(l[1]-c[1])/A):0,B=l?Math.min(1,(l[2]-c[0])/n):1;c=l?Math.min(1,(l[3]-c[1])/A):1;var F=B>b?1/(B-b):1,u=c>E?1/(c-E):1,k=-b*F,d=-E*u,f=.1*n,q=a.numVertsPerRow-1,g=a.numVertsPerRow-1,r=a.numVertsPerRow*a.numVertsPerRow,y=P.acquire(r+(2*q+2*g)),p=y.position.typedBuffer,e=y.uv0.typedBuffer,C=h.geometryInfo.boundingBox;X.empty(C);for(var z=0,Q=0;Q<=g;Q++){var G=Q/g,J=d+G*u,G=v+G*A;l&&(G<l[1]?(G=l[1],J=
0):G>l[3]&&(G=l[3],J=1));for(var K=0;K<=q;K++){var w=K/q,L=k+w*F,w=t+w*n;l&&(w<l[0]?(w=l[0],L=0):w>l[2]&&(w=l[2],L=1));var H=a.samplerData?Y.sample(w,G,a.samplerData)||0:0,w=w-m[0],D=G-m[1],H=H-m[2];U(w,D,H,C);var x=M.GEOMETRY_VERTEX_STRIDE*z;p[x+0]=w;p[x+1]=D;p[x+2]=H;e[x+0]=L;e[x+1]=J;x=T(K,Q,q,q);-1<x&&(x=M.GEOMETRY_VERTEX_STRIDE*(r+x),p[x+0]=w,p[x+1]=D,p[x+2]=H,e[x+0]=ba(L,J),e[x+1]=f);++z}}h.geometryInfo.numVertsPerRow=a.numVertsPerRow;h.geometryInfo.vertexAttributes=y;h.geometryInfo.skirtLength=
f;W.vec4.set(h.geometryInfo.uvOffsetAndScale,b,E,B-b,c-E);aa(h.geometryInfo,a.numVertsPerRow,0,a.wireframe)};var S=new Map,ga=Math.pow(2,-52);N.intersectSkirts=function(a,c,m,h,t,I,n,A){var l=I.position;I=I.uv0;var b=a[0],E=a[1];a=a[2];var B=c[0]-b,F=c[1]-E;for(c=c[2]-a;m<h;m++){var u=3*m,k=3*m+1,d=3*m+2,f=l.get(t[u],0),q=l.get(t[u],1),g=l.get(t[u],2),r=l.get(t[k],0),y=l.get(t[k],1),p=l.get(t[k],2),e=l.get(t[d],0),C=l.get(t[d],1),z=l.get(t[d],2),u=I.get(t[u],0),k=I.get(t[k],0),d=I.get(t[d],0);2<=
u&&(R.vec3.set(v,f,q,g),n(v),f+=v[0],q+=v[1],g+=v[2]);2<=k&&(R.vec3.set(v,r,y,p),n(v),r+=v[0],y+=v[1],p+=v[2]);2<=d&&(R.vec3.set(v,e,C,z),n(v),e+=v[0],C+=v[1],z+=v[2]);var r=r-f,y=y-q,p=p-g,e=e-f,C=C-q,z=z-g,u=F*z-C*c,k=c*e-z*B,M=B*C-e*F,d=r*u+y*k+p*M,f=b-f,G=E-q,J=a-g,g=G*p-y*J,q=J*r-p*f,K=f*y-r*G;if(d>ga){f=f*u+G*k+J*M;if(0>f||f>d)continue;u=B*g+F*q+c*K;if(0>u||f+u>d)continue}else if(d<-ga){f=f*u+G*k+J*M;if(0<f||f<d)continue;u=B*g+F*q+c*K;if(0<u||f+u<d)continue}else continue;g=(e*g+C*q+z*K)/d;0<=
g&&(r=ka.computeNormal(r,y,p,e,C,z,ma),A(g,r,m))}};var ca=Array(M.MAX_PATCH_TESSELATION+1),da=Array(M.MAX_PATCH_TESSELATION+1),ea=Array(M.MAX_PATCH_TESSELATION+1),fa=Array(M.MAX_PATCH_TESSELATION+1),v=V.vec3f64.create(),ma=V.vec3f64.create()});