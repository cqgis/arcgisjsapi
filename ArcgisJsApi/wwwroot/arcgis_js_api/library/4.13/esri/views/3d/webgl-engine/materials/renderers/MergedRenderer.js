// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/IntervalUtilities ../../lib/ResizableFloat32Array ../../lib/Util ../WaterGLMaterial ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(y,M,x,t,B,C,z,D,w,E,F,l,G,u,H){function I(d,a,b,e){for(var h=new Map,p=a.vertexBufferLayout.stride/
4,c=function(b,e){var c=b.origin,g=d.get(c.id),f=h.get(c.id);null==f&&(f={optimalCount:null==g?0:g.optimalCount,sparseCount:null==g?0:g.buffer.getSize(),toAdd:[],toRemove:[],origin:c.vec3},h.set(c.id,f));c=a.elementCount(b.data)*p;e?(f.optimalCount+=c,f.sparseCount+=c,f.toAdd.push(b)):(f.optimalCount-=c,f.toRemove.push(b))},k=0;k<b.length;k++){var f=b[k];c(f,!0)}for(b=0;b<e.length;b++)f=e[b],c(f,!1);return h}y=function(){function d(a,b,e,h){void 0===h&&(h=C.Default3D);this.type="MergedRenderer";this._dataByOrigin=
new Map;this._highlightCount=0;this._rctx=a;this._vertexAttributeLocations=h;this._material=e;this._materialRep=b;this._glMaterials=l.acquireMaterials(this._material,this._materialRep);this._bufferWriter=e.createBufferWriter()}d.prototype.dispose=function(){l.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(d.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"hasHighlights",{get:function(){return 0<
this._highlightCount},enumerable:!0,configurable:!0});d.prototype.hasWater=function(){var a=!1;this._glMaterials.forEach(function(b){a=a||b instanceof E.WaterGLMaterial});return a};d.prototype.renderPriority=function(){return this._material.renderPriority};d.prototype.modify=function(a){var b=this,e=J;e.clear();this.updateGeometries(a.toUpdate,e);this.addAndRemoveGeometries(a.toAdd,a.toRemove,e);this.updateHighlightCount();e.forEach(function(a){return b.updateDisplayedIndexRanges(a)})};d.prototype.addAndRemoveGeometries=
function(a,b,e){var h=this,p=this._material,c=this._bufferWriter,k=c.vertexBufferLayout,f=k.stride/4,g=this._dataByOrigin,q=I(g,c,a,b);q.forEach(function(a,b){q.delete(b);var c=a.optimalCount,d=a.sparseCount,m=g.get(b);null==m&&(w.assert(0<c),m=h.createData(k,c,a.origin),g.set(b,m));if(0===c)m.vao.dispose(!0),m.vao=null,g.delete(b);else{var n=(b=c<a.sparseCount/2)?c:d,c=K,d=m.buffer.getSize(),l=m.buffer.getArray(),n=m.buffer.resize(n,!1);b||n?h.removeAndRebuild(m,a.toRemove,f,l,c):0<a.toRemove.length?
(h.removeByErasing(m,a.toRemove,f,c),0<a.toAdd.length&&(c.end=d)):(c.begin=d,c.end=d);b=L;w.setMatrixTranslation3(b,-a.origin[0],-a.origin[1],-a.origin[2]);h.append(m,p,a.toAdd,f,b,c);a=m.vao.vertexBuffers.geometry;a.byteSize!==m.buffer.getArray().buffer.byteLength?a.setData(m.buffer.getArray()):(l=c.begin,b=c.end,l<b&&(d=m.buffer.getArray(),l*=4,a.setSubData(d,l,l,4*b)));(c.updatedDisplayedIndexRange||m.displayedIndexRanges)&&e.add(m)}})};d.prototype.updateGeometries=function(a,b){for(var e=this._bufferWriter,
h=e.vertexBufferLayout.stride/4,d=0;d<a.length;d++){var c=a[d],k=c.updateType,c=c.renderGeometry,f=this._dataByOrigin.get(c.origin.id),g=f&&f.instances.get(c.uniqueName);if(!g)break;k&1&&(g.displayedIndexRange=l.generateRenderGeometryVisibleIndexRanges(c),b.add(f));k&17&&(g.highlightedIndexRanges=l.generateRenderGeometryHighlightRanges(c),f.highlightCount=null);k&6&&(k=f.buffer.getArray(),f=f.vao,l.calculateTransformRelToOrigin(c,v,r),e.write({transformation:v,invTranspTransformation:r},c.data,e.vertexBufferLayout.createView(k.buffer),
g.from),w.assert(g.from+e.elementCount(c.data)===g.to,"material VBO layout has changed"),f.vertexBuffers.geometry.setSubData(k,g.from*h*4,g.from*h*4,g.to*h*4))}};d.prototype.updateDisplayedIndexRanges=function(a){var b=a.instances;a.displayedIndexRanges=[];var e=!0;b.forEach(function(b){b.displayedIndexRange?(a.displayedIndexRanges.push.apply(a.displayedIndexRanges,z.offsetIntervals(b.displayedIndexRange,b.from)),e=!1):a.displayedIndexRanges.push([b.from,b.to-1])});a.displayedIndexRanges=e?null:z.mergeIntervals(a.displayedIndexRanges)};
d.prototype.updateHighlightCount=function(){var a=this;this._highlightCount=0;this._dataByOrigin.forEach(function(b){if(null==b.highlightCount){var e=0;b.instances.forEach(function(a){a.highlightedIndexRanges&&++e});b.highlightCount=e}a._highlightCount+=b.highlightCount})};d.prototype.updateLogic=function(a){return this._material.update(a)};d.prototype.render=function(a,b,e,h){var d=this,c=this._rctx,k=this._glMaterials.get(b.pass),f=4===b.pass;2===b.pass&&null===a&&(a=20);if(!k||null!=a&&!k.beginSlot(a)||
f&&0===this._highlightCount)return!1;k.bind(c,e);b=k.getProgram();b.setUniformMatrix4fv("model",A);b.hasUniform("modelNormal")&&b.setUniformMatrix4fv("modelNormal",A);var g=!1;this._dataByOrigin.forEach(function(a){f&&0===a.highlightCount||(e.origin=a.origin,k.bindView(c,e),g=f?d.renderHighlightPass(k,a,h)||g:d.renderDefaultPass(k,a,h)||g)});k.release(c,e);return g};d.prototype.renderDefaultPass=function(a,b,e){var h=this._rctx,d=a.getProgram();a=a.getDrawMode();var c=b.displayedIndexRanges;if(c&&
0===c.length)return!1;u.assertCompatibleVertexAttributeLocations(b.vao,d);h.bindVAO(b.vao);c?l.drawArraysFaceRange(h,c,0,a,e):(b=4*b.buffer.getSize()/u.getStride(b.vao.layout.geometry),l.drawArrays(h,a,0,b,e));return!0};d.prototype.renderHighlightPass=function(a,b,e){var h=this._rctx,d=a.getProgram(),c=a.getDrawMode();a=b.vao;u.assertCompatibleVertexAttributeLocations(a,d);h.bindVAO(a);var k=!1;b.instances.forEach(function(a){var b=a.highlightedIndexRanges;if(b&&0!==b.length)for(var f=0;f<b.length;f++){var d=
b[f];l.drawArrays(h,c,d.range?d.range[0]+a.from:a.from,d.range?d.range[1]-d.range[0]+1:a.to-a.from,e);k=!0}});return k};d.prototype.createData=function(a,b,e){return{instances:new Map,vao:new H(this._rctx,this._vertexAttributeLocations,{geometry:B.glLayout(a)},{geometry:G.createVertex(this._rctx,35044)}),buffer:new D.ResizableFloat32Array(b),optimalCount:0,origin:e,highlightCount:0}};d.prototype.removeAndRebuild=function(a,b,e,d,l){for(var c=0;c<b.length;c++){var h=b[c].uniqueName,f=a.instances.get(h);
a.optimalCount-=(f.to-f.from)*e;a.instances.delete(h)}var g=0,q=a.buffer.getArray();l.begin=0;l.end=0;var n=-1,p=-1,r=0;a.instances.forEach(function(a){var b=a.from*e,c=a.to*e,f=c-b;n!==p&&p!==b?(q.set(d.subarray(n,p),r),r+=p-n,n=b):-1===n&&(n=b);p=c;a.from=g/e;g+=f;a.to=g/e});n!==p&&q.set(d.subarray(n,p),r);l.end=g};d.prototype.removeByErasing=function(a,b,d,h){h.begin=Infinity;h.end=-Infinity;for(var e=-1,c=-1,k=0;k<b.length;k++){var f=b[k].uniqueName,g=a.instances.get(f),l=g.from*d,g=g.to*d;e!==
c&&c!==l?(a.buffer.erase(e,c),e=l):-1===e&&(e=l);c=g;a.instances.delete(f);a.optimalCount-=g-l;l<h.begin&&(h.begin=l);g>h.end&&(h.end=g)}e!==c&&a.buffer.erase(e,c)};d.prototype.append=function(a,b,e,d,p,c){c.updatedDisplayedIndexRange=!1;b=this._bufferWriter;for(var h=0;h<e.length;h++){var f=e[h],g=f.data;x.mat4.multiply(v,p,f.transformation);x.mat4.invert(r,v);x.mat4.transpose(r,r);var q=c.end;b.write({transformation:v,invTranspTransformation:r},g,b.vertexBufferLayout.createView(a.buffer.getArray().buffer),
c.end/d);var g=b.elementCount(g)*d,n=q+g;w.assert(null==a.instances.get(f.uniqueName));var t=l.generateRenderGeometryVisibleIndexRanges(f),u=l.generateRenderGeometryHighlightRanges(f);u&&(a.highlightCount=null);q=new F(f.name,q/d,n/d,t,u,void 0,void 0,f.idx);a.instances.set(f.uniqueName,q);t&&(c.updatedDisplayedIndexRange=!0);a.optimalCount+=g;c.end+=g}};Object.defineProperty(d.prototype,"test",{get:function(){return{material:this._material}},enumerable:!0,configurable:!0});return d}();var K={updatedDisplayedIndexRange:!1,
begin:0,end:0},L=t.mat4f64.create(),v=t.mat4f64.create(),r=t.mat4f64.create(),A=t.mat4f64.create(),J=new Set;return y});