// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define(["require","exports","../webgl-engine/lib/Util"],function(e,f,g){Object.defineProperty(f,"__esModule",{value:!0});e=function(){function c(a,b,c){var d=this;this.workerFunc=a;this.callbackFunc=b;this.robin=0;this.type2id=new Map;this.tasks=[];this.typeNumWorkers=[];this.typeWorkerQuota=[];this.typeStatistics=[];this.maxTotalNumWorkers=this.totalNumWorkers=0;c.forEach(function(a,b){d.type2id.set(b,d.tasks.length);d.tasks.push([]);d.typeNumWorkers.push(0);d.typeStatistics.push({requests:0,size:0,
duration:0,speed:0});d.typeWorkerQuota.push(a);d.maxTotalNumWorkers+=a})}Object.defineProperty(c.prototype,"numTypes",{get:function(){return this.tasks.length},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"busy",{get:function(){return this.totalNumWorkers>=this.maxTotalNumWorkers},enumerable:!0,configurable:!0});c.prototype.push=function(a){var b=this,c=this.type2id.get(a.clientType);this.totalNumWorkers<this.maxTotalNumWorkers?(this.typeNumWorkers[c]++,this.totalNumWorkers++,
this.workerFunc(a,function(a,c){return b._taskCallback(a,c)})):this.tasks[c].push(a)};c.prototype.getStatsForType=function(a){a=this.type2id.get(a);return{quota:this.typeWorkerQuota[a],workers:this.typeNumWorkers[a],queueSize:this.tasks[a].length,requestStats:this.typeStatistics[a]}};c.prototype.removeTasks=function(a,b){for(var c=[],d=0,e=this.tasks[this.type2id.get(b)];d<e.length;d++){var f=e[d];-1===a.indexOf(f)&&c.push(f)}this.tasks[this.type2id.get(b)]=c};c.prototype.workerCancelled=function(a){this.taskFinished(a);
a._cancelledInQueue=!0};c.prototype.clear=function(){for(var a=0;a<this.tasks.length;a++)this.tasks[a]=[]};c.prototype.taskFinished=function(a){var b=this.type2id.get(a.clientType);this.typeNumWorkers[b]--;this.totalNumWorkers--;this.typeStatistics[b].requests++;this.typeStatistics[b].size+=a.size||0;this.typeStatistics[b].duration+=a.duration||0;this.typeStatistics[b].speed=0<this.typeStatistics[b].duration?this.typeStatistics[b].size/this.typeStatistics[b].duration:0;g.assert(0<=this.typeNumWorkers[b]);
this.next()};c.prototype.next=function(){var a=this.robin,b=!1;do this.typeNumWorkers[a]<this.typeWorkerQuota[a]&&this.processQueue(a)&&(b=!0),a=(a+1)%this.numTypes;while(!b&&a!==this.robin);if(!b){do this.processQueue(a)&&(b=!0),a=(a+1)%this.numTypes;while(!b&&a!==this.robin)}this.robin=a};c.prototype.processQueue=function(a){for(var b=this;0<this.tasks[a].length;)if(this.workerFunc(this.tasks[a].shift(),function(a,c){return b._taskCallback(a,c)}))return this.typeNumWorkers[a]++,this.totalNumWorkers++,
!0;return!1};c.prototype._taskCallback=function(a,b){a._cancelledInQueue||(this.callbackFunc(a,b),this.taskFinished(a))};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{set workerFunc(b){a.workerFunc=b}}},enumerable:!0,configurable:!0});return c}();f.AsyncQuotaRoundRobinQueue=e});