// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Graphic ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ../../../layers/support/fieldUtils ./BuildingSublayerView3D ./I3SMeshView3D ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ../../layers/support/popupUtils".split(" "),
function(G,H,I,y,d,q,r,z,t,A,u,v,c,B,m,C,D,w,E,F,n){var f=A.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D"),x=F.defineFieldProperties();return function(g){function a(){var b=null!==g&&g.apply(this,arguments)||this;b.layerView=null;b._elevationContext="scene";b._isIntegratedMesh=!1;b.lodFactor=1;b.progressiveLoadFactor=1;return b}y(a,g);a.prototype.initialize=function(){var b=this;this._layerUid=this.layer.layer.uid;this.updatingHandles.add(this,"layer.renderer",function(){return b._updateRequiredFields()});
this.updatingHandles.add(this,"definitionExpressionFields",function(){return b._updateRequiredFields()});this.updatingHandles.add(this,"filterExpressionFields",function(){return b._updateRequiredFields()});this.updatingHandles.add(this.layer,"renderer",function(a){return b._rendererChange(a)},2);this.updatingHandles.add(this,"parsedDefinitionExpression",function(){return b._filterChange()});this.updatingHandles.add(this,"parsedFilterExpression",function(){return b._filterChange()});this.addResolvingPromise(this._updateRequiredFields())};
Object.defineProperty(a.prototype,"parsedFilterExpression",{get:function(){if("Overview"===this.layer.modelName||u.isNone(this.layerView.filterExpression))return null;var b;try{b=B.WhereClause.create(this.layerView.filterExpression,this.layer.fieldsIndex)}catch(h){return f.error("Failed to parse filterExpression: "+h),null}if(!b.isStandardized)return f.error("filterExpression is using non standard function"),null;var a=[];w.findFieldsCaseInsensitive(b.fieldNames,this.layer.fields,{missingFields:a});
return 0<a.length?(f.error("filterExpression references unknown fields: "+a.join(", ")),null):b},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"filterExpressionFields",{get:function(){return this.parsedFilterExpression?w.findFieldsCaseInsensitive(this.parsedFilterExpression.fieldNames,this.layer.fields):null},enumerable:!0,configurable:!0});a.prototype._createLayerGraphic=function(b){b=new z(null,null,b);b.layer=this.layer.layer;b.sourceLayer=this.layer;return b};a.prototype.canResume=
function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};a.prototype.isUpdating=function(){return this.updatingMeshView3D};a.prototype.fetchPopupFeatures=function(b,a){return r(this,void 0,void 0,function(){var b,c,d,e,f,g,k,p,l;return q(this,function(h){switch(h.label){case 0:if(b=this._validateFetchPopupFeatures(a))return[2,v.reject(b)];if(!u.isSome(a)||!a.clientGraphics||0===a.clientGraphics.length)return[2,[]];c=[];d=[];f=m.unpackFieldNames;g=[this.layer.fields];
return[4,n.getRequiredFields(this.layer,n.getFetchPopupTemplate(this.layer,a))];case 1:e=f.apply(void 0,g.concat([h.sent()]));k=0;for(p=a.clientGraphics;k<p.length;k++)l=p[k],m.featureHasFields(e,l)?c.push(l):d.push(l);return 0===d.length?[2,v.resolve(c)]:[2,this.whenGraphicAttributes(d,e).catch(function(){return d}).then(function(b){return c.concat(b)})]}})})};a.prototype._updateRequiredFields=function(){return r(this,void 0,void 0,function(){var b,a,d,c;return q(this,function(e){switch(e.label){case 0:return a=
m.fixFields,d=[this.layer.fields],this.layer.renderer?[4,this.layer.renderer.getRequiredFields(this.layer.fields)]:[3,2];case 1:return c=e.sent(),[3,3];case 2:c=[],e.label=3;case 3:return b=a.apply(void 0,d.concat([c.concat(this.definitionExpressionFields||[],this.filterExpressionFields||[])])),this._set("requiredFields",b),[2]}})})};a.prototype._validateFetchPopupFeatures=function(b){var a=this.layer;if(!a.popupEnabled)return new t("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",
{layer:a});if(!n.getFetchPopupTemplate(a,b))return new t("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:a})};a.prototype.getFilters=function(){var a=this.inherited(arguments);this.addSqlFilter(a,this.parsedFilterExpression,this.filterExpressionFields,this.logError);this.addSqlFilter(a,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError);return a};d([c.property()],a.prototype,"layer",void 0);d([c.property()],a.prototype,"layerView",
void 0);d([c.property({dependsOn:["updatingMeshView3D"]})],a.prototype,"updating",void 0);d([c.property({dependsOn:["_controller.rootNodeVisible"]})],a.prototype,"suspended",void 0);d([c.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],a.prototype,"lodFactor",void 0);d([c.property({readOnly:!0,dependsOn:["layerView.filterExpression","layer.fieldsIndex"]})],a.prototype,"parsedFilterExpression",null);d([c.property({type:[String],readOnly:!0,dependsOn:["parsedFilterExpression"]})],
a.prototype,"filterExpressionFields",null);d([c.property(x.requiredFields)],a.prototype,"requiredFields",void 0);d([c.property(x.availableFields)],a.prototype,"availableFields",void 0);return a=d([c.subclass("esri.views.3d.layers.BuildingComponentSublayerView3D")],a)}(c.declared(E.DefinitionExpressionSceneLayerView(D.I3SMeshView3D(C))))});