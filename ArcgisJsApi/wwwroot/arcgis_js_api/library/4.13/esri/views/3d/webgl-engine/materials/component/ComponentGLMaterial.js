// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/decorateHelper ../../lib/AutoDisposable ../../lib/DefaultTextureUnits ../../lib/GLMaterial ./Parameters ../internal/MaterialUtil ../internal/MaterialUtil ../internal/TextureBinding ../../shaders/DefaultPrograms ../../../../webgl/renderState".split(" "),function(h,l,r,m,t,u,n,g,p,w,q,v,x,k){function A(f){if(f.hasTransparency)return k.separateBlendingParams(770,
1,771,771)}function y(f){if("none"!==f.parameters.cullFace)return{face:"front"===f.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(l,"__esModule",{value:!0});h=function(f){function c(b){var a=f.call(this,b)||this;a.discardTransparentVertices=!1;a.material=b.material;a.passName=b.passName;var d=a.material.parameters;a._baseColorTexture=new v.TextureBinding(b.textureRep,d.baseColorTexture,{textureUniform:"tex",textureUnit:n.DefaultTextureUnits.DIFFUSE});a._metallicRoughnessTexture=new v.TextureBinding(b.textureRep,
d.metallicRoughnessTexture,{textureUniform:"texMetallicRoughness",textureUnit:n.DefaultTextureUnits.METALLIC_ROUGHNESS});a._normalTexture=new v.TextureBinding(b.textureRep,d.normalTexture,{textureUniform:"texNormal",textureUnit:n.DefaultTextureUnits.NORMAL});a._emissiveTexture=new v.TextureBinding(b.textureRep,d.emissiveTexture,{textureUniform:"texEmission",textureUnit:n.DefaultTextureUnits.EMISSION});a._occlusionTexture=new v.TextureBinding(b.textureRep,d.occlusionTexture,{textureUniform:"texOcclusion",
textureUnit:n.DefaultTextureUnits.OCCLUSION});a.createPrograms();a.selectPipeline();return a}m(c,f);Object.defineProperty(c.prototype,"requiresVertexTransparencyDiscards",{get:function(){return p.isUniformComponentData(this.material.parameters.componentData)?!1:"color"===this.passName&&this.material.hasTransparency&&this.material.parameters.useVertexTransparencyDiscards},enumerable:!0,configurable:!0});c.prototype.createPrograms=function(){var b=this;this.programs=w.BindParametersMap.create(this.material.parameters,
function(a){return b._createProgram(a)})};c.prototype._createProgram=function(b){var a=this.material.parameters,d=this.material.geometryParameters,c="screen-space"===a.normals||"screen-space"===d.normals||"none"===d.normals?"screenDerivative":"compressed"===d.normals?"compressed":"default";if("color"===this.passName)return this.programRep.getProgram(x.colorPass,{textureAtlas:!!d.textureCoordinateRegions,colorTexture:!!a.baseColorTexture,vertexColors:d.colors,doubleSided:a.doubleSidedShading,groundNormalShading:"ground"===
a.normals,normals:c,componentColor:d.componentData&&!p.isUniformComponentData(a.componentData),textureAlphaMode:"maskBlend",slice:a.slicePlaneEnabled,receiveShadows:b.receiveShadows,receiveSSAO:b.receiveSSAO,usePBR:a.usePBR,roughnessMetallnessTexture:!!a.metallicRoughnessTexture,emissionTexture:!!a.emissiveTexture,normalTexture:!!a.normalTexture,occlusionTexture:!!a.occlusionTexture,vertexTransparencyDiscardEnabled:this.requiresVertexTransparencyDiscards});if("depth"===this.passName||"depthShadowMap"===
this.passName)return this.programRep.getProgram(x.depthPass,{textureAtlas:!!d.textureCoordinateRegions,colorTexture:!!a.baseColorTexture,vertexColors:d.colors,groundNormalShading:"ground"===a.normals,normals:c,componentColor:d.componentData&&!p.isUniformComponentData(a.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this.passName,slice:a.slicePlaneEnabled});if("normal"===this.passName)return this.programRep.getProgram(x.normalPass,{textureAtlas:!!d.textureCoordinateRegions,
colorTexture:!!a.baseColorTexture,vertexColors:d.colors,groundNormalShading:"ground"===a.normals,normals:c,componentColor:d.componentData&&!p.isUniformComponentData(a.componentData),textureAlphaMode:"maskBlend",slice:a.slicePlaneEnabled});if("highlight"===this.passName)return this.programRep.getProgram(x.highlightPass,{textureAtlas:!!d.textureCoordinateRegions,colorTexture:!!a.baseColorTexture,vertexColors:d.colors,groundNormalShading:"ground"===a.normals,normals:c,componentColor:d.componentData&&
!p.isUniformComponentData(a.componentData),textureAlphaMode:"maskBlend",slice:a.slicePlaneEnabled})};c.prototype.selectPipeline=function(){var b=this.material.parameters;this.pipelineState="color"===this.passName?k.makePipelineState({blending:A(this.material),culling:y(this.material),polygonOffset:b.polygonOffsetEnabled&&z,stencilTest:b.writeStencil&&{function:{func:b.readStencil?517:519,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:b.writeStencil&&{mask:255},depthTest:{func:513},
depthWrite:k.defaultDepthWriteParams,colorWrite:k.defaultColorWriteParams}):k.makePipelineState({culling:y(this.material),polygonOffset:b.polygonOffsetEnabled&&z,depthTest:{func:513},depthWrite:k.defaultDepthWriteParams,colorWrite:k.defaultColorWriteParams})};c.prototype.beginSlot=function(b){return this.requiresVertexTransparencyDiscards?(this.discardTransparentVertices=5===b,7===b||5===b):this.material.hasTransparency?7===b:b===(this.material.parameters.readStencil?3:this.material.parameters.writeStencil?
2:5)};c.prototype.getProgram=function(){return this.program||this.getPrograms()[0]};c.prototype.getPrograms=function(){return w.BindParametersMap.programs(this.programs)};c.prototype.updateParameters=function(){this._baseColorTexture.update(this.material.parameters.baseColorTexture);this.createPrograms();this.selectPipeline()};c.prototype.bind=function(b,a){var d=this.material.parameters,c=this.material.geometryParameters,e=this.program=w.BindParametersMap.lookup(this.programs,a);b.bindProgram(e);
b.setPipelineState(this.pipelineState);e.setUniform3fv("ambient",d.baseColor);e.setUniform3fv("diffuse",d.baseColor);e.setUniform3fv("specular",B);d.usePBR&&(e.setUniform1f("metalnessFactor",d.metallicFactor),e.setUniform1f("roughnessFactor",d.roughnessFactor),e.setUniform3fv("emissionFactor",d.emissiveFactor),e.setUniform1f("reflectanceFactor",d.reflectanceFactor));e.setUniform1f("opacity",d.baseColorOpacity);e.setUniform1f("layerOpacity",d.layerOpacity);this.requiresVertexTransparencyDiscards&&
e.setUniform1f("discardTransparentVertices",this.discardTransparentVertices?1:0);p.isUniformComponentData(d.componentData)?(e.setUniform4fv("externalColor",d.componentData.externalColor),e.setUniform1i("colorMixMode",q.colorMixModes[d.componentData.externalColorMixMode])):(e.setUniform4fv("externalColor",C),e.setUniform1i("colorMixMode",q.colorMixModes.multiply),c.componentData&&(d.componentData.textureBuffer.updateTexture(),d.componentData.textureBuffer.bind(e,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",
unit:n.DefaultTextureUnits.COMPONENT_COLOR})));this._baseColorTexture.bind(b,e);e.setUniform1f("textureAlphaCutoff",.1);this._metallicRoughnessTexture.bind(b,e);this._normalTexture.bind(b,e);this._emissiveTexture.bind(b,e);this._occlusionTexture.bind(b,e);c.textureCoordinateRegions&&(this._baseColorTexture.isValid()?this._baseColorTexture.bindSize("atlasSize",e):this._metallicRoughnessTexture.isValid()?this._metallicRoughnessTexture.bindSize("atlasSize",e):this._normalTexture.isValid()?this._normalTexture.bindSize("atlasSize",
e):this._emissiveTexture.isValid()?this._emissiveTexture.bindSize("atlasSize",e):this._occlusionTexture.isValid()&&this._occlusionTexture.bindSize("atlasSize",e));"depth"!==this.passName&&"depthShadowMap"!==this.passName||e.setUniform2fv("nearFar",a.nearFar);"highlight"===this.passName&&q.bindHighlightRendering(b,a,e)};c.prototype.bindView=function(b,a){b=this.material.parameters;var d=this.program=w.BindParametersMap.lookup(this.programs,a),c=a.origin;q.bindView(c,a.view,d);q.bindCamPos(c,a.viewInvTransp,
d);b.slicePlaneEnabled&&q.bindSlicePlane(c,a.slicePlane,d);"color"===this.passName&&a.shadowMappingEnabled&&a.shadowMap.bindView(d,c);"normal"===this.passName&&d.setUniformMatrix4fv("viewNormal",a.viewInvTransp)};c.prototype.bindInstance=function(b,a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};t([u.autoDispose()],c.prototype,"_baseColorTexture",void 0);t([u.autoDispose()],c.prototype,"_metallicRoughnessTexture",void 0);
t([u.autoDispose()],c.prototype,"_normalTexture",void 0);t([u.autoDispose()],c.prototype,"_emissiveTexture",void 0);t([u.autoDispose()],c.prototype,"_occlusionTexture",void 0);return c}(g);g=function(f){function c(b){return f.call(this,r({passName:"color"},b))||this}m(c,f);return c}(h);l.GLMaterialColor=g;g=function(f){function c(b){return f.call(this,r({passName:"depth"},b))||this}m(c,f);return c}(h);l.GLMaterialDepth=g;g=function(f){function c(b){return f.call(this,r({passName:"depthShadowMap"},
b))||this}m(c,f);return c}(h);l.GLMaterialDepthShadowMap=g;g=function(f){function c(b){return f.call(this,r({passName:"normal"},b))||this}m(c,f);return c}(h);l.GLMaterialNormal=g;h=function(f){function c(b){return f.call(this,r({passName:"highlight"},b))||this}m(c,f);return c}(h);l.GLMaterialHighlight=h;var C=[1,1,1,1],B=[0,0,0],z={factor:2,units:2}});