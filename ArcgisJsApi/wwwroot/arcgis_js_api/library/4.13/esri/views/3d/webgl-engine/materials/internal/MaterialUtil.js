// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/mathUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f32 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4 ../../../../../geometry/support/aaBoundingBox ../../lib/ComponentUtils ../../lib/doublePrecisionUtils ../../lib/screenSizePerspectiveUtils ../../lib/Util".split(" "),function(ma,f,O,P,ha,
Q,H,u,K,J,R,ia,S,T){function U(a,b,c,d,g){var e=V(b,c,W);J.setMin(E,a.getBBMin());J.setMax(E,a.getBBMax());if(L(E,b,e,d)){var e=a.getPrimitiveIndices(),h=a.getIndices(),f=a.getPosition(),k=e?e.length:h.length/3;if(k>ja&&(a=a.getChildren(),void 0!==a)){for(e=0;8>e;++e)void 0!==a[e]&&U(a[e],b,c,d,g);return}M(b,c,0,k,h,f,e,g)}}function M(a,b,c,d,g,e,h,f){if(h){var k=e.data,C=e.offsetIdx;e=e.strideIdx;var w=a[0],t=a[1];a=a[2];var G=b[0]-w,F=b[1]-t;for(b=b[2]-a;c<d;++c){var B=h[c],v=3*B,m=C+e*g[v++],p=
k[m++],q=k[m++],l=k[m],m=C+e*g[v++],y=k[m++],z=k[m++],A=k[m],m=C+e*g[v],v=k[m++],n=k[m++],y=y-p,z=z-q,A=A-l,v=v-p,n=n-q,m=k[m]-l,x=F*m-n*b,D=b*v-m*G,u=G*n-v*F,r=y*x+z*D+A*u;if(!(Math.abs(r)<=X)){p=w-p;q=t-q;l=a-l;x=p*x+q*D+l*u;if(0<r){if(0>x||x>r)continue}else if(0<x||x<r)continue;D=q*A-z*l;l=l*y-A*p;q=p*z-y*q;p=G*D+F*l+b*q;if(0<r){if(0>p||x+p>r)continue}else if(0<p||x+p<r)continue;l=(v*D+n*l+m*q)/r;0<=l&&(y=N(y,z,A,v,n,m,Y),f(l,y,B))}}}else for(h=e.data,k=e.offsetIdx,C=e.strideIdx,e=a[0],w=a[1],
t=a[2],a=b[0]-e,G=b[1]-w,F=b[2]-t,b=c,c*=3;b<d;++b)if(n=k+C*g[c++],r=h[n++],q=h[n++],l=h[n],n=k+C*g[c++],B=h[n++],y=h[n++],z=h[n],n=k+C*g[c++],A=h[n++],v=h[n++],B-=r,y-=q,z-=l,A-=r,v-=q,n=h[n]-l,p=G*n-v*F,x=F*A-n*a,D=a*v-A*G,m=B*p+y*x+z*D,!(Math.abs(m)<=X)){r=e-r;q=w-q;l=t-l;p=r*p+q*x+l*D;if(0<m){if(0>p||p>m)continue}else if(0<p||p<m)continue;x=q*z-y*l;l=l*B-z*r;q=r*y-B*q;r=a*x+G*l+F*q;if(0<m){if(0>r||p+r>m)continue}else if(0<r||p+r<m)continue;l=(A*x+v*l+n*q)/m;0<=l&&(B=N(B,y,z,A,v,n,Y),f(l,B,b))}}
function N(a,b,c,d,g,e,h){H.vec3.set(Z,a,b,c);H.vec3.set(aa,d,g,e);H.vec3.cross(h,Z,aa);H.vec3.normalize(h,h);return h}function V(a,b,c){return H.vec3.set(c,1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]))}function L(a,b,c,d){var g=(a[0]-d-b[0])*c[0],e=(a[3]+d-b[0])*c[0],h=Math.min(g,e),g=Math.max(g,e),e=(a[1]-d-b[1])*c[1],f=(a[4]+d-b[1])*c[1],h=Math.max(h,Math.min(e,f)),g=Math.min(g,Math.max(e,f));if(h>g)return!1;e=(a[2]-d-b[2])*c[2];a=(a[5]+d-b[2])*c[2];h=Math.max(h,Math.min(e,a));g=Math.min(g,Math.max(e,
a));return h<=g}function ba(a,b){b=b?ba(b):{};for(var c in a){var d=a[c];d&&d.forEach&&(d=ka(d));null==d&&c in b||(b[c]=d)}return b}function ka(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(f,"__esModule",{value:!0});var ca=Q.mat4f64.create(),E=J.create(),I=T.VertexAttrConstants;f.IDENTITY=Q.mat4f64.create();f.intersectTriangleGeometry=function(a,b,c,d,g,e){b=b&&b.componentVisibilities;c=c.tolerance;if(1<a.componentCount)a:{var h=V(d,g,W),f=a.componentCount,k=
a.componentOffsets,C=a.getIndices(I.POSITION),w=a.getAttribute(I.POSITION),t=a.boundingInfo;if(t&&(J.setMin(E,t.getBBMin()),J.setMax(E,t.getBBMax()),!L(E,d,h,c)))break a;for(t=0;t<f;t++)if(!b||R.getVisibility(b,t)){if(a.getComponentAABB){var u=a.getComponentAABB(t,E);if(!L(u,d,h,c))continue}M(d,g,k[t]/3,k[t+1]/3,C,w,void 0,e)}}else if(!b||R.getVisibility(b,0))a.boundingInfo?(T.assert("triangle"===a.data.primitiveType),U(a.boundingInfo,d,g,c,e)):(b=a.getIndices(I.POSITION),a=a.getAttribute(I.POSITION),
M(d,g,0,b.length/3,b,a,void 0,e))};var W=u.vec3f64.create(),X=Math.pow(2,-52),Y=u.vec3f64.create();f.intersectTriangles=M;var Z=u.vec3f64.create(),aa=u.vec3f64.create();f.computeNormal=N;f.intersectAabbInvDir=L;f.transformToWorld=function(a,b,c){return K.vec4.set(c,a[0]-b[0],a[1]-b[1],a[2]-b[2],1)};f.transformToView=function(a,b,c,d){P.mat4.translate(ca,c,b);c=ca;return K.vec4.transformMat4(d,a,c)};f.transformToProjection=function(a,b,c,d){d[0]=a[0]+c[0];d[1]=a[1]+c[1];d[2]=a[2]+c[2];d[3]=a[3];return K.vec4.transformMat4(d,
d,b)};f.transformToNDC=function(a,b){return K.vec4.scale(b,a,1/Math.abs(a[3]))};f.applyScreenSizePerspectiveScale=function(a,b,c,d,g){return S.scale(a,d,c,g)};f.verticalOffsetAtDistance=function(a,b,c,d,g){var e=(c.screenLength||0)*a.pixelRatio;g&&(e=S.scale(e,d,b,g));return O.clamp(e*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,c.minWorldLength||0,null!=c.maxWorldLength?c.maxWorldLength:Infinity)};f.acquireIfNotUndefined=function(a,b,c){if(void 0!==a)return b.acquire(a,c)};f.releaseIfNotUndefined=function(a,
b){void 0!==a&&b.release(a)};var da=ha.mat4f32.create();f.bindView=function(a,b,c){P.mat4.translate(da,b,a);c.setUniform3fv("localOrigin",a);c.setUniformMatrix4fv("view",da)};f.bindCamPos=function(a,b,c){c.setUniform3f("camPos",b[3]-a[0],b[7]-a[1],b[11]-a[2])};var ea=u.vec3f64.create(),fa=u.vec3f64.create();f.bindViewOriginDouble=function(a,b){ia.encodeDoubleArraySplit(a,ea,fa,3);b.setUniform3fv("viewOriginHi",ea);b.setUniform3fv("viewOriginLo",fa)};var ga=u.vec3f64.create();f.bindSlicePlane=function(a,
b,c){H.vec3.subtract(ga,b.origin,a);c.setUniform3fv("slicePlaneOrigin",ga);c.setUniform3fv("slicePlaneBasis1",b.basis1);c.setUniform3fv("slicePlaneBasis2",b.basis2)};f.bindVerticalOffset=function(a,b,c){if(a){var d=b.fovY,g=b.viewport[3],e=void 0;void 0===e&&(e=la);e.screenLength=a.screenLength;e.perDistance=Math.tan(.5*d)/(.5*g);e.minWorldLength=a.minWorldLength;e.maxWorldLength=a.maxWorldLength;a=e;c.setUniform4f("verticalOffset",a.screenLength*(b.pixelRatio||1),a.perDistance,a.minWorldLength,a.maxWorldLength)}};
f.bindHighlightRendering=function(a,b,c){a.bindTexture(b.highlightDepthTexture,5);c.setUniform1i("depthTex",5);c.setUniform4f("highlightViewportPixelSz",0,0,1/b.viewport[2],1/b.viewport[3])};f.bindScreenSizePerspective=function(a,b,c){void 0===c&&(c="screenSizePerspectiveAlignment");if(a){var d=a.parameters;b.setUniform4f(c,d.divisor,d.offset,d.minPixelSize,a.paddingPixelsOverride)}};f.copyParameters=ba;f.updateParameters=function(a,b){var c=!1,d;for(d in b){var g=b[d];void 0!==g&&(c=!0,Array.isArray(g)?
a[d]=g.slice():a[d]=g)}return c};(function(a){function b(a){return(a.shadowMappingEnabled?1:0)|(a.ssaoEnabled?2:0)}a.create=function(a,d){for(var c=[],e=0;2>e;e++)for(var f=0;2>f;f++){var u=b({shadowMappingEnabled:1===e,ssaoEnabled:1===f}),k=b({shadowMappingEnabled:1===e,ssaoEnabled:1===f&&a.receiveSSAO});c[u]=c[k]||d({receiveShadows:1===e,receiveSSAO:1===f&&a.receiveSSAO})}return{programs:c.filter(function(a){return null!=a}),byParameter:c}};a.lookup=function(a,d){return a.byParameter[b(d)]};a.programs=
function(a){return a.programs}})(f.BindParametersMap||(f.BindParametersMap={}));f.intersectDrapedRenderLineGeometry=function(a,b,c,d,f,e,h,u,k){if(d.enable.selectionMode){b=a.getAttribute(I.POSITION).data;d=a.getAttribute(I.SIZE);c=e[0];e=e[1];a=(((d&&d.data[0])+h)/2+4)*a.pixelRatio;h=Number.MAX_VALUE;for(d=0;d<b.length-5;d+=3){var g=b[d],w=b[d+1];k=c-g;f=e-w;var g=b[d+3]-g,w=b[d+4]-w,t=O.clamp((g*k+w*f)/(g*g+w*w),0,1);k=g*t-k;f=w*t-f;f=k*k+f*f;f<h&&(h=f)}h<a*a&&u()}};f.colorMixModes={multiply:1,
ignore:2,replace:3,tint:4};var ja=1E3,la={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0};f.defaultPBRMaterialParameters={usePBR:!0,roughnessFactor:.6,metallicFactor:0,reflectanceFactor:.2};f.defaultPBRTreeMaterialParameters={usePBR:!0,roughnessFactor:1,metallicFactor:0,reflectanceFactor:.2};f.returnDefaultPBRMaterialParameters=function(a,b){return b&&a?f.defaultPBRTreeMaterialParameters:a?f.defaultPBRMaterialParameters:{usePBR:!1}}});