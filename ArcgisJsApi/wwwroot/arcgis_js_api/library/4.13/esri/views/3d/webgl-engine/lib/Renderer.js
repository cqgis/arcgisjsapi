// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Handles ../../../../core/maybe ../../../../core/TimeProfiler ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/vec2f64 ../../support/debugFlags ./BoundingInfo ./depthRange ./depthRangeUtils ./FxaaRenderPass ./HighlightHelper ./OffscreenRenderingHelper ./RenderContext ./RenderPluginManager ./renderStats ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./Util ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../materials/internal/waterMaterialUtils ../../../webgl/Profiling ../../../webgl/Texture".split(" "),
function(r,U,w,x,t,y,z,p,A,B,C,D,E,F,G,H,u,I,J,K,L,M,N,O,P,Q,R,S){function T(b,a){for(var c=new Map,e=null,d=null,g=function(a){if(a===e)return d;var b=c.get(a);b||(b={toAdd:[],numToAdd:-1,toRemove:[],numToRemove:-1,toUpdate:[],numToUpdate:-1},c.set(a,b));e=a;return d=b},f=0;f<b.numToAdd;f++){var h=b.toAdd[f];if(1<=q(h.data)){var n=g(h.material);n.toAdd.push(h)}}for(f=0;f<b.numToRemove;f++)h=b.toRemove[f],1<=q(h.data)&&(n=g(h.material),n.toRemove.push(h));for(f=h=0;f<b.numToUpdate;f++){var l=b.toUpdate[f];
1<=q(l.renderGeometry.data)&&(n=g(l.renderGeometry.material),n.toUpdate.push(l),h|=l.updateType)}a&&(a.updateTypes=h);return c}function q(b){return!1===b.preinterleaved?M.getFirstObjectValue(b.indices).length:b.indexCount}function v(b,a){return b.isVisible()&&b.isVisibleInPass(a.pass)&&0!==(b.renderOccluded&a.renderOccludedMask)}r=function(){function b(a,c,b,d,g,f,h){var e=this;this.requestRender=f;this._materialRenderers=new Map;this._orderedMaterialRenderers=[];this._hasHighlights=!1;this._lighting=
new O.SceneLighting;this._content=new Map;this._isRendering=!1;this._fallbackDepthStencilTexture=null;this._stats={scene:new u.RenderStatsAggregator,draped:new u.RenderStatsAggregator};this._edgeView=null;this._handles=new w;this.renderOptions={antialiasing:"smaa"};this.renderHiddenTransparentEdges=function(){};this._programRep=a;this._materialRep=c;this._rctx=d;this._mode=g;this._stage=h;this._fxaaPass=new D(d);this._smaaPass=new K(d);this._bindParameters={view:null,proj:null,viewInvTransp:null,
fovY:0,nearFar:null,viewport:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null};this._offscreenRendering=new F(a,this._rctx);this._sliceHelper=new J;"scene"===this._mode&&(this._shadowMap=new I(this._rctx),this._ssaoHelper=new L(a,this._rctx,function(){return e.requestRender()}),this._highlightHelper=new E(a,this._rctx));this._renderPlugins=new H.RenderPluginManager({rctx:d,programRep:a,textureRep:b,materialRep:c,requestRender:this.requestRender});this._renderContext=
new G(d,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);this._handles.add(y.init(p,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",function(a){e.renderHiddenTransparentEdges=a?function(){return e.renderEdges(1)}:function(){};e.requestRender()}))}b.prototype.dispose=function(){this._handles.destroy();this._materialRenderers.forEach(function(a){a.dispose()});this._orderedMaterialRenderers=this._materialRenderers=null;this._edgeView&&(this._edgeView.destroy(),this._edgeView=
null);this._offscreenRendering.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null);this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);A.tmpIndices.prune();this._content.clear();this._content=null};Object.defineProperty(b.prototype,"updating",{get:function(){return"smaa"===
this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources||Q.waterTextureRepo.loading()},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){var a=this;null==this._edgeView&&(this._edgeView=new N.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){return a.requestRender()}}),this._edgeView.initialize());return this._edgeView};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!0,configurable:!0});b.prototype.setLighting=
function(a){this._lighting.set(a)};b.prototype.setRenderParams=function(a){void 0!==a.shadowMapResolution&&!1===this._shadowMap.enabled&&(this._shadowMap.textureResolution=a.shadowMapResolution);void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==a.ssaoAttenuation&&(this._ssaoHelper.attenuation=a.ssaoAttenuation);
void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);a.background&&(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this.renderOptions.antialiasing=a.antialiasingEnabled?"smaa":"none");void 0!==a.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);
void 0!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane);this.requestRender()};Object.defineProperty(b.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!0,configurable:!0});b.prototype.getRenderParams=function(){var a={};this._shadowMap&&(a.shadowMap=this._shadowMap.enabled,a.shadowMapResolution=this._shadowMap.textureResolution,a.shadowMapMaxCascades=this._shadowMap.maxCascades);this._ssaoHelper&&this._ssaoHelper.isSupported&&(a.ssao=this._ssaoHelper.enabled,
a.ssaoAttenuation=this._ssaoHelper.attenuation,a.ssaoRadius=this._ssaoHelper.radius,a.ssaoFilterRadius=this._ssaoHelper.filterRadius,a.ssaoSamples=this._ssaoHelper.samples);return a};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return!0},enumerable:!0,configurable:!0});b.prototype.getCombinedStats=function(){return{draped:this._stats.draped.getAggregatedStats(),
scene:this._stats.scene.getAggregatedStats()}};b.prototype.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;case "highlight":return this._offscreenRendering.highlightTexture}return null};
Object.defineProperty(b.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasWater",{get:function(){return this._orderedMaterialRenderers.some(function(a){return a.hasWater()})},enumerable:!0,configurable:!0});b.prototype.isEmpty=function(){return 0===this._materialRenderers.size};b.prototype.modify=function(a,c,b,d,g,f,h){var e=this;void 0===c&&(c=a?a.length:0);void 0===d&&(d=b?b.length:0);void 0===f&&(f=g?g.length:
0);this._isRendering&&console.warn("Renderer.modify called while rendering");for(var l=0;l<d;++l)this._content.delete(b[l].uniqueName);for(l=0;l<c;++l)this._content.set(a[l].uniqueName,a[l]);if(c||d||f){var m=!1;T({toAdd:a,numToAdd:c,toRemove:b,numToRemove:d,toUpdate:g,numToUpdate:f}).forEach(function(a,c){var b=e._materialRenderers.get(c);!b&&0<a.toAdd.length&&(b=c.createRenderer(e._rctx,e._materialRep),e._materialRenderers.set(c,b),e._orderedMaterialRenderers.push(b),e.sortOrderedMaterialRenderers());
b&&(b.modify(a),b.isEmpty&&(m=!0))});m&&this._materialRenderers.forEach(function(a,c){a.isEmpty&&(e._materialRenderers.delete(c),e._orderedMaterialRenderers.splice(e._orderedMaterialRenderers.indexOf(a),1),a.dispose())});var k=!1;this._materialRenderers.forEach(function(a){k=k||a.hasHighlights});if(k!==this._hasHighlights){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(k);this._hasHighlights=k}this.requestRender()}h&&(h.forEach(function(a){e._materialRep.updateMaterialParameters(a)}),
this.requestRender())};b.prototype.modifyRenderOrder=function(a){"draped"===this._mode&&(this.sortOrderedMaterialRenderers(),this.requestRender())};b.prototype.updateLogic=function(a){var c=!1;this._orderedMaterialRenderers.forEach(function(b){b.updateLogic&&(c=b.updateLogic(a)||c)});return c};b.prototype.render=function(a){switch(this._mode){case "scene":this.renderScene(a);break;case "draped":this.renderDraped(a)}if(this.onPostRender)this.onPostRender()};b.prototype.renderPass=function(a,c){this.renderGeometryPass(a,
c)};b.prototype.renderScene=function(a){var c=this;this._isRendering=!0;var b=this._rctx,d=this._offscreenRendering,g=a.camera,f=a.fbo,h=this._sliceHelper.plane;a.disableSlice&&(this._sliceHelper.plane=null);this._renderPlugins.prepareRender(g);this.renderShadowMap(a);d.enabled=!0;d.initializeFrame(g,f);this.renderLinearDepth(a);this.renderNormal(a);this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(g,d.linearDepthTexture,d.normalTexture);this._ssaoHelper.bindAll(this._programRep);this._stats.scene.reset();
this.updateGlobalUniforms(g.projectionMatrix);this._renderContext.pass=0;this._renderContext.camera=g;this._renderContext.options=this.renderOptions;d.bindTarget(d.mainColor,d.mainDepth);this._renderPlugins.render(0,this._renderContext);this.renderOpaqueGeometry(this._renderContext);this.renderEdges(2);this.renderHiddenTransparentEdges();this.renderTransparentGeometry(this._renderContext);this.renderEdges(1);var k=g=!1,g=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(18,this._renderContext);
(k=this.renderTransparentTerrain(this._renderContext))&&g&&(d.compositeTransparentTerrainOntoHUDVisibility(),d.renderToTargets(function(){return c.renderHUD("occluded")},d.mainColor,d.tmpDepth,void 0,!0));k&&d.compositeTransparentTerrainOntoMain();d.renderToTargets(function(){c.renderInternalSlot(10,c._renderContext);c._renderPlugins.render(14,c._renderContext);c._renderPlugins.render(15,c._renderContext)},d.mainColor,d.mainDepth);this.renderOccluded();this.renderAntiAliasing(f);b.bindFramebuffer(f);
b.clearSafe(256);this.renderHUD("notOccluded");this.renderHighlights(a,f);this._sliceHelper.plane=h;this._isRendering=!1};b.prototype.renderEdges=function(a){var c=this,b=this._edgeView;b&&b.shouldRender()&&this._offscreenRendering.renderAndComposite(function(){return b.render(c._bindParameters,a)},"alpha")};b.prototype.renderDraped=function(a){this._stats.draped.reset();this.renderGeometryPass(0,a)};b.prototype.renderShadowMap=function(a){var c=this._shadowMap,b=a.camera,d=a.fbo,g=a.lightDirection;
if(c.enabled){p.ENABLE_PROFILE_DEPTH_RANGE&&t.begin("depthRange");var f=this.computeDepthRange(b);p.ENABLE_PROFILE_DEPTH_RANGE&&t.end("depthRange");c.prepare(b,g,f);g=c.getCascades();for(f=0;f<g.length;++f){var h=g[f];h.camera.setGLViewport(this._rctx);a.camera=h.camera;this.renderGeometryPass(3,a)}a.camera=b;c.finish(d);b.setGLViewport(this._rctx)}c.bindAll(this._programRep)};b.prototype.renderLinearDepth=function(a){var c=this;this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth()?this._offscreenRendering.renderToTargets(function(){c.renderGeometryPass(1,
a)},this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};b.prototype.renderNormal=function(a){var c=this;this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets(function(){c.renderGeometryPass(2,a)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};b.prototype.computeDepthRange=
function(a){var c=C.depthRangeFromScene(a,this._content,this._stage.getLayers());B.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};b.prototype.renderGeometryPass=function(a,c){this._isRendering=!0;c=c.camera;this.updateGlobalUniforms(c.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=c;"draped"===this._mode?this.renderGeometryPassDraped(this._renderContext):this.renderGeometryPassScene(this._renderContext);
this._isRendering=!1};b.prototype.renderGeometryPassDraped=function(a){var c=this,b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;m[0]=b.near;m[1]=b.far;this._bindParameters.nearFar=m;this._bindParameters.viewport=b.fullViewport;this._bindParameters.pixelRatio=b.pixelRatio;this._bindParameters.slicePlane=a.sliceHelper&&a.sliceHelper.plane;this._bindParameters.highlightDepthTexture=this.getFallbackDepthTexture();
this._orderedMaterialRenderers.forEach(function(b){var d=c._stats.draped.getMaterialRenderStatsObject(b.type);b.render(null,a,c._bindParameters,d)})};b.prototype.renderGeometryPassScene=function(a){this.renderGeometry(a);this.renderTransparentTerrain(a)};b.prototype.renderGeometry=function(a){this.renderOpaqueGeometry(a);this.renderTransparentGeometry(a)};b.prototype.renderOpaqueGeometry=function(a){this._renderPlugins.render(1,a);this.renderInternalSlot(2,a);this.renderInternalSlot(3,a);this._renderPlugins.render(4,
a);this.renderInternalSlot(5,a);this._renderPlugins.render(6,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._renderPlugins.render(13,this._renderContext)};b.prototype.renderTransparentGeometry=function(a){this.renderInternalSlot(7,a);this._renderPlugins.render(8,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep)};b.prototype.renderTransparentTerrain=function(a){return this._renderPlugins.render(9,a)};b.prototype.renderHUDVisibility=function(a){var b=this,e=P.shouldRenderVisibilityDuringRenderPass(a.pass),
d=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.enabled,g=!1;e&&d&&a.offscreenRenderingHelper.renderHUDVisibility(function(){g=b.renderInternalSlot(11,a)});return g};b.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(19,this._renderContext);this.renderInternalSlot(16,this._renderContext);this.renderInternalSlot(17,this._renderContext)};b.prototype.renderHighlights=function(a,b){var c=this,d=this._highlightHelper;if(d&&d.enabled&&
(this.hasHighlights||this._renderPlugins.needsHighlight())){var g=null;d.profilingCallback&&(g=R.startMeasurement(this._renderContext.rctx));var f=this._offscreenRendering;this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;f=f.renderToTargets(function(){c.renderGeometryPass(4,a);c._rctx.clearSafe(256);c.renderHUD("both")},f.highlight,f.tmpDepth,[0,0,0,0],!0);d.render(a.camera,f,b);null!==g&&d.profilingCallback&&g.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};
b.prototype.renderOccluded=function(){var a=this;this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&1!==b.renderOccluded&&k.push(b)});if(0!==k.length){var b=this._offscreenRendering,e=this._renderContext,d=function(c,d){e.renderOccludedMask=d;b.renderToTargets(function(){a.renderInternalSlot(5,e,k);a.renderInternalSlot(7,e,k);a.renderInternalSlot(10,e,k)},b.tmpColor,b.tmpDepth,[0,0,0,0],!0);e.resetRenderOccludedMask();b.compositeOccludedOntoMain(c)};e.pass=0;d(.4,4);d(.5,2);d(1,8);k.length=
0}};b.prototype.renderAntiAliasing=function(a){var b=this;switch(this.renderOptions.antialiasing){case "smaa":this._smaaPass.loadResources(function(){return b.requestRender()});this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):this._offscreenRendering.composite();break;case "fxaa":this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):this._offscreenRendering.composite();
break;default:this._offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()}};b.prototype.renderInternalSlot=function(a,b,e){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;m[0]=b.camera.near;m[1]=b.camera.far;var c=this._renderContext.offscreenRenderingHelper;
this._bindParameters.nearFar=m;this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.enabled;this._bindParameters.pixelRatio=b.camera.pixelRatio;this._bindParameters.slicePlane=b.sliceHelper&&b.sliceHelper.plane;this._bindParameters.hudVisibilityTexture=c?c.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=
c&&c.depthTexture||this.getFallbackDepthTexture();return this.renderInternalSlotMaterials(a,b,e)};b.prototype.renderInternalSlotMaterials=function(a,b,e){var c=this,g=0===b.pass?this._stats.scene:null,f=!1;x.isSome(e)?e.forEach(function(d){v(d,b)&&(f=c._materialRenderers.get(d).render(a,b,c._bindParameters)||f)}):this._materialRenderers.forEach(function(d,e){v(e,b)&&(e=g?g.getMaterialRenderStatsObject(d.type):null,f=d.render(a,b,c._bindParameters,e)||f)});return f};b.prototype.updateGlobalUniforms=
function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),e=0;e<b.length;e++)b[e].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(e=0;e<b.length;e++)this._lighting.setUniforms(b[e]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(e=0;e<b.length;e++)this._lighting.setUniforms(b[e])}};b.prototype.sortOrderedMaterialRenderers=function(){"draped"===this._mode&&this._orderedMaterialRenderers.sort(function(a,
b){return b.renderPriority()-a.renderPriority()})};b.prototype.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new S(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255])));return this._fallbackDepthStencilTexture};b.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?
this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};b.prototype.forEachRenderGeometry=function(a){this._content.forEach(function(b,e){a(b)})};Object.defineProperty(b.prototype,"test",{get:function(){return{orderedMaterialRenderers:this._orderedMaterialRenderers}},enumerable:!0,configurable:!0});return b}();var m=z.vec2f64.create(),k=[];return r});