// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/assignHelper ../../../../core/compilerUtils ../../../../core/promiseUtils ../../../../core/string ../../../../core/urlUtils ../../../../core/Version ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/quat ../../../../core/libs/gl-matrix-2/quatf64 ./BinaryStreamReader ./fillDefaults ./pathUtils ../../support/buffer/BufferView ../../support/buffer/utils".split(" "),
function(A,B,k,n,S,G,C,D,H,E,t,w,I,J,F,x,K,f,y){function L(a){switch(a.componentType){case 5120:return new f.BufferViewVec2i8(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5121:return new f.BufferViewVec2u8(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5122:return new f.BufferViewVec2i16(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5123:return new f.BufferViewVec2u16(a.raw,a.byteOffset,a.byteStride,a.byteOffset+
a.byteStride*a.entryCount);case 5125:return new f.BufferViewVec2u32(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5126:return new f.BufferViewVec2f(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);default:G.neverReached(a.componentType)}}function M(a){return k(this,void 0,void 0,function(){return n(this,function(d){return[2,C.create(function(d,b){var c=new Blob([a]),e=new FileReader;e.onload=function(){d(JSON.parse(e.result))};e.onerror=function(c){b(c)};
e.readAsText(c)})]})})}function N(a,d){return k(this,void 0,void 0,function(){return n(this,function(e){return[2,C.create(function(b,c){var e=new Blob([a],{type:d}),h=URL.createObjectURL(e),g=new Image;g.addEventListener("load",function(){URL.revokeObjectURL(h);b(g)});g.addEventListener("error",function(b){URL.revokeObjectURL(h);c(b)});g.src=h})]})})}Object.defineProperty(B,"__esModule",{value:!0});var q;A=function(){function a(d,e,b,c,a){this.context=d;this.errorContext=e;this.uri=b;this.json=c;
this.glbBuffer=a;this.bufferCache=new Map;this.textureCache=new Map;this.materialCache=new Map;this.nodeParentMap=new Map;this.nodeTransformCache=new Map;this.baseUri=K.splitURI(this.uri).dirPart;this.checkVersionSupported();this.checkRequiredExtensionsSupported();e.errorUnsupportedIf(null==c.scenes,"Scenes must be defined.");e.errorUnsupportedIf(null==c.meshes,"Meshes must be defined");e.errorUnsupportedIf(null==c.nodes,"Nodes must be defined.");this.computeNodeParents()}a.load=function(d,e,b,c){return k(this,
void 0,void 0,function(){var p,h,g,z,m,f;return n(this,function(l){switch(l.label){case 0:return D.endsWith(b,".gltf")?[4,d.loadJSON(b,c)]:[3,2];case 1:return p=l.sent(),[2,new a(d,e,b,p)];case 2:return D.endsWith(b,".glb")?[4,d.loadBinary(b,c)]:[3,5];case 3:return h=l.sent(),[4,a.parseGLB(e,h)];case 4:return g=l.sent(),[2,new a(d,e,b,g.json,g.binaryData)];case 5:return[4,d.loadBinary(b,c)];case 6:return z=l.sent(),m=new F.BinaryStreamReader(z),4<=m.remainingBytes()&&1179937895===m.readUint32()?[4,
a.parseGLB(e,z)]:[3,8];case 7:return g=l.sent(),[2,new a(d,e,b,g.json,g.binaryData)];case 8:return[4,d.loadJSON(b,c)];case 9:return f=l.sent(),[2,new a(d,e,b,f)]}})})};a.parseGLB=function(d,a){return k(this,void 0,void 0,function(){var b,c,e,h,g,f,m,r,l;return n(this,function(p){switch(p.label){case 0:b=new F.BinaryStreamReader(a),d.assert(12<=b.remainingBytes(),"GLB binary data is insufficiently large."),c=b.readUint32(),e=b.readUint32(),h=b.readUint32(),d.assert(1179937895===c,"Magic first 4 bytes do not fit to expected GLB value."),
d.assert(a.byteLength>=h,"GLB binary data is smaller than header specifies."),d.errorUnsupportedIf(2!==e,"An unsupported GLB container version was detected. Only version 2 is supported."),g=0,p.label=1;case 1:if(!(8<=b.remainingBytes()))return[3,5];r=b.readUint32();l=b.readUint32();if(0!==g)return[3,3];d.assert(1313821514===l,"First GLB chunk must be JSON.");d.assert(0<=r,"No JSON data found.");return[4,M(b.readUint8Array(r))];case 2:return f=p.sent(),[3,4];case 3:1===g?(d.errorUnsupportedIf(5130562!==
l,"Second GLB chunk expected to be BIN."),m=b.readUint8Array(r)):d.warnUnsupported("More than 2 GLB chunks detected. Skipping."),p.label=4;case 4:return g+=1,[3,1];case 5:return f||d.error("No GLB JSON chunk detected."),[2,{json:f,binaryData:m}]}})})};a.prototype.getBuffer=function(d,a){return k(this,void 0,void 0,function(){var b,c,e,h;return n(this,function(p){switch(p.label){case 0:return b=this.json.buffers[d],c=this.errorContext,null==b.uri?(c.assert(null!=this.glbBuffer,"GLB buffer not present"),
[2,this.glbBuffer]):(e=this.bufferCache.get(d))?[3,2]:[4,this.context.loadBinary(this.resolveUri(b.uri),a)];case 1:h=p.sent(),e=new Uint8Array(h),this.bufferCache.set(d,e),c.assert(e.byteLength===b.byteLength,"Buffer byte lengths should match."),p.label=2;case 2:return[2,e]}})})};a.prototype.getAccessor=function(d,a){return k(this,void 0,void 0,function(){var b,c,e,h,g,f,m,r;return n(this,function(p){switch(p.label){case 0:return b=this.json.accessors[d],c=this.errorContext,c.errorUnsupportedIf(null==
b.bufferView,"Some accessor does not specify a bufferView."),c.errorUnsupportedIf(b.type in["MAT2","MAT3","MAT4"],"AttributeType "+b.type+" is not supported"),e=this.json.bufferViews[b.bufferView],[4,this.getBuffer(e.buffer,a)];case 1:return h=p.sent(),g=O[b.type],f=P[b.componentType],m=g*f,r=e.byteStride||m,[2,{raw:h.buffer,byteStride:r,byteOffset:h.byteOffset+(e.byteOffset||0)+(b.byteOffset||0),entryCount:b.count,isDenselyPacked:r===m,componentCount:g,componentByteSize:f,componentType:b.componentType,
min:b.min,max:b.max,normalized:!!b.normalized}]}})})};a.prototype.getIndexData=function(d,a){return k(this,void 0,void 0,function(){var b;return n(this,function(c){switch(c.label){case 0:return null==d.indices?[2,null]:[4,this.getAccessor(d.indices,a)];case 1:b=c.sent();if(b.isDenselyPacked)switch(b.componentType){case 5121:return[2,new Uint8Array(b.raw,b.byteOffset,b.entryCount)];case 5123:return[2,new Uint16Array(b.raw,b.byteOffset,b.entryCount)];case 5125:return[2,new Uint32Array(b.raw,b.byteOffset,
b.entryCount)]}else switch(b.componentType){case 5121:return[2,y.scalar.makeDense(this.wrapAccessor(f.BufferViewUint8,b))];case 5123:return[2,y.scalar.makeDense(this.wrapAccessor(f.BufferViewUint16,b))];case 5125:return[2,y.scalar.makeDense(this.wrapAccessor(f.BufferViewUint32,b))]}return[2,void 0]}})})};a.prototype.getPositionData=function(d,a){return k(this,void 0,void 0,function(){var b,c;return n(this,function(e){switch(e.label){case 0:return b=this.errorContext,b.errorUnsupportedIf(null==d.attributes.POSITION,
"No POSITION vertex data found."),[4,this.getAccessor(d.attributes.POSITION,a)];case 1:return c=e.sent(),b.errorUnsupportedIf(5126!==c.componentType,"Expected type FLOAT for POSITION vertex attribute, but found "+u[c.componentType]),b.errorUnsupportedIf(3!==c.componentCount,"POSITION vertex attribute must have 3 components, but found "+c.componentCount.toFixed()),[2,this.wrapAccessor(f.BufferViewVec3f,c)]}})})};a.prototype.getNormalData=function(d,a){return k(this,void 0,void 0,function(){var b,c;
return n(this,function(e){switch(e.label){case 0:return b=this.errorContext,b.assert(null!=d.attributes.NORMAL,"No NORMAL vertex data found."),[4,this.getAccessor(d.attributes.NORMAL,a)];case 1:return c=e.sent(),b.errorUnsupportedIf(5126!==c.componentType,"Expected type FLOAT for NORMAL vertex attribute, but found "+u[c.componentType]),b.errorUnsupportedIf(3!==c.componentCount,"NORMAL vertex attribute must have 3 components, but found "+c.componentCount.toFixed()),[2,this.wrapAccessor(f.BufferViewVec3f,
c)]}})})};a.prototype.getTangentData=function(d,a){return k(this,void 0,void 0,function(){var b,c;return n(this,function(e){switch(e.label){case 0:return b=this.errorContext,b.assert(null!=d.attributes.TANGENT,"No TANGENT vertex data found."),[4,this.getAccessor(d.attributes.TANGENT,a)];case 1:return c=e.sent(),b.errorUnsupportedIf(5126!==c.componentType,"Expected type FLOAT for TANGENT vertex attribute, but found "+u[c.componentType]),b.errorUnsupportedIf(4!==c.componentCount,"TANGENT vertex attribute must have 4 components, but found "+
c.componentCount.toFixed()),[2,new f.BufferViewVec4f(c.raw,c.byteOffset,c.byteStride,c.byteOffset+c.byteStride*c.entryCount)]}})})};a.prototype.getTextureCoordinates=function(a,e){return k(this,void 0,void 0,function(){var b,c;return n(this,function(d){switch(d.label){case 0:return b=this.errorContext,b.assert(null!=a.attributes.TEXCOORD_0,"No TEXCOORD_0 vertex data found."),[4,this.getAccessor(a.attributes.TEXCOORD_0,e)];case 1:c=d.sent();b.errorUnsupportedIf(2!==c.componentCount,"TEXCOORD_0 vertex attribute must have 2 components, but found "+
c.componentCount.toFixed());if(5126===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec2f,c)];b.errorUnsupportedIf(!c.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0.");return[2,L(c)]}})})};a.prototype.getVertexColors=function(a,e){return k(this,void 0,void 0,function(){var b,c;return n(this,function(d){switch(d.label){case 0:return b=this.errorContext,b.assert(null!=a.attributes.COLOR_0,"No COLOR_0 vertex data found."),[4,this.getAccessor(a.attributes.COLOR_0,
e)];case 1:c=d.sent();b.errorUnsupportedIf(4!==c.componentCount&&3!==c.componentCount,"COLOR_0 attribute must have 3 or 4 components, but found "+c.componentCount.toFixed());if(4===c.componentCount){if(5126===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec4f,c)];if(5121===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec4u8,c)];if(5123===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec4u16,c)]}else if(3===c.componentCount){if(5126===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec3f,
c)];if(5121===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec3u8,c)];if(5123===c.componentType)return[2,this.wrapAccessor(f.BufferViewVec3u16,c)]}b.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+u[c.componentType]);return[2,void 0]}})})};a.prototype.hasPositions=function(a){return void 0!==a.attributes.POSITION};a.prototype.hasNormals=function(a){return void 0!==a.attributes.NORMAL};a.prototype.hasVertexColors=function(a){return void 0!==a.attributes.COLOR_0};a.prototype.hasTextureCoordinates=
function(a){return void 0!==a.attributes.TEXCOORD_0};a.prototype.hasTangents=function(a){return void 0!==a.attributes.TANGENT};a.prototype.getMaterial=function(a,e){return k(this,void 0,void 0,function(){var b,c,d,h,f,k,m,r,l,q,t;return n(this,function(g){switch(g.label){case 0:b=this.errorContext;if(c=this.materialCache.get(a.material))return[3,15];d=null!=a.material?x.material(this.json.materials[a.material]):x.material();h=d.pbrMetallicRoughness;f=this.hasVertexColors(a);k=void 0;if(!h.baseColorTexture)return[3,
2];b.errorUnsupportedIf(0!==(h.baseColorTexture.texCoord||0),"Only TEXCOORD with index 0 is supported.");return[4,this.getTexture(h.baseColorTexture.index,e)];case 1:k=g.sent(),g.label=2;case 2:m=void 0;if(!d.normalTexture)return[3,5];if(0===(d.normalTexture.texCoord||0))return[3,3];b.warnUnsupported("Only TEXCOORD with index 0 is supported for the normal map texture.");return[3,5];case 3:return[4,this.getTexture(d.normalTexture.index,e)];case 4:m=g.sent(),g.label=5;case 5:r=void 0;if(!d.occlusionTexture)return[3,
8];if(0===(d.occlusionTexture.texCoord||0))return[3,6];b.warnUnsupported("Only TEXCOORD with index 0 is supported for the occlusion texture.");return[3,8];case 6:return[4,this.getTexture(d.occlusionTexture.index,e)];case 7:r=g.sent(),g.label=8;case 8:l=void 0;if(!d.emissiveTexture)return[3,11];if(0===(d.emissiveTexture.texCoord||0))return[3,9];b.warnUnsupported("Only TEXCOORD with index 0 is supported for the emissive texture.");return[3,11];case 9:return[4,this.getTexture(d.emissiveTexture.index,
e)];case 10:l=g.sent(),g.label=11;case 11:q=void 0;if(!h.metallicRoughnessTexture)return[3,14];if(0===(h.metallicRoughnessTexture.texCoord||0))return[3,12];b.warnUnsupported("Only TEXCOORD with index 0 is supported for the metallicRoughness texture.");return[3,14];case 12:return[4,this.getTexture(h.metallicRoughnessTexture.index,e)];case 13:q=g.sent(),g.label=14;case 14:t=null!=a.material?a.material:-1,c={alphaMode:d.alphaMode,alphaCutoff:d.alphaCutoff,color:h.baseColorFactor,doubleSided:!!d.doubleSided,
colorTexture:k,normalTexture:m,name:d.name,id:t,occlusionTexture:r,emissiveTexture:l,emissiveFactor:d.emissiveFactor,metallicFactor:h.metallicFactor,roughnessFactor:h.roughnessFactor,metallicRoughnessTexture:q,vertexColors:f,ESRI_externalColorMixMode:d.extras.ESRI_externalColorMixMode},g.label=15;case 15:return[2,c]}})})};a.prototype.getTexture=function(a,e){return k(this,void 0,void 0,function(){var b,c,d,h,g,f,m,k;return n(this,function(l){switch(l.label){case 0:b=this.errorContext;c=this.json.textures[a];
d=x.textureSampler(null!=c.sampler?this.json.samplers[c.sampler]:{});b.errorUnsupportedIf(null==c.source,"Source is expected to be defined for a texture.");h=this.json.images[c.source];if(g=this.textureCache.get(a))return[3,6];f=void 0;return h.uri?[4,this.context.loadImage(this.resolveUri(h.uri),e)]:[3,2];case 1:return f=l.sent(),[3,5];case 2:return b.errorUnsupportedIf(null==h.bufferView,"Image bufferView must be defined."),b.errorUnsupportedIf(null==h.mimeType,"Image mimeType must be defined."),
m=this.json.bufferViews[h.bufferView],[4,this.getBuffer(m.buffer,e)];case 3:return k=l.sent(),b.errorUnsupportedIf(null!=m.byteStride,"byteStride not supported for image buffer"),[4,N(new Uint8Array(k.buffer,k.byteOffset+(m.byteOffset||0),m.byteLength),h.mimeType)];case 4:f=l.sent(),l.label=5;case 5:g={data:f,wrapS:d.wrapS,wrapT:d.wrapT,minFilter:d.minFilter,name:h.name,id:a},this.textureCache.set(a,g),l.label=6;case 6:return[2,g]}})})};a.prototype.getNodeTransform=function(a){if(void 0===a)return Q;
var d=this.nodeTransformCache.get(a);if(!d){var d=this.getNodeTransform(this.getNodeParent(a)),b=this.json.nodes[a];if(b.matrix)d=t.mat4.multiply(w.mat4f64.create(),d,b.matrix);else if(b.translation||b.rotation||b.scale)d=w.mat4f64.clone(d),b.translation&&t.mat4.translate(d,d,b.translation),b.rotation&&(v[3]=I.quat.getAxisAngle(v,b.rotation),t.mat4.rotate(d,d,v[3],v)),b.scale&&t.mat4.scale(d,d,b.scale);this.nodeTransformCache.set(a,d)}return d};a.prototype.wrapAccessor=function(a,e){return new a(e.raw,
e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*(e.entryCount-1)+e.componentByteSize*e.componentCount)};a.prototype.resolveUri=function(a){return H.makeAbsolute(a,this.baseUri)};a.prototype.getNodeParent=function(a){return this.nodeParentMap.get(a)};a.prototype.checkVersionSupported=function(){var a=E.Version.parse(this.json.asset.version,"glTF");R.validate(a)};a.prototype.checkRequiredExtensionsSupported=function(){var a=this.json,e=this.errorContext;a.extensionsRequired&&0!==a.extensionsRequired.length&&
e.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+a.extensionsRequired.join(", "))};a.prototype.computeNodeParents=function(){var a=this;this.json.nodes.forEach(function(d,b){d.children&&d.children.forEach(function(c){a.nodeParentMap.set(c,b)})})};return a}();B.Resource=A;var R=new E.Version(2,0,"glTF"),Q=t.mat4.fromXRotation(w.mat4f64.create(),Math.PI/2),v=J.quatf64.create(),O={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},P=(q={},q[5120]=1,q[5121]=1,q[5122]=2,q[5123]=
2,q[5126]=4,q[5125]=4,q),u={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"}});