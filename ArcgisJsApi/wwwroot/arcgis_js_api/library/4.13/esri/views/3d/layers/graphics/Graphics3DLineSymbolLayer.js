// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f32 ../../../../geometry/support/aaBoundingBox ../../../../renderers/support/renderingInfoUtils ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./lineUtils ../support/FastSymbolUpdates ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/RibbonLineMaterial ../../webgl-engine/shaders/RibbonLinePrograms".split(" "),
function(r,y,F,G,H,I,J,K,z,t,A,B,p,v,L,C,M,N,O,P,f,w,Q,D,R,S,T,U,e){Object.defineProperty(y,"__esModule",{value:!0});r=function(r){function d(b,a,c,d){b=r.call(this,b,a,c,d)||this;b._lineWidthLOD=1;return b}F(d,r);d.prototype.doLoad=function(){return H(this,void 0,void 0,function(){var b,a,c,d;return G(this,function(f){this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,
rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?D.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};b=this._getCombinedOpacityAndColor(z.get(this.symbolLayer,"material","color"));a=b[3];c={width:1,color:b,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:1>a||this._isPropertyDriven("opacity"),slicePlaneEnabled:this._context.slicePlaneEnabled};
if(this._isPropertyDriven("size"))this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(c.width=t.pt2px(1));else{d=null!=this.symbolLayer.size?this.symbolLayer.size:t.px2pt(1);if(0>d)throw new I("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");c.width=t.pt2px(d);"round"===c.join&&(this._lineWidthLOD=1.863798+-2.0062872/Math.pow(1+d/18.2313,.8856294))}this._fastUpdates&&this._fastUpdates.visualVariables&&J.mixin(c,this._fastUpdates.materialParameters,
{});this._material=new U(c,this._getIdHint("_ribbonlinemat"));this._context.stage.add(3,this._material);return[2]})})};d.prototype.destroy=function(){r.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)};d.prototype.getDrivenSize=function(b){var a=new Float32Array(1);this._isPropertyDriven("size")&&b.size?a[0]=t.pt2px(M.getDriverAxisSizeValue(b.size)):a[0]=1;return a};d.prototype.getSizeFeatureAttribute=function(b){var a=new Float32Array(1);
a[0]=w.getAttributeValue(this._fastUpdates.visualVariables.size.field,b);return a};d.prototype.getDrivenColor=function(b,a){a=L.vec4f32.fromValues(1,1,1,1);this._isPropertyDriven("color")&&b.color&&(a[0]=b.color[0],a[1]=b.color[1],a[2]=b.color[2],0<b.color.length&&(a[3]=b.color[3]));this._isPropertyDriven("opacity")&&b.opacity&&(a[3]=b.opacity);return a};d.prototype.getColorFeatureAttribute=function(b){var a=new Float32Array(1);a[0]=w.getAttributeValue(this._fastUpdates.visualVariables.color.field,
b);return a};d.prototype.getOpacityFeatureAttribute=function(b){var a=new Float32Array(1);a[0]=w.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,b);return a};d.prototype.createGraphics3DGraphic=function(b){var a=b.graphic,c=a.geometry;if(!this._validateGeometryType(a.geometry,d.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(c))return null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",f="graphic"+a.uid,e=this.getGraphicElevationContext(a);return"on-the-ground"===
e.mode?this._createAsOverlay(b,c,e,f,this._context.layer.uid):this._createAs3DShape(b,c,e,f,a.uid)};d.prototype.applyRendererDiff=function(b,a){for(var c in b.diff)switch(c){case "visualVariables":if(D.updateFastSymbolUpdatesState(this._fastUpdates,a,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};d.prototype.layerOpacityChanged=function(){var b=this._material.getParameters().color,a=z.get(this.symbolLayer,
"material","color"),a=this._getCombinedOpacity(a),c=1>a||this._isPropertyDriven("opacity");this._material.setParameterValues({color:[b[0],b[1],b[2],a],transparent:c});return!0};d.prototype.layerElevationInfoChanged=function(b,a,c){var e=this._elevationContext.mode;c=f.elevationModeChangeUpdateType(d.elevationModeChangeTypes,c,e);if(c!==f.SymbolUpdateType.UPDATE)return c;var x=f.needsElevationUpdates2D(e);return this.updateGraphics3DGraphicElevationInfo(b,a,function(){return x})};d.prototype.slicePlaneEnabledChanged=
function(b,a){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};d.prototype.physicalBasedRenderingChanged=function(b,a){return!0};d.prototype.pixelRatioChanged=function(b,a){return!0};d.prototype._createAs3DShape=function(b,a,c,d,e){var h=f.getGeometryAsPoly(b.graphic.geometry),k=h[a],l=[],g=[],r=[],E=v.vec3f64.create(),x=Array(6),h=f.getGeometryVertexData3D(k,h.hasZ,h.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,
this._context.renderCoordsHelper,c);this._logGeometryCreationWarnings(h,k,a,"LineSymbol3DLayer");if(0<k.length){for(var k=h.geometryData.outlines,m=h.eleVertexData,u=h.vertexData,q=0;q<k.length;++q){var p=k[q];if(!(1>=p.count)){var n=p.index,t=p.count;if(this._context.clippingExtent&&(f.computeBoundingBox(m,n,t,x),f.boundingBoxClipped(x,this._context.clippingExtent)))continue;f.applyOrigin(u,n,t,E);p=new Float64Array(m.buffer,3*n*m.BYTES_PER_ELEMENT,3*t);n=new Float64Array(u.buffer,3*n*u.BYTES_PER_ELEMENT,
3*t);n=this._createGeometryData(b,n,p,"rings"===a);n=new R(n,d+"path"+q);n.singleUse=!0;l.push(n);g.push(this._material);n=B.mat4f64.create();A.mat4.translate(n,n,E);r.push(n)}}if(0<l.length)return b=new S({geometries:l,materials:g,transformations:r,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e},idHint:d}),l=new P(this,b,l,null,null,N.perVertexElevationAligner,c),l.alignedTerrainElevation=h.terrainElevation,l.needsElevationUpdates=f.needsElevationUpdates2D(c.mode),l}return null};
d.prototype._createGeometryData=function(b,a,c,d){a=Q.createPolylineGeometryData(a,c,d);if("round"===this._material.getParameters().join){c=a.vertexAttributes[e.VertexAttrConstants.POSITION].data;d=c.length/3;var f=new Float32Array(d),h=V,k=W;p.vec3.set(h,0,0,0);for(var l=0;l<d-1;++l){var g=l+1;p.vec3.set(k,c[3*g+0]-c[3*l+0],c[3*g+1]-c[3*l+1],c[3*g+2]-c[3*l+2]);p.vec3.normalize(k,k);g=1*(Math.PI-K.acosClamped(p.vec3.dot(h,k)))*X*this._lineWidthLOD;f[l]=Math.max(Math.floor(g),0);p.vec3.scale(h,k,-1)}a.vertexAttributes[e.VertexAttrConstants.SUBDIVISIONS]=
{size:1,data:f,offsetIdx:0,strideIdx:1};a.indices[e.VertexAttrConstants.SUBDIVISIONS]=a.indices[e.VertexAttrConstants.POSITION]}c=new Uint32Array(a.vertexAttributes[e.VertexAttrConstants.POSITION].data.length);a.indices[e.VertexAttrConstants.SIZE]=c;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?(a.vertexAttributes[e.VertexAttrConstants.SIZEFEATUREATTRIBUTE]={size:1,data:this.getSizeFeatureAttribute(b.graphic),offsetIdx:0,strideIdx:1},a.indices[e.VertexAttrConstants.SIZEFEATUREATTRIBUTE]=
c):(a.vertexAttributes[e.VertexAttrConstants.SIZE]={size:1,data:this.getDrivenSize(b.renderingInfo),offsetIdx:0,strideIdx:1},a.indices[e.VertexAttrConstants.SIZE]=c);this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?(a.vertexAttributes[e.VertexAttrConstants.COLORFEATUREATTRIBUTE]={size:1,data:this.getColorFeatureAttribute(b.graphic),offsetIdx:0,strideIdx:1},a.indices[e.VertexAttrConstants.COLORFEATUREATTRIBUTE]=c):(a.vertexAttributes[e.VertexAttrConstants.COLOR]={size:4,data:this.getDrivenColor(b.renderingInfo,
b.graphic),offsetIdx:0,strideIdx:4},a.indices[e.VertexAttrConstants.COLOR]=c);this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity&&(a.vertexAttributes[e.VertexAttrConstants.OPACITYFEATUREATTRIBUTE]={size:1,data:this.getOpacityFeatureAttribute(b.graphic),offsetIdx:0,strideIdx:1},a.indices[e.VertexAttrConstants.OPACITYFEATUREATTRIBUTE]=c);return a};d.prototype._createAsOverlay=function(b,a,c,d,e){c=b.graphic;var h=f.getGeometryAsPoly(c.geometry),k=h[a];this._material.renderPriority=
this._symbolLayerOrder;var l=[],g=Array(6),p=C.empty(),r=v.vec3f64.create(),h=f.getGeometryVertexDataDraped(k,h.spatialReference,this._context.overlaySR);this._logGeometryCreationWarnings(h,k,a,"LineSymbol3DLayer");if(0<k.length){for(var k=h.vertexData,h=h.geometryData.outlines,t=0;t<h.length;++t){var m=h[t],u=m.index,m=m.count;f.computeBoundingBox(k,u,m,g);if(!f.boundingBoxClipped(g,this._context.clippingExtent)){C.expand(p,g);f.applyOrigin(k,u,m,r);f.setZ(k,u,m,this._getDrapedZ());m=new Float64Array(k.buffer,
3*u*k.BYTES_PER_ELEMENT,3*m);u=B.mat4f64.create();A.mat4.translate(u,u,r);var m=this._createGeometryData(b,m,null,"rings"===a),q=new T(m);q.data.layerUid=e;q.data.graphicUid=c.uid;q.material=this._material;q.center=[.5*(g[0]+g[3]),.5*(g[1]+g[4]),0];q.bsRadius=.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]));q.transformation=u;q.name=d;q.uniqueName=d+"#"+m.id;l.push(q)}}return new O(this,l,p)}return null};d.validGeometryTypes=["polyline","polygon","extent"];d.elevationModeChangeTypes=
{definedChanged:f.SymbolUpdateType.RECREATE,staysOnTheGround:f.SymbolUpdateType.NONE,onTheGroundChanged:f.SymbolUpdateType.RECREATE};return d}(w.Graphics3DSymbolLayer);y.Graphics3DLineSymbolLayer=r;var V=v.vec3f64.create(),W=v.vec3f64.create(),X=4/Math.PI;y.default=r});