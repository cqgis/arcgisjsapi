// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/mathUtils ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec4 ../../2d/engine/vectorTiles/tileRendererHelper3D ../../2d/engine/vectorTiles/VectorTileDisplayObject ./terrainUtils ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../webgl-engine/shaders/MiscPrograms ../../webgl/FramebufferObject ../../webgl/renderState ../../webgl/Texture ../../webgl/Util".split(" "),function(G,
H,A,v,w,r,B,x,C,D,n,E,F,f,p,y){function t(b,a,c){var d=b.layerInfo[1][a];c.layerIndex=a;if(d.data)return v.vec2.set(c.offset,0,0),c.tile=b,c.scale=1,c.sourceLod=b.lij,c.sourceLayerInfo=d,c;if(!d.upsampleFromTile)return null;b=d.upsampleFromTile;a=b.tile.layerInfo[1][a];c.tile=b.tile;v.vec2.copy(c.offset,b.offset);c.scale=b.scale;c.sourceLod=b.tile.lij;c.sourceLayerInfo=a;return c}var z=[],u={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return function(){function b(a,
c,d,g){this._context=a;this.tileSize=c;this._setNeedsRender=g;this._blackTex=this._backgroundTexture=null;this._context.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,this._context.parameters.maxMaxAnisotropy));this._vaoQuad=n.createQuadVAO(this._context,D.Pos3Tex);this._blendLayersProgram=d.getProgram(E.blendLayers);this._blendLayersPipelineState=f.makePipelineState({blending:f.simpleBlendingParams(1,771),colorWrite:f.defaultColorWriteParams});this._applyOpacityPipelineState=
f.makePipelineState({blending:f.simpleBlendingParams(0,770),colorWrite:f.defaultColorWriteParams});this._blackTex=n.createColorTexture(this._context,[0,0,0,1])}b.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);this._backgroundTexture&&(this._backgroundTexture.dispose(),this._backgroundTexture=null);this._blackTex&&(this._blackTex.dispose(),this._blackTex=null);this._blendLayersProgram&&(this._blendLayersProgram.dispose(),
this._blendLayersProgram=null)};b.prototype.updateTileTexture=function(a){for(var c=a.layerInfo[1],d=0;d<c.length;d++)c[d].pendingUpdates&=-33;if(a.renderData){var g=a.surface,b=g.baseOpacity,d=0,e=this.tileSize,q=!1,k,l=c.length;for(k=0;k<c.length&&!q;k++){var h=g.layerViewByIndex(k,1),f=h.fullOpacity;z[k]=f;this._isBaseLayer(h.layer)&&l>=c.length&&(l=k);0!==f&&t(a,k,u)&&(C.isVectorTileLayerView(h)?e=Math.max(e,this.tileSize*h.view.pixelRatio):h.isOpaque&&1===b&&1===f&&(q=!0),d++)}b=e;e=A.nextHighestPowerOfTwo(b);
c=e*e;g=b*b;c===g?e=b:(b=e/2,e=c-g<g-b*b?e:b);c=e/this.tileSize;--k;0===d&&this._backgroundTexture?this._useBackgroundTexture(a):1===d&&q?this._useLayerTexture(a,k):this._composeMapLayers(a,k,l,q,z,e,c);this._setNeedsRender()}};b.prototype.setBackground=function(a){this._backgroundTexture=a instanceof HTMLImageElement?this._buildTexture(a):n.createColorTexture(this._context,a)};b.prototype._buildTexture=function(a){var c={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,
maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},d=this._context,b;if("number"===typeof a)c.width=c.height=a,b=new p(d,c);else try{b=new p(d,c,a)}catch(I){b=n.createEmptyTexture(d),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}d.bindTexture(b);b.generateMipmap();return b};b.prototype._bindFBO=function(a,c,b,g){a&&a.width===c&&a.height===b||(a&&a.dispose(),a=F.create(this._context,{colorTarget:0,depthStencilTarget:g?1:0,width:c,height:b}));
this._context.bindFramebuffer(a);return a};b.prototype._drawRasterData=function(a,c,b,g){void 0===g&&(g=1);var d=this._context,e=this._blendLayersProgram,f=this._vaoQuad;d.bindProgram(e);d.bindVAO(f);y.assertCompatibleVertexAttributeLocations(f,e);d.bindTexture(a,0);e.setUniform1i("tex",0);e.setUniform1f("scale",c);e.setUniform2f("offset",b[0],b[1]);e.setUniform1f("opacity",g);d.drawArrays(5,0,y.vertexCount(f,"geometry"))};b.prototype._drawVectorData=function(a,c,b){var d=this._context,f=a.tile.surface.layerViewByIndex(a.layerIndex,
1);B.renderVectorTile(d,a.sourceLod,a.sourceLayerInfo.data,f.renderer,f.layer.styleRepository,f.schemaHelper,Math.round(1/a.scale),a.offset,this.tileSize,c,b)};b.prototype._useBackgroundTexture=function(a){a.renderData.opacity=a.surface.baseOpacity;a.renderData.textureReference=this._backgroundTexture;r.vec4.set(a.renderData.texOffsetAndScale,0,0,1,1)};b.prototype._useLayerTexture=function(a,c){c=t(a,c,u);if(this._dataToTexture(c)){a.renderData.textureReference=c.sourceLayerInfo.data;var b=c.offset;
r.vec4.set(a.renderData.texOffsetAndScale,b[0],b[1],c.scale,c.scale)}a.renderData.opacity=a.surface.baseOpacity};b.prototype._composeMapLayers=function(a,c,b,g,f,e,q){var d=this,l=a.renderData.ensureTexture(e,function(){return d._buildTexture(e)}),h=this._context;this._fbo=this._bindFBO(this._fbo,l.descriptor.width,l.descriptor.height,!0);h.setViewport(0,0,e,e);h.setClearColor(0,0,0,0);h.setClearDepth(1);h.clearSafe(16640);var n=!1;!g&&this._backgroundTexture&&(h.setPipelineState(this._blendLayersPipelineState),
this._drawRasterData(this._backgroundTexture,1,w.vec2f64.ZEROS));g=a.surface.baseOpacity;for(var p=!1;0<=c;c--){var m=t(a,c,u);m&&(c<b&&1>g&&!p&&(h.setPipelineState(this._applyOpacityPipelineState),this._drawRasterData(this._blackTex,1,w.vec2f64.ZEROS,g),p=!0),0!==f[c]&&(m&&m.sourceLayerInfo&&m.sourceLayerInfo.data instanceof x?(n&&h.clearSafe(256),h.setPipelineState(this._blendLayersPipelineState),this._drawVectorData(m,q,f[c]),n=!0):this._dataToTexture(m)&&(h.setPipelineState(this._blendLayersPipelineState),
this._drawRasterData(m.sourceLayerInfo.data,m.scale,m.offset,f[c]))))}h.bindTexture(l);b=l.descriptor;h.gl.copyTexImage2D(h.gl.TEXTURE_2D,0,b.pixelFormat,0,0,b.width,b.height,0);l.generateMipmap();h.bindFramebuffer(null);a.renderData.opacity=p?1:g;a.renderData.textureReference=l;r.vec4.set(a.renderData.texOffsetAndScale,0,0,1,1)};b.prototype._dataToTexture=function(a){if(a&&a.sourceLayerInfo&&a.sourceLayerInfo.data instanceof x)return!1;var b=a&&a.sourceLayerInfo&&a.sourceLayerInfo.data;if(b instanceof
HTMLImageElement||b instanceof HTMLCanvasElement)this._rasterDataToTexture(a),a.tile.setMemoryDirty();return a&&a.sourceLayerInfo&&a.sourceLayerInfo.data instanceof p};b.prototype._rasterDataToTexture=function(a){a=a.sourceLayerInfo;a.data=this._buildTexture(a.data)};b.prototype._isBaseLayer=function(a){return a.parent&&"esri.Basemap"===a.parent.declaredClass&&-1<a.parent.baseLayers.indexOf(a)};Object.defineProperty(b.prototype,"test",{get:function(){return{fbo:this._fbo}},enumerable:!0,configurable:!0});
return b}()});