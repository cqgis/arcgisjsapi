// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/has ../../../../core/lang ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../libs/draco/DracoDecoder ./I3SBinaryReader ./I3SMaterialUtil ./I3SUtil".split(" "),function(m,O,K,x,L,M,n,p,N,y,C,q){m=function(){function b(a,e,d,c,f,b){this.streamDataController=e;this.logger=d;this.defaultGeometrySchema=c;this.requiredAttributes=f;this.options=b;this.layerUrl=a.parsedUrl.path;
this.geometryDefinitions=a.geometryDefinitions;if(a.materialDefinitions){var g=a.textureSetDefinitions;this.materialAndTextures=a.materialDefinitions.map(function(a){return C.getMaterialAndTextures(g,a)})}}b.prototype.load=function(a,e,d){return this.streamDataController.request(a,e,{signal:d})};b.prototype.loadAttribute=function(a,e,d){return this.load(this.layerUrl+"/nodes/"+a.resources.attributes+"/attributes/"+e.key+"/0","binary",d).then(function(a){return y.readBinaryAttribute(e,a)})};b.prototype.loadAttributes=
function(a,e,d){var c=this;return n.eachAlways(e.map(function(e){return c.loadAttribute(a,e.attributeStorageInfo,d)})).then(function(d){for(var b={},g=0;g<e.length;++g)d[g].value?b[e[g].name]=d[g].value:n.isAbortError(d[g].error)||c.logger.error("Failed to load attributeData for '"+e[g].name+"' on node '"+a.id+"'");return b})};b.prototype.loadNodeData=function(a,e){return x(this,void 0,void 0,function(){var d,b,f,k,g,t,z,u,m,r,p,A,q,D,v,B,E,x,F,G,H;return K(this,function(c){switch(c.label){case 0:d=
null!=this.requiredAttributes&&a.resources.attributes?this.loadAttributes(a,this.requiredAttributes,e):n.resolve({});var h=this.geometryDefinitions;c={bufferDefinition:null,bufferIndex:0};if(!(null==h||0>a.resources.geometryDefinition)&&(h=0<=a.resources.geometryDefinition?h[a.resources.geometryDefinition].geometryBuffers:null,null!=h))for(var l=0;l<h.length;l++)if(null!=h[l].compressedAttributes){if("draco"===h[l].compressedAttributes.encoding&&N.isSupported()&&!L("disable-feature:i3s-draco")){c.bufferIndex=
l;c.bufferDefinition=h[l];break}}else c.bufferIndex=l,c.bufferDefinition=h[l];b=c;f=b.bufferDefinition;k=b.bufferIndex;g=a.resources.geometry?this.loadGeometry(a,k,e):null;return a.resources.hasSharedResource?[4,this.loadShared(a,e)]:[3,2];case 1:return z=c.sent(),[3,3];case 2:z=null,c.label=3;case 3:return t=z,m=(u=this.materialAndTextures&&0<=a.resources.materialDefinition?this.materialAndTextures[a.resources.materialDefinition]:null!=t?C.getMaterialAndTexturesFromShared(t):null)&&u.material,r=
u&&u.textures,this.options.loadFeatureData?[4,this.loadFeatureData(a,e)]:[3,5];case 4:return A=c.sent(),[3,6];case 5:A=null,c.label=6;case 6:return p=A,q=this.options.loadFeatureData?this.collectGeometries(p):this.meshPyramidGeometryData(a,m),D=null!=r&&0<r.length?this.loadTextures(a,r,e):null,B=v=null,g?[4,g]:[3,8];case 7:v=c.sent();h=this.defaultGeometrySchema;l=t;if(h&&l&&l.materialDefinitions){var w=Object.keys(l.materialDefinitions)[0];!l.materialDefinitions[w].params.vertexRegions&&h.vertexAttributes.region&&
(h=M.clone(h),delete h.vertexAttributes.region)}E=h;if(x=!(!f||!f.compressedAttributes||"draco"!==f.compressedAttributes.encoding)){h={};l=0;for(w=f.compressedAttributes.attributes;l<w.length;l++){var I=w[l];J[I]&&(h[J[I]]={valueType:null})}h={header:null,byteOffset:0,byteCount:0,vertexAttributes:h}}else h=f?y.createGeometryIndexFromDefinition(f,a.vertexCount,a.numFeatures):y.createGeometryIndexFromSchema(v,E);B=h;c.label=8;case 8:return[4,D];case 9:return F=c.sent(),[4,d];case 10:return H=(G=c.sent())?
{attributeData:G,loadedAttributes:this.requiredAttributes}:null,[2,{allGeometryData:q,attributeDataInfo:H,geometryBuffer:v,geometryIndex:B,requiredTextures:r,textureData:F}]}})})};b.addAbsoluteHrefTexture=function(a,e){a=a.textureDefinitions;if(null!=a)for(var d=0,c=Object.keys(a);d<c.length;d++)for(var b=0,k=a[c[d]].images;b<k.length;b++){var g=k[b];Array.isArray(g.href)?g.hrefConcat=g.href.map(function(a){return p.makeAbsolute(a,e)}):g.hrefConcat=p.makeAbsolute(g.href,e)}};b.fixTextureEncodings=
function(a){a=a.textureDefinitions;if(null!=a)for(var b in a){var d=a[b];if(Array.isArray(d.encoding))for(var c=0;c<d.encoding.length;c++){var f=d.encoding[c];"data:"===f.substring(0,5)&&(d.encoding[c]=f.substring(5))}else f=d.encoding,"data:"===f.substring(0,5)&&(d.encoding=f.substring(5))}};b.prototype.loadShared=function(a,e){var d=this.layerUrl+"/nodes/"+a.resources.geometry+"/shared";return this.load(d,"json",e).then(function(a){b.fixTextureEncodings(a);b.addAbsoluteHrefTexture(a,d);return a})};
b.prototype.loadTexture=function(a,b,d,c,f,k){return f===q.DDS_ENCODING_STRING?this.load(a,"binary",k).then(function(a){return{id:b,usage:d,data:a,encoding:f}}):this.load(a,"image",k).then(function(a){var e=a;if(c&&4096<=a.width*a.height){var e=Math.ceil(a.width/2),g=Math.ceil(a.height/2),k=document.createElement("canvas");k.width=e;k.height=g;k.getContext("2d").drawImage(a,0,0,e,g);e=k}return{id:b,usage:d,data:e,encoding:f}})};b.prototype.loadTextures=function(a,e,d){var c=this,f=this.options.textureFormat===
b.TextureFormat.Compressed,k=this.options.textureFormat===b.TextureFormat.Downsampled,g=this.options.textureUsageMask;return n.all(e.map(function(b){if(0===(b.usage&g))return null;var e=q.selectEncoding(b.encodings,f);return null==e?(c.logger.error("No known encoding for texture found on node "+a.id),n.reject()):c.loadTexture(c.layerUrl+"/nodes/"+(a.resources.texture||a.id)+"/textures/"+e.name,b.id,b.usage,k,e.encoding,d)}))};b.prototype.meshPyramidGeometryData=function(a,b){return[{featureIds:[],
geometries:[{type:"ArrayBufferView",params:{material:b}}],featureDataPosition:[0,0,0]}]};b.prototype.collectGeometries=function(a){var b=[],d=0;for(a=a.featureData;d<a.length;d++){var c=a[d],f=c.geometries;if(null!=f)for(var k=0;k<f.length;k++)b.push({featureIds:[c.id],featureDataPosition:c.position,geometries:[f[k]]});else null!=c.position&&b.push({featureIds:[c.id],featureDataPosition:c.position,geometries:null})}return b};b.prototype.loadFeatureData=function(a,b){return this.load(this.layerUrl+
"/nodes/"+a.id+"/features/0","json",b)};b.prototype.loadGeometry=function(a,b,d){return this.load(this.layerUrl+"/nodes/"+a.resources.geometry+"/geometries/"+b,"binary",d)};return b}();var J={position:"position",normal:"normal",uv0:"uv0",uv1:"uv1",color:"color","uv-region":"region"};(function(b){b=b.TextureFormat||(b.TextureFormat={});b[b.Compressed=0]="Compressed";b[b.Normal=1]="Normal";b[b.Downsampled=2]="Downsampled"})(m||(m={}));return m});