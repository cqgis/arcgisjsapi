// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/mathUtils ../../../../geometry/support/aaBoundingBox ../../support/buffer/BufferView ../../support/buffer/InterleavedLayout ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/bufferWriterUtils ./internal/MaterialUtil ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/PathPrograms ../../../webgl/renderState".split(" "),function(x,
P,y,l,z,D,p,E,q,F,G,H,n,r,g,I,f,h){function t(e,a){a.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",a.vvSizeOffset),e.setUniform3fv("vvSizeFactor",a.vvSizeFactor));a.vvColorEnabled&&(e.setUniform1fv("vvColorValues",a.vvColorValues),e.setUniform4fv("vvColorColors",a.vvColorColors));a.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",a.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",a.vvOpacityOpacities))}
var u=G.assert;x=function(e){function a(b,c){c=e.call(this,c)||this;c.supportsEdges=!0;c.params=g.copyParameters(b,J);c.vertexBufferLayout=a.getVertexBufferLayout(c.params);return c}l(a,e);a.prototype.isVisibleInPass=function(b){return 3===b?this.params.castShadows:!0};a.prototype.isVisible=function(){var b=this.params;if(!e.prototype.isVisible.call(this)||0===b.layerOpacity)return!1;var c="replace"===b.colorMixMode,a=0<b.opacity,d=b.externalColor&&0<b.externalColor[3];return b.vvColorEnabled?c?!0:
a:c?d:a};a.prototype.setParameterValues=function(b){var c=this.params,a;for(a in b)c[a]=b[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(b,c,a,d,e,f,h,k){if(b.metadata){c=b.metadata.pathGeometry;a=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){k=this.params.vvSizeOffset;var m=this.params.vvSizeFactor,B=this.params.vvSizeMinSize,A=this.params.vvSizeMaxSize,l=c.sizeAttributeValue;a[0]*=z.clamp(k[0]+
l*m[0],B[0],A[0]);a[1]*=z.clamp(k[1]+l*m[1],B[1],A[1])}k=Math.max(a[0],a[1]);b=D.fromValues(b.boundingInfo.bbMin[0]-k,b.boundingInfo.bbMin[1]-k,b.boundingInfo.bbMin[2]-k,b.boundingInfo.bbMax[0]+k,b.boundingInfo.bbMax[1]+k,b.boundingInfo.bbMax[2]+k);k=[f[0]-e[0],f[1]-e[1],f[2]-e[2]];m=Math.sqrt(k[0]*k[0]+k[1]*k[1]+k[2]*k[2]);g.intersectAabbInvDir(b,e,[m/k[0],m/k[1],m/k[2]],d.tolerance)&&(c.baked.size&&c.baked.size[0]===a[0]&&c.baked.size[1]===a[1]||c.baked.bake(a),c.baked.intersect(e,f,h))}};a.prototype.createBufferWriter=
function(){return new K(this.vertexBufferLayout)};a.prototype.createRenderer=function(b,a){return new I(b,a,this,f.vertexAttributeLocations)};a.prototype.getGLMaterials=function(){return{color:L,depth:C,depthShadowMap:this.params.castShadows?M:null,normal:N,highlight:O}};a.getVertexBufferLayout=function(b){var a=E.newLayout().vec3f(f.VertexAttrConstants.POSITION).vec4f(f.VertexAttrConstants.PROFILERIGHT).vec4f(f.VertexAttrConstants.PROFILEUP).vec4f(f.VertexAttrConstants.PROFILEVERTEXANDNORMAL);if(b.vvColorEnabled||
b.vvSizeEnabled||b.vvOpacityEnabled)a=a.vec4f(f.VertexAttrConstants.FEATUREVALUE);return a};return a}(F.Material);var L=function(e){function a(b){var a=e.call(this,b)||this;a.params=g.copyParameters(b.material.getParameters());a.slot=a.params.transparent?7:5;a._createPrograms();a.selectPipeline();return a}l(a,e);a.prototype._createPrograms=function(){var b=this;this.programs=r.BindParametersMap.create(this.params,function(a){return b._createProgram(a)})};a.prototype._createProgram=function(b){var a=
this.params;return this.programRep.getProgram(f.colorPass,{flipV:a.flipV,doubleSided:a.doubleSided&&"normal"===a.doubleSidedType,windowOrderDoubleSided:a.doubleSided&&"winding-order"===a.doubleSidedType,receiveShadows:b.receiveShadows,receiveSSAO:b.receiveSSAO,vvSize:a.vvSizeEnabled,vvColor:a.vvColorEnabled,vvOpacity:a.vvOpacityEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,slice:a.slicePlaneEnabled,transparencyDiscard:a.transparent,wireframe:a.wireframe})};
a.prototype.selectPipeline=function(){var b=this.params;this.pipelineState=h.makePipelineState({blending:b.transparent&&h.separateBlendingParams(770,1,771,771),culling:v(b),polygonOffset:b.polygonOffset&&w,depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program||this.getPrograms()[0]};a.prototype.getPrograms=function(){return r.BindParametersMap.programs(this.programs)};
a.prototype.updateParameters=function(){this.params=g.copyParameters(this.material.getParameters());this.slot=this.params.transparent?7:5;this._createPrograms();this.selectPipeline()};a.prototype.bind=function(b,a){var c=this.params,d=this.program=r.BindParametersMap.lookup(this.programs,a);b.bindProgram(d);b.setPipelineState(this.pipelineState);d.setUniform3fv("size",c.size);d.setUniform3fv("ambient",c.ambient);d.setUniform3fv("diffuse",c.diffuse);d.setUniform3fv("specular",c.specular);d.setUniform4fv("externalColor",
c.externalColor);d.setUniform1i("colorMixMode",g.colorMixModes[c.colorMixMode]);d.setUniform1f("opacity",c.opacity);d.setUniform1f("layerOpacity",c.layerOpacity);g.bindVerticalOffset(c.verticalOffset,a,d);g.bindScreenSizePerspective(c.screenSizePerspective,d);t(d,c)};a.prototype.release=function(b,a){};a.prototype.bindView=function(b,a){b=this.program=r.BindParametersMap.lookup(this.programs,a);var c=this.params,d=a.origin;g.bindView(d,a.view,b);g.bindCamPos(d,a.viewInvTransp,b);c.slicePlaneEnabled&&
g.bindSlicePlane(d,a.slicePlane,b);a.shadowMappingEnabled&&a.shadowMap.bindView(b,d)};a.prototype.bindInstance=function(b,a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(q),C=function(e){function a(b){var a=e.call(this,b)||this;a.biased=!!b.biased;a.updateParameters();return a}l(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=
function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(f.depthPass,{flipV:b.flipV,shadowMap:this.biased,vvSize:b.vvSizeEnabled,vvColor:b.vvColorEnabled,vvOpacity:b.vvOpacityEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,transparencyDiscard:b.transparent});this.pipelineState=h.makePipelineState({culling:v(b),polygonOffset:b.polygonOffset&&w,depthTest:{func:513},
depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?7:5};a.prototype.updateParameters=function(){this.params=g.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot()};a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);c.setUniform3fv("size",d.size);c.setUniform2fv("nearFar",a.nearFar);g.bindVerticalOffset(d.verticalOffset,
a,c);g.bindScreenSizePerspective(d.screenSizePerspective,c);t(c,d)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params,d=a.origin;g.bindView(d,a.view,b);c.slicePlaneEnabled&&g.bindSlicePlane(a.origin,a.slicePlane,b);c.screenSizePerspective&&g.bindCamPos(d,a.viewInvTransp,b)};a.prototype.bindInstance=function(a,c){this.program.setUniformMatrix4fv("model",c.transformation)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(q),
M=function(e){function a(a){return e.call(this,y({},a,{biased:!0}))||this}l(a,e);return a}(C),N=function(e){function a(a){a=e.call(this,a)||this;a.updateParameters();return a}l(a,e);a.prototype.beginSlot=function(a){return a===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(f.normalPass,{flipV:a.flipV,vvSize:a.vvSizeEnabled,vvColor:a.vvColorEnabled,vvOpacity:a.vvOpacityEnabled,verticalOffset:null!==
a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,slice:a.slicePlaneEnabled,transparencyDiscard:a.transparent});this.pipelineState=h.makePipelineState({polygonOffset:a.polygonOffset&&w,culling:v(a),depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?7:5};a.prototype.updateParameters=function(){this.params=g.copyParameters(this.material.getParameters());this.selectProgram();
this.selectSlot()};a.prototype.bind=function(a,c){var b=this.program,d=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform3fv("size",d.size);g.bindVerticalOffset(d.verticalOffset,c,b);g.bindScreenSizePerspective(d.screenSizePerspective,b);t(b,d)};a.prototype.release=function(a){};a.prototype.bindView=function(a,c){a=this.program;var b=this.params,d=c.origin;g.bindView(d,c.view,a);a.setUniformMatrix4fv("viewNormal",c.viewInvTransp);b.slicePlaneEnabled&&g.bindSlicePlane(c.origin,
c.slicePlane,a);b.screenSizePerspective&&g.bindCamPos(d,c.viewInvTransp,a)};a.prototype.bindInstance=function(a,c){a=this.program;a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(q),O=function(e){function a(a){a=e.call(this,a)||this;a.updateParameters();return a}l(a,e);a.prototype.beginSlot=function(a){return a===this.slot};a.prototype.getProgram=function(){return this.program};
a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(f.highlightPass,{flipV:a.flipV,vvSize:a.vvSizeEnabled,vvColor:a.vvColorEnabled,vvOpacity:a.vvOpacityEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,slice:a.slicePlaneEnabled,transparencyDiscard:a.transparent});this.pipelineState=h.makePipelineState({polygonOffset:a.polygonOffset&&w,culling:v(a),depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,
colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?7:5};a.prototype.updateParameters=function(){this.params=g.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot()};a.prototype.bind=function(a,c){var b=this.program,d=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform3fv("size",d.size);g.bindVerticalOffset(d.verticalOffset,c,b);g.bindScreenSizePerspective(d.screenSizePerspective,b);
t(b,d)};a.prototype.release=function(a){};a.prototype.bindView=function(a,c){a=this.program;var b=this.params,d=c.origin;g.bindView(d,c.view,a);b.slicePlaneEnabled&&g.bindSlicePlane(c.origin,c.slicePlane,a);b.screenSizePerspective&&g.bindCamPos(d,c.viewInvTransp,a)};a.prototype.bindInstance=function(a,c){a=this.program;a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(q),
J=y({size:[1,1,1],wireframe:!1,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,receiveSSAO:!0,castShadows:!0,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,transparent:!1,polygonOffset:!1},H.Default),K=function(){function e(a){this.vertexBufferLayout=a}e.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};e.prototype.elementCount=
function(a){return a.indices[f.VertexAttrConstants.POSITION].length};e.prototype.write=function(a,b,c,e){if(f.VertexAttrConstants.PROFILERIGHT in b.vertexAttr){var d=b.vertexAttr[f.VertexAttrConstants.PROFILERIGHT],g=b.indices[f.VertexAttrConstants.PROFILERIGHT];u(4===d.size);var h=c.getField(f.VertexAttrConstants.PROFILERIGHT,p.BufferViewVec4f);if(h)n.writeBufferVec4(g,d.data,h,e);else throw Error("unable to acquire view for "+f.VertexAttrConstants.PROFILERIGHT);}if(f.VertexAttrConstants.PROFILEUP in
b.vertexAttr)if(d=b.vertexAttr[f.VertexAttrConstants.PROFILEUP],g=b.indices[f.VertexAttrConstants.PROFILEUP],u(4===d.size),h=c.getField(f.VertexAttrConstants.PROFILEUP,p.BufferViewVec4f))n.writeBufferVec4(g,d.data,h,e);else throw Error("unable to acquire view for "+f.VertexAttrConstants.PROFILEUP);if(f.VertexAttrConstants.PROFILEVERTEXANDNORMAL in b.vertexAttr)if(d=b.vertexAttr[f.VertexAttrConstants.PROFILEVERTEXANDNORMAL],g=b.indices[f.VertexAttrConstants.PROFILEVERTEXANDNORMAL],u(4===d.size),h=
c.getField(f.VertexAttrConstants.PROFILEVERTEXANDNORMAL,p.BufferViewVec4f))n.writeBufferVec4(g,d.data,h,e);else throw Error("unable to acquire view for "+f.VertexAttrConstants.PROFILEVERTEXANDNORMAL);if(this.vertexBufferLayout.hasField(f.VertexAttrConstants.FEATUREVALUE)&&f.VertexAttrConstants.FEATUREVALUE in b.vertexAttr)if(d=b.vertexAttr[f.VertexAttrConstants.FEATUREVALUE],g=b.indices[f.VertexAttrConstants.FEATUREVALUE],u(4===d.size),h=c.getField(f.VertexAttrConstants.FEATUREVALUE,p.BufferViewVec4f))n.writeBufferVec4(g,
d.data,h,e);else throw Error("unable to acquire view for "+f.VertexAttrConstants.FEATUREVALUE);n.writeDefaultAttributes(b,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,c,e)};return e}(),w={factor:2,units:2},v=function(e){var a;a=e.slicePlaneEnabled?!1:e.cullFace?"none"!==e.cullFace:!e.transparent&&!e.doubleSided;return a&&{face:"front"===e.cullFace?1028:1029,mode:2305}};return x});