// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ./constants ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ./polygonUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/RibbonLineMaterial".split(" "),
function(q,v,C,D,E,F,n,G,w,r,t,H,u,x,I,J,K,k,L,M,y,z,A,N,B,O,P,Q){Object.defineProperty(v,"__esModule",{value:!0});q=function(q){function e(a,b,h,c){return q.call(this,a,b,h,c)||this}C(e,q);e.prototype.doLoad=function(){return E(this,void 0,void 0,function(){return D(this,function(a){this._prepareFillResources();this._prepareOutlineResources();return[2]})})};e.prototype._prepareFillResources=function(){var a=n.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacityAndColor(a);this._material=
new O({color:a,transparent:1>a[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},this._getIdHint("_colormat"));this._context.stage.add(3,this._material)};e.prototype._prepareOutlineResources=function(){var a=this.symbolLayer.outline;if(this._hasOutline=!!(n.isSome(a)&&a.size&&0<a.size&&n.isSome(a.color)))a=G.pt2px(n.isSome(a)?a.size:0),a=1.5<=a?new Q({width:a,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},
this._getIdHint("_outline_ribbonlinemat")):new P({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled},this._getIdHint("_outline_nativelinemat")),this._outlineMaterial=a,this._context.stage.add(3,this._outlineMaterial)};e.prototype.destroy=function(){q.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null);this._outlineMaterial&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)};
e.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if(!this._validateGeometryType(b.geometry,e.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var h="graphic"+b.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var c=this.getGraphicElevationContext(b);return"on-the-ground"===c.mode?this._createAsOverlay(b,a,c,h):this._createAs3DShape(b,a,c,h,b.uid)};e.prototype.layerOpacityChanged=function(){var a=this._material.getParameters().color,
b=n.get(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(b);this._material.setParameterValues({color:[a[0],a[1],a[2],b],transparent:1>b||this._isPropertyDriven("opacity")});this._outlineMaterial&&(a=this._outlineMaterial.getParameters().color,this._outlineMaterial.setParameterValues({color:[a[0],a[1],a[2],this._getOutlineOpacity()]}));return!0};e.prototype.layerElevationInfoChanged=function(a,b,c){var h=this._elevationContext.mode;c=k.elevationModeChangeUpdateType(e.elevationModeChangeTypes,
c,h);if(c!==k.SymbolUpdateType.UPDATE)return c;var f=k.needsElevationUpdates2D(h);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return f})};e.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._outlineMaterial&&this._outlineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};e.prototype.physicalBasedRenderingChanged=function(a,b){return!0};e.prototype.pixelRatioChanged=
function(a,b){return!0};e.prototype.setDrawOrder=function(a,b,c){this.updateSymbolLayerOrder(a,b);this._material&&(this._material.renderPriority=a+b/2,c.add(this._material.id));this._outlineMaterial&&(this._outlineMaterial.renderPriority=a,c.add(this._outlineMaterial.id))};e.prototype._createAs3DShape=function(a,b,h,e,f){var g=k.getGeometryAsPolygon(a.geometry);a=k.getGeometryVertexData3D(g.rings,g.hasZ,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,
h);c.idHint=e;c.color=b;c.data=a;var d;this._hasOutline&&(d=new Float64Array(a.vertexData));c.outNum=0;c.outGeometries=[];c.outTransforms=[];c.outMaterials=[];this._createAs3DShapeFill(c);c.data.vertexData=d;this._createAs3DShapeOutline(c);this._logGeometryCreationWarnings(c.data,g.rings,"rings","FillSymbol3DLayer");if(0===c.outNum)return null;b=new N({geometries:c.outGeometries,materials:c.outMaterials,transformations:c.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:f},
idHint:e});b=new K(this,b,c.outGeometries,null,null,I.perVertexElevationAligner,h);b.alignedTerrainElevation=a.terrainElevation;b.needsElevationUpdates=k.needsElevationUpdates2D(h.mode);return b};e.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,c=a.data.eleVertexData,e=a.data.vertexData,f=function(d){var f=b[d],l=f.count,h=f.index;if(g._context.clippingExtent&&(k.computeBoundingBox(c,h,l,m),k.boundingBoxClipped(m,g._context.clippingExtent)))return"continue";d=new Float64Array(c.buffer,
3*h*c.BYTES_PER_ELEMENT,3*l);f=f.holeIndices.map(function(a){return a-h});f=w(d,f,3);if(0===f.length)return"continue";k.applyOrigin(e,h,l,p);f=new Uint32Array(f);l=new Float64Array(e.buffer,3*h*e.BYTES_PER_ELEMENT,3*l);d=z.createPolygonGeometryData({indices:f,vertices:l,color:a.color,eleVertices:d});d=new A(d,a.idHint);d.singleUse=!0;l=t.mat4f64.create();r.mat4.translate(l,l,p);a.outGeometries.push(d);a.outMaterials.push(g._material);a.outTransforms.push(l);a.outNum++},g=this,d=0;d<b.length;++d)f(d)};
e.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,c=a.data.eleVertexData,e=a.data.vertexData,f=0;f<b.length;++f){var g=b[f],d=g.index,l=g.count;if(this._context.clippingExtent&&(k.computeBoundingBox(c,d,l,m),k.boundingBoxClipped(m,this._context.clippingExtent)))continue;k.applyOrigin(e,d,l,p);g=new Float64Array(c.buffer,3*d*c.BYTES_PER_ELEMENT,3*l);d=new Float64Array(e.buffer,3*d*e.BYTES_PER_ELEMENT,3*l);d=y.createPolylineGeometry(d,g,!1,x.WHITE,
1);d=new A(d,a.idHint+"outline"+f);d.singleUse=!0;g=t.mat4f64.create();r.mat4.translate(g,g,p);a.outGeometries.push(d);a.outMaterials.push(this._outlineMaterial);a.outTransforms.push(g);a.outNum++}};e.prototype._createAsOverlay=function(a,b,e,m){e=k.getGeometryAsPolygon(a.geometry);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);var f=k.getGeometryVertexDataDraped(e.rings,e.spatialReference,
this._context.overlaySR);c.idHint=m;c.color=b;c.data=f;var g;this._hasOutline&&(g=new Float64Array(f.vertexData));c.outNum=0;c.outGeometries=[];c.outBoundingBox=u.empty();c.layerUid=this._context.layer.uid;c.graphicsUid=a.uid;this._createAsOverlayFill(c);c.data.vertexData=g;this._createAsOverlayOutline(c);this._logGeometryCreationWarnings(c.data,e.rings,"rings","FillSymbol3DLayer");return 0<c.outNum?new J(this,c.outGeometries,c.outBoundingBox):null};e.prototype._createAsOverlayFill=function(a){for(var c=
a.data.vertexData,e=a.data.geometryData.polygons,n=function(d){var b=e[d];d=b.count;var g=b.index;k.computeBoundingBox(c,g,d,m);if(k.boundingBoxClipped(m,f._context.clippingExtent))return"continue";var h=new Float64Array(c.buffer,3*g*c.BYTES_PER_ELEMENT,3*d),b=b.holeIndices.map(function(a){return a-g}),h=w(h,b,3);if(0===h.length)return"continue";u.expand(a.outBoundingBox,m);k.applyOrigin(c,g,d,p);k.setZ(c,g,d,f._getDrapedZ());d=new Uint32Array(h.length);for(b=0;b<h.length;b++)d[b]=h[b]+g;d=z.createPolygonGeometryData({indices:d,
vertices:c,color:a.color});h=new B(d);h.data.layerUid=a.layerUid;h.data.graphicUid=a.graphicsUid;h.material=f._material;b=m;h.center=[.5*(b[0]+b[3]),.5*(b[1]+b[4]),0];h.bsRadius=.5*Math.sqrt((b[3]-b[0])*(b[3]-b[0])+(b[4]-b[1])*(b[4]-b[1]));b=t.mat4f64.create();r.mat4.translate(b,b,p);h.transformation=b;h.name=a.idHint;h.uniqueName=a.idHint+"#"+d.id;a.outGeometries.push(h);a.outNum++},f=this,g=0;g<e.length;++g)n(g)};e.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=a.data.vertexData,
c=a.data.geometryData.outlines,e=0;e<c.length;++e){var f=c[e],g=f.index,f=f.count;k.computeBoundingBox(b,g,f,m);if(!k.boundingBoxClipped(m,this._context.clippingExtent)){u.expand(a.outBoundingBox,m);k.applyOrigin(b,g,f,p);k.setZ(b,g,f,this._getDrapedZ());g=new Float64Array(b.buffer,3*g*b.BYTES_PER_ELEMENT,3*f);g=y.createPolylineGeometry(g,null,!0,x.WHITE,1);f=new B(g);f.data.layerUid=a.layerUid;f.data.graphicUid=a.graphicsUid;f.material=this._outlineMaterial;var d=m;f.center=[.5*(d[0]+d[3]),.5*(d[1]+
d[4]),0];f.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]));d=t.mat4f64.create();r.mat4.translate(d,d,p);f.transformation=d;f.name=a.idHint+"outline";f.uniqueName=a.idHint+"outline#"+g.id;a.outGeometries.push(f);a.outNum++}}};e.prototype._getOutlineOpacity=function(){var a=n.get(this.symbolLayer,"outline","color");return this._getLayerOpacity()*(n.isSome(a)?a.a:0)};e.prototype._getOutlineColor=function(){var a=n.get(this.symbolLayer,"outline","color"),b=this._getOutlineOpacity();
return M.mixinColorAndOpacity(n.isSome(a)?F.toUnitRGB(a):null,b)};e.validGeometryTypes=["polyline","polygon","extent"];e.elevationModeChangeTypes={definedChanged:k.SymbolUpdateType.RECREATE,staysOnTheGround:k.SymbolUpdateType.NONE,onTheGroundChanged:k.SymbolUpdateType.RECREATE};return e}(L.default);v.Graphics3DPolygonFillSymbolLayer=q;var m=u.create(),p=H.vec3f64.create(),c={idHint:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null,color:null};v.default=
q});