// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/Accessor ../../../core/Handles ../../../core/now ../../../core/scheduling ../../../core/accessorSupport/decorators ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),function(w,f,e,k,m,n,p,q,d,r,t,u,v){Object.defineProperty(f,"__esModule",{value:!0});var l=function(g){function b(){var b=null!==g&&g.apply(this,arguments)||this;b.updating=!1;return b}
k(b,g);e([d.property({readOnly:!0})],b.prototype,"updating",void 0);return b=e([d.subclass("esri.views.3d.support.ResourceController")],b)}(d.declared(m));f.ResourceControllerMaster=l;f.newResourceController=function(d,b){void 0===b&&(b=p);return new h.ResourceController({view:d,now:b})};var h;(function(g){var b=function(b){function a(){var c=null!==b&&b.apply(this,arguments)||this;c._scheduler=null;c._memoryController=null;c._streamDataLoader=null;c._lastTargetChangeTime=0;c._handles=new n;c._frameTask=
null;return c}k(a,b);a.prototype.initialize=function(){var c=this;this._lastTargetChangeTime=this.now();this._scheduler=v.newScheduler(this.now);this._memoryController=t.newMemoryController(this.view);this._streamDataLoader=new u.default;this._streamDataLoader.setup(r.downloadSlotsPerClient,this._scheduler);this._handles.add([this.view.watch("state.camera",function(){return c._cameraChangedHandler()},!0),this.view.watch("stationary",function(){return c._stationaryChangedHandler()}),this._memoryController.events.on("updating-changed",
function(){return c.notifyChange("updating")})]);this._frameTask=q.addFrameTask({update:function(a){return c.frame(a)}})};a.prototype.destroy=function(){this._handles.destroy();this._handles=null;this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._streamDataLoader&&(this._streamDataLoader.destroy(),this._streamDataLoader=null);this._memoryController.destroy();this._memoryController=null;this._scheduler.destroy();this._scheduler=null};Object.defineProperty(a.prototype,"updating",
{get:function(){return!!(this._memoryController&&this._memoryController.updating||this._streamDataLoader&&this._streamDataLoader.updating)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"scheduler",{get:function(){return this._scheduler},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"memoryController",{get:function(){return this._memoryController},enumerable:!0,configurable:!0});a.prototype.createStreamDataRequester=function(a){var b=this._streamDataLoader;
return{request:function(c,d,e){return b.request(c,d,a,e)},get busy(){return b.busy}}};a.prototype.frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(a.deltaTime/1E3),!this._scheduler))return;this._scheduler.state=this.state;this._scheduler.updateBudget(a)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};a.prototype._cameraChangedHandler=function(){this._lastTargetChangeTime=
this._scheduler.now;this._scheduler.state=this.state};a.prototype._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};Object.defineProperty(a.prototype,"state",{get:function(){return this._scheduler.now-this._lastTargetChangeTime>f?2:this.view.animation?0:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"test",{get:function(){var a=this;return{getQueueStats:function(b){return a._streamDataLoader.test.loadQueue.getStatsForType(b)}}},enumerable:!0,configurable:!0});
e([d.property({constructOnly:!0})],a.prototype,"view",void 0);e([d.property({constructOnly:!0})],a.prototype,"now",void 0);e([d.property()],a.prototype,"_streamDataLoader",void 0);e([d.property({readOnly:!0,dependsOn:["_streamDataLoader.updating"]})],a.prototype,"updating",null);return a=e([d.subclass("esri.views.3d.support.ResourceController")],a)}(d.declared(l));g.ResourceController=b;var f=300})(h||(h={}))});