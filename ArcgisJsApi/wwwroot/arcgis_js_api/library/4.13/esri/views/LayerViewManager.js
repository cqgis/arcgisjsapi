// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../core/Error ../core/HandleOwner ../core/Logger ../core/promiseUtils ../core/scheduling ../core/watchUtils ../core/accessorSupport/decorators ./support/WatchUpdatingTracking".split(" "),function(q,r,u,m,v,w,n,x,y,h,z,A,k,B){function t(d,c){d&&"importLayerViewModule"in d&&d.importLayerViewModule(c)}Object.defineProperty(r,"__esModule",{value:!0});
var C=y.getLogger("esri.views.LayerViewManager"),l=new Map;l.set("view.map.basemap.baseLayers","view.basemapView.baseLayerViews");l.set("view.map.ground.layers","view.groundView.layerViews");l.set("view.map.layers","view.layerViews");l.set("view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews");var D=function(){function d(c,b){var a=this;this.layer=c;this.view=b;this._controller=h.createAbortController();this._deferred=h.createDeferred();this.done=this._started=!1;h.onAbort(this._controller.signal,
function(){var b=new n("cancelled:layerview-create","layerview creation cancelled",{layer:c});a._deferred.reject(b)})}Object.defineProperty(d.prototype,"promise",{get:function(){return this._deferred.promise},enumerable:!0,configurable:!0});d.prototype.destroy=function(){this._controller.abort();var c=this.layerView;if(c){var b=this.layer,a=this.view;b.destroyLayerView(c);b.emit("layerview-destroy",{view:a,layerView:c});a.emit("layerview-destroy",{layer:b,layerView:c});this.done=!0;this.view=this.layerView=
this.layer=null;c.layer=null;c.parent=null;c.view=null}};d.prototype.start=function(){return w(this,void 0,void 0,function(){var c,b,a,g,e,p,d;return v(this,function(f){switch(f.label){case 0:if(this._started)return[2];this._started=!0;c=this;b=c._controller.signal;a=c.layer;g=c.view;this._map=g.map;f.label=1;case 1:return f.trys.push([1,5,,6]),[4,a.load({signal:b})];case 2:return f.sent(),[4,a.createLayerView(g,{signal:b})];case 3:return e=f.sent(),[4,e.when()];case 4:f.sent();p=this._map&&this._map.allLayers.includes(a);
if(!p||b.aborted)return e.layer.destroyLayerView(e),e.layer=e.parent=e.view=null,this.done=!0,p?[2]:[2,this._deferred.reject(new n("view:no-layerview-for-layer","The layer has been removed from the map",{layer:a}))];this.layerView=e;a.emit("layerview-create",{view:g,layerView:e});g.emit("layerview-create",{layer:a,layerView:e});this.done=!0;this._deferred.resolve(e);return[3,6];case 5:return d=f.sent(),a.emit("layerview-create-error",{view:g,error:d}),g.emit("layerview-create-error",{layer:a,error:d}),
this.done=!0,this._deferred.reject(new n("layerview:create-error","layerview creation failed",{layer:a,error:d})),[3,6];case 6:return[2]}})})};return d}();q=function(d){function c(b){var a=d.call(this)||this;a._layerLayerViewInfoMap=new Map;a.watchUpdatingTracking=new B.WatchUpdatingTracking;a.view=null;a._preloadLayerViewModules=function(){var b=a.view,c=a.get("view.map.allLayers");b&&c&&c.forEach(function(a){return t(a,b)})};a._doWork=a._doWork.bind(a);a._reschedule=a._reschedule.bind(a);a.handles.add(A.on(a,
"view.map.allLayers","change",a._preloadLayerViewModules,a._preloadLayerViewModules));a.handles.add(a.watch(["view.map.basemap","view.map.ground","view.map.layers","view.internallyReady"],a._reschedule,!0));return a}u(c,d);c.prototype.destroy=function(){this.clear();this.watchUpdatingTracking.destroy();this._map=this.view=null};Object.defineProperty(c.prototype,"updating",{get:function(){if(this.handles.has("reschedule")||this.watchUpdatingTracking.updating)return!0;var b=!0;this._layerLayerViewInfoMap.forEach(function(a){return b=
b&&a.done});return!b},enumerable:!0,configurable:!0});c.prototype.clear=function(){this.destroyed||(this._layerLayerViewInfoMap.forEach(function(b){return b.destroy()}),this._layerLayerViewInfoMap.clear(),this._refreshCollections())};c.prototype.whenLayerView=function(b){this._reschedule();this._doWork();return this._layerLayerViewInfoMap.has(b)?this._layerLayerViewInfoMap.get(b).promise:h.reject(new n("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:b}))};c.prototype._reschedule=
function(){this.handles.remove("reschedule");this.handles.add(z.schedule(this._doWork),"reschedule");this.notifyChange("updating")};c.prototype._doWork=function(){var b=this.get("view.map");this._map!==b&&(this.clear(),this._map=b);if(this.handles.has("reschedule")){this.handles.remove("reschedule");this.handles.remove("collection-change");var a=b&&b.allLayers;if(a){a.forEach(this._createLayerView,this);this._refreshCollections();var c=[];this._layerLayerViewInfoMap.forEach(function(b,e){a.includes(e)||
c.push(b)});for(b=0;b<c.length;b++){var e=c[b];this._layerLayerViewInfoMap.delete(e.layer);e.destroy()}this.handles.add(this.watchUpdatingTracking.addOnCollectionChange(a,this._reschedule),"collection-change");this.notifyChange("updating")}}};c.prototype._refreshCollections=function(){var b=this;l.forEach(function(a,c){b._populateLayerViewsOwners(b.get(c),b.get(a),b.view)})};c.prototype._populateLayerViewsOwners=function(b,a,c){var e=this;if(b&&a){var d=0;b.forEach(function(b){var f=e._layerLayerViewInfoMap.get(b);
f&&f.layerView&&(f=f.layerView,f.layer=b,f.parent=c,a.getItemAt(d)!==f&&a.splice(d,0,f),b.layers&&e._populateLayerViewsOwners(b.layers,f.layerViews,f),d+=1)});d<a.length&&a.splice(d,a.length)}else a&&a.removeAll()};c.prototype._createLayerView=function(b){var a=this,c=this.view;this._layerLayerViewInfoMap.has(b)?this.get("view.internallyReady")&&this._layerLayerViewInfoMap.get(b).start():(b.load(),t(b,c),c=new D(b,this.view),c.promise.then(function(){a._refreshCollections();a.notifyChange("updating")},
function(c){c&&(h.isAbortError(c)||"cancelled:layerview-create"===c.name)||C.error("Failed to create view for layer '"+b.title+", id:"+b.id+"' of type '"+b.type+"'.",{error:c});a._refreshCollections();a.notifyChange("updating")}),this._layerLayerViewInfoMap.set(b,c),this.get("view.internallyReady")&&c.start());this.notifyChange("updating")};m([k.property({readOnly:!0})],c.prototype,"watchUpdatingTracking",void 0);m([k.property({readOnly:!0,dependsOn:["watchUpdatingTracking.updating"]})],c.prototype,
"updating",null);m([k.property()],c.prototype,"view",void 0);return c=m([k.subclass("esri.views.LayerViewManager")],c)}(k.declared(x.HandleOwner));r.default=q});