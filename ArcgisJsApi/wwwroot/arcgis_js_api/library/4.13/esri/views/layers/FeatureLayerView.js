// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../core/Error ../../core/iteratorUtils ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/support/fieldUtils ../../layers/support/timeUtils ../../support/arcadeOnDemand ../../tasks/support/Query ./support/FeatureEffect ./support/FeatureFilter ./support/popupUtils".split(" "),
function(K,f,B,e,L,x,q,y,C,D,r,t,E,c,h,F,G,H,I,J,u){Object.defineProperty(f,"__esModule",{value:!0});var z=D.getLogger("esri.views.layers.FeatureLayerView");f.FeatureLayerView=function(f){return function(f){function a(){for(var b=[],d=0;d<arguments.length;d++)b[d]=arguments[d];b=f.apply(this,b)||this;b._updatingRequiredFieldsPromise=null;b.effect=null;b.filter=null;b.layer=null;b.requiredFields=null;b.view=null;return b}B(a,f);a.prototype.initialize=function(){var b=this;E.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo filter effect layer.timeInfo timeExtent".split(" "),
function(){return b._handleRequiredFieldsChange()},!0)};Object.defineProperty(a.prototype,"availableFields",{get:function(){var b=this.layer,d=this.layer.fields,a=this.requiredFields;return"outFields"in b&&b.outFields?h.fixFields(d,h.unpackFieldNames(d,b.outFields).concat(a)):h.fixFields(d,a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(b){z.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!1},enumerable:!0,configurable:!0});a.prototype.highlight=function(b,d){void 0===d&&(d={});return this.inherited(arguments)};a.prototype.createQuery=function(){var b={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},b=r.isSome(this.filter)?this.filter.createQuery(b):new H(b);this.timeExtent&&(b.timeExtent=b.timeExtent?b.timeExtent.intersection(this.timeExtent):
this.timeExtent.clone());return b};a.prototype.queryFeatures=function(b,d){return this.inherited(arguments)};a.prototype.queryObjectIds=function(b,d){return this.inherited(arguments)};a.prototype.queryFeatureCount=function(b,d){return this.inherited(arguments)};a.prototype.queryExtent=function(b,d){return this.inherited(arguments)};a.prototype._loadArcadeModules=function(b){if(b.get("expressionInfos.length"))return G.loadArcade()};a.prototype._handleRequiredFieldsChange=function(){var b=this,d=this._updateRequiredFields();
this._set("_updatingRequiredFieldsPromise",d);d.then(function(){b._updatingRequiredFieldsPromise===d&&b._set("_updatingRequiredFieldsPromise",null)})};a.prototype._updateRequiredFields=function(){return q(this,void 0,void 0,function(){var b,d,a,v,c,e,f,g,l,m,k,n,p;return x(this,function(A){switch(A.label){case 0:if(!this.layer||!this.view)return[2];b="3d"===this.view.type;d=this;v=a=d.layer;c=v.fields;e=v.objectIdField;f=v.renderer;g=new Set;return[4,t.eachAlways([f?f.collectRequiredFields(g,c):null,
h.collectLabelingFields(g,a),b?h.collectElevationFields(g,a):null,r.isSome(this.filter)?h.collectFilterFields(g,a,this.filter):null,this.effect?h.collectFilterFields(g,a,this.effect.filter):null])];case 1:l=A.sent();a.timeInfo&&this.timeExtent&&h.collectFields(g,a.fields,[a.timeInfo.startField,a.timeInfo.endField]);m=0;for(k=l;m<k.length;m++)n=k[m],n.error&&z.error(n.error);h.collectField(g,c,e);p=C.valuesOfSet(g).sort();this._set("requiredFields",p);return[2]}})})};a.prototype.validateFetchPopupFeatures=
function(b){var a=this.layer;if(!this.layer.popupEnabled)return new y("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(!u.getFetchPopupTemplate(this.layer,b))return new y("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})};a.prototype.fetchClientPopupFeatures=function(b){return q(this,void 0,void 0,function(){var a,c,e,f,w,q,g,l,m,k,n,p;return x(this,function(d){switch(d.label){case 0:a=r.isSome(b)?b.clientGraphics:null;if(!a||0===a.length)return[2,
t.resolve([])];c=[];e=[];f=this.layer;w=u.getFetchPopupTemplate(f,b);return r.isSome(w)?[4,this._loadArcadeModules(w)]:[2,t.resolve([])];case 1:return g=(q=d.sent())&&q.arcadeUtils.hasGeometryOperations(w),[4,this.createPopupQuery(b)];case 2:l=d.sent();m=h.unpackFieldNames(f.fields,l.outFields);k=0;for(n=a;k<n.length;k++)p=n[k],g||!h.featureHasFields(m,p)?e.push(p):c.push(p);if(0===e.length)return[2,t.resolve(c)];l.objectIds=e.map(function(a){return a.attributes[f.objectIdField]});return[2,f.queryFeatures(l).then(function(a){return c.concat(a.features)}).catch(function(){return e})]}})})};
a.prototype.createPopupQuery=function(a){return q(this,void 0,void 0,function(){var b,c,e;return x(this,function(d){switch(d.label){case 0:return b=this.layer,c=b.createQuery(),c.returnGeometry=!0,c.returnZ=!0,c.returnM=!0,e=c,[4,u.getRequiredFields(this.layer,u.getFetchPopupTemplate(this.layer,a))];case 1:return e.outFields=d.sent(),c.outSpatialReference=this.view.spatialReference,[2,c]}})})};e([c.property()],a.prototype,"_updatingRequiredFieldsPromise",void 0);e([c.property({readOnly:!0,dependsOn:["layer.outFields?",
"requiredFields"]})],a.prototype,"availableFields",null);e([c.property({type:I})],a.prototype,"effect",void 0);e([c.property({type:J})],a.prototype,"filter",void 0);e([c.property(F.combinedViewLayerTimeExtentProperty)],a.prototype,"timeExtent",void 0);e([c.property()],a.prototype,"layer",void 0);e([c.property({type:Number})],a.prototype,"maximumNumberOfFeatures",null);e([c.property({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",null);e([c.property({readOnly:!0})],a.prototype,
"requiredFields",void 0);e([c.property()],a.prototype,"view",void 0);return a=e([c.subclass("esri.views.layers.FeatureLayerView")],a)}(c.declared(f))}});