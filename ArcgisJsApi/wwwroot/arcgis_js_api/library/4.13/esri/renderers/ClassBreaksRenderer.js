// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/paramHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/assignHelper ../symbols ../symbols ../core/jsonMap ../core/lang ../core/Logger ../core/promiseUtils ../core/accessorSupport/decorators ../core/accessorSupport/ensureType ../layers/support/fieldUtils ./Renderer ./mixins/VisualVariablesMixin ./support/ClassBreakInfo ./support/LegendOptions ../support/arcadeOnDemand ../symbols/support/jsonUtils".split(" "),
function(J,K,A,f,B,p,q,w,x,k,C,l,D,E,c,r,t,F,G,m,H,y,g){var u=D.getLogger("esri.renderers.ClassBreaksRenderer"),n=new C.default({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),I=r.ensureType(m.ClassBreakInfo);return function(z){function a(b){b=z.call(this)||this;b.backgroundFillSymbol=null;b.classBreakInfos=null;b.defaultLabel=null;b.defaultSymbol=null;b.field=null;b.isMaxInclusive=!0;b.legendOptions=null;b.normalizationField=null;b.normalizationTotal=
null;b.type="class-breaks";b.valueExpression=null;b.valueExpressionTitle=null;b._set("classBreakInfos",[]);return b}A(a,z);v=a;Object.defineProperty(a.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!0,configurable:!0});a.prototype.readClassBreakInfos=function(b,d,e){if(Array.isArray(b)){var a=d.minValue;return b.map(function(b){var d=new m.ClassBreakInfo;d.read(b,e);null==d.minValue&&(d.minValue=a);null==d.maxValue&&(d.maxValue=d.minValue);a=d.maxValue;return d})}};a.prototype.writeClassBreakInfos=
function(b,d,e,a){b=b.map(function(b){return b.write({},a)});this._areClassBreaksConsecutive()&&b.forEach(function(b){return delete b.classMinValue});d[e]=b};a.prototype.readDefaultSymbol=function(b,d,e){return g.read(b,d,e)};a.prototype.writeDefaultSymbolWebScene=function(b,d,e,a){g.writeTarget(b,d,e,a)};a.prototype.writeDefaultSymbol=function(b,d,a,h){g.writeTarget(b,d,a,h)};a.prototype.castField=function(b){return null==b?b:"function"===typeof b?(u.error(".field: field must be a string value"),
null):r.ensureString(b)};Object.defineProperty(a.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"normalizationType",{get:function(){var b=this._get("normalizationType"),d=!!this.normalizationField,a=null!=this.normalizationTotal;if(d||a)b=d&&"field"||a&&"percent-of-total"||null,d&&a&&u.warn("warning: both normalizationField and normalizationTotal are set!");
else if("field"===b||"percent-of-total"===b)b=null;return b},set:function(b){this._set("normalizationType",b)},enumerable:!0,configurable:!0});a.prototype.addClassBreakInfo=function(b,d,a){var e=null,e="number"===typeof b?new m.ClassBreakInfo({minValue:b,maxValue:d,symbol:a}):I(l.clone(b));this.classBreakInfos.push(e);1===this.classBreakInfos.length&&this.notifyChange("minValue")};a.prototype.removeClassBreakInfo=function(b,d){for(var a=this.classBreakInfos.length,h=0;h<a;h++){var c=[this.classBreakInfos[h].minValue,
this.classBreakInfos[h].maxValue];if(c[0]===b&&c[1]===d){this.classBreakInfos.splice(h,1);break}}};a.prototype.getBreakIndex=function(b,a){return this.valueExpression?this._getBreakIndexForExpression(b,a):this._getBreakIndexForField(b)};a.prototype.getClassBreakInfo=function(b,a){return q(this,void 0,void 0,function(){var d,c,f;return p(this,function(e){switch(e.label){case 0:return d=a,this.valueExpression?[4,y.loadArcade()]:[3,2];case 1:c=e.sent().arcadeUtils,d=w({},d,{arcadeUtils:c}),e.label=2;
case 2:return f=this.getBreakIndex(b,d),[2,-1!==f?this.classBreakInfos[f]:null]}})})};a.prototype.getSymbol=function(b,a){if(!this.valueExpression||a&&a.arcadeUtils)return b=this.getBreakIndex(b,a),-1<b?this.classBreakInfos[b].symbol:this.defaultSymbol;u.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used")};a.prototype.getSymbolAsync=function(b,a){return q(this,void 0,void 0,function(){var d,c,f;return p(this,function(e){switch(e.label){case 0:return d=a,this.valueExpression?
[4,y.loadArcade()]:[3,2];case 1:c=e.sent().arcadeUtils,d=w({},d,{arcadeUtils:c}),e.label=2;case 2:return f=this.getBreakIndex(b,d),[2,-1<f?this.classBreakInfos[f].symbol:this.defaultSymbol]}})})};a.prototype.getSymbols=function(){var b=[];this.classBreakInfos.forEach(function(a){a.symbol&&b.push(a.symbol)});this.defaultSymbol&&b.push(this.defaultSymbol);return b};a.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(b,a){return b+a.getAttributeHash()},
"")};a.prototype.getMeshHash=function(){var b=JSON.stringify(this.backgroundFillSymbol),a=JSON.stringify(this.defaultSymbol),e=this.normalizationField+"."+this.normalizationType+"."+this.normalizationTotal,c=this.classBreakInfos.reduce(function(b,a){return b+a.getMeshHash()},"");return b+"."+a+"."+c+"."+e+"."+this.field+"."+this.valueExpression};a.prototype.clone=function(){return new v({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,
defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:l.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:l.clone(this.visualVariables),legendOptions:l.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})};
a.prototype.collectRequiredFields=function(b,a){return q(this,void 0,void 0,function(){var d;return p(this,function(e){switch(e.label){case 0:return d=this.getSymbols().map(function(d){return d.collectRequiredFields(b,a)}).concat([this.collectVVRequiredFields(b,a),t.collectArcadeFieldNames(b,a,this.valueExpression)]),t.collectField(b,a,this.field),t.collectField(b,a,this.normalizationField),[4,E.all(d)];case 1:return e.sent(),[2]}})})};a.prototype._getBreakIndexForExpression=function(b,a){var d=a.arcadeUtils,
c=a.viewingMode,f=a.scale;a=a.spatialReference;var g=this._cache.compiledFunc;g||(g=d.createSyntaxTree(this.valueExpression),g=d.createFunction(g),this._cache.compiledFunc=g);b=d.executeFunction(g,d.createExecContext(b,d.getViewInfo({viewingMode:c,scale:f,spatialReference:a})));return this._getBreakIndexfromInfos(b)};a.prototype._getBreakIndexForField=function(b){var a=b.attributes;b=this.normalizationType;var e=parseFloat(a[this.field]);if(b){var c=this.normalizationTotal,a=parseFloat(a[this.normalizationField]);
if("log"===b)e=Math.log(e)*Math.LOG10E;else if("percent-of-total"===b&&!isNaN(c))e=e/c*100;else if("field"===b&&!isNaN(a)){if(isNaN(e)||isNaN(a))return-1;e/=a}}return this._getBreakIndexfromInfos(e)};a.prototype._getBreakIndexfromInfos=function(a){var b=this.isMaxInclusive;if(null!=a&&"number"===typeof a&&!isNaN(a))for(var e=0;e<this.classBreakInfos.length;e++){var c=[this.classBreakInfos[e].minValue,this.classBreakInfos[e].maxValue];if(c[0]<=a&&(b?a<=c[1]:a<c[1]))return e}return-1};a.prototype._areClassBreaksConsecutive=
function(){for(var a=this.classBreakInfos,d=a.length,c=1;c<d;c++)if(a[c-1].maxValue!==a[c].minValue)return!1;return!0};var v;f([c.property({readOnly:!0,dependsOn:["valueExpression"]})],a.prototype,"_cache",null);f([c.property({types:{base:x.BaseSymbol,key:"type",typeMap:{"simple-fill":k.symbolTypesRenderer.typeMap["simple-fill"],"picture-fill":k.symbolTypesRenderer.typeMap["picture-fill"],"polygon-3d":k.symbolTypesRenderer.typeMap["polygon-3d"]}},json:{origins:{"web-scene":{type:x.PolygonSymbol3D,
read:g.read,write:g.writeTarget}},read:g.read,write:g.writeTarget}})],a.prototype,"backgroundFillSymbol",void 0);f([c.property({type:[m.ClassBreakInfo]})],a.prototype,"classBreakInfos",void 0);f([c.reader("classBreakInfos")],a.prototype,"readClassBreakInfos",null);f([c.writer("classBreakInfos")],a.prototype,"writeClassBreakInfos",null);f([c.property({type:String,json:{write:!0}})],a.prototype,"defaultLabel",void 0);f([c.property({types:k.symbolTypesRenderer})],a.prototype,"defaultSymbol",void 0);
f([c.reader("defaultSymbol")],a.prototype,"readDefaultSymbol",null);f([c.writer("web-scene","defaultSymbol",{defaultSymbol:{types:k.symbolTypesRenderer3D}})],a.prototype,"writeDefaultSymbolWebScene",null);f([c.writer("defaultSymbol")],a.prototype,"writeDefaultSymbol",null);f([c.property({type:String,json:{write:!0}})],a.prototype,"field",void 0);f([c.cast("field")],a.prototype,"castField",null);f([c.property({type:Boolean})],a.prototype,"isMaxInclusive",void 0);f([c.property({type:H.default,json:{write:!0}})],
a.prototype,"legendOptions",void 0);f([c.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],a.prototype,"minValue",null);f([c.property({type:String,json:{write:!0}})],a.prototype,"normalizationField",void 0);f([c.property({type:Number,cast:function(a){return r.ensureNumber(a)},json:{write:!0}})],a.prototype,"normalizationTotal",
void 0);f([c.property({type:n.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:n.jsonValues,read:n.read,write:n.write}})],a.prototype,"normalizationType",null);f([c.enumeration.serializable()({classBreaks:"class-breaks"})],a.prototype,"type",void 0);f([c.property({type:String,json:{write:!0}})],a.prototype,"valueExpression",void 0);f([c.property({type:String,json:{write:!0}})],a.prototype,"valueExpressionTitle",void 0);f([B(2,c.cast(k.ensureType))],a.prototype,
"addClassBreakInfo",null);return a=v=f([c.subclass("esri.renderers.ClassBreaksRenderer")],a)}(c.declared(G.VisualVariablesMixin(F)))});