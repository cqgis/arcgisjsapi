// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../geometry ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/quantizationUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/arcgisLayerUrl ../../../../layers/support/fieldUtils ../../statistics/support/predominanceUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/utils ../../../../tasks/GenerateRendererTask ../../../../tasks/support/GenerateRendererParameters ../../../../tasks/support/QuantizationParameters ../../../../tasks/support/Query ../../../../tasks/support/StatisticDefinition ../../../../tasks/support/UniqueValueDefinition".split(" "),
function(Z,aa,B,P,K,A,w,Q,C,r,u,R,g,D,F,L,M,S,E,G,n,T,U,m,V,H,W,X,I,Y){return function(N){function d(a){return N.call(this,a)||this}P(d,N);d.prototype.destroy=function(){this._hasLocalSource=null};d.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!S.isHostedAgolService(a.url)&&10.5>a.version?g.reject(new u("feature-layer-adapter:not-supported","Layer does not support statistics query")):g.resolve()};
d.prototype._fetchFeaturesFromMemory=function(a,c){var b=this.layer;return this._hasLocalSource?g.resolve(b.source):a?a.whenLayerView(b).then(function(a){var b=D.whenFalseOnce(a,"updating").then(function(){return a.queryFeatures(c)}).then(function(a){return a.features});return g.timeout(b,1E4,null)}):g.reject(new u("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};d.prototype._fetchFeaturesFromService=function(a){return this.layer.queryFeatures(a).then(function(a){return a&&
a.features})};d.prototype._fetchFeaturesForStats=function(a){var c=this,b=this.layer;return r.safeCast(T.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})).then(function(e){var f=b.createQuery();f.returnGeometry=!1;f.outFields=e;return b.queryFeatures(f).then(function(a){return a&&a.features}).catch(function(b){return c._fetchFeaturesFromMemory(a.view)})})};d.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,b=a.normalizationField;
return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,c,e;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(e=b.maxValue-b.minValue,c=b.minValue+e/2,e*=4);return m.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:e})})};d.prototype._getSummaryStatsQuery=function(a,
c){var b=a.field,e=(c=this.supportsSQLExpression&&c?m.msSinceUnixEpochSQL(this,b):a.sqlExpression)||b,b=e?n.getRangeExpr(e,a.minValue,a.maxValue):null;a=n.mergeWhereClauses(a.sqlWhere,b);b=this.layer.createQuery();b.where=n.mergeWhereClauses(b.where,a);b.sqlFormat=c?"standard":null;b.outStatistics=m.statisticTypes.map(function(a){var b=new I;b.statisticType="variance"===a?"var":a;b.onStatisticField=e;b.outStatisticFieldName=a+"_value";return b});return b};d.prototype._summaryStatsFromServiceQuery=
function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getSummaryStatsQuery(a,c))}).then(function(a){return m.getSummaryStatisticsFromFeatureSet(a,c)}).then(m.processSummaryStatisticsResult)};d.prototype._summaryStatsFromClientQuery=function(a,c){var b=this,e=a.view;return e?e.whenLayerView(this.layer).then(function(e){var f=D.whenFalseOnce(e,"updating").then(function(){return e.queryFeaturesJSON(b._getSummaryStatsQuery(a,c))}).then(function(a){return m.getSummaryStatisticsFromFeatureSet(a,
c)}).then(m.processSummaryStatisticsResult);g.timeout(f,1E4,null);return f}):g.reject(new u("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};d.prototype._summaryStatsFromMemory=function(a,c){return w(this,void 0,void 0,function(){var b,e,f,k,h,t,d,l,x,q,g,y,v,z,n,r,O;return A(this,function(p){switch(p.label){case 0:return b=a.field,e="function"===typeof b,h=(k=(f=a.valueExpression)||a.sqlExpression)&&!a.sqlExpression,t=this._hasLocalSource||a.features,
d=e||h,l=a.view,x={field:b,valueExpression:f,normalizationField:a.normalizationField,view:l},t||!d?[3,2]:[4,this._fetchFeaturesForStats(x)];case 1:return g=p.sent(),[3,5];case 2:return(y=a.features)?[3,4]:[4,this._fetchFeaturesFromMemory(l)];case 3:y=p.sent(),p.label=4;case 4:g=y,p.label=5;case 5:v=(q=g)&&q.length;if(!v)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");z=B({},a);return"percent-of-total"!==z.normalizationType?[3,7]:[4,m.calculateStatsFromMemory({field:b},
q)];case 6:n=p.sent();r=n.sum;if(null==r)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");z.normalizationTotal=r;p.label=7;case 7:return[4,m.calculateStatsFromMemory(z,q,c)];case 8:return O=p.sent(),[2,m.processSummaryStatisticsResult(O)]}})})};d.prototype._uvFromGenRenderer=function(a,c){var b=this,e=a.field,f=new Y;f.attributeField=e;var k=new H;k.classificationDefinition=f;return this.generateRenderer(k).then(function(a){var c={},f=b.getField(e);a.uniqueValues.forEach(function(a){var b=
a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:E.isNumericField(f)&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return m.createUVResult(b,"service-generate-renderer",c,a.returnAllCodedValues)})};d.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,e="countOF"+(c||"Expr"),f=new I;f.statisticType="count";f.onStatisticField=b?"1":c;f.outStatisticFieldName=e;e=this.layer.createQuery();
e.where=n.mergeWhereClauses(e.where,a.sqlWhere);e.sqlFormat=b?"standard":null;e.outStatistics=[f];e.groupByFieldsForStatistics=[c||b];return e};d.prototype._uvFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a))}).then(function(c){return m.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return m.createUVResult(b,"service-query",c,a.returnAllCodedValues)})};d.prototype._uvFromClientQuery=function(a,
c){var b=this,e=a.view;return e?e.whenLayerView(this.layer).then(function(e){var f=D.whenFalseOnce(e,"updating").then(function(){return e.queryFeaturesJSON(b._getUVQuery(a))}).then(function(c){return m.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return m.createUVResult(b,"service-query",c,a.returnAllCodedValues)});g.timeout(f,1E4,null);return f}):g.reject(new u("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};d.prototype._uvFromMemory=
function(a,c){var b=a.valueExpression,e=a.sqlExpression,f=a.view,k={field:a.field,valueExpression:b,view:f};return(this._hasLocalSource||a.features||!b||e?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(f):this._fetchFeaturesForStats(k)).then(function(b){return r.safeCast(m.calculateUniqueValuesFromMemory(a,b,c))})};d.prototype._calcBinsSQL=function(a,c){var b=[],e=c.length;c.forEach(function(c,k){c=n.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(k===e-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+
c+") THEN "+(k+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};d.prototype._getNormalizationTotal=function(a,c){return a&&"percent-of-total"===c?this.summaryStatistics({field:a}).then(function(a){return a.sum}):g.resolve(null)};d.prototype._getQueryParamsForExpr=function(a,c){if(!a.valueExpression&&!a.sqlExpression){var b=a.field,e=b?this.getField(b):null,e=E.isDateField(e);c={field:b,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:c};return{sqlExpression:e?
m.msSinceUnixEpochSQL(this,b):m.getFieldExpr(c),sqlWhere:e?null:a.sqlWhere||n.getSQLFilterForNormalization(a)}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere}};d.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?g.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};d.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType).then(function(b){var e=
c._getQueryParamsForExpr(a,b);return c._getDataRange(e,a.minValue,a.maxValue).then(function(f){var k=f.min,h=f.max,d=a.numBins||10;f=m.getEqualIntervalBins(k,h,d);f=c._calcBinsSQL(e.sqlExpression,f);var p=new I({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),l=c.layer.createQuery();l.where=n.mergeWhereClauses(l.where,e.sqlWhere);l.sqlFormat="standard";l.outStatistics=[p];l.groupByFieldsForStatistics=[f];l.orderByFields=[f];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(l)}).then(function(a){return m.getHistogramFromFeatureSet(a,
k,h,d,b)})})})};d.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?g.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){return a.count?{min:a.min,max:a.max}:g.reject(new u("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field"))});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins)})};d.prototype._getBins=function(a,
c,b){void 0===b&&(b=10);var e=a.min,f=a.max,k=a.normTotal,h=a.excludeZerosExpr,d=a.intervals||m.getEqualIntervalBins(e,f,b);return this._queryBins(d,a.sqlExpr||c,h).then(function(a){return{bins:a.map(function(a,b){return{minValue:d[b][0],maxValue:d[b][1],count:a.value}}),minValue:e,maxValue:f,normalizationTotal:k}})};d.prototype._queryBins=function(a,c,b){for(var e=this,f=[],k=a.length,h=0;h<k;h++){var d=n.mergeWhereClauses(b,n.mergeWhereClauses(c+" \x3e\x3d "+a[h][0],null!==a[h][1]?c+(h===k-1?" \x3c\x3d ":
" \x3c ")+a[h][1]:""));f.push(d)}return g.eachAlways(f.map(function(a){return e.queryFeatureCount(a)}))};d.prototype._binParamsFromGenRend=function(a,c){var b=a.field,e=a.normalizationType,f=a.normalizationField,k=n.getSQLFilterForNormalization({field:b,normalizationType:e,normalizationField:f});a=new H({classificationDefinition:m.createCBDefn({field:b,normalizationType:e,normalizationField:f,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||
10}),where:n.mergeWhereClauses(k,c)});return this.generateRenderer(a).then(function(a){return m.generateBinParams({field:b,normalizationType:e,normalizationField:f,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:k})})};d.prototype._histogramFromMemory=function(a){var c=this,b=a.field,e=a.normalizationType,f=a.valueExpression,k=a.classificationMethod,h=a.minValue,d=a.maxValue,p=a.view,l=f&&!a.sqlExpression,x={field:b,valueExpression:f,normalizationField:a.normalizationField,
view:p};return(this._hasLocalSource||a.features||!l?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(p):this._fetchFeaturesForStats(x)).then(function(l){if(!l||!l.length)return g.reject(new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"));var t=null!=h&&null!=d,q=null;k&&"equal-interval"!==k||e?(t=B({},a),t.features=l,q=r.safeCast(c._getBinParamsFromMemory(t))):q=t?g.resolve({min:h,max:d,source:"parameters"}):c.summaryStatistics({field:b,
valueExpression:f,features:l,view:p}).then(function(a){return a.count?{min:a.min,max:a.max}:g.reject(new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return q.then(function(b){return r.safeCast(m.calculateHistogramFromMemory(a,b,l))})})};d.prototype._getBinParamsFromMemory=function(a){return w(this,void 0,void 0,function(){var c,b,e,f,k,h,d,p,l,g;return A(this,function(t){c=a.field;b=a.valueExpression;e=a.classificationMethod;f=a.standardDeviationInterval;
k=a.normalizationType;h=a.normalizationField;d=a.minValue;p=a.maxValue;l=a.features;g=a.view;return[2,this._classBreaksFromMemory({field:c,valueExpression:b,normalizationType:k,normalizationField:h,classificationMethod:e,standardDeviationInterval:f,minValue:d,maxValue:p,numClasses:a.numBins,features:l,view:g}).then(function(a){var b=a.normalizationTotal;a=a.classBreakInfos;var e=n.getSQLFilterForNormalization({field:c,normalizationType:k,normalizationField:h});return m.generateBinParams({field:c,
normalizationType:k,normalizationField:h,normalizationTotal:b,classBreaks:a,where:e})})]})})};d.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,e=a.normalizationField,f=a.normalizationTotal,k=n.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:e}),f=m.getFieldExpr({field:c,normalizationType:b,normalizationField:e,normalizationTotal:f}),f=n.getRangeExpr(f,a.minValue,a.maxValue),c=m.createCBDefn({field:c,normalizationType:b,normalizationField:e,
classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new H;b.classificationDefinition=c;b.where=n.mergeWhereClauses(k,f);return this.generateRenderer(b).then(function(b){return m.resolveCBResult(a,b)})};d.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,e=a.numClasses||5,f=[],k=(b-c)/e,d=0;d<e;d++){var t=c+d*k;f.push({minValue:t,maxValue:t+k})}f[e-1].maxValue=b;a=m.resolveCBResult(a,{classBreaks:f,
normalizationTotal:a.normalizationTotal});return g.resolve(a)};d.prototype._classBreaksFromMemory=function(a){return w(this,void 0,void 0,function(){var c,b,e,f,k,d,t,p,l,g,q,n,y;return A(this,function(h){switch(h.label){case 0:return c=a.field,b=a.normalizationField,e=a.valueExpression,f=a.view,k=this._hasLocalSource||a.features,d={field:c,valueExpression:e,normalizationField:b,view:f},k||!e?[3,2]:[4,this._fetchFeaturesForStats(d)];case 1:return p=h.sent(),[3,5];case 2:return(l=a.features)?[3,4]:
[4,this._fetchFeaturesFromMemory(f)];case 3:l=h.sent(),h.label=4;case 4:p=l,h.label=5;case 5:g=(t=p)&&t.length;if(!g)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");q=B({},a);return"percent-of-total"!==q.normalizationType?[3,7]:[4,m.calculateStatsFromMemory({field:c},t)];case 6:n=h.sent();y=n.sum;if(null==y)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");q.normalizationTotal=y;h.label=7;case 7:return[2,m.calculateClassBreaksFromMemory(q,
t)]}})})};d.prototype._heatmapStatsFromMemory=function(a,c){var b=this,e=a.blurRadius,f=a.field,k=a.view,d=k.state,t=d.size,p=new W.default({extent:k.extent,tolerance:d.resolution}),d=new X({returnGeometry:!0,geometry:k.extent,quantizationParameters:p});return(a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(k,d)).then(function(a){a=b._quantizeFeatures(a,p,k);return a&&a.length?(a=m.calculateHeatmapStats(a,e,c,f,t[0],t[1]))?{count:a.count,min:a.min,max:a.max,avg:a.mean,stddev:a.stdDev}:
g.reject(new u("feature-layer-adapter:invalid","unable to calculate heatmap statistics")):{count:0,min:null,max:null,avg:null,stddev:null}})};d.prototype._quantizeFeatures=function(a,c,b){var e=this,f=L.toQuantizationTransform(c);c=b.spatialReference;var d=b.size,h=M.isWrappable(c);b=M.getInfo(c);var g=Math.round((b.valid[1]-b.valid[0])/f.scale[0]);return a.map(function(a){var b=new Q.Point(R.unwrap(a.geometry));L.quantizePoint(f,b,b,b.hasZ,b.hasM);a.geometry=h?e._wrapPoint(b,g,d[0]):b;return a})};
d.prototype._wrapPoint=function(a,c,b){0>a.x?a.x+=c:a.x>b&&(a.x-=c);return a};d.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};d.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};d.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,c)};d.prototype.summaryStatistics=function(a){var c=this,b=a.field,e=b?this.getField(b):
null,f=E.isDateField(e),d=(e=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,b="function"===typeof b||d,d=(d=a.view)&&"3d"===d.type;return this._hasLocalSource||a.features||b?b||a.features||d?r.safeCast(this._summaryStatsFromMemory(a,f)):this._summaryStatsFromClientQuery(a,f):this.supportsSQLExpression||!f&&!e?(a.normalizationType?this._summaryStatsFromGenRend(a):this._summaryStatsFromServiceQuery(a,f)).catch(function(b){return r.safeCast(c._summaryStatsFromMemory(a,f))}):g.reject(new u("feature-layer-adapter:not-supported",
"Layer does not support standardized SQL expression for queries"))};d.prototype.uniqueValues=function(a){var c=this,b=a.field,e=a.valueExpression,f=a.sqlExpression,d=(b?this.getField(b):null)&&this.getFieldDomain(b),h=e&&(!f||!this.supportsSQLExpression),g=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||a.features||h?h||a.features||g?this._uvFromMemory(a,d):this._uvFromClientQuery(a,d):this._uvFromServiceQuery(a,d).catch(function(b){return a.field?c._uvFromGenRenderer(a,d):b}).catch(function(b){return h||
a.features||g?c._uvFromMemory(a,d):c._uvFromClientQuery(a,d)})};d.prototype.histogram=function(a){var c=this,b=a.field,e=a.normalizationType,f=a.normalizationField,d=a.classificationMethod,h=b?this.getField(b):null,h=E.isDateField(h),t=a.valueExpression||a.sqlExpression,p=t&&!a.sqlExpression,l=this.supportsSQLExpression,x=!d||"equal-interval"===d,q=a.minValue,r=a.maxValue,y=null!=q&&null!=r,v=a.numBins||10;return this._hasLocalSource||a.features||p?this._histogramFromMemory(a):(t||l)&&x?t&&!l?g.reject(new u("feature-layer-adapter:not-supported",
"Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):h&&x?g.reject(new u("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):e||!x?this._binParamsFromGenRend(a).then(function(d){if(!y)return c._getBins(d,b,v);if(q>d.max||r<d.min)return g.reject(new u("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));
if(x)return c._getBins({min:q,max:r,sqlExpr:d.sqlExpr,excludeZerosExpr:d.excludeZerosExpr},b,v);d=m.getFieldExpr({field:b,normalizationType:e,normalizationField:f,normalizationTotal:d.normTotal});d=n.getRangeExpr(d,q,r);return c._binParamsFromGenRend(a,d).then(function(a){return c._getBins(a,b,v)})}):this._histogramForField(a)};d.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,d=this._hasLocalSource||a.features||a.valueExpression;return b&&d?r.safeCast(this._classBreaksFromMemory(a)):
(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(b){return r.safeCast(c._classBreaksFromMemory(a))})};d.prototype.queryFeatureCount=function(a){if(this._hasLocalSource)return g.reject(new u("feature-layer-adapter:not-supported","Layer does not support count query"));var c=this.layer,b=c.createQuery();b.where=n.mergeWhereClauses(b.where,a);return c.queryFeatureCount(b)};d.prototype.generateRenderer=function(a){var c=this.layer;if(this._hasLocalSource||10.1>c.version)return g.reject(new u("feature-layer-adapter:not-supported",
"Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var b=new V({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion}),c=c.createQuery();a.where=n.mergeWhereClauses(a.where,c.where);return b.execute(a)};d.prototype.heatmapStatistics=function(a){var c=this,b=a.field,d=a.fieldOffset;return(b&&null==d?this.summaryStatistics({field:b}):g.resolve(null)).then(function(b){var e=d||0;if(b){var f=b.min,g=b.max;b.count?f===g&&0===f?e=1:0>=g?e="abs":
0>f&&(e=-1.01*f):e=1}return c._heatmapStatsFromMemory(a,e).then(function(a){return B({},a,{summaryStatistics:b,fieldOffset:e})})})};d.prototype.predominantCategories=function(a){return w(this,void 0,void 0,function(){var c,b,d,f,k,h,g,p,l,m,q,n,r,v,z,J,w;return A(this,function(e){switch(e.label){case 0:if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new u("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries");c=a.fields;b=a.view;
d=G.getArcadeForPredominantCategory(c);f=G.getSQLForPredominantCategoryName(c);k=b&&"3d"===b.type;return b&&this._hasLocalSource?k?[4,this._uvFromMemory({valueExpression:d,view:b})]:[3,2]:[3,5];case 1:return p=e.sent(),[3,4];case 2:return[4,this._uvFromClientQuery({valueExpression:d,view:b})];case 3:p=e.sent(),e.label=4;case 4:return g=p,[3,7];case 5:return[4,this._uvFromServiceQuery({sqlExpression:f.expression,valueExpression:d})];case 6:g=e.sent(),e.label=7;case 7:h=g;l=h.uniqueValueInfos;m=l.map(function(a){return a.value});
q=c.filter(function(a){return-1===m.indexOf(a)});n=0;for(r=q;n<r.length;n++)v=r[n],l.push({value:v,count:0});l.sort(function(a,b){return c.indexOf(a.value)-c.indexOf(b.value)});z=0;for(J=l;z<J.length;z++)w=J[z],w.value===G.noDominantCategoryField&&(w.value=null);return[2,{predominantCategoryInfos:l}]}})})};d.prototype.getSampleFeatures=function(a){return w(this,void 0,void 0,function(){var c,b,d,f,g,h,m,p,l,n,q,r,u,v=this;return A(this,function(e){switch(e.label){case 0:c=a.view,b=a.sampleSize,d=
a.requiredFields,f=this.layer.createQuery(),g=1,f.outFields=null,f.outSpatialReference=a.spatialReference||c.spatialReference,f.returnGeometry=!0,f.outFields=d,h=[],e.label=1;case 1:return e.trys.push([1,7,,8]),m=!0,d&&d.length?[4,c.whenLayerView(this.layer)]:[3,4];case 2:return p=e.sent(),[4,D.whenFalseOnce(p,"updating")];case 3:e.sent(),m=d.every(function(a){a=v.getField(a);return-1<p.availableFields.indexOf(a.name)}),e.label=4;case 4:return m?[4,this._fetchFeaturesFromMemory(c,f)]:[3,6];case 5:h=
e.sent();if(h.length&&0<b&&b<=h.length)return[2,C.pickRandom(h,b,g)];e.label=6;case 6:return[3,8];case 7:return e.sent(),[3,8];case 8:return e.trys.push([8,12,,13]),[4,this.queryFeatureCount()];case 9:l=e.sent();n=this.layer.maxRecordCount;q=-1===b?l:b;q=n&&q>n?n:q;if(l<=h.length||h.length>=n)return[2,C.pickRandom(h,h.length,g)];r=c.extent.width/c.width/c.scale*4E5;f.maxAllowableOffset=a.resolution||r;return l<=q?[2,this._fetchFeaturesFromService(f)]:2E4>=l?[4,this.layer.queryObjectIds()]:[3,11];
case 10:return u=e.sent(),f.objectIds=C.pickRandom(u,q,g),[2,this._fetchFeaturesFromService(f)];case 11:return this.layer.get("capabilities.query.supportsPagination")&&(f.num=q),[2,this._fetchFeaturesFromService(f)];case 12:return e.sent(),[2,C.pickRandom(h,h.length,g)];case 13:return[2]}})})};d.prototype.load=function(a){var c=this;a=this.layer.load(a).then(function(a){c.geometryType=a.geometryType;c.objectIdField=a.objectIdField;c.supportsSQLExpression=a.get("capabilities.query.supportsSqlExpression");
c._hasLocalSource=!a.url&&!!a.source;c.hasQueryEngine=c._hasLocalSource;c.minScale=a.minScale;c.maxScale=a.maxScale;c.fullExtent=a.fullExtent});this.addResolvingPromise(a);return this.when()};K([F.property({constructOnly:!0})],d.prototype,"layer",void 0);return d=K([F.subclass("esri.renderers.smartMapping.support.adapters.FeatureLayerAdapter")],d)}(F.declared(U))});