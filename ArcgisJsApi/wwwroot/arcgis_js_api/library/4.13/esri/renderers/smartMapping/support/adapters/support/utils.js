// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/promiseUtils ../../utils ../../../../support/heatmapUtils ../../../../../support/arcadeOnDemand ../../../../../tasks/support/ClassBreaksDefinition ../../../../../tasks/support/generateRendererUtils".split(" "),function(W,g,u,v,M,N,F,O,P,Q){function G(a,c,b){c=null==c?-Infinity:c;b=null==b?Infinity:b;return a.filter(function(a){return null!=a&&p(a)&&a>=c&&a<=b})}function t(a,
c){return v(this,void 0,void 0,function(){var b,d,e,f,m,l,k,h,C,g,r;return u(this,function(n){switch(n.label){case 0:return b=a.field,d="function"===typeof b,e=a.valueExpression,f=a.normalizationType,m=a.normalizationField,l=a.normalizationTotal,k=[],h=a.view,g=C=null,e?q?[3,2]:[4,O.loadArcade()]:[3,3];case 1:q=r=n.sent().arcadeUtils,n.label=2;case 2:C=q.createFunction(e),g=h&&q.getViewInfo({viewingMode:"2d"===h.type?"map":h.viewingMode,scale:h.scale,spatialReference:h.spatialReference}),n.label=
3;case 3:if(!c)return[2,k];c.forEach(function(a){var c=a.attributes,h;e?(h=q.createExecContext(a,g),h=q.executeFunction(C,h)):d?h=b.call(null,a):c&&(h=c[b]);f&&null!=h&&p(h)&&(c=c&&parseFloat(c[m]),"log"===f&&0!==h?h=Math.log(h)*Math.LOG10E:"percent-of-total"===f&&p(l)&&0!==l?h=h/l*100:"field"===f&&p(c)&&0!==c&&(h/=c));k.push(h)});return[2,k]}})})}function R(a,c){for(var b=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,e=null,f=null,m=null,l=null,k=0;k<a.length;k++)var h=a[k],e=e+h,b=Math.min(b,
h),d=Math.max(d,h);if(k=a.length){f=e/k;for(l=m=0;l<a.length;l++)h=a[l],m+=Math.pow(h-f,2);l=c?1<k?m/(k-1):0:0<k?m/k:0;m=Math.sqrt(l)}else d=b=null;return{avg:f,count:k,max:d,min:b,stddev:m,sum:e,variance:l}}function H(a){var c=a.field,b=a.classificationMethod||"equal-interval",d=a.normalizationType,e=a.normalizationField,f=new P;f.classificationField=c;f.breakCount=a.breakCount;f.classificationMethod=b;f.standardDeviationInterval="standard-deviation"===b?a.standardDeviationInterval||1:void 0;f.normalizationType=
d;f.normalizationField="field"===d?e:void 0;return f}function I(a,c){var b=c.classBreaks,d=b[0].minValue,e=b[b.length-1].maxValue,f="standard-deviation"===a.classificationMethod,m=S,b=b.map(function(a){var b=a.label;a={minValue:a.minValue,maxValue:a.maxValue,label:b};if(f&&b){var c=b.match(m).map(function(a){return+a.trim()});2===c.length?(a.minStdDev=c[0],a.maxStdDev=c[1],0>c[0]&&0<c[1]&&(a.hasAvg=!0)):1===c.length&&(-1<b.indexOf("\x3c")?(a.minStdDev=null,a.maxStdDev=c[0]):-1<b.indexOf("\x3e")&&
(a.minStdDev=c[0],a.maxStdDev=null))}return a});return{minValue:d,maxValue:e,classBreakInfos:b,normalizationTotal:c.normalizationTotal}}function y(a,c,b){c=(c-a)/b;for(var d=[],e,f=1;f<=b;f++)e=a+c,e=Number(e.toFixed(16)),d.push([a,e]),a=e;return d}function J(a){var c=a.field,b=a.normalizationType,d=a.normalizationField;a=a.normalizationTotal;var e=c;"percent-of-total"===b?e="(("+c+" / "+a+") * 100)":"log"===b?e="(log("+c+") * "+T+")":"field"===b&&(e="("+c+" / "+d+")");return e}function U(a,c){for(var b=
-1,d=a.length-1;0<=d;d--)if(c>=a[d][0]){b=d;break}return b}function K(a,c){var b;c=c.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()!==c){b=a[d];break}return b}function D(a,c){var b;c=c.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()===c){b=a[d];break}return b}function E(a,c){if(c)for(var b in a)a[b].label=c[b];return{count:a}}function L(a,c,b,d){var e=a.count;a=[];d&&b&&"coded-value"===b.type&&b.codedValues.forEach(function(a){a=a.code;e.hasOwnProperty(a)||(e[a]={data:a,count:0})});for(var f in e)b=
e[f],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function p(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}Object.defineProperty(g,"__esModule",{value:!0});var V=/_value$/i,S=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,T=Math.LOG10E;g.statisticTypes="min max avg stddev count sum variance".split(" ");var q=null;g.getSummaryStatisticsFromFeatureSet=function(a,c){a=(a=a&&a.features)&&a[0]&&a[0].attributes;var b={},d;for(d in a)b[d.replace(V,"").toLowerCase()]=
a[d];b.min===b.max&&null!=b.min&&null==b.stddev&&(b.stddev=b.variance=0);c&&("min max avg stddev sum variance".split(" ").forEach(function(a){null!=b[a]&&(b[a]=Math.ceil(b[a]))}),b.min===b.max&&null!=b.min&&(b.avg=b.min,b.stddev=b.variance=0));return b};g.calculateStatsFromMemory=function(a,c,b){return v(this,void 0,void 0,function(){var d,e;return u(this,function(f){switch(f.label){case 0:return[4,t(a,c)];case 1:return d=f.sent(),d=G(d,a.minValue,a.maxValue),e=R(d,!a.normalizationType),b&&["avg",
"stddev","variance"].forEach(function(a){null!=e[a]&&(e[a]=Math.ceil(e[a]))}),[2,e]}})})};g.getDataValues=t;g.processSummaryStatisticsResult=function(a){for(var c in a)-1<g.statisticTypes.indexOf(c)&&(p(a[c])||(a[c]=null));return a};g.createCBDefn=H;g.calculateHeatmapStats=function(a,c,b,d,e,f){void 0===c&&(c=10);var m=new Float64Array(e*f),l=F.createKernel(c);c=Math.round(3*c);var k=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,g=0,x=0,r=0,n=0;b=F.createValueFunction(d,b);for(d=0;d<a.length;d++)for(var A=
a[d],w=A.geometry,p=w.x-c,q=w.y-c,u=Math.max(0,p),g=Math.max(0,q),v=Math.min(f,w.y+c),w=Math.min(e,w.x+c),A=+b(A.attributes),t=g;t<v;t++)for(var y=l[t-q],B=u;B<w;B++){var g=t*e+B,z=m[g],g=m[g]+=y*l[B-p]*A,z=g-z,x=x+z,r=r+z*z;g<k&&(k=g);g>h&&(h=g);n++}return n?{mean:x/n,stdDev:Math.sqrt((r-x*x/n)/n),min:k,max:h,mid:(h-k)/2,count:n}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};g.calculateClassBreaksFromMemory=function(a,c){return v(this,void 0,void 0,function(){var b,d,e,f;return u(this,function(g){switch(g.label){case 0:return b=
a.normalizationTotal,d=H({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),[4,t(a,c)];case 1:return e=g.sent(),e=G(e,a.minValue,a.maxValue),f=Q.createGenerateRendererClassBreaks({definition:d,values:e,normalizationTotal:b}),[2,I(a,f)]}})})};g.resolveCBResult=I;g.getEqualIntervalBins=y;g.generateBinParams=function(a){var c=[],b=a.classBreaks,
d=b[0].minValue,e=b[b.length-1].maxValue;b.forEach(function(a){c.push([a.minValue,a.maxValue])});return{min:d,max:e,intervals:c,sqlExpr:J({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};g.getFieldExpr=J;g.calculateHistogramFromMemory=function(a,c,b){return v(this,void 0,void 0,function(){var d,e,f,g,l,k,h,p,q,r,n;return u(this,function(m){switch(m.label){case 0:return d=
c.min,e=c.max,f=c.normTotal,g=a.numBins||10,l=c.intervals||y(d,e,g),k=l.map(function(a,b){return{minValue:l[b][0],maxValue:l[b][1],count:0}}),[4,t(a,b)];case 1:h=m.sent();p=0;for(q=h;p<q.length;p++)r=q[p],null!=r&&r>=d&&r<=e&&(n=U(l,r),-1<n&&k[n].count++);return[2,{bins:k,minValue:d,maxValue:e,normalizationTotal:f}]}})})};g.getHistogramFromFeatureSet=function(a,c,b,d,e){var f={};a&&a.features&&a.features.forEach(function(a){var b=a.attributes;a=K(b,"countOFExpr");b=D(b,"countOFExpr");0!==a&&(f[a]=
b)});var g=[];y(c,b,d).forEach(function(a,b){b=(b+1).toString();g.push({minValue:a[0],maxValue:a[1],count:f.hasOwnProperty(b)?f[b]:0})});return{bins:g,minValue:c,maxValue:b,normalizationTotal:e}};g.getUniqueValuesFromFeatureSet=function(a,c,b,d){var e="countOF"+(b||"Expr"),f={},g=!1;(a&&a.features).forEach(function(a){var c=a.attributes;a=D(c,e);c=b?D(c,b):K(c,e);null===c&&0===a&&(g=!0);if(null==c||"string"===typeof c&&""===c.trim())c=null;null==f[c]?f[c]={count:a,data:c}:f[c].count+=a});return b&&
g?c.queryFeatureCount(b+" is NULL").then(function(a){f["null"].count+=a||0;return E(f,d)}).catch(function(){return E(f,d)}):M.resolve(E(f,d))};g.createUVResult=L;g.calculateUniqueValuesFromMemory=function(a,c,b){return v(this,void 0,void 0,function(){var d,e,f,g,l,k;return u(this,function(h){switch(h.label){case 0:return d=a.features?"features":"features-in-memory",[4,t(a,c)];case 1:e=h.sent();f={};g=0;for(l=e;g<l.length;g++){k=l[g];if(null==k||"string"===typeof k&&""===k.trim())k=null;null==f[k]?
f[k]={count:1,data:k}:f[k].count++}return[2,L({count:f},d,b,a.returnAllCodedValues)]}})})};g.msSinceUnixEpochSQL=function(a,c){return N.getDateDiffSQL(a,new Date(0),c,"milliseconds").sqlExpression};g.isValidNumber=p});