// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/promiseUtils ./type ./support/utils ../support/utils ../symbology/relationship ../../support/AuthoringInfo ../../support/AuthoringInfoClassBreakInfo ../../support/AuthoringInfoFieldInfo ../../../symbols/support/utils".split(" "),function(ca,q,F,n,p,G,k,M,v,
N,O,r,w,y,P,H,I,Q){function R(b){return p(this,void 0,void 0,function(){var a,c,d,e,f,g,l,h,u;return n(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&b.view&&b.field1&&b.field2))throw new k("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");a=F({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"quantile";a.numClasses=a.numClasses||
3;a.focus=a.focus||null;if(-1===S.indexOf(a.classificationMethod))throw new k("relationship-renderer:invalid-parameters","classification method "+a.classificationMethod+" is not supported");if(2>a.numClasses||4<a.numClasses)throw new k("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(b.focus&&-1===T.indexOf(b.focus))throw new k("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");c=[0,2,1,3];d=w.createLayerAdapter(a.layer,c);a.layer=
d;if(!d)throw new k("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:m.sent();e=d.geometryType;f=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new k("relationship-renderer:not-supported",
"3d-volumetric-uniform symbols are supported for point layers only");if(f&&"polygon"===e)throw new k("relationship-renderer:not-supported","3d symbols are not supported for polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new k("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}g=a.field1;l=a.field2;h=[g.field,l.field];g.normalizationField&&
h.push(g.normalizationField);l.normalizationField&&h.push(l.normalizationField);if(u=r.verifyBasicFieldValidity(d,h,"relationship-renderer:invalid-parameters"))throw u;return[2,a]}})})}function U(b){return p(this,void 0,void 0,function(){var a,c,d,e,f,g;return n(this,function(l){if(!(b&&b.renderer&&b.numClasses))throw new k("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");a=b.field1;c=b.field2;d=b.renderer;e=b.numClasses;f=b.colors;g=Math.pow(e,
2);if((a||c)&&!(a&&c&&a.field&&c.field))throw new k("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(a&&!a.classBreakInfos||c&&!c.classBreakInfos)throw new k("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!d.authoringInfo)throw new k("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");if(d.uniqueValueInfos.length!==g)throw new k("update-relationship-renderer:invalid-parameters",
"Renderer must have "+g+" unique value infos to support "+e+" classes");if(f&&f.length!==g)throw new k("update-relationship-renderer:invalid-parameters","The scheme must have "+g+" colors");return[2,b]})})}function V(b){return p(this,void 0,void 0,function(){var a,c,d,e,f;return n(this,function(g){switch(g.label){case 0:return a=b.relationshipScheme,d=c=null,[4,r.getBasemapInfo(b.basemap,b.view)];case 1:e=g.sent();c=v.isSome(e.basemapId)?e.basemapId:null;d=v.isSome(e.basemapTheme)?e.basemapTheme:
null;if(a)return[2,{scheme:y.cloneScheme(a),basemapId:c,basemapTheme:d}];if(f=y.getSchemes({basemap:c,basemapTheme:d,geometryType:b.geometryType,theme:b.theme,worldScale:b.worldScale,view:b.view}))a=f.primaryScheme,c=f.basemapId,d=f.basemapTheme;return[2,{scheme:a,basemapId:c,basemapTheme:d}]}})})}function J(b,a){b=M.clone(W[b]);return y.flatten2DArray(b,a)}function X(b,a){return J(b,a).map(function(a){return{value:a,count:0}})}function K(b,a,c,d){var e=b.field;b=b.normalizationField;var f=a.field;
a=a.normalizationField;c=c.map(function(a){return[a.minValue,a.maxValue]});d=d.map(function(a){return[a.minValue,a.maxValue]});var g=Y[c.length];return"\n  var field1 \x3d $feature['"+e+"'];\n  var field2 \x3d $feature['"+f+"'];\n  var hasNormField1 \x3d "+(b?"true":"false")+";\n  var hasNormField2 \x3d "+(a?"true":"false")+";\n  var normField1 \x3d "+(b?"$feature['"+b+"']":"null")+";\n  var normField2 \x3d "+(a?"$feature['"+a+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 \x26\x26 (IsEmpty(normField1) || normField1 \x3d\x3d 0)) ||\n    (hasNormField2 \x26\x26 (IsEmpty(normField2) || normField2 \x3d\x3d 0))\n  ) {\n    return null;\n  }\n\n  var value1 \x3d IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 \x3d IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 \x3d "+
JSON.stringify(c)+";\n  var breaks2 \x3d "+JSON.stringify(d)+";\n  var classCodes \x3d "+JSON.stringify(g)+";\n\n  function getClassCode(value, breaks) {\n    var code \x3d null;\n\n    for (var i in breaks) {\n      var info \x3d breaks[i];\n      if (value \x3e\x3d info[0] \x26\x26 value \x3c\x3d info[1]) {\n        code \x3d classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 \x3d getClassCode(value1, breaks1);\n  var code2 \x3d getClassCode(value2, breaks2);\n\n  var classValue \x3d IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}
function Z(b,a,c){return p(this,void 0,void 0,function(){var d,e,f,g,l,h,u,m,t,L,p,r,z,x,A,q,v,B,D,E,w;return n(this,function(n){switch(n.label){case 0:d=b.basemap;e=b.classificationMethod;f=b.field1;g=b.field2;l=b.focus;h=b.numClasses;u=b.layer;m=a.classBreakInfos;t=c.classBreakInfos;if(h!==m.length||m.length!==t.length)throw new k("relationship-renderer:error","incompatible class breaks");L=X(h,l);p=K(b.field1,b.field2,m,t);return[4,V({basemap:d,geometryType:u.geometryType,theme:"default",relationshipScheme:b.relationshipScheme,
worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view})];case 1:return r=n.sent(),z=r.scheme,[4,O.createRenderer({layer:u,basemap:d,valueExpression:p,valueExpressionTitle:G.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:b.defaultSymbolEnabled,typeScheme:F({colors:y.getColors(z,h,l)},z),statistics:{uniqueValueInfos:L},legendOptions:b.legendOptions,outlineOptimizationEnabled:b.outlineOptimizationEnabled,symbolType:b.symbolType,colorMixMode:b.colorMixMode,edgesType:b.edgesType,
view:b.view})];case 2:x=n.sent();A=x.renderer;q=A.uniqueValueInfos;v=G.relationship;B=0;for(D=q;B<D.length;B++)E=D[B],E.label=v[E.value];w=new P({type:"relationship",classificationMethod:e,numClasses:h,focus:l,field1:{field:f.field,normalizationField:f.normalizationField,classBreakInfos:m.map(C)},field2:{field:g.field,normalizationField:g.normalizationField,classBreakInfos:t.map(C)}});A.authoringInfo=w;return[2,{renderer:A,classBreaks:{field1:a,field2:c},uniqueValueInfos:x.uniqueValueInfos,relationshipScheme:z,
basemapId:x.basemapId,basemapTheme:x.basemapTheme}]}})})}function aa(b,a,c){var d=J(a,c);b.sort(function(a,b){a=d.indexOf(a.value);b=d.indexOf(b.value);var c=0;a<b?c=-1:a>b&&(c=1);return c})}function ba(b,a){var c=b.authoringInfo;c.numClasses=a.numClasses;c.focus=a.focus||null;c.focus||delete c.focus;var d=a.field1;a=a.field2;c.field1=new I.default({field:d.field,normalizationField:d.normalizationField,classBreakInfos:d.classBreakInfos.map(function(a){return new H.default(C(a))})});c.field2=new I.default({field:a.field,
normalizationField:a.normalizationField,classBreakInfos:a.classBreakInfos.map(function(a){return new H.default(C(a))})});b.authoringInfo=c}Object.defineProperty(q,"__esModule",{value:!0});var S=["equal-interval","natural-breaks","quantile"],T=["HH","HL","LH","LL"],W={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},Y={2:["L","H"],3:["L","M","H"],4:["L","M1",
"M2","H"]},C=function(b){return{minValue:b.minValue,maxValue:b.maxValue}};q.updateRenderer=function(b){return p(this,void 0,void 0,function(){var a,c,d,e,f,g,l,h,k;return n(this,function(m){switch(m.label){case 0:return[4,U(b)];case 1:return a=m.sent(),c=a.field1,d=a.field2,e=a.renderer,f=a.numClasses,g=a.focus,l=a.colors,h=e.clone(),h.valueExpression=K(c,d,c.classBreakInfos,d.classBreakInfos),aa(h.uniqueValueInfos,f,g),l&&(k=r.createColors(l,l.length),h.uniqueValueInfos.forEach(function(a,b){return Q.applyColorToSymbol(a.symbol,
k[b])})),ba(h,a),[2,h]}})})};q.createRenderer=function(b){return p(this,void 0,void 0,function(){var a,c,d,e,f,g,l,h,p,m,t,q;return n(this,function(n){switch(n.label){case 0:return[4,R(b)];case 1:return a=n.sent(),c=a.layer,d=a.classificationMethod,e=a.field1,f=a.field2,g=a.numClasses,l=a.view,h={layer:c,classificationMethod:d,field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationField?"field":null,minValue:e.minValue,maxValue:e.maxValue,analyzeData:!(null!=e.minValue&&
null!=e.maxValue),numClasses:g,view:l},p={layer:c,classificationMethod:d,field:f.field,normalizationField:f.normalizationField,normalizationType:f.normalizationField?"field":null,minValue:f.minValue,maxValue:f.maxValue,analyzeData:!(null!=f.minValue&&null!=f.maxValue),numClasses:g,view:l},[4,N.all([r.getClassBreaks(h),r.getClassBreaks(p)])];case 2:m=n.sent();t=m[0];q=m[1];if(!t||!q)throw new k("relationship-renderer:error","error when calculating class breaks");return[2,Z(a,t.result,q.result)]}})})}});