// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../.. ../../../pointCloudRenderers ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../intl/substitute ./support/utils ../heuristics/ageUnit ../heuristics/outline ../statistics/support/ageUtils ../support/utils ../symbology/color ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/numberUtils ../../support/utils ../../visualVariables/ColorVariable".split(" "),
function(ga,x,u,r,q,F,A,B,k,C,t,Q,h,R,I,E,n,w,J,S,T,K,U){function V(b){return q(this,void 0,void 0,function(){var a,c,e,d,g,f;return r(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new k("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new k("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");
a=u({},b);c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new k("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(c).join(", "));return[4,e.load()];case 1:return m.sent(),d=e.geometryType,"mesh"===d||!a.worldScale||a.view&&"3d"===a.view.type?[4,n.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})]:[2,t.reject(h.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))];
case 2:g=m.sent();if(f=h.verifyBasicFieldValidity(e,g,"color-visual-variable:invalid-parameters"))throw f;return[2,a]}})})}function W(b){return q(this,void 0,void 0,function(){var a,c,e,d,g,f;return r(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new k("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new k("color-continuous-renderer:missing-parameters",
"View is required when 'valueExpression' is specified");a=u({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new k("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(c).join(", "));return[4,e.load()];case 1:m.sent();d=e.geometryType;a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===
d)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==d)throw new k("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new k("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");
}return[4,n.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:g=m.sent();if(f=h.verifyBasicFieldValidity(e,g,"color-continuous-renderer:invalid-parameters"))throw f;return[2,a]}})})}function X(b){return q(this,void 0,void 0,function(){var a,c,e,d,g,f,m;return r(this,function(l){switch(l.label){case 0:if(!b||!b.layer||!b.field&&!b.valueExpression)throw new k("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");
if(b.valueExpression&&!b.view)throw new k("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=u({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";a.normalizationType=n.getNormalizationType(a);c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new k("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+
n.getLayerTypeLabels(c).join(", "));d=null!=a.minValue&&null!=a.maxValue;if(!d&&(null!=a.minValue||null!=a.maxValue))throw new k("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return[4,e.load()];case 1:l.sent();g=e.geometryType;a.outlineOptimizationEnabled="polygon"===g?a.outlineOptimizationEnabled:!1;if("mesh"===g)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";
else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==g)throw new k("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new k("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}return[4,n.getFieldsList({field:a.field,normalizationField:a.normalizationField})];
case 2:f=l.sent();if(m=h.verifyBasicFieldValidity(e,f,"color-class-breaks-renderer:invalid-parameters"))throw m;return[2,a]}})})}function Y(b){b=u({},b);delete b.basemap;delete b.colorScheme;delete b.legendOptions;delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function Z(b){if(!b||!b.layer)return t.reject(h.createError("color-point-cloud-true-color-renderer:missing-parameters","'layer' parameter is required"));
var a=u({},b);b=[4];var c=n.createLayerAdapter(a.layer,b);a.layer=c;a.density=a.density||25;a.size=a.size||"100%";return h.isValidPointSize(a.size)?c?c.load().then(function(){return a}):t.reject(h.createError("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(b).join(", "))):t.reject(h.createError("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function aa(b){if(!(b&&
b.layer&&b.field))return t.reject(h.createError("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required"));var a=b.field.toLowerCase();if("intensity"!==a&&"elevation"!==a)return t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'"));var c=u({},b);b=[4];a=n.createLayerAdapter(c.layer,b);c.layer=a;c.density=c.density||25;c.size=c.size||"100%";return h.isValidPointSize(c.size)?
a?a.load().then(function(){return c}):t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(b).join(", "))):t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function L(b){b=u({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;
b.worldScale=a;return b}function ba(b){return q(this,void 0,void 0,function(){var a,c,e,d,g;return r(this,function(f){switch(f.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&b.endTime))throw new k("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");a=u({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new k("color-age-renderer:invalid-parameters",
"'layer' must be one of these types: "+n.getLayerTypeLabels(c).join(", "));return[4,e.load()];case 1:f.sent();d=e.geometryType;a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else if("3d-volumetric-uniform"===a.symbolType&&"point"!==d)throw new k("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");
if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new k("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");if(g=E.verifyDates(e,a.startTime,a.endTime,"color-age-renderer:invalid-parameters"))throw g;if(a.unit&&-1===E.supportedAgeUnits.indexOf(a.unit))throw new k("color-age-renderer:invalid-unit","Supported units are: "+E.supportedAgeUnits.join(", "));
return[2,a]}})})}function z(b,a){return q(this,void 0,void 0,function(){var c,e,d,g,f,m,l;return r(this,function(p){switch(p.label){case 0:return c=b.colorScheme,d=e=null,[4,h.getBasemapInfo(b.basemap,b.view)];case 1:g=p.sent();e=C.isSome(g.basemapId)?g.basemapId:null;d=C.isSome(g.basemapTheme)?g.basemapTheme:null;if(c)return[2,{scheme:w.cloneScheme(c),basemapId:e,basemapTheme:d}];f=a||b.theme||"high-to-low";if(m=w.getSchemes({theme:f,basemap:e,basemapTheme:d,geometryType:b.geometryType,worldScale:b.worldScale,
view:b.view}))e=m.basemapId,d=m.basemapTheme,b.schemeId?(l=f+"/"+e+"/"+b.schemeId,c=w.getSchemeById({id:l,geometryType:b.geometryType})):c=m.primaryScheme;return[2,{scheme:c,basemapId:e,basemapTheme:d}]}})})}function M(b,a,c){for(var e=(a-b)/(c-1),d=[b],g=1;g<=c-2;g++)d.push(b+g*e);d.push(a);return T.round(d,{strictBounds:!0})}function ca(b,a){return q(this,void 0,void 0,function(){var c,e,d,g,f,m,l;return r(this,function(p){switch(p.label){case 0:return c=a.layer,[4,z({basemap:a.basemap,colorScheme:a.colorScheme,
geometryType:c.geometryType,schemeId:"elevation"===a.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"})];case 1:e=p.sent();d=e.scheme;if(!d)return[2,t.reject(h.createError("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme"))];g=h.createColors(d.colors,5);if(5>g.length)return[2,t.reject(h.createError("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors"))];m=(f=h.getDefaultDataRange(b,
!1,!0))?M(f[0],f[1],5):h.createStopValues(b);l=K.createColorStops({values:m,isDate:!1,dateFormatOptions:null,colors:g,labelIndexes:[0,2,4]});return[2,{stops:l,basemapId:e.basemapId,basemapTheme:e.basemapTheme,statistics:b,defaultValuesUsed:!!f,colorScheme:w.cloneScheme(d)}]}})})}function da(b,a,c){return q(this,void 0,void 0,function(){var e,d,g,f,m,l,p,k,n,q,N,v,y,u,D;return r(this,function(r){switch(r.label){case 0:return e=c.layer,d=c.field,g="function"===typeof d,m=(f=d&&!g?e.getField(d):null)&&
"date"===f.type,[4,z({basemap:c.basemap,theme:c.theme,geometryType:e.geometryType,colorScheme:c.colorScheme,worldScale:c.worldScale,view:c.view})];case 1:l=r.sent();p=l.scheme;if(!p)return[2,t.reject(h.createError("color-visual-variable:insufficient-info","Unable to find color scheme"))];k=h.createColors(p.colors,5);if(5>k.length)return[2,t.reject(h.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors"))];n=h.getDefaultDataRange(b,m,!0);q=-1<p.id.indexOf("seq-");
N=n?M(n[0],n[1],5):h.createStopValues(b,q);v=h.createColors(k,5);y=new U({field:d,valueExpression:c.valueExpression,valueExpressionTitle:c.valueExpressionTitle,normalizationField:a,stops:N.map(function(a,b){return{value:a,color:v[b]}}),legendOptions:c.legendOptions});u=new S({type:"color",minSliderValue:b.min,maxSliderValue:b.max,theme:p.theme});D=new J({visualVariables:[u]});return[2,{basemapId:l.basemapId,basemapTheme:l.basemapTheme,visualVariable:y,statistics:b,defaultValuesUsed:!!n,colorScheme:w.cloneScheme(p),
authoringInfo:D}]}})})}function O(b,a,c,e,d){var g=d.field,f=d.layer.geometryType,m=d.defaultSymbolEnabled,l=w.cloneScheme(b.colorScheme),p=a&&a.opacity,k=[b.visualVariable.clone()];a&&a.visualVariables&&a.visualVariables.length&&k.push.apply(k,a.visualVariables.map(function(a){return a.clone()}));return{renderer:new A.ClassBreaksRenderer({classBreakInfos:[{minValue:-P,maxValue:P,symbol:h.createSymbol(f,{type:d.symbolType,color:l.noDataColor,size:h.getSymbolSizeFromScheme(l,f),outline:h.getSymbolOutlineFromScheme(l,
f,p),meshInfo:{colorMixMode:d.colorMixMode,edgesType:d.edgesType}})}],defaultLabel:m?F.other:null,defaultSymbol:m?h.createSymbol(f,{type:d.symbolType,color:l.noDataColor,size:h.getSymbolSizeFromScheme(l,f),outline:h.getSymbolOutlineFromScheme(l,f,p),meshInfo:{colorMixMode:d.colorMixMode,edgesType:d.edgesType}}):null,field:g,normalizationType:c,normalizationField:e,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,visualVariables:k,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),
visualVariable:b.visualVariable.clone(),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,colorScheme:w.cloneScheme(b.colorScheme),basemapId:b.basemapId,basemapTheme:b.basemapTheme}}function H(b){return q(this,void 0,void 0,function(){var a,c,e,d,g;return r(this,function(f){switch(f.label){case 0:return[4,V(b)];case 1:a=f.sent();e=(c=a.normalizationField)?"field":void 0;if(!a.statistics)return[3,2];g=a.statistics;return[3,4];case 2:return[4,h.getSummaryStatistics({layer:a.layer,field:a.field,
valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:c,minValue:a.minValue,maxValue:a.maxValue,view:a.view})];case 3:g=f.sent(),f.label=4;case 4:return d=g,[2,da(d,c,a)]}})})}function ea(b,a){b=b.colorsForClassBreaks;var c;if(b&&0<b.length&&(b.some(function(b){b.numClasses===a&&(c=b.colors);return!!c}),!c)){var e=b[b.length-1];b=a-e.numClasses;if(0<b){var d=e.colors[e.numClasses-1];c=e.colors.splice(0);for(e=1;e<=b;e++)c.push(d)}}c&&
(c=h.createColors(c,c.length));return c}function fa(b,a){return q(this,void 0,void 0,function(){var c,e,d,g,f,m,l,p,n,q,t,u,v,y;return r(this,function(r){switch(r.label){case 0:return c=b.layer,e=b.defaultSymbolEnabled,d=c.geometryType,[4,z({basemap:b.basemap,geometryType:d,colorScheme:b.colorScheme,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view})];case 1:g=r.sent();f=g.scheme;m=a.result;l=a.outlineResult;p=m.classBreakInfos;n=b.classificationMethod;q="standard-deviation"===n;t=b.normalizationType;
if(!f)throw new k("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");u=ea(f,p.length);if(!u||u.length!==p.length)throw new k("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");v=l&&l.opacity;y=new A.ClassBreaksRenderer({classBreakInfos:p.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,symbol:h.createSymbol(d,{type:b.symbolType,color:u[c],size:h.getSymbolSizeFromScheme(f,d),outline:h.getSymbolOutlineFromScheme(f,
d,v),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}),label:a.label}}),defaultLabel:e?F.other:null,defaultSymbol:e?h.createSymbol(d,{type:b.symbolType,color:f.noDataColor,size:h.getSymbolSizeFromScheme(f,d),outline:h.getSymbolOutlineFromScheme(f,d,v),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}):null,field:b.field,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationType:t,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===
t?m.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new J({type:"class-breaks-color",classificationMethod:n,standardDeviationInterval:b.standardDeviationInterval})});q||K.setLabelsForClassBreaks({classBreakInfos:y.classBreakInfos,classificationMethod:n,normalizationType:t,round:!0});l&&l.visualVariables&&l.visualVariables.length&&(y.visualVariables=l.visualVariables.map(function(a){return a.clone()}));return[2,{renderer:y,colorScheme:w.cloneScheme(f),classBreaksResult:m,defaultValuesUsed:a.defaultValuesUsed,
basemapId:g.basemapId,basemapTheme:g.basemapTheme}]}})})}Object.defineProperty(x,"__esModule",{value:!0});var P=Math.pow(2,53)-1;x.createVisualVariable=H;x.createContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,e,d,g,f,h;return r(this,function(l){switch(l.label){case 0:return[4,W(b)];case 1:return a=l.sent(),c={layer:a.layer,view:a.view},[4,t.all([H(L(a)),a.outlineOptimizationEnabled?I(c):null])];case 2:return e=l.sent(),d=e[0],g=e[1],h=(f=a.normalizationField)?"field":
void 0,[2,O(d,g,h,f,a)]}})})};x.createClassBreaksRenderer=function(b){return q(this,void 0,void 0,function(){var a,c;return r(this,function(e){switch(e.label){case 0:return[4,X(b)];case 1:return a=e.sent(),[4,h.getClassBreaks(Y(a),a.outlineOptimizationEnabled)];case 2:return c=e.sent(),[2,fa(a,c)]}})})};x.createPCTrueColorRenderer=function(b){return Z(b).then(function(a){return{renderer:new B.PointCloudRGBRenderer({field:"RGB",pointsPerInch:a.density,pointSizeAlgorithm:h.getPointSizeAlgorithm(a.size)})}})};
x.createPCContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,e,d,g;return r(this,function(f){switch(f.label){case 0:return[4,aa(b)];case 1:a=f.sent();if(!a.statistics)return[3,2];e=a.statistics;return[3,4];case 2:return[4,h.getSummaryStatistics({layer:a.layer,field:a.field})];case 3:e=f.sent(),f.label=4;case 4:return c=e,[4,ca(c,a)];case 5:return d=f.sent(),g=new B.PointCloudStretchRenderer({field:a.field,pointsPerInch:a.density,pointSizeAlgorithm:h.getPointSizeAlgorithm(a.size),
stops:d.stops}),[2,{renderer:g,basemapId:d.basemapId,basemapTheme:d.basemapTheme,statistics:d.statistics,defaultValuesUsed:d.defaultValuesUsed,colorScheme:d.colorScheme}]}})})};x.createAgeRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,e,d,g,f,m,l,k,n,q,w,x,v,y,z,D,A,B,G,C;return r(this,function(p){switch(p.label){case 0:return[4,ba(b)];case 1:return a=p.sent(),c=a.defaultSymbolEnabled,e=a.view,d=a.startTime,g=a.endTime,f=a.symbolType,m=a.colorMixMode,l=a.edgesType,k=a.layer,n=
{layer:a.layer,view:a.view},[4,t.all([a.unit?{unit:a.unit,statistics:null}:R({view:e,layer:k,startTime:d,endTime:g}),a.outlineOptimizationEnabled?I(n):null])];case 2:return q=p.sent(),w=q[0],x=q[1],v=w.unit,y=w.statistics,z=E.getAgeExpressions({layer:k,startTime:d,endTime:g,unit:v}).valueExpression,D=Q.substitute(F["ageInfo_"+v],{unit:v,startTime:h.formatDate(d,v,k),endTime:h.formatDate(g,v,k)}),[4,H(L({layer:k,basemap:a.basemap,valueExpression:z,symbolType:f,statistics:y,legendOptions:{title:D},
colorScheme:a.colorScheme,theme:a.theme,view:e}))];case 3:return A=p.sent(),B={layer:k,valueExpression:z,defaultSymbolEnabled:c,symbolType:f,colorMixMode:m,edgesType:l},G=O(A,x,null,null,B),C=G.renderer.authoringInfo.visualVariables,C.forEach(function(a){return h.updateAgeRendererAuthoringInfoVV(a,d,g,v)}),[2,u({},G,{unit:v})]}})})}});