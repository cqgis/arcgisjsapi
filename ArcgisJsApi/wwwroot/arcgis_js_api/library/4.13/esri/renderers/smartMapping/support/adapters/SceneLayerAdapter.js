// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Graphic ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/Error ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/fieldUtils ../../statistics/support/utils ./FeatureLayerAdapter ./LayerAdapter ./support/utils ../../../../tasks/support/FeatureSet".split(" "),
function(I,J,u,D,y,r,p,z,A,m,k,l,E,v,w,F,G,H,n,B){return function(C){function b(a){return C.call(this,a)||this}D(b,C);b.prototype._hasCachedStatistics=function(a){return this.layer.hasCachedStatistics(a)};b.prototype._fetchFeaturesFromMemory=function(a,c){return a?a.whenLayerView(this.layer).then(function(a){var d=E.whenFalseOnce(a,"updating").then(function(){return a.queryFeatures(c)}).then(function(a){return"esri.tasks.support.FeatureSet"===a.declaredClass?a.features:a});return l.timeout(d,1E4,
null)}):l.reject(new k("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};b.prototype._generateFeatureSetForCachedHistogram=function(a,c,d,f){void 0===c&&(c=a.minimum);void 0===d&&(d=a.maximum);for(var h=[],g=0;g<f;g++)h[g]=0;for(var e=a.counts.length,t=a.minimum,q=a.maximum,g=0;g<e;g++){var b=(g+.5)/e,b=((1-b)*t+b*q-c)/(d-c)*f;0<=b&&b<=f&&(h[b===f?f-1:Math.floor(b)]+=a.counts[g])}var k=[];h.forEach(function(a,c){var d=new z({attributes:{}});d.attributes.EXPR_1=
c+1;d.attributes.countOFExpr=a;k.push(d)});a=new B;a.features=k;return a};b.prototype._getCachedStatistics=function(a,c){var d=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.minValue||a.maxValue?l.reject(new k("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):m.safeCast(d.queryCachedStatistics(c&&c.name)).then(function(a){var c=a.stats;a=c.min;var d=
c.max,e=c.avg,f=c.stddev,b=c.sum,k=c.variance,c=c.count;if(0!==a||0!==d)e=0===e?null:e,b=0===b?null:b,f=0===f?null:f,k=0===k?null:k,c=0===c?null:c;null==c&&null!=b&&null!=e&&(c=Math.round(b/e));return{avg:e,count:c,max:d,min:a,stddev:f,sum:b,variance:k}})};b.prototype._getSummaryStatisticsFromMemory=function(a,c){return p(this,void 0,void 0,function(){var d,f,b,g,e,t,q,l;return r(this,function(h){switch(h.label){case 0:if(!a.features)return[3,1];f=a.features;return[3,3];case 1:return[4,this._fetchFeaturesFromMemory(a.view)];
case 2:f=h.sent(),h.label=3;case 3:b=(d=f)&&d.length;if(!b)throw new k("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");g=w.isDateField(c);e=u({},a);return"percent-of-total"!==e.normalizationType?[3,5]:[4,n.calculateStatsFromMemory({field:e.field},d)];case 4:t=h.sent();q=t.sum;if(null==q)throw new k("scene-layer-adapter:invalid","invalid normalizationTotal");e.normalizationTotal=q;h.label=5;case 5:return[4,n.calculateStatsFromMemory(e,d,g)];case 6:return l=
h.sent(),[2,n.processSummaryStatisticsResult(l)]}})})};b.prototype._getCachedStatisticsForUniqueValues=function(a,c){var d=this,b=this.layer,h=c&&c.name,g=c&&this.getFieldDomain(a.field);return a.valueExpression||a.sqlExpression||a.sqlWhere?l.reject(new k("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):m.safeCast(b.queryCachedStatistics(h)).then(function(e){var f=e.stats;e=e.labels&&e.labels.labels;
var g={},k=[];if(f.mostFrequentValues){var l="countOF"+h;f.mostFrequentValues.forEach(function(a){var d=new z({attributes:{}});d.attributes[h]=c&&c.name!==b.objectIdField&&(w.isNumericField(c)||w.isDateField(c))?Number(a.value):a.value;d.attributes[l]=a.count;k.push(d)});e&&e.forEach(function(a){g[a.value]=a.label})}f=new B;f.features=k;return n.getUniqueValuesFromFeatureSet(f,d,a.field,g)}).then(function(c){return n.createUVResult(c,"service-cached-query",g,a.returnAllCodedValues)})};b.prototype._getUniqueValuesFromMemory=
function(a,c){var d=c&&this.getFieldDomain(a.field);return(a.features?l.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(c){return m.safeCast(n.calculateUniqueValuesFromMemory(a,c,d))})};b.prototype._getCachedStatisticsForHistogram=function(a,c){var d=this,b=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.normalizationType?l.reject(new k("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):
m.safeCast(b.queryCachedStatistics(c&&c.name)).then(function(c){c=c.stats;var b=a.minValue,e=a.maxValue,b=null!=b?b:c.min,e=null!=e?e:c.max,f=a.numBins||10;c=d._generateFeatureSetForCachedHistogram(c.histogram,b,e,f);return n.getHistogramFromFeatureSet(c,b,e,f)})};b.prototype._getClassBreaksFromMemory=function(a){return p(this,void 0,void 0,function(){var c,d,b,h,g,e;return r(this,function(f){switch(f.label){case 0:if(!a.features)return[3,1];d=a.features;return[3,3];case 1:return[4,this._fetchFeaturesFromMemory(a.view)];
case 2:d=f.sent(),f.label=3;case 3:b=(c=d)&&c.length;if(!b)throw new k("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");h=u({},a);return"percent-of-total"!==h.normalizationType?[3,5]:[4,n.calculateStatsFromMemory({field:h.field},c)];case 4:g=f.sent();e=g.sum;if(null==e)throw new k("scene-layer-adapter:invalid","invalid normalizationTotal");h.normalizationTotal=e;f.label=5;case 5:return[2,n.calculateClassBreaksFromMemory(h,c)]}})})};b.prototype._getHistogramFromMemory=
function(a){var c=this;return(a.features?l.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(d){if(!d||!d.length)return l.reject(new k("scene-layer-adapter:insufficient-data","No features are available to calculate histogram"));var b=a.field,h=a.normalizationType,g=a.valueExpression,e=a.classificationMethod,t=a.minValue,q=a.maxValue,r=a.view,p=null!=t&&null!=q,x=null;e&&"equal-interval"!==e||h?(b=u({},a),b.features=d,x=m.safeCast(c._getBinParamsFromMemory(b))):x=p?l.resolve({min:t,
max:q}):c.summaryStatistics({field:b,valueExpression:g,features:d,view:r}).then(function(a){return a.count?{min:a.min,max:a.max}:l.reject(new k("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return x.then(function(c){return m.safeCast(n.calculateHistogramFromMemory(a,c,d))})})};b.prototype._getBinParamsFromMemory=function(a){return p(this,void 0,void 0,function(){var c,b,f,h,g,e,k,l,m,p;return r(this,function(d){c=a.field;b=a.valueExpression;f=a.classificationMethod;
h=a.standardDeviationInterval;g=a.normalizationType;e=a.normalizationField;k=a.minValue;l=a.maxValue;m=a.features;p=a.view;return[2,this._getClassBreaksFromMemory({field:c,valueExpression:b,normalizationType:g,normalizationField:e,classificationMethod:f,standardDeviationInterval:h,minValue:k,maxValue:l,numClasses:a.numBins,features:m,view:p}).then(function(a){var b=a.normalizationTotal;a=a.classBreakInfos;var d=F.getSQLFilterForNormalization({field:c,normalizationType:g,normalizationField:e});return n.generateBinParams({field:c,
normalizationType:g,normalizationField:e,normalizationTotal:b,classBreaks:a,where:d})})]})})};b.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};b.prototype.getFieldUsageInfo=function(a){a=this.getField(a);if(!a)return null;a=this.layer.getFieldUsageInfo(a.name);return{supportsLabelingInfo:a.supportsLabelingInfo,supportsPopupTemplate:a.supportsPopupTemplate,supportsRenderer:a.supportsRenderer,supportsLayerQuery:a.supportsLayerQuery,supportsStatistics:!0}};b.prototype.getFieldDomain=
function(a,c){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(a,c):null};b.prototype.summaryStatistics=function(a){var c=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatistics(a,b).catch(function(d){return m.safeCast(c._getSummaryStatisticsFromMemory(a,b))}):m.safeCast(this._getSummaryStatisticsFromMemory(a,b))};b.prototype.uniqueValues=function(a){var c=
this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForUniqueValues(a,b).catch(function(d){return c._getUniqueValuesFromMemory(a,b)}):this._getUniqueValuesFromMemory(a,b)};b.prototype.histogram=function(a){var c=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForHistogram(a,
b).catch(function(b){return c._getHistogramFromMemory(a)}):this._getHistogramFromMemory(a)};b.prototype.classBreaks=function(a){var c=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(a):this._hasCachedStatistics(c&&c.name)?l.reject(new k("scene-layer-adapter:not-supported","Cached stats not supported")):m.safeCast(this._getClassBreaksFromMemory(a))};b.prototype.queryFeatureCount=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(a):
l.reject(new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))};b.prototype.generateRenderer=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(a):l.reject(new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))};b.prototype.heatmapStatistics=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.heatmapStatistics(a):
l.reject(new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))};b.prototype.predominantCategories=function(a){return p(this,void 0,void 0,function(){return r(this,function(c){if(this._featureLayerAdapter)return[2,this._featureLayerAdapter.predominantCategories(a)];throw new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support predominantCategories");})})};b.prototype.getSampleFeatures=
function(a){return p(this,void 0,void 0,function(){var c,b,f,h,g,e,l;return r(this,function(d){switch(d.label){case 0:if("mesh"===this.layer.geometryType)throw new k("scene-layer-adapter:not-supported","getSampleFeatures does not support scene layer with mesh geometry type");c=a.view;b=a.sampleSize;f=1;h=this.layer.createQuery();h.outFields=null;h.returnGeometry=!0;h.where=null;h.num=b;g=[];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this._fetchFeaturesFromMemory(c,h)];case 2:return g=d.sent(),
g.length&&0<b&&b<=g.length?[2,A.pickRandom(g,b,f)]:[3,4];case 3:return d.sent(),[3,4];case 4:e=null;if(!this._featureLayerAdapter)return[3,6];l=u({},a);delete l.view;return[4,this._featureLayerAdapter.getSampleFeatures(l)];case 5:e=d.sent(),d.label=6;case 6:return e&&e.length?[2,e]:[2,A.pickRandom(g,g.length,f)]}})})};b.prototype.load=function(a){var c=this,b=this.layer.load(a).then(function(b){var d=b.associatedLayer;c.geometryType=b.geometryType;if(d)return c._featureLayerAdapter=new G({layer:d}),
c._featureLayerAdapter.load(a).then(function(){c.objectIdField=c._featureLayerAdapter.objectIdField;c.supportsSQLExpression=c._featureLayerAdapter.supportsSQLExpression;c.minScale=c._featureLayerAdapter.minScale;c.maxScale=c._featureLayerAdapter.maxScale;c.fullExtent=c._featureLayerAdapter.fullExtent});c.objectIdField=b.objectIdField;c.supportsSQLExpression=!1;c.hasQueryEngine=!1;c.fullExtent=b.fullExtent});this.addResolvingPromise(b);return this.when()};y([v.property({constructOnly:!0})],b.prototype,
"layer",void 0);return b=y([v.subclass("esri.renderers.smartMapping.support.adapters.SceneLayerAdapter")],b)}(v.declared(H))});