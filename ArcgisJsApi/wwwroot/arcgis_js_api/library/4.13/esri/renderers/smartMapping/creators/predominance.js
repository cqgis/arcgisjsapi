// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ./size ./type ./support/utils ../heuristics/outline ../statistics/predominantCategories ../statistics/summaryStatistics ../statistics/support/predominanceUtils ../support/utils ../symbology/predominance ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/numberUtils ../../visualVariables/OpacityVariable".split(" "),
function(ga,y,R,f,m,H,k,z,N,S,T,n,U,V,W,X,A,B,O,Y,Z,aa){function ba(b){return m(this,void 0,void 0,function(){var a,c,d,e,g,h,u;return f(this,function(l){switch(l.label){case 0:if(!(b&&b.layer&&b.view&&b.fields&&b.fields.length))throw new k("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(2>b.fields.length)throw new k("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(10<b.fields.length)throw new k("predominance-renderer:invalid-parameters",
"Maximum 10 fields are supported");a=R({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.includeOpacityVariable=b.includeOpacityVariable||!1;a.includeSizeVariable=b.includeSizeVariable||!1;a.sortBy=null==a.sortBy?"count":a.sortBy;c=[0,2,1,3];d=A.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new k("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+A.getLayerTypeLabels(c).join(", "));return[4,d.load()];
case 1:l.sent();e=d.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if(g&&("polyline"===e||"polygon"===e))throw new k("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new k("predominance-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}h=a.fields.map(function(a){return a.name});if(u=n.verifyBasicFieldValidity(d,h,"predominance-renderer:invalid-parameters"))throw u;return[2,a]}})})}function ca(b){return m(this,void 0,void 0,function(){var a,c,d,e,g;return f(this,function(h){switch(h.label){case 0:return a=b.predominanceScheme,d=c=null,[4,n.getBasemapInfo(b.basemap,b.view)];case 1:e=h.sent();c=z.isSome(e.basemapId)?
e.basemapId:null;d=z.isSome(e.basemapTheme)?e.basemapTheme:null;if(a)return[2,{scheme:B.cloneScheme(a),basemapId:c,basemapTheme:d}];if(g=B.getSchemes({basemap:c,basemapTheme:d,geometryType:b.geometryType,numColors:b.numColors,theme:b.theme,worldScale:b.worldScale,view:b.view}))a=g.primaryScheme,c=g.basemapId,d=g.basemapTheme;return[2,{scheme:a,basemapId:c,basemapTheme:d}]}})})}function da(b,a,c,d){return m(this,void 0,void 0,function(){var e,g,h,u,l,P,Q,p,q,v,w,r,t,C,I,k,m,E,F,G,J,K,x,D,y,L,M,z,A,
B;return f(this,function(f){switch(f.label){case 0:return e=b.layer,g={layer:b.layer,view:b.view},Q=(P=N).all,p=[V({layer:e,fields:d,view:b.view})],b.outlineOptimizationEnabled?[4,U(g)]:[3,2];case 1:return q=f.sent(),[3,3];case 2:q=null,f.label=3;case 3:return[4,Q.apply(P,[p.concat([q])])];case 4:return h=f.sent(),u=h[0],l=h[1],(v=u)&&u.predominantCategoryInfos||(v={predominantCategoryInfos:d.map(function(a){return{value:a,count:0}})}),w=l&&l.opacity,[4,T.createRenderer({layer:e,basemap:b.basemap,
valueExpression:a.valueExpression,valueExpressionTitle:H.predominantCategory,numTypes:-1,defaultSymbolEnabled:b.defaultSymbolEnabled,sortBy:b.sortBy,typeScheme:c,statistics:{uniqueValueInfos:v.predominantCategoryInfos},legendOptions:b.legendOptions,outlineOptimizationEnabled:!1,symbolType:b.symbolType,colorMixMode:b.colorMixMode,edgesType:b.edgesType,view:b.view})];case 5:r=f.sent();t=r.renderer;C=t.uniqueValueInfos;I={};k=0;for(m=b.fields;k<m.length;k++)E=m[k],F=e.getField(E.name),I[F.name]=E.label||
F&&F.alias||E.name;G=0;for(J=C;G<J.length;G++)K=J[G],K.label=I[K.value];b.includeSizeVariable&&(x=e.geometryType,D=null,"polygon"===x?(y=c,L=y.sizeScheme,M=L.background,t.backgroundFillSymbol=n.createSymbol(x,{type:b.symbolType,color:M.color,outline:n.getSymbolOutlineFromScheme(M,x,w)}),D=L.marker.size,x="point"):"polyline"===x?(z=c,D=z.width):(A=c,D=A.size),B=n.createColors(c.colors,C.length),C.forEach(function(a,d){a.symbol=n.createSymbol(x,{type:b.symbolType,color:B[d],size:D,outline:n.getSymbolOutlineFromScheme(c,
x,w),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}})}));l&&l.visualVariables&&l.visualVariables.length&&(t.visualVariables=l.visualVariables.map(function(a){return a.clone()}));t.authoringInfo=new O({type:"predominance",fields:d.slice()});return[2,{renderer:t,predominantCategoryInfos:C,excludedCategoryInfos:r.excludedUniqueValueInfos,predominanceScheme:c,basemapId:r.basemapId,basemapTheme:r.basemapTheme}]}})})}function ea(b,a,c){return S.createVisualVariables({layer:b.layer,basemap:b.basemap,
valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:c,sizeOptimizationEnabled:b.sizeOptimizationEnabled,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),legendOptions:{title:H.sumOfCategories},view:b.view})}function fa(b,a){return m(this,void 0,void 0,function(){var c,d,e,g,h,u,l,k;return f(this,function(f){switch(f.label){case 0:return[4,W({layer:b.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,
sqlWhere:a.statisticsQuery.sqlWhere,view:b.view})];case 1:return c=f.sent(),d=null==c.avg||null==c.stddev,e=1/b.fields.length*100,g=d?100:c.avg+1.285*c.stddev,100<g&&(g=100),h=Z.round([e,g],{strictBounds:!0}),u=new aa({valueExpression:a.valueExpression,stops:[{value:h[0],opacity:.15},{value:h[1],opacity:1}],legendOptions:{title:H.strengthOfPredominance}}),l=new Y({type:"opacity",minSliderValue:c.min,maxSliderValue:c.max}),k=new O({visualVariables:[l]}),[2,{visualVariable:u,statistics:c,defaultValuesUsed:d,
authoringInfo:k}]}})})}Object.defineProperty(y,"__esModule",{value:!0});y.createRenderer=function(b){return m(this,void 0,void 0,function(){var a,c,d,e,g,h,k,l,m,n,p,q,v,w,r,t;return f(this,function(f){switch(f.label){case 0:return[4,ba(b)];case 1:return a=f.sent(),c=a.layer,[4,ca({basemap:a.basemap,geometryType:c.geometryType,numColors:a.fields.length,predominanceScheme:a.predominanceScheme,worldScale:-1<a.symbolType.indexOf("3d-volumetric"),view:a.view})];case 2:return d=f.sent(),e=d.scheme,g=a.fields.map(function(a){return a.name}),
h=X.getPredominanceExpressions(c,g),k=da(a,h.predominantCategory,e,g),l=a.includeSizeVariable?ea(a,h.size,e.sizeScheme):null,m=a.includeOpacityVariable?fa(a,h.opacity):null,[4,N.all([k,l,m])];case 3:return n=f.sent(),p=n[0],q=n[1],v=n[2],w=[],r=[],q&&(Array.prototype.push.apply(w,q.visualVariables.map(function(a){return a.clone()})),delete q.sizeScheme,p.size=q,Array.prototype.push.apply(r,q.authoringInfo.visualVariables.map(function(a){return a.clone()}))),v&&(w.push(v.visualVariable.clone()),p.opacity=
v,Array.prototype.push.apply(r,v.authoringInfo.visualVariables.map(function(a){return a.clone()}))),w.length&&(t=p.renderer.visualVariables||[],Array.prototype.push.apply(t,w),p.renderer.visualVariables=t,p.renderer.authoringInfo.visualVariables=r),[2,p]}})})}});