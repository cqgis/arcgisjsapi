// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.13/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/assignHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../Color ../request ../core/Error ../core/iteratorUtils ../core/lang ../core/Logger ../core/LRUCache ../core/promiseUtils ../core/accessorSupport/decorators ./Renderer ./mixins/VisualVariablesMixin ../support/arcadeOnDemand ../symbols/CIMSymbol".split(" "),function(W,X,M,f,l,z,r,N,A,O,P,m,Q,R,J,e,S,T,K,U){var V=
Q.getLogger("esri.renderers.DictionaryRenderer");return function(L){function b(a){a=L.call(this)||this;a._ongoingRequests=new Map;a._symbolCache=new R(100);a.config=null;a.description=null;a.fieldMap=null;a.label=null;a.url=null;a.type="dictionary";return a}M(b,L);v=b;b.prototype.clone=function(){return new v({config:m.clone(this.config),description:m.clone(this.description),fieldMap:m.clone(this.fieldMap),label:m.clone(this.label),url:m.clone(this.url),visualVariables:m.clone(this.visualVariables)})};
b.prototype.collectRequiredFields=function(a,b){return r(this,void 0,void 0,function(){var n,c;return z(this,function(d){switch(d.label){case 0:return[4,this.collectVVRequiredFields(a,b)];case 1:d.sent();n=b.map(function(a){return a.name});for(c in this.fieldMap)0>n.indexOf(this.fieldMap[c])||a.add(this.fieldMap[c]);return[2]}})})};b.prototype.fetchResources=function(a){return r(this,void 0,void 0,function(){var b,B,c,d,w,g,F,h,D,e,p,x,y,t,k,q,f;return z(this,function(n){switch(n.label){case 0:if(!this.url)return V.error("no valid URL!"),
[2,void 0];b=a&&a.abortOptions;B=A(this.url+"/resources/styles/dictionary-info.json",l({responseType:"json",query:{f:"json"}},b));return[4,J.all([B,K.loadArcade()])];case 1:c=n.sent()[0].data;if(!c)throw new O("esri.renderers.DictionaryRenderer","Bad dictionary data!");d=c.expression;w=c.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+c.cimRefTemplateUrl;this._itemNames=P.SetFromValues(c.itemsNames);this._symbolAttributes=w.symbol;g={};if(this.config)for(h in F=this.config,F)g[h]=F[h];D=0;for(e=
w.configuration;D<e.length;D++)h=e[D],g.hasOwnProperty(h.name)||(g[h.name]=h.value);p=[];if(a&&a.fields)for(x=function(c){var b=y.fieldMap[c],d=a.fields.filter(function(a){return a.name===b});0<d.length&&p.push(l({},d[0],{name:c}))},y=this,t=0,k=this._symbolAttributes;t<k.length;t++)h=k[t],x(h);return[4,K.createDictionaryExpression(d,a.spatialReference,p,g)];case 2:return q=n.sent(),f={scale:0},[2,function(a,c){a=q.repurposeFeature({geometry:null,attributes:a});f.scale=c&&c.scale;return q.evaluate({$feature:a,
$view:f})}]}})})};b.prototype.getSymbol=function(a,b){return null};b.prototype.getSymbolAsync=function(a,b){return r(this,void 0,void 0,function(){var n,c,d,w,g,e,h,f,m,p,x,y,t,k,q,r,l,u,C,E,v,G,H,A,I;return z(this,function(B){switch(B.label){case 0:return this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(b)),[4,this._dictionaryPromise];case 1:n=B.sent();c={};d=0;for(w=this._symbolAttributes;d<w.length;d++)g=w[d],(e=this.fieldMap[g])&&null!==a.attributes[e]&&void 0!==a.attributes[e]?
(h=""+a.attributes[e],c[g]=h):c[g]="";f=n(c,b);if(!f||"string"!==typeof f)return[2,null];m=f.split(";");p=[];x=[];y=0;for(t=m;y<t.length;y++)if((k=t[y])&&0!==k.length)if(-1!==k.indexOf("po:"))q=k.substr(3).split("|"),3===q.length&&(r=q[0],l=q[1],u=q[2],"DashTemplate"===l?u=u.split(" ").map(function(a){return Number(a)}):"Color"===l?(C=(new N(u)).toRgba(),u=[C[0],C[1],C[2],255*C[3]]):u=Number(u),x.push({primitiveName:r,propertyName:l,value:u}));else if(-1!==k.indexOf("|"))for(E=0,v=k.split("|");E<
v.length;E++)G=v[E],this._itemNames.has(G)&&p.push(G);else this._itemNames.has(k)&&p.push(k);H=p.join(";")+x.map(function(a){return a.primitiveName+";"+a.propertyName+";"+a.value});if(A=this._symbolCache.get(H))return[2,A];I=this._cimPartsToCIMSymbol(p,x,b);this._symbolCache.put(H,I,1);return[2,I]}})})};b.prototype.getSymbols=function(){return[]};b.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(a,b){return a+b.getAttributeHash()},"")};b.prototype.getMeshHash=
function(){return this.url+"-"+JSON.stringify(this.fieldMap)};b.prototype._getSymbolPart=function(a,b){return r(this,void 0,void 0,function(){var e,c,d;return z(this,function(f){switch(f.label){case 0:if(this._ongoingRequests.has(a))return[2,this._ongoingRequests.get(a).then(function(a){return a.data})];e=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,a);c=A(e,l({responseType:"json",query:{f:"json"}},b));this._ongoingRequests.set(a,c);return[4,c];case 1:return d=f.sent(),[2,d.data]}})})};b.prototype._combineSymbolParts=
function(a,b){var e;if(!a||0===a.length)return null;if(1===a.length)return{type:"CIMSymbolReference",symbol:a[0],primitiveOverrides:b};var c=l({},a[0]);c.symbolLayers=[];for(var d=0;d<a.length;d++){var f=a[d];(e=c.symbolLayers).unshift.apply(e,f.symbolLayers)}return{type:"CIMSymbolReference",symbol:c,primitiveOverrides:b}};b.prototype._cimPartsToCIMSymbol=function(a,b,e){return r(this,void 0,void 0,function(){var c,d,f;return z(this,function(g){switch(g.label){case 0:c=Array(a.length);for(d=0;d<a.length;d++)c[d]=
this._getSymbolPart(a[d],e);return[4,J.eachAlwaysValues(c)];case 1:return f=g.sent(),[2,new U({data:this._combineSymbolParts(f,b)})]}})})};var v;f([e.property({type:Object,json:{write:!0}})],b.prototype,"config",void 0);f([e.property({type:String,json:{write:!0}})],b.prototype,"description",void 0);f([e.property({type:Object,json:{write:!0}})],b.prototype,"fieldMap",void 0);f([e.property({type:String,json:{write:!0}})],b.prototype,"label",void 0);f([e.property({type:String,json:{write:!0}})],b.prototype,
"url",void 0);return b=v=f([e.subclass("esri.renderers.DictionaryRenderer")],b)}(e.declared(T.VisualVariablesMixin(S)))});