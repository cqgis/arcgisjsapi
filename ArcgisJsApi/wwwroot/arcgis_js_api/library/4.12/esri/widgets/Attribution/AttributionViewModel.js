// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/generatorHelper ../../geometry ../../core/arrayUtils ../../core/Collection ../../core/HandleOwner ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/support/contains ../../geometry/support/webMercatorUtils".split(" "),function(C,D,u,l,v,w,x,y,q,z,r,f,A,t){function B(d,c){return d.length!==c.length||d.some(function(b,a){return b.text!==
c[a].text})}function n(d,c,b){b&&c&&(y.find(d,function(a){return a.layerView===c&&a.text===b})||d.push({text:b,layerView:c}))}var e=[];return function(d){function c(b){var a=d.call(this,b)||this;a.clear=function(){a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension")};a._pendingAttributions=new Set;a._fetchedAttributionData=new Map;a.items=new q;a.view=null;a._allLayerViewsChange=function(b){a.handles.remove("suspension");var k=a.get("view.allLayerViews");
k&&a.handles.add(k.map(function(b){return b.watch(["suspended","attributionVisible"],a._updateAttributionItems)}),"suspension");b&&b.removed&&b.removed.forEach(function(b){a._pendingAttributions.delete(b);a._fetchedAttributionData.delete(b)});a._updateAttributionItems()};a._updateAttributionItems=function(){var b=a.get("view.allLayerViews");e.length=0;b?(b.forEach(function(b){if(!b.suspended&&b.get("layer.attributionVisible")){var c=b.layer;if(c&&"function"===typeof c.originOf&&"user"===c.originOf("copyright"))n(e,
b,c.copyright);else if(c.hasAttributionData)if(a._fetchedAttributionData.has(b)){var g=a._fetchedAttributionData.get(b);g&&n(e,b,a._getDynamicAttribution(g,a.view,c))}else a._fetchAttributionData(b);else(g=c.get("portalItem.accessInformation"))?n(e,b,g):n(e,b,c.copyright)}}),B(a.items,e)&&(a.items.removeAll(),a.items.addMany(e))):a.clear()};a.handles.add([r.on(a,"view.allLayerViews","change",a._allLayerViewsChange,a._allLayerViewsChange,a.clear),r.whenTrue(a,"view.stationary",function(){return a._updateAttributionItems()})]);
return a}u(c,d);c.prototype.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear()};Object.defineProperty(c.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0});c.prototype._fetchAttributionData=function(b){return v(this,void 0,void 0,function(){var a,c;return w(this,function(g){switch(g.label){case 0:if(this._pendingAttributions.has(b))return[2];this._pendingAttributions.add(b);a=null;
g.label=1;case 1:return g.trys.push([1,3,,4]),[4,b.layer.fetchAttributionData()];case 2:return c=g.sent(),a=this._createContributionIndex(c,"bing-maps"===b.layer.type),[3,4];case 3:return g.sent(),[3,4];case 4:return this._pendingAttributions.has(b)&&(this._pendingAttributions.delete(b),this._fetchedAttributionData.set(b,a)),this._updateAttributionItems(),[2]}})})};c.prototype._createContributionIndex=function(b,a){b=b.contributors;var c={};if(!b)return c;for(var k=0;k<b.length;k++){var d=b[k],e=
d.coverageAreas;if(!e)return;for(var p=0;p<e.length;p++)for(var h=e[p],f=h.bbox,m=h.zoomMin-(a&&h.zoomMin?1:0),l=h.zoomMax-(a&&h.zoomMax?1:0),h={extent:t.geographicToWebMercator({xmin:f[1],ymin:f[0],xmax:f[3],ymax:f[2],spatialReference:x.SpatialReference.WGS84}),attribution:d.attribution||"",score:null!=h.score?h.score:100,id:k};m<=l;m++)c[m]=c[m]||[],c[m].push(h)}c.maxKey=Math.max.apply(null,Object.keys(c));return c};c.prototype._getDynamicAttribution=function(b,a,c){var d=a.extent;c=c.tileInfo.scaleToZoom(a.scale);
c=Math.min(b.maxKey,Math.round(c));if(!d||null==c||-1>=c)return"";b=b[c];var e=t.project(d.center.clone().normalize(),a.spatialReference),f={};return b?b.filter(function(a){var b=!f[a.id]&&e&&A.extentContainsPoint(a.extent,e);b&&(f[a.id]=!0);return b}).sort(function(a,b){return b.score-a.score||a.objectId-b.objectId}).map(function(a){return a.attribution}).join(", "):""};l([f.property({readOnly:!0,type:q})],c.prototype,"items",void 0);l([f.property({dependsOn:["view.ready"],readOnly:!0})],c.prototype,
"state",null);l([f.property()],c.prototype,"view",void 0);return c=l([f.subclass("esri.widgets.Attribution.AttributionViewModel")],c)}(f.declared(z))});