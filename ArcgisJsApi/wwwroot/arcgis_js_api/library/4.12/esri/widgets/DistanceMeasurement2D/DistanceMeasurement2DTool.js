// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../Graphic ../../symbols ../../core/Handles ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/Point ../../geometry/Polyline ../../geometry/projection ../../geometry/SpatialReference ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../views/2d/draw/Draw ../../views/interactive/GraphicManipulator ../../views/interactive/InteractiveToolBase ../../views/interactive/interactiveToolUtils".split(" "),
function(D,E,v,d,m,h,w,c,q,t,x,l,y,n,u,z,A,B,r){function C(c,a,b,k){var p=new h.SimpleMarkerSymbol({style:"circle",color:k.handleColor,size:k.handleWidth,outline:{type:"simple-line",width:0}});k=new h.SimpleMarkerSymbol({style:"circle",color:k.handleColor,size:1.5*k.handleWidth,outline:{type:"simple-line",width:0}});c=new m({geometry:c,symbol:p});return new A.GraphicManipulator({view:a,layer:b,graphic:c,focusedSymbol:k})}return function(h){function a(b){b=h.call(this,b)||this;b._drawActive=!1;b._handles=
new w;b._polylineLayer=new u({listMode:"hide"});b._manipulatorLayer=new u({listMode:"hide"});b._vertices=[];return b}v(a,h);a.prototype.initialize=function(){var b=this;this._draw=new z({view:this.view});var a=this.view;a.map.addMany([this._polylineLayer,this._manipulatorLayer]);a.focus();this._handles.add(this.watch(["viewModel.unit","viewModel.mode"],function(){b._updatePolylines()}));this.projectionEngineRequired&&this.projectionEngineSupported&&(l.isLoaded()||l.load())};a.prototype.destroy=function(){this.detach();
this._handles.removeAll();this._polylineLayer.removeAll();this.viewModel.view.map.remove(this._polylineLayer);this.viewModel.view.map.remove(this._manipulatorLayer);this.viewModel.measurement=null;this._draw&&(this._draw.destroy(),this._draw=null);this._handles&&(this._handles.destroy(),this._handles=null);this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null);this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)};Object.defineProperty(a.prototype,
"editable",{set:function(b){this._set("editable",b);b||this._draw.reset()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"projectionEngineRequired",{get:function(){if(!this.view||!this.view.spatialReference)return!1;var b=this.view.spatialReference;return!b.isWebMercator&&!b.isWGS84&&!n.isSupported(b)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"projectionEngineSupported",{get:function(){return l.isSupported()},enumerable:!0,configurable:!0});a.prototype.onShow=
function(){this._polylineLayer.visible=!0};a.prototype.onHide=function(){this._polylineLayer.visible=!1};a.prototype.reset=function(){this._vertices=[];this._polylineLayer.removeAll();this.viewModel.measurement=null;this._draw.reset();this._drawActive=!1;this._updateSketch([])};a.prototype.newMeasurement=function(){this.reset();r.setActive(this,!0);this._startSketch()};a.prototype.clearMeasurement=function(){this.reset();r.setActive(this,!1);this.cursor=null};a.prototype.onInputEvent=function(b){"pointer-move"===
b.type&&this._updateCursor()};a.prototype._startSketch=function(){var b=this;this._drawActive=!0;var a=this._draw.create("polyline",{mode:"click"});a.on("vertex-add",function(a){return b._updateSketch(a.vertices)});a.on("vertex-update",function(a){return b._updateSketch(a.vertices)});a.on("vertex-remove",function(a){return b._updateSketch(a.vertices)});a.on("cursor-update",function(a){return b._updateSketch(a.vertices)});a.on("undo",function(a){return b._updateSketch(a.vertices)});a.on("redo",function(a){return b._updateSketch(a.vertices)});
a.on("draw-complete",function(){return b._stopSketch()})};a.prototype._stopSketch=function(){this.manipulators.forEach(function(a){a.manipulator.interactive=!0});r.setActive(this,!1);this._drawActive=!1};a.prototype._updateSketch=function(a){var b=this;if(!this.projectionEngineRequired||l.isLoaded())if(2>a.length)this._vertices=[],this.manipulators.removeAll(),this._polylineLayer.removeAll();else{for(var p=this.view.spatialReference;this._vertices.length>a.length;){var f=this._vertices.pop().manipulatorId;
this.manipulators.remove(f)}for(var f=function(e){var d=a[e],f=d[0],d=d[1],g=new t({x:f,y:d,spatialReference:p}),k=C(g,c.view,c._manipulatorLayer,c.viewModel.palette),g=c.manipulators.add(k);k.on("drag",function(){var a=k.graphic.geometry;b._vertices[e].coord=[a.x,a.y];b._updatePolylines()});c._vertices.push({manipulatorId:g,coord:[f,d]})},c=this,e=this._vertices.length;e<a.length;e++)f(e);var f=this._vertices.length-1,e=this._vertices[f],g=a[f],d=g[0],g=g[1];if(e.coord[0]!==d||e.coord[1]!==g)e.coord=
[d,g],d=new t({x:d,y:g,spatialReference:p}),this.manipulators.findById(e.manipulatorId).graphic.geometry=d;var h=this._drawActive?this._vertices[f].manipulatorId:null;this.manipulators.forEach(function(a){a.manipulator.interactive=null==h||a.id!==h});this._updatePolylines()}};a.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null};a.prototype._updatePolylines=function(){this._polylineLayer.removeAll();var a=this.viewModel,d=a.palette,c=a.view.spatialReference,f=n.isSupported(c),
h=!f&&!c.isWebMercator&&!c.isWGS84,c=new x({paths:[this._vertices.map(function(a){return a.coord})],spatialReference:c}),e=h?l.project(c,y.WGS84):c,g=null;f||h?(a.measurement={geometry:e,length:n.geodesicLengths([e],"meters")[0]},g=n.geodesicDensify(e,1E5)):(f=q.planarLength(e,"meters"),"geodesic"===a.mode||"auto"===a.mode&&f>=a.geodesicDistanceThreshold?(a.measurement={geometry:e,length:q.geodesicLength(e,"meters")},g=q.geodesicDensify(c,1E5,"meters")):(a.measurement={geometry:e,length:f},g=c.clone()));
this._polylineLayer.addMany([new m({geometry:g,symbol:{type:"simple-line",cap:"butt",join:"round",color:d.pathPrimaryColor,width:d.pathWidth}}),new m({geometry:g,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:d.pathSecondaryColor,width:d.pathWidth-2}}),new m({geometry:c.extent.center,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:a.measurementLabel,font:{size:14,family:"sans-serif"}}})])};d([c.property({constructOnly:!0})],a.prototype,"view",
void 0);d([c.property({constructOnly:!0})],a.prototype,"viewModel",void 0);d([c.property()],a.prototype,"cursor",void 0);d([c.property({value:!0})],a.prototype,"editable",null);d([c.property({dependsOn:["view.spatialReference"],readOnly:!0})],a.prototype,"projectionEngineRequired",null);d([c.property({readOnly:!0})],a.prototype,"projectionEngineSupported",null);return a=d([c.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],a)}(c.declared(B.InteractiveToolBase))});