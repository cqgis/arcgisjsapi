// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../Graphic ../../core/Handles ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/Point ../../geometry/Polygon ../../geometry/Polyline ../../geometry/projection ../../geometry/SpatialReference ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../symbols/SimpleMarkerSymbol ../../views/2d/draw/Draw ../../views/interactive/GraphicManipulator ../../views/interactive/InteractiveToolBase ../../views/interactive/interactiveToolUtils".split(" "),
function(F,G,y,f,m,z,d,e,u,A,v,l,q,k,w,n,B,C,D,r){function E(e,c,d,a){var b=new n({style:"circle",color:a.handleColor,size:a.handleWidth,outline:{type:"simple-line",width:0}});a=new n({style:"circle",color:a.handleColor,size:1.5*a.handleWidth,outline:{type:"simple-line",width:0}});e=new m({geometry:e,symbol:b});return new C.GraphicManipulator({view:c,layer:d,graphic:e,focusedSymbol:a})}return function(n){function c(a){a=n.call(this,a)||this;a._drawActive=!1;a._handles=new z;a._graphicsLayer=new w({listMode:"hide"});
a._manipulatorLayer=new w({listMode:"hide"});a._vertices=[];return a}y(c,n);t=c;c.prototype.initialize=function(){var a=this;this._draw=new B({view:this.view});var b=this.view;b.map.addMany([this._graphicsLayer,this._manipulatorLayer]);b.focus();this._handles.add(this.watch(["viewModel.unit","viewModel.mode"],function(){a._updateGraphics()}));this.projectionEngineRequired&&this.projectionEngineSupported&&(l.isLoaded()||l.load())};c.prototype.destroy=function(){this.detach();this._handles.removeAll();
this._graphicsLayer.removeAll();this.viewModel.view.map.remove(this._graphicsLayer);this.viewModel.view.map.remove(this._manipulatorLayer);this.viewModel.measurement=null;this._draw&&(this._draw.destroy(),this._draw=null);this._handles&&(this._handles.destroy(),this._handles=null);this._graphicsLayer&&(this._graphicsLayer.destroy(),this._graphicsLayer=null);this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)};Object.defineProperty(c.prototype,"editable",{set:function(a){this._set("editable",
a);a||this._draw.reset()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"projectionEngineRequired",{get:function(){if(!this.view||!this.view.spatialReference)return!1;var a=this.view.spatialReference;return!a.isWebMercator&&!a.isWGS84&&!k.isSupported(a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"projectionEngineSupported",{get:function(){return l.isSupported()},enumerable:!0,configurable:!0});c.prototype.onShow=function(){this._graphicsLayer.visible=!0};
c.prototype.onHide=function(){this._graphicsLayer.visible=!1};c.prototype.reset=function(){this._vertices=[];this._graphicsLayer.removeAll();this.viewModel.measurement=null;this._draw.reset();this._drawActive=!1;this._updateSketch([])};c.prototype.newMeasurement=function(){this.reset();r.setActive(this,!0);this._startSketch()};c.prototype.clearMeasurement=function(){this.reset();r.setActive(this,!1);this.cursor=null};c.updateViewModelAndCreateGraphics=function(a,b,c,x,h,g){var p=[];if(2===a.length){a=
new v({paths:[a.map(function(a){return a.coord})],spatialReference:b});c&&(a=l.project(a,q.WGS84));if(x||c)a=k.geodesicDensify(a,1E5);else if(c=e.geodesicLength(a,"meters"),"geodesic"===h.mode||"auto"===h.mode&&c>=h.geodesicDistanceThreshold)a=e.geodesicDensify(a,1E5,"meters");p.push(new m({geometry:a,symbol:{type:"simple-line",color:g.pathColor,width:g.pathWidth}}))}else{a.push(a[0]);var d=a.map(function(a){return a.coord});a=new v({paths:[d],spatialReference:b});b=new A({rings:[d],spatialReference:b});
c&&(b=l.project(b,q.WGS84),a=l.project(a,q.WGS84));x||c?(b=k.geodesicDensify(b,1E5),a=k.geodesicDensify(a,1E5),b=e.simplify(b),h.measurement={geometry:b,area:k.geodesicAreas([b],"square-meters")[0],perimeter:k.geodesicLengths([b],"meters")[0]}):(c=e.planarLength(b,"meters"),"geodesic"===h.mode||"auto"===h.mode&&c>=h.geodesicDistanceThreshold?(b=e.geodesicDensify(b,1E5,"meters"),a=e.geodesicDensify(a,1E5,"meters"),b=e.simplify(b),h.measurement={geometry:b,area:e.geodesicArea(b,"square-meters"),perimeter:e.geodesicLength(b,
"meters")}):(b=e.simplify(b),h.measurement={geometry:b,area:e.planarArea(b,"square-meters"),perimeter:c}));p.push(new m({geometry:b,symbol:{type:"simple-fill",style:"solid",color:g.fillColor,outline:{type:"simple-line",width:0}}}));p.push(new m({geometry:a,symbol:{type:"simple-line",style:"solid",color:g.pathColor,width:g.pathWidth}}));p.push(new m({geometry:b.centroid,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:h.measurementLabel.area,font:{size:14,family:"sans-serif"}}}))}return p};
c.prototype.onInputEvent=function(a){"pointer-move"===a.type&&this._updateCursor()};c.prototype._startSketch=function(){var a=this;this._drawActive=!0;var b=this._draw.create("polyline",{mode:"click"});b.on("vertex-add",function(b){return a._updateSketch(b.vertices)});b.on("vertex-update",function(b){return a._updateSketch(b.vertices)});b.on("vertex-remove",function(b){return a._updateSketch(b.vertices)});b.on("cursor-update",function(b){return a._updateSketch(b.vertices)});b.on("undo",function(b){return a._updateSketch(b.vertices)});
b.on("redo",function(b){return a._updateSketch(b.vertices)});b.on("draw-complete",function(){return a._stopSketch()})};c.prototype._stopSketch=function(){this.manipulators.forEach(function(a){a.manipulator.interactive=!0});r.setActive(this,!1);this._drawActive=!1};c.prototype._updateSketch=function(a){var b=this;if(!this.projectionEngineRequired||l.isLoaded())if(2>a.length)this._vertices=[],this.manipulators.removeAll(),this._graphicsLayer.removeAll();else{for(var c=this.view.spatialReference;this._vertices.length>
a.length;){var e=this._vertices.pop().manipulatorId;this.manipulators.remove(e)}for(var e=function(e){var d=a[e],g=d[0],d=d[1],f=new u({x:g,y:d,spatialReference:c}),k=E(f,h.view,h._manipulatorLayer,h.viewModel.palette),f=h.manipulators.add(k);k.on("drag",function(){var a=k.graphic.geometry;b._vertices[e].coord=[a.x,a.y];b._updateGraphics()});h._vertices.push({manipulatorId:f,coord:[g,d]})},h=this,g=this._vertices.length;g<a.length;g++)e(g);var e=this._vertices.length-1,g=this._vertices[e],d=a[e],
f=d[0],d=d[1];if(g.coord[0]!==f||g.coord[1]!==d)g.coord=[f,d],f=new u({x:f,y:d,spatialReference:c}),this.manipulators.findById(g.manipulatorId).graphic.geometry=f;var k=this._drawActive?this._vertices[e].manipulatorId:null;this.manipulators.forEach(function(a){a.manipulator.interactive=null==k||a.id!==k});this._updateGraphics()}};c.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null};c.prototype._updateGraphics=function(){this._graphicsLayer.removeAll();var a=this._vertices.slice(),
b=this.viewModel,c=b.palette,d=b.view.spatialReference,e=k.isSupported(d),a=t.updateViewModelAndCreateGraphics(a,d,!e&&!d.isWebMercator&&!d.isWGS84,e,b,c);this._graphicsLayer.addMany(a)};var t;f([d.property({constructOnly:!0})],c.prototype,"view",void 0);f([d.property({constructOnly:!0})],c.prototype,"viewModel",void 0);f([d.property()],c.prototype,"cursor",void 0);f([d.property({value:!0})],c.prototype,"editable",null);f([d.property({dependsOn:["view.spatialReference"],readOnly:!0})],c.prototype,
"projectionEngineRequired",null);f([d.property({readOnly:!0})],c.prototype,"projectionEngineSupported",null);return c=t=f([d.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],c)}(d.declared(D.InteractiveToolBase))});