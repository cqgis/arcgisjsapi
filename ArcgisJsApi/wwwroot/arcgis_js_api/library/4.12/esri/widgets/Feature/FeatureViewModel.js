// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../Graphic ../../intl ../../core/asyncUtils ../../core/Handles ../../core/lang ../../core/Logger ../../core/promiseUtils ../../core/throttle ../../core/watchUtils ../../core/accessorSupport/decorators ../../intl/date ../../intl/number ../../layers/support/fieldUtils ../../popup/content/TextContent ../../popup/content/support/ChartMediaInfoValueSeries ../../popup/support/FieldInfoFormat ../../tasks/support/AttachmentQuery ./support/featureUtils ./support/RelatedFeatures ../support/widget".split(" "),
function(G,X,H,k,w,t,u,I,v,J,K,p,L,n,M,N,g,O,A,P,Q,R,S,T,q,U,B){function V(){return u(this,void 0,void 0,function(){return t(this,function(g){return[2,n.create(function(d){G(["../../support/arcadeUtils"],function(a){d(a)})})]})})}function x(g,d){return g&&"function"===typeof g.getField?g.getField(d):null}function y(g){return g.replace(/[\u00A0-\u9999<>\&]/gim,function(d){return"\x26#"+d.charCodeAt(0)+";"})}var W=["$datastore","$map","$layer"],z=L.getLogger("esri.widgets.FeatureViewModel"),D=/^\s*expression\//i,
E=O.convertDateFormatToIntlOptions("short-date-short-time");return function(C){function d(a){var b=C.call(this)||this;b._handles=new K;b._featureAbortController=null;b._graphicChangedThrottled=M.throttle(b._graphicChanged,1,b);b._effectivePopupTemplate=null;b._contentResponse=null;b._graphic=null;b.content=null;b.defaultPopupTemplateEnabled=!1;b.formattedAttributes=null;b.graphic=null;b.lastEditInfo=null;b.title="";b.view=null;b._handles.add(N.init(b,"graphic graphic.sourceLayer.popupTemplate.title graphic.sourceLayer.popupTemplate.content graphic.sourceLayer.popupTemplate.fieldInfos graphic.sourceLayer.popupTemplate.lastEditInfoEnabled graphic.popupTemplate.title graphic.popupTemplate.content graphic.popupTemplate.fieldInfos graphic.popupTemplate.lastEditInfoEnabled".split(" "),
function(){return b._graphicChangedThrottled()}));return b}H(d,C);d.prototype.destroy=function(){this._clear();this._cancelFeatureQuery();this._handles.destroy();this._graphic=this.graphic=this._handles=null};Object.defineProperty(d.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(a){void 0===a?this._clearOverride("spatialReference"):this._override("spatialReference",a)},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"map",
{get:function(){return this.get("view.map")||null},set:function(a){void 0===a?this._clearOverride("map"):this._override("map",a)},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!0,configurable:!0});d.prototype._clear=function(){this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};d.prototype._graphicChanged=function(){return u(this,void 0,void 0,function(){var a,
b,c,e;return t(this,function(f){switch(f.label){case 0:this._cancelFeatureQuery();this._clear();this._graphic=b=(a=this.graphic)?a.clone():null;if(!b)return[2];this._featureAbortController=c=n.createAbortController();f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this._queryFeature({signal:c.signal})];case 2:return f.sent(),[3,4];case 3:return e=f.sent(),z.error("error","error loading template",e),[3,4];case 4:return this._featureAbortController=null,[2]}})})};d.prototype._cancelFeatureQuery=function(){var a=
this._featureAbortController;a&&a.abort();this._featureAbortController=null};d.prototype._compileContent=function(a,b){var c=this;if(a&&(a.nodeName||a&&B.isWidgetBase(a)||B.isWidget(a)))return a;if("string"===typeof a)return this._compileText(new Q({text:a})).text;if(Array.isArray(a))return a.map(function(a,f){f=(f=b&&b[f])&&f.value;if("attachments"===a.type)return c._compileAttachments(a,f);if("fields"===a.type)return c._compileFields(a);if("media"===a.type)return c._compileMedia(a);if("text"===
a.type)return c._compileText(a)});a&&z.warn("invalid content type.")};d.prototype._compileFields=function(a){var b=this,c=this._effectivePopupTemplate;a=p.clone(a);var e=c&&c.expressionInfos,c=a.fieldInfos?void 0:c&&c.fieldInfos,c=a.fieldInfos||p.clone(c),f=[];c&&c.forEach(function(a){var c=a.fieldName.toLowerCase();if(!a.hasOwnProperty("visible")||a.visible)c=b._isExpressionField(c)?b._getExpressionInfo(e,c):null,a.label=c?c.title:a.label,f.push(a)});a.fieldInfos=f;return a};d.prototype._setImageValue=
function(a){var b=a.value,c=a.formattedAttributes;a=a.layer;var e=b.linkURL,f=b.sourceURL;f&&(f=this._fixTokens(f,a),b.sourceURL=this._substituteAttributes(c,f));e&&(a=this._fixTokens(e,a),b.linkURL=this._substituteAttributes(c,a))};d.prototype._compileMedia=function(a){var b=this,c=this._graphic;a=p.clone(a);var e=a.mediaInfos,f=c.attributes,d=q.getSourceLayer(c),l=this.formattedAttributes.global;a.mediaInfos=e&&e.map(function(a){if(a=p.clone(a)){var c=a.title?b._processFieldsInLinks(a.title,f):
"",e=a.caption?b._processFieldsInLinks(a.caption,f):"";a.title=c?b._substituteAttributes(l,c):"";a.caption=e?b._substituteAttributes(l,e):"";if("image"===a.type)return c=a.value,b._setImageValue({value:c,formattedAttributes:l,layer:d}),a.value.sourceURL?a:void 0;if("pie-chart"===a.type||"line-chart"===a.type||"column-chart"===a.type||"bar-chart"===a.type)return c=a.value,b._setChartValue({value:c,attributes:f,formattedAttributes:l,layer:d}),a}}).filter(Boolean);return a};d.prototype._substituteAttributes=
function(a,b){return(""+this._removeEmptyHref(v.substitute(b,a))).trim()};d.prototype._compileText=function(a){if((a=p.clone(a))&&a.text){var b=this.formattedAttributes.global,c=this._processFieldsInLinks(a.text,this._graphic.attributes);a.text=this._substituteAttributes(b,c)}return a};d.prototype._formatEditInfo=function(a,b){var c=a.creatorField,e=a.creationDateField,f=a.editorField;if(b){a=b[a.editDateField];if("number"===typeof a)return b=b[f],c=v.formatDate(a,E),{type:"edit",date:c,user:b};e=
b[e];if("number"===typeof e)return b=b[c],c=v.formatDate(e,E),{type:"create",date:c,user:b}}};d.prototype._compileLastEditInfo=function(){var a=this._effectivePopupTemplate,b=this._graphic;if(a){var a=a.lastEditInfoEnabled,c=b.get("sourceLayer.editFieldsInfo");if(a&&c)return this._formatEditInfo(c,b.attributes)}};d.prototype._compileTitle=function(){var a=this._effectivePopupTemplate,b=this._graphic,c=a&&a.title,e=b.attributes,a=this.formattedAttributes.global;return"function"===typeof c?c.call(null,
{graphic:b}):"string"===typeof c&&c?(b=this._processFieldsInLinks(c,e),this._substituteAttributes(a,b)):""};d.prototype._getExpressionInfo=function(a,b){if(this._isExpressionField(b)){var c=b.replace(D,"").toLowerCase(),e;a.some(function(a){if(a.name.toLowerCase()===c)return e=a,!0});return e}};d.prototype._fixTokens=function(a,b){return a.replace(/(\{([^\{\r\n]+)\})/g,function(a,e,f){return(a=x(b,f))?"{"+a.name+"}":e})};d.prototype._encodeAttributes=function(a){var b=a?p.clone(a):{};Object.keys(b).forEach(function(a){var c=
b[a];"string"===typeof c&&(c=encodeURIComponent(c).replace(/\'/g,"\x26apos;"),b[a]=c)});return b};d.prototype._formatAttributesToFieldInfos=function(a,b,c){var e=this;a.forEach(function(f){var d=e._getFixedFieldName(f.fieldName,b);f.fieldName=d;c[d]=e._formatValue(c[d],{fieldInfos:a,fieldName:d,layer:b})})};d.prototype._formatAttributes=function(a){var b=this,c=this._graphic,e=q.getSourceLayer(c),f=p.clone(c.attributes);this.addRelatedFeatureAttributes(f);Object.keys(f).forEach(function(a){var c=
f[a];if(null!=c){var e;(e=b._getDomainName(a,c)||b._getTypeName(a))||(e=/(\n)/gi,e="string"===typeof c?c.replace(e,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):c);f[a]=e}});a&&this._formatAttributesToFieldInfos(a,e,f);return f};d.prototype._formatValue=function(a,b){var c=b.fieldName,e=this._getFieldInfo(b.fieldInfos,c),f=p.clone(e),e=b.preventPlacesFormatting;(b=x(b.layer,c))&&"date"===b.type&&(b=f.format||new S,b.dateFormat=b.dateFormat||"short-date-short-time",f.format=b);f=f&&f.format;return"string"===
typeof a||null==a||null==f?a:e?A.formatNumber(a,w({},A.convertNumberFormatToIntlOptions(f),{minimumFractionDigits:0,maximumFractionDigits:20})):f.format(a)};d.prototype._getDomainName=function(a,b){if(this.isRelatedField(a))return null;var c=this._graphic,e=q.getSourceLayer(c);return e&&"function"===typeof e.getFieldDomain?(a=e.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null:null};d.prototype._getFieldInfo=function(a,b){if(a&&a.length&&b){var c=b.toLowerCase(),e=void 0;a.some(function(a){if(a.fieldName&&
a.fieldName.toLowerCase()===c)return e=a,!0});return e}};d.prototype._getTypeName=function(a){if(this.isRelatedField(a))return null;var b=this._graphic,c=q.getSourceLayer(b);if(!c||"function"!==typeof c.getFeatureType)return null;var e=c.typeIdField;return e&&a===e?(a=c.getFeatureType(b))?a.name:null:null};d.prototype._removeEmptyHref=function(a){return a.replace(/href=(""|'')/gi,"")};d.prototype._processFieldsInLinks=function(a,b){var c=this.get("_graphic.layer");a=this._fixTokens(a,c);var e=this._encodeAttributes(b),
c=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return a?a.replace(c,function(a,c,d){c=(""+(c||d)).trim();return v.substitute(a,c&&"{"===c[0]?b:e)}):a};d.prototype._compileAttachments=function(a,b){a=p.clone(a);if(!b||b&&0===b.length)return a;a.attachmentInfos=b;return a};d.prototype._queryAttachments=function(){var a=this._graphic,b=q.getSourceLayer(a);if(!b)return n.resolve([]);if((b="scene"===b.type&&b.associatedLayer?b.associatedLayer:b)&&"function"===typeof b.queryAttachments){var c=b.objectIdField,
e=(a=a.attributes)&&a[c],a=new T({objectIds:[e],returnMetadata:!0});return b.queryAttachments(a).then(function(a){return a[e]||[]})}return n.resolve([])};d.prototype._queryContentElements=function(a){var b=this;if(!Array.isArray(a))return n.resolve();var c={};a.forEach(function(a,f){"attachments"===a.type&&(a=b._queryAttachments())&&(c[f]=a)});return Object.keys(c).length?n.eachAlways(c):n.resolve()};d.prototype._getContent=function(){var a=this._effectivePopupTemplate,b=this._graphic,a=a&&a.content,
b="function"===typeof a?a.call(null,{graphic:b}):a;return n.isThenable(b)?b:n.resolve(b)};d.prototype._querySourceLayer=function(a,b){var c=a.layer,e=a.outFields;a=a.objectIds;var f=c.createQuery();f.objectIds=a;f.outFields=e;f.returnGeometry=!0;return c.queryFeatures(f,b).then(function(a){return a.features[0]})};d.prototype._queryRequiredFieldsFeature=function(a){var b=this,c=this._graphic,e=this._effectivePopupTemplate,f=c.sourceLayer;return f&&"function"===typeof f.queryFeatures&&e?("function"===
typeof f.load?f.load(a):n.resolve()).then(function(){var d=c.attributes[f.objectIdField];return J.safeCast(e.getRequiredFields(f.fields)).then(function(e){return P.featureHasFields(e,c)||"number"!==typeof d?null:b._querySourceLayer({layer:f,outFields:e,objectIds:[d]},a)})}):n.resolve(null)};d.prototype._queryFeature=function(a){var b=this,c=this._graphic;this._effectivePopupTemplate=c&&c.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled);return this._getContent().then(function(e){var f=b._checkForRelatedFeatures(e,
a),d=b._createFormattedExpressions().then(function(a){c.attributes=w({},c.attributes,a)}),l=b._queryContentElements(e).then(function(a){return b._contentResponse=a}),g=b._queryRequiredFieldsFeature(a).then(function(a){a&&(c.geometry=a.geometry,c.attributes=w({},c.attributes,a.attributes))});return n.eachAlways([f,d,l,g]).then(function(){b._set("formattedAttributes",b._createFormattedAttributes(e));b._set("title",b._compileTitle());var a=b._compileLastEditInfo();b._set("lastEditInfo",a||null);a=b._compileContent(e,
b._contentResponse);b._set("content",a||null);return a})})};d.prototype._isExpressionField=function(a){return D.test(a)};d.prototype._formatArcadeArray=function(a){return'\x3cul class\x3d"esri-widget__list"\x3e'+a.map(function(a){return"\x3cli\x3e"+("string"===typeof a?y(a):a)+"\x3c/li\x3e"}).join("")+"\x3c/ul\x3e"};d.prototype._formatArcadeDictionary=function(a){return'\x3ctable class\x3d"esri-widget__table"\x3e'+a.keys().map(function(b){var c=a.field(b),c="string"===typeof c?y(c):c;return"\x3ctr\x3e\x3cth\x3e"+
b+"\x3c/th\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3c/tr\x3e"}).join("")+"\x3c/table\x3e"};d.prototype._createFormattedExpressions=function(){return u(this,void 0,void 0,function(){var a,b,c,e,f,d,l,g,h,m,F,k=this;return t(this,function(r){switch(r.label){case 0:return a=this,b=a._effectivePopupTemplate,c=a._graphic,e=b&&b.expressionInfos,f=[],d={},e&&e.length?[4,V()]:[2,d];case 1:l=r.sent();g=function(a){var b="expression/"+a.name,e=l.createSyntaxTree(a.expression),h=W.filter(function(a){return l.hasVariable(e,
a)});a=l.loadScriptDependencies(e,!0,h).then(function(){return u(k,void 0,void 0,function(){var a,f,g,r,m=this;return t(this,function(k){a=this.spatialReference;f=l.getViewInfo({spatialReference:a});g=l.createExecContext(c,f);g.useAsync=!0;this._addVarsToContext(l,h,g,f);r=l.createFunction(e,g);return[2,l.executeAsyncFunction(r,g).then(function(a){d[b]="string"===typeof a?y(a):Array.isArray(a)?m._formatArcadeArray(a):a&&"esri.arcade.Dictionary"===a.declaredClass?m._formatArcadeDictionary(a):a},function(a){return z.error("arcade-execution-error",
a)})]})})});f.push(a)};h=0;for(m=e;h<m.length;h++)F=m[h],g(F);return[2,n.eachAlways(f).then(function(){return d})]}})})};d.prototype._addVarsToContext=function(a,b,c,e){var f=this.graphic,d=this.map;b.forEach(function(b){b=b.toLowerCase();var g={map:d,spatialReference:e.sr};"$map"===b&&(c.vars[b]=a.convertMapToFeatureSetCollection(g));"$layer"===b&&(c.vars[b]=a.convertFeatureLayerToFeatureSet(f.sourceLayer,e.sr));"$datastore"===b&&(c.vars[b]=a.convertServiceUrlToWorkspace(f.sourceLayer.url,e.sr))})};
d.prototype._createFormattedAttributes=function(a){var b=this,c=this._effectivePopupTemplate,e={global:this._formatAttributes(c&&c.fieldInfos),content:[]};Array.isArray(a)&&a.forEach(function(a,c){"fields"===a.type&&a.fieldInfos&&(e.content[c]=b._formatAttributes(a.fieldInfos))});return e};d.prototype._getAllFieldInfos=function(a){var b=this._effectivePopupTemplate,c=[];(b=b&&b.fieldInfos)&&c.push.apply(c,b);if(!a||!Array.isArray(a))return c;a.forEach(function(a){"fields"===a.type&&c.push.apply(c,
a&&a.fieldInfos)});return c};d.prototype._checkForRelatedFeatures=function(a,b){var c=this._graphic;a=this._getAllFieldInfos(a);return this.queryRelatedInfos(c,a,b)};d.prototype._getChartOption=function(a){var b=a.value,c=a.attributes,e=a.formattedAttributes,f=a.fieldName,d=a.relatedFieldName,g=a.fieldInfos,k=a.index;a=q.getSourceLayer(this._graphic);var h=b.normalizeField,b=b.tooltipField,h=h?this.isRelatedField(h)?c[this.getRelatedFieldInfo(h).fieldName]:c[h]:null,m=d&&void 0!==c[d]?c[d]:void 0!==
c[f]?c[f]:e[f],m=void 0===m?null:m&&h?m/h:m,k=new R({x:k,y:m});if(this.isRelatedField(f))return e=this.getRelatedFieldInfo(f),f=(f=this.getRelatedFieldInfo(b))?f.fieldName:null,g=this._formatValue(m,{fieldInfos:g,fieldName:d,layer:a,preventPlacesFormatting:!!h}),d=e?e.label||e.fieldName:d,k.tooltip=(f&&void 0!==c[f]?c[f]:d)+": "+g,k;c=this._getFieldInfo(g,f);d=this._getFixedFieldName(f,a);c=c?c.label||c.fieldName:f;k.tooltip=(b&&void 0!==e[b]?e[b]:c)+": "+e[d];return k};d.prototype._getFixedFieldName=
function(a,b){return(b=x(b,a))?b.name:a};d.prototype._getFixedFieldNames=function(a,b){var c=this;return a&&a.map(function(a){return c._getFixedFieldName(a,b)})};d.prototype._setChartValue=function(a){var b=this,c=a.value,d=a.attributes,f=a.formattedAttributes;a=a.layer;var g=this._effectivePopupTemplate,l=this.relatedInfoCount,k=c.fields,h=c.normalizeField;c.fields=this._getFixedFieldNames(k,a);h&&(c.normalizeField=this._getFixedFieldName(h,a));if(k.some(function(a){return!!(null!=f[a]||b.isRelatedField(a)&&
l)})){var m=g&&g.fieldInfos;k.forEach(function(a,e){b.isRelatedField(a)?c.series=c.series.concat(b._getRelatedChartInfos({fieldInfos:m,fieldName:a,formattedAttributes:f,value:c})):(a=b._getChartOption({value:c,index:e,attributes:d,formattedAttributes:f,fieldName:a,fieldInfos:m}),c.series.push(a))})}};d.prototype._getRelatedChartInfos=function(a){var b=this,c=a.fieldInfos,d=a.fieldName,f=a.formattedAttributes,g=a.value,k=[];a=this.getRelatedFieldInfo(d);var n=a.fieldName,h=this.getRelatedInfo(a.layerId);
if(!h)return k;a=h.relatedFeatures;h=h.relation;if(!h||!a)return k;h=h.cardinality;a.forEach(function(a,e){var h=a.attributes;h&&Object.keys(h).forEach(function(a){a===n&&k.push(b._getChartOption({value:g,index:e,attributes:h,formattedAttributes:f,fieldName:d,relatedFieldName:a,fieldInfos:c}))})});return"one-to-many"===h||"many-to-many"===h?k:[k[0]]};k([g.property()],d.prototype,"_featureAbortController",void 0);k([g.property({readOnly:!0})],d.prototype,"content",void 0);k([g.property({type:Boolean})],
d.prototype,"defaultPopupTemplateEnabled",void 0);k([g.property({readOnly:!0})],d.prototype,"formattedAttributes",void 0);k([g.property({type:I})],d.prototype,"graphic",void 0);k([g.property({readOnly:!0})],d.prototype,"lastEditInfo",void 0);k([g.property({dependsOn:["view"]})],d.prototype,"spatialReference",null);k([g.property({readOnly:!0})],d.prototype,"title",void 0);k([g.property({dependsOn:["view"]})],d.prototype,"map",null);k([g.property({readOnly:!0,dependsOn:["_featureAbortController"]})],
d.prototype,"waitingForContent",null);k([g.property()],d.prototype,"view",void 0);return d=k([g.subclass("esri.widgets.FeatureViewModel")],d)}(g.declared(U))});