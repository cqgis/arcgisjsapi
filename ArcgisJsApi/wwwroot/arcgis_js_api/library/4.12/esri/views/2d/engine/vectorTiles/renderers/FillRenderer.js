// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f32 ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f32 ../../../../../core/libs/gl-matrix-2/vec3f32 ../../../../../core/libs/gl-matrix-2/vec4f32 ../../../../webgl ../GeometryUtils ./rendererUtils".split(" "),function(I,J,C,D,y,E,F,z,r,G,H){var A=1/65536;return function(){function g(e){this._viewProjMat=E.mat4f32.create();this._offsetVector=F.vec3f32.create();
this._patternMatrix=D.mat3f32.create();this._color=z.vec4f32.create();this._outlineColor=z.vec4f32.create();this._initialized=!1;this._fillProgramOptions={id:!1,dd:!1,pattern:!1};this._outlineProgramOptions={id:!1,dd:!1};this._programCache=e}g.prototype.dispose=function(){};g.prototype.render=function(e,a,b,c,p,l,h,g,x,m,d){if(0===a.triangleElementCount)return 0;this._initialized||this._initialize(e);var t=void 0!==h.getPaintValue("fill-pattern",b),f=h.hasDataDrivenColor?[1,1,1,1]:h.getPaintValue("fill-color",
b),B=h.hasDataDrivenOpacity?1:h.getPaintValue("fill-opacity",b),n=B*f[3]*d;this._color[0]=n*f[0];this._color[1]=n*f[1];this._color[2]=n*f[2];this._color[3]=n;var f=3===p,k;f&&(k=H.int32To4Bytes(a.layerID));var n=l.tileTransform.transform,u=l.coordRange/512,q=h.getPaintValue("fill-translate",b);if(0!==q[0]||0!==q[1]){y.mat4.copy(this._viewProjMat,l.tileTransform.transform);var n=q[0],q=q[1],v=0,w=0,u=(1<<l.key.level)/Math.pow(2,b)*u;1===h.getPaintValue("fill-translate-anchor",b)?(v=-G.C_DEG_TO_RAD*
c,c=Math.sin(v),w=Math.cos(v),v=u*(n*w-q*c),w=u*(n*c+q*w)):(v=u*n,w=u*q);this._offsetVector[0]=v;this._offsetVector[1]=w;this._offsetVector[2]=0;y.mat4.translate(this._viewProjMat,this._viewProjMat,this._offsetVector);n=this._viewProjMat}g=this._drawFill(e,a,b,p,l,h,g,n,m,d,f,k);if(!(h.getPaintValue("fill-antialias",b)&&!t&&0<a.outlineElementCount)||1!==p&&3!==p)return g;p=h.hasDataDrivenOutline;if(h.outlineUsesFillColor){if(1!==this._color[3])return a.triangleElementCount/3;this._outlineColor[0]=
this._color[0];this._outlineColor[1]=this._color[1];this._outlineColor[2]=this._color[2];this._outlineColor[3]=this._color[3]}else b=h.hasDataDrivenOutlineColor?[1,1,1,1]:h.getPaintValue("fill-outline-color",b),d*=B*b[3],this._outlineColor[0]=d*b[0],this._outlineColor[1]=d*b[1],this._outlineColor[2]=d*b[2],this._outlineColor[3]=d;m=.75/m;d=this._getOutlineVAO(e,l,p);if(!d)return g;e.bindVAO(d);d=this._outlineProgramOptions;d.id=f;d.dd=p;d=this._programCache.getProgram(2,(f?1:0)<<1|(p?1:0),d);e.bindProgram(d);
d.setUniformMatrix4fv("u_transformMatrix",n);d.setUniformMatrix4fv("u_extrudeMatrix",x);d.setUniform2fv("u_normalized_origin",l.tileTransform.displayCoord);d.setUniform1f("u_depth",h.z+A);d.setUniform1f("u_outline_width",m);d.setUniform4fv("u_color",this._outlineColor);f&&d.setUniform4f("u_id",k[0],k[1],k[2],k[3]);e.drawElements(4,a.outlineElementCount,5125,12*a.outlineElementStart);e.bindVAO();return g+=a.outlineElementCount/3};g.prototype._initialize=function(e){if(this._initialized)return!0;this._fillVertexAttributes=
{geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]};this._fillVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:8,normalized:!0,divisor:0}]};this._outlineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,
type:5120,offset:6,stride:8,normalized:!1,divisor:0}]};this._outlineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:12,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:12,normalized:!0,divisor:0}]};return this._initialized=!0};g.prototype._drawFill=function(e,a,b,c,g,l,h,r,x,m,d,t){var f=
l.getPaintValue("fill-pattern",b),p=void 0!==f,n=l.hasDataDrivenOpacity?1:m*l.getPaintValue("fill-opacity",b),k=l.hasDataDrivenColor?[1,1,1,1]:l.getPaintValue("fill-color",b);m*=n*k[3];this._color[0]=m*k[0];this._color[1]=m*k[1];this._color[2]=m*k[2];this._color[3]=m;k=l.hasDataDrivenFill;if((m=p||1>m||k)&&0===c||!m&&1===c)return 0;c=this._getFillVAO(e,g,k);if(!c)return 0;e.bindVAO(c);c=this._fillProgramOptions;c.id=d;c.dd=k;c.pattern=p;c=this._programCache.getProgram(1,(d?1:0)<<2|(k?1:0)<<1|(p?1:
0),c);e.bindProgram(c);if(p){f=h.getMosaicItemPosition(f,!0);if(!f){e.bindVAO();e.bindProgram();return}b=g.coordRange/512/Math.pow(2,Math.round(b)-g.key.level)/x;C.mat3.identity(this._patternMatrix);x=1/(f.size[1]*b);this._patternMatrix[0]=1/(f.size[0]*b);this._patternMatrix[4]=x;h.bind(e,9729,f.page,5);c.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix);c.setUniform2f("u_pattern_tl",f.tl[0],f.tl[1]);c.setUniform2f("u_pattern_br",f.br[0],f.br[1]);c.setUniform1i("u_texture",5)}c.setUniformMatrix4fv("u_transformMatrix",
r);c.setUniform2fv("u_normalized_origin",g.tileTransform.displayCoord);c.setUniform1f("u_depth",l.z+A);c.setUniform4fv("u_color",this._color);d&&c.setUniform4f("u_id",t[0],t[1],t[2],t[3]);e.drawElements(4,a.triangleElementCount,5125,12*a.triangleElementStart);e.bindVAO();return a.triangleElementCount/3};g.prototype._getFillVAO=function(e,a,b){if(b){if(a.fillDDVertexArrayObject)return a.fillDDVertexArrayObject;b=a.fillDDVertexBuffer;var c=a.fillIndexBuffer;if(!b||!c)return null;a.fillDDVertexArrayObject=
new r.VertexArrayObject(e,this._programCache.getProgramAttributes(1),this._fillVertexAttributesDD,{geometry:b},c);return a.fillDDVertexArrayObject}if(a.fillVertexArrayObject)return a.fillVertexArrayObject;b=a.fillVertexBuffer;c=a.fillIndexBuffer;if(!b||!c)return null;a.fillVertexArrayObject=new r.VertexArrayObject(e,this._programCache.getProgramAttributes(1),this._fillVertexAttributes,{geometry:b},c);return a.fillVertexArrayObject};g.prototype._getOutlineVAO=function(e,a,b){if(b){if(a.outlineDDVertexArrayObject)return a.outlineDDVertexArrayObject;
b=a.outlineDDVertexBuffer;var c=a.outlineIndexBuffer;if(!b||!c)return null;a.outlineDDVertexArrayObject=new r.VertexArrayObject(e,this._programCache.getProgramAttributes(2),this._outlineVertexAttributesDD,{geometry:b},c);return a.outlineDDVertexArrayObject}if(a.outlineVertexArrayObject)return a.outlineVertexArrayObject;b=a.outlineVertexBuffer;c=a.outlineIndexBuffer;if(!b||!c)return null;a.outlineVertexArrayObject=new r.VertexArrayObject(e,this._programCache.getProgramAttributes(2),this._outlineVertexAttributes,
{geometry:b},c);return a.outlineVertexArrayObject};return g}()});