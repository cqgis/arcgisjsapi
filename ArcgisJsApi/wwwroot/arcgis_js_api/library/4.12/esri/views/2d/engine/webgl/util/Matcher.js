// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/asyncUtils ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/support/cimSymbolUtils ../../../arcade/utils".split(" "),function(g,p,D,v,l,J,z,K,F,k,G){Object.defineProperty(p,"__esModule",{value:!0});var H=z.getLogger("esri/views/2d/engine/webgl/util/Matcher");
g=function(){function e(){this._defaultResult=null}e.fromBasicRenderer=function(b,a,h){return l(this,void 0,void 0,function(){var d,c,f;return v(this,function(A){switch(A.label){case 0:return[4,k.expandSymbols(b.getSymbols(),k.constructUrlFn)];case 1:return d=A.sent(),c=new e,d.length&&(f=a.createTemplateGroup(d[0],null,b,h),c.setDefault(f)),[2,c]}})})};e.prototype.size=function(){return 1};e.prototype.getDefault=function(){return this._defaultResult};e.prototype.setDefault=function(b){this._defaultResult=
b};e.prototype.match=function(b,a,h,d,c){return this.getDefault()};e.prototype.analyze=function(b,a,h,d,c){return l(this,void 0,void 0,function(){return v(this,function(a){return[2]})})};return e}();p.FeatureMatcher=g;z=function(e){function b(a,h,d,c){var b=e.call(this)||this;b._intervals=[];b._isMaxInclusive=h;c?b._getValue=G.callWithFeature.bind(null,c):a&&a.length?"function"===typeof a?(b._field=null,b._getValue=a):(b._field=a,b._normalizationInfo=d,b._getValue=b._getValueFromField.bind(b)):b._field=
null;return b}D(b,e);b.fromCBRenderer=function(a,h,d){return l(this,void 0,void 0,function(){var c,e,A,I,w,B,x,r,m,q,t,u,E,y,C,n,g,l,p;return v(this,function(f){switch(f.label){case 0:return c=a.isMaxInclusive,e=a.normalizationField,A=a.normalizationTotal,I=a.normalizationType,w=a.field,B={normalizationField:e,normalizationTotal:A,normalizationType:I},(m=x=a.valueExpression)?[4,F.createRendererExpression(x,d.spatialReference,d.fields)]:[3,2];case 1:m=f.sent(),f.label=2;case 2:return r=m,q=new b(w,
c,B,r),[4,k.expandSymbol(a.backgroundFillSymbol,k.constructUrlFn)];case 3:t=f.sent(),u=0,E=a.classBreakInfos,f.label=4;case 4:if(!(u<E.length))return[3,7];y=E[u];return[4,k.expandSymbol(y.symbol,k.constructUrlFn)];case 5:C=f.sent(),n=h.createTemplateGroup(C,t,a,d),g={min:y.minValue,max:y.maxValue},q.add(g,n),f.label=6;case 6:return u++,[3,4];case 7:return[4,k.expandSymbol(a.defaultSymbol,k.constructUrlFn)];case 8:if(l=f.sent())p=h.createTemplateGroup(l,t,a,d),q.setDefault(p);return[2,q]}})})};b.prototype.add=
function(a,b){this._intervals.push({interval:a,result:b});this._intervals.sort(function(a,c){return a.interval.min-c.interval.min})};b.prototype.size=function(){return e.prototype.size.call(this)+this._intervals.length};b.prototype.match=function(a,b,d,c,f){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:f},d,c);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(b=0;b<this._intervals.length;b++)if(c=this._intervals[b],d=c.interval,c=c.result,f=this._isMaxInclusive?
a<=d.max:a<d.max,a>=d.min&&f)return c;return this.getDefault()};b.prototype._needsNormalization=function(){var a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};b.prototype._getValueFromField=function(a){var b=a.attributes[this._field];if(!this._needsNormalization())return b;var d=this._normalizationInfo,c=d.normalizationField,f=d.normalizationTotal,d=d.normalizationType;a=!!c&&a.attributes[c];if(d)switch(d){case "field":return(a||void 0)&&b/a;
case "log":return Math.log(b)*Math.LOG10E;case "percent-of-total":return b/f*100;default:H.error("Found unknown normalization type: "+d)}else H.error("Normalization is required, but no type was set!")};return b}(g);p.IntervalMatcher=z;z=function(e){function b(a,b,d){var c=e.call(this)||this;c._resultsMap=new Map;d?c._getValue=G.callWithFeature.bind(null,d):a&&a.length?"function"===typeof a[0]?(c._fields=null,c._getValue=a[0]):(c._fields=a,c._seperator=b||"",c._getValue=c._getValueFromFields.bind(c)):
c._fields=null;return c}D(b,e);b.fromUVRenderer=function(a,h,d){return l(this,void 0,void 0,function(){var c,f,e,g,w,B,x,r,m,q,t,u,l,y,C;return v(this,function(n){switch(n.label){case 0:return c=a.uniqueValueInfos,f=a.fieldDelimiter,e=[a.field],g=a.valueExpression,a.field2&&e.push(a.field2),a.field3&&e.push(a.field3),[4,k.expandSymbol(a.backgroundFillSymbol,k.constructUrlFn)];case 1:return w=n.sent(),(x=g)?[4,F.createRendererExpression(g,d.spatialReference,d.fields)]:[3,3];case 2:x=n.sent(),n.label=
3;case 3:B=x,r=new b(e,f,B),m=0,q=c,n.label=4;case 4:if(!(m<q.length))return[3,7];t=q[m];return[4,k.expandSymbol(t.symbol,k.constructUrlFn)];case 5:u=n.sent(),l=h.createTemplateGroup(u,w,a,d),r.add(t.value,l),n.label=6;case 6:return m++,[3,4];case 7:return[4,k.expandSymbol(a.defaultSymbol,k.constructUrlFn)];case 8:if(y=n.sent())C=h.createTemplateGroup(a.defaultSymbol,w,a,d),r.setDefault(C);return[2,r]}})})};b.prototype.add=function(a,b){this._resultsMap.set(a.toString(),b)};b.prototype.size=function(){return e.prototype.size.call(this)+
this._resultsMap.size};b.prototype.match=function(a,b,d,c,e){if(!this._getValue)return this.getDefault();a=this._getValue(b,{$view:e},d,c);if(!a&&(null===a||void 0===a))return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};b.prototype._getValueFromFields=function(a){for(var b=[],d=0,c=this._fields;d<c.length;d++)b.push(a.attributes[c[d]]);return b.join(this._seperator)};return b}(g);p.MapMatcher=z;g=function(e){function b(a,b,d){var c=e.call(this)||
this;c._fidToAttributeHash=new Map;c._attributeHashToGroup=new Map;c._renderer=a;c._fieldMap=a.fieldMap;c._templates=b;c._info=d;return c}D(b,e);b.fromDictionaryRenderer=function(a,e,d){return l(this,void 0,void 0,function(){return v(this,function(c){a.fetchResources();return[2,new b(a,e,d)]})})};b.prototype.analyze=function(a,b,d,c,e){return l(this,void 0,void 0,function(){var c,d,f,h,g,k,m=this;return v(this,function(l){switch(l.label){case 0:c=[];d=function(b){var d=b.attributes[a],h=f._fidToAttributeHash.get(d),
g=f._hashAttributes(b);if(h===g)return"continue";f._fidToAttributeHash.set(d,g);f._attributeHashToGroup.has(g)||(b=J.safeCast(f._renderer.fetchSymbol(b,e)).then(function(a){a=m._templates.createTemplateGroup(a,null,m._renderer,m._info);m._attributeHashToGroup.set(g,a)}),c.push(b))};f=this;h=0;for(g=b;h<g.length;h++)k=g[h],d(k);return[4,K.all(c)];case 1:return l.sent(),[2]}})})};b.prototype.match=function(a,b,d,c,e){a=this._fidToAttributeHash.get(b.attributes[a]);return this._attributeHashToGroup.get(a)};
b.prototype._hashAttributes=function(a){var b="",d;for(d in this._fieldMap)b+=". "+a.attributes[this._fieldMap[d]];return b};return b}(g);p.DictionaryMatcher=g});