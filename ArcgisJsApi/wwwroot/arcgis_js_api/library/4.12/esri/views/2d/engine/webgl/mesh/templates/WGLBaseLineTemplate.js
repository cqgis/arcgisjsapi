// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/has ../../../../../../core/Logger ../../definitions ../../enums ../../number ../../TileClipper ../../TurboLine ../../WGLDisplayRecord ../../materialKey/MaterialKey".split(" "),function(E,m,x,F,y,t,z,c,A,u,B,C){Object.defineProperty(m,"__esModule",{value:!0});var D=y.getLogger("esri.views.2d.engine.webgl.WGLLineTemplateBase"),q=t.TILE_SIZE+8,w=1/3.8,n=new A.TileClipper(0,0,0,1,8);n.setExtent(t.TILE_SIZE);
var e=new Uint32Array(9),a=new Uint32Array(36),r=new Uint32Array(3),l=new Uint32Array(6);m.default=function(m){return function(m){function g(){for(var b=[],f=0;f<arguments.length;f++)b[f]=arguments[f];b=m.apply(this,b)||this;b._tessellationOptions={};b.geometryType=z.WGLGeometryType.LINE;return b}x(g,m);g.prototype.writeMesh=function(b,f,d,a,c){var v=f.indexVector,k=f.get("geometry"),h=new B(a,this.geometryType,this._materialKey);f=f.getVector("geometry").vertexCount;h.vertexFrom=f;h.indexFrom=v.length;
switch(d){case "esriGeometryPolyline":d=this._clipLines(c.geometry.paths);if(0===d.length)break;this._write(h,v,k,f,a,d);b.push(h);break;case "esriGeometryPolygon":d=this._clipLines(c.geometry.rings);if(0===d.length)break;this._write(h,v,k,f,a,d);b.push(h);break;default:D.error("Unable to handle geometryType: "+d)}};g.prototype._clipLines=function(b){for(var a=[],d=!1,c=0;c<b.length;){var p=[],e=b[c];n.reset(2);var k=e[0],h=k[0],k=k[1];if(d)n.moveTo(h,k);else{if(-8>h||h>q||-8>k||k>q){d=!0;continue}p.push({x:h,
y:k})}for(var g=!1,m=e.length,l=1;l<m;++l)if(h+=e[l][0],k+=e[l][1],d)n.lineTo(h,k);else{if(-8>h||h>q||-8>k||k>q){g=!0;break}p.push({x:h,y:k})}if(g)d=!0;else{if(d){if(p=n.resultWithStarts())for(d=0;d<p.length;d++)a.push(p[d])}else a.push({line:p,start:0});c++;d=!1}}return a};g.prototype._write=function(b,a,d,c,e,g){this.id=e;this.indexBuf=a;this.indexCount=0;this.geometryBuf=d;this.vertexCount=0;this.offset=c;for(a=0;a<g.length;a++)d=g[a],c=d.line,2>c.length||(this._tessellationOptions.initialDistance=
d.start%65535,this._tessellationCallbacks instanceof u.StandardTessellationCallbacks&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),u.tessellate(c,this._tessellationOptions,this._tessellationCallbacks));b.vertexCount=this.vertexCount;b.indexCount=this.indexCount;b.zOrder=this._zOrder};g.prototype._initializeTessellator=function(b){var a=C.LineMaterialKey.load(this._materialKey);this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern;
this._tessellationOptions.thin=!b&&this._halfWidth<t.THIN_LINE_THRESHOLD/2&&!(a.vvSizeFieldStops||a.vvSizeMinMaxValue||a.vvSizeScaleStops||a.vvSizeUnitValue);this._tessellationOptions.wrapDistance=65535;this._tessellationOptions.outerBisectorAutoSplitThreshold=w;this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern;this._tessellationOptions.innerBisectorAutoSplitThreshold=w;this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern;this._tessellationOptions.thin?
this._tessellationCallbacks={vertex:this._thinVertex.bind(this),bridge:this._thinBridge.bind(this)}:(b=new u.StandardTessellationCallbacks(this._thickWriteVertex.bind(this),this._thickWriteTriangle.bind(this)),b.miterLimitCosine=this._miterLimitCosine,b.textured=this._isDashed||this._hasPattern,this._tessellationCallbacks=b)};g.prototype._thinVertex=function(b){b.entry0=this.offset+this.vertexCount++;var f=c.i1616to32(b.distance,31*this._halfWidth),d=c.i8888to32(Math.round(31*b.prevNormal.x),Math.round(31*
b.prevNormal.y),Math.round(0),Math.round(-31)),e=c.i8888to32(0,0,0,this._bitset);a[0]=c.i1616to32(b.currentVertex.x,b.currentVertex.y);a[1]=this.id;a[2]=this._fillColor;a[3]=d;a[4]=f;a[5]=this._tl;a[6]=this._br;a[7]=e;a[8]=c.i1616to32(31*this._halfReferenceWidth,0);b.entry2=this.offset+this.vertexCount++;f=c.i1616to32(b.distance,31*this._halfWidth);d=c.i8888to32(Math.round(31*-b.prevNormal.x),Math.round(31*-b.prevNormal.y),Math.round(0),Math.round(31));e=c.i8888to32(0,0,0,this._bitset);a[9]=c.i1616to32(b.currentVertex.x,
b.currentVertex.y);a[10]=this.id;a[11]=this._fillColor;a[12]=d;a[13]=f;a[14]=this._tl;a[15]=this._br;a[16]=e;a[17]=c.i1616to32(31*this._halfReferenceWidth,0);b.exit0=this.offset+this.vertexCount++;f=c.i1616to32(b.distance,31*this._halfWidth);d=c.i8888to32(Math.round(31*b.nextNormal.x),Math.round(31*b.nextNormal.y),Math.round(0),Math.round(-31));e=c.i8888to32(0,0,0,this._bitset);a[18]=c.i1616to32(b.currentVertex.x,b.currentVertex.y);a[19]=this.id;a[20]=this._fillColor;a[21]=d;a[22]=f;a[23]=this._tl;
a[24]=this._br;a[25]=e;a[26]=c.i1616to32(31*this._halfReferenceWidth,0);b.exit2=this.offset+this.vertexCount++;f=c.i1616to32(b.distance,31*this._halfWidth);d=c.i8888to32(Math.round(31*-b.nextNormal.x),Math.round(31*-b.nextNormal.y),Math.round(0),Math.round(31));e=c.i8888to32(0,0,0,this._bitset);a[27]=c.i1616to32(b.currentVertex.x,b.currentVertex.y);a[28]=this.id;a[29]=this._fillColor;a[30]=d;a[31]=f;a[32]=this._tl;a[33]=this._br;a[34]=e;a[35]=c.i1616to32(31*this._halfReferenceWidth,0);this.geometryBuf.writeRegion(a)};
g.prototype._thinBridge=function(b){l[0]=b.leftExit0;l[1]=b.rightEntry0;l[2]=b.leftExit2;l[3]=b.rightEntry0;l[4]=b.rightEntry2;l[5]=b.leftExit2;this.indexCount+=6;this.indexBuf.writeRegion(l)};g.prototype._thickWriteVertex=function(b,a,d,g,l,m,k,h,n){n=c.i1616to32(n,31*this._halfWidth);l=c.i8888to32(Math.round(31*l),Math.round(31*m),Math.round(31*k),Math.round(31*h));d=c.i8888to32(31*d,31*g,0,this._bitset);e[0]=c.i1616to32(b,a);e[1]=this.id;e[2]=this._fillColor;e[3]=l;e[4]=n;e[5]=this._tl;e[6]=this._br;
e[7]=d;e[8]=c.i1616to32(31*this._halfReferenceWidth,0);this.geometryBuf.writeRegion(e);return this.offset+this.vertexCount++};g.prototype._thickWriteTriangle=function(a,c,d){r[0]=a;r[1]=c;r[2]=d;this.indexCount+=3;this.indexBuf.writeRegion(r)};return g}(m)}});