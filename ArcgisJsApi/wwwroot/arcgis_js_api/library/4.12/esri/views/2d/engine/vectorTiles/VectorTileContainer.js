// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/has ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../webgl ../../engine ./GeometryUtils ./renderers/Renderer".split(" "),function(y,z,t,p,u,m,v,n,A,q,w,x){var r=q.enums.WGLDrawPhase;return function(l){function h(){var a=null!==l&&l.apply(this,arguments)||this;a._tileCoordinateScale=n.vec3f32.create();a._orientationVec=
n.vec3f32.fromValues(0,0,1);a._displayScale=n.vec3f32.create();a._defaultTransform=v.mat4f32.create();a._displayWidth=0;a._displayHeight=0;a._pointToCallbacks=new Map;return a}t(h,l);h.prototype.initialize=function(a,k,b,d){var f=this;this._spriteMosaicPromise=a;this._spriteMosaicPromise.then(function(b){f._spriteMosaicPromise===a&&(f._renderer=new x(b,k))});this._tileInfoView=d;this._tileInfo=b};h.prototype.dispose=function(){this._renderer&&this._renderer.dispose();l.prototype.dispose.call(this)};
h.prototype.hitTest=function(a,k){var b=this,d=[a,k];return u.create(function(a,c){b._pointToCallbacks.set(d,{resolve:a,reject:c});b.requestRender()},function(){b._pointToCallbacks.has(d)&&b._pointToCallbacks.delete(d)})};h.prototype.renderChildren=function(a){var k=this;if(0!==this.children.length&&this._tileInfoView&&a&&a.state&&(a.drawPhase===r.MAP||a.drawPhase===r.HITTEST))if(this._renderer){if(p("esri-vector-tiles-debug"))for(var b=0,d=this.children;b<d.length;b++){var f=d[b];f.triangleCount=
0}d=a.state;b=this.stage.context;f=this._renderer;f.initializeProgramCache(this.stage.context);f.setGlobalOpacity(b,a,this.opacity);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearDepth(1);b.setClearStencil(0);b.clear(b.gl.DEPTH_BUFFER_BIT|b.gl.STENCIL_BUFFER_BIT);b.setDepthWriteEnabled(!1);a.displayLevel=this._tileInfoView.scaleToLevel(d.scale);a.requiredLevel=this._tileInfoView.getSmallestInfoForScale(d.scale).level;a.renderer=this._renderer;this.sortChildren(function(a,b){return a.key.level-
b.key.level});for(var d=this.children.length,c=1;c<=d;c++){var g=this.children[c-1];g.attached&&g.visible&&(g.stencilData.reference=c,g.stencilData.mask=255)}this._updateTilesTransform(a.state,a.requiredLevel,this.children);b.setDepthWriteEnabled(!0);this._renderer.setStateParams(a.state,a.pixelRatio,a.displayLevel);this._renderer.drawClippingMasks(b,this.children);b.setStencilWriteMask(0);b.setBlendFunctionSeparate(1,771,1,771);b.setStencilOp(7680,7680,7681);b.setDepthFunction(515);b.setBlendingEnabled(!1);
b.setStencilTestEnabled(!0);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);a.drawphase=0;l.prototype.renderChildren.call(this,a);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(!0);a.drawphase=1;l.prototype.renderChildren.call(this,a);a.drawphase=2;l.prototype.renderChildren.call(this,a);b.setStencilTestEnabled(!1);b.setDepthTestEnabled(!1);f.applyGlobalOpacity(b,a,this.opacity);if(p("esri-vector-tiles-debug"))for(d=0,c=this.children;d<c.length;d++)f=c[d],f.attached&&f.visible&&this._renderer.renderTileInfo(b,
f);0<this._pointToCallbacks.size&&(this._pointToCallbacks.forEach(function(b,c){b.resolve(k._hitTest(a,c[0],c[1]))}),this._pointToCallbacks.clear());this._renderer.needsRedraw()&&this.requestRender()}else this.requestRender()};h.prototype.removeAllChildren=function(){for(var a=0;a<this.children.length;a++)this.children[a].dispose();l.prototype.removeAllChildren.call(this)};h.prototype._hitTest=function(a,k,b){var d=this._tileInfoView.getSmallestInfoForScale(a.state.scale).level,f=[0,0];a.state.toMap(f,
[k,b]);var c=a.state.clone(),g=c.viewpoint.clone(),e=g.targetGeometry;e.x=f[0];e.y=f[1];g.targetGeometry=e;c.viewpoint=g;c.size=[3,3];this._renderer.setStateParams(c,a.pixelRatio,a.displayLevel);return(a=this._renderer.hitTest({context:this.stage.context,drawPhase:0,pixelRatio:a.pixelRatio,stationary:a.stationary,globalOpacity:a.globalOpacity,displayLevel:a.displayLevel,requiredLevel:a.requiredLevel,renderer:a.renderer,layerOpacity:a.layerOpacity,state:c,drawphase:3},k,b,this.children,d,3,this._updateTilesTransform.bind(this)))&&
0!==a.length?a[0]:null};h.prototype._updateTilesTransform=function(a,k,b){var d=1/a.size[0],f=1/a.size[1],c=[0,0];this._calculateRelativeViewProjMat(this._tileInfo.lodAt(k).resolution,a.resolution,a.rotation,this._tileInfo.size[1],4096,a.size[0],a.size[1],this._defaultTransform);for(var g=0;g<b.length;g++){var e=b[g];a.toScreen(c,e.coords);c[1]=a.size[1]-c[1];e.tileTransform.displayCoord[0]=2*c[0]*d-1;e.tileTransform.displayCoord[1]=2*c[1]*f-1;e.key.level===k&&4096===e.coordRange?e.tileTransform.transform.set(this._defaultTransform):
this._calculateRelativeViewProjMat(this._tileInfo.lodAt(e.key.level).resolution,a.resolution,a.rotation,this._tileInfo.size[1],e.coordRange,a.size[0],a.size[1],e.tileTransform.transform)}};h.prototype._calculateRelativeViewProjMat=function(a,k,b,d,f,c,g,e){var h=.125;512!==d&&4096!==f&&(h=d/f);a=a/k*h;this._tileCoordinateScale.set([a,a,1]);if(c!==this._displayWidth||g!==this._displayHeight)this._displayScale.set([2/c,-2/g,1]),this._displayWidth=c,this._displayHeight=g;m.mat4.identity(e);m.mat4.scale(e,
e,this._tileCoordinateScale);m.mat4.rotate(e,e,-b*w.C_DEG_TO_RAD,this._orientationVec);m.mat4.scale(e,e,this._displayScale);m.mat4.transpose(e,e)};return h}(q.Container)});