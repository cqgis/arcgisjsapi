// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../geometry/support/spatialReferenceUtils ../../../webgl ./RenderBucket ../../tiling/TileKey".split(" "),function(y,z,A,t,u,v,g,n,w){var x="fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer".split(" ");
return function(){function l(){for(var a,c=[],d=0;d<arguments.length;d++)c[d]=arguments[d];this._renderBuckets=[];this._symbolUpdateData=this._vectorTileData=null;this.coords=[0,0];this.bounds=[0,0,0,0];this.tileTransform={transform:t.mat4f32.create(),displayCoord:u.vec2f32.create()};this.stencilData={mask:0,reference:0};this.triangleCount=0;0<c.length&&(a=this.acquire).call.apply(a,[this].concat(c))}l.prototype.reset=function(){w.pool.release(this.key);this.key=null;this.coords[0]=0;this.coords[1]=
0;this.bounds[0]=0;this.bounds[1]=0;this.bounds[2]=0;this.bounds[3]=0;this.resolution=null;this.rotation=0;this.id=this.client=this.styleLayers=this._vectorTileData=null;this.tileTransform.transform.fill(0);this.tileTransform.displayCoord.fill(0);this.stencilData.mask=0;this.stencilData.reference=0;this._renderBuckets.length=0;this.context=this._symbolUpdateData=null;this.triangleCount=0;this.refKeys=null};l.prototype.acquire=function(a,c,d,e){this.key=a;var b=c.lodAt(a.level),b=null!==b?b.resolution:
0,h=c.size[0]*b,f=c.origin,p=a.col*h,m=a.row*h,k=c.spatialReference,g=0;k&&(k._isWrappable?k._isWrappable():k.isWrappable)&&(k=v.getInfo(k),g=k.valid[1]-k.valid[0]);p=f.x+p+a.world*g;f=f.y-m;this.coords[0]=p;this.coords[1]=f;this.bounds[0]=p;this.bounds[1]=f;this.bounds[2]=p+h;this.bounds[3]=f-h;this.widthInPixels=c.size[1];this.coordRange=4096;this.resolution=b;this.rotation=e;this.styleLayers=d;this.id=a.id};l.prototype.setData=function(a,c,d){this._vectorTileData=a;this.client=c;this.refKeys=d};
l.prototype.dispose=function(){for(var a="fillVertexArrayObject fillDDVertexArrayObject outlineVertexArrayObject lineVertexArrayObject lineDDVertexArrayObject iconVertexArrayObject iconDDVertexArrayObject textVertexArrayObject textDDVertexArrayObject circleVertexArrayObject fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer texture".split(" "),
c=0;c<a.length;++c){var d=a[c];this[d]&&(this[d].dispose(),this[d]=null)}this._renderBuckets.length=0};l.prototype.getCpuMemoryUsage=function(){return null!=this._vectorTileData&&this._vectorTileData.bufferData?this._vectorTileData.bufferData.reduce(function(a,c){return a+c.byteLength},0)+this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength:0};l.prototype.getGpuMemoryUsage=function(){var a=this,c=x.reduce(function(c,e){return a[e]?c+a[e].size:c},0);this.texture&&
(c+=this.texture.descriptor.width*this.texture.descriptor.height*4);return c};l.prototype.attachWithContext=function(a){this.context=a};l.prototype._commitChanges=function(){this._vectorTileData&&(this.dispose(),this._createRenderBuckets(),this._createBufferObjects(),this._vectorTileData=null)};l.prototype._createRenderBuckets=function(){for(var a=new Uint32Array(this._vectorTileData.bucketDataInfo),c=a.length,d=0;d<c;){var e=a[d];switch(a[d+1]){case 0:var b=new n.BackgroundRenderBucket;b.layerID=
e;this._renderBuckets.push(b);d+=2;break;case 1:b=new n.FillRenderBucket;b.layerID=e;b.triangleElementStart=a[d+2];b.triangleElementCount=a[d+3];b.outlineElementStart=a[d+4];b.outlineElementCount=a[d+5];this._renderBuckets.push(b);d+=6;break;case 2:b=new n.LineRenderBucket;b.layerID=e;b.triangleElementStart=a[d+2];b.triangleElementCount=a[d+3];this._renderBuckets.push(b);d+=4;break;case 3:b=new n.SymbolRenderBucket;b.layerID=e;b.isSDF=0!==a[d+2];var h=d+3,e=a[h];h++;if(0<e)for(var f=void 0,g=void 0,
m=void 0,k=0;k<e;k++)f=a[h],g=a[h+1],m=a[h+2],b.markerPerPageElementsMap.set(f,[g,m]),h+=3;var l=a[h];h++;if(0<l)for(m=g=f=void 0,k=0;k<l;k++)f=a[h],g=a[h+1],m=a[h+2],b.glyphPerPageElementsMap.set(f,[g,m]),h+=3;this._renderBuckets.push(b);d+=5+3*e+3*l;break;case 4:b=new n.CircleRenderBucket;b.layerID=e;b.triangleElementStart=a[d+2];b.triangleElementCount=a[d+3];this._renderBuckets.push(b);d+=4;break;default:console.error("Bad bucket type!"),d+=2}}};l._createBufferToObject=function(){var a=[];a[1]=
{create:g.BufferObject.createVertex,var:"fillVertexBuffer"};a[2]={create:g.BufferObject.createVertex,var:"fillDDVertexBuffer"};a[3]={create:g.BufferObject.createIndex,var:"fillIndexBuffer"};a[4]={create:g.BufferObject.createVertex,var:"outlineVertexBuffer"};a[5]={create:g.BufferObject.createVertex,var:"outlineDDVertexBuffer"};a[6]={create:g.BufferObject.createIndex,var:"outlineIndexBuffer"};a[7]={create:g.BufferObject.createVertex,var:"lineVertexBuffer"};a[8]={create:g.BufferObject.createVertex,var:"lineDDVertexBuffer"};
a[9]={create:g.BufferObject.createIndex,var:"lineIndexBuffer"};a[10]={create:g.BufferObject.createVertex,var:"iconVertexBuffer"};a[11]={create:g.BufferObject.createVertex,var:"iconDDVertexBuffer"};a[12]={create:g.BufferObject.createIndex,var:"iconIndexBuffer"};a[13]={create:g.BufferObject.createVertex,var:"textVertexBuffer"};a[14]={create:g.BufferObject.createVertex,var:"textDDVertexBuffer"};a[15]={create:g.BufferObject.createIndex,var:"textIndexBuffer"};a[16]={create:g.BufferObject.createVertex,
var:"circleVertexBuffer"};a[17]={create:g.BufferObject.createIndex,var:"circleIndexBuffer"};return a};l.prototype._createBufferObjects=function(){for(var a=this.context,c=new Uint32Array(this._vectorTileData.bufferDataInfo),d=c.length,e=0,b=0;b<d;b+=2,e++){var h=c[b];if(!(0>=c[b+1]||0===this._vectorTileData.bufferData[e].byteLength)){var f=l.bufferToObject[h];f?this[f.var]?this[f.var].setData(this._vectorTileData.bufferData[e]):this[f.var]=f.create(a,35044,this._vectorTileData.bufferData[e]):console.error("Bad buffer type "+
h)}}};l.prototype.render=function(a){var c=this.context,d=a.renderer;if(c&&d){this._commitChanges();var e=a.drawphase;this._symbolUpdateData&&(this._updateSymbolData(a,this._symbolUpdateData),this._symbolUpdateData=null);c.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var b=this.styleLayers,h,f=void 0!==a.layerOpacity?a.layerOpacity:1;if(0!==f){var g=this._renderBuckets.length;if(0===e)for(var m=g-1;0<=m;m--){var k=this._renderBuckets[m];h=b.layers[k.layerID];if(!k||!h)break;
1!==k.type&&0!==k.type||!k.hasData()||(this.triangleCount+=d.renderBucket(c,k,a.displayLevel,a.requiredLevel,e,this,h,f))}else for(m=0;m<g;m++){k=this._renderBuckets[m];h=b.layers[k.layerID];if(!k||!h)break;k.hasData()&&(this.triangleCount+=d.renderBucket(c,k,a.displayLevel,a.requiredLevel,e,this,h,f))}}}};l.prototype._updateSymbolData=function(a,c){if(!c||!c.bucketDataInfo)return!0;a=new Uint32Array(c.bucketDataInfo);var d=a.length;if(0===d)return!0;if(this.context){for(var e=this.context,b=new Uint32Array(c.bufferDataInfo),
h=b.length,f=0,l=0;l<h;l+=2,f++)switch(b[l]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconVertexBuffer=g.BufferObject.createVertex(e,35044,c.bufferData[f]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconDDVertexBuffer=g.BufferObject.createVertex(e,35044,c.bufferData[f]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.iconIndexBuffer=
g.BufferObject.createIndex(e,35044,c.bufferData[f]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null);this.textVertexBuffer=g.BufferObject.createVertex(e,35044,c.bufferData[f]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null);this.textDDVertexBuffer=g.BufferObject.createVertex(e,35044,c.bufferData[f]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),
this.textIndexBuffer=g.BufferObject.createIndex(e,35044,c.bufferData[f])}c=[];for(e=0;e<this._renderBuckets.length;e++)this._renderBuckets[e]instanceof n.SymbolRenderBucket||c.push(this._renderBuckets[e]);this._renderBuckets=c;for(e=0;e<d;){h=a[e];b=new n.SymbolRenderBucket;b.layerID=h;b.isSDF=0!==a[e+2];this.styleLayers.layers.length>b.layerID&&this.styleLayers.layers[b.layerID].type===b.type&&c.push(b);var m=e+3,h=a[m];m++;if(0<h)for(var k=l=f=void 0,q=0;q<h;q++)f=a[m],l=a[m+1],k=a[m+2],b.markerPerPageElementsMap.set(f,
[l,k]),m+=3;var r=a[m];m++;if(0<r)for(k=l=f=void 0,q=0;q<r;q++)f=a[m],l=a[m+1],k=a[m+2],b.glyphPerPageElementsMap.set(f,[l,k]),m+=3;e+=5+3*h+3*r}this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),
this.textDDVertexArrayObject=null);return!0}};l.bufferToObject=l._createBufferToObject();return l}()});