// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/array @dojo/framework/shim/iterator @dojo/framework/shim/Map ../../../../../core/mathUtils ../definitions ./CollisionBucket ./LayerCollisionInfo ../../../support/mathUtils".split(" "),function(w,x,A,B,y,C,m,D,n,z){Object.defineProperty(x,"__esModule",{value:!0});var p=m.TILE_SIZE/m.COLLISION_BUCKET_SIZE;w=function(){function d(a){this._layers=new y.default;this._collisionBuckets=new y.default;this._tilingScheme=a}Object.defineProperty(d.prototype,"collisionInfos",
{get:function(){var a=[];B.forOf(this._layers.values(),function(b){return a.push(b)});return a},enumerable:!0,configurable:!0});d.prototype.registerLayerView=function(a,b){if(!this._layers.has(a)){var c=n.default.create(a,b,this.collisionInfos,this._tilingScheme);this._layers.set(a,c);this._collisionBuckets.forEach(function(a){return a.onRegisterLayer(c.index)})}};d.prototype.unregisterLayerView=function(a){var b=this;if(this._layers.has(a)){var c=this._layers.get(a);n.default.delete(c.index,this.collisionInfos);
this._layers.delete(a);this._collisionBuckets.forEach(function(a,g){var e=a.getTile(c.index);e&&(a.onUnregisterLayer(c.index),a.canDelete()&&b._collisionBuckets.delete(g),e.reference&&(e.reference.isDirty=!1))})}};d.prototype.addTile=function(a,b){var c=b.key.id;this._layers.has(a)&&(this._collisionBuckets.has(c)||this._collisionBuckets.set(c,new D.default(b.key,this._layers.size)),this._collisionBuckets.get(c).getTile(this._getIndex(a)).reference=b)};d.prototype.removeTile=function(a,b){this._layers.has(a)&&
this._collisionBuckets.has(b)&&(a=this._collisionBuckets.get(b).getTile(this._getIndex(a)),a.dirty=!1,a.reference=null)};d.prototype.run=function(a,b){for(var c=A.from(this._collisionBuckets.values()).filter(function(a){return a.key.level===b}).sort(function(a,b){return a.key.compareRowMajor(b.key)}),e=this._checkRotation(a.rotation),g=0;g<c.length;g++)for(var h=c[g],e=e||h.isDirty,d=0;d<this._layers.size;d++){var f=n.default.find(d,this.collisionInfos);h.computeNeighbors(this._collisionBuckets);
h.reset(a,e,f)}for(a=0;a<this._layers.size;a++)for(f=n.default.find(a,this.collisionInfos),e=0,g=c;e<g.length;e++)h=g[e],this._run(h,f,b);for(f=0;f<c.length;f++)h=c[f],h.ready()};d.prototype._run=function(a,b,c){var e=a.getReference(b.index);e&&e.isDirty&&e.hasData&&this._runVisibility(a,e,b,c)};d.prototype._checkLabelsVisible=function(a,b){var c=!b.effect||b.effect.excludedLabelsVisible||!!(a&m.EFFECT_FLAG_0);return(!b.filter||!!(a&m.FILTER_FLAG_0))&&c};d.prototype._runVisibility=function(a,b,c,
e){for(var d=c.layerView.tileRenderer.featuresView.attributeView,h=0,r=b.displayObjects;h<r.length;h++){var f=r[h];if(f.metrics.length){for(var q=0,l=d.getFilterFlags(f.id),k=this._checkLabelsVisible(l,c.layerView),m=0;m<f.metrics.length;m++)l=f.metrics[m],l=k?this._computeLabelVisibility(f,l,c.index,a,b,l.baseZoom,e):255,q=Math.max(l,q);d.setLabelMinZoom(f.id,q);k=0;for(f=f.metrics;k<f.length;k++)l=f[k],l.minZoom=q}}};d.prototype._computeLabelVisibility=function(a,b,c,e,d,h,m){for(var f=b.xBucket,
g=b.yBucket,l=b.xOverflow,k=b.yOverflow,r=f-l,f=f+l+1,l=g+k+1,g=g-k;g<l;g++)for(k=r;k<f;k++)if(!(k<-p||g<-p||k>p||g>p))for(var n=0;n<=c;n++){var u=this._getRelativeSubBucket(n,e,d,k,g);if(u)for(var v=0;v<u.length;v++){var t=u[v];t.id!==a.id&&(t=this._compareLabels(b,t,h,m),h=Math.max(t,h))}}return h};d.prototype._compareLabels=function(a,b,c,e){var d=10*(e+m.COLLISION_MAX_ZOOM_DELTA);if(-1===b.minZoom||b.minZoom>d||b.minZoom>Math.floor(10*e))return c;a=a.findCollisionDelta(b);e=C.clamp(Math.floor(10*
(a+e)),0,255);return b.minZoom>=e?c:Math.max(c,e)};d.prototype._getNeighboringTile=function(a,b,c,e,d){return(b=b.neighbors[3*(1+d)+(1+e)])&&b.getTile(a)};d.prototype._getRelativeSubBucket=function(a,b,c,e,d){var h=z.sign(Math.floor(e/4)),g=z.sign(Math.floor(d/4));return(a=this._getNeighboringTile(a,b,c,h,g))&&a.reference&&a.index&&a.reference.hasData?a.index[d-4*g][e-4*h]:null};d.prototype._checkRotation=function(a){if(!this._lastRotation)return this._lastRotation=a,!1;var b=a!==this._lastRotation;
this._lastRotation=a;return b};d.prototype._getIndex=function(a){return this._layers.get(a).index};return d}();x.CollisionEngine=w});