// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../request ../../../../core/asyncUtils ../../../../core/has ../../../../core/ItemCache ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../core/requireUtils ../../../../core/workers ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ./VectorTileDisplayObject ../../tiling/TileKey module @dojo/framework/shim/Promise".split(" "),
function(u,L,r,n,l,v,A,B,C,m,D,E,F,w,G,H,I,x,J,p,K){var y=new C(10),q=new Map;return function(){function f(a,g,e,b){this.devicePixelRatio=g;this.allowUpdates=e;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._updateToAbortController=new Map;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map;this._vectorTileLayer=a;this._container=b}f.prototype.destroy=function(){this._updateToAbortController&&this._updateToAbortController.forEach(function(a){return a.abort()});
this._ongoingTileRequests&&this.abortAll();this._connection&&(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(f.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,
"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});f.prototype.start=function(a){return l(this,void 0,void 0,function(){var g,e,b,c,d,h=this;return n(this,function(k){g=this._vectorTileLayer.sourceNameToSource;e=[];for(b in g)e.push(this._fetchTileMap(g[b],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){h._spriteMosaic=new I(1024,1024,250);h._spriteMosaic.setSpriteSource(a)});
c=this._vectorTileLayer.styleRepository;d=new H(c.glyphs);this._glyphMosaic=new G(1024,1024,d);this._broadcastPromise=A.safeCast(F.open(E.getAbsMid("./WorkerTileHandler",u,K),{client:this,signal:a&&a.signal})).then(function(b){h._connection=b;return m.all(h._connection.broadcast("setLayers",c.styleJSON,r({},a)))});return[2,m.all(e)]})})};f.prototype.updateStyle=function(){return l(this,void 0,void 0,function(){var a,g=this;return n(this,function(e){switch(e.label){case 0:return[4,this._broadcastPromise];
case 1:return e.sent(),this._updateToAbortController.forEach(function(a){return a.abort()}),this._updateToAbortController.clear(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=m.create(function(b,c){m.all(g._connection.broadcast("updateStyle",a.styleJSON)).then(b,c)}),[2,this._broadcastPromise]}})})};f.prototype.updateTile=function(a,g){return l(this,void 0,void 0,function(){var e,b,c,d,h=this;return n(this,function(k){switch(k.label){case 0:return this.allowUpdates?[4,this._broadcastPromise]:
[2,null];case 1:k.sent();e=Math.round(w.degToByte(g.state.rotation));if(a.rotation===e)return[2,null];c=a.key;this._updateToAbortController.has(c.id)&&(b=this._updateToAbortController.get(c.id),b.abort(),this._updateToAbortController.delete(c.id));b=m.createAbortController();a.rotation=e;d=a.client.invoke("updateSymbols",{key:a.id,rotation:e},{signal:b.signal}).then(function(b){h._updateToAbortController.delete(c.id);a.updateSymbolData(b);return b}).catch(function(a){m.isAbortError(a)||h._updateToAbortController.delete(c.id)});
this._updateToAbortController.set(a.id,b);return[2,d]}})})};f.prototype.updateTileData=function(a){for(var g=a.tileId,e=this._container.children,b,c=0;c<e.length;c++)if(b=e[c],b.id===g){b.updateTileData(a.tileData);break}};f.prototype.getVectorTile=function(a,g,e,b){void 0===b&&(b=0);return l(this,void 0,void 0,function(){var c,d,h;return n(this,function(k){switch(k.label){case 0:return c=new p(a,g,e,0),d=new J(c,this._vectorTileLayer.tileInfo,this._vectorTileLayer.styleRepository,0),[4,this._getVectorTileData(c,
b,null)];case 1:return(h=k.sent())?d.setData(h.tileData,h.client):d.setData(null,null),[2,d]}})})};f.prototype.getVectorTile3D=function(a,g,e,b){void 0===b&&(b=0);return l(this,void 0,void 0,function(){var c,d,h,k;return n(this,function(f){switch(f.label){case 0:return[4,new Promise(function(a,b){u(["./VectorTileDisplayObject3D"],a,b)})];case 1:return c=f.sent(),d=new p(a,g,e,0),h=new c(d,this._vectorTileLayer.tileInfo,this._vectorTileLayer.styleRepository,0),[4,this._getVectorTileData(d,b,null)];
case 2:return(k=f.sent())?h.setData(k.tileData,k.client):h.setData(null,null),[2,h]}})})};f.prototype.fetchTileData=function(a,g){return l(this,void 0,void 0,function(){var e,b,c,d;return n(this,function(h){switch(h.label){case 0:return[4,this._getRefKeys(a,g)];case 1:e=h.sent();b=this._vectorTileLayer.sourceNameToSource;c=[];for(d in b)c.push(d);return[2,this._getSourcesData(a,c,e,g)]}})})};f.prototype.parseTileData=function(a,g,e){return l(this,void 0,void 0,function(){var b,c,d,h,k,f,l,m;return n(this,
function(t){switch(t.label){case 0:b=a&&a.data;if(!b)return[2,{tileData:null,client:null}];c=b.sourceName2DataAndRefKey;d=b.transferList;return 0===Object.keys(c).length?[2,{tileData:null,client:null}]:[4,this._broadcastPromise];case 1:return t.sent(),h=Math.round(w.degToByte(g)),k=this._connection.getAvailableClient(),[4,k.invoke("createTileAndParse",{key:a.key.id,rotation:h,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:c},r({},e,{transferList:d}))];case 2:f=t.sent();if(B("esri-vector-tiles-debug")){l=
{};for(m in c)l[m]=c[m].refKey;return[2,{tileData:f,client:k,refKeys:l}]}return[2,{tileData:f,client:k}]}})})};Object.defineProperty(f.prototype,"updating",{get:function(){return 0<this._ongoingTileRequests.size},enumerable:!0,configurable:!0});f.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};f.prototype.getSprites=function(a){var g=this;return this._spriteSourcePromise.then(function(){return g._spriteMosaic.getSpriteItems(a)})};
f.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.tileID,a.font,a.codePoints)};f.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};f.prototype._getTilePayload=function(a,g,e,b){return l(this,void 0,void 0,function(){var a,d,h,k,f;return n(this,function(c){switch(c.label){case 0:return a=p.pool.acquire(g.id),d=this._vectorTileLayer.sourceNameToSource,h=d[e],k=h.getSourceTileUrl(a.level,a.row,a.col),p.pool.release(a),[4,v(k,r({responseType:"array-buffer"},
b))];case 1:return f=c.sent(),[2,{protobuff:f.data,sourceName:e}]}})})};f.prototype._fetchTileMap=function(a,g){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return m.resolve();var e=y.get(a.tileMapURL);if(e)return a.tileIndex=e,m.resolve();if(q.has(a.tileMapURL))return q.get(a.tileMapURL).then(function(b){a.tileIndex=new x(b.data)});g=v(a.tileMapURL,g);g.then(function(b){a.tileIndex=new x(b.data);q["delete"](a.tileMapURL);y.put(a.tileMapURL,a.tileIndex)});q.set(a.tileMapURL,
g);return g};f.prototype._getRefKeys=function(a,g){return l(this,void 0,void 0,function(){var e,b,c,d,h;return n(this,function(f){e=this._vectorTileLayer.sourceNameToSource;b=[];for(c in e)d=e[c],h=d.getRefKey(a,g),b.push(h);return[2,m.eachAlways(b)]})})};f.prototype._getSourcesData=function(a,g,e,b){return l(this,void 0,void 0,function(){var c,d,f,k,l,p,z;return n(this,function(h){switch(h.label){case 0:c=[];for(d=0;d<e.length;d++)null==e[d].value||null==g[d]?c.push(null):(f=this._getTilePayload(a,
e[d].value,g[d],b),c.push(f));return[4,m.eachAlways(c)];case 1:k=h.sent();l={};p=[];for(d=0;d<k.length;d++)k[d].value&&k[d].value&&k[d].value.protobuff&&0<k[d].value.protobuff.byteLength&&(z=e[d].value.id,l[k[d].value.sourceName]={refKey:z,protobuff:k[d].value.protobuff},p.push(k[d].value.protobuff));return[2,{sourceName2DataAndRefKey:l,transferList:p}]}})})};f.prototype._getVectorTileData=function(a,g,e){return l(this,void 0,void 0,function(){var b,c,d,f,k,l=this;return n(this,function(h){b=a.id;
if(this._ongoingTileRequests.has(b))return[2,this._ongoingTileRequests.get(b)];c=new AbortController;d={signal:c.signal};f=e&&e.signal;k=this._getParsedVectorTileData(a,g,d).then(function(a){l._ongoingTileRequests.delete(b);l._ongoingRequestToController.delete(b);return a}).catch(function(a){l._ongoingTileRequests.delete(b);l._ongoingRequestToController.delete(b);return null});this._ongoingTileRequests.set(b,k);this._ongoingRequestToController.set(b,c);if(f)D.onAbort(f,function(){c.abort();l._ongoingTileRequests.delete(b);
l._ongoingRequestToController.delete(b)});return[2,k]})})};f.prototype._getParsedVectorTileData=function(a,f,e){return l(this,void 0,void 0,function(){var b;return n(this,function(c){switch(c.label){case 0:return[4,this.fetchTileData(a,e)];case 1:return b=c.sent(),[2,this.parseTileData({key:a,data:b},f,e)]}})})};return f}()});