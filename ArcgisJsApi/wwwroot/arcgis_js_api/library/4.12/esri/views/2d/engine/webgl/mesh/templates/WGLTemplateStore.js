// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/awaiterHelper ../../../../../../core/tsSupport/generatorHelper ../../../../../../core/asyncUtils ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/cim/cimAnalyzer ../../../../../../symbols/support/defaults ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/BidiText ../../util/Lock ../../util/Result".split(" "),
function(u,p,g,h,B,C,D,m,v,q,E,F,G,r,w,t,x,H,y,n){function k(b,a){var e=b.length;b.push(null);a.then(function(a){return b[e]=a});return b}function z(b){return!!(b&1)}Object.defineProperty(p,"__esModule",{value:!0});var l=D.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),A=[];p.isDynamicId=z;u=function(){function b(a){this._templateIdCounter=this._idCounter=0;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=
new Map;this._cimAnalyses=[];this._lock=new y.default;this._fetchResource=a}Object.defineProperty(b.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});b.prototype.createTemplateGroup=function(a,e,c,d){this._initErrorTemplates();var b=this._hashSymbol(a);if(!this._symbolToTemplate.has(b)){var f=[];e&&this._createMeshTemplates(f,e,c,d,!0);this._createMeshTemplates(f,a,c,d,!1);a=this._createGroupId("cim"===a.type);this._idToTemplateGroup.set(a,f);this._symbolToTemplate.set(b,a)}return this._symbolToTemplate.get(b)};b.prototype.getCIMMosaicItem=function(a,
e){var c=this,d=this._createTemplateId(),b=m.create(function(a){return c._idToResolver.set(d,a)});this._fetchQueue.push({symbol:a,id:d,glyphIds:e});return b};b.prototype.getTemplateGroup=function(a){return this._idToTemplateGroup.has(a)?this._idToTemplateGroup.get(a):A};b.prototype.getDynamicTemplateGroup=function(a){if(!this._idToTemplateGroup.has(a))return A;z(a)||l.error("mapview-template-store","Id "+a+" does not refer to a dynamic template");return this._idToTemplateGroup.get(a)};b.prototype.finalize=
function(a){return this._fetchQueue.length||this._lock.isHeld()?y.withLock(this._lock,this._fetchAllQueuedResources.bind(this),a):m.resolve()};b.prototype._initErrorTemplates=function(){if(!this._errorTemplates){var a=this._createMeshTemplates([],q.errorPolygonSymbol2D,null,null,!1),e=this._createMeshTemplates([],q.errorPointSymbol2D,null,null,!1),c=this._createMeshTemplates([],q.errorPolylineSymbol2D,null,null,!1);this._errorTemplates={fill:a,marker:e,line:c}}};b.prototype._fetchAllQueuedResources=
function(a){var e=this;if(!this._fetchQueue.length)return m.resolve();var c=this._fetchQueue,d=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return m.all(d).then(function(){return e._fetchResource(c,a).then(function(a){for(var c=0;c<a.length;c++){var d=a[c],b=d.id,d=d.mosaicItem;e._idToResolver.get(b)(d);e._idToResolver.delete(b)}})}).catch(function(a){m.isAbortError(a)?e._fetchQueue=e._fetchQueue.concat(c):l.error(C("mapview-template-store","Unable to fetch requested texture resources",
a))})};b.prototype._createGroupId=function(a){return this._idCounter++<<1|(a?1:0)};b.prototype._createTemplateId=function(){return this._templateIdCounter++};b.prototype._getCodepoints=function(a){a=H.bidiText(a.text)[0];for(var e=[],c=0;c<a.length;c++)e.push(a.charCodeAt(c));return e};b.prototype._getMosaicItem=function(a){var e=this,c=this._createTemplateId(),d="text"===a.type&&this._getCodepoints(a),b=m.create(function(a){return e._idToResolver.set(c,a)});this._fetchQueue.push({symbol:a.toJSON(),
id:c,glyphIds:d});return b};b.prototype._hashSymbol=function(a){return a.id?a.id:JSON.stringify(a)};b.prototype._createSMS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,t.default.fromSimpleMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createPMS=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,
this._getMosaicItem(a)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,t.default.fromPictureMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createSFS=function(a,e,c){return g(this,void 0,void 0,function(){var d,b;return h(this,function(f){switch(f.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=f.sent().spriteMosaicItem,b=a,n.ok(d,l)?[2,r.default.fromSimpleFill(e,b,d,c)]:[2,this._fillError]}})})};b.prototype._createPFS=function(a,e,c){return g(this,void 0,void 0,function(){var d,
b;return h(this,function(f){switch(f.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=f.sent().spriteMosaicItem,b=a,n.ok(d,l)?[2,r.default.fromPictureFill(e,b,d,c)]:[2,this._fillError]}})})};b.prototype._createSLS=function(a,e,c){return g(this,void 0,void 0,function(){var d,b;return h(this,function(f){switch(f.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=f.sent().spriteMosaicItem,b=a,n.ok(d,l)?[2,w.default.fromSimpleLine(e,c,b,d)]:[2,this._lineError]}})})};b.prototype._createTS=
function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return c=d.sent().glyphMosaicItems,[2,x.default.fromText(e,a,c)]}})})};b.prototype._createCIMText=function(a,e){return g(this,void 0,void 0,function(){var c,d,b,f,g,k;return h(this,function(h){switch(h.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(G.default.fromCIMText(e,a))];c=[];if(d=a.text)for(b=d.length,f=0;f<b;f++)g=d.charCodeAt(f),
c.push(g);a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim,c)];case 1:return k=h.sent().glyphMosaicItems,n.ok(k,l)?[2,x.default.fromCIMText(e,a,k)]:[2,this._textError]}})})};b.prototype._createCIMFill=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,r.default.fromCIMFill(e,a,c,!1)]:[2,this._fillError]}})})};
b.prototype._createCIMLine=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(E.default.fromCIMLine(e,a))];a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,w.default.fromCIMLine(e,a,c,!1)]:[2,this._lineError]}})})};b.prototype._createCIMMarker=function(a,e){return g(this,void 0,void 0,function(){var c;return h(this,
function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(F.default.fromCIMMarker(e,a))];a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return c=d.sent().spriteMosaicItem,n.ok(c,l)?[2,t.default.fromCIMMarker(e,a,c)]:[2,this._markerError]}})})};b.prototype._createCIM=function(a,e){return g(this,void 0,void 0,function(){var c,d,b=this;return h(this,function(f){c=a.templateHash;if(this._cimTemplateCache.has(c))return[2,this._cimTemplateCache.get(c)];
switch(a.type){case "marker":d=this._createCIMMarker(a,e);break;case "line":d=this._createCIMLine(a,e);break;case "fill":d=this._createCIMFill(a,e);break;case "text":d=this._createCIMText(a,e)}d.then(function(a){return b._cimTemplateCache.set(c,a)});return[2,d]})})};b.prototype._getCIMSymbolLayers=function(a,e,c){return g(this,void 0,void 0,function(){var d,b,f,g,k;return h(this,function(h){switch(h.label){case 0:d=[];b=[];if(Array.isArray(a.data))for(f=0,g=a.data;f<g.length;f++)k=g[f],d.push(v.analyzeCIMSymbol(k,
e,c,b));else d.push(v.analyzeCIMSymbol(a.data,e,c,b));return[4,m.all(d)];case 1:return h.sent(),[2,b]}})})};b.prototype._createCIMMeshTemplates=function(a,b,c,d){var e=this;b=this._getCIMSymbolLayers(b,c?c.fieldMap:null,d);this._cimAnalyses.push(B.safeCast(b.then(function(b){for(var d=0;d<b.length;d++)k(a,e._createCIM(b[d],c))})))};b.prototype._createMeshTemplates=function(a,b,c,d,g){if(-1!==b.type.indexOf("3d"))return l.error("3D symbols are not supported with MapView"),a;switch(b.type){case "cim":return this._createCIMMeshTemplates(a,
b,c,d),a;case "simple-marker":return k(a,this._createSMS(b,c));case "picture-marker":return k(a,this._createPMS(b,c));case "simple-fill":return k(a,this._createSFS(b,c,g)),b.outline&&k(a,this._createSLS(b.outline,c,!0)),a;case "picture-fill":return k(a,this._createPFS(b,c,g)),b.outline&&k(a,this._createSLS(b.outline,c,!0)),a;case "simple-line":return k(a,this._createSLS(b,c,!1));case "text":return k(a,this._createTS(b,c));default:return l.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),
a}};return b}();p.WGLTemplateStore=u});