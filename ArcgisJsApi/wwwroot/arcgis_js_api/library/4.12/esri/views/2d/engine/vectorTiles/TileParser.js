// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/pbf ../../../../core/promiseUtils ./BackgroundBucket ./CircleBucket ./Feature ./FillBucket ./LineBucket ./SourceLayerData ./SymbolBucket ../webgl/TileClipper ../../tiling/enums".split(" "),function(xa,ya,ma,na,oa,I,pa,qa,ra,sa,ta,ua,va,n,wa){return function(){function e(b,a,l){this._pbfTiles={};this._tileClippers={};this._client=l;this._tile=a;this._layers=a.getLayers();var h=
a.tileKey.split("/").map(parseFloat);a=h[0];l=h[1];h=h[2];this._level=a;for(var e=Math.max(8,Math.round(1*this._level)-8),c=0,g=Object.keys(b);c<g.length;c++){var k=g[c],f=b[k];this._pbfTiles[k]=new oa(new Uint8Array(f.protobuff),new DataView(f.protobuff));if(f.refKey&&(f=f.refKey.split("/").map(parseFloat)[0],f=a-f,0<f)){var p=(1<<f)-1;this._tileClippers[k]=new n.TileClipper(f,l&p,h&p,8,e)}this._tileClippers[k]||(this._tileClippers[k]=new n.SimpleBuilder)}}e.prototype.parse=function(b){return na(this,
void 0,void 0,function(){var a,l,h,e,c,g,k,f,p,q,d,x,n,r,v,J,t,K,da,ea,y,L,M,N,z,A,B,O,fa,C,P,m,w,Q,u,R,S,T,ga,ha,D,U,ia,E,V,W,F,X,G,Y,Z,H,aa,ja,ka,ba,ca,la=this;return ma(this,function(za){a=b&&b.signal;l=this._parseTileData(this._pbfTiles);h=this._layers;e=this._level;g=[];k=this._tileClippers;f={};p={};for(q=h.length-1;0<=q;q--)(c=h[q],c.minzoom&&e<c.minzoom||c.maxzoom&&e>=c.maxzoom||c.layout&&c.layout.visibility&&"none"===c.layout.visibility)||(0===c.type?(d=this._createBucket(c),d.layerIndex=
q,g.push(d)):l[c.source]&&k[c.source]&&(x=l[c.source],n=k[c.source],r=c.sourceLayer,v=x[r])&&((J=p[c.source])||(J=p[c.source]=new Set),J.add(c.sourceLayer),d=this._createBucket(c))&&(d.layerIndex=q,d.layerExtent=v.extent,d.tileClipper=n,(t=f[c.source])||(t=f[c.source]={}),(K=t[r])||(K=t[r]=[]),K.push(d)));da=10*this._level;ea=10*(this._level+1);y=[];L=[];M=[];N=[];z=new Set;A={};B=[];O=[];fa=function(a){p[a].forEach(function(b){B.push(b);O.push(a)})};C=0;for(P=Object.keys(p);C<P.length;C++)m=P[C],
fa(m);for(w=0;w<B.length;w++){m=O[w];Q=B[w];if(!l[m]||!f[m])break;x=l[m];v=x[Q];t=f[m];u=t[Q];if(!u||0===u.length)break;if(I.isAborted(a))return[2];for(R=v.getData();R.next(2);){S=new ra(R.getMessage(),v);if(T=S.values){if((ga=T._minzoom)&&ga>=ea)continue;if((ha=T._maxzoom)&&ha<=da)continue}D=0;for(U=u;D<U.length;D++)d=U[D],d.pushFeature(S)}}ia=this._tile;E=0;for(V=Object.keys(f);E<V.length;E++)for(r in m=V[E],W=f[m],W)for(u=W[r],F=0,X=u;F<X.length;F++)d=X[F],d.hasFeatures()&&(3===d.layer.type?(y.push(d),
ia.addBucket(d)):d.layer.refLayerId?M.push(d):(L.push(d),N[d.layer.id]=d));G=0;for(Y=y;G<Y.length;G++)Z=d=Y[G],Z.getResources(Z.tileClipper,z,A);if(this._tile.status===wa.TileStatus.INVALID)return[2,I.resolve([])];H=[];aa=this._tile.getWorkerTileHandler();0<z.size&&(ja=aa.fetchSprites(z,this._client,b),H.push(ja));for(ba in A)ca=A[ba],0<ca.size&&(ka=aa.fetchGlyphs(this._tile.tileKey,ba,ca,this._client,b),H.push(ka));return[2,I.all(H).then(function(){for(var a=0,b=L;a<b.length;a++){var c=b[a];c.processFeatures(c.tileClipper,
la._tile);g.push(c)}a=0;for(b=M;a<b.length;a++){var c=b[a],d=N[c.layer.refLayerId];d&&(d.assignBufferInfo(c),g.push(c))}a=0;for(b=y;a<b.length;a++)c=b[a],c.processFeatures(c.tileClipper,la._tile),g.push(c);g.sort(function(a,b){return a.layerIndex-b.layerIndex});return g})]})})};e.prototype._parseTileData=function(b){for(var a={},e=0,h=Object.keys(b);e<h.length;e++){for(var n=h[e],c=b[n],g={};c.next();)switch(c.tag()){case 3:var k=new ua(c.getMessage());g[k.name]=k;break;default:c.skip()}a[n]=g}return a};
e.prototype._createBucket=function(b){switch(b.type){case 0:return this._createBackgroundBucket(b);case 1:return this._createFillBucket(b);case 2:return this._createLineBucket(b);case 4:return this._createCircleBucket(b);case 3:return this._createSymbolBucket(b)}};e.prototype._createBackgroundBucket=function(b){return new pa(b,this._level)};e.prototype._createFillBucket=function(b){var a=this._tile;return new sa(b,this._level,b.hasDataDrivenFill?a.fillDDVertexBuffer:a.fillVertexBuffer,a.fillIndexBuffer,
b.hasDataDrivenOutline?a.outlineDDVertexBuffer:a.outlineVertexBuffer,a.outlineIndexBuffer)};e.prototype._createLineBucket=function(b){var a=this._tile;return new ta(b,this._level,b.hasDataDrivenLine?a.lineDDVertexBuffer:a.lineVertexBuffer,a.lineIndexBuffer)};e.prototype._createCircleBucket=function(b){var a=this._tile;return new qa(b,this._level,a.circleVertexBuffer,a.circleIndexBuffer)};e.prototype._createSymbolBucket=function(b){var a=this._tile;return new va(b,this._level,b.hasDataDrivenIcon?a.iconDDVertexBuffer:
a.iconVertexBuffer,a.iconIndexBuffer,b.hasDataDrivenText?a.textDDVertexBuffer:a.textVertexBuffer,a.textIndexBuffer,a.placementEngine,a.getWorkerTileHandler())};return e}()});