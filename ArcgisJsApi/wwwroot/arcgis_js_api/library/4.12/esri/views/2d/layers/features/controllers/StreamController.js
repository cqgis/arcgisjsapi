// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper @dojo/framework/shim/array @dojo/framework/shim/Map ../../../../../core/asyncUtils ../../../../../core/has ../../../../../core/maybe ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/executeTileQuery ../../../../../layers/graphics/data/StreamStore ../../../../../layers/graphics/sources/connections/GeoEventConnection ./BaseController ./support/DispatchQueue".split(" "),
function(n,p,r,e,D,t,u,v,w,h,E,k,g,x,q,y,z,A,B){Object.defineProperty(p,"__esModule",{value:!0});n=function(m){function b(){var a=null!==m&&m.apply(this,arguments)||this;a.type="stream";a._tileDispatchMap=new w.default;a._updateIntervalId=0;return a}r(b,m);b.prototype.initialize=function(){var a=this,c=this.service,b=c.objectIdField,d=c.timeInfo,l=c.maximumTrackPoints,C=c.purgeOptions;this.connection=new z.default(c.source,this.spatialReference,c.serviceFilter);this._set("store",new y.default(b,d,
this.geometryInfo,l,C));this.connection.on("feature",function(c){return a._onFeature(c)});this.store.events.on("update",function(c){return a._onUpdate(c.addOrUpdated,c.removed)});["connectionStatus","errorString"].forEach(function(c){a.watch("connection."+c,function(b){return a.remoteClient.invoke("setProperty",{propertyName:c,value:b})})});this._updateIntervalId=setInterval(function(){return a.store.checkForUpdates()},64);this._set("queryEngine",this._createQueryEngine(this.store));this._shouldPushDataReceived=
this.service.enableDataRecieved};b.prototype.destroy=function(){clearInterval(this._updateIntervalId);this.connection.destroy();this.queryEngine.destroy();this._tileDispatchMap.forEach(function(a){return a.destroy()})};Object.defineProperty(b.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0});b.prototype.update=function(a,c){return u(this,void 0,void 0,function(){var b,d,l=this;
return t(this,function(f){switch(f.label){case 0:return this.validateConfig(a,c),b=this.renderer.getAttributeHash(),this._set("config",a),[4,this.updatePixelBuffer()];case 1:f.sent();if("heatmap"===this.renderer.type)return[2];if(b===this.renderer.getAttributeHash())return[3,3];d=this.queryEngine.featureStore;return[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 2:f.sent(),d.forEach(function(a){return l.attributeStore.setAttributeData(a.localId,a,l.geometryInfo,l.viewParams)}),
f.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return f.sent(),[4,this.attributeStore.sendUpdates()];case 5:return f.sent(),[2]}})})};b.prototype.invalidate=function(){this._repushActiveTiles()};b.prototype.onEdits=function(a){};b.prototype.queryFeatures=function(a){return h.safeCast(this.queryEngine.executeQuery(a))};b.prototype.queryFeatureCount=function(a){return h.safeCast(this.queryEngine.executeQueryForCount(a))};b.prototype.queryObjectIds=function(a){return h.safeCast(this.queryEngine.executeQueryForIds(a))};
b.prototype.queryExtent=function(a){return h.safeCast(this.queryEngine.executeQueryForExtent(a))};b.prototype.queryLatestObservations=function(a){return h.safeCast(this.queryEngine.executeQueryForLatestObservations(a))};b.prototype.redraw=function(){};b.prototype.refresh=function(){};b.prototype.setViewState=function(a){var c=this,b=this.viewState&&this.viewState.scale;this.inherited(arguments);b!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(a){return c.attributeStore.setAttributeData(a.localId,
a,c.geometryInfo,c.viewParams)}),this.attributeStore.sendUpdates())};b.prototype.onTileUpdate=function(a){var c=this,b=a.added;a.removed.forEach(function(a){return c._handleTileRemove(a)});b.forEach(function(a){return c._handleTileAdd(a)})};b.prototype.enableEvent=function(a){"data-received"===a.name&&(this._shouldPushDataReceived=a.value)};b.prototype._onFeature=function(a){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,
geometry:a.geometry}});try{var c=this.geometryInfo,b=x.convertFromFeature(a,c.geometryType,c.hasZ,c.hasM,this.store.objectIdField);this.store.add(b)}catch(d){}};b.prototype._createStoreWithFeatures=function(a){if(k.isNone(a))return null;var c=this._createFeatureStore(!1);c.addMany(a);return c};b.prototype._onUpdate=function(a,c){var b=this;k.isSome(a)&&a.forEach(function(a){return b.onFeatureAdd(a)});a=this._createStoreWithFeatures(a);var d=this._createStoreWithFeatures(c);this.attributeStore.sendUpdates();
this.processor.supportsTileUpdates?this._updateActiveTiles(a,d):this._repushActiveTiles();k.isSome(c)&&c.forEach(function(a){return b.onFeatureRemove(a)})};b.prototype._handleTileAdd=function(a){if(this._tileDispatchMap.has(a.id)){var b=this._tileDispatchMap.get(a.id);b.up()}else b=new B.default,this._tileDispatchMap.set(a.id,b);this._queryTileFeatures(a,!0,this.queryEngine)};b.prototype._handleTileRemove=function(a){this._tileDispatchMap.get(a.id).destroy();this._tileDispatchMap.delete(a.id)};b.prototype._anyUpdatesQueued=
function(){return v.from(this._tileDispatchMap).some(function(a){return a[1].hasAction()})};b.prototype._updateActiveTiles=function(a,b){var c=this;a=k.applySome(a,function(a){return c._createQueryEngine(a)});b=k.applySome(b,function(a){return c._createQueryEngine(a)});for(var d=0,l=this.tileStore.tiles;d<l.length;d++)this._queryTileFeatures(l[d],!1,a,b)};b.prototype._repushActiveTiles=function(){for(var a=0,b=this.tileStore.tiles;a<b.length;a++)this._queryTileFeatures(b[a],!0,this.queryEngine)};
b.prototype._queryTileFeatures=function(a,b,f,d){var c=this,g={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]}},e=this.queryInfo,h={returnCentroid:e.returnCentroid,returnGeometry:e.returnGeometry,pixelBuffer:this._pixelBuffer},e=this._tileDispatchMap.get(a.id);f=k.applySome(f,function(b){return q.executeTileQuery(b,a,h)});var m=k.mapOr(f,[],function(a){return a.features}),n=k.mapOr(d,[],function(b){return q.executeTileQueryForIds(b,
a,h)}).map(function(a){return c.attributeStore.getLocalId(a)});e.enqueue(function(d){return c.processor.onTileData(a,{addOrUpdate:m,remove:n,clear:b,transformParams:g},{signal:d})})};e([g.property()],b.prototype,"connection",void 0);e([g.property()],b.prototype,"service",void 0);e([g.property({readOnly:!0})],b.prototype,"store",void 0);e([g.property({readOnly:!0})],b.prototype,"queryEngine",void 0);e([g.property()],b.prototype,"updating",null);return b=e([g.subclass("esri.views.2d.layers.features.controllers.StreamController")],
b)}(g.declared(A.default));p.default=n});