// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/screenUtils ../../alignmentUtils ../../color ../../fontUtils ../../materialKey/MaterialKey ./util ./WGLBaseTextTemplate ./WGLDynamicMeshTemplate ../../util/BidiText".split(" "),function(q,r,A,g,n,t,v,w,c,B,C,D){Object.defineProperty(r,"__esModule",{value:!0});var p=new Set;q=function(q){function h(u,a){var b=q.call(this,a)||this;b._horizontalAlignment="center";b._verticalAlignment="middle";b._glyphs=[];b._cimTextLayer=
a;var h=b._bitset=0;c.isFunction(a.color)||(h=t.premultiplyAlphaRGBA(a.color));b._dynamicPropertyMap.set("_color",function(b,d,e){return c.isFunction(a.color)?t.premultiplyAlphaRGBA(a.color(b,d,e)):h});var f=0;c.isFunction(a.color)||(f=t.premultiplyAlphaRGBA(a.outlineColor));b._dynamicPropertyMap.set("_haloColor",function(b,d,e){return c.isFunction(a.outlineColor)?t.premultiplyAlphaRGBA(a.outlineColor(b,d,e)):f});var k;c.isFunction(a.size)||(k=Math.min(Math.round(g.pt2px(a.size*a.sizeRatio)),127));
b._dynamicPropertyMap.set("_size",function(b,d,e){return c.isFunction(a.size)?Math.min(Math.round(g.pt2px(a.size(b,d,e)*a.sizeRatio)),127):k});var l;c.isFunction(a.outlineSize)||(l=Math.min(Math.floor(5*g.pt2px(a.outlineSize*a.sizeRatio)),127));b._dynamicPropertyMap.set("_haloSize",function(b,d,e){return c.isFunction(a.outlineSize)?Math.min(Math.floor(5*g.pt2px(a.outlineSize(b,d,e)*a.sizeRatio)),127):l});var x;c.isFunction(a.offsetX)||(x=Math.round(g.pt2px(a.offsetX*a.sizeRatio)));b._dynamicPropertyMap.set("_xOffset",
function(b,d,e){return c.isFunction(a.offsetX)?Math.round(g.pt2px(a.offsetX(b,d,e)*a.sizeRatio)):x});var m;c.isFunction(a.offsetY)||(m=Math.round(g.pt2px(a.offsetY*a.sizeRatio)));b._dynamicPropertyMap.set("_yOffset",function(b,d,e){return c.isFunction(a.offsetY)?Math.round(g.pt2px(a.offsetY(b,d,e)*a.sizeRatio)):m});var y;c.isFunction(a.decoration)||(y=v.getFontDecorationTop(a.decoration));b._dynamicPropertyMap.set("_decorationTop",function(b,d,e){return c.isFunction(a.decoration)?v.getFontDecorationTop(a.decoration(b,
d,e)):y});var z;c.isFunction(a.angle)||(z=a.angle);b._dynamicPropertyMap.set("_angle",function(b,d,e){return c.isFunction(a.angle)?a.angle(b,d,e):z});var n;c.isFunction(a.horizontalAlignment)||(n=a.horizontalAlignment);b._dynamicPropertyMap.set("_horizontalAlignment",function(b,d,e){return c.isFunction(a.horizontalAlignment)?a.horizontalAlignment(b,d,e):n});var p;c.isFunction(a.verticalAlignment)||(p=a.verticalAlignment);b._dynamicPropertyMap.set("_verticalAlignment",function(b,d,e){return c.isFunction(a.verticalAlignment)?
a.verticalAlignment(b,d,e):p});var r;c.isFunction(a.text)||(r=a.text);b._dynamicPropertyMap.set("_text",function(b,d,e){return c.isFunction(a.text)?a.text(b,d,e):r});b._materialKey=w.createMaterialKey(b.geometryType,u,!1);u=w.TextMaterialKey.load(b._materialKey);u.sdf=!0;b._materialKey=u.data;return b}A(h,q);h.fromCIMText=function(c,a){return new h(c,a)};h.prototype.analyze=function(c,a,b,h){var f=this._cimTextLayer;a="string"===typeof f.text?f.text:"function"===typeof f.text?f.text(a,b,h):"";var k=
this._glyphs;p.clear();for(b=0;b<a.length;b++)p.add(a.charCodeAt(b));var l=[];p.forEach(function(a){if(k.length<a||void 0===k[a])l[a]=a});return c.getCIMMosaicItem(f.cim,l).then(function(a){if(a.glyphMosaicItems&&0<a.glyphMosaicItems.length)for(var b=a.glyphMosaicItems,c=0;c<b.length;c++)void 0!==b[c]&&(k[c]=b[c]);return a})};h.prototype.bindFeature=function(c,a,b){var h=this,f=this._dynamicPropertyMap;f&&f.forEach(function(f,g){h[g]=f(c,a,b)});if(this._text&&0!==this._text.length){this._scale=this._size/
24;this._justify=n.getJustification(this._horizontalAlignment||"center");this._xAlignD=n.getXAnchorDirection(this._horizontalAlignment||"center");this._yAlignD=-n.getYAnchorDirection(this._verticalAlignment||"baseline");this._baseline="baseline"===(this._verticalAlignment||"baseline");for(var f=this._glyphs,k=D.bidiText(this._text),l=k[0],k=k[1],g=[],m=0;m<l.length;m++)g[l.charCodeAt(m)]=f[l.charCodeAt(m)];this.bindTextInfo(g,l,k);this._computeGlyphs(this._shapedGlyphs,this._shapedBox)}else this._shapedBox=
this._shapedGlyphs=this._computedGlyphs=null};return h}(B.default(C.default));r.default=q});