// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../config ../../../../request ../../../../core/asyncUtils ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../symbols/cim/CIMSymbolHelper ../../../../symbols/cim/SDFHelper ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./Utils ./util/Result".split(" "),
function(P,Q,B,u,v,C,D,E,l,F,w,x,G,n,y,p,q,H,I,J,K,L,r,M){function N(b){if(b.type){switch(r.normalizeSymbolType(b.type)){case "simple-marker":return b.path?"simple-marker"+b.style+b.path:"simple-marker"+b.style;case "simple-line":return"simple-line"+b.style+b.cap;case "simple-fill":return"simple-fill"+b.style}if(b.mosaicHash)return b.mosaicHash;if(r.isPictureSymbol(b))return b.imageData?b.imageData:b.url+(""+b.width+b.height)}return JSON.stringify(b)}var z=G.vec2f32.create(),t=F.getLogger("esri.views.2d.engine.webgl.TextureManager"),
O=function(){function b(a,e,c){this.mosaicType=a;this.page=e;this.sdf=c}b.fromMosaic=function(a,e){return new b(a,e.page,e.sdf)};return b}();return function(){function b(){this._invalidFontsMap=new Map;this._sdfConverter=new K.default(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._spriteMosaic=new L(1024,1024,300);this._glyphSource=new J(C.fontsUrl+"/{fontstack}/{range}.pbf");this._glyphMosaic=new I(1024,1024,this._glyphSource)}Object.defineProperty(b.prototype,"sprites",{get:function(){return this._spriteMosaic},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});b.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizationCanvas=this._glyphMosaic=this._spriteMosaic=null};b.prototype._hashMosaic=function(a,e){return 1|a<<1|(e.sdf?1:0)<<2|e.page<<3};b.prototype._setTextureBinding=function(a,e){var c=this._hashMosaic(a,e);this._hashToBindingIndex.has(c)||(a=O.fromMosaic(a,
e),this._hashToBindingIndex.set(c,this._bindingInfos.length+1),this._bindingInfos.push(a));e.textureBinding=this._hashToBindingIndex.get(c)};b.prototype.rasterizeItem=function(a,e,c){var d=this;void 0===e&&(e=null);return a?a.type&&-1!==a.type.toLowerCase().indexOf("3d")?(t.error(new l("mapview-invalid-type","MapView does not support 3d symbol type: "+a.type,a)),w.resolve({glyphMosaicItems:[],spriteMosaicItem:null})):!a.type||"text"!==a.type&&"esriTS"!==a.type&&"CIMTextSymbol"!==a.type?E.safeCast(this._rasterizeSpriteSymbol(a,
c)).then(function(a){M.ok(a)&&a&&d._setTextureBinding(q.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}):this._rasterizeTextSymbol(a,e,c).then(function(a){a.forEach(function(a){return d._setTextureBinding(q.MosaicType.GLYPH,a)});return{glyphMosaicItems:a}}):(t.error(new l("mapview-null-resource","Unable to rasterize null resource")),w.resolve(null))};b.prototype.bindTextures=function(a,e,c,d){void 0===d&&(d=1);if(0!==c.textureBinding){var b=this._bindingInfos[c.textureBinding-1];c=b.page;switch(b.mosaicType){case q.MosaicType.SPRITE:b=
this.sprites.getWidth(c)/d;d=this.sprites.getHeight(c)/d;d=x.vec2.set(z,b,d);this._bindSpritePage(a,c,p.TEXTURE_BINDING_SPRITE_ATLAS,9729);e.setUniform1i("u_texture",p.TEXTURE_BINDING_SPRITE_ATLAS);e.setUniform2fv("u_mosaicSize",d);break;case q.MosaicType.GLYPH:b=this.glyphs.width/d;d=this.glyphs.height/d;d=x.vec2.set(z,b,d);this._bindGlyphsPage(a,c,p.TEXTURE_BINDING_GLYPH_ATLAS);e.setUniform1i("u_texture",p.TEXTURE_BINDING_GLYPH_ATLAS);e.setUniform2fv("u_mosaicSize",d);break;default:t.error("mapview-texture-manager",
"Cannot handle unknown type "+b.mosaicType)}}};b.prototype._bindSpritePage=function(a,e,c,d){d||(d=9729);this._spriteMosaic.bind(a,d,e,c)};b.prototype._bindGlyphsPage=function(a,e,c){this._glyphMosaic.bind(a,9729,e,c)};b.prototype._rasterizeTextSymbol=function(a,e,c){var d=this,b=H.getFullyQualifiedFontName(a.font);a=this._invalidFontsMap.has(b);return this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":b,e,c).catch(function(a){t.error(new l("mapview-invalid-resource","Couldn't find font "+
b+". Falling back to Arial Unicode MS Regular"));d._invalidFontsMap.set(b,!0);return d._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",e,c)})};b.prototype._rasterizeSpriteSymbol=function(a,e){return u(this,void 0,void 0,function(){var c,b,k,g,h,m;return v(this,function(d){d="CIMSolidStroke"===a.type||"CIMSolidFill"===a.type?!0:a&&(r.isFillSymbol(a)||r.isLineSymbol(a))&&"style"in a&&("solid"===a.style||"esriSFSSolid"===a.style||"esriSLSSolid"===a.style||"none"===a.style||"esriSFSNull"===a.style||
"esriSLSNull"===a.style);if(d)return[2,null];c=N(a);return this._spriteMosaic.has(c)?[2,this._spriteMosaic.getSpriteItem(c)]:"simple-marker"!==a.type&&"esriSMS"!==a.type||!a.path?a.url||a.imageData?[2,this._handleImage(a,c,e)]:(b=this._rasterizeJSON(a))?(k=b.size,g=b.image,h=b.sdf,m=b.simplePattern,[2,this._addItemToMosaic(c,k,g,!r.isMarkerSymbol(a),h,m)]):[2,new l("TextureManager","unrecognized or null rasterized image")]:[2,this._handleSVG(a,c,e)]})})};b.prototype._handleSVG=function(a,b,c){return u(this,
void 0,void 0,function(){var e,k;return v(this,function(d){switch(d.label){case 0:return e=[126,126],[4,this._sdfConverter.draw(a.path,c)];case 1:return k=d.sent(),[2,this._addItemToMosaic(b,e,new Uint32Array(k.buffer),!1,!0,!0)]}})})};b.prototype._handleImage=function(a,b,c){return u(this,void 0,void 0,function(){var e,k,g,h,m,A,f;return v(this,function(d){switch(d.label){case 0:e=a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url,d.label=1;case 1:return d.trys.push([1,3,,4]),[4,D(e,
B({responseType:"image"},c))];case 2:return k=d.sent().data,g=this._rasterizeImageResource(k,a.colorSubstitutions),h=g.size,m=g.sdf,A=g.image,[2,this._addItemToMosaic(b,h,A,!r.isMarkerSymbol(a),m,!1)];case 3:return f=d.sent(),w.isAbortError(f)?[3,4]:[2,new l("mapview-invalid-resource","Could not fetch requested resource at "+e)];case 4:return[2]}})})};b.prototype._rasterizeImageResource=function(a,b){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));this._rasterizationCanvas.width=
a.width;this._rasterizationCanvas.height=a.height;var c=this._rasterizationCanvas.getContext("2d");c.drawImage(a,0,0,a.width,a.height);c=c.getImageData(0,0,a.width,a.height);c=new Uint8Array(c.data);if(b)for(var d=0;d<b.length;d++){var e=b[d];if(e&&e.oldColor&&4===e.oldColor.length&&e.newColor&&4===e.newColor.length){var g=e.oldColor,h=g[0],m=g[1],l=g[2],g=g[3],f=e.newColor,e=f[0],n=f[1],p=f[2],q=f[3];if(h!==e||m!==n||l!==p||g!==q)for(f=0;f<c.length;f+=4)h===c[f]&&m===c[f+1]&&l===c[f+2]&&g===c[f+
3]&&(c[f]=e,c[f+1]=n,c[f+2]=p,c[f+3]=q)}}for(f=0;f<c.length;f+=4)b=c[f+3]/255,c[f]*=b,c[f+1]*=b,c[f+2]*=b;b=a.width;d=a.height;h=c;if(512<=b||512<=d)h=a.width/a.height,1<h?(b=512,d=Math.round(512/h)):(d=512,b=Math.round(512*h)),h=new Uint8Array(4*b*d),r.resampleHermite(c,a.width,a.height,new Uint8ClampedArray(h.buffer),b,d,!1);return{size:[b,d],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1}};b.prototype._addItemToMosaic=function(a,b,c,d,k,g){return this._spriteMosaic.addSpriteItem(a,b,c,
d,k,g)};b.prototype._rasterizeJSON=function(a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));if("simple-fill"===a.type||"esriSFS"===a.type)return a=n.SymbolHelper.rasterizeSimpleFill(this._rasterizationCanvas,a.style),{size:[a[1],a[2]],image:new Uint32Array(a[0].buffer),sdf:!1,simplePattern:!0};if("simple-line"===a.type||"esriSLS"===a.type)return a=n.SymbolHelper.rasterizeSimpleLine(this._rasterizationCanvas,a.style,a.cap),{size:[a[1],a[2]],image:new Uint32Array(a[0].buffer),
sdf:!0,simplePattern:!0};var b;a="simple-marker"===a.type||"esriSMS"===a.type?n.CIMSymbolHelper.fromSimpleMarker(a):a;if(b=y.getSDFInfo(a))return a=y.buildSDF(b),(b=a[0])?{size:[a[1],a[2]],image:new Uint32Array(b.buffer),sdf:!0,simplePattern:!0}:null;a=n.CIMSymbolHelper.rasterize(this._rasterizationCanvas,a);return(b=a[0])?{size:[a[1],a[2]],image:new Uint32Array(b.buffer),sdf:!1,simplePattern:!1}:null};return b}()});