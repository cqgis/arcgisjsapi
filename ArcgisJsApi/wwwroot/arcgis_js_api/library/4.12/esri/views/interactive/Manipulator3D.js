// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/decorateHelper ../../core/tsSupport/declareExtendsHelper ../../core/Accessor ../../core/Collection ../../core/compilerUtils ../../core/maybe ../../core/screenUtils ../../core/accessorSupport/decorators ../../core/accessorSupport/ensureType ../../core/libs/gl-matrix-2/mat3 ../../core/libs/gl-matrix-2/mat3f64 ../../core/libs/gl-matrix-2/mat4 ../../core/libs/gl-matrix-2/mat4f64 ../../core/libs/gl-matrix-2/vec2 ../../core/libs/gl-matrix-2/vec2f32 ../../core/libs/gl-matrix-2/vec3 ../../core/libs/gl-matrix-2/vec3f64 ../../geometry/support/aaBoundingRect ../../layers/graphics/dehydratedFeatures ../3d/support/geometryUtils ../3d/support/stack ../3d/webgl-engine/lib/Intersector ../3d/webgl-engine/lib/intersectorUtils ../3d/webgl-engine/lib/Layer ../3d/webgl-engine/lib/Object3D ../3d/webgl-engine/parts/Model".split(" "),
function(u,D,d,S,T,U,E,m,q,c,V,F,W,z,A,v,X,n,r,Y,G,p,w,Z,aa,ba,ca,t){function H(c){return 0!==c[12]||0!==c[13]||0!==c[14]}Object.defineProperty(D,"__esModule",{value:!0});u=function(u){function b(a){a=u.call(this)||this;a.hideOnGrab=!1;a.moveOnDrag=!0;a.snapToPointer=!0;a.collisionType={type:"point"};a.collisionPriority=0;a.renderObjects=[];a.autoScaleRenderObjects=!0;a._radius=10;a._worldSized=!1;a._focusMultiplier=2;a._touchMultiplier=2.5;a.interactive=!0;a.selectable=!1;a.dragging=!1;a._areAnyEngineObjectsVisible=
!1;a._position=r.vec3f64.create();a._modelTransform=A.mat4f64.create();a._dragOffset=null;a._dirtyScreenPoint=q.createScreenPoint();a._dirtyScreenPointArray=q.createScreenPointArray();a._dirtyRenderScreenPointArray=q.createRenderScreenPointArray3();a._dirtyOriginScreenPointArray=q.createScreenPointArray();a._dirtyScreenPixelSize=1;a._screenPositionDirty=!0;a._engineResourcesAddedToStage=!1;a._engineResources=null;a._attached=!1;a._engineLayerId=null;a._materialIdReferences=null;a._hitResult={onSurface:!1,
surfaceType:"ground"};a._handlers=new U;return a}S(b,u);b.prototype.initialize=function(){this._intersector=new Z(this.view.viewingMode);this._mapPoint=G.makeDehydratedPoint(0,0,0,this.view.spatialReference)};b.prototype.destroy=function(){this._handlers.removeAll();this._handlers=null;this._removeResourcesFromStage();this._engineResources=null;this._set("view",null);this._camera=null};Object.defineProperty(b.prototype,"alignment",{get:function(){return this._get("alignment")},set:function(a){this._set("alignment",
a);this.constructed&&this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"visible",{set:function(a){a!==this._get("visible")&&(this._set("visible",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"radius",{get:function(){return this._radius},set:function(a){a!==this._radius&&(this._radius=a,this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"worldSized",{get:function(){return this._worldSized},
set:function(a){a!==this._worldSized&&(this._worldSized=a,this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focusMultiplier",{get:function(){return this._focusMultiplier},set:function(a){this._focusMultiplier=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"touchMultiplier",{get:function(){return this._touchMultiplier},set:function(a){this._touchMultiplier=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"modelTransform",
{get:function(){return this._modelTransform},set:function(a){H(a)&&(this._screenPositionDirty=!0);z.mat4.copy(this._modelTransform,a);this._updateEngineObject()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"position",{get:function(){return this._position},set:function(a){this.view.renderCoordsHelper.fromRenderCoords(a,this._mapPoint,this._mapPoint.spatialReference);this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"mapPoint",{get:function(){return this._mapPoint},
set:function(a){G.clonePoint(a,this._mapPoint);this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"grabbing",{set:function(a){a!==this._get("grabbing")&&(this._set("grabbing",a),this._updateEngineObject());a||(this._dragOffset=null)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hovering",{set:function(a){a!==this._get("hovering")&&(this._set("hovering",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"selected",{set:function(a){a!==this._get("selected")&&(this._set("selected",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{set:function(a){a!==this._get("state")&&(this._set("state",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"areAnyEngineObjectsVisible",{get:function(){return this._areAnyEngineObjectsVisible},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"surfaceType",
{get:function(){return this._hitResult.onSurface?this._hitResult.surfaceType:null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"screenPoint",{get:function(){this._updateScreenSpaceProperties();return this._dirtyScreenPoint},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_screenPointArray",{get:function(){this._updateScreenSpaceProperties();return this._dirtyScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_renderScreenPointArray",{get:function(){this._updateScreenSpaceProperties();return this._dirtyRenderScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_originScreenPointArray",{get:function(){this._updateScreenSpaceProperties();
return this._dirtyOriginScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_screenPixelSize",{get:function(){this._updateScreenSpaceProperties();return this._dirtyScreenPixelSize},enumerable:!0,configurable:!0});b.prototype._updateScreenSpaceProperties=function(){if(this._screenPositionDirty){this._screenPositionDirty=!1;this._dirtyScreenPixelSize=this._camera.computeScreenPixelSizeAt(this._position);var a=H(this._modelTransform),e;a?(e=this._calculateModelTransformOffset(da),
e=n.vec3.add(e,e,this._position)):e=this._position;this._camera.projectPoint(e,this._dirtyRenderScreenPointArray);this._camera.renderToScreen(this._dirtyRenderScreenPointArray,this._dirtyScreenPointArray);q.screenPointArrayToObject(this._dirtyScreenPointArray,this._dirtyScreenPoint);a?(this._camera.projectPoint(this._position,I),this._camera.renderToScreen(I,this._dirtyOriginScreenPointArray)):v.vec2.copy(this._dirtyOriginScreenPointArray,this._dirtyScreenPointArray)}};b.prototype.intersectionDistance=
function(a,e){if(!this._get("visible"))return null;var b=q.screenPointObjectToArray(a,J),l=this._getCollisionRadius(e);e=-1*this._get("collisionPriority");switch(this.collisionType.type){case "point":if(v.vec2.squaredDistance(this._screenPointArray,b)<l*l)return this._renderScreenPointArray[2]+e;break;case "line":var k=this.collisionType.paths;a=this._getWorldToScreenObjectScale();a=this._calculateObjectTransform(a,x);for(var l=l*this._screenPixelSize,b=p.ray.fromScreen(this._camera,b,B),h=0,f=k;h<
f.length;h++)if(k=f[h],0!==k.length)for(var g=n.vec3.transformMat4(K,k[0],a),c=1;c<k.length;c++){var d=n.vec3.transformMat4(L,k[c],a),m=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(g,d,M),b);if(null!=m&&m<l*l)return a=n.vec3.add(w.sv3d.get(),g,d),n.vec3.scale(a,a,.5),l=q.castRenderScreenPointArray(w.sv3d.get()),this._camera.projectPoint(a,l),l[2]+e;n.vec3.copy(g,d)}break;case "disc":g=this.collisionType.direction;a=this._getWorldToScreenObjectScale();a=this._calculateObjectTransform(a,
x);l*=this._screenPixelSize;b=p.ray.fromScreen(this._camera,b,B);c=F.mat3.fromMat4(N,a);c=n.vec3.transformMat3(O,g,c);g=this._calculateModelTransformPosition(P);p.plane.fromPositionAndNormal(g,c,y);h=C;if(p.plane.intersectRay(y,b,h)&&n.vec3.squaredDistance(h,g)<l*l)return this._renderScreenPointArray[2]+e;break;case "ribbon":a=this.collisionType;k=a.paths;g=a.direction;a=this._getWorldToScreenObjectScale();a=this._calculateObjectTransform(a,x);l*=this._camera.computeScreenPixelSizeAt(this._position);
b=p.ray.fromScreen(this._camera,b,B);c=F.mat3.fromMat4(N,a);c=n.vec3.transformMat3(O,g,c);g=this._calculateModelTransformPosition(P);p.plane.fromPositionAndNormal(g,c,y);h=C;if(!p.plane.intersectRay(y,b,h))break;b=0;for(f=k;b<f.length;b++)if(k=f[b],0!==k.length)for(g=n.vec3.transformMat4(K,k[0],a),c=1;c<k.length;c++){d=n.vec3.transformMat4(L,k[c],a);m=p.lineSegment.distance2(p.lineSegment.fromPoints(g,d,M),h);if(null!=m&&m<l*l)return a=n.vec3.add(w.sv3d.get(),g,d),n.vec3.scale(a,a,.5),l=q.castRenderScreenPointArray(w.sv3d.get()),
this._camera.projectPoint(a,l),l[2]+e;n.vec3.copy(g,d)}break;default:E.neverReached(this.collisionType)}return null};b.prototype.attemptDragTo=function(a){if(!this.moveOnDrag)return this._handlers.forEach(function(b){var e=b.handler;"drag"===b.type&&e(a)}),!1;var b=q.screenPointObjectToArray(a.screenPoint,J);m.isNone(this._dragOffset)&&this.grabbing&&!this.snapToPointer&&(this._dragOffset=v.vec2.subtract(X.vec2f32.create(),b,this._originScreenPointArray));m.isSome(this._dragOffset)&&v.vec2.subtract(b,
b,this._dragOffset);var b=this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(b,this._intersector,"on-the-ground"===this.alignment?Q:null).results.min,c=C;b.getIntersectionPoint(c)?(this.position=c,this._hitResult.onSurface=!0,this._hitResult.surfaceType="TerrainRenderer"===b.intersector?"ground":"feature",this._handlers.forEach(function(b){var e=b.handler;"drag"===b.type&&e(a)})):this._hitResult.onSurface=!1;return this._hitResult.onSurface};b.prototype.grab=function(a){this._handlers.forEach(function(b){var e=
b.handler;"grab"===b.type&&e(a)})};b.prototype.click=function(a){this._handlers.forEach(function(b){var e=b.handler;"click"===b.type&&e(a)})};b.prototype.on=function(a,b){this._handlers.push({type:a,handler:b})};b.prototype.attach=function(a){void 0===a&&(a={manipulator3D:{}});if(this.view._stage){a=a.manipulator3D;this._engineLayerId=a.engineLayerId;if(m.isNone(this._engineLayerId)){var b=new ba("manipulator-3d",{isPickable:!1});this.view._stage.add(t.ContentType.LAYER,b);this.view._stage.addToViewContent([b.id]);
this._engineLayerId=b.id;a.engineLayerId=b.id}a.engineLayerReferences=(a.engineLayerReferences||0)+1;this._materialIdReferences=a.materialIdReferences;m.isNone(this._materialIdReferences)&&(this._materialIdReferences=new Map,a.materialIdReferences=this._materialIdReferences);this._camera=this.view.state.camera;this._attached=!0;this._updateEngineObject()}};b.prototype.detach=function(a){void 0===a&&(a={manipulator3D:{}});a=a.manipulator3D;a.engineLayerReferences--;var b=0===a.engineLayerReferences;
b&&(a.engineLayerId=null);this._removeResourcesFromStage(b);this._camera=this._materialIdReferences=this._engineLayerId=this._engineResources=null;this._attached=!1};b.prototype.onCameraChange=function(a){this._camera=a;this._screenPositionDirty=!0;this._updateEngineObject()};b.prototype.onElevationChange=function(a){this.view.renderCoordsHelper.fromRenderCoords(this.position,R,a.spatialReference)&&Y.containsPoint(a.extent,R)&&this._refreshMapPoint(!0)};b.prototype._refreshMapPoint=function(a){void 0===
a&&(a=!1);switch(this.alignment){case "none":break;case "on-the-ground":var b=this.view.elevationProvider.getElevation(this.mapPoint,"ground");if(b===this._mapPoint.z&&a)return;this._mapPoint.z=b;break;default:E.neverReached(this.alignment)}this._screenPositionDirty=!0;this._hitResult.onSurface=!1;this.view.renderCoordsHelper.toRenderCoords(this._mapPoint,this._position);this._updateEngineObject()};b.prototype._updateEngineObject=function(){this._areAnyEngineObjectsVisible=!1;if(this._attached)if(!1===
this._get("visible"))this._removeResourcesFromStage();else{var a=this._getWorldToScreenObjectScale(),b=x;!0===this._get("autoScaleRenderObjects")&&(a*=this._getFocusedSize(this._radius,this._focused));this._calculateObjectTransform(a,b);for(var a=this._ensureEngineResources().objectsByState,c=(this._focused?2:1)|(this._get("selected")?8:4),d=this._get("hideOnGrab")&&this._get("grabbing"),k=0;k<a.length;k++){var h=a[k],f=h.stateMask,h=h.objects;if(d)for(var f=0,g=h;f<g.length;f++)h=g[f],h.hideAllComponents();
else if(g=0===(f&15)||(c&f)===(f&15),f=0===(f&65520)||(this._get("state")&f)===(f&65520),g&&f)for(f=0,g=h;f<g.length;f++)h=g[f],h.unhideAllComponents(),h.objectTransformation=b,this._areAnyEngineObjectsVisible=!0;else for(f=0,g=h;f<g.length;f++)h=g[f],h.hideAllComponents()}}};b.prototype._ensureEngineResources=function(){if(m.isNone(this._engineResources)){var a=this.view._stage.get(t.ContentType.LAYER,m.expect(this._engineLayerId)),b=[],c=new Set;this.renderObjects.forEach(function(a){a=a.material;
c.has(a)||(b.push(a),c.add(a))});var d=function(a,b){var c=b.geometry,e=b.material,f=b.transform;Array.isArray(c)?c.forEach(function(b){return a.addGeometry(b,e,f)}):a.addGeometry(c,e,f)},k=new Map;this.renderObjects.forEach(function(a){var b=new ca({idHint:"manipulator"});d(b,a);a=a.stateMask||0;var c=k.get(a)||[];c.push(b);k.set(a,c)});var h=[];k.forEach(function(a,b){h.push({stateMask:b,objects:a})});this._engineResources={objectsByState:h,layer:a,materials:b}}this._addResourcesToStage();return this._engineResources};
b.prototype._addResourcesToStage=function(){var a=this;if(!this._engineResourcesAddedToStage&&!m.isNone(this._engineResources)){var b=this._engineResources,c=b.objectsByState,d=b.layer;b.materials.forEach(function(b){var c=m.expect(a._materialIdReferences),e=c.get(b.id)||0;0===e&&a.view._stage.add(t.ContentType.MATERIAL,b);c.set(b.id,e+1)});c.forEach(function(b){b.objects.forEach(function(b){d.addObject(b);a.view._stage.add(t.ContentType.OBJECT,b)})});this._engineResourcesAddedToStage=!0}};b.prototype._removeResourcesFromStage=
function(a){var b=this;void 0===a&&(a=!1);if(this._engineResourcesAddedToStage&&!m.isNone(this._engineResources)){var c=this._engineResources,d=c.layer,k=c.materials;c.objectsByState.forEach(function(a){a.objects.forEach(function(a){d.removeObject(a);b.view._stage.remove(t.ContentType.OBJECT,a.id)})});k.forEach(function(a){var c=m.expect(b._materialIdReferences),e=c.get(a.id);1===e?(b.view._stage.remove(t.ContentType.MATERIAL,a.id),c.delete(a.id)):c.set(a.id,e-1)});a&&this.view._stage.remove(t.ContentType.LAYER,
d.id);this._engineResourcesAddedToStage=!1}};b.prototype._getCollisionRadius=function(a){return this._getFocusedSize(this._radius,!0)*("touch"===a?this._touchMultiplier:1)};b.prototype._getFocusedSize=function(a,b){return a*(b?this._focusMultiplier:1)};b.prototype._getWorldToScreenObjectScale=function(){return this._worldSized?1:this._screenPixelSize};b.prototype._calculateModelTransformPosition=function(a){var b=this._getWorldToScreenObjectScale(),b=this._calculateObjectTransform(b,ea);return n.vec3.set(a,
b[12],b[13],b[14])};b.prototype._calculateModelTransformOffset=function(a){var b=this._calculateModelTransformPosition(a);return n.vec3.subtract(a,b,this._position)};b.prototype._calculateObjectTransform=function(a,b){z.mat4.set(b,a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1);z.mat4.multiply(b,b,this._modelTransform);b[12]+=this._position[0];b[13]+=this._position[1];b[14]+=this._position[2];b[15]=1;return b};d([c.property({constructOnly:!0,nonNullable:!0})],b.prototype,"view",void 0);d([c.property({value:"none",
nonNullable:!0})],b.prototype,"alignment",null);d([c.property()],b.prototype,"hideOnGrab",void 0);d([c.property()],b.prototype,"moveOnDrag",void 0);d([c.property()],b.prototype,"snapToPointer",void 0);d([c.property()],b.prototype,"collisionType",void 0);d([c.property({type:V.Integer})],b.prototype,"collisionPriority",void 0);d([c.property({constructOnly:!0})],b.prototype,"renderObjects",void 0);d([c.property()],b.prototype,"autoScaleRenderObjects",void 0);d([c.property({value:!0})],b.prototype,"visible",
null);d([c.property()],b.prototype,"radius",null);d([c.property()],b.prototype,"worldSized",null);d([c.property()],b.prototype,"focusMultiplier",null);d([c.property()],b.prototype,"touchMultiplier",null);d([c.property()],b.prototype,"interactive",void 0);d([c.property()],b.prototype,"selectable",void 0);d([c.property({value:!1})],b.prototype,"grabbing",null);d([c.property()],b.prototype,"dragging",void 0);d([c.property({value:!1})],b.prototype,"hovering",null);d([c.property({value:!1})],b.prototype,
"selected",null);d([c.property({value:0})],b.prototype,"state",null);d([c.property({dependsOn:["hovering","grabbing"]})],b.prototype,"focused",null);return b=d([c.subclass("esri.views.interactive.Manipulator3D")],b)}(c.declared(T));D.Manipulator3D=u;var Q={include:new Set};Q.include.add(aa.TERRAIN_ID);var J=q.createScreenPointArray(),I=q.createRenderScreenPointArray3(),M=p.lineSegment.create(),B=p.ray.create(),N=W.mat3f64.create(),ea=A.mat4f64.create(),x=A.mat4f64.create(),y=p.plane.create(),K=r.vec3f64.create(),
L=r.vec3f64.create(),C=r.vec3f64.create(),O=r.vec3f64.create(),P=r.vec3f64.create(),da=r.vec3f64.create(),R=r.vec3f64.create()});