// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/has ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/buffer/InterleavedLayout ../lib/GLMaterialTexture ../lib/Material ../lib/Util ./internal/bufferWriters ./internal/MaterialUtil ./internal/MaterialUtil ./renderers/InstancedRenderer ./renderers/MergedRenderer ../shaders/DefaultPrograms ../../../webgl/renderState".split(" "),
function(p,U,m,V,z,E,k,l,A,n,F,G,H,q,f,I,J,r,h){function t(e,a){var b=a.vvSizeEnabled;a.vvSizeEnabled?(e.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",a.vvSizeOffset),e.setUniform3fv("vvSizeFactor",a.vvSizeFactor)):b&&e.setUniform3fv("vvSizeValue",a.vvSizeValue);b&&(e.setUniform3fv("vvSymbolAnchor",a.vvSymbolAnchor),e.setUniformMatrix3fv("vvSymbolRotationMatrix",a.vvSymbolRotationMatrix));a.vvColorEnabled&&(e.setUniform1fv("vvColorValues",
a.vvColorValues),e.setUniform4fv("vvColorColors",a.vvColorColors))}var w=G.assert;p=function(e){function a(b,c){c=e.call(this,c)||this;c.supportsEdges=!0;c.params=f.copyParameters(b,K);c.vertexBufferLayout=a.getVertexBufferLayout(c.params);c.instanceBufferLayout=b.instanced?a.getInstanceBufferLayout(c.params):null;c.textureMode=c.vertexBufferLayout.hasField("uv0")?"Textured":"none";return c}m(a,e);a.prototype.isVisibleInPass=function(b){return 3===b?this.params.castShadows:!0};a.prototype.isVisible=
function(){var b=this.params;if(!e.prototype.isVisible.call(this)||0===b.layerOpacity)return!1;var c=b.instanced,a=b.vertexColors,d=b.symbolColors,c=!!c&&-1<c.indexOf("color"),f=b.vvColorEnabled,h="replace"===b.colorMixMode,k=0<b.opacity,b=b.externalColor&&0<b.externalColor[3];return a&&(c||f||d)?h?!0:k:a?h?b:k:c||f||d?h?!0:k:h?b:k};a.prototype.setParameterValues=function(b){var c=this.params,a;for(a in b)"instanced"===a&&w(b.instanced===c.instanced,"Can not change instanced attributes"),"textureId"===
a&&w(c.textureId,"Can only change texture of material that already has a texture"),"vertexColors"===a&&!0===b[a]&&b[a]!==c[a]&&w(c.vertexColors,"Can not enable vertex colors after DefaultMaterial creation"),c[a]=b[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(b,c,a,d,e,h,l,m){if(null!==this.params.verticalOffset){m=d.camera;k.vec3.set(x,a[12],a[13],a[14]);var g=k.vec3.subtract(L,x,m.eye),B=k.vec3.length(g),p=k.vec3.scale(g,
g,1/B),n=null,g=null;switch(d.viewingMode){case "global":g=k.vec3.normalize(C,x);break;case "local":g=k.vec3.copy(C,M)}this.params.screenSizePerspective&&(n=k.vec3.dot(g,p));m=f.verticalOffsetAtDistance(m,B,this.params.verticalOffset,n,this.params.screenSizePerspective);k.vec3.scale(g,g,m);k.vec3.transformMat3(y,g,d.transform.inverseRotation);e=k.vec3.subtract(N,e,y);h=k.vec3.subtract(O,h,y)}f.intersectTriangleGeometry(b,c,a,d,e,h,l)};a.prototype.getGLMaterials=function(){return{color:P,depthShadowMap:Q,
normal:R,depth:D,highlight:S}};a.prototype.createRenderer=function(b,c){return this.params.softwareInstanced?new I(b,c,this):new J(b,c,this)};a.prototype.createBufferWriter=function(){return new T(this.vertexBufferLayout,this.instanceBufferLayout)};a.getVertexBufferLayout=function(b){var c=b.textureId||b.normalTextureId||b.metallicRoughnessTextureId||b.emissiveTextureId||b.occlusionTextureId,a=A.newLayout().vec3f("position").vec3f("normal");b.vertexTangents&&a.vec4f("aTangent");c&&a.vec2f("uv0");
b.vertexColors&&a.vec4u8("color");b.symbolColors&&a.vec4u8("symbolColor");return a};a.getInstanceBufferLayout=function(b){var c=A.newLayout(),c=b.instancedDoublePrecision?c.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):c.mat4f("model").mat4f("modelNormal");b.instanced&&-1<b.instanced.indexOf("color")&&(c=c.vec4f("instanceColor"));b.instanced&&-1<b.instanced.indexOf("featureAttribute")&&(c=c.vec4f("instanceFeatureAttribute"));return c};return a}(F);var P=function(e){function a(b,
c,a){var d=this,g=b.getParameters(),d=e.call(this,b,c,a,g.textureId,g.normalTextureId,g.emissiveTextureId,g.occlusionTextureId,g.metallicRoughnessTextureId,g.textureInitTransparent)||this;d.params=f.copyParameters(g);c=d.params;d.slot=c.transparent?c.writeDepth?7:10:5;d.textureMode=b.textureMode;b=c.instanced;d.instanced=!!b;d.instancedColor=!!b&&-1<b.indexOf("color");d._createPrograms();d.selectPipeline();return d}m(a,e);a.prototype._createPrograms=function(){var b=this;this.programs=q.BindParametersMap.create(this.params,
function(c){return b._createProgram(c)})};a.prototype._createProgram=function(b){var c=this.params;return this.programRep.getProgram(r.colorPass,{treeRendering:!!c.treeRendering,textureMode:this.textureMode,normalTexture:!!c.normalTextureId,colorTexture:!!c.textureId,tangents:c.vertexTangents?"vertex":"none",vertexColors:c.vertexColors,symbolColors:c.symbolColors,flipV:c.flipV,doubleSided:c.doubleSided&&"normal"===c.doubleSidedType,windowOrderDoubleSided:c.doubleSided&&"winding-order"===c.doubleSidedType,
instanced:!!this.instanced,instancedDoublePrecision:c.instancedDoublePrecision,instancedColor:this.instancedColor,receiveShadows:b.receiveShadows,receiveSSAO:b.receiveSSAO,vvSize:c.vvSizeEnabled,vvColor:c.vvColorEnabled,verticalOffset:null!==c.verticalOffset,screenSizePerspective:null!==c.screenSizePerspective,slice:c.slicePlaneEnabled,sliceHighlightDisabled:c.sliceHighlightDisabled,normals:c.normals,textureAlphaMode:c.textureAlphaMode,textureAlphaPremultiplied:!!c.textureAlphaPremultiplied,iosSafariFix:u,
roughnessMetallnessTexture:!!c.metallicRoughnessTextureId,emissionTexture:!!c.emissiveTextureId,occlusionTexture:!!c.occlusionTextureId,usePBR:c.usePBR})};a.prototype.selectPipeline=function(){var b=this.params;this.pipelineState=h.makePipelineState({blending:b.transparent&&h.separateBlendingParams(770,1,771,771),culling:v(b),depthTest:{func:513},depthWrite:b.writeDepth&&h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=
function(){return this.program||this.getPrograms()[0]};a.prototype.getPrograms=function(){return q.BindParametersMap.programs(this.programs)};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.slot=this.params.transparent?this.params.writeDepth?7:10:5;this.updateTexture(this.params.textureId);this._createPrograms();this.selectPipeline()};a.prototype.bind=function(b,c){var a=this.params,d=this.program=q.BindParametersMap.lookup(this.programs,c);
b.bindProgram(d);b.setPipelineState(this.pipelineState);d.setUniform3fv("ambient",a.ambient);d.setUniform3fv("diffuse",a.diffuse);d.setUniform3fv("specular",a.specular);d.setUniform4fv("externalColor",a.externalColor);d.setUniform1i("colorMixMode",f.colorMixModes[a.colorMixMode]);a.usePBR&&(d.setUniform1f("metalnessFactor",a.metallicFactor),d.setUniform1f("roughnessFactor",a.roughnessFactor),d.setUniform3fv("emissionFactor",a.emissiveFactor));d.setUniform1f("opacity",a.opacity);d.setUniform1f("layerOpacity",
a.layerOpacity);f.bindVerticalOffset(a.verticalOffset,c,d);f.bindScreenSizePerspective(a.screenSizePerspective,d);t(d,a);this.bindTexture(b,d);"none"!==this.textureMode&&this.bindTextureSize(b,d);"mask"!==a.textureAlphaMode&&"maskBlend"!==a.textureAlphaMode||d.setUniform1f("textureAlphaCutoff",a.textureAlphaCutoff)};a.prototype.release=function(b,c){};a.prototype.bindView=function(b,c){b=this.program=q.BindParametersMap.lookup(this.programs,c);var a=this.params,d=a.instancedDoublePrecision?l.vec3f64.fromValues(c.viewInvTransp[3],
c.viewInvTransp[7],c.viewInvTransp[11]):c.origin;f.bindView(d,c.view,b);f.bindCamPos(d,c.viewInvTransp,b);a.instancedDoublePrecision&&f.bindViewOriginDouble(d,b);a.slicePlaneEnabled&&f.bindSlicePlane(d,c.slicePlane,b);c.shadowMappingEnabled&&c.shadowMap.bindView(b,d)};a.prototype.bindInstance=function(b,c){b=this.program;b.setUniformMatrix4fv("model",c.transformation);b.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return 4};return a}(n),D=function(e){function a(b,
c,a,d){void 0===d&&(d=!1);c=e.call(this,b,c,a,b.getParameters().textureId)||this;c.textureMode=b.textureMode;c.biased=d;c.updateParameters();return c}m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(r.depthPass,{textureMode:this.textureMode,normalTexture:!!b.normalTextureId,colorTexture:!!b.textureId,tangents:b.vertexTangents?"vertex":
"none",flipV:b.flipV,instanced:!!b.instanced,instancedDoublePrecision:b.instancedDoublePrecision,shadowMap:this.biased,vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,textureAlphaMode:b.textureAlphaMode,normals:b.normals,iosSafariFix:u});this.pipelineState=h.makePipelineState({culling:v(b),depthTest:{func:513},depthWrite:b.writeDepth&&h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=
function(){this.slot=this.params.transparent?this.params.writeDepth?7:10:5};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(b,c){var a=this.program,d=this.params;b.bindProgram(a);b.setPipelineState(this.pipelineState);a.setUniform2fv("nearFar",c.nearFar);f.bindVerticalOffset(d.verticalOffset,c,a);f.bindScreenSizePerspective(d.screenSizePerspective,
a);t(a,d);"mask"!==d.textureAlphaMode&&"maskBlend"!==d.textureAlphaMode||a.setUniform1f("textureAlphaCutoff",d.textureAlphaCutoff);this.bindTexture(b,a)};a.prototype.release=function(b){};a.prototype.bindView=function(b,c){b=this.program;var a=this.params,d=a.instancedDoublePrecision?l.vec3f64.fromValues(c.viewInvTransp[3],c.viewInvTransp[7],c.viewInvTransp[11]):c.origin;f.bindView(d,c.view,b);a.slicePlaneEnabled&&f.bindSlicePlane(d,c.slicePlane,b);a.screenSizePerspective&&f.bindCamPos(d,c.viewInvTransp,
b);a.instancedDoublePrecision&&f.bindViewOriginDouble(d,b)};a.prototype.bindInstance=function(b,a){this.program.setUniformMatrix4fv("model",a.transformation)};a.prototype.getDrawMode=function(){return 4};return a}(n),Q=function(e){function a(b,a,g){return e.call(this,b,a,g,!0)||this}m(a,e);return a}(D),R=function(e){function a(b,a,g){a=e.call(this,b,a,g,b.getParameters().textureId)||this;a.params=f.copyParameters(b.getParameters());a.textureMode=b.textureMode;a.selectProgram();a.selectSlot();return a}
m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(r.normalPass,{textureMode:this.textureMode,normalTexture:!!b.normalTextureId,colorTexture:!!b.textureId,tangents:b.vertexTangents?"vertex":"none",flipV:b.flipV,instanced:!!b.instanced,instancedDoublePrecision:b.instancedDoublePrecision,vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,
screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,textureAlphaMode:b.textureAlphaMode,normals:b.normals,iosSafariFix:u});this.pipelineState=h.makePipelineState({culling:v(b),depthTest:{func:513},depthWrite:b.writeDepth&&h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?this.params.writeDepth?7:10:5};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());
this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);this.bindTexture(b,c);f.bindVerticalOffset(d.verticalOffset,a,c);f.bindScreenSizePerspective(d.screenSizePerspective,c);t(c,d);"mask"!==d.textureAlphaMode&&"maskBlend"!==d.textureAlphaMode||c.setUniform1f("textureAlphaCutoff",d.textureAlphaCutoff)};a.prototype.release=function(b){};a.prototype.bindView=
function(b,a){b=this.program;var c=this.params,d=c.instancedDoublePrecision?l.vec3f64.fromValues(a.viewInvTransp[3],a.viewInvTransp[7],a.viewInvTransp[11]):a.origin;f.bindView(d,a.view,b);b.setUniformMatrix4fv("viewNormal",a.viewInvTransp);c.slicePlaneEnabled&&f.bindSlicePlane(d,a.slicePlane,b);c.screenSizePerspective&&f.bindCamPos(d,a.viewInvTransp,b);c.instancedDoublePrecision&&f.bindViewOriginDouble(d,b)};a.prototype.bindInstance=function(b,a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);
b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.getDrawMode=function(){return 4};return a}(n),S=function(e){function a(b,a,g){a=e.call(this,b,a,g,b.getParameters().textureId)||this;a.textureMode=b.textureMode;a.updateParameters();return a}m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(r.highlightPass,{textureMode:this.textureMode,
normalTexture:!!b.normalTextureId,colorTexture:!!b.textureId,tangents:b.vertexTangents?"vertex":"none",flipV:b.flipV,instanced:!!b.instanced,instancedDoublePrecision:b.instancedDoublePrecision,vvSize:b.vvSizeEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,slice:b.slicePlaneEnabled,textureAlphaMode:b.textureAlphaMode,normals:b.normals,iosSafariFix:u});this.pipelineState=h.makePipelineState({culling:v(b),depthTest:{func:513},depthWrite:b.writeDepth&&
h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?this.params.writeDepth?7:10:5};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot();this.updateTexture(this.params.textureId)};a.prototype.bind=function(b,a){var c=this.program,d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);f.bindHighlightRendering(b,a,c);this.bindTexture(b,
c);f.bindVerticalOffset(d.verticalOffset,a,c);f.bindScreenSizePerspective(d.screenSizePerspective,c);t(c,d);"mask"!==d.textureAlphaMode&&"maskBlend"!==d.textureAlphaMode||c.setUniform1f("textureAlphaCutoff",d.textureAlphaCutoff)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params,d=c.instancedDoublePrecision?l.vec3f64.fromValues(a.viewInvTransp[3],a.viewInvTransp[7],a.viewInvTransp[11]):a.origin;f.bindView(d,a.view,b);c.slicePlaneEnabled&&f.bindSlicePlane(d,
a.slicePlane,b);c.screenSizePerspective&&f.bindCamPos(d,a.viewInvTransp,b);c.instancedDoublePrecision&&f.bindViewOriginDouble(d,b)};a.prototype.bindInstance=function(a,c){a=this.program;a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return 4};return a}(n);(p||(p={})).COLOR_GAMMA=2.1;var K={textureId:void 0,textureInitTransparent:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,
emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],metallicFactor:0,roughnessFactor:.75,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,softwareInstanced:!1,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,castShadows:!0,verticalOffset:null,screenSizePerspective:null,
slicePlaneEnabled:!1,sliceHighlightDisabled:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:E.mat3f64.create(),transparent:!1,writeDepth:!0,textureAlphaMode:"blend",textureAlphaCutoff:.1,textureAlphaPremultiplied:!1},T=function(){function e(a,
b){this.vertexBufferLayout=a;this.instanceBufferLayout=b}e.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};e.prototype.elementCount=function(a){return a.indices.position.length};e.prototype.write=function(a,b,c,e){H.writeDefaultAttributes(b,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,c,e)};return e}(),v=function(e){var a;a=e.cullFace?"none"!==e.cullFace:e.slicePlaneEnabled?!1:!e.transparent&&!e.doubleSided;return a&&{face:"front"===e.cullFace?
1028:1029,mode:2305}},u=!!z("ios")&&!!z("safari"),N=l.vec3f64.create(),O=l.vec3f64.create(),M=l.vec3f64.fromValues(0,0,1),C=l.vec3f64.create(),y=l.vec3f64.create(),x=l.vec3f64.create(),L=l.vec3f64.create();return p});