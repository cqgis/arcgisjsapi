// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Error ../../../../core/lang ../../../../core/Logger ./LEPCC".split(" "),function(D,h,l,n,z,u){function A(a,b,d){for(var g="",f=0;f<d;){var c=a[b+f];if(128>c)g+=String.fromCharCode(c),f++;else if(192<=c&&224>c){if(f+1>=d)throw new l("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var e=a[b+f+1],c=(c&31)<<6|e&63,g=g+String.fromCharCode(c),f=f+2}else if(224<=c&&240>c){if(f+2>=d)throw new l("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");
var e=a[b+f+1],k=a[b+f+2],c=(c&15)<<12|(e&63)<<6|k&63,g=g+String.fromCharCode(c),f=f+3}else if(240<=c&&248>c){if(f+3>=d)throw new l("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");e=a[b+f+1];k=a[b+f+2];c=(c&7)<<18|(e&63)<<12|(k&63)<<6|a[b+f+3]&63;g=65536<=c?g+String.fromCharCode((c-65536>>10)+55296,(c&1023)+56320):g+String.fromCharCode(c);f+=4}else throw new l("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");}return g}function p(a,b){for(var d=
{byteOffset:0,byteCount:0,fields:Object.create(null)},g=0,f=0;f<b.length;f++){var c=b[f],e=c.valueType||c.type;d.fields[c.property]=(0,h.valueType2ArrayBufferReader[e])(a,g);g+=h.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT}d.byteCount=g;return d}function v(a,b,d){var g=[],f,c=0,e;for(e=0;e<a;e+=1){f=b[e];if(0<f){if(g.push(A(d,c,f-1)),0!==d[c+f-1])throw new l("string-array-error","Invalid string array: missing null termination.");}else g.push(null);c+=f}return g}function q(a,b){return new h.valueType2TypedArrayClassMap[b.valueType](a,
b.byteOffset,b.count*b.valuesPerElement)}function w(a,b){return new Uint8Array(a,b.byteOffset,b.byteCount)}function x(a,b,d){a=null!=b.header?p(a,b.header):{byteOffset:0,byteCount:0,fields:{count:d}};d={header:a,byteOffset:a.byteCount,byteCount:0,entries:Object.create(null)};for(var g=a.byteCount,f=0;f<b.ordering.length;f++){var c=b.ordering[f],e=n.clone(b[c]);e.count=a.fields.count;if("String"===e.valueType){if(e.byteOffset=g,e.byteCount=a.fields[c+"ByteCount"],"UTF-8"!==e.encoding)throw new l("unsupported-encoding",
"Unsupported String encoding.",{encoding:e.encoding});}else if(r(e.valueType)){var k=m(e.valueType),g=g+(0!==g%k?k-g%k:0);e.byteOffset=g;e.byteCount=k*e.valuesPerElement*e.count}else throw new l("unsupported-value-type","Unsupported binary valueType",{valueType:e.valueType});g+=e.byteCount;d.entries[c]=e}d.byteCount=g-d.byteOffset;return d}function y(a,b,d){b!==a&&t.error("Invalid "+d+" buffer size\n expected: "+a+", actual: "+b+")");if(b<a)throw new l("buffer-too-small","Binary buffer is too small",
{expectedSize:a,actualSize:b});}function r(a){return h.valueType2TypedArrayClassMap.hasOwnProperty(a)}function m(a){return r(a)?h.valueType2TypedArrayClassMap[a].BYTES_PER_ELEMENT:0}Object.defineProperty(h,"__esModule",{value:!0});var t=z.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");h.readHeader=p;h.readStringArray=v;h.createTypedView=q;h.createRawView=w;h.createAttributeDataIndex=x;h.createGeometryIndexFromDefinition=function(a,b,d){for(var g={header:{byteOffset:0,byteCount:a.offset,fields:{}},
byteOffset:a.offset,byteCount:0,vertexAttributes:{},featureAttributes:{}},f=a.offset,c=function(b,a,c,d){var e="UInt64"===a.type?8:m(a.type);a={byteOffset:f,byteCount:e*a.component*c,count:c,valueType:a.type,valuesPerElement:a.component};f+=a.byteCount;d[b]=a},e=0,k=B;e<k.length;e++){var h=k[e];a[h[0]]&&c(h[1],a[h[0]],b,g.vertexAttributes)}b=0;for(e=C;b<e.length;b++)k=e[b],a[k[0]]&&c(k[1],a[k[0]],d,g.featureAttributes);return g};var B=[["position","position"],["normal","normal"],["uv0","uv0"],["uv1",
"uv1"],["color","color"],["uvRegion","region"]],C=[["featureId","id"],["faceRange","faceRange"]];h.createGeometryIndexFromSchema=function(a,b){for(var d=p(a,b&&b.header),g=d.byteCount,f={header:d,byteOffset:d.byteCount,byteCount:0,vertexAttributes:n.clone(b.vertexAttributes)},c=f.vertexAttributes,e=d.fields,k=null!=e.vertexCount?e.vertexCount:e.count,d=0;d<b.ordering.length;d++){var h=b.ordering[d];null!=c[h]&&(c[h].byteOffset=g,c[h].count=k,g+=m(c[h].valueType)*c[h].valuesPerElement*k)}c=e.faceCount;
if(b.faces&&c)for(f.faces=n.clone(b.faces),k=f.faces,d=0;d<b.ordering.length;d++)h=b.ordering[d],null!=k[h]&&(k[h].byteOffset=g,k[h].count=c,g+=m(k[h].valueType)*k[h].valuesPerElement*c);e=e.featureCount;if(b.featureAttributes&&b.featureAttributeOrder&&e)for(f.featureAttributes=n.clone(b.featureAttributes),c=f.featureAttributes,d=0;d<b.featureAttributeOrder.length;d++)k=b.featureAttributeOrder[d],c[k].byteOffset=g,c[k].count=e,h=m(c[k].valueType),"UInt64"===c[k].valueType&&(h=8),g+=h*c[k].valuesPerElement*
e;y(g,a.byteLength,"geometry");f.byteCount=g-f.byteOffset;return f};h.readBinaryAttribute=function(a,b,d){if("lepcc-rgb"===a.encoding)return u.decodeRGB(b);if("lepcc-intensity"===a.encoding)return u.decodeIntensity(b);if(null!=a.encoding&&""!==a.encoding)throw new l("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");a["attributeByteCounts "]&&!a.attributeByteCounts&&(t.warn("Warning: Trailing space in 'attributeByteCounts '."),a.attributeByteCounts=a["attributeByteCounts "]);
"ObjectIds"===a.ordering[0]&&a.hasOwnProperty("objectIds")&&(t.warn("Warning: Case error in objectIds"),a.ordering[0]="objectIds");d=x(b,a,d);y(d.byteOffset+d.byteCount,b.byteLength,"attribute");if(a=d.entries.attributeValues||d.entries.objectIds){if("String"===a.valueType){d=d.entries.attributeByteCounts;var g=q(b,d);b=w(b,a);return v(d.count,g,b)}return q(b,a)}throw new l("bad-attribute-storage-info","Bad attributeStorageInfo specification.");};h.valueType2TypedArrayClassMap={Float32:Float32Array,
Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array};h.valueType2ArrayBufferReader={Float32:function(a,b){return(new DataView(a,0)).getFloat32(b,!0)},Float64:function(a,b){return(new DataView(a,0)).getFloat64(b,!0)},UInt8:function(a,b){return(new DataView(a,0)).getUint8(b)},Int8:function(a,b){return(new DataView(a,0)).getInt8(b)},UInt16:function(a,b){return(new DataView(a,0)).getUint16(b,!0)},Int16:function(a,b){return(new DataView(a,
0)).getInt16(b,!0)},UInt32:function(a,b){return(new DataView(a,0)).getUint32(b,!0)},Int32:function(a,b){return(new DataView(a,0)).getInt32(b,!0)}};h.isValueType=r;h.getBytesPerValue=m});