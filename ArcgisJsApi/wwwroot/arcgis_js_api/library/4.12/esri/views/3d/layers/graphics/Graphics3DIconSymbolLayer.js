// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/asyncUtils ../../../../core/compilerUtils ../../../../core/Error ../../../../core/has ../../../../core/lang ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/utils ./constants ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./sdfPrimitives ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(n,x,J,K,C,D,L,M,N,y,O,P,k,Q,r,R,S,z,g,T,U,V,W,X,Y,Z,p,aa,u,q,v,ba,w,ca,E,da,ea,F){function A(g){return k.isSome(g)?"cross"===g||"x"===g:!1}Object.defineProperty(x,"__esModule",{value:!0});var G=S.mat4f64.create(),H=g.vec3f64.fromValues(0,0,1),fa=[.25,.25,.75,.75],ga=[64,64];n=function(n){function d(a,b,c,f){a=n.call(this,a,b,c,f)||this;a._size=null;a._symbolTextureRatio=1;a._outlineSize=0;a._texture=null;a._drapedMaterial=null;a._releaseTexture=null;a._elevationOptions={supportsOffsetAdjustment:!0,
supportsOnTheGround:!0};return a}K(d,n);d.prototype.getCachedSize=function(){return{size:this._getIconSize()}};d.prototype.doLoad=function(a){return D(this,void 0,void 0,function(){var b,c;return C(this,function(f){switch(f.label){case 0:this._validateOrThrow();b=this._prepareMaterialParameters();c=this._getPrimitive();if(!k.isSome(c))return[3,1];this._prepareResourcesPrimitive(b,c);return[3,3];case 1:return[4,this._prepareResourcesHref(b,a)];case 2:f.sent(),f.label=3;case 3:return[2]}})})};d.prototype._validateOrThrow=
function(){if(!this._isPropertyDriven("size")){var a=u.validateSymbolLayerSize(this._getIconSize());if(a)throw new y("graphics3diconsymbollayer:invalid-size",a);}};d.prototype._getIconSize=function(){var a=this.symbolLayer,a=Math.round(null!=a.size?r.pt2px(a.size):16);return this._isPropertyDriven("size")?Math.max(a,64):a};d.prototype._prepareMaterialParameters=function(){var a={anchorPos:this._getAnchorPos()},b=this.symbol;if(this._hasVisibleVerticalOffset(b)){var b=b.verticalOffset,c=b.minWorldLength,
f=b.maxWorldLength;a.verticalOffset={screenLength:r.pt2px(b.screenLength),minWorldLength:c||0,maxWorldLength:null!=f?f:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);return a};d.prototype._prepareResourcesPrimitive=function(a,b){var c=this,f=this._getOutlineSize();if(A(b)&&0===f)throw Error("Nothing to render");this._outlineSize=f;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=
this._outlineSize;var d=this._context.sharedResources.textures.fromData(b,function(){var a;switch(b){case "circle":a=q.createCircle(128,64);break;case "square":a=q.createSquare(128,64);break;case "kite":a=q.createKite(128,64);break;case "cross":a=q.createCross(128,64);break;case "x":a=q.createX(128,64);break;case "triangle":a=q.createTriangle(128,64);break;default:N.neverReached(b)}return new ea(a,"sdf_"+b,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})});this._texture=
d.texture;this._releaseTexture=function(){return c._context.sharedResources.textures.release(d.uid)};a.textureIsSignedDistanceField=!0;a.distanceFieldBoundingBox=fa;a.textureId=this._texture.id;f=this._getIconSize();this._size=[f,f];this._symbolTextureRatio=2;this._createMaterialsAndAddToStage(a,this._context.stage)};d.prototype._prepareResourcesHref=function(a,b){return D(this,void 0,void 0,function(){var c,f,d,l,e,t,I,m,B,g,k=this;return C(this,function(h){switch(h.label){case 0:c=V.getIconHref(this.symbol,
this.symbolLayer);if(!O("esri-canvas-svg-support")&&R.isSVG(c))throw f="IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)",new y("graphics3diconsymbollayer:unsupported-image-format",f);this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=!1;d=this._getIconSize();l=d*this._context.layerView.view.pixelRatio;return[4,M.result(this._context.sharedResources.textures.fromUrl(c,
l,{signal:b}))];case 1:e=h.sent();if(!1===e.ok)throw Q.throwIfAbortError(e.error),f="Failed to load (Request for icon resource failed: "+c+")",new y("graphics3diconsymbollayer:request-failed",f);t=e.value;I=t.uid;m=t.texture;this._releaseTexture=function(){return k._context.sharedResources.textures.release(I)};B=m.params;g=B.width/B.height;this._size=1<g?[d,Math.round(d/g)]:[Math.round(d*g),d];a.textureId=m.id;this._createMaterialsAndAddToStage(a,this._context.stage);return[2]}})})};d.prototype._getPrimitive=
function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||U.defaultPrimitive};d.prototype._getOutlineSize=function(){var a=0,a=this.symbolLayer;if(k.isSome(a.outline)&&null!=a.outline.size)return Math.max(r.pt2px(a.outline.size),0);a=this._getPrimitive();a=A(a)?1.5:0;return Math.max(a,0)};d.prototype._getOutlineColor=function(){var a=this._getLayerOpacity(),b=k.get(this.symbolLayer,"outline","color");if(k.isSome(b)){var c=
L.toUnitRGB(b);return[c[0],c[1],c[2],b.a*a]}return[0,0,0,0]};d.prototype._getFillColor=function(){if(A(this._getPrimitive()))return W.TRANSPARENT;var a=k.isNone(this._getPrimitive()),b=k.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(b,{hasIntrinsicColor:a})};d.prototype._getAnchorPos=function(){var a=this.symbolLayer.anchor,b=this.symbolLayer.anchorPosition;return"relative"===a?z.vec2f64.fromValues((b.x||0)+.5,-(b.y||0)+.5):a in u.namedAnchorToHUDMaterialAnchorPos?
u.namedAnchorToHUDMaterialAnchorPos[a]:u.namedAnchorToHUDMaterialAnchorPos.center};d.prototype._createMaterialsAndAddToStage=function(a,b){this._fastUpdates=v.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&P.mixin(a,this._fastUpdates.materialParameters);var c=J({},a);c.verticalOffset=null;c.screenSizePerspective=null;c.occlusionTest=!1;c.slicePlaneEnabled=!1;c.shaderPolygonOffset=0;var d=this._getStageIdHint();this._drapedMaterial=
new F(c,d+"_iconDraped");b.add(w.ModelContentType.MATERIAL,this._drapedMaterial);a.occlusionTest=!0;a.slicePlaneEnabled=this._context.slicePlaneEnabled;this._material=new F(a,d+"_icon");b.add(w.ModelContentType.MATERIAL,this._material)};d.prototype.destroy=function(){n.prototype.destroy.call(this);this._material&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._material.id),this._material=null);this._drapedMaterial&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._drapedMaterial.id),
this._drapedMaterial=null);this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)};d.prototype._getScaleFactor=function(a){if(this._isPropertyDriven("size")&&a.size){for(var b=0;3>b;b++){var c=a.size[b];c&&"symbolValue"!==c&&"proportional"!==c&&(a.size[b]=r.pt2px(c))}b=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/b;if(isFinite(+a.size[2]))return+a.size[2]/b}return 1};d.prototype.createGraphics3DGraphic=
function(a){var b=a.renderingInfo,c=a.graphic;if(!this._validateGeometry(c.geometry))return null;var d=p.placePointOnGeometry(c.geometry);if(k.isNone(d))return this.logger.warn("unsupported geometry type for icon symbol: "+c.geometry.type),null;var h="graphic"+c.uid,l=this._getVertexOpacityAndColor(b),e=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(e=this._getScaleFactor(b));e*=this._symbolTextureRatio;b=[this._size[0]*e,this._size[1]*e];e=this.getGraphicElevationContext(c);
return"on-the-ground"===e.mode?this._createAsOverlay(c,d,l,b,e,h,c.uid,a.layer.uid):this._createAs3DShape(c,d,l,b,e,h,c.uid)};d.prototype.layerOpacityChanged=function(){var a=this._getFillColor();this._drapedMaterial.setParameterValues({color:a});this._material.setParameterValues({color:a});a=this._getOutlineColor();this._drapedMaterial.setParameterValues({outlineColor:a});this._material.setParameterValues({outlineColor:a});return!0};d.prototype.layerElevationInfoChanged=function(a,b,c){var d=this._elevationContext.mode;
if("on-the-ground"===c&&"on-the-ground"===d)return!0;if(c!==d&&("on-the-ground"===c||"on-the-ground"===d))return!1;var h=p.needsElevationUpdates2D(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return h})};d.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};d.prototype.pixelRatioChanged=function(a,b){return this._getPrimitive()?!0:!1};d.prototype.applyRendererDiff=
function(a,b){for(var c in a.diff)switch(c){case "visualVariables":if(v.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))this._material.setParameterValues(this._fastUpdates.materialParameters),this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};d.prototype.setDrawOrder=function(a,b,c){this.updateSymbolLayerOrder(a,b);this._drapedMaterial&&(this._drapedMaterial.renderPriority=a,c.add(this._drapedMaterial.id))};
d.prototype._defaultElevationInfoNoZ=function(){return ha};d.prototype._createAs3DShape=function(a,b,c,d,h,l,e){var f=this,g=this.getFastUpdateAttrValues(a);a=g?function(a){return v.evaluateModelTransform(f._fastUpdates.materialParameters,g,a)}:null;c=E.createPointGeometry(H,null,c,d,ia,null,g);c=[new ca(c,l)];l=p.createStageObjectForPoint(this._context,b,c,[this._material],null,null,h,l,this._context.layer.uid,e,!0,a);if(null===l)return null;var m=new Z(this,l.object,c,null,null,X.perObjectElevationAligner,
h);m.alignedTerrainElevation=l.terrainElevation;m.needsElevationUpdates=p.needsElevationUpdates2D(h.mode)||"absolute-height"===h.mode;m.getScreenSize=this._createScreenSizeGetter(d,a);m.calculateRelativeScreenBounds=function(a){return f._material.calculateRelativeScreenBounds(m.getScreenSize(),1,a)};p.extendPointGraphicElevationContext(m,b,this._context.elevationProvider);return m};d.prototype._createAsOverlay=function(a,b,c,d,h,l,e,t){var f=this;this._drapedMaterial.renderPriority=this._symbolLayerOrder;
h=g.vec3f64.create();ba.pointToVector(b,h,this._context.overlaySR);h[2]=this._getDrapedZ();if((b=this._context.clippingExtent)&&!p.pointInBox2D(h,b))return null;var m=this.getFastUpdateAttrValues(a);b=m?function(a){return v.evaluateModelTransform(f._fastUpdates.materialParameters,m,a)}:null;c=E.createPointGeometry(H,h,c,d,null,null,m);e=new da(c);e.material=this._drapedMaterial;e.center=h;e.bsRadius=0;e.transformation=G;e.name=l;e.uniqueName=l+"#"+c.id;e.data.layerUid=t;e.data.graphicUid=a.uid;e.calculateShaderTransformation=
b;var k=new Y(this,[e],null);k.getScreenSize=this._createScreenSizeGetter(d,b);k.calculateRelativeScreenBounds=function(a){return f._drapedMaterial.calculateRelativeScreenBounds(k.getScreenSize(),1,a)};return k};d.prototype._createScreenSizeGetter=function(a,b){var c=this._outlineSize+2;if(this._fastUpdates.enabled){var d=a[0]/this._symbolTextureRatio,h=a[1]/this._symbolTextureRatio;return function(a){void 0===a&&(a=z.vec2f64.create());var e=b(G);a[0]=e[0]*d+c;a[1]=e[5]*h+c;return a}}var g=a[0]/this._symbolTextureRatio+
c,e=a[1]/this._symbolTextureRatio+c;return function(a){void 0===a&&(a=z.vec2f64.create());a[0]=g;a[1]=e;return a}};d.prototype._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1],b=g.vec3f64.fromValues(a,a,a),c=r.px2pt(1),a=a*c,a=g.vec3f64.fromValues(a,a,a);return{modelSize:b,symbolSize:a,unitInMeters:c,transformation:{anchor:g.vec3f64.ZEROS,scale:g.vec3f64.ONES,rotation:g.vec3f64.ZEROS}}};d.prototype._hasVisibleVerticalOffset=function(a){return this.symbol&&
"point-3d"===this.symbol.type&&this.symbol.hasVisibleVerticalOffset()};d.PRIMITIVE_SIZE=ga;return d}(aa.default);x.Graphics3DIconSymbolLayer=n;var ha={mode:"relative-to-ground",offset:0},ia=T.vec4f64.fromValues(0,0,0,1);x.default=n});