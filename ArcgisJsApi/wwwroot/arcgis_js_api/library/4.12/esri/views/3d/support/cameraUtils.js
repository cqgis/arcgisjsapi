// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Camera ../../../config ../../../core/Logger ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/support/scaleUtils ../camera/intersectionUtils ./cameraUtilsPlanar ./cameraUtilsSpherical ./earthUtils ./mathUtils ./projectionUtils ../webgl-engine/lib/Camera ../../support/spatialReferenceSupport".split(" "),
function(ia,g,ja,H,I,J,K,T,U,t,p,r,u,V,W,L,M,z,x,k,X,Y){function q(a){return"global"===a.viewingMode?M:L}function N(a,b,c){var d=a.renderSpatialReference,e=t.vec3.copy(Z,b.viewForward),e=O(a,b.eye,e,b.up,aa);a=a.spatialReference||u.WGS84;k.vectorToVector(b.eye,d,v,a)||(a=u.WGS84,k.vectorToVector(b.eye,d,v,a));if(!c)return new J(new r(v,a),e.heading,e.tilt,x.rad2deg(b.fov));c.position.x=v[0];c.position.y=v[1];c.position.z=v[2];c.position.spatialReference=a;c.heading=e.heading;c.tilt=e.tilt;c.fov=x.rad2deg(b.fov);
return c}function P(a,b,c){var d=a.state.camera,e=d.fovX,d=d.width/2/d.pixelRatio;"global"===a.viewingMode&&null!=c&&(b*=Math.cos(x.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return d/(39.37*K.screenDPI/b)/Math.tan(e/2)}function Q(a,b,c){var d=a.state.camera;b=39.37*K.screenDPI/(d.width/2/d.pixelRatio/(b*Math.tan(d.fovX/2)));"global"===a.viewingMode&&(b/=Math.cos(x.deg2rad(c)));return b*=a.renderCoordsHelper.unitInMeters}function R(a,b,c,d,e,f){if(w(f)){var l=F(f.signal);A(a,d.heading,d.tilt,
b,c,e,l);l.resolver.promise.then(function(b){return f.resolver.resolve(B(a,b,d.fov))},function(a){return f.resolver.reject(a)})}else return b=A(a,d.heading,d.tilt,b,c,e),B(a,b,d.fov,f)}function O(a,b,c,d,e){return q(a).directionToHeadingTilt(b,c,d,e)}function ba(a,b,c){return a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,y,a.spatialReference)&&a.basemapTerrain.getElevation(y)>y.z-1}function ca(a,b,c,d){return I(this,void 0,void 0,function(){var c;return H(this,function(e){switch(e.label){case 0:return a.renderCoordsHelper.fromRenderCoords(b,
y,a.spatialReference)?[4,a.elevationProvider.queryElevation(y,d)]:[2,!1];case 1:return c=e.sent(),[2,c>y.z-10]}})})}function da(a,b,c){return I(this,void 0,void 0,function(){var d,e;return H(this,function(f){switch(f.label){case 0:d=p.vec3f64.create();if(b)return[3,1];t.vec3.copy(d,a.state.camera.center);return[3,5];case 1:if(!(b instanceof r))return[3,4];k.pointToVector(b,d,a.renderSpatialReference);return null!=b.z||null==a.basemapTerrain?[3,3]:[4,a.elevationProvider.queryElevation(b,c)];case 2:return e=
f.sent(),null!=e&&a.renderCoordsHelper.setAltitude(e,d),[2,d];case 3:return[3,5];case 4:t.vec3.copy(d,b),f.label=5;case 5:return[2,d]}})})}function ea(a,b){var c=p.vec3f64.create();b&&b instanceof r?(k.pointToVector(b,c,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&(b=a.elevationProvider.getElevation(b),null!=b&&a.renderCoordsHelper.setAltitude(b,c))):b?t.vec3.copy(c,b):t.vec3.copy(c,a.state.camera.center);return c}function A(a,b,c,d,e,f,l){var n=d&&d instanceof r?d:null;if(w(l))da(a,
d,l.signal).then(function(d){G(a,b,c,n,d,e,f,l)},function(a){return l.resolver.reject(a)});else return d=ea(a,d),G(a,b,c,n,d,e,f,l)}function G(a,b,c,d,e,f,l,n){d||(d=k.vectorToPoint(e,a.renderSpatialReference,a.spatialReference||u.WGS84));f=Math.max(f,a.state.constraints.minimumPoiDistance);var h=fa(a,b,c,e,f,l),g=q(a).eyeForCenterWithHeadingTilt,m=g(e,f,h.heading,h.tilt);if(l===C.ADJUST&&"global"===a.viewingMode&&0<c){var r=function(){var h=f,g=f,m=a.state.constraints.tilt(g),g=q(a).eyeTiltToLookAtTilt(e,
g,c),g=Math.min(g,.5*Math.PI),m=m.min*(1-D)+g*D,h=q(a).lookAtTiltToEyeTilt(e,h,m);l=1>c-h?C.LOCKED:C.ADJUST;return G(a,b,h,d,e,f,l,n)};if(ba(a,m.eye,m.tilt))return r();if(w(n)){ca(a,m.eye,m.tilt,n.signal).then(function(a){if(a)return r();n.resolver.resolve({eye:m.eye,up:m.up,center:p.vec3f64.clone(e),heading:m.heading,tilt:m.tilt})});return}}h=!n||w(n)?{center:p.vec3f64.create(),eye:p.vec3f64.create(),up:p.vec3f64.create(),tilt:0,heading:0}:n;h.eye=m.eye;h.up=m.up;h.center=p.vec3f64.clone(e);h.heading=
m.heading;h.tilt=m.tilt;w(n)&&n.resolver.resolve(h);return h}function fa(a,b,c,d,e,f){var l=0;if(f=f===C.ADJUST)if(l=a.pointsOfInterest.centerOnSurfaceFrequent.distance,8<Math.log(e/l)/Math.LN2)f=!0;else{var g=a.renderSpatialReference,h=a.spatialReference||u.WGS84;f=k.vectorToPoint(d,g,h);g=k.vectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,g,h);l*=Math.tan(.5*a.state.camera.fov);f=5<g.distance(f)/l}f?(b=0,f=a.state.constraints.tilt(e),f.max=Math.min(f.max,.5*Math.PI),f=f.min*
(1-D)+f.max*D,c=q(a).eyeTiltToLookAtTilt(d,e,c),l=Math.min(c,f)):l=q(a).eyeTiltToLookAtTilt(d,e,c);c=l=a.state.constraints.clampTilt(e,l);c=q(a).lookAtTiltToEyeTilt(d,e,c);return{heading:b,tilt:c}}function B(a,b,c,d){a=k.vectorToPoint(b.eye,a.renderSpatialReference,a.spatialReference||u.WGS84);return a?d?(d.position=a,d.heading=b.heading,d.tilt=b.tilt,d.fov=c,d):new J(a,b.heading,b.tilt,c):null}function F(a){return{resolver:U.createResolver(),signal:a}}function w(a){return a&&"resolver"in a}Object.defineProperty(g,
"__esModule",{value:!0});var S=T.getLogger("esri.views.3d.support.cameraUtils"),v=p.vec3f64.create(),E=p.vec3f64.create(),Z=p.vec3f64.create(),aa={heading:0,tilt:0},y=new r,ga=new x.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),ha=new x.Cyclical(-180,180),C;(function(a){a[a.LOCKED=0]="LOCKED";a[a.ADJUST=1]="ADJUST"})(C=g.OrientationMode||(g.OrientationMode={}));g.headingTiltToDirectionUp=function(a,b,c,d,e){return q(a).headingTiltToDirectionUp(b,c,d,e)};g.externalToInternal=function(a,b){var c=
a.renderSpatialReference,d=q(a).headingTiltToDirectionUp,e=p.vec3f64.create();if(!k.pointToVector(b.position,e,c))return null;c=d(e,b.heading,b.tilt);t.vec3.scale(c.direction,c.direction,a.state.camera.distance);t.vec3.add(c.direction,c.direction,e);a=W.cameraOnContentAlongViewDirection(a,e,c.direction,c.up);a.fov=x.deg2rad(b.fov);return a};g.internalToExternal=N;g.scaleToDistance=P;g.distanceToScale=Q;g.fromCenterScale=function(a,b,c,d,e,f){c=P(a,c,b.latitude);return R(a,b,c,d,e,f)};g.fromCenterDistance=
R;g.directionToHeadingTilt=O;g.getObserverForPointAtDistance=A;g.fromExtent=function(a,b,c,d,e,f){var g,n=0;null!=b.zmax&&null!=b.zmin&&(g=(b.zmax+b.zmin)/2,n=b.zmax-b.zmin);var h,k;if("global"===a.viewingMode){if(!Y.isSpatialReferenceSupported(b.spatialReference,"global"))return w(f)&&f.resolver.reject(),null;var m=new r(b.xmin,b.ymin,b.spatialReference),p=new r(b.xmax,b.ymax,b.spatialReference),q=b.spatialReference.isGeographic?ha:ga;b=new r(q.center(m.x,p.x),(p.y+m.y)/2,b.spatialReference);null!=
g&&(b.z=g);k=z.getGreatCircleSpanAt(b,m,p);h=k.lon;k=k.lat;q.diff(m.x,p.x)>q.range/2&&(h+=z.halfEarthCircumference);h=Math.min(h,z.halfEarthCircumference);k=Math.min(k,z.halfEarthCircumference)}else m=a.spatialReference||u.WGS84,h=b.xmax-b.xmin,k=b.ymax-b.ymin,b=new r({x:b.xmin+.5*h,y:b.ymin+.5*k,z:g,spatialReference:m});g=a.state.camera;n=Math.max(1/Math.tan(g.fovX/2)*h*.5,1/Math.tan(g.fovY/2)*k*.5,1/Math.tan(g.fov/2)*n*.5)/1;if(w(f))h=F(f.signal),A(a,c,d,b,n,e,h),h.resolver.promise.then(function(b){return f.resolver.resolve(B(a,
b,a.camera.fov))},function(a){return f.resolver.reject(a)});else return c=A(a,c,d,b,n,e),B(a,c,a.camera.fov,f)};g.toExtent=function(a,b,c,d,e){b||(c||(c=a.state.camera),b=N(a,c,e));e=a.renderSpatialReference;var f;if(c)e=k.vectorToPoint(c.center,e,a.spatialReference||u.WGS84),f=c.distance;else{e=a.toMap(a.screenCenter);if(!e)return null;f=z.computeCartesianDistance(b.position,e)}c||(c=a.state.camera);b=2*f*Math.tan(c.fovX/2)*1;c=2*f*Math.tan(c.fovY/2)*1;return"global"===a.viewingMode?M.toExtent(a,
e,b,c,d):L.toExtent(a,e,b,c,d)};var D=.7;g.observerToCamera=B;g.scaleToZoom=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.levelAtScale(b);S.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};g.zoomToScale=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.scaleAtLevel(b);S.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};g.scaleToResolution=function(a,b){return a.spatialReference?
V.getResolutionForScale(b,a.spatialReference):void 0};g.computeScale=function(a,b,c){var d=a.renderSpatialReference;b||(b=a.state.camera);var e;e=u.WGS84;b instanceof X?(k.vectorToVector(b.center,d,E,e),e=E[1],b=b.distance):(e=b.position.latitude,k.pointToVector(b.position,v,d),k.pointToVector(c,E,d),b=t.vec3.distance(v,E));return Q(a,b,e)};g.createAsyncContext=F;g.isAsyncContext=w});