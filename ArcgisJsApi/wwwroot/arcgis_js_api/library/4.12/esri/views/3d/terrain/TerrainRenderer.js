// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/assignHelper ../../../Color ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingBox ../support/imageUtils ../support/buffer/BufferView ./PatchGeometryFactory ./PatchRenderData ./TerrainConst ./TileRenderer ./tileUtils ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/tracer ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainRendererPrograms ../../webgl/renderState ../../webgl/Util".split(" "),
function(L,ra,sa,V,W,X,M,C,Y,N,Z,k,l,O,D,G,aa,ba,P,ca,v,da,w,ea,Q,fa,H,ga,B,n,q,ha){var ia=ga.assert,ja=N.mat4f64.create(),I=Z.vec2f64.create(),J=G.create(),r=D.vec4f64.create(),p=D.vec4f64.create(),R=D.vec4f64.create(),ka=function(){return function(){this.extent=D.vec4f64.create();this.maxLevel=this.minLevel=0;this.callback=null}}();L=function(){function c(a,b){this._memCache=b;this.tileSize=256;this.rctx=null;this.renderDataPool=new M(ca.PatchRenderData);this.patchGroups=new C({allocator:function(a){return a||
{root:null,origin:null,patches:new C}},deallocator:function(a){a.root=null;a.origin=null;a.patches.clear();return a}});this.patchGroupsDirty=!0;this.patchGroupsMap=new Map;this.tileIterator=new w.IteratorPreorder;this.highestVisibleLODTile=null;this.visible=!0;this.debugScreenSizePerspective=!1;this.wireframe=B.copyParameters(la);this._opaque=!0;this._skirtScale=1;this.backfaceCullingEnabled=this._renderingDisabled=this._renderPatchBorders=!1;this._renderOrder=v.RenderOrder.FRONT_TO_BACK;this._velvetOvergroundEnabled=
!0;this._slicePlaneEnabled=this.hasOverlays=!1;this.castShadows=!0;this.receiveShadows=!1;this.tileRenderer=this.emptyTex=null;this.tileBackgroundInitialized=!1;this.stencilEnabledLayerExtents=[];this.numOriginsRendered=this.numTilesCulled=this.numTilesRendered=this.numTrianglesRendered=0;this.loaded=this.clippingExtent=null;this.needsHighlight=this.needsRender=this._loaded=!1;this.visibleScaleRangeQueries=new C({initialSize:10});this.visibleScaleRangeQueriesInvPtr=0;this.visibleScaleRangeQueryQueue=
new C({initialSize:30});this.visibleScaleRangeQueryPool=new M(ka,!1);this.manifold=a}c.prototype.destroy=function(a){this.uninstall(a);P.clearCaches()};c.prototype.install=function(a){a.addRenderPlugin([4,9],this);this.drapedRenderer=a.renderView.getDrapedRenderer()};c.prototype.uninstall=function(a){a.removeRenderPlugin(this)};Object.defineProperty(c.prototype,"renderingDisabled",{set:function(a){this._renderingDisabled=!!a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"opaque",{set:function(a){this._opaque=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"skirtScale",{set:function(a){this._skirtScale=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderPatchBorders",{set:function(a){this._renderPatchBorders!==a&&(this._renderPatchBorders=a,this._updatePrograms())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"cullBackFaces",{set:function(a){this.backfaceCullingEnabled=
a;this._updatePrograms();this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{get:function(){return this._renderOrder},set:function(a){this._renderOrder=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"velvetOvergroundEnabled",{set:function(a){this._velvetOvergroundEnabled!==a&&(this._velvetOvergroundEnabled=a,this._updatePrograms())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"intersectionHandlerId",
{get:function(){return Q.TERRAIN_ID},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._updatePrograms())},enumerable:!0,configurable:!0});c.prototype.setRootTiles=function(a){this.rootTiles=a;this.setNeedsRender()};c.prototype.setNeedsHighlight=function(a){this.needsHighlight=a;this.setNeedsRender()};c.prototype.setStencilEnabledLayerExtents=
function(a){this.stencilEnabledLayerExtents=a;this.setNeedsRender()};c.prototype.setTileSize=function(a){this.tileSize=a;this.tileRenderer&&(this.tileRenderer.tileSize=a);this.setNeedsRender()};c.prototype.loadCachedElevationData=function(a){ia(null===a.renderData);var b=w.tile2str(a);if(b=this._memCache.pop(b)){a.renderData=b.renderData;a.renderData.tile=a;a.renderData.localOrigin=this._getLocalOriginOfTile(a);for(var d in b.upsampleLIJs){var g=w.findParentByLIJ(a,b.upsampleLIJs[d]);a.layerInfo[v.LayerClass.ELEVATION][d].setUpsampleInfo(a,
g)}}return null!=b};c.prototype.loadTile=function(a){a.renderData||(a.renderData=this.renderDataPool.acquire(),a.renderData.init(a),a.renderData.localOrigin=this._getLocalOriginOfTile(a),this.updateTileGeometry(a));this.updateTileTexture(a)};c.prototype.queryVisibleLevelRange=function(a,b,d,g){var e=this.visibleScaleRangeQueryPool.acquire();O.vec4.copy(e.extent,a);e.minLevel=b?b:-Number.MAX_VALUE;e.maxLevel=null!=d?d:Number.MAX_VALUE;e.callback=g;this.visibleScaleRangeQueryQueue.push(e);this.setNeedsRender()};
c.prototype.updateTileTexture=function(a){this.tileRenderer&&this.tileBackgroundInitialized&&this.tileRenderer.updateTileTexture(a)};c.prototype.updateTileGeometry=function(a){for(var b=0,d=a.layerInfo[v.LayerClass.ELEVATION];b<d.length;b++)d[b].pendingUpdates&=~v.TileUpdate.GEOMETRY;a.renderData.updateGeometry(this.rctx,"debug"===this.wireframe.mode)&&this.setNeedsRender()};c.prototype.unloadTile=function(a,b){if(a.renderData){a.renderData.releaseTexture();if(b){b={renderData:a.renderData,upsampleLIJs:[]};
for(var d=0,g=a.layerInfo[v.LayerClass.ELEVATION];d<g.length;d++){var e=g[d].upsampleFromTile.tile.lij;b.upsampleLIJs.push([e[0],e[1],e[2]])}this._memCache.put(w.tile2str(a),b,a.renderData.estimatedGeometryMemoryUsage)}else this.releaseTileGeometry(a.renderData);a.renderData=null;a.updateMemoryUsed()}};c.prototype._getLocalOriginOfTile=function(a){var b=Math.max(0,7*Math.floor((a.lij[0]-3)/7));if("spherical"===this.manifold&&0===b)return l.vec3f64.ZEROS;for(;a.parent&&a.lij[0]>b;)a=a.parent;return a.centerAtSeaLevel};
c.prototype.setVisibility=function(a){this.visible=a;this.setNeedsRender()};c.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}};c.prototype.getWireframeEnabled=function(){return"shader"===this.wireframe.mode};c.prototype.setDebugScreenSizePerspective=function(a){a!==this.debugScreenSizePerspective&&(this.debugScreenSizePerspective=a,this._updatePrograms())};
c.prototype.setWireframe=function(a){var b=this;if(!1===a||!0===a)a={mode:a?"shader":"none"};var d=this.wireframe;if(void 0!==a.mode&&d.mode!==a.mode){var g="debug"===d.mode,e="debug"===a.mode;d.mode=a.mode;this._updatePrograms();g!==e&&this.rootTiles&&(w.traverseTilesPreorder(this.rootTiles,function(a){a.renderData&&a.renderData.updateGeometry(b.rctx,e)}),this.setNeedsRender())}for(var c in a)d.hasOwnProperty(c)&&(d[c]=a[c]),this.setNeedsRender();d.resolution&&(d.resolution=Math.min(d.resolution,
this.tileSize),d.resolution=1<<Math.round(Math.log(d.resolution)/Math.LN2))};c.prototype.setNeedsRender=function(){this.patchGroupsDirty=this.needsRender=!0};c.prototype.isOpaqueExcludingSlice=function(){var a=this.wireframe,a="shader"===a.mode&&(1>a.wireOpacity||1>a.surfaceOpacity);return this._opaque&&!a};c.prototype.isOpaque=function(){return this.isOpaqueExcludingSlice()&&!this._slicePlaneEnabled};c.prototype.setTileBackground=function(a){this.tileBackground=a;this._updateTileBackground()};c.prototype.initializeRenderContext=
function(a){var b=this,d=this.rctx=a.rctx;a=this.programRep=a.programRep;this._updatePrograms();this.tileRenderer=new da(d,this.tileSize,a,function(){return b.setNeedsRender()});this.tileBackground&&this._updateTileBackground();this.emptyTex=ea.createEmptyTexture(d)};c.prototype.uninitializeRenderContext=function(a){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null);this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)};c.prototype.intersect=function(a,b,d,g,e){if(this.rootTiles&&
(!a.enable.selectOpaqueTerrainOnly||!a.enable.selectionMode||this.isOpaqueExcludingSlice())){var c=ma,x=na;k.vec3.subtract(c,g,d);k.vec3.set(x,1/c[0],1/c[1],1/c[2]);var K=a.results.min,h=a.results.max,l=a.results.terrain,z=null,v=this.clippingExtent,u=this.tileIterator;u.reset(this.rootTiles);e=function(){var e=u.next();if(null===e.renderData)return"continue";if(a.enable.invisibleTerrain){if(!e.visible&&v&&!e.intersectsExtent(v))return"continue"}else if(!e.visible)return"continue";var f=e.renderData.geometryInfo,
m=-S._skirtScale*f.skirtLength;if(0!==m){var y=e.up;G.offset(f.boundingBox,m*y[0],m*y[1],m*y[2],J);G.expandWithBuffer(J,f.boundingBox,0,2)}var y=0===m?f.boundingBox:J,A=e.renderData.localOrigin;k.vec3.subtract(E,d,A);if(!B.intersectAabbInvDir(y,E,x,a.tolerance))return"continue";var n=function(a,b,d,e){a.set(void 0,w.tile2str(b),d,e,ja,void 0);a.intersector=oa;a.target=pa},y=function(f,x,m){0<=f&&(a.enable.backfacesTerrain||0>k.vec3.dot(x,c))&&(a.enable.invisibleTerrain||!a.enable.selectionMode||null==
b||b(d,g,f))&&((null==l.dist||f<l.dist)&&n(l,e,f,x),a.enable.storeTerrainResults&&(a.enable.storeAll&&(X.isNone(z)?(z=new Q.IntersectorResult(a.ray),n(z,e,f,x),a.results.all.push(z)):f<z.dist&&n(z,e,f,x)),(null==K.dist||f<K.dist)&&n(K,e,f,x),(null==h.dist||f>h.dist)&&n(h,e,f,x)))},q=qa;k.vec3.subtract(q,g,A);var A=f.indices,r=f.vertexAttributes,p={data:r.getField("position",ba.BufferViewVec3f).typedBuffer,size:3,offsetIdx:0,strideIdx:r.stride/4},f=f.numWithoutSkirtIndices/3;B.intersectTriangles(E,
q,0,f,A,p,null,y);0!==m&&P.intersectSkirts(E,q,f,A.length/3,A,r,"spherical"===S.manifold?function(a){return k.vec3.scale(a,a,m/k.vec3.length(a))}:function(a){return k.vec3.set(a,0,0,m)},y)};for(var S=this;!u.done;)e()}};c.prototype.render=function(a){var b=a.rctx;if(this._renderingDisabled||!this.visible||!this.rootTiles||!this.tileBackgroundInitialized)return!1;var d=this.isOpaque()?4:9;if(a.slot!==d)return!1;H.trace("# BEGIN RENDER TERRAIN");var d=a.pass,c=1===a.lightingData.helper.globalFactor;
h.overlayEnabled=!1;h.used=!0;switch(d){case 0:h.overlayEnabled=!0;h.used=!1;b=a.shadowMap&&a.shadowMap.enabled;this.receiveShadows!==b&&(this.receiveShadows=b,this._updatePrograms());b=!this.drapedRenderer.isEmpty();b!==this.hasOverlays&&(this.hasOverlays=b,this._updatePrograms());this._renderMaterialPass(a,this.programs.color,this._updatePatchGroupsData(),h);break;case 3:this.castShadows&&c&&this._renderAuxiliaryPass(a,this.programs.depthShadowMap,this._updatePatchGroupsData(),h);break;case 1:this._renderAuxiliaryPass(a,
this.programs.depth,this._updatePatchGroupsData(),h);break;case 2:this._renderAuxiliaryPass(a,this.programs.normal,this._updatePatchGroupsData(),h);break;case 4:this.needsHighlight&&(h.overlayEnabled=!0,this._renderAuxiliaryPass(a,this.programs.highlight,this._updatePatchGroupsData(),h),b.clearSafe(256))}H.trace("# END RENDER TERRAIN");this.needsRender=0!==this.visibleScaleRangeQueryQueue.length;return!0};c.prototype._renderMaterialPass=function(a,b,d,c){var e=this,f=a.camera;a.rctx.bindProgram(b);
var g=this.wireframe;if("shader"===g.mode||this._renderPatchBorders)b.setUniform1f("wireframe.width",this.wireframe.width),b.setUniform1f("wireframe.falloff",Math.min(g.width,g.falloff)),b.setUniform1f("wireframe.wireOpacity",g.wireOpacity),b.setUniform1f("wireframe.surfaceOpacity",g.surfaceOpacity),b.setUniform4fv("wireframe.color",g.color);a.shadowMap&&a.shadowMap.bind(b);a.ssaoHelper&&a.ssaoHelper.setUniforms(b);b.setUniform1i("tex",0);this._bindOverlayUniforms(b);b.setUniformMatrix4fv("viewNormal",
f.viewInverseTransposeMatrix);b.setUniformMatrix4fv("proj",f.projectionMatrix);g=a.lightingData;k.vec3.set(T,g.diffuse[0],g.diffuse[1],g.diffuse[2]);b.setUniform3fv("lightIntensity",T);a.lightingData.helper.setUniforms(b,!0);f=f.viewMatrix;k.vec3.set(F,f[12],f[13],f[14]);k.vec3.normalize(F,F);b.setUniform3fv("viewDirection",F);this.numOriginsRendered=this.numTrianglesRendered=this.numTilesCulled=this.numTilesRendered=0;this._prepareScaleRangeQueries();this.isOpaque()?this._renderPatchGroups(a,b,d,
c):a.offscreenRenderingHelper.renderToTargets(function(){return e._renderPatchGroups(a,b,d,c)},a.offscreenRenderingHelper.tmpColor,a.offscreenRenderingHelper.mainDepth,[0,0,0,0]);this._processScaleRangeQueries();0<this.numTilesRendered&&!this._loaded&&(this._loaded=!0,this.loaded&&this.loaded())};c.prototype._renderAuxiliaryPass=function(a,b,d,c){a.rctx.bindProgram(b);if(4===a.pass){var e=a.offscreenRenderingHelper;a.rctx.bindTexture(e.depthTexture,5);b.setUniform1i("depthTex",5);b.setUniform4f("highlightViewportPixelSz",
0,0,1/e.width,1/e.height)}else if(b.setUniformMatrix4fv("viewNormal",a.camera.viewInverseTransposeMatrix),1===a.pass||3===a.pass)I[0]=a.camera.near,I[1]=a.camera.far,b.setUniform2fv("nearFar",I);this._renderPatchGroupsAuxiliary(a,b,d,c)};c.prototype._updateTileBackground=function(){var a=this;if(this.tileRenderer){var b=function(){a.tileBackgroundInitialized=!0;a.rootTiles&&w.traverseTilesPreorder(a.rootTiles,function(b){return a.tileRenderer.updateTileTexture(b)})};if("string"===typeof this.tileBackground){var d=
this.tileBackground;aa.requestImage(d).then(function(c){d===a.tileBackground&&a.tileRenderer&&(a.tileRenderer.setBackground(c),b())})}else{var c=this.tileBackground?W.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(c);b()}}};c.prototype._updatePatchGroupsData=function(){var a=this,b=this.patchGroups;if(!this.patchGroupsDirty)return b;this.highestVisibleLODTile=null;b.clear();this._renderCollectOrigins(b);if(this.renderOrder!==v.RenderOrder.NONE){for(var d=0;d<b.length;d++)w.sortTiles(this.renderOrder,
b.data[d].patches);b.sort(function(b,d){var c=a.renderOrder;b=0===b.patches.length?-c:0===d.patches.length?c:w.compareTiles(b.patches.data[0],d.patches.data[0],c);return b})}this.patchGroupsDirty=!1;return b};c.prototype._renderCollectOrigins=function(a){var b=this.rootTiles,d="spherical"===this.manifold;a.clear();for(var c=0;c<b.length;c++){var e=b[c],f=a.pushNew();f.root=e;f.origin=d?l.vec3f64.ZEROS:e.centerAtSeaLevel;f.patches.clear();this._renderCollectOriginsForRoot(a,f)}};c.prototype._renderCollectOriginsForRoot=
function(a,b){var d=this.tileIterator;d.resetOne(b.root);var c=this.patchGroupsMap;c.clear();for(c.set(b.origin,b);!d.done;){b=d.next();var e=b.renderData;if(e&&!b.visible)this.numTilesCulled++,d.skipSubtree();else{if(0===b.lij[0]%7){var f=a.pushNew();f.root=b;f.origin=b.centerAtSeaLevel;c.set(b.centerAtSeaLevel,f);f.patches.clear()}if(e){(f=c.get(b.renderData.localOrigin))&&f.patches.push(b);if(!this.highestVisibleLODTile||b.vlevel>this.highestVisibleLODTile.vlevel)this.highestVisibleLODTile=b;d.skipSubtree()}}}};
c.prototype._scaleQueriesForTile=function(a){var b=a.extent;a=a.lij[0];for(var d=0;d<this.visibleScaleRangeQueriesInvPtr;){var c=this.visibleScaleRangeQueries.data[d],e=c.extent;a>=c.minLevel&&a<=c.maxLevel&&e[0]<=b[2]&&e[2]>=b[0]&&e[1]<=b[3]&&e[3]>=b[1]?(this.visibleScaleRangeQueries.swapElements(d,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):d++}};c.prototype._tileIntersectsStencilEnabledLayer=function(a){for(var b=this.stencilEnabledLayerExtents,d=0;d<b.length;d++)if(a.intersectsExtent(b[d]))return!0;
return!1};c.prototype._renderPatchGroupsAuxiliary=function(a,b,d,c){a.rctx.setPipelineState(this.defaultPipelineState);var e=0<this.stencilEnabledLayerExtents.length;b.setUniformMatrix4fv("proj",a.camera.projectionMatrix);b.setUniform1f("skirtScale",this._skirtScale);c.overlayEnabled&&this._bindOverlayUniforms(b);for(var f=0;f<d.length;f++){var g=d.data[f];this._bindViewForPatchGroup(b,g,a.camera.eye,a.camera.viewMatrix);for(var h=0;h<g.patches.length;h++)this._renderPatch(a.rctx,b,g.patches.data[h],
4,e,c)}a.rctx.bindVAO(null)};c.prototype._renderPatchGroups=function(a,b,c,g){var d=a.rctx,f=a.camera,h=f.viewMatrix;d.setPipelineState(this.defaultPipelineState);if(this.debugScreenSizePerspective&&this.pointsOfInterest){var l=fa.getSettings("spherical"===this.manifold?"global":"local");l.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:f.fovY});B.bindScreenSizePerspective(l,b,"screenSizePerspective")}l=0<this.stencilEnabledLayerExtents.length;b.setUniform1f("skirtScale",
this._skirtScale);var k=this.highestVisibleLODTile,n;k?(k=k.vlevel,n=this.tileSize/this.wireframe.resolution):(k=16,n=this.tileSize/64);for(var v="debug"===this.wireframe.mode?1:4,q=0;q<c.length;q++){var u=c.data[q],r=u.patches;if(0!==r.length){this._bindViewForPatchGroup(b,u,f.eye,h);var t=a.sliceHelper&&a.sliceHelper.plane;t&&B.bindSlicePlane(u.origin,t,b);a.shadowMap&&a.shadowMap.bindView(b,u.origin);this.numOriginsRendered++;for(u=0;u<r.length;u++){t=r.data[u];H.trace("# RENDER TILE "+w.tile2str(t)+
", screenDepth:"+t.screenDepth);var p=t.renderData.geometryInfo.uvOffsetAndScale,m=t.renderData.texOffsetAndScale;O.vec4.set(R,p[0]*m[2]+m[0],p[1]*m[3]+m[1],p[2]*m[2],p[3]*m[3]);b.setUniform4fv("texOffsetAndScale",R);d.bindTexture(t.renderData.textureReference,0);b.setUniform1f("opacity",t.renderData.opacity);("shader"===this.wireframe.mode||this._renderPatchBorders)&&b.setUniform1f("wireframe.subdivision",n*(1<<k-t.vlevel));p=this._renderPatch(d,b,t,v,l,g);t.renderOrder=this.numTilesRendered;this.numTilesRendered++;
this.numTrianglesRendered+=p/3;this._scaleQueriesForTile(t)}}}d.bindVAO(null)};c.prototype._renderPatch=function(a,b,c,g,e,f){f.overlayEnabled&&(this._bindOverlayTextures(b,c.renderData.overlays,f.used),b.setUniform1f("overlayOpacity",c.renderData.overlayOpacity));e&&a.setPipelineState(this._tileIntersectsStencilEnabledLayer(c)?this.stencilPipelineState:this.defaultPipelineState);e=0===this._skirtScale?c.renderData.geometryInfo.numWithoutSkirtIndices:c.renderData.vao.indexBuffer.size;a.bindVAO(c.renderData.vao);
ha.assertCompatibleVertexAttributeLocations(c.renderData.vao,b);a.drawElements(g,e,c.renderData.vao.indexBuffer.indexType,0);return e};c.prototype._bindViewForPatchGroup=function(a,b,c,g){a.setUniform3fv("origin",b.origin);Y.mat4.translate(U,g,b.origin);a.setUniformMatrix4fv("view",U);a.setUniform3f("camPos",c[0]-b.origin[0],c[1]-b.origin[1],c[2]-b.origin[2])};c.prototype._bindOverlayUniforms=function(a){a.setUniform1i("ovInnerColorTex",1);a.setUniform1i("ovOuterColorTex",2);a.setUniform1i("ovInnerWaterTex",
3);a.setUniform1i("ovOuterWaterTex",4)};c.prototype._bindOverlayTextures=function(a,b,c){for(var d=0;2>d;d++){var e=2*d,f=b[d],h=c?f.highlightRenderTargetId:f.renderTargetId;h?(r[e]=f.texOffset[0],r[e+1]=f.texOffset[1],p[e]=f.texScale[0],p[e+1]=f.texScale[1],e=this.drapedRenderer.getRenderTargetTexture(h),this.rctx.bindTexture(e,1+d),(f=f.waterMaskRenderTargetId)?(f=this.drapedRenderer.getRenderTargetTexture(f),this.rctx.bindTexture(f,3+d)):this.rctx.bindTexture(this.emptyTex,3+d)):(r[e]=0,r[e+1]=
0,p[e]=0,p[e+1]=0,this.rctx.bindTexture(this.emptyTex,1+d),this.rctx.bindTexture(this.emptyTex,3+d))}a.setUniform4fv("overlayTexOffset",r);a.setUniform4fv("overlayTexScale",p)};c.prototype._updatePrograms=function(){var a="shader"===this.wireframe.mode,b=this.programRep;this.programs={color:b.getProgram(n.colorPass,{mode:a||this._renderPatchBorders?"wireframe":"normal",overlay:this.hasOverlays,atmosphere:"spherical"===this.manifold&&this._velvetOvergroundEnabled,wireframeTexture:a,tileBorders:this._renderPatchBorders,
receiveShadows:this.receiveShadows,screenSizePerspective:this.debugScreenSizePerspective,slice:this._slicePlaneEnabled}),normal:b.getProgram(n.normalPass,{alphaZero:!0}),depth:b.getProgram(n.depthPass,{shadowMap:!1}),depthShadowMap:b.getProgram(n.depthPass,{shadowMap:!0}),highlight:b.getProgram(n.highlightPass,{})};this.defaultPipelineState=q.makePipelineState({culling:this.backfaceCullingEnabled&&q.backFaceCullingParams,depthTest:{func:513},depthWrite:q.defaultDepthWriteParams,colorWrite:q.defaultColorWriteParams});
this.stencilPipelineState=q.makePipelineState(V({},this.defaultPipelineState,{stencilTest:{function:{func:517,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7680}}}));this.setNeedsRender()};c.prototype.releaseTileGeometry=function(a){a.releaseGeometry()&&this.setNeedsRender();this.renderDataPool.release(a)};c.prototype._prepareScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryQueue;a.length<a.data.length&&0<b.length;){var c=b.pop();a.push(c)}this.visibleScaleRangeQueriesInvPtr=
a.length};c.prototype._processScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryPool,c=0;c<a.length;c++){var g=a.data[c];b.release(g);g.callback(c>=this.visibleScaleRangeQueriesInvPtr);g.callback=null}a.clear()};Object.defineProperty(c.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0});return c}();var la={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,color:[1,1,1,0],resolution:64},
h={overlayEnabled:!1,used:!0},U=N.mat4f64.create(),T=l.vec3f64.create(),F=l.vec3f64.create(),ma=l.vec3f64.create(),na=l.vec3f64.create(),E=l.vec3f64.create(),qa=l.vec3f64.create(),oa="TerrainRenderer",pa={type:"external"};return L});