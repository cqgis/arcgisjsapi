// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/mathUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f32 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4 ../../../../../geometry/support/aaBoundingBox ../../lib/ComponentUtils ../../lib/doublePrecisionUtils ../../lib/screenSizePerspectiveUtils ../../lib/Util".split(" "),function(la,h,N,O,ga,
P,G,m,J,I,Q,ha,R,S){function T(a,b,c,d,f){var e=U(b,c,V);I.setMin(B,a.getBBMin());I.setMax(B,a.getBBMax());if(K(B,b,e,d)){var e=a.getPrimitiveIndices(),g=a.getIndices(),h=a.getPosition(),k=e?e.length:g.length/3;if(k>ia&&(a=a.getChildren(),void 0!==a)){for(e=0;8>e;++e)void 0!==a[e]&&T(a[e],b,c,d,f);return}L(b,c,0,k,g,h,e,f)}}function L(a,b,c,d,f,e,g,h){if(g){var k=e.data,E=e.offsetIdx;e=e.strideIdx;var y=a[0],u=a[1];a=a[2];var D=b[0]-y,m=b[1]-u;for(b=b[2]-a;c<d;++c){var C=g[c],v=3*C,n=E+e*f[v++],q=
k[n++],r=k[n++],l=k[n],n=E+e*f[v++],x=k[n++],z=k[n++],A=k[n],n=E+e*f[v],v=k[n++],p=k[n++],x=x-q,z=z-r,A=A-l,v=v-q,p=p-r,n=k[n]-l,w=m*n-p*b,F=b*v-n*D,B=D*p-v*m,t=x*w+z*F+A*B;if(!(Math.abs(t)<=W)){q=y-q;r=u-r;l=a-l;w=q*w+r*F+l*B;if(0<t){if(0>w||w>t)continue}else if(0<w||w<t)continue;F=r*A-z*l;l=l*x-A*q;r=q*z-x*r;q=D*F+m*l+b*r;if(0<t){if(0>q||w+q>t)continue}else if(0<q||w+q<t)continue;l=(v*F+p*l+n*r)/t;0<=l&&(x=M(x,z,A,v,p,n,X),h(l,x,C))}}}else for(g=e.data,k=e.offsetIdx,E=e.strideIdx,e=a[0],y=a[1],
u=a[2],a=b[0]-e,D=b[1]-y,m=b[2]-u,b=c,c*=3;b<d;++b)if(p=k+E*f[c++],t=g[p++],r=g[p++],l=g[p],p=k+E*f[c++],C=g[p++],x=g[p++],z=g[p],p=k+E*f[c++],A=g[p++],v=g[p++],C-=t,x-=r,z-=l,A-=t,v-=r,p=g[p]-l,q=D*p-v*m,w=m*A-p*a,F=a*v-A*D,n=C*q+x*w+z*F,!(Math.abs(n)<=W)){t=e-t;r=y-r;l=u-l;q=t*q+r*w+l*F;if(0<n){if(0>q||q>n)continue}else if(0<q||q<n)continue;w=r*z-x*l;l=l*C-z*t;r=t*x-C*r;t=a*w+D*l+m*r;if(0<n){if(0>t||q+t>n)continue}else if(0<t||q+t<n)continue;l=(A*w+v*l+p*r)/n;0<=l&&(C=M(C,x,z,A,v,p,X),h(l,C,b))}}
function M(a,b,c,d,f,e,g){G.vec3.set(Y,a,b,c);G.vec3.set(Z,d,f,e);G.vec3.cross(g,Y,Z);G.vec3.normalize(g,g);return g}function U(a,b,c){return G.vec3.set(c,1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]))}function K(a,b,c,d){var f=(a[0]-d-b[0])*c[0],e=(a[3]+d-b[0])*c[0],g=Math.min(f,e),f=Math.max(f,e),e=(a[1]-d-b[1])*c[1],h=(a[4]+d-b[1])*c[1],g=Math.max(g,Math.min(e,h)),f=Math.min(f,Math.max(e,h));if(g>f)return!1;e=(a[2]-d-b[2])*c[2];a=(a[5]+d-b[2])*c[2];g=Math.max(g,Math.min(e,a));f=Math.min(f,Math.max(e,
a));return g<=f}function aa(a,b){b=b?aa(b):{};for(var c in a){var d=a[c];d&&d.forEach&&(d=ja(d));null==d&&c in b||(b[c]=d)}return b}function ja(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(h,"__esModule",{value:!0});var ba=P.mat4f64.create(),B=I.create(),H=S.VertexAttrConstants;h.IDENTITY=P.mat4f64.create();h.intersectTriangleGeometry=function(a,b,c,d,f,e,g,h){b=b&&b.componentVisibilities;d=d.tolerance;if(1<a.componentCount)a:{c=U(f,e,V);h=a.componentCount;var k=
a.componentOffsets,E=a.getIndices(H.POSITION),m=a.getAttribute(H.POSITION),u=a.boundingInfo;if(u&&(I.setMin(B,u.getBBMin()),I.setMax(B,u.getBBMax()),!K(B,f,c,d)))break a;for(u=0;u<h;u++)if(!b||Q.getVisibility(b,u)){if(a.getComponentAABB){var D=a.getComponentAABB(u,B);if(!K(D,f,c,d))continue}L(f,e,k[u]/3,k[u+1]/3,E,m,void 0,g)}}else if(!b||Q.getVisibility(b,0))a.boundingInfo?(S.assert("triangle"===a.data.primitiveType),T(a.boundingInfo,f,e,d,g)):(b=a.getIndices(H.POSITION),a=a.getAttribute(H.POSITION),
L(f,e,0,b.length/3,b,a,void 0,g))};var V=m.vec3f64.create(),W=Math.pow(2,-52),X=m.vec3f64.create();h.intersectTriangles=L;var Y=m.vec3f64.create(),Z=m.vec3f64.create();h.computeNormal=M;h.intersectAabbInvDir=K;h.transformToWorld=function(a,b,c){return J.vec4.set(c,a[0]-b[0],a[1]-b[1],a[2]-b[2],1)};h.transformToView=function(a,b,c,d){O.mat4.translate(ba,c,b);c=ba;return J.vec4.transformMat4(d,a,c)};h.transformToProjection=function(a,b,c,d){d[0]=a[0]+c[0];d[1]=a[1]+c[1];d[2]=a[2]+c[2];d[3]=a[3];return J.vec4.transformMat4(d,
d,b)};h.transformToNDC=function(a,b){return J.vec4.scale(b,a,1/Math.abs(a[3]))};h.applyScreenSizePerspectiveScale=function(a,b,c,d,f){return R.scale(a,d,c,f)};h.verticalOffsetAtDistance=function(a,b,c,d,f){var e=(c.screenLength||0)*a.pixelRatio;f&&(e=R.scale(e,d,b,f));return N.clamp(e*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,c.minWorldLength||0,null!=c.maxWorldLength?c.maxWorldLength:Infinity)};h.acquireIfNotUndefined=function(a,b,c){if(void 0!==a)return b.acquire(a,c)};h.releaseIfNotUndefined=function(a,
b){void 0!==a&&b.release(a)};var ca=ga.mat4f32.create();h.bindView=function(a,b,c){O.mat4.translate(ca,b,a);c.setUniform3fv("localOrigin",a);c.setUniformMatrix4fv("view",ca)};h.bindCamPos=function(a,b,c){c.setUniform3f("camPos",b[3]-a[0],b[7]-a[1],b[11]-a[2])};var da=m.vec3f64.create(),ea=m.vec3f64.create();h.bindViewOriginDouble=function(a,b){ha.encodeDoubleArraySplit(a,da,ea,3);b.setUniform3fv("viewOriginHi",da);b.setUniform3fv("viewOriginLo",ea)};var fa=m.vec3f64.create();h.bindSlicePlane=function(a,
b,c){G.vec3.subtract(fa,b.origin,a);c.setUniform3fv("slicePlaneOrigin",fa);c.setUniform3fv("slicePlaneBasis1",b.basis1);c.setUniform3fv("slicePlaneBasis2",b.basis2)};h.bindVerticalOffset=function(a,b,c){if(a){var d=b.fovY,f=b.viewport[3],e=void 0;void 0===e&&(e=ka);e.screenLength=a.screenLength;e.perDistance=Math.tan(.5*d)/(.5*f);e.minWorldLength=a.minWorldLength;e.maxWorldLength=a.maxWorldLength;a=e;c.setUniform4f("verticalOffset",a.screenLength*(b.pixelRatio||1),a.perDistance,a.minWorldLength,a.maxWorldLength)}};
h.bindHighlightRendering=function(a,b,c){a.bindTexture(b.highlightDepthTexture,5);c.setUniform1i("depthTex",5);c.setUniform4f("highlightViewportPixelSz",0,0,1/b.viewport[2],1/b.viewport[3])};h.bindScreenSizePerspective=function(a,b,c){void 0===c&&(c="screenSizePerspectiveAlignment");if(a){var d=a.parameters;b.setUniform4f(c,d.divisor,d.offset,d.minPixelSize,a.paddingPixelsOverride)}};h.copyParameters=aa;h.updateParameters=function(a,b){var c=!1,d;for(d in b){var f=b[d];void 0!==f&&(c=!0,Array.isArray(f)?
a[d]=f.slice():a[d]=f)}return c};(function(a){function b(a){return(a.shadowMappingEnabled?1:0)|(a.ssaoEnabled?2:0)}a.create=function(a,d){for(var c=[],e=0;2>e;e++)for(var g=0;2>g;g++){var h=b({shadowMappingEnabled:1===e,ssaoEnabled:1===g}),k=b({shadowMappingEnabled:1===e,ssaoEnabled:1===g&&a.receiveSSAO});c[h]=c[k]||d({receiveShadows:1===e,receiveSSAO:1===g&&a.receiveSSAO})}return{programs:c.filter(function(a){return null!=a}),byParameter:c}};a.lookup=function(a,d){return a.byParameter[b(d)]};a.programs=
function(a){return a.programs}})(h.BindParametersMap||(h.BindParametersMap={}));h.intersectDrapedRenderLineGeometry=function(a,b,c,d,f,e,g,h,k){if(d.enable.selectionMode){b=a.getAttribute(H.POSITION).data;d=a.getAttribute(H.SIZE);c=e[0];e=e[1];a=(((d&&d.data[0])+g)/2+4)*a.pixelRatio;g=Number.MAX_VALUE;for(d=0;d<b.length-5;d+=3){var m=b[d],y=b[d+1];k=c-m;f=e-y;var m=b[d+3]-m,y=b[d+4]-y,u=N.clamp((m*k+y*f)/(m*m+y*y),0,1);k=m*u-k;f=y*u-f;f=k*k+f*f;f<g&&(g=f)}g<a*a&&h()}};h.colorMixModes={multiply:1,
ignore:2,replace:3,tint:4};var ia=1E3,ka={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});