// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/mathUtils ../../../../geometry/support/aaBoundingBox ../../support/buffer/BufferView ../../support/buffer/InterleavedLayout ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/bufferWriters ./internal/MaterialUtil ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/PathPrograms ../../../webgl/renderState".split(" "),function(v,
N,A,m,w,B,x,C,n,D,E,F,u,p,f,G,g,l){function q(e,a){a.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",a.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",a.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",a.vvSizeOffset),e.setUniform3fv("vvSizeFactor",a.vvSizeFactor));a.vvColorEnabled&&(e.setUniform1fv("vvColorValues",a.vvColorValues),e.setUniform4fv("vvColorColors",a.vvColorColors));a.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",a.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",a.vvOpacityOpacities))}
var y=E.assert;v=function(e){function a(b,c){c=e.call(this,c)||this;c.supportsEdges=!0;c.params=f.copyParameters(b,H);c.vertexBufferLayout=a.getVertexBufferLayout(c.params);return c}m(a,e);a.prototype.isVisibleInPass=function(b){return 3===b?this.params.castShadows:!0};a.prototype.isVisible=function(){var b=this.params;if(!e.prototype.isVisible.call(this)||0===b.layerOpacity)return!1;var c=b.symbolColors,a="replace"===b.colorMixMode,d=0<b.opacity,f=b.externalColor&&0<b.externalColor[3];return b.vvColorEnabled||
c?a?!0:d:a?f:d};a.prototype.setParameterValues=function(b){var c=this.params,a;for(a in b)c[a]=b[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(b,c,a,d,e,g,l,k){if(b.metadata){c=b.metadata.pathGeometry;a=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){k=this.params.vvSizeOffset;var h=this.params.vvSizeFactor,m=this.params.vvSizeMinSize,n=this.params.vvSizeMaxSize,p=c.sizeAttributeValue;a[0]*=w.clamp(k[0]+
p*h[0],m[0],n[0]);a[1]*=w.clamp(k[1]+p*h[1],m[1],n[1])}k=Math.max(a[0],a[1]);b=B.fromValues(b.boundingInfo.bbMin[0]-k,b.boundingInfo.bbMin[1]-k,b.boundingInfo.bbMin[2]-k,b.boundingInfo.bbMax[0]+k,b.boundingInfo.bbMax[1]+k,b.boundingInfo.bbMax[2]+k);k=[g[0]-e[0],g[1]-e[1],g[2]-e[2]];h=Math.sqrt(k[0]*k[0]+k[1]*k[1]+k[2]*k[2]);f.intersectAabbInvDir(b,e,[h/k[0],h/k[1],h/k[2]],d.tolerance)&&(c.baked.size&&c.baked.size[0]===a[0]&&c.baked.size[1]===a[1]||c.baked.bakeVertexPositions(a),c.baked.intersect(e,
g,l))}};a.prototype.createBufferWriter=function(){return new I(this.vertexBufferLayout)};a.prototype.createRenderer=function(b,a){return new G(b,a,this,g.vertexAttributeLocations)};a.prototype.getGLMaterials=function(){return{color:J,depth:z,depthShadowMap:this.params.castShadows?K:null,normal:L,highlight:M}};a.getVertexBufferLayout=function(b){var a=C.newLayout().vec3f(g.VertexAttrConstants.POSITION).vec3f(g.VertexAttrConstants.NORMAL),a=a.mat3f(g.VertexAttrConstants.PATHGEOMETRYINFO);if(b.vvColorEnabled||
b.vvSizeEnabled||b.vvOpacityEnabled)a=a.vec4f(g.VertexAttrConstants.FEATUREVALUE);b.symbolColors&&(a=a.vec4u8(g.VertexAttrConstants.SYMBOLCOLOR));return a};return a}(D);var J=function(e){function a(b,a,h){h=this;var c=b.getParameters();h=e.call(this,b,a)||this;h.params=f.copyParameters(c);h.slot=h.params.transparent?7:5;h._createPrograms();h.selectPipeline();return h}m(a,e);a.prototype._createPrograms=function(){var b=this;this.programs=p.BindParametersMap.create(this.params,function(a){return b._createProgram(a)})};
a.prototype._createProgram=function(b){var a=this.params;return this.programRep.getProgram(g.colorPass,{symbolColors:a.symbolColors,flipV:a.flipV,doubleSided:a.doubleSided&&"normal"===a.doubleSidedType,windowOrderDoubleSided:a.doubleSided&&"winding-order"===a.doubleSidedType,receiveShadows:b.receiveShadows,receiveSSAO:b.receiveSSAO,vvSize:a.vvSizeEnabled,vvColor:a.vvColorEnabled,vvOpacity:a.vvOpacityEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,
slice:a.slicePlaneEnabled,compressedNormals:a.compressedNormals,transparencyDiscard:a.transparent,wireframe:a.wireframe})};a.prototype.selectPipeline=function(){var b=this.params;this.pipelineState=l.makePipelineState({blending:b.transparent&&l.separateBlendingParams(770,1,771,771),culling:r(b),polygonOffset:b.polygonOffset&&t,depthTest:{func:513},depthWrite:l.defaultDepthWriteParams,colorWrite:l.defaultColorWriteParams})};a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=
function(){return this.program||this.getPrograms()[0]};a.prototype.getPrograms=function(){return p.BindParametersMap.programs(this.programs)};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.slot=this.params.transparent?7:5;this._createPrograms();this.selectPipeline()};a.prototype.bind=function(b,a){var c=this.params,d=this.program=p.BindParametersMap.lookup(this.programs,a);b.bindProgram(d);b.setPipelineState(this.pipelineState);d.setUniform3fv("size",
c.size);d.setUniform3fv("ambient",c.ambient);d.setUniform3fv("diffuse",c.diffuse);d.setUniform3fv("specular",c.specular);d.setUniform4fv("externalColor",c.externalColor);d.setUniform1i("colorMixMode",f.colorMixModes[c.colorMixMode]);d.setUniform1f("opacity",c.opacity);d.setUniform1f("layerOpacity",c.layerOpacity);f.bindVerticalOffset(c.verticalOffset,a,d);f.bindScreenSizePerspective(c.screenSizePerspective,d);q(d,c)};a.prototype.release=function(b,a){};a.prototype.bindView=function(b,a){b=this.program=
p.BindParametersMap.lookup(this.programs,a);var c=this.params,d=a.origin;f.bindView(d,a.view,b);f.bindCamPos(d,a.viewInvTransp,b);c.slicePlaneEnabled&&f.bindSlicePlane(d,a.slicePlane,b);a.shadowMappingEnabled&&a.shadowMap.bindView(b,d)};a.prototype.bindInstance=function(b,a){b=this.program;b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(n),z=function(e){function a(b,
a,h,d){void 0===d&&(d=!1);b=e.call(this,b,a)||this;b.biased=d;b.updateParameters();return b}m(a,e);a.prototype.beginSlot=function(b){return b===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(g.depthPass,{flipV:b.flipV,shadowMap:this.biased,vvSize:b.vvSizeEnabled,vvColor:b.vvColorEnabled,vvOpacity:b.vvOpacityEnabled,verticalOffset:null!==b.verticalOffset,screenSizePerspective:null!==b.screenSizePerspective,
slice:b.slicePlaneEnabled,transparencyDiscard:b.transparent});this.pipelineState=l.makePipelineState({culling:r(b),polygonOffset:b.polygonOffset&&t,depthTest:{func:513},depthWrite:l.defaultDepthWriteParams,colorWrite:l.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?7:5};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot()};a.prototype.bind=function(b,a){var c=this.program,
d=this.params;b.bindProgram(c);b.setPipelineState(this.pipelineState);c.setUniform3fv("size",d.size);c.setUniform2fv("nearFar",a.nearFar);f.bindVerticalOffset(d.verticalOffset,a,c);f.bindScreenSizePerspective(d.screenSizePerspective,c);q(c,d)};a.prototype.release=function(b){};a.prototype.bindView=function(b,a){b=this.program;var c=this.params,d=a.origin;f.bindView(d,a.view,b);c.slicePlaneEnabled&&f.bindSlicePlane(a.origin,a.slicePlane,b);c.screenSizePerspective&&f.bindCamPos(d,a.viewInvTransp,b)};
a.prototype.bindInstance=function(a,c){this.program.setUniformMatrix4fv("model",c.transformation)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(n),K=function(e){function a(a,c,h){return e.call(this,a,c,h,!0)||this}m(a,e);return a}(z),L=function(e){function a(a,c,h){a=e.call(this,a,c)||this;a.updateParameters();return a}m(a,e);a.prototype.beginSlot=function(a){return a===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=
this.params;this.program=this.programRep.getProgram(g.normalPass,{flipV:a.flipV,vvSize:a.vvSizeEnabled,vvColor:a.vvColorEnabled,vvOpacity:a.vvOpacityEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,slice:a.slicePlaneEnabled,compressedNormals:a.compressedNormals,transparencyDiscard:a.transparent});this.pipelineState=l.makePipelineState({polygonOffset:a.polygonOffset&&t,culling:r(a),depthTest:{func:513},depthWrite:l.defaultDepthWriteParams,colorWrite:l.defaultColorWriteParams})};
a.prototype.selectSlot=function(){this.slot=this.params.transparent?7:5};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot()};a.prototype.bind=function(a,c){var b=this.program,d=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform3fv("size",d.size);f.bindVerticalOffset(d.verticalOffset,c,b);f.bindScreenSizePerspective(d.screenSizePerspective,b);q(b,d)};a.prototype.release=function(a){};
a.prototype.bindView=function(a,c){a=this.program;var b=this.params,d=c.origin;f.bindView(d,c.view,a);a.setUniformMatrix4fv("viewNormal",c.viewInvTransp);b.slicePlaneEnabled&&f.bindSlicePlane(c.origin,c.slicePlane,a);b.screenSizePerspective&&f.bindCamPos(d,c.viewInvTransp,a)};a.prototype.bindInstance=function(a,c){a=this.program;a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?
1:4};return a}(n),M=function(e){function a(a,c,h){a=e.call(this,a,c)||this;a.updateParameters();return a}m(a,e);a.prototype.beginSlot=function(a){return a===this.slot};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(g.highlightPass,{flipV:a.flipV,vvSize:a.vvSizeEnabled,vvColor:a.vvColorEnabled,vvOpacity:a.vvOpacityEnabled,verticalOffset:null!==a.verticalOffset,screenSizePerspective:null!==a.screenSizePerspective,
slice:a.slicePlaneEnabled,transparencyDiscard:a.transparent});this.pipelineState=l.makePipelineState({polygonOffset:a.polygonOffset&&t,culling:r(a),depthTest:{func:513},depthWrite:l.defaultDepthWriteParams,colorWrite:l.defaultColorWriteParams})};a.prototype.selectSlot=function(){this.slot=this.params.transparent?7:5};a.prototype.updateParameters=function(){this.params=f.copyParameters(this.material.getParameters());this.selectProgram();this.selectSlot()};a.prototype.bind=function(a,c){var b=this.program,
d=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform3fv("size",d.size);f.bindVerticalOffset(d.verticalOffset,c,b);f.bindScreenSizePerspective(d.screenSizePerspective,b);q(b,d)};a.prototype.release=function(a){};a.prototype.bindView=function(a,c){a=this.program;var b=this.params,d=c.origin;f.bindView(d,c.view,a);b.slicePlaneEnabled&&f.bindSlicePlane(c.origin,c.slicePlane,a);b.screenSizePerspective&&f.bindCamPos(d,c.viewInvTransp,a)};a.prototype.bindInstance=function(a,
c){a=this.program;a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};a.prototype.getDrawMode=function(){return this.params.wireframe?1:4};return a}(n),H=A({size:[1,1,1],wireframe:!1,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,symbolColors:!1,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,compressedNormals:!1,receiveSSAO:!0,castShadows:!0,verticalOffset:null,
screenSizePerspective:null,slicePlaneEnabled:!1,transparent:!1,polygonOffset:!1},F.Default),I=function(){function e(a){this.vertexBufferLayout=a}e.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};e.prototype.elementCount=function(a){return a.indices[g.VertexAttrConstants.POSITION].length};e.prototype.write=function(a,b,c,e){if(g.VertexAttrConstants.PATHGEOMETRYINFO in b.vertexAttr){var d=b.vertexAttr[g.VertexAttrConstants.PATHGEOMETRYINFO],f=b.indices[g.VertexAttrConstants.PATHGEOMETRYINFO];
y(9===d.size);var h=c.getField(g.VertexAttrConstants.PATHGEOMETRYINFO,x.BufferViewMat3f);if(h)u.writeBufferMat3f(f,d.data,h,e);else throw Error("unable to acquire view for "+g.VertexAttrConstants.PATHGEOMETRYINFO);}if(this.vertexBufferLayout.hasField(g.VertexAttrConstants.FEATUREVALUE)&&g.VertexAttrConstants.FEATUREVALUE in b.vertexAttr)if(d=b.vertexAttr[g.VertexAttrConstants.FEATUREVALUE],f=b.indices[g.VertexAttrConstants.FEATUREVALUE],y(4===d.size),h=c.getField(g.VertexAttrConstants.FEATUREVALUE,
x.BufferViewVec4f))u.writeBufferVec4(f,d.data,h,e);else throw Error("unable to acquire view for "+g.VertexAttrConstants.FEATUREVALUE);u.writeDefaultAttributes(b,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,c,e)};return e}(),t={factor:2,units:2},r=function(e){var a;a=e.slicePlaneEnabled?!1:e.cullFace?"none"!==e.cullFace:!e.transparent&&!e.doubleSided;return a&&{face:"front"===e.cullFace?1028:1029,mode:2305}};return v});