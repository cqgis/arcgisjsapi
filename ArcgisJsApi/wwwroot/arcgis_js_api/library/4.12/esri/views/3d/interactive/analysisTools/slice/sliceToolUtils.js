// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/compilerUtils ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/quat ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ./sliceToolConfig ../../../support/geometryUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/materials/ColorMaterial ../../../webgl-engine/materials/NativeLineMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/materials/SlicePlaneMaterial ../../../../interactive/Manipulator3D ../../../../interactive/manipulatorUtils".split(" "),
function(Z,g,aa,I,J,K,q,L,T,b,u,k,z,l,x,y,A,M,U,X,C,Y){function V(a,c,e,f,d,h){var D=b.vec3.dot(a,c),D=Math.abs(D)>k.VERTICAL_DOT_THRESHOLD?"vertical":"horizontal",n=l.sv3d.get(),m=l.sv3d.get(),r=function(){b.vec3.cross(n,c,e.viewUp);b.vec3.cross(m,c,n)},g=function(a){b.vec3.cross(m,a,c);b.vec3.copy(n,c)};if(J.isSome(f)&&f!==D)switch(f){case "vertical":r();break;case "horizontal":g(e.viewUp);break;default:I.neverReached(f)}else switch(D){case "vertical":r();break;case "horizontal":g(a);break;default:I.neverReached(D)}a=
b.vec3.cross(l.sv3d.get(),n,m);0<b.vec3.dot(a,e.viewForward)&&b.vec3.scale(m,m,-1);b.vec3.normalize(d,n);b.vec3.normalize(h,m)}function N(a,c){return Math.abs(b.vec3.dot(c.basis1,a))>Math.abs(b.vec3.dot(c.basis2,a))?1:2}function W(a){return{basis1Positive:{position:b.vec3.add(l.sv3d.get(),a.origin,a.basis1),rotationIdx:0},basis2Positive:{position:b.vec3.add(l.sv3d.get(),a.origin,a.basis2),rotationIdx:1},basis1Negative:{position:b.vec3.subtract(l.sv3d.get(),a.origin,a.basis1),rotationIdx:2},basis2Negative:{position:b.vec3.subtract(l.sv3d.get(),
a.origin,a.basis2),rotationIdx:3}}}function O(a,c,e){var f=e.projectPoint(b.vec3.add(l.sv3d.get(),a,c),K.castRenderScreenPointArray3(l.sv3d.get()));a=e.projectPoint(b.vec3.subtract(l.sv3d.get(),a,c),K.castRenderScreenPointArray3(l.sv3d.get()));return b.vec3.squaredLength(b.vec3.subtract(f,f,a))}function B(a){var c=b.vec3.length(a.basis1);a=b.vec3.length(a.basis2);return k.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(c,a)}function F(a){return 0!==a.direction[0]&&0!==a.direction[1]}function P(a,c,e){var f=
function(d){var h=(d?c:a).slice(0),f=b.vec3.subtract(l.sv3d.get(),h[0],h[1]);b.vec3.normalize(f,f);var n=b.vec3.subtract(l.sv3d.get(),h[h.length-1],h[h.length-2]);b.vec3.normalize(n,n);if(0<e.padding){var m=b.vec3.scale(u.vec3f64.create(),n,-e.padding);h[h.length-1]=b.vec3.add(m,m,h[h.length-1]);e.bothEnds&&(m=b.vec3.scale(u.vec3f64.create(),f,-e.padding),h[0]=b.vec3.add(m,m,h[0]))}var k=d?e.tipFocusMultiplier:1,m=e.tipLength*(e.focusTipLength?k:1),g=e.tipRadius*k,k=q.mat4.identity(l.sm4d.get());
if(0<e.padding){var p=m/4,t=b.vec3.set(l.sv3d.get(),0,p,0),p=1+e.padding/p;q.mat4.translate(k,k,t);q.mat4.scale(k,k,b.vec3.set(l.sv3d.get(),p,p,p));q.mat4.translate(k,k,b.vec3.scale(t,t,-1/p))}p=q.mat4.identity(L.mat4f64.create());t=u.vec3f64.fromValues(0,1,0);n=q.mat4.fromQuat(L.mat4f64.create(),T.quat.rotationTo(l.sq4d.get(),t,n));n[12]=h[h.length-1][0];n[13]=h[h.length-1][1];n[14]=h[h.length-1][2];q.mat4.multiply(n,n,k);d=e.tubeRadius*(d?e.tubeFocusMultiplier:1)+e.padding;var w=e.flat,Q=[];if(J.isSome(w))Q.push([d,
w.thickness/2],[-d,w.thickness/2],[-d,-w.thickness/2],[d,-w.thickness/2]);else for(w=0;12>w;w++){var z=w/12*2*Math.PI;Q.push([Math.cos(z)*d,Math.sin(z)*d])}d=y.createPathExtrusionGeometry(Q,h,[],[],!1);d=[{part:"tube",geometry:new x(d,"arrow-tube"),transform:p}];var E;J.isSome(e.flat)?p=new x(y.createExtrudedTriangle(m,g,g,e.flat.thickness),"arrow-tip"):(p=new x(y.createConeGeometry(m,g,24,!1,!1,!0),"arrow-tip"),E=new x(y.createConeGeometry(m,g,24,!1,!0,!1),"arrow-cap"));d.push({part:"tip",geometry:p,
transform:n});E&&d.push({part:"cap",geometry:E,transform:n});e.bothEnds&&(f=q.mat4.fromQuat(L.mat4f64.create(),T.quat.rotationTo(l.sq4d.get(),t,f)),f[12]=h[0][0],f[13]=h[0][1],f[14]=h[0][2],q.mat4.multiply(f,f,k),d.push({part:"tip",geometry:p,transform:f}),E&&d.push({part:"cap",geometry:E,transform:f}));return d};return{normal:f(!1),focused:f(!0)}}function R(a,c){var e=b.vec3.subtract(u.vec3f64.create(),a[a.length-1],a[a.length-2]);b.vec3.normalize(e,e);b.vec3.scale(e,e,k.ROTATE_HEADING_TIP_LENGTH);
b.vec3.add(e,e,a[a.length-1]);return c?(c=b.vec3.subtract(u.vec3f64.create(),a[0],a[1]),b.vec3.normalize(c,c),b.vec3.scale(c,c,k.ROTATE_HEADING_TIP_LENGTH),b.vec3.add(c,c,a[0]),[c].concat(a,[e])):a.concat([e])}function S(a,c){return Math.abs(b.vec3.dot(a.plane,c))<=k.PERPENDICULAR_GROUND_DOT_THRESHOLD}Object.defineProperty(g,"__esModule",{value:!0});g.createPlane=function(a,c,e,f,d,h,k,n,m){n=n.worldUpAtPosition(a,l.sv3d.get());V(c,n,h,k,m.basis1,m.basis2);b.vec3.scale(m.basis1,m.basis1,f);b.vec3.scale(m.basis2,
m.basis2,d);b.vec3.copy(m.origin,c);b.vec3.scale(m.origin,m.origin,-e);b.vec3.add(m.origin,m.origin,a);return z.boundedPlane.fromValues(m.origin,m.basis1,m.basis2,m)};g.normalToBases=V;g.resizePlane=function(a,c,e,f,d,h){var g=b.vec3.copy(l.sv3d.get(),h.origin),n=b.vec3.copy(l.sv3d.get(),h.basis1),m=b.vec3.copy(l.sv3d.get(),h.basis2),r=b.vec3.copy(l.sv3d.get(),d.origin);b.vec3.add(r,r,b.vec3.scale(l.sv3d.get(),d.basis1,0>a.direction[0]?1:-1));b.vec3.add(r,r,b.vec3.scale(l.sv3d.get(),d.basis2,0>a.direction[1]?
1:-1));var v=b.vec3.length(d.basis1),p=b.vec3.length(d.basis2);e=b.vec3.subtract(l.sv3d.get(),e,r);var t=b.vec3.subtract(l.sv3d.get(),c,r),w=0;c=0;if(F(a)){var q=B(d),u=B(h),w=v-.5*a.direction[0]*b.vec3.dot(d.basis1,t)/v;c=p-.5*a.direction[1]*b.vec3.dot(d.basis2,t)/p;t=u/q;w*=t;c*=t}t=.5*a.direction[0]*b.vec3.dot(d.basis1,e)/v;q=.5*a.direction[1]*b.vec3.dot(d.basis2,e)/p;e=w+t;c+=q;v=b.vec3.scale(l.sv3d.get(),d.basis1,e/v);d=b.vec3.scale(l.sv3d.get(),d.basis2,c/p);0<e&&O(h.origin,v,f)>k.PLANE_MIN_BASIS_SCREEN_LEN2&&
b.vec3.copy(n,v);0<c&&O(h.origin,d,f)>k.PLANE_MIN_BASIS_SCREEN_LEN2&&b.vec3.copy(m,d);b.vec3.copy(g,r);b.vec3.add(g,g,b.vec3.scale(l.sv3d.get(),n,0>a.direction[0]?-1:1));b.vec3.add(g,g,b.vec3.scale(l.sv3d.get(),m,0>a.direction[1]?-1:1));return z.boundedPlane.fromValues(g,n,m,h)};g.calculatePlaneHalfSize=function(a,c){return k.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(c.width,c.height)*c.computeRenderPixelSizeAt(a)};g.createShiftPlane=function(a,c,e,f){e=b.vec3.cross(l.sv3d.get(),c,e);b.vec3.cross(e,
e,c);return z.plane.fromPositionAndNormal(a,e,f)};g.calculateBoundedPlaneTranslateRotate=function(a,c){return Y.calculateTranslateRotateFromBases(a.basis1,a.basis2,a.origin,c)};g.createRotatePlane=function(a,c,e){var f=c.worldUpAtPosition(a.origin,l.sv3d.get());c=S(a,f);f=N(f,a);c=b.vec3.copy(l.sv3d.get(),c?1===f?a.basis1:a.basis2:a.plane);return z.plane.fromPositionAndNormal(a.origin,c,e)};g.updateShiftRestartHandle=function(a,c,e,f,d){var h=f.worldUpAtPosition(e.origin,l.sv3d.get());f=S(e,h);var h=
N(h,e),g=W(e),h=f&&2!==h?g.basis2Positive:g.basis1Positive;f=l.sm4d.get();q.mat4.rotateZ(f,c,h.rotationIdx*Math.PI/2);c=b.vec3.subtract(l.sv3d.get(),h.position,e.origin);b.vec3.normalize(c,c);c=b.vec3.scale(l.sv3d.get(),c,d.computeScreenPixelSizeAt(h.position)*k.SHIFT_RESTART_OFFSET_DISTANCE);b.vec3.add(c,c,h.position);var h=d.projectPoint(c,K.castRenderScreenPointArray3(l.sv3d.get())),n=d.viewport,g=n[0],m=n[1],r=n[2],n=n[3],v=Math.min(r,n)/16,p=!0;h[0]<g+v?(h[0]=g+v,p=!1):h[0]>g+r-v&&(h[0]=g+r-
v,p=!1);h[1]<m+v?(h[1]=m+v,p=!1):h[1]>m+n-v&&(h[1]=m+n-v,p=!1);g=p;z.ray.fromRender(d,h,G);b.vec3.normalize(G.direction,G.direction);d=l.sv3d.get();!g&&z.boundedPlane.intersectRay(e,G,d)&&(c=d);f[12]=0;f[13]=0;f[14]=0;a.modelTransform=f;a.position=u.vec3f64.clone(c);a.state=g?a.state|H:a.state&~H};g.updateResizeHandle=function(a,c,e,f){var d=b.vec3.length(f.basis1),h=b.vec3.length(f.basis2),g=B(f),k=B(f),m=b.vec3.set(l.sv3d.get(),0,0,0);b.vec3.add(m,b.vec3.scale(l.sv3d.get(),f.basis1,c.direction[0]),
b.vec3.scale(l.sv3d.get(),f.basis2,c.direction[1]));b.vec3.add(m,f.origin,m);f=0;var r=1;F(c)?(1===c.direction[0]&&-1===c.direction[1]?f=Math.PI/2:1===c.direction[0]&&1===c.direction[1]?f=Math.PI:-1===c.direction[0]&&1===c.direction[1]&&(f=3*Math.PI/2),r=k):(c=0!==c.direction[0]?1:2,f=1===c?Math.PI/2:0,r=(1===c?h:d)-g);d=q.mat4.identity(l.sm4d.get());q.mat4.rotateZ(d,d,f);q.mat4.scale(d,d,b.vec3.set(l.sv3d.get(),r,r,r));q.mat4.multiply(d,e,d);d[12]=0;d[13]=0;d[14]=0;a.modelTransform=d;a.position=
m};g.updateRotateHeadingHandle=function(a,c,e,b){var d=b.worldUpAtPosition(e.origin,l.sv3d.get());b=S(e,d);d=N(d,e);e=W(e);e=b&&2!==d?e.basis2Negative:e.basis1Negative;d=q.mat4.identity(l.sm4d.get());q.mat4.rotateZ(d,d,e.rotationIdx*Math.PI/2);b&&q.mat4.rotateX(d,d,Math.PI/2);q.mat4.multiply(d,c,d);d[12]=0;d[13]=0;d[14]=0;a.modelTransform=d;a.position=e.position};g.calculateScreenSpaceBasisLength2=O;g.calculateResizeHandlePadding=B;g.calculateDiagonalResizeHandleScale=function(a){return B(a)};g.isDiagonalResizeHandle=
F;g.createShiftManipulator=function(a){var c=[u.vec3f64.fromValues(0,0,-k.SHIFT_RESTART_ARROW_LENGTH/2),u.vec3f64.fromValues(0,0,k.SHIFT_RESTART_ARROW_LENGTH/2)],b=R(c,!0),f=function(a,b){return P(c,c,{tubeRadius:k.SHIFT_RESTART_TUBE_RADIUS,tipRadius:k.SHIFT_RESTART_TIP_RADIUS,tipLength:k.SHIFT_RESTART_TIP_LENGTH,tubeFocusMultiplier:k.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:k.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER,padding:a,bothEnds:!0,flat:null,focusTipLength:!0,addCap:b})},d=f(0,!1),
f=f(k.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),h=new A({color:k.SHIFT_RESTART_ARROW_TIP_COLOR,cullFace:"back"},"slice-shift");h.renderOccluded=8;var l=new A({color:k.SHIFT_RESTART_ARROW_CAP_COLOR,cullFace:"back"},"slice-shift");l.renderOccluded=8;var n=new A({color:k.SHIFT_RESTART_TUBE_COLOR,cullFace:"back"},"slice-shift");n.renderOccluded=8;var m=new A({color:k.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,cullFace:"front"},"slice-shift");m.renderOccluded=2;var r=new x(y.createPolylineGeometry([[0,
0,0],[-k.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),q=new x(y.createPolylineGeometry([[0,0,0],[-k.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),p=new M({color:k.SHIFT_RESTART_CALLOUT_COLOR},"slice-rotate-heading");p.renderOccluded=4;return new C.Manipulator3D({view:a,renderObjects:d.normal.map(function(a){var b=a.part;return{geometry:a.geometry,material:"tip"===b?h:"cap"===b?l:n,transform:a.transform,stateMask:1|g.DidPointerMoveRecentlyFlag}}).concat(f.normal.map(function(a){return{geometry:a.geometry,
material:m,transform:a.transform,stateMask:1|g.DidPointerMoveRecentlyFlag}}),[{geometry:r,material:p,stateMask:1|g.DidPointerMoveRecentlyFlag|H}],d.focused.map(function(a){var b=a.part;return{geometry:a.geometry,material:"tip"===b?h:"cap"===b?l:n,transform:a.transform,stateMask:2|g.DidPointerMoveRecentlyFlag}}),f.focused.map(function(a){return{geometry:a.geometry,material:m,transform:a.transform,stateMask:2|g.DidPointerMoveRecentlyFlag}}),[{geometry:q,material:p,stateMask:2|g.DidPointerMoveRecentlyFlag|
H}]),autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[b]},collisionPriority:1,radius:k.SHIFT_RESTART_TIP_RADIUS,snapToPointer:!1,moveOnDrag:!1,state:g.DidPointerMoveRecentlyFlag})};g.createRotateManipulator=function(a){var b=.1*Math.PI,e=1.7*Math.PI,f=k.ROTATE_HEADING_DISC_RADIUS,d=f*k.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,h=k.ROTATE_HEADING_DISC_ARROW_RADIUS*k.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,l=k.ROTATE_HEADING_OFFSET_DISTANCE,n=function(a){for(var c=[],d=0;32>d;d++){var f=
Math.PI+b+(e-b)*d/31;c.push(u.vec3f64.fromValues(l+a*Math.cos(f),a*Math.sin(f),0))}return c},m=n(k.ROTATE_HEADING_DISC_ARROW_RADIUS),n=n(h),h=R(m,!1),m=P(m,n,{tubeRadius:k.ROTATE_HEADING_TUBE_RADIUS,tipRadius:k.ROTATE_HEADING_TIP_RADIUS,tipLength:k.ROTATE_HEADING_TIP_LENGTH,tubeFocusMultiplier:k.ROTATE_HEADING_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:k.ROTATE_HEADING_TIP_FOCUS_MULTIPLIER,padding:0,bothEnds:!1,flat:{thickness:2},focusTipLength:!0,addCap:!0}),r=new A({color:k.ROTATE_HEADING_ARROW_COLOR,
cullFace:"back"},"slice-rotate-heading");r.renderOccluded=8;var n=new x(y.createPolylineGeometry([[0,0,0],[l-f,0,0]]),"slice-rotate-heading"),q=new x(y.createPolylineGeometry([[0,0,0],[l-d,0,0]]),"slice-rotate-heading"),p=new M({color:k.ROTATE_HEADING_CALLOUT_COLOR},"slice-rotate-heading");p.renderOccluded=4;var t=u.vec3f64.fromValues(0,0,1),w=u.vec3f64.fromValues(l,0,0),f=new x(y.createCylinderGeometry(1,f,32,t,w),"slice-rotate-heading"),d=new x(y.createCylinderGeometry(1,d,32,t,w),"slice-rotate-heading"),
t=new A({color:k.ROTATE_HEADING_DISC_COLOR,transparent:!0,writeDepth:!1,cullFace:"back"},"slice-rotate-heading");t.renderOccluded=8;return new C.Manipulator3D({view:a,renderObjects:m.normal.map(function(a){return{geometry:a.geometry,material:r,transform:a.transform,stateMask:1|g.DidPointerMoveRecentlyFlag}}).concat([{geometry:f,material:t,stateMask:1|g.DidPointerMoveRecentlyFlag},{geometry:n,material:p,stateMask:1|g.DidPointerMoveRecentlyFlag}],m.focused.map(function(a){return{geometry:a.geometry,
material:r,transform:a.transform,stateMask:2|g.DidPointerMoveRecentlyFlag}}),[{geometry:d,material:t,stateMask:2|g.DidPointerMoveRecentlyFlag},{geometry:q,material:p,stateMask:2|g.DidPointerMoveRecentlyFlag}]),autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[h]},collisionPriority:1,radius:k.ROTATE_HEADING_TIP_RADIUS,snapToPointer:!1,moveOnDrag:!1,state:g.DidPointerMoveRecentlyFlag})};g.createOutlineManipulator=function(a){var b=new x(y.createPolylineGeometry([[-1,-1,0],[1,-1,0],[1,1,0],
[-1,1,0],[-1,-1,0]]),"slice-outline"),e=k.PLANE_OUTLINE_COLOR.slice(),e=new U({color:e,writeDepth:!1,width:k.PLANE_OUTLINE_WIDTH},"slice-outline");e.renderOccluded=4;return{manipulator:new C.Manipulator3D({view:a,renderObjects:[{geometry:b,material:e}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:e}};g.createGridManipulator=function(a){var b=new x(y.createSquareGeometry(),"slice-grid"),e=k.PLANE_BACKGROUND_COLOR.slice(),e=new X({backgroundColor:e,gridColor:k.GRID_COLOR,gridWidth:4},
"slice-grid");e.renderOccluded=4;return{manipulator:new C.Manipulator3D({view:a,renderObjects:[{geometry:b,material:e}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:e}};g.createResizeManipulator=function(a,b){var c=(b=F(b))?[u.vec3f64.fromValues(1,0,0),u.vec3f64.fromValues(0,0,0),u.vec3f64.fromValues(0,1,0)]:[u.vec3f64.fromValues(1,0,0),u.vec3f64.fromValues(-1,0,0)],f=new x(y.createPolylineGeometry(c),"slice-resize"),d=k.HANDLE_COLOR.concat([1]),h=function(a){a=new U({color:d,
width:a},"slice-resize");a.renderOccluded=4;return a},g=function(){var a=new M({color:d},"slice-resize");a.renderOccluded=4;return a},l=b?k.RESIZE_HANDLE_CORNER_WIDTH:k.RESIZE_HANDLE_EDGE_WIDTH,m=l*k.DISPLAY_FOCUS_MULTIPLIER;return new C.Manipulator3D({view:a,renderObjects:[{geometry:f,material:1<l?h(l):g(),stateMask:1},{geometry:f,material:1<m?h(m):g(),stateMask:2}],collisionType:{type:"line",paths:[c]},autoScaleRenderObjects:!1,worldSized:!0,radius:b?k.RESIZE_HANDLE_CORNER_INPUT_RADIUS:k.RESIZE_HANDLE_EDGE_INPUT_RADIUS,
snapToPointer:!1,moveOnDrag:!1})};g.createArrowGeometry=P;g.addArrowTips=R;g.isAlwaysDrapedLayer=function(a){switch(a.type){case "building-scene":case "csv":case "feature":case "geo-rss":case "geojson":case "graphics":case "group":case "integrated-mesh":case "kml":case "map-notes":case "point-cloud":case "scene":case "stream":case "unknown":case "unsupported":case null:return!1;case "base-dynamic":case "base-elevation":case "base-tile":case "bing-maps":case "elevation":case "imagery":case "map-image":case "open-street-map":case "tile":case "vector-tile":case "web-tile":case "wms":case "wmts":return!0;
default:return I.neverReached(a.type),!1}};g.DidPointerMoveRecentlyFlag=16;var H=32,G=z.ray.create()});