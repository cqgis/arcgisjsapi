// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/Handles ../../../../../core/screenUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec2 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ./LaserLineRenderer ../support/Label ../support/LabelSegment ../support/labelUtils ../support/PathSegmentInterpolator ../support/viewUtils ../../../support/mathUtils ../../../support/projectionUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryData ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Intersector ../../../webgl-engine/lib/Layer ../../../webgl-engine/lib/Object3D ../../../webgl-engine/materials/ColorMaterial ../../../webgl-engine/materials/MeasurementArrowMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/parts/Model ../../../../interactive/manipulatorUtils".split(" "),
function(n,U,V,W,E,q,F,L,G,k,r,M,A,x,B,H,v,t,I,h,C,N,J,O,P,p,Q,R,D,d,S){n=[1,.5,0,.75];var T={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:n,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],
arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:n,guideLineWidth:2,guideLineColor:n,guideStippleLengthPixels:6,labelDistance:25};n=function(){function b(a,c){void 0===c&&(c={});this._visible=!1;this._laserLineRenderer=null;this._directDistanceLabel=new A;this._horizontalDistanceLabel=new A;this._verticalDistanceLabel=new A;this._handles=new E;this._listenerHandles=null;this._cursorPosition=r.vec3f64.create();this._startPosition=r.vec3f64.create();
this._endPosition=r.vec3f64.create();this._centerPosition=r.vec3f64.create();this._cornerPosition=r.vec3f64.create();this._arrowLabelSegment=new x;this._horizontalLabelSegment=new x;this._verticalLabelSegment=new x;this._geodesicProjectionLabelSegment=new x;this._origin=r.vec3f64.create();this._originTransform=L.mat4f64.create();this._lastDraggedHandle=null;this._model=a;this._sceneView=a.sceneView;this._params=v.copyParameter(T,c);this._layer=new P("point-to-point-measurement",{isPickable:!1});this._createMaterials();
this._createObjects();this._intersector=new O(this._sceneView.viewingMode)}b.prototype.destroy=function(){this.hide();this._handles.destroy();this._handles=null};Object.defineProperty(b.prototype,"requiresCursorPoint",{get:function(){return"initial"===this._model.state&&this._model.active},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"cameraAboveGround",{get:function(){return this._sceneView.state.camera.aboveGround},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"visible",{get:function(){return this._visible},set:function(a){a?this.show():this.hide()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"testData",{get:function(){return{labels:{direct:this._directDistanceLabel,horizontal:this._horizontalDistanceLabel,vertical:this._verticalDistanceLabel},laserLineRenderer:this._laserLineRenderer}},enumerable:!0,configurable:!0});b.prototype.createManipulators=function(){var a=this,c=function(){var c=S.createSphereManipulator(a._sceneView,a._params.handleColor,
a._params.handleOpacity);c.visible=!1;c.hideOnGrab=!0;c.radius=a._params.handleRadius;return c},f=c(),m=c();this._model.startPoint&&(f.mapPoint=this._model.startPoint,f.visible=!0);this._model.endPoint&&(m.mapPoint=this._model.endPoint,m.visible=!0);var e=function(){var c=a._lastDraggedHandle;f.grabbing&&!m.grabbing&&(c="start");m.grabbing&&!f.grabbing&&(c="end");f.grabbing||m.grabbing||(c=null);var e=c!==a._lastDraggedHandle;a._lastDraggedHandle=c;e&&a.visible&&a._updateLaserLine()};this._handles.add([f.watch("grabbing",
function(){e()}),m.watch("grabbing",function(){e()})]);return{start:f,end:m}};b.prototype.show=function(){if(!this._visible){this._visible=!0;var a=this._sceneView._stage;this._laserLineRenderer=new M(this._sceneView.renderCoordsHelper,{glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,globalAlpha:this._params.laserLineGlobalAlpha});a.addRenderPlugin(this._laserLineRenderer.renderSlots,
this._laserLineRenderer);this._addToStage(a);this._directDistanceLabel.addToView(this._sceneView);this._horizontalDistanceLabel.addToView(this._sceneView);this._verticalDistanceLabel.addToView(this._sceneView);this._initializeListeners();this._updateCursorPosition();this._updateStartPosition();this._updateEndPosition();this._updateLaserLine();this._updateView()}};b.prototype.hide=function(){if(this._visible){this._visible=!1;var a=this._sceneView._stage;a.removeRenderPlugin(this._laserLineRenderer);
this._laserLineRenderer=null;this._removeFromStage(a);this._directDistanceLabel.removeFromView(this._sceneView);this._horizontalDistanceLabel.removeFromView(this._sceneView);this._verticalDistanceLabel.removeFromView(this._sceneView);this._destroyListeners();this._sceneView.cursor=null}};b.prototype.pick=function(a){var c=this._sceneView.spatialReference;a=q.screenPointObjectToArray(a.screenPoint);a=this._sceneView.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector).results.min;
var f=r.vec3f64.create();if(!a.getIntersectionPoint(f))return new b.PickResult;c=this._sceneView.renderCoordsHelper.fromRenderCoords(f,c);return new b.PickResult("TerrainRenderer"===a.intersector?"ground":"feature",f,c)};b.prototype.getElevation=function(a){return this._sceneView.basemapTerrain.ready?this._sceneView.basemapTerrain.getElevation(a)||0:0};b.prototype.overlappingHandles=function(a,c){return v.pointToPointScreenDistance(a,c,this._sceneView)<=this._params.handleRadius};b.prototype._createMaterials=
function(){this._triangleLineMaterial=new D({width:this._params.triangleLineWidth,color:this._params.triangleColor,polygonOffset:!0},"triangle-line");this._triangleLineMaterial.renderOccluded=4;this._triangleCornerMaterial=new Q({color:this._params.triangleColor,transparent:!0,writeDepth:!1,polygonOffset:!0},"triangle-corner");this._triangleCornerMaterial.renderOccluded=4;this._arrowMaterial=new R({outlineColor:this._params.arrowOutlineColor,stripeEvenColor:this._params.arrowStripeEvenColor,stripeOddColor:this._params.arrowStripeOddColor,
polygonOffset:!0},"arrow");this._arrowMaterial.renderOccluded=4;this._geodesicProjectionLineMaterial=new D({width:this._params.geodesicProjectionLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0},"geodesic-line");this._geodesicProjectionLineMaterial.renderOccluded=4;this._geodesicGuideLineMaterial=new D({width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stippleLength:0},"geodesic-guide");this._geodesicGuideLineMaterial.renderOccluded=
4};b.prototype._createObjects=function(){this._triangleLineObject=new p;this._layer.addObject(this._triangleLineObject);this._triangleCornerObject=new p;this._layer.addObject(this._triangleCornerObject);this._arrowObject=new p;this._layer.addObject(this._arrowObject);this._geodesicProjectionLineObject=new p;this._layer.addObject(this._geodesicProjectionLineObject);this._geodesicProjectionStartGuideObject=new p;this._layer.addObject(this._geodesicProjectionStartGuideObject);this._geodesicProjectionEndGuideObject=
new p;this._layer.addObject(this._geodesicProjectionEndGuideObject)};b.prototype._addToStage=function(a){a.add(d.ContentType.LAYER,this._layer);a.add(d.ContentType.MATERIAL,this._triangleLineMaterial);a.add(d.ContentType.MATERIAL,this._triangleCornerMaterial);a.add(d.ContentType.MATERIAL,this._arrowMaterial);a.add(d.ContentType.MATERIAL,this._geodesicProjectionLineMaterial);a.add(d.ContentType.MATERIAL,this._geodesicGuideLineMaterial);a.add(d.ContentType.OBJECT,this._triangleLineObject);a.add(d.ContentType.OBJECT,
this._triangleCornerObject);a.add(d.ContentType.OBJECT,this._arrowObject);a.add(d.ContentType.OBJECT,this._geodesicProjectionLineObject);a.add(d.ContentType.OBJECT,this._geodesicProjectionStartGuideObject);a.add(d.ContentType.OBJECT,this._geodesicProjectionEndGuideObject);a.addToViewContent([this._layer.id])};b.prototype._removeFromStage=function(a){a.removeFromViewContent([this._layer.id]);a.remove(d.ContentType.LAYER,this._layer.id);a.remove(d.ContentType.MATERIAL,this._triangleLineMaterial.id);
a.remove(d.ContentType.MATERIAL,this._triangleCornerMaterial.id);a.remove(d.ContentType.MATERIAL,this._arrowMaterial.id);a.remove(d.ContentType.MATERIAL,this._geodesicProjectionLineMaterial.id);a.remove(d.ContentType.MATERIAL,this._geodesicGuideLineMaterial.id);a.remove(d.ContentType.OBJECT,this._triangleLineObject.id);a.remove(d.ContentType.OBJECT,this._triangleCornerObject.id);a.remove(d.ContentType.OBJECT,this._arrowObject.id);a.remove(d.ContentType.OBJECT,this._geodesicProjectionLineObject.id);
a.remove(d.ContentType.OBJECT,this._geodesicProjectionStartGuideObject.id);a.remove(d.ContentType.OBJECT,this._geodesicProjectionEndGuideObject.id)};b.prototype._getLabelPositions=function(a,c,f,m,e){var g=this._model.triangleView.collapsed,b=q.castRenderScreenPointArray3(h.sv3d.get()),l=q.castRenderScreenPointArray3(h.sv3d.get());e.projectPoint(f,b);e.projectPoint(c,l);b={direct:g?"top":"bottom",horizontal:"top",vertical:b[0]<l[0]?"left":"right"};g||(l=h.sv2d.get(),g=h.sv2d.get(),v.screenSpaceTangent(a,
f,l,e),v.screenSpaceTangent(a,c,g,e),G.vec2.dot(l,g)>=K?b.direct=t.sign(l[1])===t.sign(g[1])?B.mirrorPosition(b.vertical):b.vertical:(a=q.castRenderScreenPointArray(h.sv2d.get()),v.screenSpaceTangent(f,c,a,e),G.vec2.dot(a,g)>=K&&(b.direct=t.sign(a[0])===t.sign(g[0])?B.mirrorPosition(b.horizontal):b.horizontal)));"below-the-surface"===m&&(c=function(a){return"top"===a?"bottom":"top"},b.direct=c(b.direct),b.horizontal=c(b.horizontal),b.vertical=c(b.vertical));return b};b.prototype._updateView=function(){var a;
if(this._sceneView.ready){var c=this._sceneView._stage.getCamera(),f=this._sceneView.renderCoordsHelper,b=this._model.triangleView;if(b.visible){var e="camera-dependent"===this._model.measurementSurfaceLocation?this._sceneView.state.camera.aboveGround?"above-the-surface":"below-the-surface":this._model.measurementSurfaceLocation,g=this._startPosition;a=this._endPosition;var h="above-the-surface"===e?1:-1,l=h*(f.getAltitude(a)-f.getAltitude(g));0>l&&(a=[a,g],g=a[0],a=a[1]);var d=this._cornerPosition;
f.worldUpAtPosition(g,d);k.vec3.scale(d,d,h*Math.abs(l));k.vec3.add(d,d,g);f=this._centerPosition;v.midpoint([g,a,d],f);k.vec3.copy(this._origin,f);F.mat4.identity(this._originTransform);F.mat4.translate(this._originTransform,this._originTransform,this._origin);b.collapsed?(this._triangleLineObject.removeAllGeometries(),this._triangleCornerObject.removeAllGeometries()):this._updateTriangleObjects(this._triangleLineObject,this._triangleCornerObject,g,a,d,this._origin,this._originTransform,c,b.mode,
this._horizontalLabelSegment,this._verticalLabelSegment);this._updateArrowObject(this._arrowObject,this._startPosition,this._endPosition,this._origin,this._originTransform,b.stripeLength,c,b.mode,this._arrowLabelSegment);f=this._requiresGeodesicGuides(this._startPosition,this._endPosition,c,b.mode);this._updateGeodesicProjectionLineObject(this._geodesicProjectionLineObject,this._startPosition,this._endPosition,this._origin,this._originTransform,f,this._geodesicProjectionLabelSegment);this._updateGeodesicProjectionGuideObjects(c,
f);h=this._params.labelDistance;e=this._getLabelPositions(g,a,d,e,c);this._updateAuxiliaryMeasureLabels(b,c,e);"geodesic"!==b.mode?this._updateLabel(this._directDistanceLabel,this._arrowLabelSegment,h,e.direct,b.directLabel,b.visible,16,c):(this._updateLabel(this._horizontalDistanceLabel,f?this._geodesicProjectionLabelSegment:this._arrowLabelSegment,h,e.horizontal,b.horizontalLabel,b.visible,16,c),this._directDistanceLabel.visible=!1)}else this._triangleLineObject.removeAllGeometries(),this._triangleCornerObject.removeAllGeometries(),
this._arrowObject.removeAllGeometries(),this._geodesicProjectionLineObject.removeAllGeometries(),this._geodesicProjectionStartGuideObject.removeAllGeometries(),this._geodesicProjectionEndGuideObject.removeAllGeometries(),this._directDistanceLabel.visible=!1,this._horizontalDistanceLabel.visible=!1,this._verticalDistanceLabel.visible=!1}};b.prototype._updateAuxiliaryMeasureLabels=function(a,c,f){if(a.collapsed)this._horizontalDistanceLabel.visible=!1,this._verticalDistanceLabel.visible=!1;else{var b=
this._params.labelDistance;this._updateLabel(this._horizontalDistanceLabel,this._horizontalLabelSegment,b,f.horizontal,a.horizontalLabel,!0,12,c);this._updateLabel(this._verticalDistanceLabel,this._verticalLabelSegment,b,f.vertical,a.verticalLabel,!0,12,c)}};b.prototype._updateTriangleObjects=function(a,c,b,m,e,g,d,l,w,u,n){w=[k.vec3.subtract(h.sv3d.get(),b,g),k.vec3.subtract(h.sv3d.get(),e,g),k.vec3.subtract(h.sv3d.get(),m,g)];u.update(e,m);n.update(b,e);u=new C(J.createPolylineGeometry(w),"triangle-line");
a.removeAllGeometries();a.addGeometry(u,this._triangleLineMaterial,d);a=h.sv3d.get();u=h.sv3d.get();k.vec3.subtract(a,e,b);k.vec3.normalize(a,a);k.vec3.subtract(u,m,e);k.vec3.normalize(u,u);b=.33*Math.min(k.vec3.distance(e,b),k.vec3.distance(e,m));l=this._params.triangleCornerSize*l.computeScreenPixelSizeAt(e);e=new C(this._quadGeometryData(e,a,u,Math.min(b,l),g),"triangle-corner");c.removeAllGeometries();c.addGeometry(e,this._triangleCornerMaterial,d)};b.prototype._updateArrowObject=function(a,c,
b,m,e,g,d,h,k){this._createInterpolatedLineGeometry(a,this._arrowMaterial,"arrow",c,b,m,e,h,this._arrowLabelSegment);a=d.computeScreenPixelSizeAt(k.origin);this._arrowMaterial.setParameterValues({width:this._params.arrowWidth*a,stripeLength:g})};b.prototype._getSegmentInterpolator=function(a,c){var b=this._sceneView.renderCoordsHelper.spatialReference;return I.canProject(this._sceneView.spatialReference,I.SphericalECEFSpatialReference)?new H.Spherical(a,c,b,b):new H.Linear(a,c)};b.prototype._updateGeodesicProjectionLineObject=
function(a,c,b,m,e,g,d){g?(g=this._sceneView.renderCoordsHelper,c=k.vec3.copy(h.sv3d.get(),c),b=k.vec3.copy(h.sv3d.get(),b),g.setAltitude(0,c),g.setAltitude(0,b),this._createInterpolatedLineGeometry(a,this._geodesicProjectionLineMaterial,"geodesicProjectionLine",c,b,m,e,"geodesic",d)):a.removeAllGeometries()};b.prototype._requiresGeodesicGuides=function(a,b,f,d){return"geodesic"===d&&this._model.geodesicDistanceExceeded?this._requiresGeodesicGuideAt(a,f)||this._requiresGeodesicGuideAt(b,f):!1};b.prototype._requiresGeodesicGuideAt=
function(a,b){var c=this._sceneView.renderCoordsHelper;b=b.computeScreenPixelSizeAt(a);return 10<=c.getAltitude(a)/b};b.prototype._updateGeodesicProjectionGuideObjects=function(a,b){if(b){b=this._sceneView.renderCoordsHelper;var c=k.vec3.copy(h.sv3d.get(),this._startPosition),d=k.vec3.copy(h.sv3d.get(),this._endPosition);b.setAltitude(0,c);b.setAltitude(0,d);this._createInterpolatedLineGeometry(this._geodesicProjectionStartGuideObject,this._geodesicGuideLineMaterial,"geodesicGuideLine",c,this._startPosition,
this._origin,this._originTransform,"euclidean");this._createInterpolatedLineGeometry(this._geodesicProjectionEndGuideObject,this._geodesicGuideLineMaterial,"geodesicGuideLine",d,this._endPosition,this._origin,this._originTransform,"euclidean");a=Math.min(a.computeScreenPixelSizeAt(this._startPosition),a.computeScreenPixelSizeAt(c),a.computeScreenPixelSizeAt(this._endPosition),a.computeScreenPixelSizeAt(d));this._geodesicGuideLineMaterial.setParameterValues({stippleLength:this._params.guideStippleLengthPixels*
a})}else this._geodesicProjectionStartGuideObject.removeAllGeometries(),this._geodesicProjectionEndGuideObject.removeAllGeometries()};b.prototype._createInterpolatedLineGeometry=function(a,b,f,d,e,g,n,l,w){var c=this._sceneView.renderCoordsHelper,m=[],r=[],q=function(a,b){var c=h.sv3d.get();k.vec3.subtract(c,a,g);m.push(c);r.push(b)};if("euclidean"===l){var p=h.sv3d.get();v.midpoint([d,e],p);l=h.sv3d.get();c.worldUpAtPosition(p,l);q(d,l);q(e,l);w&&w.update(d,e)}else{d=this._getSegmentInterpolator(d,
e);e=this._params.arrowSubdivisions+1&-2;for(var t=p=null,y=0;y<e;++y){var x=y/(e-1),z=h.sv3d.get();l=h.sv3d.get();d.eval(x,z);c.worldUpAtPosition(z,l);y===e/2-1?p=z:y===e/2&&(t=z);q(z,l)}w&&w.update(p,t)}f=new C(J.createPolylineGeometry(m,r),f);a.removeAllGeometries();a.addGeometry(f,b,n)};b.prototype._quadGeometryData=function(a,b,d,m,e){var c=h.sv3d.get(),f=[],l=h.sv3d.get();k.vec3.scale(l,d,m);d=h.sv3d.get();k.vec3.scale(d,b,-m);for(b=0;4>b;++b)k.vec3.copy(c,a),k.vec3.subtract(c,c,e),b&1&&k.vec3.add(c,
c,l),b&2&&k.vec3.add(c,c,d),f.push(c[0],c[1],c[2]);return new N({position:{size:3,data:f}},{position:new Uint32Array([0,1,2,1,2,3])})};b.prototype._updateLabel=function(a,b,d,m,e,g,k,l){var c=q.castScreenPointArray(h.sv2d.get()),f=q.castScreenPointArray(h.sv2d.get());b=B.computeLabelPositionFromSegment(l,b,d,m,c,f);a.updatePosition(c,f);a.text=e;a.visible=b&&g;a.fontSize=k};b.prototype._updateCursorPosition=function(){this._model.cursorPoint&&this._sceneView.renderCoordsHelper.toRenderCoords(this._model.cursorPoint,
this._cursorPosition);this._updateLaserLine()};b.prototype._updateStartPosition=function(){this._model.startPoint&&this._sceneView.renderCoordsHelper.toRenderCoords(this._model.startPoint,this._startPosition)};b.prototype._updateEndPosition=function(){this._model.endPoint&&this._sceneView.renderCoordsHelper.toRenderCoords(this._model.endPoint,this._endPosition)};b.prototype._getFocusPosition=function(){var a=this._model,b=a.triangleView.visible&&a.triangleView.collapsed&&"euclidean"===a.measurementMode;
switch(a.state){case "drawing":return b?this._startPosition:a.endPoint?this._endPosition:this._startPosition;case "editing":return b?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return a.cursorPoint?this._cursorPosition:null}};b.prototype._getFocusSpherePosition=function(){return"drawing"===this._model.state||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition};b.prototype._updateLaserLine=
function(){var a=this._model,b=this._getFocusPosition(),d=this._params.laserLineEnabled&&!!b&&"measured"!==a.state&&a.active;d?(this._laserLineRenderer.focusPlaneActive=d&&"euclidean"===a.measurementMode,this._laserLineRenderer.focusSphereActive=d&&!!a.startPoint&&"geodesic"===a.measurementMode,this._laserLineRenderer.focusPosition=b,this._laserLineRenderer.focusSpherePosition=this._getFocusSpherePosition(),this._laserLineRenderer.segmentActive=d&&a.triangleView.visible&&!a.triangleView.collapsed,
this._laserLineRenderer.segmentStartPosition=this._startPosition,this._laserLineRenderer.segmentEndPosition=this._endPosition):(this._laserLineRenderer.focusPlaneActive=!1,this._laserLineRenderer.focusSphereActive=!1,this._laserLineRenderer.segmentActive=!1)};b.prototype._initializeListeners=function(){var a=this;this._listenerHandles=new E;this._listenerHandles.add([this._model.watch("state",function(){a._updateLaserLine()}),this._model.watch("measurementMode",function(){a._updateLaserLine()}),this._model.watch("hoveredHandle",
function(){a._updateView()}),this._model.watch("cursorPoint",function(){a._updateCursorPosition()}),this._model.watch("startPoint",function(){a._updateStartPosition();a._updateView();a._updateLaserLine()}),this._model.watch("endPoint",function(){a._updateEndPosition();a._updateView();a._updateLaserLine()}),this._model.watch("unit",function(){a._updateView()}),this._model.watch("active",function(){a._updateLaserLine();a._updateView()}),this._sceneView.state.watch("camera",function(){a._updateView()})])};
b.prototype._destroyListeners=function(){this._listenerHandles.destroy();this._listenerHandles=null};return b}();(function(b){var a=function(){return function(){}}();b.PickRequest=a;a=function(){return function(a,b,d){void 0===a&&(a=null);void 0===b&&(b=null);void 0===d&&(d=null);this.type=a;this.scenePoint=b;this.mapPoint=d}}();b.PickResult=a})(n||(n={}));var K=Math.cos(t.deg2rad(12));return n});