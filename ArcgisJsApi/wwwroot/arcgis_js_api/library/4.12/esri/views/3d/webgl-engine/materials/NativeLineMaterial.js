// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/Logger ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./internal/bufferWriters ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/NativeLinePrograms ../../../webgl/renderState".split(" "),
function(F,ba,A,M,q,N,f,d,c,G,O,H,P,y,Q,n,R,I,x){var S=M.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");F=function(l){function a(e,b){b=l.call(this,b)||this;b.params=n.copyParameters(e,T);return b}A(a,l);a.prototype.setParameterValues=function(e){var b=this.params,a;for(a in e)b[a]=e[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.getColor=function(){return this.params.color};a.prototype.intersect=function(e,a,c,f,g,h,l,
k,U){U?this.intersectLineGeometry(e,a,c,f,g,h,l):n.intersectDrapedRenderLineGeometry(e,a,c,f,g,h,1,l)};a.prototype.intersectLineGeometry=function(e,a,p,l,m,d,n,k){if(l.enable.selectionMode&&!O.isAllHidden(a.componentVisibilities,e.componentOffsets))if(y.isTranslationMatrix(p)){a=e.data.getVertexAttr().position.data;m=l.camera;d=V;N.vec2.copy(d,l.point);f.vec3.set(z[0],d[0]-2,d[1]+2,0);f.vec3.set(z[1],d[0]+2,d[1]+2,0);f.vec3.set(z[2],d[0]+2,d[1]-2,0);f.vec3.set(z[3],d[0]-2,d[1]-2,0);for(k=0;4>k;k++)m.unprojectPoint(z[k],
t[k]);c.plane.fromPoints(m.eye,t[0],t[1],B);c.plane.fromPoints(m.eye,t[1],t[2],C);c.plane.fromPoints(m.eye,t[2],t[3],D);c.plane.fromPoints(m.eye,t[3],t[0],E);e=Number.MAX_VALUE;for(k=0;k<a.length-5;k+=3)if(g[0]=a[k]+p[12],g[1]=a[k+1]+p[13],g[2]=a[k+2]+p[14],h[0]=a[k+3]+p[12],h[1]=a[k+4]+p[13],h[2]=a[k+5]+p[14],!(0>c.plane.signedDistance(B,g)&&0>c.plane.signedDistance(B,h)||0>c.plane.signedDistance(C,g)&&0>c.plane.signedDistance(C,h)||0>c.plane.signedDistance(D,g)&&0>c.plane.signedDistance(D,h)||0>
c.plane.signedDistance(E,g)&&0>c.plane.signedDistance(E,h))){m.projectPoint(g,u);m.projectPoint(h,v);if(0>u[2]&&0<v[2]){f.vec3.subtract(r,g,h);var b=m.frustum,q=-c.plane.signedDistance(b.planes[4],g),b=q/f.vec3.dot(r,b.planes[4]);f.vec3.scale(r,r,b);f.vec3.add(g,g,r);m.projectPoint(g,u)}else if(0<u[2]&&0>v[2])f.vec3.subtract(r,h,g),b=m.frustum,q=-c.plane.signedDistance(b.planes[4],h),b=q/f.vec3.dot(r,b.planes[4]),f.vec3.scale(r,r,b),f.vec3.add(h,h,r),m.projectPoint(h,v);else if(0>u[2]&&0>v[2])continue;
u[2]=0;v[2]=0;b=c.lineSegment.distance2(c.lineSegment.fromPoints(u,v,J),d);b<e&&(e=b,f.vec3.copy(K,g),f.vec3.copy(L,h))}p=l.rayBeginPoint;l=l.rayEndPoint;4>e&&(e=Number.MAX_VALUE,c.lineSegment.closestLineSegmentPoint(c.lineSegment.fromPoints(K,L,J),c.lineSegment.fromPoints(p,l,W),w)&&(f.vec3.subtract(w,w,p),e=f.vec3.length(w),f.vec3.scale(w,w,1/e),e/=f.vec3.distance(p,l)),n(e,w))}else S.error("intersection assumes a translation-only matrix")};a.prototype.createBufferWriter=function(){return new X(this.params)};
a.prototype.createRenderer=function(a,b){return new R(a,b,this)};a.prototype.getGLMaterials=function(){return{color:Y,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:Z}};return a}(P);var Y=function(c){function a(a,b,d){a=c.call(this,a,b)||this;a.updateParameters();return a}A(a,c);a.prototype.updateParameters=function(){this.params=n.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.selectProgram=function(){var a=this.params;this.program=this.programRep.getProgram(I.colorPass,
{slice:a.slicePlaneEnabled,vertexColors:this.params.vertexColors});this.pipelineState=x.makePipelineState({blending:1>a.color[3]&&x.separateBlendingParams(770,1,771,771),depthTest:{func:513},depthWrite:x.defaultDepthWriteParams,colorWrite:x.defaultColorWriteParams})};a.prototype.beginSlot=function(a){return 5===a};a.prototype.getProgram=function(){return this.program};a.prototype.bind=function(a,b){b=this.program;var e=this.params;a.bindProgram(b);a.setPipelineState(this.pipelineState);b.setUniform4fv("constantColor",
e.color)};a.prototype.release=function(a){};a.prototype.bindView=function(a,b){a=this.program;var e=this.params;n.bindView(b.origin,b.view,a);e.slicePlaneEnabled&&n.bindSlicePlane(b.origin,b.slicePlane,a)};a.prototype.bindInstance=function(a,b){this.program.setUniformMatrix4fv("model",b.transformation)};a.prototype.getDrawMode=function(){return 1};return a}(H),Z=function(c){function a(a,b,d){a=c.call(this,a,b)||this;a.updateParameters();return a}A(a,c);a.prototype.updateParameters=function(){this.params=
n.copyParameters(this.material.getParameters());this.selectProgram()};a.prototype.beginSlot=function(a){return 5===a};a.prototype.getProgram=function(){return this.program};a.prototype.selectProgram=function(){this.program=this.programRep.getProgram(I.highlightPass,{slice:this.params.slicePlaneEnabled,vertexColors:this.params.vertexColors});this.pipelineState=x.makePipelineState({depthTest:{func:513},colorWrite:x.defaultColorWriteParams})};a.prototype.bind=function(a,b){a.bindProgram(this.program);
a.setPipelineState(this.pipelineState);n.bindHighlightRendering(a,b,this.program)};a.prototype.release=function(a){};a.prototype.bindView=function(a,b){a=this.program;var c=this.params;n.bindView(b.origin,b.view,a);c.slicePlaneEnabled&&n.bindSlicePlane(b.origin,b.slicePlane,a)};a.prototype.bindInstance=function(a,b){this.program.setUniformMatrix4fv("model",b.transformation)};a.prototype.getDrawMode=function(){return 1};return a}(H),T={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1},aa=G.newLayout().vec3f(y.VertexAttrConstants.POSITION),
X=function(){function c(a){this.vertexBufferLayout=G.newLayout().vec3f(y.VertexAttrConstants.POSITION);a.vertexColors&&(this.vertexBufferLayout=aa.vec4u8(y.VertexAttrConstants.COLOR))}c.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};c.prototype.elementCount=function(a){return a.indices[y.VertexAttrConstants.POSITION].length};c.prototype.write=function(a,c,b,d){Q.writeDefaultAttributes(c,this.vertexBufferLayout,a.transformation,a.invTranspTransformation,b,d)};return c}(),
g=d.vec3f64.create(),h=d.vec3f64.create(),r=d.vec3f64.create(),w=d.vec3f64.create(),u=q.createRenderScreenPointArray3(),v=q.createRenderScreenPointArray3(),K=d.vec3f64.create(),L=d.vec3f64.create(),J=c.lineSegment.create(),W=c.lineSegment.create(),V=d.vec3f64.create(),z=[q.createRenderScreenPointArray3(),q.createRenderScreenPointArray3(),q.createRenderScreenPointArray3(),q.createRenderScreenPointArray3()],t=[d.vec3f64.create(),d.vec3f64.create(),d.vec3f64.create(),d.vec3f64.create()],B=c.plane.create(),
C=c.plane.create(),D=c.plane.create(),E=c.plane.create();return F});