// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/asyncUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingRect ../../../layers/support/LercWorker ../../2d/engine/vectorTiles/VectorTileDisplayObject3D ../support/geometryUtils ../support/index ../support/projectionUtils ./ElevationData ./ElevationTileAgent ./MapTileAgent ./OverlayManager ./PlanarPatch ./SphericalPatch ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./TilemapOnlyTile ./tileUtils ./tileUtils ./UpsampleInfo ../../webgl/Texture ../../webgl/Util".split(" "),
function(x,ua,O,P,l,Q,R,D,S,T,U,V,W,X,z,Y,Z,v,E,h,aa,ba,ca,F,da,p,G,ea,H,fa,A,I,ga,ha,ia,ja,ka,J,la,e,ma,m,na,w,K,oa,pa,L){function M(e,c){return e[0]===c[0]&&e[1]===c[1]&&e[2]===c[2]}function N(e,c){var a=!1;c=c||e;var b=0;for(e=e.children;b<e.length;b++){var d=e[b];if(d){for(var k in d.layerInfo)for(var g in d.layerInfo[k]){var f=d.layerInfo[k][g].upsampleFromTile;if(f&&f.tile===c)return!0}a=a||N(d,c)}}return a}var q=W.getLogger("esri.views.3d.terrain.TerrainSurface");x=function(x){function c(a,
b){b=x.call(this)||this;b.defaultTileBackground=e.DEFAULT_TILE_BACKGROUND;b.hideSkirtsDistanceFromExtentMargin=qa;b.hideSkirtsMinimumCameraTilt=ra;b.hideSkirtsMaximumCameraTilt=sa;b._clippingExtent=null;b._dataExtent=null;b._elevationBounds=[0,0];b._rootExtent=p.create();b._iteratorPool=new z(K.IteratorPreorder);b._postorderIterator=new K.IteratorPostorder;b.visible=!1;b.suspended=!1;b._pendingUpdates=!1;b._asyncWorkItems=0;b._lvPendingUpdates=!1;b._updateNextFrame=0;b._memoryUsed=0;b._overlayOpacity=
1;b._eyePosRenderSR=F.vec3f64.create();b._eyePosSurfaceSR=F.vec3f64.create();b._splitLimits=[0,0,0,0,0,0];b._frustum=H.frustum.create();b._viewProjectionMatrix=ba.mat4f64.create();b._layerViews=[[],[]];b._layerIndexByLayerViewId=[{},{}];b._basemapLayerViewHandles={};b._handles=new V;b._lowPrioUpdates=new Y;b._topLevelTilemapOnlyTiles=Array(e.TILEMAP_SIZE_EXP+1);b._upsampleInfoPool=new z(oa);b._getElevationData={spatialReference:null,rootTiles:null};b.loaded=!1;b.maxTextureScale=1.2;b.rootTiles=null;
b.backgroundImage=e.DEFAULT_TILE_BACKGROUND;b.backgroundColor=null;b._lercWorker=G.acquireInstance(a.resourceController.scheduler);for(a=0;a<b._topLevelTilemapOnlyTiles.length;a++)b._topLevelTilemapOnlyTiles[a]=new na([a-e.TILEMAP_SIZE_EXP,0,0],b._upsampleInfoPool);return b}P(c,x);c.prototype.normalizeCtorArgs=function(a,b){this._view=a;this._stage=a._stage;this._set("manifold",b);return{}};c.prototype.initialize=function(){var a=this;this._tilePool="planar"===this.manifold?new z(ja):new z(ka);this._memCache=
this._view.resourceController.memoryController.getMemCache("esri.views.3d.terrain",function(b){return a._renderer.releaseTileGeometry(b.renderData)});this._renderer=new ma(this.manifold,this._memCache);this._renderer.loaded=this._setLoaded.bind(this);this._renderer.install(this._view._stage);E.init(this,"_background",function(){a._renderer.setTileBackground(a._background)});this._handles.add(this._view.watch("pointsOfInterest",function(b){a._renderer.pointsOfInterest=b}));this._set("overlayManager",
new ia.OverlayManager({terrainSurface:this,view:this._view}));this._handles.add(this.watch("overlayManager.hasHighlights",this._handleHasHighlights.bind(this)),"overlayManager");var b={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?new J.SurfaceExtentHelperGlobal(b):new J.SurfaceExtentHelperLocal(b);this._handles.add(E.init(this.extentHelper,"stencilEnabledExtents",function(b){a._renderer.setStencilEnabledLayerExtents(b)}),
"extentHelper");b=this._view.defaultsFromMap?new T({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(a){return a.layers}}):this._view.map.allLayers;b=new la({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",
this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._streamDataRequester=this._view.resourceController.createStreamDataRequester(fa.ClientType.TERRAIN);this._handles.add(this._view.resourceController.scheduler.registerTask(1,function(b){return a._frame(b)},function(){return a.ready&&(a._pendingUpdates||a._lvPendingUpdates)}));this._viewChangeUpdate=this._viewChangeUpdate.bind(this);this._view.resourceController.memoryController.events.on("quality-changed",
function(){return a._viewChangeUpdate()});this._handles.add([this._view.on("resize",this._viewChangeUpdate),this._view.watch("state.camera",this._viewChangeUpdate,!0),this._view.watch("qualitySettings.tiledSurface.lodBias",this._viewChangeUpdate),this._view.watch("clippingArea",this._clippingChanged.bind(this))],"view");this._handles.add(this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),"allLayerViews");this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),
removed:[],moved:[],target:this._view.allLayerViews});this._updateClippingExtent();this.notifyChange("extent")};c.prototype.destroy=function(){this._handles.destroy();G.releaseInstance(this._lercWorker);this._lercWorker=null;this._removeAllTiles();this._memCache.destroy();this._memCache=null;this.tilingSchemeLogic.destroy();this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;for(var a in this._basemapLayerViewHandles)this._unregisterTiledLayerView(a);this._streamDataRequester=
null;this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._tilePool.destroy();this._tilePool=null;ga.Pool.prune(0);ha.Pool.prune(0);this._renderer.destroy(this._stage);this._renderer=null;this._iteratorPool.destroy();this._stage=this._view=this._iteratorPool=null;this._upsampleInfoPool.destroy();this._upsampleInfoPool=null};Object.defineProperty(c.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"frustum",{get:function(){return this._frustum},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"cullBackFaces",{set:function(a){this._renderer.cullBackFaces=a;this._set("cullBackFaces",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"baseOpacity",{set:function(a){this._renderer.opaque=1<=a;this._set("baseOpacity",a);this._updateTileTextures(!0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"skirtScale",{set:function(a){this._renderer.skirtScale=
a;this._set("skirtScale",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){var a=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",
{set:function(a){this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOvergroundEnabled=a);this._set("velvetOverground",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"wireframe",{set:function(a){this._renderer.setWireframe(a);this._set("wireframe",a)},enumerable:!0,configurable:!0});c.prototype.setVisibility=
function(a){a!==this.visible&&(this.visible=a,this._renderer.setVisibility(a),this.setUpdatesDisabled(!a),a&&this._viewChangeUpdate())};c.prototype.isVisible=function(){return this.visible&&this.ready};c.prototype.isOpaque=function(){return this._renderer.isOpaque()};c.prototype.setUpdatesDisabled=function(a){(this.suspended=a)||this._viewChangeUpdate()};c.prototype.intersect=function(a,b,d,c){this._renderer.intersect(a,b,d,c,null)};c.prototype.getElevation=function(a){var b=this._getElevationData.rootTiles;
if(!b||!b.length||0===b[0].layerInfo[e.LayerClass.ELEVATION].length)return null;var d=y;if(Array.isArray(a))d=a;else if("point"===a.type&&!A.pointToVector(a,d,this._getElevationData.spatialReference))return q.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(var c=0;c<b.length;c++)if(a=b[c],w.isPosWithinTile(a,d)){for(;a&&!a.renderData;)b=0,d[0]>.5*(a.extent[0]+a.extent[2])&&(b+=1),d[1]<.5*(a.extent[1]+a.extent[3])&&(b+=2),a=a.children[b];
if(b=(b=a.renderData)&&b.geometryState?b.geometryState.samplerData:null)return I.sample(d[0],d[1],b);break}return null};c.prototype.getElevationBounds=function(){return this._elevationBounds};c.prototype.getScale=function(a){if(this.tilingScheme){if(!A.pointToVector(a,y,this.spatialReference))return q.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;var b=this.rootTiles;if(b)for(var d=0;d<b.length;d++)if(a=b[d],w.isPosWithinTile(a,y)){for(;null!=
a.children[0];)b=0,y[0]>a.children[0].extent[2]&&(b+=1),y[1]<a.children[0].extent[1]&&(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.lij[0])}}return 1E100};c.prototype.queryVisibleScaleRange=function(a,b,d,c){b=b?this.tilingScheme.levelAtScale(b):0;d=d?this.tilingScheme.levelAtScale(d):Infinity;var k=this._getLodBias();this._renderer.queryVisibleLevelRange(a,b+k,d+k,c)};c.prototype._setLoaded=function(){this.loaded||this._set("loaded",!0)};c.prototype._updateTilingSchemeAndExtent=
function(){var a=this.tilingSchemeLogic.extent,b=a&&!p.equals(a,this._dataExtent);b&&(this._dataExtent?p.set(this._dataExtent,a):this._dataExtent=p.create(a));var a=this.tilingSchemeLogic.tilingScheme,d=a!==this.tilingScheme;d&&(m.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize[0]),this.overlayManager.setSpatialReference(a.spatialReference,
"spherical"===this.manifold)));(b||d)&&this._updateRootTiles()};c.prototype._acquireTile=function(a,b,d,c){var k=this._tilePool.acquire();B[0]=a;B[1]=b;B[2]=d;k.init(B,c,this);return k};c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,d=this.tilingScheme;if(b&&d){this._memCache.clear();var c=ta,g=d.rootTilesInExtent(b,c,Infinity),f=function(b){b=a._acquireTile(0,b[1],b[2],null);b.shouldSplit(a._splitLimits,a._eyePosRenderSR)===e.TileUpdate.SPLIT&&b.setPendingUpdate(e.TileUpdate.SPLIT);
a._loadTile(b);return b};if(this.rootTiles){if(g.length>e.MAX_ROOT_TILES){q.warn(e.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}var b=this.rootTiles.map(function(a){return a.lij}),n=D.difference(b,g,M);if(0<n.removed.length||0<n.added.length){var t=this.rootTiles.filter(function(b){return-1<D.findIndex(n.removed,M.bind(null,b.lij))?(a._purgeTile(b),!1):!0});n.added.forEach(function(a){return t.push(f(a))});this._setRootTiles(t)}}else g.length>e.MAX_ROOT_TILES&&(q.warn(e.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),
g=d.rootTilesInExtent(b,c,e.MAX_ROOT_TILES)),this._setRootTiles(g.map(function(a){return f(a)}));p.equals(c,this._rootExtent)||(this._rootExtent=p.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.setVisibility(!0);this._viewChangeUpdate();this.overlayManager.setOverlayPlacementDirty();this.notifyChange("ready")}};c.prototype._setRootTiles=function(a){this._set("rootTiles",a);this._getElevationData.rootTiles=a;this._renderer.setRootTiles(this.rootTiles)};c.prototype._viewChangeUpdate=
function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateSkirts(),this._updateOverlayOpacity(this._eyePosSurfaceSR[2]),this._updateTiles())};c.prototype._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.resetPendingUpdate(e.TileUpdate.GEOMETRY)&&this._updateTileGeometry(a)};c.prototype._updateTiles=function(a){void 0===a&&(a=this.rootTiles);if(a){var b=this._iteratorPool.acquire();b.reset(a);var d=
this._splitLimits,c;w.hasVisibleSiblings(a)?(a=this._elevationBounds[0],c=this._elevationBounds[1]):(a=Infinity,c=-Infinity);for(;!b.done;){var g=b.next();this._updateClippingStatus(g);g.updateVisibility();if(g.visible){g.updateScreenDepth(this._viewProjectionMatrix);g.renderData&&(a=Math.min(g.elevationBounds[0],a),c=Math.max(g.elevationBounds[1],c));var f=g.shouldSplit(d,this._eyePosRenderSR);if(f===e.TileUpdate.SPLIT){g.resetPendingUpdate(e.TileUpdate.MERGE);g.isLeaf&&(g.setPendingUpdate(e.TileUpdate.SPLIT),
b.skipSubtree());this._pendingUpdates=this._pendingUpdates||g.hasPendingUpdates;continue}g.resetPendingUpdate(e.TileUpdate.SPLIT)&&g.updateAgentSuspension();f===e.TileUpdate.VSPLITMERGE&&g.updateAgents(e.LayerClass.ELEVATION)}b.skipSubtree();if(!g.renderData){g.setPendingUpdate(e.TileUpdate.MERGE);g.resetPendingUpdate(e.TileUpdate.SPLIT);f=this._iteratorPool.acquire();for(f.resetOne(g);!f.done;){var n=f.next();this._updateClippingStatus(n);n.updateVisibility();n.visible&&n.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(f)}this._pendingUpdates=
this._pendingUpdates||g.hasPendingUpdates}this._iteratorPool.release(b);isFinite(a)&&isFinite(c)&&(this._elevationBounds[0]!==a||this._elevationBounds[1]!==c)&&(this._elevationBounds[0]=a,this._elevationBounds[1]=c,this.emit("elevation-bounds-change",null))}};c.prototype._updateViewDependentParameters=function(){var a=this._view.state.camera,b=Math.tan(.5*a.fovX),d=Math.tan(.5*a.fovY),c=this.tilingScheme.pixelSize,g=Math.pow(2,-this._getLodBias())*a.pixelRatio;this._splitLimits[0]=b;this._splitLimits[1]=
c[0]/a.width*this.maxTextureScale*g;this._splitLimits[2]=d;this._splitLimits[3]=c[1]/a.height*this.maxTextureScale*g;this._splitLimits[4]=this.tilingScheme.getMaxLod();this._splitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias;H.frustum.copy(a.frustum,this._frustum);aa.mat4.multiply(this._viewProjectionMatrix,a.projectionMatrix,a.viewMatrix);ca.vec3.copy(this._eyePosRenderSR,a.eye);A.vectorToVector(this._eyePosRenderSR,this._view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};
c.prototype._updateSkirts=function(){m.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,this._view.state.camera.near)};c.prototype._setLayerViewsUpdating=function(){for(var a=0;a<e.LayerClass.COUNT;a++)for(var b=0,d=this._layerViews[a];b<d.length;b++)d[b].updatingChanged(this._pendingUpdates)};c.prototype._updateTileGeometry=function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);this._elevationUpdate(a);this._memoryUsed=0};c.prototype._elevationUpdate=function(a){C.spatialReference=
this.spatialReference;C.tile=a;C.extent=a.extent;this.emit("elevation-change",C);p.containsPoint(a.extent,this._eyePosSurfaceSR)&&this._updateSkirts()};c.prototype._frame=function(a){var b=this;this._frameTraversal(a);a.run(function(){w.sortTiles(b._renderer.renderOrder,b._lowPrioUpdates);return!1});this._processElevation(a)&&this._processTextures(a)&&!this._view.resourceController.hasPendingDownloads&&0===this._asyncWorkItems||(this._pendingUpdates=!0);this.isVisible()&&this.overlayManager&&this.overlayManager.needsUpdate()&&
(a.done?this._pendingUpdates=!0:(this.overlayManager.updateOverlays(),this._updateOverlayOpacity(this._eyePosSurfaceSR[2])));this._lowPrioUpdates.clear();(this._pendingUpdates||20===++this._updateNextFrame)&&this._updatedThrottledPendingUpdates()};c.prototype._updatedThrottledPendingUpdates=function(){this._lvPendingUpdates!==this._pendingUpdates&&(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,this._updateNextFrame=0)};c.prototype._frameTraversal=function(a){if(!this.suspended&&
this._pendingUpdates){this._lowPrioUpdates.clear();this._pendingUpdates=!1;var b=this._iteratorPool.acquire();b.reset(this.rootTiles);for(var d=0,c=!1,g=[];!b.done&&!a.done;){var f=b.next(),d=d+f.memoryUsed;f.resetPendingUpdate(e.TileUpdate.MERGE)?(this._mergeTile(f),a.madeProgress(),b.skipSubtree()):f.resetPendingUpdate(e.TileUpdate.SPLIT)?(this._splitTile(f)&&(c=this._pendingUpdates=!0,g.push(f)),a.madeProgress(),b.skipSubtree()):f.hasPendingUpdates&&this._lowPrioUpdates.push(f);this._pendingUpdates=
this._pendingUpdates||f.hasPendingUpdates;b.done&&(b.reset(g),g.length=0)}this._pendingUpdates=this._pendingUpdates||!b.done;!c&&b.done&&(this._memoryUsed=d);this._iteratorPool.release(b)}};c.prototype._processElevation=function(a){for(var b=this,d=function(d){var f=c._lowPrioUpdates.data[d];if(!a.run(function(){if(f.resetPendingUpdate(e.TileUpdate.GEOMETRY))return b._updateTileGeometry(f),!0}))return{value:!1}},c=this,g=0;g<this._lowPrioUpdates.length;++g){var f=d(g);if("object"===typeof f)return f.value}return!0};
c.prototype._processTextures=function(a){for(var b=this,d=function(d){var f=c._lowPrioUpdates.data[d];if(!a.run(function(){return f.resetPendingUpdate(e.TileUpdate.TEXTURE)?(b._renderer.updateTileTexture(f),b._memoryUsed=0,!0):!1}))return{value:!1}},c=this,g=0;g<this._lowPrioUpdates.length;++g){var f=d(g);if("object"===typeof f)return f.value}return!0};c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=p.create(),b=null;A.extentToBoundingRect(this._view.clippingArea,
a,this.spatialReference)&&(b=a);if(p.equals(b,this._clippingExtent))return!1;this._memCache.clear();this._clippingExtent=b;this._renderer.clippingExtent=b;this.notifyChange("extent");this.updateTileOverlayParams();this.overlayManager.setOverlayPlacementDirty();return!0};c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};c.prototype._getLodBias=function(){return this._view.qualitySettings.tiledSurface.lodBias-(1-this._view.resourceController.memoryController.memoryFactor)*
e.MAX_MEMORY_LOD_BIAS};c.prototype._getLodBiasCorrectedScale=function(a){var b=this.tilingScheme.levels;a=X.clamp(a-this._getLodBias(),0,b.length-1);var d=a-Math.floor(a);return b[Math.floor(a)].scale*(1-d)+b[Math.ceil(a)].scale*d};c.prototype._cancelTilemapRequests=function(a){var b=0;for(a=a.layerInfo;b<a.length;b++){var d=a[b];if(d)for(var c=0;c<d.length;c++)d[c].abortTilemapRequest()}};c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){return a._purgeTile(b)}),
this._setRootTiles(null),this.notifyChange("ready"));for(var b=0;b<this._topLevelTilemapOnlyTiles.length;b++)this._cancelTilemapRequests(this._topLevelTilemapOnlyTiles[b]);this.setVisibility(!1)};c.prototype._purgeChildTiles=function(a){for(var b in a.children){var c=a.children[b];null!=c&&(a.children[b]=null,this._purgeTile(c))}};c.prototype._purgeTile=function(a){this._purgeChildTiles(a);a.unload(this._renderer);this._cancelTilemapRequests(a);a.dispose();this._tilePool.release(a)};c.prototype._splitTile=
function(a){var b=a.lij[0]+1,c=2*a.lij[1],k=2*a.lij[2];a.children[0]=this._createTile(b,c,k,a);a.children[1]=this._createTile(b,c,k+1,a);a.children[2]=this._createTile(b,c+1,k,a);a.children[3]=this._createTile(b,c+1,k+1,a);a.unload(this._renderer);u.spatialReference=this.spatialReference;u.extent=a.extent;u.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",u);return a.children[0].hasPendingUpdate(e.TileUpdate.SPLIT)||a.children[1].hasPendingUpdate(e.TileUpdate.SPLIT)||a.children[2].hasPendingUpdate(e.TileUpdate.SPLIT)||
a.children[3].hasPendingUpdate(e.TileUpdate.SPLIT)};c.prototype._createTile=function(a,b,c,k){m.weakAssert(!!k,"_createTile sanity check");a=this._acquireTile(a,b,c,k);a.updateClippingStatus(this._clippingExtent);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._splitLimits,this._eyePosRenderSR)===e.TileUpdate.SPLIT&&a.setPendingUpdate(e.TileUpdate.SPLIT));this._loadTile(a);return a};c.prototype._mergeTile=function(a){m.weakAssert(!a.renderData,"_mergeTile sanity check");
m.weakAssert(!a.hasPendingUpdate(e.TileUpdate.SPLIT),"_mergeTile sanity check");this._loadTile(a);this._purgeChildTiles(a);u.spatialReference=this.spatialReference;u.extent=a.extent;u.scale=this._getLodBiasCorrectedScale(a.lij[0]);this.emit("scale-change",u)};c.prototype._loadTile=function(a){a.load(this._renderer);this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(a,a.renderData,this._overlayOpacity);this._elevationUpdate(a)};c.prototype._handleHasHighlights=
function(a){this._renderer.setNeedsHighlight(a)};c.prototype._elevationDataUpdated=function(a,b){var c=a.layerInfo[e.LayerClass.ELEVATION][b],k=[a],g=a.lij[0],f=this._iteratorPool.acquire();for(f.reset(k);!f.done;){var n=f.next();n.findElevationBoundsForLayer(b,g);n.computeElevationBounds()}this._iteratorPool.release(f);a.dataArrived(b,e.LayerClass.ELEVATION,c.data);this._updateTiles(k)};c.prototype._handleLayerViewChanges=function(a){var b=this,c=!1;a.added.forEach(function(a){var d=a.layer;m.isTiledLayerView(a)?
(b._registerTiledLayer(a),d.loaded&&(c=!0),a.updatingChanged(b._pendingUpdates)):a.supportsDraping&&b.overlayManager&&b.overlayManager.registerLayerView(a)});a.removed.forEach(function(a){m.isTiledLayerView(a)?(c=!0,b._unregisterTiledLayerView(a.uid)):a.supportsDraping&&b.overlayManager&&b.overlayManager.unregisterLayerView(a)});(c=c||0<a.moved.filter(m.isTiledLayerView).length)&&this._updateTiledLayers()};c.prototype._registerTiledLayer=function(a){var b=this,c=[];c.push(a.watch("suspended",function(){return b._updateTiledLayers()}));
c.push(a.watch("fullOpacity",function(){return b._updateTileTextures(!1)}));a.on("data-changed",function(){var c=m.isElevationLayerView(a)?e.LayerClass.ELEVATION:e.LayerClass.MAP,d=b._layerIndexByLayerViewId[c][a.uid];null!=d&&b._invalidateLayerData(d,c)});this._basemapLayerViewHandles[a.uid]=c};c.prototype._unregisterTiledLayerView=function(a){var b=this._basemapLayerViewHandles[a];if(b){for(var c=0;c<b.length;c++)b[c].remove();delete this._basemapLayerViewHandles[a]}};c.prototype._updateTiledLayers=
function(){var a=this;if(this.tilingScheme&&!this._view.suspended){var b=this._view.allLayerViews,c=[[],[]],k=null,g=p.empty();b.forEach(function(b){var d=b.layer;if(d&&!b.suspended&&m.isTiledLayerView(b)){var f=b.fullExtent;f?a.tilingScheme.compatibleWith(b.tileInfo)?(p.expand(g,f),m.isElevationLayerView(b)?c[e.LayerClass.ELEVATION].push(b):(d=b.displayLevelRange,Infinity!==d.maxLevel&&(null===k||d.maxLevel>k)&&(k=d.maxLevel),c[e.LayerClass.MAP].push(b))):q.warn("Terrain: tiling scheme of layer "+
d.id+" is incompatible with other tiled layers, will not be drawn"):q.warn("Terrain: Map or elevation layer does not have fullExtent: "+d.id)}},this);for(var b=function(a){var b=f._layerViews[a],d=c[a];d.reverse();var g=d.length,k=b.length!==g,n=Array(g),t=Array(b.length);f._layerIndexByLayerViewId[a]={};for(var h=0;h<g;h++){f._layerIndexByLayerViewId[a][d[h].uid]=h;var l=b.indexOf(d[h]);n[h]=l;h!==l&&(k=!0);-1<l&&(t[l]=h)}if(k){f._topLevelTilemapOnlyTiles.forEach(function(b){return b.modifyLayers(t,
n,a)});b=f._postorderIterator;for(b.reset(f.rootTiles);!b.done;)b.next().modifyLayers(t,n,a);f._layerViews[a]=d;a===e.LayerClass.ELEVATION&&f._memCache.clear();for(b.reset(f.rootTiles);!b.done;)d=b.next(),d.restartAgents(a),a===e.LayerClass.ELEVATION&&d.computeElevationBounds();f._updateTiles()}},f=this,n=0;n<e.LayerClass.COUNT;n++)b(n);this.tilingScheme.ensureMaxLod(k)&&this._viewChangeUpdate()}};c.prototype._hasFixedExtent=function(){return!!this._clippingExtent};c.prototype.layerViewByIndex=function(a,
b){return this._layerViews[b][a]};c.prototype.numLayers=function(a){return this._layerViews[a].length};c.prototype._updateTileTextures=function(a){var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.updateAgents(e.LayerClass.MAP);a&&this.renderer.updateTileTexture(c)}this._iteratorPool.release(b)};c.prototype._invalidateLayerData=function(a,b){var c=this._iteratorPool.acquire();for(c.reset(this.rootTiles);!c.done;)c.next().removeLayerAgent(a,b);for(c.reset(this.rootTiles);!c.done;)c.next().invalidateLayerData(a,
b);this._iteratorPool.release(c);b===e.LayerClass.ELEVATION&&this._memCache.clear()};c.prototype.setPendingUpdates=function(){this._pendingUpdates=!0;this._updatedThrottledPendingUpdates()};c.prototype.requestTileData=function(a,b,c,k){var d=this,f=this.layerViewByIndex(b,c),e=f.layer;if(e.tilemapCache&&!m.isVectorTileLayerView(f)){var t=this.getTilemapTile(a),h=t.layerInfo[c][b];if(h.tilemap){if(!t.hasDataAvailable(a,b,c))return this._dispatchDataEvent(a,"dataMissing",c,f,{notInTilemap:!0}),v.reject()}else return h.tilemapRequestPromise||
(h.tilemapRequestAbort=v.createAbortController(),h.tilemapRequestPromise=this.requestTilemap(t,b,c,f,e,{signal:h.tilemapRequestAbort.signal})),++this._asyncWorkItems,h.tilemapRequestPromise.catch(function(){}).then(function(){--d._asyncWorkItems;h.tilemapRequestPromise=null;h.tilemapRequestAbort=null;v.throwIfAborted(k);var b=d._layerIndexByLayerViewId[c][f.uid];if(null!=b){if(t.hasDataAvailable(a,b,c))return d._requestTileData(a,b,c,f,k);d._dispatchDataEvent(a,"dataMissing",c,f,{notInTilemap:!0});
return v.reject()}})}return this._requestTileData(a,b,c,f,k)};c.prototype._requestTileData=function(a,b,c,k,g){return c===e.LayerClass.ELEVATION?this._requestElevationTileData(a,b,c,k,g):this._requestMapTileData(a,b,c,k,g)};c.prototype._requestElevationTileData=function(a,b,c,k,g){var d=this;if(m.isElevationLayerView(k)){var h=function(f){d._asyncWorkItems--;var g=d._layerIndexByLayerViewId[c][k.uid];null==g?q.warn("TerrainSurface: received data from unknown layer %d %s",c,a.lij.toString()):(g=a.layerInfo[c][g],
d._memoryUsed=0,g.data=I.create(a.lij,a.extent,f),d._elevationDataUpdated(a,b),d._pendingUpdates=!0)},t=function(b){d._asyncWorkItems--;v.isAbortError(b)||d._dispatchDataEvent(a,"dataMissing",c,k,b)};this._asyncWorkItems++;if(m.useFetchTileForLayer(k.layer))return k.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],{noDataValue:e.ELEVATION_NODATA_VALUE,signal:g.signal}).then(function(a){return h(a)},t);var l=k.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._streamDataRequester(l,"binary",g).then(function(a){return d._lercWorker.decode(a,
{noDataValue:e.ELEVATION_NODATA_VALUE},g.signal)}).then(function(a){h({values:a.pixelData,width:a.width,height:a.height,noDataValue:a.noDataValue,minValue:a.minValue,maxValue:a.maxValue})}).catch(function(a){return t(a)})}m.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")};c.prototype._requestMapTileData=function(a,b,c,e,g){var d=this;++this._asyncWorkItems;var k=function(b){--d._asyncWorkItems;d._dispatchDataEvent(a,"dataArrived",c,e,b)};b=function(b){--d._asyncWorkItems;
v.isAbortError(b)||d._dispatchDataEvent(a,"dataMissing",c,e,b)};if(m.isVectorTileLayerView(e)){var h=e.tileHandler,l=e.schemaHelper.getLevelRowColumn(a.lij);return S.safeCast(h.getVectorTile3D(l[0],l[1],l[2],0)).then(function(a){Z.isAborted(g)?--d._asyncWorkItems:k(a)},b)}if(m.useFetchTileForLayer(e.layer)&&m.isTileLayerView(e))return e.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],g).then(k,b);h=e.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);null!=e.refreshInterval&&e.refreshTimestamp&&(h+=(-1<h.indexOf("?")?
"\x26":"?")+"_ts\x3d"+e.refreshTimestamp);return this._streamDataRequester(h,"image",g).then(k,b)};c.prototype.requestTilemap=function(a,b,c,k,g,f){var d=this;return g.tilemapCache.fetchTilemap(a.lij[0]+e.TILEMAP_SIZE_EXP,a.lij[1]<<e.TILEMAP_SIZE_EXP,a.lij[2]<<e.TILEMAP_SIZE_EXP,O({},f,{timeout:6E3})).then(function(f){b=d._layerIndexByLayerViewId[c][k.uid];null!=b&&(a.layerInfo[c][b].tilemap=f)}).catch(function(a){})};c.prototype.getTilemapTile=function(a){var b=a.lij[0];return b>e.TILEMAP_SIZE_EXP?
w.getTileNLevelsUp(a,e.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[b]};c.prototype._dispatchDataEvent=function(a,b,c,e,g){e=this._layerIndexByLayerViewId[c][e.uid];if(null!=e)a[b](e,c,g);else q.warn("TerrainSurface: received data from unknown layer")};c.prototype.updateTileOverlayParams=function(){if(this.rootTiles){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(b,b.renderData,
this._overlayOpacity)}this._iteratorPool.release(a);this._renderer.setNeedsRender()}};c.prototype._updateOverlayOpacity=function(a){if(this.overlayManager&&(a=this.overlayManager.updateOpacity(a),!isNaN(a)&&a!==this._overlayOpacity)){var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.renderData&&(c.renderData.overlayOpacity=a)}this._iteratorPool.release(b);this._overlayOpacity=a;this._renderer.setNeedsRender()}};c.prototype.getStats=function(){var a={numNodes:0,
numLeaves:0,numVisible:0,numVisiblePerLevel:[]},b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();a.numNodes++;c.renderData&&(a.numLeaves++,c.visible&&(a.numVisible++,c=c.lij[0],a.numVisiblePerLevel[c]=null==a.numVisiblePerLevel[c]?1:a.numVisiblePerLevel[c]+1))}this._iteratorPool.release(b);return a};c.prototype.getUsedMemory=function(){if(!this.tilingScheme)return 0;if(0<this._memoryUsed)return this._memoryUsed;var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=
a.next();this._memoryUsed+=b.memoryUsed}this._iteratorPool.release(a);return this._memoryUsed};c.prototype.getMemoryUsage=function(){if(!this.tilingScheme)return{};var a=0,b=0,c=0,k=0,g=0,f=0,h=this._iteratorPool.acquire();h.reset(this.rootTiles);for(var l=this.tilingScheme.pixelSize,l=l[0]*l[1]*4;!h.done;){for(var m=h.next(),p=N(m),q=0,u=m.layerInfo[e.LayerClass.MAP];q<u.length;q++){var r=u[q],r=r.data,v=0,w=0;r instanceof pa?v+=L.getGpuMemoryUsage(r):r instanceof HTMLImageElement?w+=l:r instanceof
ea&&(f+=r.getGpuMemoryUsage(),c+=r.getCpuMemoryUsage());m.renderData||p?(a+=w,k+=v):(b+=w,g+=v)}p=0;for(q=m.layerInfo[e.LayerClass.ELEVATION];p<q.length;p++)r=q[p],r=r.data,a+=r?l:0;m.renderData&&(r=m.renderData.textureDescriptor,k+=r?L.getGpuMemoryUsage(r):0,m=m.renderData.estimatedGeometryMemoryUsage,f+=m,c+=m)}this._iteratorPool.release(h);return{cpuVisibleImageData:a,cpuInvisibleImageData:b,cpuGeometryData:c,gpuVisibleImageData:k,gpuInvisibleImageData:g,gpuGeometryData:f}};c.prototype.getTile=
function(a){var b=a.split("/").map(function(a){return+a});if(0===b[0])return this.rootTiles.forEach(function(a){if(a.lij[1]===b[1]&&a.lij[2]===b[2])return a}),null;var c=Math.pow(2,b[0]),e=Math.floor(b[1]/c),g=Math.floor(b[2]/c),f;this.rootTiles.some(function(a){return a.lij[1]===e&&a.lij[2]===g?(f=a,!0):!1});if(f){for(c=1<<b[0]-1;f.lij[0]<b[0];){var h=b[1]&c?2:0;0<(b[2]&c)&&h++;if(!f.children[h])return console.log("Tile "+a+" doesn't exist, smallest ancestor is "+w.tile2str(f)),null;f=f.children[h];
c>>=1}m.weakAssert(f.lij[0]===b[0]&&f.lij[1]===b[1]&&f.lij[2]===b[2],"not the right tile?");return f}return null};c.prototype.setBorders=function(a){this._renderer.renderPatchBorders=a};c.prototype.setDisableRendering=function(a){this._renderer.renderingDisabled=a};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{renderer:this._renderer,lercWorker:this._lercWorker,mergeTile:function(b){return a._mergeTile(b)},updateTiles:function(b){return a._updateTiles(b)}}},enumerable:!0,
configurable:!0});l([h.property({value:!1})],c.prototype,"cullBackFaces",null);l([h.property({readOnly:!0})],c.prototype,"extent",null);l([h.property({readOnly:!0})],c.prototype,"loaded",void 0);l([h.property({value:1})],c.prototype,"baseOpacity",null);l([h.property({readOnly:!0})],c.prototype,"overlayManager",void 0);l([h.property({readOnly:!0})],c.prototype,"manifold",void 0);l([h.property()],c.prototype,"maxTextureScale",void 0);l([h.property({readOnly:!0})],c.prototype,"ready",null);l([h.property({value:1})],
c.prototype,"renderOrder",null);l([h.property({readOnly:!0})],c.prototype,"rootTiles",void 0);l([h.property({value:!0})],c.prototype,"skirtScale",null);l([h.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],c.prototype,"spatialReference",null);l([h.property({})],c.prototype,"backgroundImage",void 0);l([h.property({type:Q})],c.prototype,"backgroundColor",void 0);l([h.property({dependsOn:["backgroundColor","backgroundImage"]})],c.prototype,"_background",null);l([h.property({value:!1})],
c.prototype,"slicePlaneEnabled",null);l([h.property({readOnly:!0})],c.prototype,"tilingScheme",void 0);l([h.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0);l([h.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],c.prototype,"tilingSchemeDone",void 0);l([h.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0);l([h.property({value:!0})],c.prototype,"velvetOverground",null);l([h.property({value:!1})],c.prototype,
"wireframe",null);return c=l([h.subclass("esri.views.3d.terrain.TerrainSurface")],c)}(h.declared(R,U));var qa=1.2,ra=80/180*Math.PI,sa=110/180*Math.PI,y=da.vec4f64.create(),ta=p.create(),B=[0,0,0],C={spatialReference:null,tile:null,extent:null},u={spatialReference:null,extent:null,scale:0};return x});