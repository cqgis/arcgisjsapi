// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Point ./Graphics3DSymbolCommonCode ./graphicUtils ../../support/debugFlags ../../support/projectionUtils ../../webgl-engine/lib/Util".split(" "),function(N,p,H,u,v,m,I,A,J,B,F,K){Object.defineProperty(p,"__esModule",{value:!0});var L=K.VertexAttrConstants,w=new I,g=m.vec3f64.create(),e=m.vec3f64.create(),
t=m.vec3f64.create(),c=u.mat4f64.create(),G=m.vec3f64.create(),q={verticalDistanceToGround:0,terrainElevation:0};p.perVertexElevationAligner=function(d,a,h,b){d=d.stageObject;w.spatialReference=h.spatialReference;for(var C=d.getGeometryRecords(),k=C.length,c="absolute-height"!==a.mode,r=0,x=0;x<k;x++){var f=C[x].geometry,n=C[x].getShaderTransformation();e[0]=n[12];e[1]=n[13];e[2]=n[14];f.invalidateBoundingInfo();for(var n=f.data.getVertexAttr(),y=n[L.POSITION],f=y.data,n=n.mapPos.data,y=y.size,m=
f.length/y,l=0,D=0,E=!1,u=0,v=0;v<m;v++){w.x=n[D++];w.y=n[D++];w.z=n[D++];t[0]=f[l];t[1]=f[l+1];t[2]=f[l+2];var z=A.computeElevation(h,w,a,b,c?q:null);c&&(u+=q.terrainElevation);g[0]=f[l]+e[0];g[1]=f[l+1]+e[1];g[2]=f[l+2]+e[2];b.setAltitude(z,g);f[l]=g[0]-e[0];f[l+1]=g[1]-e[1];f[l+2]=g[2]-e[2];if(B.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS)E=!0;else if(z=p.updateThresholdInMeters/b.unitInMeters,Math.abs(t[0]-f[l])>=z||Math.abs(t[1]-f[l+1])>=z||Math.abs(t[2]-f[l+2])>=z)E=!0;l+=y}r+=u/m;E&&d.geometryVertexAttrsUpdated(x)}return r/
k};p.perObjectElevationAligner=function(d,a,h,b,c){d=d.stageObject;var k=a.centerPointInElevationSR,e=0;c=0;if(d.metadata.usesVerticalDistanceToGround)e=A.computeElevation(h,k,a,b,q),J.updateVertexAttributeAuxpos1w(d,q.verticalDistanceToGround),c=q.terrainElevation;else{var r="absolute-height"!==a.mode,e=A.computeElevation(h,k,a,b,r?q:null);r&&(c=q.terrainElevation)}a=H.mat4.copy(M,d.objectTransformation);h=v.vec3.set(G,a[12],a[13],a[14]);B.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(g[0]=k.x,g[1]=
k.y,g[2]=e,F.computeLinearTransformation(k.spatialReference,g,a,b.spatialReference)&&(d.objectTransformation=a)):b.setAltitudeOfTransformation(e,a);b=p.updateThresholdInMeters/b.unitInMeters;if(Math.abs(a[12]-h[0])>=b||Math.abs(a[13]-h[1])>=b||Math.abs(a[14]-h[2])>=b)d.objectTransformation=a;return c};var M=u.mat4f64.create();p.perLodInstanceElevationAligner=function(d,a,h,b,e){var k=a.centerPointInElevationSR,m=0;e=0;var r="absolute-height"!==a.mode,m=A.computeElevation(h,k,a,b,r?q:null);r&&(e=q.terrainElevation);
a=d.graphics3DSymbolLayer.lodRenderer.instanceData;d=d.instanceIndex;a.getGlobalTransform(d,c);h=v.vec3.set(G,c[12],c[13],c[14]);B.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(g[0]=k.x,g[1]=k.y,g[2]=m,F.computeLinearTransformation(k.spatialReference,g,c,b.spatialReference)&&a.setGlobalTransform(d,c)):b.setAltitudeOfTransformation(m,c);b=p.updateThresholdInMeters/b.unitInMeters;(Math.abs(c[12]-h[0])>=b||Math.abs(c[13]-h[1])>=b||Math.abs(c[14]-h[2])>=b)&&a.setGlobalTransform(d,c);return e};p.updateThresholdInMeters=
.01;p.iterativeUpdatesEnabled=!0});