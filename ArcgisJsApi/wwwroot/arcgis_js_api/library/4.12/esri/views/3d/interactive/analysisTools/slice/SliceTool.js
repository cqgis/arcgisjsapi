// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/clock ../../../../../core/Collection ../../../../../core/Handles ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../layers/Layer ../../../../../layers/buildingSublayers/BuildingComponentSublayer ./sliceToolConfig ./sliceToolUtils ./sliceToolUtils ../../../support/geometryUtils ../../../support/stack ../../../../interactive/InteractiveToolBase ../../../../interactive/interactiveToolUtils ../../../../interactive/manipulatorUtils".split(" "),
function(r,P,E,n,F,G,A,H,l,I,p,J,m,u,g,y,B,K,f,k,v,d,h,L,q,M){function C(g,b,f,a){f=k.createShiftPlane(f,a.plane,g.direction,d.plane.create());a=y.vec3f64.create();return d.plane.intersectRay(f,g,a)?{type:"shift",creatingPointerId:b,shiftPlane:f,depth:0,startPoint:a}:null}function z(d){return"mouse"!==d.pointerType||0===d.button}var D=H.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool");r=function(r){function b(a,c){void 0===c&&(c=F.default);a=r.call(this,a)||this;a._clock=c;a.cursor=
null;a.layersMode="none";a.excludedLayers=new G;a.shiftManipulator=null;a.rotateManipulator=null;a.resizeManipulators=null;a.disableEngineLayers=!1;a._handles=new A;a._viewHandles=new A;a._frameTask=null;a._prevPointerMoveTimeout=null;a._previewOutlineManipulator=null;a._previewOutlineMaterial=null;a._outlineManipulator=null;a._gridManipulator=null;a._gridMaterial=null;a._startPlane=d.boundedPlane.create();a._previewPlane=null;a._activeKeyModifiers={};a._lastCursorPosition=p.createScreenPoint();a._baseOpacity=
1;a._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}];return a}E(b,r);w=b;b.prototype.initialize=function(){var a=this;this._handles.add([J.init(this,"state",function(){"sliced"===a.state&&q.setActive(a,!1)},!0),this.view.state.watch("camera",function(){a._updateManipulators()}),this.excludedLayers.on("before-add",function(c){var b=c.item;null!=b&&(b instanceof B||b instanceof K)?b instanceof
B&&k.isAlwaysDrapedLayer(b)?(D.error("excludedLayers","Layer '"+b.title+", id:"+b.id+"' of type '"+b.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),c.preventDefault()):a.excludedLayers.includes(b)&&c.preventDefault():(D.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),c.preventDefault())})]);var c=function(c,b){a._setSingleManipulatorInteractive(c,b);b||(a.plane&&d.boundedPlane.copy(a.plane,a._startPlane),
a.inputState=null)};this.shiftManipulator=k.createShiftManipulator(this.view);this.manipulators.add(this.shiftManipulator);this.shiftManipulator.on("grab",function(c){a._onShiftGrab(c)});this.shiftManipulator.on("drag",function(c){a._onShiftDrag(c)});this._handles.add(this.shiftManipulator.watch("grabbing",function(b){c(a.shiftManipulator,b)},!0));this.rotateManipulator=k.createRotateManipulator(this.view);this.manipulators.add(this.rotateManipulator);this.rotateManipulator.on("grab",function(c){a._onRotateGrab(c)});
this.rotateManipulator.on("drag",function(c){a._onRotateDrag(c)});this._handles.add(this.rotateManipulator.watch("grabbing",function(b){c(a.rotateManipulator,b)},!0));this.resizeManipulators=this._resizeHandles.map(function(b,t){var e=k.createResizeManipulator(a.view,b);e.on("grab",function(c){a._onResizeGrab(c,t)});e.on("drag",function(c){a._onResizeDrag(c)});a._handles.add(e.watch("grabbing",function(a){c(e,a)},!0));return e});this.manipulators.addMany(this.resizeManipulators);var b=k.createOutlineManipulator(this.view),
e=b.material;this._previewOutlineManipulator=b.manipulator;this._previewOutlineMaterial=e;this.manipulators.add(this._previewOutlineManipulator,2);this._outlineManipulator=k.createOutlineManipulator(this.view).manipulator;this.manipulators.add(this._outlineManipulator,1);b=k.createGridManipulator(this.view);e=b.material;this._gridManipulator=b.manipulator;this._gridMaterial=e;this.manipulators.add(this._gridManipulator,2)};b.prototype.destroy=function(){this.detach();this._handles.destroy();this._handles=
null;this._viewHandles.destroy();this._viewHandles=null;this._removeFrameTask();this._clearPointerMoveTimeout()};Object.defineProperty(b.prototype,"state",{get:function(){var a=!!this.plane,c=!!this.inputState;return a?a&&c?"slicing":a&&!c?"sliced":"ready":"ready"},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"plane",{set:function(a){this._set("plane",
a);this.visible&&(this._updateLayerViews(),this.view.slicePlane=a,this._updateManipulators(),a&&this._unsetOtherToolPlanes())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"excludeGroundSurface",{set:function(a){this._set("excludeGroundSurface",a);this._updateLayerViews()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"inputState",{get:function(){return this._get("inputState")},set:function(a){this._set("inputState",a);this._updateMaterials()},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"_isTargeting",{get:function(){return!this.inputState&&!this.plane&&this.active},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_creatingPointerId",{get:function(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null},enumerable:!0,configurable:!0});b.prototype.newSlice=function(){this._reset();this._unsetOtherToolPlanes();q.setActive(this,!0)};b.prototype.clearSlice=function(){this._reset();
q.setActive(this,!1)};b.prototype.enterExcludeLayerMode=function(){this._set("layersMode","exclude");q.setActive(this,!0)};b.prototype.exitExcludeLayerMode=function(){this._set("layersMode","none");q.setActive(this,!1)};b.prototype.deactivate=function(){this._updateMouseCursor();this._set("layersMode","none");"sliced"!==this.state&&(this.plane=null);this._updatePreviewPlane(null)};b.prototype.onDetach=function(){this._reset()};b.prototype.onShow=function(){var a=this;this._updateMouseCursor();this._updateLayerViews();
this._updateManipulators();var c=this.view;c.slicePlane=this.plane;0===this._viewHandles.size&&this._viewHandles.add([c.allLayerViews.on("change",function(){a._updateLayerViews()}),this.excludedLayers.on("change",function(c){a._updateLayerViews()})])};b.prototype.onHide=function(){this._updateMouseCursor();this._updateLayerViews();this.view.slicePlane=null;this._viewHandles.removeAll();this._clearPointerMoveTimeout()};b.prototype.onInputEvent=function(a){switch(a.type){case "pointer-down":if(!z(a))break;
this._onPointerDown(a)&&(a.stopPropagation(),this._updateMouseCursor());break;case "pointer-drag":if(!z(a))break;this._onPointerDrag(a)&&a.stopPropagation();break;case "pointer-move":this._onPointerMove(a);this._updateMouseCursor();break;case "pointer-up":this._onPointerUp(a)&&a.stopPropagation();break;case "click":if(!z(a))break;this._onClick(a)&&a.stopPropagation();break;case "drag":this.inputState&&a.stopPropagation();break;case "key-down":this._onKeyDown(a)&&a.stopPropagation();break;case "key-up":this._onKeyUp(a)&&
a.stopPropagation()}};b.prototype._reset=function(){this.plane=null;this._set("layersMode","none")};b.prototype._updateLayerViews=function(){var a=this.view.tools.some(function(a){return a instanceof w&&!!a.plane&&a.visible}),c=[],b=function(a){"layers"in a?a.layers.forEach(b):c.push(a)};this.excludedLayers.forEach(b);this.view.allLayerViews.forEach(function(b){"slicePlaneEnabled"in b&&(b.slicePlaneEnabled=a&&0>c.indexOf(b.layer));"componentLayerViews"in b&&b.componentLayerViews.forEach(function(b){b.slicePlaneEnabled=
a&&0>c.indexOf(b.layer)})});this.view.basemapTerrain.slicePlaneEnabled=a&&!this.excludeGroundSurface};b.prototype._onPointerDown=function(a){if("exclude"===this.layersMode)return!0;if(this._isTargeting){var c=d.boundedPlane.create();if(this._pickPlane(p.createScreenPointFromEvent(a),!1,this._activeKeyModifiers,c)){d.boundedPlane.copy(c,this._startPlane);var b=this._calculatePickRay(p.createScreenPointFromEvent(a));this.inputState=C(b,a.pointerId,c.origin,c);this.plane=c;return!0}}return!1};b.prototype._onPointerDrag=
function(a){return a.pointerId===this._creatingPointerId?(this.shiftManipulator.attemptDragTo({screenPoint:p.createScreenPointFromEvent(a)}),!0):!1};b.prototype._onPointerMove=function(a){this._lastCursorPosition.x=a.x;this._lastCursorPosition.y=a.y;this._resetPointerMoveTimeout();"touch"!==a.pointerType&&this._updatePreviewPlane(p.createScreenPointFromEvent(a),this._activeKeyModifiers)};b.prototype._onPointerUp=function(a){return a.pointerId===this._creatingPointerId?(d.boundedPlane.copy(this.plane,
this._startPlane),this.inputState=null,!0):!1};b.prototype._onClick=function(a){var c=this;if("exclude"!==this.layersMode)return!1;this.view.hitTest(p.createScreenPointFromEvent(a)).then(function(a){a.results.length?(a=(a=a.results[0])&&a.graphic)&&(a=a.sourceLayer||a.layer)&&c.excludedLayers.push(a):c.excludeGroundSurface=!0});this._set("layersMode","none");q.setActive(this,!1);return!0};b.prototype._onKeyDown=function(a){return"Escape"===a.key&&this.plane&&this.active?(this.plane=null,!0):a.key===
f.forceVerticalModifier||a.key===f.forceHorizontalModifier?(this._activeKeyModifiers[a.key]=!0,l.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0):!1};b.prototype._onKeyUp=function(a){return a.key!==f.forceVerticalModifier&&a.key!==f.forceHorizontalModifier||!this._activeKeyModifiers[a.key]?!1:(delete this._activeKeyModifiers[a.key],l.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)};
b.prototype._onShiftGrab=function(a){a=this._calculatePickRay(a.screenPoint);d.boundedPlane.copy(this.plane,this._startPlane);this.inputState=C(a,null,this.shiftManipulator.position,this.plane)};b.prototype._onShiftDrag=function(a){if(this.inputState&&"shift"===this.inputState.type){a=this._calculatePickRay(a.screenPoint);var c=h.sv3d.get();if(d.plane.intersectRay(this.inputState.shiftPlane,a,c)){a=Math.min((1-Math.abs(g.vec3.dot(this.plane.plane,a.direction)))/.001,1);var c=-d.plane.signedDistance(this._startPlane.plane,
c),b=-d.plane.signedDistance(this._startPlane.plane,this.inputState.startPoint);this.inputState.depth=this.inputState.depth*(1-a)+c*a-b;a=g.vec3.copy(h.sv3d.get(),this._startPlane.origin);c=g.vec3.copy(h.sv3d.get(),this._startPlane.plane);g.vec3.scale(c,c,-this.inputState.depth);g.vec3.add(c,c,a);d.boundedPlane.fromValues(c,this.plane.basis1,this.plane.basis2,this.plane);this.plane=this.plane}}};b.prototype._onRotateGrab=function(a){var c=k.createRotatePlane(this.plane,this.view.renderCoordsHelper,
d.plane.create());a=this._calculatePickRay(a.screenPoint);var b=y.vec3f64.create();d.plane.intersectRay(c,a,b)&&(d.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:c,startPoint:b})};b.prototype._onRotateDrag=function(a){if(this.inputState&&"rotate"===this.inputState.type){a=this._calculatePickRay(a.screenPoint);var c=h.sv3d.get();if(d.plane.intersectRay(this.inputState.rotatePlane,a,c)){a=this.inputState.rotatePlane;var b=M.calculateInputRotationTransform(this.inputState.startPoint,
c,this.plane.origin,a),c=u.mat4.identity(h.sm4d.get());u.mat4.rotate(c,c,b,a);a=g.vec3.transformMat4(h.sv3d.get(),this._startPlane.basis1,c);c=g.vec3.transformMat4(h.sv3d.get(),this._startPlane.basis2,c);d.boundedPlane.fromValues(this.plane.origin,a,c,this.plane);this.plane=this.plane}}};b.prototype._onResizeGrab=function(a,c){a=this._calculatePickRay(a.screenPoint);var b=h.sv3d.get();d.plane.intersectRay(this.plane.plane,a,b)&&(d.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"resize",
activeHandleIdx:c,startPoint:y.vec3f64.clone(b)})};b.prototype._onResizeDrag=function(a){if(this.inputState&&"resize"===this.inputState.type){a=this._calculatePickRay(a.screenPoint);var c=h.sv3d.get();d.plane.intersectRay(this.plane.plane,a,c)&&(this.plane=k.resizePlane(this._resizeHandles[this.inputState.activeHandleIdx],this.inputState.startPoint,c,this.view._stage.getCamera(),this._startPlane,this.plane))}};b.prototype._updatePreviewPlane=function(a,c){var b=this;void 0===c&&(c={});var e=this._previewPlane;
this._previewPlane=null;if(l.isNone(a))this._removeFrameTask(),this._updateManipulators();else{if(!this.plane&&this.active){var x=l.isSome(e)?e:d.boundedPlane.create(),e=l.isSome(e)?d.boundedPlane.copy(e,N):null;this._pickPlane(a,!0,c,x)&&(a=f.PREVIEW_FADE_DOT_THRESHOLD,c=!1,l.isSome(e)&&(c=g.vec3.dot(e.plane,x.plane)<a||g.vec3.dot(g.vec3.normalize(h.sv3d.get(),e.basis1),g.vec3.normalize(h.sv3d.get(),x.basis1))<a),c&&(this._baseOpacity=0),this._previewPlane=x)}l.isSome(this._previewPlane)&&l.isNone(this._frameTask)&&
0===this._baseOpacity?this._frameTask=I.addFrameTask({update:function(a){b._baseOpacity=Math.min(b._baseOpacity+a.deltaTime/(1E3*f.PREVIEW_FADE_DURATION_SECONDS),1);b._updateManipulators();1===b._baseOpacity&&b._removeFrameTask()}}):l.isNone(this._frameTask)&&(this._removeFrameTask(),this._updateManipulators())}};b.prototype._removeFrameTask=function(){l.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)};b.prototype._calculatePickRay=function(a){var c=d.ray.create();a=p.screenPointObjectToArray(a,
O);d.ray.fromScreen(this.view.state.camera,a,c);g.vec3.normalize(c.direction,c.direction);return c};b.prototype._pickIntersector=function(a){a=p.screenPointObjectToArray(a,h.sv2d.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a)};b.prototype._pickPlane=function(a,c,b,d){var e=this._pickIntersector(a).results.min;a=h.sv3d.get();if(!e.getIntersectionPoint(a))return!1;var e=e.getTransformedNormal(h.sv3d.get()),t=this.view._stage.getCamera();0<g.vec3.dot(e,t.viewForward)&&
g.vec3.scale(e,e,-1);var l=k.calculatePlaneHalfSize(a,t);c=(c?1:-1)*l*f.INITIAL_DEPTH_OFFSET_FRAC;c=g.vec3.scale(h.sv3d.get(),e,c);g.vec3.add(c,c,a);k.createPlane(c,e,0,l,l,t,b[f.forceVerticalModifier]?"vertical":b[f.forceHorizontalModifier]?"horizontal":null,this.view.renderCoordsHelper,d);return!0};b.prototype._updateMouseCursor=function(){this._set("cursor",null);this._isTargeting||"exclude"===this.layersMode?this._set("cursor","crosshair"):this._creatingPointerId&&this._set("cursor","grabbing")};
b.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)};b.prototype._resetPointerMoveTimeout=function(){var a=this;this._clearPointerMoveTimeout();this.shiftManipulator.state|=v.DidPointerMoveRecentlyFlag;this.rotateManipulator.state|=v.DidPointerMoveRecentlyFlag;this._prevPointerMoveTimeout=this._clock.setTimeout(function(){a.shiftManipulator.state&=~v.DidPointerMoveRecentlyFlag;a.rotateManipulator.state&=
~v.DidPointerMoveRecentlyFlag},f.POINTER_MOVE_TIMER_MS)};b.prototype._unsetOtherToolPlanes=function(){var a=this;this.view.tools.forEach(function(c){c!==a&&c instanceof w&&c._set("plane",null)})};b.prototype._updateManipulators=function(){var a=this;if(!this.disableEngineLayers){var c=this.plane||l.isSome(this._previewPlane)&&this._previewPlane,b=null!=c&&c===this.plane,e=null!=c&&c===this._previewPlane,d=c?k.calculateBoundedPlaneTranslateRotate(c,h.sm4d.get()):null;this.shiftManipulator.visible=
b;this.rotateManipulator.visible=b;this.resizeManipulators.forEach(function(a){a.visible=b});b&&(k.updateShiftRestartHandle(this.shiftManipulator,d,this.plane,this.view.renderCoordsHelper,this.view._stage.getCamera()),k.updateRotateHeadingHandle(this.rotateManipulator,d,this.plane,this.view.renderCoordsHelper),this.resizeManipulators.forEach(function(b,c){k.updateResizeHandle(b,a._resizeHandles[c],d,a.plane)}));this._previewOutlineManipulator.visible=e;this._outlineManipulator.visible=b;this._gridManipulator.visible=
!!c;c&&(c=g.vec3.set(h.sv3d.get(),g.vec3.length(c.basis1),g.vec3.length(c.basis2),1),c=u.mat4.fromScaling(h.sm4d.get(),c),c=u.mat4.multiply(c,d,c),c[12]=0,c[13]=0,c[14]=0,e=g.vec3.set(h.sv3d.get(),d[12],d[13],d[14]),this._previewOutlineManipulator.modelTransform=c,this._previewOutlineManipulator.position=e,this._outlineManipulator.modelTransform=c,this._outlineManipulator.position=e,this._gridManipulator.modelTransform=c,this._gridManipulator.position=e,this._updateMaterials())}};b.prototype._updateMaterials=
function(){this._previewOutlineMaterial.setParameterValues({color:[f.PLANE_OUTLINE_COLOR[0],f.PLANE_OUTLINE_COLOR[1],f.PLANE_OUTLINE_COLOR[2],f.PLANE_OUTLINE_COLOR[3]*this._baseOpacity]});this._gridMaterial.setParameterValues({backgroundColor:[f.PLANE_BACKGROUND_COLOR[0],f.PLANE_BACKGROUND_COLOR[1],f.PLANE_BACKGROUND_COLOR[2],f.PLANE_BACKGROUND_COLOR[3]*this._baseOpacity],gridColor:this.inputState&&"resize"===this.inputState.type?f.GRID_COLOR:[0,0,0,0]})};b.prototype._setSingleManipulatorInteractive=
function(a,b){b?(this.shiftManipulator.interactive=this.shiftManipulator===a,this.rotateManipulator.interactive=this.rotateManipulator===a,this.resizeManipulators.forEach(function(b){b.interactive=b===a})):(this.shiftManipulator.interactive=!0,this.rotateManipulator.interactive=!0,this.resizeManipulators.forEach(function(a){a.interactive=!0}))};var w;n([m.property({constructOnly:!0})],b.prototype,"view",void 0);n([m.property({dependsOn:["plane","inputState"],readOnly:!0})],b.prototype,"state",null);
n([m.property({dependsOn:["view.type"],readOnly:!0})],b.prototype,"isSupported",null);n([m.property({readOnly:!0})],b.prototype,"cursor",void 0);n([m.property({value:null})],b.prototype,"plane",null);n([m.property({readOnly:!0})],b.prototype,"layersMode",void 0);n([m.property({readOnly:!0})],b.prototype,"excludedLayers",void 0);n([m.property({type:Boolean,value:!1})],b.prototype,"excludeGroundSurface",null);n([m.property({value:null})],b.prototype,"inputState",null);return b=w=n([m.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],
b)}(m.declared(L.InteractiveToolBase));var N=d.boundedPlane.create(),O=p.createScreenPointArray();return r});