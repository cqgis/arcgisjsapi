// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/maybe ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Polygon ../../../../layers/graphics/dehydratedFeatures ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/edgeUtils ../../support/projectionUtils ../../support/buffer/BufferView ../../support/buffer/math/vec3 ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(K,L,ha,ia,ja,ka,O,la,ma,na,T,Q,z,g,oa,pa,qa,H,ra,U,sa,V,W,X,Y,ta,ua,va,D,wa){function xa(e,f,a,b,d,c,k,l,v,r,B,n,q,g){var F=a.length/3,C=0;B+=2*b.count;var h=b.index,m=b.count,p=v,u=B;z.vec3.copy(t,q);var x=0<n?1:-1,h=3*h,y=p;q=3*y;for(var A=p+m,p=3*A,w=0;w<m;++w)g&&(t[0]=e[h+0],t[1]=e[h+1],t[2]=e[h+2],z.vec3.normalize(t,t)),d[q+0]=e[h+0],d[q+1]=e[h+1],d[q+2]=e[h+2],c[q+0]=f[h+0],c[q+1]=f[h+1],c[q+2]=f[h+2],k[q+0]=-x*t[0],k[q+1]=-x*t[1],k[q+2]=-x*t[2],l[y]=0,d[p+0]=e[h+0]+n*t[0],d[p+1]=e[h+
1]+n*t[1],d[p+2]=e[h+2]+n*t[2],c[p+0]=f[h+0],c[p+1]=f[h+1],c[p+2]=f[h+2],k[p+0]=x*t[0],k[p+1]=x*t[1],k[p+2]=x*t[2],l[A]=n,q+=3,p+=3,h+=3,y+=1,A+=1;h=0;q=3*u;p=3*(u+F);q=3*(u+F);p=3*u;e=Z;f=aa;0>n&&(e=aa,f=Z);for(w=0;w<F;++w)r[q+0]=a[h+e[0]],r[q+1]=a[h+e[1]],r[q+2]=a[h+e[2]],r[p+0]=a[h+f[0]]+m,r[p+1]=a[h+f[1]]+m,r[p+2]=a[h+f[2]]+m,q+=3,p+=3,h+=3;v+=2*b.count;B=B+2*F-(2*b.count+2*F);ba(d,c,l,k,C,b.pathLengths[0],b.count,v,r,B,n);v+=4*b.pathLengths[0];B+=2*b.pathLengths[0];C+=b.pathLengths[0];for(a=
1;a<b.pathLengths.length;++a)ba(d,c,l,k,C,b.pathLengths[a],b.count,v,r,B,n),v+=4*b.pathLengths[a],B+=2*b.pathLengths[a],C+=b.pathLengths[a]}function I(e,f,a,b,d,c,k){b[c]=b[k];k*=3;c*=3;e[c+0]=e[k+0];e[c+1]=e[k+1];e[c+2]=e[k+2];f[c+0]=f[k+0];f[c+1]=f[k+1];f[c+2]=f[k+2];a[c+0]=d[0];a[c+1]=d[1];a[c+2]=d[2]}function ba(e,f,a,b,d,c,k,l,v,r,B){var n=d,q=d+1,t=d+k,g=d+k+1,C=l,h=l+1,m=l+2*c;l=l+2*c+1;0>B&&(n=d+k+1,g=d);r*=3;for(var p=0;p<c;++p){p===c-1&&(0<B?(q=d,g=d+k):(q=d,n=d+k));var u=e,x=n,y=q,A=t,
w=G,x=3*x,y=3*y,A=3*A;z.vec3.set(M,u[x++],u[x++],u[x++]);z.vec3.set(ca,u[y++],u[y++],u[y++]);z.vec3.set(da,u[A++],u[A++],u[A++]);z.vec3.subtract(ea,ca,M);z.vec3.subtract(fa,da,M);z.vec3.cross(w,fa,ea);z.vec3.normalize(w,w);I(e,f,b,a,G,C,n);I(e,f,b,a,G,h,q);I(e,f,b,a,G,m,t);I(e,f,b,a,G,l,g);v[r++]=C;v[r++]=m;v[r++]=l;v[r++]=C;v[r++]=l;v[r++]=h;n++;q++;t++;g++;C+=2;h+=2;m+=2;l+=2}}Object.defineProperty(L,"__esModule",{value:!0});var E=g.vec3f64.create(),t=g.vec3f64.create(),Z=[0,2,1],aa=[0,1,2],P=pa.makeDehydratedPoint(0,
0,0,null),ga={verticalDistanceToGround:0,terrainElevation:0};K=function(e){function f(a,b,d,c){a=e.call(this,a,b,d,c)||this;a._edgeStageObjects=new Set;return a}ha(f,e);f.prototype.doLoad=function(){return ja(this,void 0,void 0,function(){var a,b,d,c,k,l,f;return ia(this,function(e){if(!this._isPropertyDriven("size")&&(a=U.validateSymbolLayerSize(this._getSymbolSize())))throw new ka("graphics3dextrudesymbollayer:invalid-size",a);b=this._getStageIdHint();d=O.get(this.symbolLayer,"material","color");
c=this._getCombinedOpacityAndColor(d);k=g.vec3f64.fromArray(c);l=c[3];f={diffuse:k,ambient:k,opacity:l,transparent:1>l||this._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows};this._material=new wa(f,b+"_3dlinemat");this._context.stage.add(Y.ModelContentType.MATERIAL,this._material);return[2]})})};f.prototype.destroy=function(){e.prototype.destroy.call(this);this._material&&this._context.stage.remove(Y.ModelContentType.MATERIAL,
this._material.id)};f.prototype.createGraphics3DGraphic=function(a){var b=a.renderingInfo;a=a.graphic;var d=a.geometry;if("polygon"!==d.type&&"extent"!==d.type)return this.logger.warn("unsupported geometry type for extrude symbol: "+d.type),null;if(!this._validateGeometry(d))return null;var c="graphic"+a.uid,f=this._getVertexOpacityAndColor(b,Float32Array,255),l=this.getGraphicElevationContext(a);return this._createAs3DShape(d,b,f,l,c,a.uid)};f.prototype.layerOpacityChanged=function(){var a=O.get(this.symbolLayer,
"material","color"),a=this._getCombinedOpacity(a),b=1>a||this._isPropertyDriven("opacity");this._material.setParameterValues({opacity:a,transparent:b});if(0<this._edgeStageObjects.size){var f=this._context.stage.renderView.ensureEdgeView(),c=this._getLayerOpacity();this._edgeStageObjects.forEach(function(a){return f.updateAllComponentOpacities(a,[c])})}return!0};f.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,H.needsElevationUpdates3D)};f.prototype.slicePlaneEnabledChanged=
function(a,b){var f=this;this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});if(0<this._edgeStageObjects.size){var c=this._context.stage.renderView.ensureEdgeView();a=this._createEdgeMaterial(c);if(O.isSome(a)){var k=[a];this._edgeStageObjects.forEach(function(a){return c.updateAllComponentMaterials(a,k,{slicePlaneEnabled:f._context.slicePlaneEnabled},!1)})}}return!0};f.prototype.pixelRatioChanged=function(a,b){return!0};f.prototype._getExtrusionSize=function(a){a=
a.size&&this._isPropertyDriven("size")?H.getSingleSizeDriver(a.size,2):this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};f.prototype._getSymbolSize=function(){return this.symbolLayer.size||1};f.prototype._createAs3DShape=function(a,b,f,c,k,l){var d=this,e="extent"===a.type?oa.fromExtent(a):a;a=e.rings;var t=[],n=[],q=[],G=Array(6),F=this._context.renderSpatialReference===V.SphericalECEFSpatialReference,C=this._getExtrusionSize(b),h=g.vec3f64.create();F||this._context.renderCoordsHelper.worldUpAtPosition(null,
h);b=H.getGeometryVertexData3D(a,e.hasZ,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c);this._logGeometryCreationWarnings(b,a,"rings","ExtrudeSymbol3DLayer");if(0===a.length||!a.some(function(a){return 0<a.length}))return null;var m=U.computeCentroid(e);if(O.isNone(m))return null;a=Q.mat4f64.create();V.computeLinearTransformation(e.spatialReference,[m.x,m.y,0],a,this._context.renderSpatialReference);var p=Q.mat4f64.create();
T.mat4.invert(p,a);var u=na.mat3f64.create();ma.mat3.normalFromMat4(u,p);for(var x=b.geometryData.polygons,y=b.eleVertexData,A=b.vertexData,e=A.length/3,w=new Float64Array(18*e),I=new Float64Array(18*e),K=new Float64Array(18*e),L=new Float64Array(6*e),J=0,e=function(a){var b=x[a],c=b.count,e=b.index;if(R._context.clippingExtent&&(H.computeBoundingBox(y,e,c,G),H.boundingBoxClipped(G,R._context.clippingExtent)))return"continue";var d=new Float64Array(y.buffer,3*e*w.BYTES_PER_ELEMENT,3*c),l=b.holeIndices.map(function(a){return a-
e}),d=la(d,l,3);if(0===d.length)return"continue";var l=new Uint32Array(6*c+2*d.length),g=6*c,m=3*w.BYTES_PER_ELEMENT,m=new W.BufferViewVec3f64(w.buffer,J*m,m,(J+g)*m),r=3*I.BYTES_PER_ELEMENT,r=new W.BufferViewVec3f64(I.buffer,J*r,r,(J+g)*r),v=new Float64Array(K.buffer,3*J*K.BYTES_PER_ELEMENT,3*g),g=new Float64Array(L.buffer,1*J*L.BYTES_PER_ELEMENT,1*g);xa(A,y,d,b,m.typedBuffer,v,r.typedBuffer,g,0,l,0,C,h,F);X.transformMat4(m,m,p);X.transformMat3(r,r,u);J+=6*c;b=R._createExtrudeGeometry(l,{positions:m.typedBuffer,
elevation:v,normals:r.typedBuffer,heights:g},f);a=new ta(b,k+"path"+a);a.singleUse=!0;t.push(a);n.push(R._material);q.push(Q.mat4f64.create())},R=this,m=0;m<x.length;++m)e(m);if(0===t.length)return null;var S=new va({geometries:t,materials:n,transformations:q,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:l},idHint:k});S.objectTransformation=a;var M=function(a){var b=d._context.stage.renderView.ensureEdgeView();b.removeObject(a);d._edgeStageObjects.delete(a);var c=d._createEdgeMaterial(b);
O.isSome(c)&&(d._edgeStageObjects.add(a),b.addObject(a,[c],{slicePlaneEnabled:d._context.slicePlaneEnabled},!d._context.isAsync))};M(S);l=new qa(this,S,t,null,null,function(a,b,c,e){a=a.stageObject;P.spatialReference=c.spatialReference;for(var f=a.getGeometryRecords(),d=f.length,l="absolute-height"!==b.mode,k=0,h=a.objectTransformation,q=T.mat4.invert(Q.mat4f64.create(),h),p=0;p<d;p++){var g=f[p].geometry;g.invalidateBoundingInfo();for(var m=g.data.getVertexAttr(),g=m[D.VertexAttrConstants.POSITION].data,
r=m[D.VertexAttrConstants.SIZE].data,m=m.mapPos.data,t=g.length/3,n=0,u=0,v=!1,x=0,y=0;y<t;y++){P.x=m[u];P.y=m[u+1];P.z=m[u+2];N[0]=g[n];N[1]=g[n+1];N[2]=g[n+2];var w=H.computeElevation(c,P,b,e,l?ga:null);l&&(x+=ga.terrainElevation);z.vec3.set(E,g[n+0],g[n+1],g[n+2]);z.vec3.transformMat4(E,E,h);e.setAltitude(w+r[n/3],E);z.vec3.transformMat4(E,E,q);g[n]=E[0];g[n+1]=E[1];g[n+2]=E[2];w=.01/e.unitInMeters;if(Math.abs(N[0]-g[n])>w||Math.abs(N[1]-g[n+1])>w||Math.abs(N[2]-g[n+2])>w)v=!0;u+=3;n+=3}v&&a.geometryVertexAttrsUpdated(p);
k+=x/t}b=k/d;M(S);return b},c);l.alignedTerrainElevation=b.terrainElevation;l.needsElevationUpdates=H.needsElevationUpdates3D(c.mode);return l};f.prototype._createExtrudeGeometry=function(a,b,e){for(var c=a.length,f=new Uint32Array(c),d=0;d<c;d++)f[d]=0;c={};d={};c[D.VertexAttrConstants.POSITION]=a;c[D.VertexAttrConstants.NORMAL]=a;c[D.VertexAttrConstants.COLOR]=f;d[D.VertexAttrConstants.POSITION]={size:3,data:b.positions};d[D.VertexAttrConstants.NORMAL]={size:3,data:b.normals};d[D.VertexAttrConstants.COLOR]=
{size:4,data:e};d[D.VertexAttrConstants.SIZE]={size:1,data:b.heights};b.elevation&&(d.mapPos={size:3,data:b.elevation},c.mapPos=a);return new ua(d,c)};f.prototype._createEdgeMaterial=function(a){var b={opacity:this._getLayerOpacity()};return sa.createMaterial(a,this.symbolLayer,b)};return f}(ra.default);L.Graphics3DExtrudeSymbolLayer=K;var G=g.vec3f64.create(),M=g.vec3f64.create(),ca=g.vec3f64.create(),da=g.vec3f64.create(),ea=g.vec3f64.create(),fa=g.vec3f64.create(),N=g.vec3f64.create();L.default=
K});