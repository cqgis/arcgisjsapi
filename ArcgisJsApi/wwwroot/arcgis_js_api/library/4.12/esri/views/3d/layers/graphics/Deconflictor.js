// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Handles ../../../../core/PooledArray ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingRect ./deconflictorDebug ../../support/debugFlags ../../support/earthUtils ../../support/geometryUtils ../../support/mathUtils ../../support/geometryUtils/sphere ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(F,G,O,P,D,Q,R,f,S,r,T,y,H,v,t,w,U,V,z,I,W,X,J,Y,B){function Z(k){var b,a,c,g;return P(this,function(d){switch(d.label){case 0:b=[];for(a in k)b.push(a);c=0;d.label=1;case 1:if(!(c<b.length))return[3,4];g=b[c];return[4,k[g]];case 2:d.sent(),d.label=3;case 3:return c++,[3,1];case 4:return[2]}})}Object.defineProperty(G,"__esModule",{value:!0});var K=v.vec4f64.create(),A=v.vec4f64.create(),L=v.vec4f64.create(),aa=v.vec4f64.create(),M=z.sphere.create(),C=z.ray.create(),N=H.vec3f64.create(),ba=
t.create(),ca=t.create(),da=function(){return function(){this.posView=this.yMax=this.yMin=this.xMax=this.xMin=0;this.pooled=this.visible=this.culled=!1}}(),ea=function(){return function(k,b,a){void 0===a&&(a={});this.graphics3DGraphic=k;this.slicePlaneEnabled=b;this.info=a}}(),fa=function(){return function(k,b){void 0===b&&(b=new Map);this.graphics3DCore=k;this.graphics=b}}();F=function(k){function b(){var a=null!==k&&k.apply(this,arguments)||this;a.handles=new R;a.dirty=!1;a.state=0;a.contexts=[];
a.graphics=null;a.iterators=null;a.accBinsNumX=15;a.accBinsNumY=20;a.accBinsSizeX=0;a.accBinsSizeY=0;a.accBins=null;a.accNumTests=0;a._iconMarginFactor=-.1;a.slicePlaneViewSpace=null;return a}O(b,k);Object.defineProperty(b.prototype,"iconMarginFactor",{get:function(){return this._iconMarginFactor},set:function(a){this._iconMarginFactor=a;this.setDirty()},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this,c,g;this.graphics=(c={},c[0]={active:{},visible:new f,remove:new f},
c[1]={active:{},visible:new f,remove:new f},c);this.iterators=(g={},g[0]={active:null,visible:null,remove:null,sort:null},g[1]={active:null,visible:null,remove:null,sort:null},g);this.handles.add([this.view.watch("state.camera",function(){a.updateSlicePlane();a.setDirtyUrgent()}),this.view.watch("map.ground.opacity",function(c,g){1!==c&&1!==g||a.setDirtyUrgent()}),S.init(this.view,"slicePlane",function(){return a.updateSlicePlane()})]);this.frameWorker=this.view.resourceController.scheduler.registerTask(12,
function(c){return a.run(c)},function(){return a.needsUpdate()})};b.prototype.updateSlicePlane=function(){var a=this.view&&this.view.slicePlane;a?(this.slicePlaneViewSpace||(this.slicePlaneViewSpace=z.boundedPlane.create()),z.boundedPlane.transform(a,this.view.state.camera.viewMatrix,this.slicePlaneViewSpace),this.slicePlaneChanged()):this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged())};b.prototype.slicePlaneChanged=function(){for(var a=0,c=this.contexts;a<c.length;a++)if(c[a].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();
break}};b.prototype.destroy=function(){this.handles.destroy();this.handles=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.graphics[0].active=null;this.graphics[0].visible.clear();this.graphics[0].remove.clear();this.graphics[1].active=null;this.graphics[1].visible.clear();this.graphics[1].remove.clear();this.iterators=this.graphics=null};b.prototype.addGraphicsOwner=function(a){var c=this,g=this.findDeconflictionContext(a),b;-1!==g?b=this.contexts[g]:(b=new fa(a),this.contexts.push(b),
this.setDirtyUrgent());return{addGraphic:function(a){return c.addGraphic(b,a)},removeGraphic:function(a){return c.removeGraphic(b,a)},labelingInfoChange:function(){return c.globalLabelingInfoChanged(b)},visibilityInfoChange:function(){},featureReductionChange:function(){return c.globalFeatureReductionChanged(b)},slicePlaneEnabledChange:function(){return c.globalSlicePlaneEnabledChanged(b)},clear:function(){return b.graphics.forEach(function(a){return c.removeGraphic(b,a.graphics3DGraphic)})}}};b.prototype.removeGraphicsOwner=
function(a){var c=this;a=this.findDeconflictionContext(a);if(-1!==a){var b=this.contexts.splice(a,1)[0];b.graphics.forEach(function(a){return c.removeGraphic(b,a.graphics3DGraphic)});this.setDirtyUrgent()}};b.prototype.setInitialIconVisibilityFlag=function(a,c){a=!(this.graphicSupportsDeconfliction(c)&&this.isFeatureReductionEnabled(a));c.setVisibilityFlag(3,a,0)};b.prototype.setDirtyUrgent=function(){!this.dirty&&0<this.contexts.length&&(this.dirty=!0,this.notifyChange("updating"));this.frameWorker.priority=
2};b.prototype.setDirty=function(){!this.dirty&&0<this.contexts.length&&(this.dirty=!0,this.notifyChange("updating"),this.frameWorker.priority=12)};Object.defineProperty(b.prototype,"updating",{get:function(){return 0!==this.state||this.dirty},enumerable:!0,configurable:!0});b.prototype.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating};b.prototype.run=function(a){switch(this.state){case 0:w.prepare(this.view),this.dirty=!1,this.camera=this.view.state.camera,this.initBins(this.camera.fullWidth,
this.camera.fullHeight),this.resetIterators(),a.madeProgress();case 1:if(this.state=1,!this.processActiveGraphics(0,a))break;case 3:if(this.state=3,!this.cleanVisibleGraphics(0,a))break;case 5:if(this.state=5,!this.sortVisibleGraphics(0,a))break;case 7:this.state=7;if(!this.deconflictVisibleGraphics(0,a))break;w.drawAccelerationStruct(this,this.graphics[0].visible);case 2:if(this.state=2,!this.processActiveGraphics(1,a))break;case 4:if(this.state=4,!this.cleanVisibleGraphics(1,a))break;case 6:if(this.state=
6,!this.sortVisibleGraphics(1,a))break;case 8:this.state=8;if(!this.deconflictVisibleGraphics(1,a))break;w.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=0,this.notifyChange("updating")}};b.prototype.findDeconflictionContext=function(a){for(var c=0;c<this.contexts.length;c++)if(this.contexts[c].graphics3DCore===a)return c;return-1};b.prototype.globalFeatureReductionChanged=function(a){var c=this.isFeatureReductionEnabled(a.graphics3DCore);c||this.clearVisibilityFlags(a);
this.modifyGraphics(a,c,0)};b.prototype.globalLabelingInfoChanged=function(a){var c=this.isLabelDeconflictionEnabled(a.graphics3DCore);this.modifyGraphics(a,c,1)};b.prototype.globalSlicePlaneEnabledChanged=function(a){var c=a.graphics3DCore.symbolCreationContext.slicePlaneEnabled;a.graphics.forEach(function(a){a.slicePlaneEnabled=c});this.setDirtyUrgent()};b.prototype.modifyGraphics=function(a,c,b){var g=this;c?a.graphics.forEach(function(a){return g.addToActiveGraphics(a,b)}):a.graphics.forEach(function(a){return g.removeFromActiveGraphics(a,
b)});this.setDirtyUrgent()};b.prototype.graphicSupportsDeconfliction=function(a){var c=a._graphics;if(!c||!c.length||a.isDraped())return!1;for(a=0;a<c.length;a++)if(this.graphics3DGraphicsLayerSupportsDeconfliction(c[a]))return!0;return!1};b.prototype.graphics3DGraphicsLayerSupportsDeconfliction=function(a){if(!a||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.getNumGeometryRecords():0)&&a.getGeometryRecord(0).material instanceof Y?!0:!1};b.prototype.addGraphic=function(a,c){var b=c.graphic.uid;
c=new ea(c,a.graphics3DCore.symbolCreationContext.slicePlaneEnabled);a.graphics.set(b,c);this.isFeatureReductionEnabled(a.graphics3DCore)&&this.addToActiveGraphics(c,0);this.isLabelDeconflictionEnabled(a.graphics3DCore)&&this.addToActiveGraphics(c,1);this.setDirty()};b.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var b=a.graphics.get(c);b&&(this.removeFromActiveGraphics(b,0),this.removeFromActiveGraphics(b,1),a.graphics.delete(c),this.setDirty())};b.prototype.addToActiveGraphics=function(a,
c){a.info[c]=new da;this.graphics[c].active[a.graphics3DGraphic.graphic.uid]=a};b.prototype.removeFromActiveGraphics=function(a,c){this.removeFromVisibleGraphics(a,c);this.clearGraphicVisibility(a,c);delete a.info[c];delete this.graphics[c].active[a.graphics3DGraphic.graphic.uid]};b.prototype.addToVisibleGraphics=function(a,c){var b=a.info[c];b&&!b.pooled&&(this.graphics[c].visible.push(a),b.pooled=!0)};b.prototype.removeFromVisibleGraphics=function(a,c){var b=a.info[c];b&&b.pooled&&(this.graphics[c].remove.push(a),
b.pooled=!1)};b.prototype.processActiveGraphics=function(a,c){for(var b=this.getOrCreateActiveGraphicsIterator(a),d="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this.camera&&0<this.camera.relativeElevation;!c.done;){c.madeProgress();var e=b.next();if(e.done)return this.resetActiveGraphicsIterator(a),!0;var u=(e=e.value)&&e.info[a];u&&(this.collectGraphics3DGraphics(e,a,d),u.culled?this.removeFromVisibleGraphics(e,a):this.addToVisibleGraphics(e,a))}return!1};b.prototype.cleanVisibleGraphics=
function(a,c){for(var b=this.graphics[a],d=this.ensureRemoveGraphicsIterator(a,c);!c.done;){var e=d.next();c.madeProgress();if(e.done)return b.remove.clear(),this.resetRemoveGraphicsIterator(a),!0}return!1};b.prototype.sortVisibleGraphics=function(a,c){for(var b=this.ensureSortGraphicsIterator(a,function(c,b){return c.info[a]&&b.info[a]?b.info[a].posView-c.info[a].posView:Number.MAX_VALUE},c);!c.done;){var d=b.next();c.madeProgress();if(d.done)return this.resetSortGraphicsIterator(a),!0}return!1};
b.prototype.deconflictVisibleGraphics=function(a,c){for(var b=this.getOrCreateVisibleGraphicsIterator(a),d=1===a;!c.done;){c.madeProgress();var e=b.next();if(e.done)return this.resetVisibleGraphicsIterator(a),!0;var e=e.value,u=e.info[a];if(u&&!u.culled){var l=e.graphics3DGraphic,l=!(d&&!l.isVisible())&&!this.doesIntersectExistingPoly(e,a);(u.visible=l)&&this.addToBins(e,a);this.setGraphicVisibility(e,a,l);l&&w.drawPoly(u,l?"green":"red")}}return!1};b.prototype.resetIterators=function(){this.iterators[0].active=
null;this.iterators[0].visible=null;this.iterators[0].remove=null;this.iterators[0].sort=null;this.iterators[1].active=null;this.iterators[1].visible=null;this.iterators[1].remove=null;this.iterators[1].sort=null};b.prototype.getOrCreateActiveGraphicsIterator=function(a){var c=this.graphics[a];a=this.iterators[a];a.active||(a.active=Z(c.active));return a.active};b.prototype.resetActiveGraphicsIterator=function(a){this.iterators[a].active=null};b.prototype.getOrCreateVisibleGraphicsIterator=function(a){var c=
this.graphics[a];a=this.iterators[a];a.visible||(a.visible=c.visible.iterableForEach());return a.visible};b.prototype.resetVisibleGraphicsIterator=function(a){this.iterators[a].visible=null};b.prototype.ensureRemoveGraphicsIterator=function(a,c){var b=this.graphics[a];a=this.iterators[a];a.remove||(a.remove=b.visible.iterableRemoveMany(b.remove.data,function(){return c.done}));return a.remove};b.prototype.resetRemoveGraphicsIterator=function(a){this.iterators[a].remove=null};b.prototype.ensureSortGraphicsIterator=
function(a,c,b){var d=this.graphics[a];a=this.iterators[a];a.sort||(a.sort=d.visible.iterableSort(c,function(){return b.done}));return a.sort};b.prototype.resetSortGraphicsIterator=function(a){this.iterators[a].sort=null};b.prototype.collectGraphics3DGraphics=function(a,c,b){var d=a.graphics3DGraphic;if(!d.destroyed){var e=1===c,g=e?d._labelGraphics:d._graphics,e=e?0:this.iconMarginFactor;c=a.info[c];if(d.isVisible(0,3)){for(var d=t.empty(ba),l,h,k=0;k<g.length;k++){var p=g[k];if(this.graphics3DGraphicsLayerSupportsDeconfliction(p)){var q=
p.stageObject,x=q.getGeometryRecord(0),m=x.material,n=this.camera,f=x.geometry.data.getVertexAttr();if(b&&(M.radius=V.earthRadius,y.vec3.sub(C.direction,q.getCenter(),this.camera.eye),y.vec3.copy(C.origin,this.camera.eye),W.intersectRay(M,C,N))){var r=1-Math.abs(Math.tan(y.vec3.angle(q.getCenter(),C.direction)))/this.view.width,r=Math.pow(r,4),v=y.vec3.sqrDist(this.camera.eye,N),w=y.vec3.sqrDist(this.camera.eye,q.getCenter());if(r*w>v){c.culled=!0;return}}if(!h){h=q.getCenter();x=x.origin.vec3;B.transformToWorld(h,
x,K);B.transformToView(K,x,n.viewMatrix,A);m.applyVerticalOffsetTransformation(A,f[J.VertexAttrConstants.NORMAL].data,q.objectTransformation,n,E);if(a.slicePlaneEnabled&&this.slicePlaneViewSpace&&z.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,A)){c.culled=!0;return}q=f[J.VertexAttrConstants.AUXPOS1].data;f="screen"!==m.getParameters().centerOffsetUnits;B.transformToProjection(A,n.projectionMatrix,f?q:H.vec3f64.ZEROS,L);h=B.transformToNDC(L,aa);f||(h[0]+=q[0]/n.fullWidth*2,h[1]+=q[1]/
n.fullHeight*2);if(-1>h[0]||-1>h[1]||-1>h[2]||1<=h[0]||1<=h[1])break;l=A[2];!U.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&c.visible&&(l*=.7)}p=p.getScreenSize(ga);p[0]*=n.pixelRatio;p[1]*=n.pixelRatio;X.applyPrecomputedScaleFactorVec2(p,E.factor,p);m=t.offset(m.calculateRelativeScreenBounds(p,E.factorAlignment.scale,ca),I.lerp(0,n.fullWidth,.5+.5*h[0]),I.lerp(0,n.fullHeight,.5+.5*h[1]));0!==e&&(n=e*Math.min(t.width(m),t.height(m)),m[0]-=n,m[1]-=n,m[2]+=n,m[3]+=n);t.expand(d,m)}}null==l?c.culled=!0:(c.xMin=
d[0],c.yMin=d[1],c.xMax=d[2],c.yMax=d[3],c.posView=l,c.culled=!1)}else c.culled=!0}};b.prototype.doesIntersectExistingPoly=function(a,c){var b=a.graphics3DGraphic.graphic.uid;a=a.info[c];for(var d=Math.floor(a.xMin/this.accBinsSizeX);d<=Math.floor(a.xMax/this.accBinsSizeX);d++)if(!(0>d||d>=this.accBinsNumX))for(var e=Math.floor(a.yMin/this.accBinsSizeY);e<=Math.floor(a.yMax/this.accBinsSizeY);e++)if(!(0>e||e>=this.accBinsNumY))for(var k=this.accBins[d][e],l=0;l<k.length;l++){var h=k.data[l],f=h.info[c];
if(f&&f.visible&&h.graphics3DGraphic.graphic.uid!==b&&(this.accNumTests++,!(f.xMin>a.xMax||f.xMax<a.xMin||f.yMin>a.yMax||f.yMax<a.yMin)))return!0}return!1};b.prototype.initBins=function(a,c){if(null==this.accBins){this.accBins=[];for(var b=0;b<this.accBinsNumX;b++){this.accBins.push([]);for(var d=this.accBins[this.accBins.length-1],e=0;e<this.accBinsNumY;e++)d.push(new f)}}for(b=0;b<this.accBinsNumX;b++)for(e=0;e<this.accBinsNumY;e++)this.accBins[b][e].clear();this.accBinsSizeX=a/this.accBinsNumX;
this.accBinsSizeY=c/this.accBinsNumY;this.accNumTests=0};b.prototype.addToBins=function(a,c){c=a.info[c];for(var b=Math.floor(c.xMin/this.accBinsSizeX);b<=Math.floor(c.xMax/this.accBinsSizeX);b++)if(!(0>b||b>=this.accBinsNumX))for(var d=Math.floor(c.yMin/this.accBinsSizeY);d<=Math.floor(c.yMax/this.accBinsSizeY);d++)0>d||d>=this.accBinsNumY||this.accBins[b][d].push(a)};b.prototype.isFeatureReductionEnabled=function(a){a=a.layer;return!(!a||!a.featureReduction||"selection"!==a.featureReduction.type)};
b.prototype.isLabelDeconflictionEnabled=function(a){return a.labelsEnabled};b.prototype.clearVisibilityFlags=function(a){(a=a.graphics3DCore.graphics3DGraphics)&&a.forEach(function(a){return a.clearVisibilityFlag(3)})};b.prototype.setGraphicVisibility=function(a,c,b){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(3,b,c),1===c&&this.view.labeler.setLabelGraphicVisibility(a,b))};b.prototype.clearGraphicVisibility=function(a,b){a=a.graphics3DGraphic;a.destroyed||a.clearVisibilityFlag(3,b)};
D([r.property({constructOnly:!0})],b.prototype,"view",void 0);D([r.property({type:Boolean,readOnly:!0})],b.prototype,"updating",null);return b=D([r.subclass("esri.views.3d.layers.graphics.Deconflictor")],b)}(r.declared(Q));G.Deconflictor=F;var E={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},ga=T.vec2f64.create()});