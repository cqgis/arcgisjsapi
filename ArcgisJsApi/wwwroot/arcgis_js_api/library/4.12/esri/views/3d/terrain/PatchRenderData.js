// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/arrayUtils ../../../core/mathUtils ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingBox ../support/buffer/glUtil ./PatchGeometryFactory ./TerrainConst ./tileUtils ../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl/BufferObject ../../webgl/VertexArrayObject".split(" "),function(p,q,w,x,r,y,z,t,u,A,B,l,C,D,v,E){Object.defineProperty(q,
"__esModule",{value:!0});p=function(){function b(){this.overlayTexOffset=y.vec2f64.create();this.texOffsetAndScale=t.vec4f64.create();this.geometryInfo={indices:null,vertexAttributes:null,boundingBox:u.empty(),numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0,skirtLength:0,uvOffsetAndScale:t.vec4f64.create()}}b.prototype.init=function(a){this.tile=a;a=this.geometryInfo;a.indices=null;a.vertexAttributes=null;u.empty(a.boundingBox);a.numSurfaceIndices=0;a.numSkirtIndices=
0;a.numWithoutSkirtIndices=0;a.numVertsPerRow=0;this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1};this.textureReference=this._texture=this._vao=null;z.vec4.set(this.texOffsetAndScale,0,0,1,1);this.opacity=1;if(this.overlays){a=0;for(var c=this.overlays;a<c.length;a++){var d=c[a];d.renderTargetId=null;d.highlightRenderTargetId=null;d.waterMaskRenderTargetId=null;r.vec2.set(d.texScale,1,1);r.vec2.set(d.texOffset,0,0)}}else for(this.overlays=[null,null],a=0;2>a;a++)this.overlays[a]=
{renderTargetId:null,highlightRenderTargetId:null,waterMaskRenderTargetId:null,texScale:[1,1],texOffset:[0,0]};this.overlayOpacity=1;this.localOrigin=null};b.prototype.updateGeometry=function(a,c){if(!this._updateGeometryState(c))return!1;this._releaseGeometry();this._createGeometry(a,c);return!0};b.prototype.releaseGeometry=function(){return this._releaseGeometry()?(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0):!1};b.prototype.ensureTexture=function(a,
c){this._texture&&this._texture.descriptor.width!==c&&this.releaseTexture();this._texture||(this._texture=a(c),this.tile.updateMemoryUsed());return this._texture};b.prototype.releaseTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null);this.textureReference=null};b.prototype._updateGeometryState=function(a){var c=this._getElevationInfo(),d=this.tile.lij[0],e=8>d?this.tile.numSubdivisionsAtLevel[d]+1:2;c.samplerData&&(e=this.tile.maxTesselation,e=x.clamp((e>>Math.max(d-c.maxTileLevel,
l.ELEVATION_DESIRED_RESOLUTION_LEVEL-(this.tile.vlevel-d)))+1,2,e+1));d=this.tile.clippingArea;if(!this.tile.intersectsClippingArea||this.tile.isWithinClippingArea)d=null;var f=this.geometryState,b=!1;f.numVertsPerRow!==e&&(f.numVertsPerRow=e,b=!0);c.changed&&(f.samplerData=c.samplerData,b=!0);w.equals(f.clippingArea,d)||(f.clippingArea=d,b=!0);f.wireframe!==a&&(f.wireframe=a,b=!0);return b};b.prototype._createGeometry=function(a,c){this.tile.createGeometry(this.geometryState,this.localOrigin,c);
c=this.geometryInfo.vertexAttributes;var b=this.geometryInfo.indices,e=a.gl;this._vao=new E(a,D.Default3D,{geometry:A.glLayout(c.layout)},{geometry:v.createVertex(a,e.STATIC_DRAW,c.buffer)},v.createIndex(a,e.STATIC_DRAW,b))};b.prototype._releaseGeometry=function(){if(!this._vao)return!1;this._vao.dispose();this._vao=null;B.releaseGeometry(this.geometryInfo);return!0};Object.defineProperty(b.prototype,"vao",{get:function(){return this._vao},enumerable:!0,configurable:!0});b.prototype._getElevationInfo=
function(){for(var a=this.geometryState.samplerData,b=this.tile.layerInfo[l.LayerClass.ELEVATION],d=b.length,e=Array(d),f=0,m=0,n=!1,k=0;k<d;k++){var h=b[k];if(h.upsampleFromTile){var h=h.upsampleFromTile.tile,g=h.layerInfo[l.LayerClass.ELEVATION][k].data,g=g.samplerData;a&&a[f]===g||(n=!0);e[f++]=g;m=Math.max(m,h.lij[0])}else h.data&&(g=this.tile.surface.layerViewByIndex(k,l.LayerClass.ELEVATION),C.fallsWithinLayer(this.tile,g.layer,!1)&&(g=h.data,a&&a[f]===g.samplerData||(n=!0),e[f++]=g.samplerData,
m=this.tile.lij[0]))}a&&a.length!==f&&(n=!0);0<f?e.length=f:e=null;return{changed:n,samplerData:e,maxTileLevel:m}};Object.defineProperty(b.prototype,"estimatedGeometryMemoryUsage",{get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"textureDescriptor",{get:function(){return this._texture?this._texture.descriptor:null},enumerable:!0,configurable:!0});return b}();q.PatchRenderData=
p});