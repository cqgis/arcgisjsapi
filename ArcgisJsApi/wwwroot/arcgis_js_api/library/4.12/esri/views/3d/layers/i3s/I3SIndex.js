// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec4f64 ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(C,x,K,k,p,y,F,q,r,v){function D(c){c.node?(c.node.renderMbs[3]=-1,c.node.renderObb.halfSize[0]=-1):c.ref&&(c.ref.renderMbs[3]=-1,c.ref.renderObb.halfSize[0]=-1)}function z(c,a){return 0===a?0:c/a|0}function w(c,
a){return 0===a?c:c%a}function E(c){if(c)for(var a=0;a<c.length;a++)for(var b=0,d=G;b<d.length;b++){var f=d[b];if(f[0]===c[a].metricType)return{lodMetric:f[1],maxError:c[a].maxError}}return{lodMetric:0,maxError:0}}function H(c){return Math.sqrt(4/Math.PI*c)}Object.defineProperty(x,"__esModule",{value:!0});C=function(){function c(a,b,d,c,e,g,h,l,I,k){var f=this;this.layerUrl=a;this.streamDataController=c;this.viewportQueries=e;this.logger=g;this._isLoaded=h;this._isSelected=l;this._enable=I;this._needsUpdate=
k;this._dirty=!0;this.nodePages=[];this.lodMetric=this.rootIndex=this.nodesPerPage=this.nodeCount=0;this.lodConversion=function(a){return a};this._loading=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState={};this._version=0;this._visibilityCacheGeneration=r.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leafsReached:!1};this._unloadedMemoryEstimate=
0;this._missing=new p({deallocator:null});this._prefetch=new p({deallocator:null});this._updates=new J;this.ignoreServiceOBB=!1;this.progressiveLoadPenalty=0;this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1;this.initNodePages(d).catch(function(){return f.initNodeDocuments(b)})}c.prototype.initNodePages=function(a){if(!a)return y.reject();this.nodesPerPage=a.nodesPerPage;this.rootIndex=a.rootIndex;switch(a.lodSelectionMetricType){case "maxScreenThreshold":this.lodMetric=1;
break;case "maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=H}a=z(this.rootIndex,this.nodesPerPage);return this.loadPage(a)};c.prototype.initNodeDocuments=function(a){this.rootIndex=this.nodesPerPage=0;this.nodePages.push({nodes:[],children:[],parents:[]});this.makeRefNode({id:a,mbs:null},-1)};c.prototype.loadPage=function(a){var b=this;this._loading.add(a);return this.streamDataController.request(this.layerUrl+"/nodepages/"+a,"json").then(function(d){b._loading.delete(a);b.addPage(a,d)}).catch(function(d){b._loading.delete(a);
b._failedPages.add(a);return y.reject(d)})};c.prototype.addPage=function(a,b){for(var d=this,c=this.nodePages.length;c<a;c++)this.nodePages[c]=null;var e=[],g=[];b=b.nodes.map(function(b,c){var h=e.length,f=b.children?b.children.length:0;g.push(-1);for(var l=0;l<f;l++)e.push(b.children[l]);var l=""+b.index,k=v.clone(b.obb),m=q.vec4f64.fromArray([k.center[0],k.center[1],k.center[2],F.vec3.length(k.halfSize)]),A=b.mesh&&b.mesh.attribute,n=b.mesh&&b.mesh.geometry,t=b.mesh&&b.mesh.material;b={id:l,index:a*
d.nodesPerPage+c,childCount:f,failed:!1,cacheState:0,obb:k,mbs:m,level:0,resources:{hasSharedResource:!1,hasFeatureData:!!n,attributes:A&&null!=A.resource?""+A.resource:null,geometry:n&&null!=n.resource?""+n.resource:null,texture:t&&null!=t.resource&&0<t.texelCountHint?""+t.resource:null,geometryDefinition:n?n.definition:-1,materialDefinition:t?t.definition:-1},lodMetric:d.lodMetric,maxError:d.lodConversion(b.lodThreshold),renderMbs:q.vec4f64.fromArray([0,0,0,-1]),renderObb:v.create([0,0,0],[-1,-1,
-1],[0,0,0,1]),numFeatures:n?n.featureCount:null,vertexCount:n?n.vertexCount:null};return{childOffset:h,childCount:f,visibilityCache:r.addWraparound(d._visibilityCacheGeneration,-2),ref:null,node:b}});this.nodePages[a]={nodes:b,children:e,parents:g};this.nodeCount+=b.length;this.updateParentsAndLevel()};c.prototype.updateParentsAndLevel=function(){var a=this,b=[],d=function(d,c,e){var h=a.getPage(d);if(k.isSome(h)){var f=w(d,a.nodesPerPage);h.parents[f]=c;if(c=h.nodes[f].node)c.level=e,b.push(d)}};
for(d(this.rootIndex,-1,0);b.length;)for(var c=b.pop(),e=this.getNode(c),g=0;g<e.childCount;g++){var h=this.getChildIndex(e,g);d(h,c,e.level+1)}};c.prototype.getPage=function(a){return this.nodePages[z(a,this.nodesPerPage)]};c.prototype.getNodeInternal=function(a){var b=this.getPage(a);return k.isNone(b)?null:b.nodes[w(a,this.nodesPerPage)]};c.prototype.addNode=function(a,b){null!=a.children&&this.populateChildren(b,a.children);var d=this.getParent(b),d=d?d.level+1:1;this._maxLevel=Math.max(this._maxLevel,
d);var c=E(a.lodSelection),e=c.lodMetric,c=c.maxError,g=k.expect(this.getNodeInternal(b));g.node={id:a.id,index:b,mbs:q.vec4f64.fromArray(a.mbs),obb:a.obb&&v.clone(a.obb),childCount:g.childCount,level:d,resources:a.resources,version:a.version,lodMetric:e,maxError:c,memory:null,numFeatures:a.numFeatures,failed:!1,cacheState:0};null==g.ref.mbs&&(g.ref.mbs=a.mbs);g.node.renderMbs=g.ref.renderMbs;g.node.renderObb=g.ref.renderObb;return g.node};c.prototype.makeRefNode=function(a,b){var d=this.nodePages[0],
c=d.nodes.length;d.nodes.push({childOffset:0,childCount:0,node:null,ref:a,visibilityCache:r.addWraparound(this._visibilityCacheGeneration,-2)});this.nodeCount++;d.parents.push(b);a.renderMbs=q.vec4f64.fromArray([0,0,0,-1]);a.renderObb=v.create([0,0,0],[-1,-1,-1],[0,0,0,1]);return c};c.prototype.populateChildren=function(a,b){var d=k.expect(this.getNodeInternal(a)),c=k.expect(this.getPage(a));d.childOffset=c.children.length;d.childCount=b.length;for(d=0;d<b.length;d++){var e=this.makeRefNode(b[d],
a);c.children.push(e)}};c.prototype.getNode=function(a){a=this.getNodeInternal(a);return k.isSome(a)&&a.node};c.prototype.getIndexById=function(a){var b;this.forAllNodes(function(d,c){(d.node?d.node.id:d.ref.id)===a&&(b=c)});return b};c.prototype.getNodeById=function(a){a=this.getIndexById(a);a=null!=a?this.getNodeInternal(a):null;return k.isSome(a)?a.node:null};c.prototype.getChildIndex=function(a,b){var d=this.getPage(a.index);if(k.isNone(d))return-1;a=d.nodes[w(a.index,this.nodesPerPage)];return d.children[a.childOffset+
b]};c.prototype.getParentIndex=function(a){var b=this.getPage(a);return k.isSome(b)?b.parents[w(a,this.nodesPerPage)]:-1};c.prototype.getParent=function(a){a=this.getParentIndex(a);return 0<=a?this.getNode(a):null};Object.defineProperty(c.prototype,"rootNode",{get:function(){var a=this.getNodeInternal(this.rootIndex);return k.isSome(a)?a.node:null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return this.nodeCount},enumerable:!0,configurable:!0});c.prototype.invalidateVisibilityCache=
function(a){null!=a?(a=this.getNodeInternal(a),k.isSome(a)&&(a.visibilityCache=r.addWraparound(this._visibilityCacheGeneration,-2))):this._visibilityCacheGeneration=r.addWraparound(this._visibilityCacheGeneration,2)};c.prototype.isNodeVisible=function(a){a=this.getNodeInternal(a);if(k.isNone(a)||a.ref&&!a.ref.mbs)return!0;if((a.visibilityCache&-2)!==this._visibilityCacheGeneration){var b=this.viewportQueries.isNodeVisible(a.ref||a.node);a.visibilityCache=this._visibilityCacheGeneration+(b?1:0);return b}return 1===
(a.visibilityCache&1)};c.prototype.isGeometryVisible=function(a){if(!this.isNodeVisible(a))return!1;a=this.getNodeInternal(a);return k.isNone(a)?!0:a.node&&a.ref&&!a.ref.obb?this.viewportQueries.isGeometryVisible(a.node):!0};Object.defineProperty(c.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0});c.prototype.destroy=function(){this._updates.add.prune();
this._updates.update.prune()};c.prototype.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;++this._version};c.prototype.update=function(a,b){var d=this;if(this._dirty){this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a,this._missing);m.clear();var c=!0,e=new B,g=new B;this.traverseVisible(function(h,l){if(l){var f=l.node;d._updateNodeFeatureEstimate(f,g);if(f){var r=k.expect(d.getPage(h));if(0===d._missing.length&&
0===d.nodesPerPage)for(var p=0;p<l.childCount;p++){var u=r.children[l.childOffset+p],q=d.getNodeInternal(u);!k.isSome(q)||q.node||d._loading.has(u)||(m.set(u,d.entryPriority(u)),d._prefetch.push(u))}!f.failed&&f.resources.hasFeatureData&&(d._isLoaded(h)?(e.known+=f.memory,++e.knownNodes,d._isSelected(f)?0<l.childCount&&(c=!1):(e.unremoved+=f.memory,c=!1),d._needsUpdate(f)&&(l=d.entryPriority(h),m.set(h,l),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l),d._updates.update.push(h))):(f.memory&&
(e.known+=f.memory,++e.knownNodes),d._isSelected(f)&&(0<l.childCount&&(c=!1),f.memory?(e.missing+=f.memory,e.known+=f.memory,++e.knownNodes):++e.missingNodes,0<=a.indexOf(f.index)?(d._maxProcessingPrio=Math.max(d._maxProcessingPrio,d.entryPriority(h)),d._updates.cancel=d._updates.cancel.filter(function(a){return a!==f.index})):!b.done&&d._enable(f)?b.madeProgress():(l=d.entryPriority(h),m.set(h,l),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l),d._updates.add.push(h)))))}else l=d.entryPriority(h),
d._loading.has(h)||d._failedNodes.has(h)||(d._missing.push(h),m.set(h,l)),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l)}else l=d.entryPriority(h),h=z(h,d.nodesPerPage),m.set(h,Math.max(l,m.get(h)||0)),d._loading.has(h)||d._failedPages.has(h)||d._missing.push(h),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l)});this._unloadedMemoryEstimate=e.missing-e.unremoved;3<e.knownNodes&&0<e.missingNodes&&(this._unloadedMemoryEstimate+=e.known/e.knownNodes*e.missingNodes);this._unloadedMemoryEstimate=
.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(g);this._featureEstimate.leafsReached=c;this._missing.sort(function(a,b){return a-b});this._missing.filterInPlace(function(a,b){return 1>b||d._missing.data[b-1]!==a});this._missing.sort(function(a,b){return m.get(a)-m.get(b)});0<this._missing.length?(this._maxUnloadedPrio=m.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(function(a,b){return m.get(a)-m.get(b)});this._updates.add.filterInPlace(function(a){return m.get(a)>=
d._maxUnloadedPrio}).sort(function(a,b){return m.get(a)-m.get(b)});this._updates.update.sort(function(a,b){return m.get(a)-m.get(b)});this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;m.clear()}};c.prototype.checkFeatureTarget=function(a,b){for(var d=this.viewportQueries.updateScreenSpaceErrorBias(b),c=b,e=b,g=d,h=10;h--;){var l=new B;this._updateFeatureEstimate(c,l);if(this._computeFeatureEstimate(l)<=a){if(c>=b||0<l.missingNodes||0===h)break;g=c;c=.5*(c+
e)}else e=c,c=.5*(c+g)}++this._version;this.viewportQueries.updateScreenSpaceErrorBias(d);return Math.min(b,c)};c.prototype._updateFeatureEstimate=function(a,b){var d=this;++this._version;this.viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible(function(a,c){return d._updateNodeFeatureEstimate(c&&c.node,b)})};c.prototype._updateNodeFeatureEstimate=function(a,b){a&&!a.failed&&null!=a.numFeatures&&(this._isLoaded(a.index)?(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=
a.numFeatures)):this._isSelected(a)&&(a.numFeatures?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};c.prototype._computeFeatureEstimate=function(a){var b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};c.prototype.load=function(a){if(0===this._missing.length)return!1;a=Math.min(a,this._missing.length);for(var b=0;b<a;++b)0===this.nodesPerPage?this._loadNode(this._missing.pop()):this.loadPage(this._missing.pop());
return!0};c.prototype.prefetch=function(a){if(0===this._prefetch.length)return!1;a=Math.min(a,this._prefetch.length);for(var b=0;b<a;++b)this._loadNode(this._prefetch.pop());return!0};c.prototype.isLoading=function(){return 0<this._indexMissing};c.prototype.getIndexLoading=function(){return this._loading.size};c.prototype.getIndexMissing=function(){return this._indexMissing};c.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate};Object.defineProperty(c.prototype,"updates",
{get:function(){return this._updates},enumerable:!0,configurable:!0});c.prototype.getFeatureEstimate=function(){return this._featureEstimate};c.prototype.nodeTraversalState=function(a){if(!a)return null;var b=this._nodeTraversalState[a.index];if(b&&b.version===this._version)return b;var d=this.viewportQueries.getLodLevel(a),c=this.viewportQueries.hasLOD(a),e=!0;c&&(e=this.getParentIndex(a.index),e=0<=e?(e=this._nodeTraversalState[e])&&d>e.lodLevel:0<d);if(b)return b.lodLevel=d,b.isChosen=e,b.version=
this._version,b;this._nodeTraversalState[a.index]={nodeHasLOD:c,lodLevel:d,isChosen:e,version:this._version};return this._nodeTraversalState[a.index]};c.prototype._loadNode=function(a){var b=this;this._loading.add(a);var d=k.expect(this.getNodeInternal(a)).ref.id,c=this.layerUrl+"/nodes/"+d,e=function(){b._loading.delete(a);0===b._missing.length&&0===b._loading.size&&b.requestUpdate()};this.streamDataController.request(c,"json").then(function(c){c=b._validateNode(d,c);null!=c&&(c.obb&&b.invalidateVisibilityCache(a),
c=b.addNode(c,a),b.nodeTraversalState(c));e()},function(d){y.isAbortError(d)||(b.logger.error("Error loading node: "+c),b._failedNodes.add(a));e()})};c.prototype._validateNode=function(a,b){var c=this;if(null==b||"object"!==typeof b||b.id!==a)return this.logger.error('Invalid node. Wrong type or wrong id "'+a+'"'),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+a+'"');null==b.geometryData||Array.isArray(b.geometryData)&&
1===b.geometryData.length&&"./geometries/0"===b.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+a+'"');null==b.attributeData||Array.isArray(b.attributeData)&&!b.attributeData.some(function(a,b){return a.href!=="./attributes/f_"+b+"/0"})||this.logger.warn('Invalid attribute data on node "'+a+'"');b.featureData&&1<b.featureData.length&&this.logger.warn("Node "+a+" has "+b.featureData.length+" bundles. Only the first bundle will be loaded.");var f=b.hasOwnProperty("obb")&&!this.ignoreServiceOBB?
b.obb:null,e=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:null,g=function(b){if(null==b)return null;var d=function(b){return c.logger.error("Invalid node reference on node "+a+": "+b)};if("number"===typeof b.id)d("id "+b.id+" is a number instead of a string.");else if("string"!==typeof b.id||!Array.isArray(b.mbs))return d("Missing or invalid id."),null;if(!Array.isArray(b.mbs))return d("Invalid bounding volume on reference "+
b.id+"."),null;b.href&&b.href!=="../"+b.id&&c.logger.error('Invalid node href on node "'+a+'"');d=b.hasOwnProperty("obb")&&!c.ignoreServiceOBB?b.obb:null;return{id:""+b.id,mbs:b.mbs,obb:d}},g=Array.isArray(b.children)?b.children.map(g).filter(function(a){return null!=a}):null;return{id:a,mbs:b.mbs,obb:f,children:g,resources:{hasFeatureData:b.featureData&&0<b.featureData.length,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:null,texture:b.textureData&&0<b.textureData.length?
a:null,geometry:null!=b.geometryData?a:null},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:e}};c.prototype.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this.forAllNodes(function(a){a.node&&(a.node.failed=!1)})};c.prototype.entryPriority=function(a){var b=this.getNodeInternal(a),c=this.getParentIndex(a);if(k.isNone(b)||0>c&&null==b.node)return 0>c?Infinity:this.entryPriority(c);var f=
0;b.node&&0<=c&&(c=this._nodeTraversalState[c],null!=c&&(f=c.lodLevel));for(c=this.progressiveLoadPenalty;0<=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=this.viewportQueries.distToPOI(b.ref||b.node);return-b-f*(b+this.progressiveLoadPenalty)+c};c.prototype.traverseVisible=function(a){var b=this.getNodeInternal(this.rootIndex);k.isSome(b)?this._traverse(this.rootIndex,b,a):a(this.rootIndex,null)};c.prototype._traverse=function(a,b,c){if(b.node&&0===b.childCount)this.isGeometryVisible(a)&&
c(a,b);else if(this.isNodeVisible(a)&&(c(a,b),null!=b.node)){var d=this.nodeTraversalState(b.node);if(!d.nodeHasLOD||d.lodLevel!==this._maxLodLevel)for(a=k.expect(this.getPage(a)),d=0;d<b.childCount;d++){var e=a.children[b.childOffset+d],g=this.getNodeInternal(e);k.isSome(g)?this._traverse(e,g,c):c(e,null)}}};c.prototype.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};c.prototype.traverseChildren=function(a,b){a=a.index;var c=this.getNodeInternal(a);k.isSome(c)&&this._traverseChildren(a,
c,b)};c.prototype._traverseChildren=function(a,b,c){a=this.getPage(a);if(!k.isNone(a))for(var d=0;d<b.childCount;++d){var e=a.children[b.childOffset+d],g=this.getNodeInternal(e);k.isSome(g)&&g.node&&c(g.node)&&this._traverseChildren(e,g,c)}};c.prototype.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){var b=
this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};c.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)};c.prototype.updateElevationInfo=function(a){this.forAllNodes(D);this.viewportQueries.updateElevationInfo(a)};c.prototype.invalidateBoundingVolumeCache=function(a){a=this.getNodeInternal(a);k.isSome(a)&&D(a)};c.prototype.forAllNodes=function(a){for(var b=0;b<this.nodePages.length;b++){var c=this.nodePages[b];
if(c)for(var f=b*this.nodesPerPage,e=0;e<c.nodes.length;e++)a(c.nodes[e],f+e)}};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{addNode:function(b,c){return a.addNode(b,c)}}},enumerable:!0,configurable:!0});return c}();x.I3SIndex=C;var m=new Map,J=function(){function c(){this.update=new p({deallocator:null});this.add=new p({deallocator:null});this.cancel=[]}c.prototype.reset=function(a,b){this.add.clear();this.update.clear();this.cancel=a;this.missing=b};return c}(),G=[["maxScreenThreshold",
1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];x.selectErrorMetric=E;var B=function(){return function(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0}}()});