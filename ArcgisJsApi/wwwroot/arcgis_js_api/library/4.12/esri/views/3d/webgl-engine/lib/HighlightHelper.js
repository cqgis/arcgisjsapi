// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f32 ../../../../core/libs/gl-matrix-2/vec4f64 ../../support/debugFlags ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./glUtil3D ./Util ../shaders/HighlightPrograms ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/renderState ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(D,E,t,u,v,q,w,x,y,z,n,A,r,p,m,B){return function(){function h(b,
f){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0};this.blur1Fbo=this.blur0Fbo=this.quadVAO=null;this._rctx=f;this.viewportToRestore=v.vec4f64.create();this.defaultOptions={color:u.vec4f32.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};this.blurProgram=b.getProgram(n.blurPass,{gaussianSamples:5});this.blurGridProgram=b.getProgram(n.blurPass,{gaussianSamples:5,
gridOptimization:!0});this.applyProgram=b.getProgram(n.applyPass);this.applyGridProgram=b.getProgram(n.applyPass,{gridOptimization:!0});this.applyGridDebugProgram=b.getProgram(n.applyPass,{gridOptimization:!0,gridDebug:!0});this.downsampleProgram=b.getProgram(n.downsamplePass);this.preprocessPipelineState=p.makePipelineState({colorWrite:p.defaultColorWriteParams});this.applyPipelineState=p.makePipelineState({blending:p.separateBlendingParams(770,1,771,771),colorWrite:p.defaultColorWriteParams})}Object.defineProperty(h.prototype,
"enabled",{get:function(){return null!==this.blur0Fbo},set:function(b){b?this.enable():this.disable()},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"profilingCallback",{get:function(){return q.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(b){return console.log(b)}:null},enumerable:!0,configurable:!0});h.prototype.setDefaultOptions=function(b){this.defaultOptions=b};h.prototype.render=function(b,f,C){var c=b.pixelRatio,d=!q.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,k=q.HIGHLIGHTS_VISUALIZE_BLOCKS,
a=this._rctx;z.assert(this.enabled);t.vec4.copy(this.viewportToRestore,b.fullViewport);var g=Math.ceil(b.fullWidth/c);b=Math.ceil(b.fullHeight/c);this.blur0Fbo.resize(g,b);this.blur1Fbo.resize(g,b);a.bindVAO(this.quadVAO);a.setPipelineState(this.preprocessPipelineState);var e=null,l=c=e=null;if(d){var h=this._grid;this._gridUpdateResources(f,32);this._gridComputeMipmap();c=h.vao;l=4;e=this.blurGridProgram;a.bindProgram(e);a.bindTexture(h.coverageMipmap[h.mipmapLevels].colorTexture,1);e.setUniform1i("coverageTex",
1)}else c=this.quadVAO,l=5,e=this.blurProgram,a.bindProgram(e);a.bindVAO(c);a.bindFramebuffer(this.blur0Fbo);a.setViewport(0,0,g,b);a.setClearColor(0,0,0,0);a.clear(16384);e.setUniform1i("tex",0);a.bindTexture(f.colorTexture,0);e.setUniform2f("blurSize",1/g,0);a.drawArrays(l,0,m.vertexCount(c,"geometry"));a.bindFramebuffer(this.blur1Fbo);a.clear(16384);a.bindTexture(this.blur0Fbo.colorTexture,0);e.setUniform2f("blurSize",0,1/b);a.drawArrays(l,0,m.vertexCount(c,"geometry"));a.bindFramebuffer(C);a.setPipelineState(this.applyPipelineState);
a.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);d?(e=k?this.applyGridDebugProgram:this.applyGridProgram,a.bindProgram(e),e.setUniform1i("coverageTex",2),a.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,2)):(e=this.applyProgram,a.bindProgram(e));e.setUniform1i("tex",0);a.bindTexture(this.blur1Fbo.colorTexture,0);e.setUniform1i("origin",1);a.bindTexture(f.colorTexture,1);e.setUniform4fv("color",this.defaultOptions.color);
e.setUniform1f("outlineSize",8.6);e.setUniform1f("blurSize",.4);e.setUniform4f("opacities",this.defaultOptions.haloOpacity,this.defaultOptions.haloOpacityOccluded,this.defaultOptions.fillOpacity,this.defaultOptions.fillOpacityOccluded);a.drawArrays(l,0,m.vertexCount(c,"geometry"));a.bindVAO(null)};h.prototype.enable=function(){if(!this.enabled){this.quadVAO=y.createQuadVAO(this._rctx);var b={colorTarget:0,depthStencilTarget:0,width:0,height:0},f={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,
wrapMode:33071,width:0,height:0};this.blur0Fbo=r.createWithAttachments(this._rctx,f,b);this.blur1Fbo=r.createWithAttachments(this._rctx,f,b)}};h.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.blur1Fbo=this.blur0Fbo=this.quadVAO=null)};h.prototype._gridUpdateResources=function(b,f){var h=this._rctx,c=this._grid,d=!1;null===c.coverageMipmap&&(c.coverageMipmap=[b],d=!0);if(c.viewportWidth!==b.width||c.viewportHeight!==b.height)d=
!0,c.viewportWidth=b.width,c.viewportHeight=b.height;c.coverageMipmap[0]=b;c.cellPixelSize!==f&&(c.cellPixelSize=f,d=!0);if(d){for(f=1;f<c.coverageMipmap.length;f++)c.coverageMipmap[f].dispose();c.mipmapLevels=Math.ceil(Math.log(c.cellPixelSize)*Math.LOG2E);c.coverageMipmap.length=c.mipmapLevels+1;for(f=0;f<c.mipmapLevels;f++)d=c.coverageMipmap[f],d=r.createWithAttachments(h,{target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(d.width/2),height:Math.ceil(d.height/
2)},{colorTarget:0,depthStencilTarget:0,width:Math.ceil(d.width/2),height:Math.ceil(d.height/2)}),c.coverageMipmap[f+1]=d}var d=Math.ceil(b.height/c.cellPixelSize),k=Math.ceil(b.width/c.cellPixelSize);if(!c.vao||c.verticalCellCount!==d||c.horizontalCellCount!==k){c.verticalCellCount=d;c.horizontalCellCount=k;b=d+1;f=k+1;for(var d=1/d,k=1/k,a=new Float32Array(24*b*f),g=0,e=0;e<b;e++)for(var l=0;l<f;l++)a[g+0]=(l-.5)*k*2-1,a[g+1]=(e-.5)*d*2-1,a[g+2]=l*k,a[g+3]=e*d,a[g+4]=(l+.5)*k*2-1,a[g+5]=(e-.5)*
d*2-1,a[g+6]=l*k,a[g+7]=e*d,a[g+8]=(l-.5)*k*2-1,a[g+9]=(e+.5)*d*2-1,a[g+10]=l*k,a[g+11]=e*d,a[g+12]=(l-.5)*k*2-1,a[g+13]=(e+.5)*d*2-1,a[g+14]=l*k,a[g+15]=e*d,a[g+16]=(l+.5)*k*2-1,a[g+17]=(e-.5)*d*2-1,a[g+18]=l*k,a[g+19]=e*d,a[g+20]=(l+.5)*k*2-1,a[g+21]=(e+.5)*d*2-1,a[g+22]=l*k,a[g+23]=e*d,g+=24;c.vao&&c.vao.dispose(!0);c.vao=new B(h,w.Default3D,{geometry:x.Pos2Tex},{geometry:A.createVertex(h,35044,a)})}};h.prototype._gridComputeMipmap=function(){var b=this._rctx,f=this._grid,h=this.downsampleProgram;
b.bindVAO(this.quadVAO);for(var c=0;c<f.mipmapLevels;c++){b.bindFramebuffer(f.coverageMipmap[c+1]);b.bindTexture(f.coverageMipmap[c].colorTexture,0);var d=f.coverageMipmap[c+1].width,k=f.coverageMipmap[c+1].height;b.bindProgram(h);h.setUniform1i("tex",0);h.setUniform2f("invFramebufferDim",1/d,1/k);b.setViewport(0,0,d,k);b.drawArrays(5,0,m.vertexCount(this.quadVAO,"geometry"))}};h.prototype.getGpuMemoryUsage=function(){var b=m.getGpuMemoryUsage(this.blur0Fbo)+m.getGpuMemoryUsage(this.blur1Fbo);if(this._grid&&
this._grid.coverageMipmap)for(var f=0,h=this._grid.coverageMipmap;f<h.length;f++)b+=m.getGpuMemoryUsage(h[f]);return b};return h}()});