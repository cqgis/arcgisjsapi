// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/maybe ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../lib/GLMaterial ./internal/MaterialUtil ./internal/waterMaterialUtils ../shaders/WaterSurfacePrograms ../../../webgl/renderState".split(" "),function(h,l,m,r,t,u,n,k,f,p,g){Object.defineProperty(l,"__esModule",{value:!0});h=function(e){function d(b,a,c){b=e.call(this,b,a)||this;b._elapsedTime=0;b.updateParameters();return b}m(d,
e);d.prototype.updateParameters=function(){this.params=k.copyParameters(this.material.getParameters());this.selectProgram()};d.prototype._selectPipelineState=function(){this.pipelineState=g.makePipelineState({blending:this.params.transparent&&g.separateBlendingParams(770,1,771,771),depthTest:{func:513},depthWrite:this.params.writeDepth&&g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};d.prototype.selectProgram=function(){this.program=this.programRep.getProgram(p.color,{slice:this.params.slicePlaneEnabled,
receiveShadows:!0});this._selectPipelineState()};d.prototype.beginSlot=function(b){var a=5;this.params.transparent&&(a=this.params.writeDepth?7:10);return b===a};d.prototype.getProgram=function(){return this.program};d.prototype._initTextures=function(b){this.texturePaths=[this.params.waveTexture,this.params.perturbationTexture];f.waterTextureRepo.initialize(b,this.texturePaths)};d.prototype._bindUniforms=function(b,a){a=this.program;var c=this.params;null!=c.polygonOffset&&(b.gl.enable(b.gl.POLYGON_OFFSET_FILL),
b.gl.polygonOffset(c.polygonOffset.factor,c.polygonOffset.units));b.bindProgram(a);b.setPipelineState(this.pipelineState);f.waterTextureRepo.bindRepo(b);a.setUniform1i("texWaveNormal",0);a.setUniform1i("texWavePerturbation",1);a.setUniform1f("dtrExponent",c.dtrExponent);a.setUniform1f("roughness",c.roughness);a.setUniform1f("f0maxSpec",c.f0maxSpec);a.setUniform4fv("waterColor",c.color);a.setUniform3fv("skyColor",c.sky.horizon);a.setUniform3fv("skyZenitColor",c.sky.zenit);a.setUniform1f("f0Sky",c.f0Sky);
a.setUniform1f("f0maxSky",c.f0maxSky);a.setUniform1f("expSky",c.expSky);a.setUniform4f("waveParams",c.waveStrength,c.waveTextureRepeat,c.flowStrength,c.flowOffset);a.setUniform2f("waveDirection",c.waveDirection[0]*c.waveVelocity,c.waveDirection[1]*c.waveVelocity);a.setUniform1f("timeElapsed",.001*this._elapsedTime*c.animationSpeed)};d.prototype.bind=function(b,a){f.waterTextureRepo.ready()?this._bindUniforms(b,a):f.waterTextureRepo.loading()||this._initTextures(b)};d.prototype.animate=function(b){r.isNone(this._startTime)&&
(this._startTime=b);this._elapsedTime=this._startTime-b};d.prototype.release=function(b){null!=this.params.polygonOffset&&b.gl.disable(b.gl.POLYGON_OFFSET_FILL)};d.prototype.bindView=function(b,a){b=this.program;b.setUniform3fv("localOrigin",a.origin);k.bindView(a.origin,a.view,b);k.bindCamPos(a.origin,a.viewInvTransp,b);var c=a.lightingData;t.vec3.set(q,c.diffuse[0],c.diffuse[1],c.diffuse[2]);b.setUniform3fv("lightIntensity",q);this.params.slicePlaneEnabled&&k.bindSlicePlane(a.origin,a.slicePlane,
b);a.shadowMappingEnabled?(a.shadowMap.bind(b),a.shadowMap.bindView(b,a.origin),b.setUniform1i("shadowsEnabled",1)):b.setUniform1i("shadowsEnabled",0)};d.prototype.bindInstance=function(b,a){this.program.setUniformMatrix4fv("model",a.transformation)};d.prototype.getDrawMode=function(){return 4};return d}(n);l.WaterGLMaterial=h;n=function(e){function d(){return null!==e&&e.apply(this,arguments)||this}m(d,e);d.prototype.bind=function(b,a){b.bindProgram(this.program);b.setPipelineState(this.pipelineState);
this.program.setUniform4fv("waterColor",this.params.color)};d.prototype.bindView=function(b,a){this.program.setUniform3fv("localOrigin",a.origin);k.bindView(a.origin,a.view,this.program)};d.prototype.beginSlot=function(b){return null==b};d.prototype.selectProgram=function(){this.program=this.programRep.getProgram(p.drapedColor,{slice:this.params.slicePlaneEnabled,receiveShadows:!0});this._selectPipelineState()};return d}(h);l.WaterDrapedGLMaterial=n;h=function(e){function d(){return null!==e&&e.apply(this,
arguments)||this}m(d,e);d.prototype.bind=function(b,a){if(f.waterTextureRepo.ready()){a=this.program;var c=this.params;b.bindProgram(a);b.setPipelineState(this.pipelineState);f.waterTextureRepo.bindRepo(b);a.setUniform1i("texWaveNormal",0);a.setUniform1i("texWavePerturbation",1);a.setUniform4f("waveParams",c.waveStrength,c.waveTextureRepeat,c.flowStrength,c.flowOffset);a.setUniform2f("waveDirection",c.waveDirection[0]*c.waveVelocity,c.waveDirection[1]*c.waveVelocity);a.setUniform1f("timeElapsed",
.001*this._elapsedTime*c.animationSpeed)}else f.waterTextureRepo.loading()||this._initTextures(b)};d.prototype.bindView=function(b,a){this.program.setUniform3fv("localOrigin",a.origin);k.bindView(a.origin,a.view,this.program)};d.prototype.beginSlot=function(b){return 20===b};d.prototype._selectPipelineState=function(){this.pipelineState=g.makePipelineState({depthTest:{func:513},depthWrite:this.params.writeDepth&&g.defaultDepthWriteParams,colorWrite:g.defaultColorWriteParams})};d.prototype.selectProgram=
function(){this.program=this.programRep.getProgram(p.drapedNormal,{slice:this.params.slicePlaneEnabled,receiveShadows:!0});this._selectPipelineState()};return d}(h);l.WaterNormalGLMaterial=h;var q=u.vec3f64.create()});