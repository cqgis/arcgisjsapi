// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/compilerUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/MeshComponent ../../../../geometry/support/webMercatorUtils ../../../../geometry/support/meshUtils/projection ./ElevationAligners ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ../support/edgeUtils ../support/symbolColorUtils ../../support/debugFlags ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Texture ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/NativeLineMaterial".split(" "),
function(r,L,Y,Z,aa,M,ba,C,R,ca,da,G,l,q,S,ea,fa,ga,T,ha,ia,x,ja,ka,la,U,ma,I,N,O,na,oa,pa,qa,V){Object.defineProperty(L,"__esModule",{value:!0});var h=pa.VertexAttrConstants;r=function(r){function e(a,b,c,d){a=r.call(this,a,b,c,d)||this;a._edgeStageObjects=new Set;a._materials=new Map;a._textures=new Map;return a}Y(e,r);e.prototype.doLoad=function(){return aa(this,void 0,void 0,function(){return Z(this,function(a){U.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new V({color:[1,0,1,
1]},"debugVertexNormal"),this._debugFaceNormalMaterial=new V({color:[0,1,1,1]},"debugFAceNormal"));return[2]})})};e.prototype.destroy=function(){var a=this;r.prototype.destroy.call(this);this._materials.forEach(function(b){a._context.stage.remove(I.ModelContentType.MATERIAL,b.material.id)});this._textures.forEach(function(b){a._context.stage.remove(I.ModelContentType.TEXTURE,b.id)});this._materials.clear();this._textures.clear()};e.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if("mesh"!==
b.geometry.type)return this.logger.warn("unsupported geometry type for fill on mesh-3d symbol: "+b.geometry.type),null;if(!this._validateGeometry(b.geometry))return null;var c="graphic"+b.uid,d=this.getGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,d,c,b.uid)};e.prototype.layerOpacityChanged=function(){var a=this,b=this._getLayerOpacity();this._materials.forEach(function(c){c.material.setParameterValues({layerOpacity:b});var d=c.material.getParameters();a._setMaterialTransparentParameter(d,
c);c.material.setParameterValues({transparent:d.transparent})});if(0<this._edgeStageObjects.size){var c=this._context.stage.renderView.ensureEdgeView(),d=this._getLayerOpacity();this._edgeStageObjects.forEach(function(a){return c.updateAllComponentOpacities(a,[d])})}return!0};e.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,x.needsElevationUpdates3D)};e.prototype.slicePlaneEnabledChanged=function(a,b){var c=this;this._materials.forEach(function(a){a.material.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});
if(0<this._edgeStageObjects.size){var d=this._context.stage.renderView.ensureEdgeView();a=this._createEdgeMaterial(d);if(C.isSome(a)){var g=[a];this._edgeStageObjects.forEach(function(a){return d.updateAllComponentMaterials(a,g,{slicePlaneEnabled:c._context.slicePlaneEnabled},!1)})}}return!0};e.prototype.pixelRatioChanged=function(a,b){return!0};e.prototype._requiresSymbolVertexColors=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};e.prototype._colorOrTextureUid=
function(a){return a?a instanceof M?a.toHex():a.contentHash:"-"};e.prototype._materialProperties=function(a,b,c){var d=this._requiresSymbolVertexColors(),g,k,e,f,h,n,l,z,u;b.material&&(k=b.material.color,g=this._colorOrTextureUid(b.material.color),e=b.material.colorTexture,f=this._colorOrTextureUid(b.material.colorTexture),h=b.material.normalTexture,n=this._colorOrTextureUid(b.material.normalTexture),l=b.material.doubleSided,z=b.material.alphaCutoff,u=b.material.alphaMode);b=!!a.vertexAttributes.color;
a=!!a.vertexAttributes.tangent;return{hasSymbolVertexColors:d,hasVertexColors:b,hasVertexTangents:a,color:k,colorTexture:e,normalTexture:h,uid:"vc:"+b+",vt:"+a+",vct"+c+",svc:"+d+",cmuid:"+g+",ctmuid:"+f+",ntmuid:"+n+",ds:"+l+",ac:"+z+",am:"+u}};e.prototype._setInternalColorValueParameters=function(a,b){b.diffuse=M.toUnitRGB(a);b.opacity=a.a};e.prototype._getLoadableTextureResource=function(a){return a.data?a.data instanceof HTMLImageElement?a.data.complete?a.data:a.data.src:a.data:a.url};e.prototype._getInternalTextureId=
function(a,b){var c=this._getLoadableTextureResource(a);if(c){var d=a.contentHash,g=this._textures.get(d);g||(g=new oa(c,b+"_"+d+"_tex",{mipmap:!0,wrap:this._castTextureWrap(a.wrap),noUnpackFlip:!0}),this._textures.set(d,g),this._context.stage.add(I.ModelContentType.TEXTURE,g));return g.id}};e.prototype._castTextureWrap=function(a){void 0===a&&(a="repeat");return"string"===typeof a?(a=this._castTextureWrapIndividual(a),{s:a,t:a}):{s:this._castTextureWrapIndividual(a.horizontal),t:this._castTextureWrapIndividual(a.vertical)}};
e.prototype._castTextureWrapIndividual=function(a){switch(a){case "clamp":return 33071;case "mirror":return 33648;default:return 10497}};e.prototype._setInternalMaterialParameters=function(a,b,c){a.color&&this._setInternalColorValueParameters(a.color,c);a.colorTexture&&(c.textureId=this._getInternalTextureId(a.colorTexture,b));a.hasVertexTangents&&a.normalTexture&&(c.normalTextureId=this._getInternalTextureId(a.normalTexture,b))};e.prototype._setExternalMaterialParameters=function(a){var b=this._isPropertyDriven("color"),
c=C.isSome(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;b?a.externalColor=S.vec4f64.ONES:(b=C.isSome(this.symbolLayer.material)?this.symbolLayer.material.color:null,C.isSome(b)?a.externalColor=M.toUnitRGBA(b):(c=null,a.externalColor=S.vec4f64.ONES));c&&(a.colorMixMode=c)};e.prototype._hasTransparentVertexColors=function(a){a=a.vertexAttributes.color;if(!a)return!1;for(var b=3;b<a.length;b+=4)if(255!==a[b])return!0;return!1};e.prototype._getOrCreateMaterial=function(a,b){var c=
b.material&&b.material.color,d=b.material&&b.material.colorTexture,c=this._hasTransparentVertexColors(a)||c&&1>c.a||d&&d.transparent;a=this._materialProperties(a,b,c);if(d=this._materials.get(a.uid))return d.material;var c={material:null,isComponentTransparent:c,alphaMode:b.material?b.material.alphaMode:"opaque"},d=this._getStageIdHint(),g={specular:q.vec3f64.ZEROS,vertexColors:a.hasVertexColors,symbolColors:a.hasSymbolVertexColors,vertexTangents:a.hasVertexTangents,ambient:q.vec3f64.ZEROS,diffuse:q.vec3f64.ONES,
opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:"none",layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,textureInitTransparent:!0};b.material&&(g.doubleSided=b.material.doubleSided,g.cullFace=b.material.doubleSided?"none":"back",g.textureAlphaCutoff=b.material.alphaCutoff);this._setInternalMaterialParameters(a,d,g);this._setExternalMaterialParameters(g);this._setMaterialTransparentParameter(g,c);b=new qa(g,d+"_"+a.uid+"_mat");c.material=b;this._materials.set(a.uid,
c);this._context.stage.add(I.ModelContentType.MATERIAL,b);return b};e.prototype._setMaterialTransparentParameter=function(a,b){var c=this._isPropertyDriven("opacity");a.transparent=c||b.isComponentTransparent||1>a.layerOpacity||1>a.opacity||a.externalColor&&1>a.externalColor[3];a.textureAlphaMode="auto"===b.alphaMode?a.transparent?"maskBlend":"opaque":b.alphaMode};e.prototype._addDebugNormals=function(a,b,c,d){var g,k,e,P,H=b.length,n=a.spatialReference.isGeographic?20015077/180:1,q=.1*Math.max(a.extent.width*
n,a.extent.height*n,a.extent.zmax-a.extent.zmin),z=[],u=[];a=[];for(var n=[],Q=0;Q<H;Q++)for(var A=b[Q],v=A.data.getAttribute(h.POSITION),r=A.data.getAttribute(h.NORMAL),w=A.data.getIndices(h.POSITION),A=A.data.getIndices(h.NORMAL),v=v.data,r=r.data,m=0;m<w.length;m++){for(var t=3*w[m],D=3*A[m],p=0;3>p;p++)z.push(v[t+p]);for(p=0;3>p;p++)z.push(v[t+p]+r[D+p]*q);u.push(u.length);u.push(u.length);if(0===m%3){this._calculateFaceNormal(v,w,m,B);this._getFaceVertices(v,w,m,f,E,F);l.vec3.add(f,f,E);l.vec3.add(f,
f,F);l.vec3.scale(f,f,1/3);for(p=0;3>p;p++)a.push(f[p]);for(p=0;3>p;p++)a.push(f[p]+B[p]*q);n.push(n.length);n.push(n.length)}}H=(g={},g[h.POSITION]={data:new Float64Array(z),size:3},g);g=(k={},k[h.POSITION]=new Uint32Array(u),k);k=new O(H,g,void 0,"line");k=new N(k,"debugVertexNormal");k.singleUse=!0;b.push(k);c.push(this._debugVertexNormalMaterial);d.push(G.mat4f64.clone(d[0]));H=(e={},e[h.POSITION]={data:new Float64Array(a),size:3},e);g=(P={},P[h.POSITION]=new Uint32Array(n),P);k=new O(H,g,void 0,
"line");k=new N(k,"debugFaceNormal");k.singleUse=!0;b.push(k);c.push(this._debugFaceNormalMaterial);d.push(G.mat4f64.clone(d[0]))};e.prototype._createAs3DShape=function(a,b,c,d,g){var k=this;a=a.geometry;if("mesh"!==a.type)return null;var e=this._createGeometryInfo(a,b,d);if(!e)return null;b=e.geometries;var f=e.materials,h=e.transformations,e=e.objectTransformation;U.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,b,f,h);var n=new na({geometries:b,materials:f,transformations:h,castShadow:!0,
metadata:{layerUid:this._context.layer.uid,graphicUid:g},idHint:d});n.objectTransformation=e;var l=function(a){var b=k._context.stage.renderView.ensureEdgeView();b.removeObject(a);k._edgeStageObjects.delete(a);var c=k._createEdgeMaterial(b);C.isSome(c)&&(k._edgeStageObjects.add(a),b.addObject(a,[c],{slicePlaneEnabled:k._context.slicePlaneEnabled},!k._context.isAsync,{mergeGeometries:!0}))};l(n);d=function(a,b,c,d,g){a=ha.perObjectElevationAligner(a,b,c,d,g);l(n);return a};g=new ia(this,n,b,null,null,
d,c);g.needsElevationUpdates=x.needsElevationUpdates3D(c.mode);c=a.extent.center.clone();c.z=0;g.elevationContext.centerPointInElevationSR=c;g.alignedTerrainElevation=d(g,g.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper,this._context.featureExpressionInfoContext);return g};e.prototype._createComponentNormals=function(a,b,c,d){var g=c.shading||"flat";switch(g){case "source":return this._createComponentNormalsSource(a,b,c,d);case "flat":return this._createComponentNormalsFlat(a,
c,d);case "smooth":return this._createComponentNormalsSmooth(a,c,d);default:ba.neverReached(g)}};e.prototype._createComponentNormalsSource=function(a,b,c,d){if(!b)return this._createComponentNormalsFlat(a,c,d);var g=!1;if(!c.trustSourceNormals)for(c=0;c<d.length;c+=3){this._calculateFaceNormal(a,d,c,B);for(var e=0;3>e;e++){var y=3*d[c+e];f[0]=b[y+0];f[1]=b[y+1];f[2]=b[y+2];0>l.vec3.dot(B,f)&&(b[y+0]=-b[y+0],b[y+1]=-b[y+1],b[y+2]=-b[y+2],g=!0)}}return{normals:b,indices:d,didFlipNormals:g}};e.prototype._createComponentNormalsFlat=
function(a,b,c){b=new Float32Array(c.length);for(var d=new Uint32Array(3*c.length),g=0;g<c.length;g+=3)for(var e=this._calculateFaceNormal(a,c,g,B),f=0;3>f;f++)b[g+f]=e[f],d[g+f]=g/3;return{normals:b,indices:d,didFlipNormals:!1}};e.prototype._createComponentNormalsSmooth=function(a,b,c){b={};for(var d=0;d<c.length;d+=3)for(var g=this._calculateFaceNormal(a,c,d,B),e=0;3>e;e++){var f=c[d+e],h=b[f];h||(h={normal:q.vec3f64.create(),count:0},b[f]=h);l.vec3.add(h.normal,h.normal,g);h.count++}a=new Float32Array(3*
c.length);g=new Uint32Array(3*c.length);for(d=0;d<c.length;d++){f=c[d];h=b[f];1!==h.count&&(l.vec3.normalize(h.normal,h.normal),h.count=1);for(e=0;3>e;e++)a[3*d+e]=h.normal[e];g[d]=d}return{normals:a,indices:g,didFlipNormals:!1}};e.prototype._getFaceVertices=function(a,b,c,d,g,e){var f=3*b[c+0],k=3*b[c+1];b=3*b[c+2];d[0]=a[f+0];d[1]=a[f+1];d[2]=a[f+2];g[0]=a[k+0];g[1]=a[k+1];g[2]=a[k+2];e[0]=a[b+0];e[1]=a[b+1];e[2]=a[b+2]};e.prototype._calculateFaceNormal=function(a,b,c,d){this._getFaceVertices(a,
b,c,f,E,F);l.vec3.subtract(E,E,f);l.vec3.subtract(F,F,f);l.vec3.cross(f,E,F);l.vec3.normalize(d,f);return d};e.prototype._getOrCreateComponents=function(a){return a.components?a.components:ra};e.prototype._createPositionBuffer=function(a){var b=a.vertexAttributes.position,c=new Float64Array(b.length);x.reproject(a.vertexAttributes.position,0,a.spatialReference,c,0,this._context.renderSpatialReference,b.length/3);return c};e.prototype._createNormalBuffer=function(a,b){var c=a.vertexAttributes.normal;
if(!c)return null;if("local"===this._context.layerView.view.viewingMode)return c;var d=a.vertexAttributes.position,e=new Float32Array(c.length);return T.projectNormalToECEF(c,d,b,a.spatialReference,e)};e.prototype._createTangentBuffer=function(a,b){var c=a.vertexAttributes.tangent;if(!c)return null;if("local"===this._context.layerView.view.viewingMode)return c;var d=a.vertexAttributes.position,e=new Float32Array(c.length);return T.projectTangentToECEF(c,d,b,a.spatialReference,e)};e.prototype._createColorBuffer=
function(a){return a.vertexAttributes.color};e.prototype._createSymbolColorBuffer=function(a){if(this._requiresSymbolVertexColors()){a=this._getVertexOpacityAndColor(a);var b=C.get(this.symbolLayer,"material","colorMixMode"),c=new Uint8Array(4);la.encodeSymbolColor(a,b,c);return c}return null};e.prototype._createColorIndices=function(a,b){a=new Uint32Array(b.length);for(b=0;b<a.length;b++)a[b]=0;return a};e.prototype._createBuffers=function(a,b){var c=a.vertexAttributes&&a.vertexAttributes.position;
if(!c)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;var d=a.vertexAttributes.normal,e=a.vertexAttributes.uv,f=a.vertexAttributes.tangent;if(d&&d.length!==c.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(f&&f.length/4!==c.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(e&&e.length/2!==c.length/
3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;c=this._createPositionBuffer(a);d=this._createColorBuffer(a);b=this._createSymbolColorBuffer(b);var f=this._createNormalBuffer(a,c),h=this._createTangentBuffer(a,c);a=this._transformCenterLocal(a,c,f);return{positionBuffer:c,normalBuffer:f,tangentBuffer:h,uvBuffer:e,colorBuffer:d,symbolColorBuffer:b,objectTransformation:a}};e.prototype._transformCenterLocal=function(a,b,c){var d=
a.extent.center,e=this._context.renderSpatialReference;J[0]=d.x;J[1]=d.y;J[2]=0;d=G.mat4f64.create();ma.computeLinearTransformation(a.spatialReference,J,d,e);da.mat4.invert(W,d);for(a=0;a<b.length;a+=3)f[0]=b[a+0],f[1]=b[a+1],f[2]=b[a+2],l.vec3.transformMat4(f,f,W),b[a+0]=f[0],b[a+1]=f[1],b[a+2]=f[2];if(c)for(R.mat3.fromMat4(K,d),R.mat3.transpose(K,K),a=0;a<c.length;a+=3)f[0]=c[a+0],f[1]=c[a+1],f[2]=c[a+2],l.vec3.transformMat3(f,f,K),c[a+0]=f[0],c[a+1]=f[1],c[a+2]=f[2];return d};e.prototype._validateFaces=
function(a,b){a=a.vertexAttributes.position.length/3;if(b=b.faces){for(var c=-1,d=0;d<b.length;d++){var e=b[d];e>c&&(c=e)}if(a<=c)return this.logger.warn("Vertex index "+c+" is out of bounds of the mesh position buffer"),!1}else if(0!==a%3)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0};e.prototype._getOrCreateFaces=function(a,b){if(b.faces)return b.faces;a=new Uint32Array(a.vertexAttributes.position.length/
3);for(b=0;b<a.length;b++)a[b]=b;return a};e.prototype._isOutsideClippingArea=function(a){if(!this._context.clippingExtent)return!1;var b=a.vertexAttributes&&a.vertexAttributes.position;if(!b)return!1;var c=this._context.elevationProvider.spatialReference,d=b.length/3;a.spatialReference.equals(c)||(b=new Float64Array(b.length),x.reproject(a.vertexAttributes.position,0,a.spatialReference,b,0,c,d));x.computeBoundingBox(b,0,d,X);return x.boundingBoxClipped(X,this._context.clippingExtent)};e.prototype._createGeometryInfo=
function(a,b,c){var d,e;if(!ga.canProject(a,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(a))return null;var f=this._createBuffers(a,b);if(!f)return null;b=f.positionBuffer;for(var l=f.uvBuffer,q=f.colorBuffer,r=f.symbolColorBuffer,n=f.normalBuffer,C=f.tangentBuffer,f=f.objectTransformation,z=[],u=[],x=[],A=!1,v=0,B=this._getOrCreateComponents(a);v<B.length;v++){var w=B[v];if(!this._validateFaces(a,
w))return null;var m=this._getOrCreateFaces(a,w);if(0!==m.length){var t=this._createComponentNormals(b,n,w,m);t.didFlipNormals&&(A=!0);var D=(d={},d[h.POSITION]={size:3,data:b},d[h.NORMAL]={size:3,data:t.normals},d),t=(e={},e[h.POSITION]=m,e[h.NORMAL]=t.indices,e);q&&(D[h.COLOR]={size:4,data:q},t[h.COLOR]=m);r&&(D[h.SYMBOLCOLOR]={size:4,data:r},t[h.SYMBOLCOLOR]=this._createColorIndices(w,m));a.vertexAttributes.uv&&(D[h.UV0]={size:2,data:l},t[h.UV0]=m);a.vertexAttributes.tangent&&(D[h.TANGENT]={size:4,
data:C},t[h.TANGENT]=m);m=new O(D,t);m=new N(m,c+"_mesh");m.singleUse=!0;z.push(m);u.push(G.mat4f64.create());x.push(this._getOrCreateMaterial(a,w))}}A&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.");return{geometries:z,transformations:u,materials:x,objectTransformation:f}};e.prototype._createEdgeMaterial=function(a){var b={opacity:this._getLayerOpacity()};
return ka.createMaterial(a,this.symbolLayer,b)};return e}(ja.default);L.Graphics3DMeshFillSymbolLayer=r;var J=q.vec3f64.create(),f=q.vec3f64.create(),E=q.vec3f64.create(),F=q.vec3f64.create(),B=q.vec3f64.create(),W=G.mat4f64.create(),K=ca.mat3f64.create(),X=ea.create(),ra=[new fa];L.default=r});