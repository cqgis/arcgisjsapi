// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec3 ../../support/geometryUtils ../../support/stack ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/intersectorUtils".split(" "),function(t,A,C,y,k,l,g,n,u){function B(e,a,b){for(var d=0;d<e.length;d++){var c=e[d];a&&!a(c)||b.push(c)}return b}Object.defineProperty(A,"__esModule",{value:!0});t=function(){function e(a,b,d){this.viewingMode=a;this.layerProvider=b;this.view=d;this.tmpIntersector=
new n(this.viewingMode);this.tmpRay=l.ray.create();this.externalIntersectionHandlers=new Set;this.intersectionTolerance=n.DEFAULT_TOLERANCE;this.validateHUDIntersector=new n(this.viewingMode);this.validateHUDIntersector.enable.hud=!1}e.prototype.intersectScreen=function(a,b,d,c){return this.intersectRay(this.getPickRay(a,this.tmpRay),b,d,c)};e.prototype.intersectScreenFreePointFallback=function(a,b,d,c){return this.intersectRayFreePointFallback(this.getPickRay(a,this.tmpRay),b,d,c)};e.prototype.intersectRay=
function(a,b,d,c){c=this.computeIntersection(a,d,!1,c||this.tmpIntersector);b=c?(a=c.results.min)?a.getIntersectionPoint(b):!1:!1;return b};e.prototype.intersectRayFreePointFallback=function(a,b,d,c){return this.intersectRay(a,b,d,c)||this.intersectRayFreePointLocal(a,b)};e.prototype.intersectIntersectorScreen=function(a,b,d,c,f){void 0===c&&(c=!1);void 0===f&&(f=!1);return this.computeIntersection(this.getPickRay(a,this.tmpRay),d,c,b,f)};e.prototype.intersectToolIntersectorScreen=function(a,b,d){a=
this.getPickRay(a,this.tmpRay);var c=this.computeIntersection(a,d,!0,b),f=c.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.isOpaque()||f.hasIntersectionPoint&&"TerrainRenderer"!==f.intersector||(c=this.computeIntersection(a,d,!1,b));return c};e.prototype.setTolerance=function(a){void 0===a&&(a=n.DEFAULT_TOLERANCE);this.intersectionTolerance=a};e.prototype.addIntersectionHandler=function(a){this.externalIntersectionHandlers.add(a)};e.prototype.removeIntersectionHandler=function(a){this.externalIntersectionHandlers.delete(a)};
e.prototype.getPickRay=function(a,b){void 0===b&&(b=l.ray.create());return l.ray.fromScreen(this.view.state.camera,a,b)};e.prototype.intersectRayFreePointLocal=function(a,b){if("local"!==this.viewingMode)return!1;var d=this.view.dataExtent,c=Math.max(d.xmax-d.xmin,d.ymax-d.ymin,8*Math.max(d.xmax-d.xmin,d.ymax-d.ymin));if(0===c)return k.vec3.add(b,a.origin,k.vec3.normalize(g.sv3d.get(),a.direction)),!0;var f=this.view.state.camera,e=Math.max(0,d.xmin-f.eye[0],f.eye[0]-d.xmax),d=Math.max(0,d.ymin-f.eye[1],
f.eye[1]-d.ymax),f=c/Math.max(1,Math.pow(Math.max(0,Math.log(c/(Math.abs(f.relativeElevation)+Number.MIN_VALUE))),2)),f=Math.max(f,Math.min(Math.sqrt(e*e+d*d),c)),c=k.vec3.scale(g.sv3d.get(),a.direction,f/k.vec3.length(a.direction));k.vec3.add(b,a.origin,c);return!0};e.prototype.computeIntersection=function(a,b,d,c,f){var e=this,p=this.view.state.camera,v=y.castRenderScreenPointArray3(g.sv3d.get());p.projectPoint(a.origin,v);var h=this.prepareFilters(b,q);c=c||new n(this.viewingMode);c.enable.storeAll=
b&&b.allEnabled;c.enable.storeTerrainResults=h.filterLayerUid(u.TERRAIN_ID);c.enable.selectOpaqueTerrainOnly=!b||!("include"in b||"exclude"in b);var l=a.origin,z=k.vec3.add(g.sv3d.get(),a.origin,a.direction);c.intersect(h.layers,l,z,v,p,this.intersectionTolerance,d,null);var w=(a=this.view.slicePlane)?u.sliceFilterPredicate(a):null;c.intersect(h.sliceableLayers,l,z,v,p,this.intersectionTolerance,d,w,!1);var t=b&&b.terrainLocationFeedbackEnabled||f;this.externalIntersectionHandlers.forEach(function(a){if(a.intersectionHandlerId===
u.TERRAIN_ID){if(!t&&!h.filterLayerUid(u.TERRAIN_ID))return}else if(!h.filterLayerUid(a.intersectionHandlerId))return;a.intersect(c,a.slicePlaneEnabled?w:null,l,z,v)});b=g.sv3d.get();f&&c.results.terrain.getIntersectionPoint(b)&&(f=this.view._stage.renderView.getDrapedRenderer(),a=g.sv3d.get(),this.view.renderCoordsHelper.fromRenderCoords(b,a,this.view.spatialReference),a[2]=this.view.basemapTerrain.getElevation(b)||0,f.intersect(c,a,h.filterRenderGeometry));c.sortResults();f=c.results.hud;if(f.hasIntersectionPoint){var x=
y.castRenderScreenPointArray3(g.sv3d.get()),m=g.sv3d.get(),r=g.sv3d.get();this.unprojectHUDResultRay(f.center,x,m,r);b=k.vec3.distance(f.center,m)/k.vec3.distance(m,r)*.99;this.validateHUDIntersector.intersect(h.layers,m,r,x,p,this.intersectionTolerance,d,null);this.validateHUDIntersector.intersect(h.sliceableLayers,m,r,x,p,this.intersectionTolerance,d,w,!1);this.externalIntersectionHandlers.forEach(function(a){h.filterLayerUid(a.intersectionHandlerId)&&a.intersect(e.validateHUDIntersector,a.slicePlaneEnabled?
w:null,m,r,x)});d=this.validateHUDIntersector.results.min;if(null==d.dist||b<=d.dist)c.results.min.copyFrom(f),c.results.all.splice(0,0,f)}return c};e.prototype.prepareFilters=function(a,b){var d=[],c=[];this.layerProvider.forEachLayer(function(a){a.isPickable&&(a.isSliceable?c:d).push(a)});b.include=a&&a.include;b.exclude=a&&a.exclude;b.layers.length=0;b.sliceableLayers.length=0;B(d,b.filterLayer,b.layers);B(c,b.filterLayer,b.sliceableLayers);return b};e.prototype.unprojectHUDResultRay=function(a,
b,d,c){var e=this.view.state.camera;e.projectPoint(a,b);a=y.castRenderScreenPointArray3(g.sv3d.get());a[0]=b[0];a[1]=b[1];a[2]=0;e.unprojectPoint(a,d);a[2]=1;e.unprojectPoint(a,c)};return e}();A.SceneIntersectionHelper=t;var q={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:function(e){return q.filterLayerUid(e.apiLayerUid)},filterLayerUid:function(e){var a=q.include,b=q.exclude;return C.isNone(e)?null==a&&null==b:(null==a||a.has(e))&&(null==b||!b.has(e))},filterRenderGeometry:function(e){return q.filterLayerUid(e.data.layerUid)}}});