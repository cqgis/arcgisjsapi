// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/maybe ../../../../core/unitUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/math/common ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/WaterMaterial ../../webgl-engine/materials/internal/waterMaterialUtils".split(" "),
function(p,y,I,J,K,L,M,B,N,C,D,E,O,t,P,Q,R,S,z,A,T,U,V,m,W,u,X,Y,Z,aa,v,F,G){Object.defineProperty(y,"__esModule",{value:!0});p=function(p){function e(a,c,d,b){return p.call(this,a,c,d,b)||this}J(e,p);e.prototype.doLoad=function(){return L(this,void 0,void 0,function(){var a,c;return K(this,function(d){a=G.waterParameterDefaultsLocal;c=I({},a);this._updateMaterialParameters(c);c.isDraped=!0;this._drapedMaterial=new F.WaterMaterial(c,"waterDraped");this._context.stage.add(u.ModelContentType.MATERIAL,
this._drapedMaterial);this._updateMaterialParameters(a);this._material=new F.WaterMaterial(a,"water");this._context.stage.add(u.ModelContentType.MATERIAL,this._material);return[2]})})};e.prototype.destroy=function(){p.prototype.destroy.call(this);this._material&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id),this._material=null);this._drapedMaterial&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._drapedMaterial.id),this._drapedMaterial=null)};e.prototype.createGraphics3DGraphic=
function(a){a=a.graphic;var c=a.geometry.type;if("polyline"!==c&&"polygon"!==c&&"extent"!==c)return this.logger.warn("unsupported geometry type for water symbol: "+c),null;if(!this._validateGeometry(a.geometry))return null;var c="graphic"+a.uid,d=this.getGraphicElevationContext(a);return"on-the-ground"===d.mode?this._createAsOverlay(a,c):this._createAs3DShape(a,d,c,a.uid)};e.prototype.layerOpacityChanged=function(){var a=this._material.color,c=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});
this._material.color=[a[0],a[1],a[2],c];this._material.setTransparent(1>c||this._isPropertyDriven("opacity"));this._drapedMaterial.color=[a[0],a[1],a[2],c];this._drapedMaterial.setTransparent(1>c||this._isPropertyDriven("opacity"));return!0};e.prototype.layerElevationInfoChanged=function(a,c,d){var b=this._elevationContext.mode;if(null==d||null==b)return!1;if("on-the-ground"===d&&"on-the-ground"===b)return!0;if(d!==b&&("on-the-ground"===d||"on-the-ground"===b))return!1;var f=m.needsElevationUpdates2D(b);
return this.updateGraphics3DGraphicElevationInfo(a,c,function(){return f})};e.prototype.slicePlaneEnabledChanged=function(a,c){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._drapedMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};e.prototype.pixelRatioChanged=function(a,c){return!0};e.prototype.setDrawOrder=function(a,c,d){this.updateSymbolLayerOrder(a,c);this._material&&(this._material.renderPriority=a+c/2,d.add(this._material.id));
this._drapedMaterial&&(this._drapedMaterial.renderPriority=a+c/2,d.add(this._drapedMaterial.id))};e.prototype._createAs3DShape=function(a,c,d,e){a=this._getPolyGeometry(a);var f=this._getOutlineGeometry(a.rings);a=m.getGeometryVertexData3D(f,a.hasZ,a.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c);f=a.vertexData.length/3;a.uvCoords=new Float64Array(2*f);b.idHint=d;b.data=a;b.outNum=0;b.outGeometries=[];b.outTransforms=[];b.outMaterials=
[];this._create3DShapeGeometries(b);if(0===b.outNum)return null;this._createUVCoordsFromVertices(b.data.uvCoords,b.data.eleVertexData,f,this._context.elevationProvider.spatialReference);d=new Z({geometries:b.outGeometries,materials:b.outMaterials,transformations:b.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e},idHint:d});d=new V(this,d,b.outGeometries,null,null,T.perVertexElevationAligner,c);d.alignedTerrainElevation=a.terrainElevation;d.needsElevationUpdates=
m.needsElevationUpdates2D(c.mode);return d};e.prototype._createUVCoordsFromVertices=function(a,c,d,b){b=N.getMetersPerUnitForSR(b);A.empty(n);for(var f=0;f<d;f++)O.vec2.set(H,c[3*f+0],c[3*f+1]),A.expandPointInPlace(n,H);Q.vec4.scale(n,n,b);f=n[1]%e.unitSizeOfTexture;w[0]=n[0]-n[0]%e.unitSizeOfTexture;w[1]=n[1]-f;for(f=0;f<d;f++)a[2*f+0]=(c[3*f+0]*b-w[0])/e.unitSizeOfTexture,a[2*f+1]=(c[3*f+1]*b-w[1])/e.unitSizeOfTexture};e.prototype._create3DShapeGeometries=function(a){for(var c=a.data.geometryData.polygons,
b=a.data.eleVertexData,e=a.data.vertexData,f=a.data.uvCoords,k=function(d){var l=c[d];d=l.count;var q=l.index;if(g._context.clippingExtent&&(m.computeBoundingBox(b,q,d,r),m.boundingBoxClipped(r,g._context.clippingExtent)))return"continue";var h=new Float64Array(b.buffer,3*q*b.BYTES_PER_ELEMENT,3*d),k=new Float64Array(e.buffer,3*q*e.BYTES_PER_ELEMENT,3*d),ba=new Float64Array(f.buffer,2*q*f.BYTES_PER_ELEMENT,2*d),l=l.holeIndices.map(function(a){return a-q}),l=C(h,l,3);if(0===l.length)return"continue";
m.applyOrigin(e,q,d,x);d=g._createWaterGeometry(l,k,ba,h);d=new X(d,a.idHint);d.singleUse=!0;h=E.mat4f64.create();D.mat4.translate(h,h,x);a.outGeometries.push(d);a.outMaterials.push(g._material);a.outTransforms.push(h);a.outNum++},g=this,l=0;l<c.length;++l)k(l)};e.prototype._createWaterGeometry=function(a,c,b,e){for(var d=a.length,k=new Uint32Array(d),g=0;g<d;g++)k[g]=a[g];a={};d={};a[v.VertexAttrConstants.POSITION]=k;a[v.VertexAttrConstants.UV0]=k;d[v.VertexAttrConstants.POSITION]={size:3,data:c};
d[v.VertexAttrConstants.UV0]={size:2,data:b};e&&(d.mapPos={size:3,data:e},a.mapPos=k);return new Y(d,a)};e.prototype._updateMaterialParameters=function(a){var c=this.symbolLayer.color;B.isSome(c)&&(a.color=M.toUnitRGBA(c));c=this._getCombinedOpacity(c,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],c];a.transparent=1>c||this._isPropertyDriven("opacity");a.waveDirection=B.isSome(this.symbolLayer.waveDirection)?e.headingVectorFromAngle(this.symbolLayer.waveDirection):t.vec2f64.fromValues(0,
0);c=G.wavePresets[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=c.waveStrength;a.waveTextureRepeat=c.textureRepeat;a.waveVelocity=c.waveVelocity;a.flowStrength=c.perturbationStrength};e.prototype._createAsOverlay=function(a,c){var d=this._getPolyGeometry(a),e=d.rings,f=this._getOutlineGeometry(e);this._drapedMaterial.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;f=m.getGeometryVertexDataDraped(f,d.spatialReference,this._context.overlaySR);
b.idHint=c;b.data=f;c=f.vertexData.length/3;f.uvCoords=new Float64Array(2*c);b.outNum=0;b.outGeometries=[];b.outBoundingBox=z.empty();b.layerUid=this._context.layer.uid;b.graphicsUid=a.uid;this._createAsOverlayWater(b);if(0===b.outNum)return null;this._createUVCoordsFromVertices(b.data.uvCoords,b.data.vertexData,c,d.spatialReference);this._logGeometryCreationWarnings(b.data,e,"rings","WaterSymbol3DLayer");return 0<b.outNum?new U(this,b.outGeometries,b.outBoundingBox):null};e.prototype._createAsOverlayWater=
function(a){for(var c=a.data.vertexData,d=a.data.uvCoords,b=function(b){var f=b.count,g=b.index,k=new Float64Array(c.buffer,3*g*c.BYTES_PER_ELEMENT,3*f),h=new Float64Array(d.buffer,2*g*d.BYTES_PER_ELEMENT,2*f);b=b.holeIndices.map(function(a){return a-g});b=C(k,b,3);if(0===b.length)return"continue";m.computeBoundingBox(c,g,f,r);if(m.boundingBoxClipped(r,e._context.clippingExtent))return"continue";z.expand(a.outBoundingBox,r);m.applyOrigin(c,g,f,x);m.setZ(c,g,f,e._getDrapedZ());f=E.mat4f64.create();
D.mat4.translate(f,f,x);k=e._createWaterGeometry(b,k,h,null);h=new aa(k);h.data.layerUid=a.layerUid;h.data.graphicUid=a.graphicsUid;h.material=e._drapedMaterial;b=r;h.center=[.5*(b[0]+b[3]),.5*(b[1]+b[4]),0];h.bsRadius=.5*Math.sqrt((b[3]-b[0])*(b[3]-b[0])+(b[4]-b[1])*(b[4]-b[1]));h.transformation=f;h.name=a.idHint;h.uniqueName=a.idHint+"#"+k.id;a.outGeometries.push(h);a.outNum++},e=this,k=0,g=a.data.geometryData.polygons;k<g.length;k++)b(g[k])};e.prototype._getOutlineGeometry=function(a){return a};
e.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?S.fromExtent(a):a};e.headingVectorFromAngle=function(a){var b=t.vec2f64.create();a=R.toRadian(a);b[0]=Math.sin(a);b[1]=Math.cos(a);return b};e.unitSizeOfTexture=100;return e}(W.default);y.Graphics3DWaterSymbolLayer=p;var w=t.vec2f64.create(),n=A.create(),H=t.vec2f64.create(),r=z.create(),x=P.vec3f64.create(),b={idHint:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};y.default=
p});