// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Graphic ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ../../../layers/support/fieldUtils ./BuildingSublayerView3D ./I3SMeshView3D ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ../../layers/support/popupUtils".split(" "),
function(H,I,J,z,c,q,r,A,t,B,u,v,w,d,C,l,D,E,x,F,G,m){var e=B.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D"),y=G.defineFieldProperties();return function(f){function a(){var b=null!==f&&f.apply(this,arguments)||this;b.layerView=null;b._elevationContext="scene";b._isIntegratedMesh=!1;b.lodFactor=1;b.progressiveLoadFactor=1;return b}z(a,f);a.prototype.initialize=function(){var b=this;this._layerUid=this.layer.layer.uid;this.handles.add([w.init(this,["layer.renderer","definitionExpressionFields",
"filterExpressionFields"],function(){return b._updateRequiredFields()}),w.init(this.layer,"renderer",function(a){return b._rendererChange(a)}),this.watch(["parsedDefinitionExpression","parsedFilterExpression"],function(){return b._filterChange()})])};Object.defineProperty(a.prototype,"parsedFilterExpression",{get:function(){if("Overview"===this.layer.modelName||u.isNone(this.layerView.filterExpression))return null;var b;try{b=C.WhereClause.create(this.layerView.filterExpression,this.layer.fieldsIndex)}catch(g){return e.error("Failed to parse filterExpression: "+
g),null}if(!b.isStandardized)return e.error("filterExpression is using non standard function"),null;var a=[];x.findFieldsCaseInsensitive(b.fieldNames,this.layer.fields,{missingFields:a});return 0<a.length?(e.error("filterExpression references unknown fields: "+a.join(", ")),null):b},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"filterExpressionFields",{get:function(){return this.parsedFilterExpression?x.findFieldsCaseInsensitive(this.parsedFilterExpression.fieldNames,this.layer.fields):
null},enumerable:!0,configurable:!0});a.prototype._createLayerGraphic=function(b){b=new A(null,null,b);b.layer=this.layer.layer;b.sourceLayer=this.layer;return b};a.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};a.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)};a.prototype.fetchPopupFeatures=function(b,a){return r(this,void 0,void 0,function(){var b,d,c,n,e,f,h,p,k;return q(this,function(g){switch(g.label){case 0:if(b=
this._validateFetchPopupFeatures(a))return[2,v.reject(b)];if(!u.isSome(a)||!a.clientGraphics||0===a.clientGraphics.length)return[2,[]];d=[];c=[];e=l.unpackFieldNames;f=[this.layer.fields];return[4,m.getRequiredFields(this.layer,m.getFetchPopupTemplate(this.layer,a))];case 1:n=e.apply(void 0,f.concat([g.sent()]));h=0;for(p=a.clientGraphics;h<p.length;h++)k=p[h],l.featureHasFields(n,k)?d.push(k):c.push(k);return 0===c.length?[2,v.resolve(d)]:[2,this.whenGraphicAttributes(c,n).catch(function(){return c}).then(function(a){return d.concat(a)})]}})})};
a.prototype._updateRequiredFields=function(){return r(this,void 0,void 0,function(){var a,c,d,e;return q(this,function(b){switch(b.label){case 0:return c=l.fixFields,d=[this.layer.fields],this.layer.renderer?[4,this.layer.renderer.getRequiredFields(this.layer.fields)]:[3,2];case 1:return e=b.sent(),[3,3];case 2:e=[],b.label=3;case 3:return a=c.apply(void 0,d.concat([e.concat(this.definitionExpressionFields||[],this.filterExpressionFields||[])])),this._set("requiredFields",a),[2]}})})};a.prototype._validateFetchPopupFeatures=
function(a){var b=this.layer;if(!b.popupEnabled)return new t("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:b});if(!m.getFetchPopupTemplate(b,a))return new t("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:b})};a.prototype.getFilters=function(){var a=this.inherited(arguments);this.addSqlFilter(a,this.parsedFilterExpression,this.filterExpressionFields,this.logError);this.addSqlFilter(a,this.parsedDefinitionExpression,this.definitionExpressionFields,
this.logError);return a};c([d.property()],a.prototype,"layer",void 0);c([d.property()],a.prototype,"layerView",void 0);c([d.property({dependsOn:["_controller.updating"]})],a.prototype,"updating",void 0);c([d.property({dependsOn:["_controller.rootNodeVisible"]})],a.prototype,"suspended",void 0);c([d.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],a.prototype,"lodFactor",void 0);c([d.property({readOnly:!0,dependsOn:["layerView.filterExpression","layer.fieldsIndex"]})],
a.prototype,"parsedFilterExpression",null);c([d.property({type:[String],readOnly:!0,dependsOn:["parsedFilterExpression"]})],a.prototype,"filterExpressionFields",null);c([d.property(y.requiredFields)],a.prototype,"requiredFields",void 0);c([d.property(y.availableFields)],a.prototype,"availableFields",void 0);return a=c([d.subclass("esri.views.3d.layers.BuildingComponentSublayerView3D")],a)}(d.declared(D,E.I3SMeshView3D,F.DefinitionExpressionSceneLayerView))});