// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/assignHelper ../../../../core/compilerUtils ../../../../core/promiseUtils ../../../../core/string ../../../../core/urlUtils ../../../../core/Version ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/quat ../../../../core/libs/gl-matrix-2/quatf64 ./BinaryStreamReader ./fillDefaults ./pathUtils ../../support/buffer/BufferView ../../support/buffer/utils".split(" "),
function(A,B,k,n,S,G,C,D,H,E,t,w,I,J,F,x,K,f,y){function L(a){switch(a.componentType){case 5120:return new f.BufferViewVec2i8(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5121:return new f.BufferViewVec2u8(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5122:return new f.BufferViewVec2i16(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5123:return new f.BufferViewVec2u16(a.raw,a.byteOffset,a.byteStride,a.byteOffset+
a.byteStride*a.entryCount);case 5125:return new f.BufferViewVec2u32(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);case 5126:return new f.BufferViewVec2f(a.raw,a.byteOffset,a.byteStride,a.byteOffset+a.byteStride*a.entryCount);default:G.neverReached(a.componentType)}}function M(a){return k(this,void 0,void 0,function(){return n(this,function(c){return[2,C.create(function(c,b){var d=new Blob([a]),e=new FileReader;e.onload=function(){c(JSON.parse(e.result))};e.onerror=function(d){b(d)};
e.readAsText(d)})]})})}function N(a,c){return k(this,void 0,void 0,function(){return n(this,function(e){return[2,C.create(function(b,d){var e=new Blob([a],{type:c}),h=URL.createObjectURL(e),g=new Image;g.addEventListener("load",function(){URL.revokeObjectURL(h);b(g)});g.addEventListener("error",function(b){URL.revokeObjectURL(h);d(b)});g.src=h})]})})}Object.defineProperty(B,"__esModule",{value:!0});var q;A=function(){function a(c,e,b,d,a){this.context=c;this.errorContext=e;this.uri=b;this.json=d;
this.glbBuffer=a;this.bufferCache=new Map;this.textureCache=new Map;this.materialCache=new Map;this.nodeParentMap=new Map;this.nodeTransformCache=new Map;this.baseUri=K.splitURI(this.uri).dirPart;this.checkVersionSupported();this.checkRequiredExtensionsSupported();e.errorUnsupportedIf(null==d.scenes,"Scenes must be defined.");e.errorUnsupportedIf(null==d.meshes,"Meshes must be defined");e.errorUnsupportedIf(null==d.nodes,"Nodes must be defined.");this.computeNodeParents()}a.load=function(c,e,b,d){return k(this,
void 0,void 0,function(){var p,h,g,z,m,f;return n(this,function(l){switch(l.label){case 0:return D.endsWith(b,".gltf")?[4,c.loadJSON(b,d)]:[3,2];case 1:return p=l.sent(),[2,new a(c,e,b,p)];case 2:return D.endsWith(b,".glb")?[4,c.loadBinary(b,d)]:[3,5];case 3:return h=l.sent(),[4,a.parseGLB(e,h)];case 4:return g=l.sent(),[2,new a(c,e,b,g.json,g.binaryData)];case 5:return[4,c.loadBinary(b,d)];case 6:return z=l.sent(),m=new F.BinaryStreamReader(z),4<=m.remainingBytes()&&1179937895===m.readUint32()?[4,
a.parseGLB(e,z)]:[3,8];case 7:return g=l.sent(),[2,new a(c,e,b,g.json,g.binaryData)];case 8:return[4,c.loadJSON(b,d)];case 9:return f=l.sent(),[2,new a(c,e,b,f)]}})})};a.parseGLB=function(c,e){return k(this,void 0,void 0,function(){var b,d,a,h,g,f,m,r,l;return n(this,function(p){switch(p.label){case 0:b=new F.BinaryStreamReader(e),c.assert(12<=b.remainingBytes(),"GLB binary data is insufficiently large."),d=b.readUint32(),a=b.readUint32(),h=b.readUint32(),c.assert(1179937895===d,"Magic first 4 bytes do not fit to expected GLB value."),
c.assert(e.byteLength>=h,"GLB binary data is smalller than header specifies."),c.errorUnsupportedIf(2!==a,"Only GLB container version 2 is supported."),g=0,p.label=1;case 1:if(!(8<=b.remainingBytes()))return[3,5];r=b.readUint32();l=b.readUint32();if(0!==g)return[3,3];c.assert(1313821514===l,"First GLB chunck must be JSON.");c.assert(0<=r,"No JSON data found.");return[4,M(b.readUint8Array(r))];case 2:return f=p.sent(),[3,4];case 3:1===g?(c.errorUnsupportedIf(5130562!==l,"Second GLB chunck expected to be BIN."),
m=b.readUint8Array(r)):c.warnUnsupported("More than 2 GLB chunks detected. Skipping."),p.label=4;case 4:return g+=1,[3,1];case 5:return f||c.error("No GLB JSON chunk detected."),[2,{json:f,binaryData:m}]}})})};a.prototype.getBuffer=function(c,a){return k(this,void 0,void 0,function(){var b,d,e,h;return n(this,function(p){switch(p.label){case 0:return b=this.json.buffers[c],d=this.errorContext,null==b.uri?(d.assert(null!=this.glbBuffer,"GLB buffer not present"),[2,this.glbBuffer]):(e=this.bufferCache.get(c))?
[3,2]:[4,this.context.loadBinary(this.resolveUri(b.uri),a)];case 1:h=p.sent(),e=new Uint8Array(h),this.bufferCache.set(c,e),d.assert(e.byteLength===b.byteLength,"Buffer byte lengths should match."),p.label=2;case 2:return[2,e]}})})};a.prototype.getAccessor=function(c,a){return k(this,void 0,void 0,function(){var b,d,e,h,g,f,m,r;return n(this,function(p){switch(p.label){case 0:return b=this.json.accessors[c],d=this.errorContext,d.errorUnsupportedIf(null==b.bufferView,"An accessor bufferView is required."),
d.errorUnsupportedIf(b.type in["MAT2","MAT3","MAT4"],"AttributeType "+b.type+" is not supported"),e=this.json.bufferViews[b.bufferView],[4,this.getBuffer(e.buffer,a)];case 1:return h=p.sent(),g=O[b.type],f=P[b.componentType],m=g*f,r=e.byteStride||m,[2,{raw:h.buffer,byteStride:r,byteOffset:h.byteOffset+(e.byteOffset||0)+(b.byteOffset||0),entryCount:b.count,isDenselyPacked:r===m,componentCount:g,componentByteSize:f,componentType:b.componentType,min:b.min,max:b.max,normalized:!!b.normalized}]}})})};
a.prototype.getIndexData=function(c,e){return k(this,void 0,void 0,function(){var b;return n(this,function(d){switch(d.label){case 0:return null==c.indices?[2,null]:[4,this.getAccessor(c.indices,e)];case 1:b=d.sent();if(b.isDenselyPacked)switch(b.componentType){case 5121:return[2,new Uint8Array(b.raw,b.byteOffset,b.entryCount)];case 5123:return[2,new Uint16Array(b.raw,b.byteOffset,b.entryCount)];case 5125:return[2,new Uint32Array(b.raw,b.byteOffset,b.entryCount)]}else switch(b.componentType){case 5121:return[2,
y.scalar.makeDense(this.wrapAccessor(f.BufferViewUint8,b))];case 5123:return[2,y.scalar.makeDense(this.wrapAccessor(f.BufferViewUint16,b))];case 5125:return[2,y.scalar.makeDense(this.wrapAccessor(f.BufferViewUint32,b))]}return[2]}})})};a.prototype.getPositionData=function(c,e){return k(this,void 0,void 0,function(){var b,d;return n(this,function(a){switch(a.label){case 0:return b=this.errorContext,b.errorUnsupportedIf(null==c.attributes.POSITION,"POSITION vertex data is required."),[4,this.getAccessor(c.attributes.POSITION,
e)];case 1:return d=a.sent(),b.errorUnsupportedIf(5126!==d.componentType,"[POSITION attribute] Expected type FLOAT, found "+u[d.componentType]),b.errorUnsupportedIf(3!==d.componentCount,"POSITION attribute must have 3 components."),[2,this.wrapAccessor(f.BufferViewVec3f,d)]}})})};a.prototype.getNormalData=function(c,a){return k(this,void 0,void 0,function(){var b,d;return n(this,function(e){switch(e.label){case 0:return b=this.errorContext,b.errorUnsupportedIf(null==c.attributes.NORMAL,"NORMAL vertex data is required."),
[4,this.getAccessor(c.attributes.NORMAL,a)];case 1:return d=e.sent(),b.errorUnsupportedIf(5126!==d.componentType,"[NORMAL attribute] Expected type FLOAT, found "+u[d.componentType]),b.errorUnsupportedIf(3!==d.componentCount,"NORMAL attribute must have 3 components."),[2,this.wrapAccessor(f.BufferViewVec3f,d)]}})})};a.prototype.getTangentData=function(a,e){return k(this,void 0,void 0,function(){var b,d;return n(this,function(c){switch(c.label){case 0:return b=this.errorContext,b.errorUnsupportedIf(null==
a.attributes.TANGENT,"TANGENT vertex data is required."),[4,this.getAccessor(a.attributes.TANGENT,e)];case 1:return d=c.sent(),b.errorUnsupportedIf(5126!==d.componentType,"[TANGENT attribute] Expected type FLOAT, found "+u[d.componentType]),b.errorUnsupportedIf(4!==d.componentCount,"NORMAL attribute must have 4 components."),[2,new f.BufferViewVec4f(d.raw,d.byteOffset,d.byteStride,d.byteOffset+d.byteStride*d.entryCount)]}})})};a.prototype.getTextureCoordinates=function(a,e){return k(this,void 0,void 0,
function(){var b,d;return n(this,function(c){switch(c.label){case 0:return b=this.errorContext,b.errorUnsupportedIf(null==a.attributes.TEXCOORD_0,"TEXCOORD_0 vertex data is required."),[4,this.getAccessor(a.attributes.TEXCOORD_0,e)];case 1:d=c.sent();b.errorUnsupportedIf(2!==d.componentCount,"TEXCOORD_0 attribute must have 2 components.");if(5126===d.componentType)return[2,this.wrapAccessor(f.BufferViewVec2f,d)];b.errorUnsupportedIf(!d.normalized,"[TEXCOORD_0 attribute] Integer ComponentTypes are only supported for a normalized accessor.");
return[2,L(d)]}})})};a.prototype.hasNormals=function(a){return!!a.attributes.NORMAL};a.prototype.hasVertexColors=function(a){return!!a.attributes.COLOR_0};a.prototype.hasTextureCoordinates=function(a){return!!a.attributes.TEXCOORD_0};a.prototype.hasTangents=function(a){return!!a.attributes.TANGENT};a.prototype.getVertexColors=function(a,e){return k(this,void 0,void 0,function(){var b,d;return n(this,function(c){switch(c.label){case 0:return b=this.errorContext,b.errorUnsupportedIf(null==a.attributes.COLOR_0,
"COLOR_0 vertex data is required."),[4,this.getAccessor(a.attributes.COLOR_0,e)];case 1:d=c.sent();b.errorUnsupportedIf(4!==d.componentCount&&3!==d.componentCount,"COLOR_0 attribute must have 3 or 4 components.");if(4===d.componentCount){if(5126===d.componentType)return[2,this.wrapAccessor(f.BufferViewVec4f,d)];if(5121===d.componentType)return[2,this.wrapAccessor(f.BufferViewVec4u8,d)];if(5123===d.componentType)return[2,this.wrapAccessor(f.BufferViewVec4u16,d)]}else if(3===d.componentCount){if(5126===
d.componentType)return[2,this.wrapAccessor(f.BufferViewVec3f,d)];if(5121===d.componentType)return[2,this.wrapAccessor(f.BufferViewVec3u8,d)];if(5123===d.componentType)return[2,this.wrapAccessor(f.BufferViewVec3u16,d)]}b.errorUnsupported("[COLOR_0 attribute] Unsupported component type: "+u[d.componentType]);return[2]}})})};a.prototype.getMaterial=function(a,e){return k(this,void 0,void 0,function(){var b,d,c,h,f,k,m,r,l,q,t;return n(this,function(g){switch(g.label){case 0:b=this.errorContext;if(d=
this.materialCache.get(a.material))return[3,12];c=null!=a.material?x.material(this.json.materials[a.material]):x.material();h=c.pbrMetallicRoughness;f=this.hasVertexColors(a);k=void 0;if(!h.baseColorTexture)return[3,2];b.errorUnsupportedIf(0!==(h.baseColorTexture.texCoord||0),"Only TEXCOORD_0 is supported");return[4,this.getTexture(h.baseColorTexture.index,e)];case 1:k=g.sent(),g.label=2;case 2:m=void 0;if(!c.normalTexture)return[3,5];if(0===(c.normalTexture.texCoord||0))return[3,3];b.warnUnsupported("Only TEXCOORD_0 is supported for normal map");
return[3,5];case 3:return[4,this.getTexture(c.normalTexture.index,e)];case 4:m=g.sent(),g.label=5;case 5:r=void 0;if(!c.occlusionTexture)return[3,7];b.errorUnsupportedIf(0!==(c.occlusionTexture.texCoord||0),"Only TEXCOORD_0 is supported");return[4,this.getTexture(c.occlusionTexture.index,e)];case 6:r=g.sent(),g.label=7;case 7:l=void 0;if(!c.emissiveTexture)return[3,9];b.errorUnsupportedIf(0!==(c.emissiveTexture.texCoord||0),"Only TEXCOORD_0 is supported");return[4,this.getTexture(c.emissiveTexture.index,
e)];case 8:l=g.sent(),g.label=9;case 9:q=void 0;if(!h.metallicRoughnessTexture)return[3,11];b.errorUnsupportedIf(0!==(h.metallicRoughnessTexture.texCoord||0),"Only TEXCOORD_0 is supported");return[4,this.getTexture(h.metallicRoughnessTexture.index,e)];case 10:q=g.sent(),g.label=11;case 11:t=null!=a.material?a.material:-1,d={alphaMode:c.alphaMode,alphaCutoff:c.alphaCutoff,color:h.baseColorFactor,doubleSided:!!c.doubleSided,colorTexture:k,normalTexture:m,name:c.name,id:t,occlusionTexture:r,emissiveTexture:l,
emissiveFactor:c.emissiveFactor,metallicFactor:h.metallicFactor,roughnessFactor:h.roughnessFactor,metallicRoughnessTexture:q,vertexColors:f,ESRI_externalColorMixMode:c.extras.ESRI_externalColorMixMode},g.label=12;case 12:return[2,d]}})})};a.prototype.getTexture=function(a,e){return k(this,void 0,void 0,function(){var b,d,c,h,g,f,m,k;return n(this,function(l){switch(l.label){case 0:b=this.errorContext;d=this.json.textures[a];c=x.textureSampler(null!=d.sampler?this.json.samplers[d.sampler]:{});b.errorUnsupportedIf(null==
d.source,"source must be defined for a texture");h=this.json.images[d.source];if(g=this.textureCache.get(a))return[3,6];f=void 0;return h.uri?[4,this.context.loadImage(this.resolveUri(h.uri),e)]:[3,2];case 1:return f=l.sent(),[3,5];case 2:return b.errorUnsupportedIf(null==h.bufferView,"Image bufferView must be defined."),b.errorUnsupportedIf(null==h.mimeType,"Image mimeType must be defined."),m=this.json.bufferViews[h.bufferView],[4,this.getBuffer(m.buffer,e)];case 3:return k=l.sent(),b.errorUnsupportedIf(null!=
m.byteStride,"byteStride not supported for image buffer"),[4,N(new Uint8Array(k.buffer,k.byteOffset+(m.byteOffset||0),m.byteLength),h.mimeType)];case 4:f=l.sent(),l.label=5;case 5:g={data:f,wrapS:c.wrapS,wrapT:c.wrapT,minFilter:c.minFilter,name:h.name,id:a},this.textureCache.set(a,g),l.label=6;case 6:return[2,g]}})})};a.prototype.getNodeTransform=function(a){if(void 0===a)return Q;var c=this.nodeTransformCache.get(a);if(!c){var c=this.getNodeTransform(this.getNodeParent(a)),b=this.json.nodes[a];if(b.matrix)c=
t.mat4.multiply(w.mat4f64.create(),c,b.matrix);else if(b.translation||b.rotation||b.scale)c=w.mat4f64.clone(c),b.translation&&t.mat4.translate(c,c,b.translation),b.rotation&&(v[3]=I.quat.getAxisAngle(v,b.rotation),t.mat4.rotate(c,c,v[3],v)),b.scale&&t.mat4.scale(c,c,b.scale);this.nodeTransformCache.set(a,c)}return c};a.prototype.wrapAccessor=function(a,e){return new a(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*(e.entryCount-1)+e.componentByteSize*e.componentCount)};a.prototype.resolveUri=
function(a){return H.makeAbsolute(a,this.baseUri)};a.prototype.getNodeParent=function(a){return this.nodeParentMap.get(a)};a.prototype.checkVersionSupported=function(){E.Version.parse(this.json.asset.version,"glTF").validate(R)};a.prototype.checkRequiredExtensionsSupported=function(){var a=this.json,e=this.errorContext;a.extensionsRequired&&0!==a.extensionsRequired.length&&e.errorUnsupportedIf(!0,"Extensions: "+a.extensionsRequired.join(", "))};a.prototype.computeNodeParents=function(){var a=this;
this.json.nodes.forEach(function(c,b){c.children&&c.children.forEach(function(c){a.nodeParentMap.set(c,b)})})};return a}();B.Resource=A;var R=new E.Version(2,0,"glTF"),Q=t.mat4.fromXRotation(w.mat4f64.create(),Math.PI/2),v=J.quatf64.create(),O={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},P=(q={},q[5120]=1,q[5121]=1,q[5122]=2,q[5123]=2,q[5126]=4,q[5125]=4,q),u={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"}});