// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Color ../../../Graphic ../../../core/asyncUtils ../../../core/Collection ../../../core/Evented ../../../core/HandleOwner ../../../core/has ../../../core/iteratorUtils ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/requireUtils ../../../core/scheduling ../../../core/string ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/aaBoundingBox ../../../layers/graphics/controllers/I3SOnDemandController ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeUtils ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/edgeUtils ./support/layerViewUpdatingProperties ./support/symbolColorUtils ../support/mathUtils ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../webgl-engine/Stage ../webgl-engine/lib/Geometry ../webgl-engine/lib/Layer ../webgl-engine/lib/Object3D ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/TextureBackedBuffer/BufferManager ../webgl-engine/materials/component/index module".split(" "),
function(fa,Q,J,ga,l,ha,ia,ja,L,ka,la,A,ma,na,R,oa,pa,y,qa,F,ra,sa,ta,S,ua,q,va,m,T,wa,xa,D,ya,U,za,Aa,Ba,V,W,Ca,Da,Ea,k,Fa,M,Ga,Ha,G,X,Ia,N,Ja,Ka,La,Ma,Na,O,Y,B,Oa,Z,Pa){function aa(k){return y.isSome(k)&&S.isArrayBuffer(k.data)}function ba(k,b){for(var a=1024,c=0;c<k.length;c++)var d=k[c],a=a+(d.interleavedVertexData.byteLength+(d.indices?d.indices.byteLength:0)),a=a+(d.positionData.data.byteLength+d.positionData.indices.byteLength);if(y.isSome(b))for(k=0;k<b.length;k++)c=b[k],y.isSome(c)&&S.isArrayBuffer(c.data)&&
(a+=c.data.byteLength);return a}function ca(k,b){return 104857600<b.byteSize?(E.warn("Node is too big to store in IndexedDB cache: "+k.id+" ("+b.byteSize+" bytes)"),!1):0<b.byteSize}Object.defineProperty(Q,"__esModule",{value:!0});var x=Ka.ModelContentType,E=oa.getLogger("esri.views.3d.layers.SceneLayerView3D"),da=[1,1,1,1],Qa=[.8,.8,.8],Ra=function(){return function(){}}();A=function(A){function b(){var a=null!==A&&A.apply(this,arguments)||this;a._layerUid="";a._highlights=new Ca(a);a._elevationProvider=
null;a._worker=new V;a._workerThread=null;a._nodeId2Meta=new Map;a._addTasks=new Map;a._rendererVersion=0;a._rendererFields=null;a._colorVariable=null;a._opacityVariable=null;a._symbolInfos=new Map;a._idbCache=new Fa.IDBCache("esri-scenelayer-cache","geometries");a._cancelCount=0;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a._layerUrl="";a._cacheKeySuffix=null;a._tmpAttributeOnlyGraphic=new L(null,null,{});return a}ga(b,A);Object.defineProperty(b.prototype,"hasTexturesOrVertexColors",
{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rendererNeedsTextures",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var c=ua.getMetersPerVerticalUnitForSR(this.layer.spatialReference),
d=Ba.getMetersPerUnit(a.unit);return(a.offset||0)*d/c}return 0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"useCompressedTextures",{get:function(){var a=this.layer.version,a=!na("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.renderView.has("s3tc")&&
a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;va.open(ra.getAbsMid("./SceneLayerWorker",fa,Pa)).then(function(c){a.destroyed?c.close():a._workerThread=c});k.checkSceneLayerValid(this.layer);k.checkSceneLayerCompatibleWithView(this.layer,this.view);this._layerUid=this.layer.uid;this._layerUrl=this.layer.parsedUrl.path;
this._controller=new ya({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;if(this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var c=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(c&&c.faceRange&&c.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color);
this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(c){return a._deleteNodeStageData(c)});this._addThisLayerToStage();this._elevationProvider=new Da({layerView:this,stageLayer:this._stageLayer});this.handles.add([q.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),q.watch(this,"fullOpacity",function(c){return a._opacityChange(c)}),q.watch(this,"slicePlaneEnabled",
function(c){return a._slicePlaneEnabledChange(c)}),q.watch(this,"elevationOffset",function(c,e){return a._reloadAll(e)}),q.init(this,"filter",function(){return a._filterChange()}),q.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){a._reloadAll();a._memCache.clear()}),q.init(this,"suspended",function(c){return a._suspendedChange(c)})],"sceneLayerHandles");this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(function(a){return E.warn("Failed to initialize IndexedDB cache: "+
a)});this._componentColorManager=this._hasSymbolColors?new Oa.BufferManager(this._stage.renderView.renderingContext):null};b.prototype.destroy=function(){this.handles.remove("sceneLayerHandles");this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._memCache=null;this._removeThisLayerFromStage();this._stage=null;this._idbCache&&(this._idbCache.destroy(),this._idbCache=null);null!=this._controller&&(this._controller.destroy(),
this._controller=null);this._highlights.destroy();this._nodeId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};b.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};b.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=
a;this.texMemoryEstimate-=a};b.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};b.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};b.prototype.isNodeLoaded=function(a){return this._nodeId2Meta.has(a)};b.prototype.getUsedMemory=function(){var a=0;this._nodeId2Meta.forEach(function(c){return a+=c.node.memory});return a};b.prototype.getUnloadedMemory=
function(){return this._controller?this._controller.unloadedMemoryEstimate:0};b.prototype.ignoresMemoryFactor=function(){return!1};b.prototype._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)};b.prototype.getStats=function(){var a={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+
"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};this._controller&&(this._cachingEnabled()&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a};b.prototype._addThisLayerToStage=function(){for(var a=this._stage,c=new Uint8Array(256),d=0;d<c.length;d++)c[d]=255;c=""+this.layer.uid;this._stageLayer=c=new Ma(c,{},c);a.add(x.LAYER,c);this._stage.addToViewContent([c.id])};
b.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var a=this._stage;this._removeAllNodeDataFromStage();B.verify(0===this._nodeId2Meta.size);a.remove(x.LAYER,this._stageLayer.id);this._stageLayer=void 0;this.gpuMemoryEstimate=0}};b.prototype.getLoadedAttributes=function(a){if((a=this._nodeId2Meta.get(a))&&a.attributeInfo)return a.attributeInfo.loadedAttributes};b.prototype.getAttributeData=function(a){if((a=this._nodeId2Meta.get(a))&&a.attributeInfo)return a.attributeInfo.attributeData};
b.prototype.setAttributeData=function(a,c){if(a=this._nodeId2Meta.get(a))a.attributeInfo=c,a.cachedRendererVersion=this._getInvalidRendererVersion(),a.filteredIds=null,this._updateEngineObject(a)};b.prototype.getLoadedNodeIds=function(){var a=[];this._nodeId2Meta.forEach(function(c){return a.push(c.node.id)});return a.sort()};b.prototype.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach(function(c,d){return a.push(d)})};b.prototype._calcEngineMaterialTransparencyParams=function(a,c,d){if(this._isIntegratedMesh)return{forceTransparency:!1};
var e=this.fullOpacity,f=1-pa.clamp(B.fallbackIfUndefined(c.transparency,0),0,1);a=1>f||1>e||a&&ta.endsWith(a.channels,"a")||!0===c.useVertexColorAlpha||d;return{baseColorOpacity:f,layerOpacity:e,forceTransparency:!!a}};b.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0};b.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"};b.prototype._getMaterialParameters=
function(a,c,d){var e=c.params,f=B.fallbackIfUndefined(e.diffuse,Qa);"standard"!==c.type&&E.warn("Unknown material type '"+c.type+"', must be 'standard'");c=this._isIntegratedMesh;a=this._calcEngineMaterialTransparencyParams(a,e);return J({baseColor:f,baseColorTexture:d,doubleSidedShading:this._calcEngineMaterialDoubleSidedParams(e),cullFace:this._calcEngineMaterialCullFaceParams(e),writeStencil:c,receiveSSAO:!c,normals:c?"ground":"vertex"},a)};b.prototype._getGeometryParameters=function(a){return{textureCoordinates:a.hasTexture,
textureCoordinateRegions:a.hasTexture&&a.hasRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":a.hasNormals?"compressed":"screen-space"}};b.prototype._createTexture=function(a,c,d,e,f){if(null==c||y.isNone(e))return null;var b;a:{for(var h=0;h<e.length;h++){var n=e[h];if(y.isSome(n)&&n.i3sTexId===d){b=n;break a}}b=null}e=b.data;if(null==e)return null;var h="none"!==c.wrap[0]||"none"!==c.wrap[1],n="rgba"===c.channels,r=!0,H;b.encoding===k.DDS_ENCODING_STRING?
H=Y.DDS_ENCODING:r=X.isPowerOfTwo(e.width)&&X.isPowerOfTwo(e.height);f=((c=f||!0===c.atlas)?this._enableAtlasMipMaps:this._enableMipMaps)&&r;d=new Y(e,d,{mipmap:f,wrap:c||!h?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:c&&f&&this._disableAtlasAnisotropy,encoding:H,noUnpackFlip:!0,components:n?4:3});this._stage.add(x.TEXTURE,d);a.memory+=this.memEstimateTextureAdded(d);return d};b.prototype._getVertexBufferLayout=function(a,c,d){a=a.params.textureID||"none";return Ja.glLayout(Z.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters({hasTexture:"none"!==
a&&null!=c.textureDefinitions[a],hasNormals:null!=d.vertexAttributes.normal,hasRegions:null!=d.vertexAttributes.region})))};b.prototype._createEngineMaterial=function(a,c,d,e,b){var f=c.params.materialID,h=d.materialDefinitions[f];B.assert(void 0!==h,"geometry wants unknown material "+f);c=c.params.textureID||"none";var n;"none"!==c&&(null!=d.textureDefinitions&&null!=d.textureDefinitions[c]||E.warn("textureDefinitions missing in shared resource"),n=d.textureDefinitions[c]);d=h.params.vertexRegions;
a=null!=n?this._createTexture(a,n,c,e,d):null;e=this._getMaterialParameters(n,h,a&&a.id);b=this._getGeometryParameters({hasTexture:null!=n,hasRegions:b.some(function(a){return"region"===a.name}),hasNormals:b.some(function(a){return"normal"===a.name||"normalCompressed"===a.name})});f=Z.ComponentMaterial.create(e,b,f);f.metadata={i3sTex:n,i3sMatParams:h.params,engineTex:a};return f};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._findGraphicNodeAndIndex=
function(a){var c=M.attributeLookup(a.attributes,this._getObjectIdField()),d=null;R.everyMap(this._nodeId2Meta,function(a,b){b=a.featureIds.indexOf(c);if(-1===b)return!0;d={node:a.node,index:b};return!1});return d};b.prototype._getGraphicIndices=function(a,c){a=this._nodeId2Meta.get(a.index);if(!a)return[];for(var d=[],e=this._getObjectIdField(),b=0;b<c.length;b++){var g=M.attributeLookup(c[b].attributes,e),g=a.featureIds.indexOf(g);-1!==g&&d.push(g)}return d};b.prototype.whenGraphicBounds=function(a){a=
this._findGraphicNodeAndIndex(a);if(!a)return F.reject();var c=this._nodeId2Meta.get(a.node.index).engineObject;a=this._boundingBoxCornerPoints(a.index,c,new Float64Array(24));if(N.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return c=D.empty(),D.expandWithBuffer(c,a,0,8),F.resolve({boundingBox:c,screenSpaceObjects:[]})};b.prototype.whenGraphicAttributes=function(a,c){var d=this;return k.whenGraphicAttributes(this.layer,a,this._getObjectIdField(),c,function(a){for(var c=
new Map,e=[],b=0;b<a.length;b++){var n=a[b],r=d._findGraphicNodeAndIndex(n),k=c.get(r.node);k||(k={node:r.node,indices:[],graphics:[]},e.push(k));k.indices.push(r.index);k.graphics.push(n)}return e},{ignoreUnavailableFields:!0,populateObjectId:!0})};b.prototype.getGraphicFromStageObject=function(a,c){if(this._isIntegratedMesh)return null;var d=this._getMetadata(a);a=a.getComponentFromTriangleNr(0,c);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?this._createGraphic(a,d):null};b.prototype.hasStageObject=
function(a){var c=a.getMetadata();return(c=this._nodeId2Meta.get(c.nodeIndex))&&c.engineObject===a};b.prototype._getMetadata=function(a){a=a.getMetadata();return this._nodeId2Meta.get(a.nodeIndex)};b.prototype._getCacheKey=function(a){return this._layerUrl+"/v2/"+a.id+this._cacheKeySuffix};b.prototype._getMemCacheKey=function(a,c){void 0===c&&(c=this.elevationOffset);return a+"#"+c};b.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};
b.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=k.addWraparound(this._cancelCount,1)};b.prototype._handleCancelled=function(a){if(0<k.addWraparound(this._cancelCount,-a))throw F.createAbortError();};b.prototype.loadCachedGPUData=function(a){return this._memCache.pop(this._getMemCacheKey(a.index))};b.prototype.loadCachedNodeData=function(a,c){var d=this,e=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(a)).then(function(b){if(null==b)return null;
d._handleCancelled(e);if(b.nodeVersion!==a.version)return d._idbCache.remove(d._getCacheKey(a)),null;a.obb||(a.obb=Ia.clone(b.nodeObb),d._controller.updateVisibility(a.index));var f=function(a,c){for(var b=0;b<a.length;b++){if(y.isNone(c))return!0;var e=k.selectEncoding(a[b].encodings,d.useCompressedTextures),f=c[b];if(y.isNone(f)||null==f.data||e&&f.encoding!==e.encoding)return!0}return!1};return d.rendererNeedsTextures&&f(b.requiredTextures,b.textureData)?c(b.requiredTextures).then(function(c){b.textureData=
c;b.byteSize=ba(b.transformedGeometries,b.textureData);c.every(aa)&&ca(a,b)&&d._idbCache.initialized&&d._idbCache.put(d._getCacheKey(a),b).catch(function(c){return E.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+c)});d._handleCancelled(e);return b}):b}):F.resolve(null)};b.prototype.addNodeData=function(a,c){var d=this;if(0===c.allGeometryData.length||0===c.allGeometryData[0].geometries.length)return F.resolve();1!==c.allGeometryData.length&&console.warn("Node with",c.allGeometryData.length,
"geometries is unsupported");return this._addData(a,c.attributeDataInfo,function(){return d._transformNode(a,c).then(function(c){return d._controller.reschedule(a.index,c)}).then(function(b){a.obb||(a.obb=b.obb,d._controller.updateVisibility(a.index));c.allGeometryData[0].componentOffsets=b.componentOffsets;b.featureIds&&(c.allGeometryData[0].featureIds=Array.prototype.slice.call(b.featureIds));b={geometryData:c.allGeometryData[0],transformedGeometries:b.transformedGeometries,requiredTextures:c.requiredTextures,
textureData:c.textureData,sharedResource:c.sharedResource,nodeVersion:a.version,nodeObb:a.obb,byteSize:d._cachingEnabled()?ba(b.transformedGeometries,c.textureData):0};if(ca(a,b)&&d._idbCache.initialized){var e=y.isSome(b.textureData)?b.textureData.map(function(a){return aa(a)?a:null}):null;d._idbCache.put(d._getCacheKey(a),J({},b,{textureData:e})).catch(function(c){return E.warn("Failed to store node in IndexedDB cache: "+a.id+": "+c)})}return d._addCachedNodeData(a,b)})})};b.prototype._transformNode=
function(a,c){for(var d=this,b=c.allGeometryData[0].geometries,f=Array(b.length),g=0;g<b.length;++g)f[g]=this._getVertexBufferLayout(b[g],c.sharedResource,c.geometryIndex);var h={geometryBuffer:c.geometryBuffer,geometryData:c.allGeometryData[0],geometryIndex:c.geometryIndex,layouts:f,mbs:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),
vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",h,{transferList:[c.geometryBuffer]}):V.ensureDracoDecoder(h).then(function(){return d._controller.reschedule(a.index,h).then(function(a){return d._worker.transform(a)})})};b.prototype.addCachedGPUData=function(a,c,d){if(this._controller.isGeometryVisible(a)){this._nodeId2Meta.set(a.index,c);this.updateNodeStatus(a.index,d);c.engineObject.setHidden(c.engineObject.geometryRecords[0],
!1);a=0;for(d=c.engineObject.getGeometryRecords();a<d.length;a++)d[a].material.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled});this._updateEngineObject(c);this._highlights.objectCreated(c.engineObject)}else d=this._controller.indexDepth-a.level+1,this._memCache.put(this._getMemCacheKey(a.index),c,a.memory,d)};b.prototype.addCachedNodeData=function(a,c,d){var b=this;return this._addData(a,d,function(){return b._addCachedNodeData(a,c)})};b.prototype._addCachedNodeData=function(a,c){var d=
this;if(this.suspended||!this._controller.isGeometryVisible(a))return F.resolve();var b=c.geometryData,f=c.transformedGeometries,g=c.sharedResource;c=this.rendererNeedsTextures?c.textureData:null;var h={};h[x.OBJECT]={};h[x.GEOMETRY]={};h[x.MATERIAL]={};var n=0,k=!1;a.memory=0;var H=b.componentOffsets,z=b.geometries,b=b.featureIds,t=null,K=null;if(this._hasSymbolColors)for(var t=this._componentColorManager.getBuffer(b.length),K=new Uint16Array(b.length),p=0;p<b.length;p++)K[p]=t.acquireIndex();for(var p=
a.id+"|"+b[0],m=[],u=[],l=[],y=[],E=this.view,C,A=0;A<z.length;A++){var q=z[A],w=f[n++],D=this._createEngineMaterial(a,q,g,c,w.layout);C=w.corMatrices.globalTrafo;k=k||w.hasColors;w=new O(new Float32Array(w.interleavedVertexData),w.layout,w.positionData,H||O.DefaultOffsets,w.indices||O.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(w,K);var q=null!=q.transformation?T.mat4f64.clone(q.transformation):Sa,B=m.length,w=new La(w,p+(0<B?"_"+B:"")),B=E.renderSpatialReference;m.push(w);l.push(q);
y.push(D);q=Ea.createOrigin(a.mbs,this.elevationOffset,this._controller.crsIndex,B);u.push(q);a.memory+=this.memEstimateGeometryAdded(w.data);h[x.MATERIAL][D.id]=D;h[x.GEOMETRY][w.id]=w}var I=new Na({idHint:a.id,name:p,geometries:m,materials:y,transformations:l,origins:u,castShadow:!0,metadata:{nodeIndex:a.index,layerUid:this._layerUid}});I.objectTransformation=C;h[x.OBJECT][I.id]=I;var G=this._addTasks.get(a.index),v=new Ra;v.node=a;v.engineObject=I;v.featureIds=b;v.componentColorBuffer=t;v.componentIndices=
K;v.cachedRendererVersion=this._getInvalidRendererVersion();v.cachedSymbolInfos=[];v.attributeInfo=G.attributeInfo;!this._hasTextures&&a.resources.texture&&(this._hasTextures=!0);this._hasColors||(this._hasColors=k);this._hasData=!0;this.notifyChange("hasTexturesOrVertexColors");var J=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(v).then(function(){var c=d._stageLayer,b=d._stage,e=h[x.OBJECT],f;for(f in e)e.hasOwnProperty(f)&&c.addObject(e[f]);for(var g in h)if(h.hasOwnProperty(g)){var c=
h[g],k;for(k in c)c.hasOwnProperty(k)&&null==b.get(g,k)&&b.add(g,c[k])}d._nodeId2Meta.set(a.index,v);if(d.suspended)d._removeNodeStageData(a.index);else{v.attributeInfo=G.attributeInfo;v.cachedRendererVersion===d._rendererVersion&&J===d.slicePlaneEnabled||d._addOrUpdateEdgeRendering(v);d._setObjectSymbology(v);d._applyFiltersToNode(v)&&d._updateEdgeRendering(v);d.visibleGeometryChanged(I);d._highlights.objectCreated(I);b=0;for(g=v.engineObject.getGeometryRecords();b<g.length;b++)g[b].material.updateParameters({slicePlaneEnabled:d.slicePlaneEnabled});
d._markParentsAsHole(a.index)}})};b.prototype._addData=function(a,c,d){var b=this,f=this._addTasks.get(a.index);f?f.attributeInfo=c:(f=J({},F.createResolver(),{attributeInfo:c}),this._addTasks.set(a.index,f),d().then(f.resolve,f.reject).then(function(){return b._addTasks.delete(a.index)}).catch(function(c){b._addTasks.delete(a.index);throw c;}));return f.promise};b.prototype._markParentsAsHole=function(a){if(this._isIntegratedMesh){var c=this._controller;for(a=c.getParentIndex(a);a;a=c.getParentIndex(a))this.updateNodeStatus(a,
"hole")}};b.prototype._clippingAreaChanged=function(){var a=D.create();N.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};b.prototype._filterChange=function(){this._applyFilters(!1)};b.prototype._applyFilters=function(a){var c=this;this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(a){c._applyFiltersToNode(a)&&
(c._addOrUpdateEdgeRendering(a),c.visibleGeometryChanged(a.engineObject))})};b.prototype.getFilters=function(){var a=this,c=[];this._clippingArea&&c.push(function(c,b){return a._boundingboxFilter(c,b,a._clippingArea)});return c};b.prototype.addSqlFilter=function(a,c,d,b){var e=this;c&&d&&a.push(function(a,f){return e._sqlFilter(a,f,c,d,b)})};b.prototype._sqlFilter=function(a,c,d,b,f){var e={},h=this._createLayerGraphic(e),n=this.layer.objectIdField,r=c.featureIds,H=c.attributeInfo.attributeData;b.every(function(a){return null!=
H[a]||a===n})&&k.filterInPlace(a,r,function(a){e[n]=r[a];for(var c=0;c<b.length;c++){var g=b[c];g!==n&&(e[g]=k.getCachedAttributeValue(H[g],a))}try{return d.testFeature(h)}catch(p){return f(p),!1}})};b.prototype._boundingboxNodeTest=function(a,c){N.mbsToMbs(a.node.mbs,this._controller.crsIndex,ea,this.view.renderSpatialReference);return k.intersectBoundingBoxWithMbs(c,ea)};b.prototype._boundingboxFeatureTest=function(a,c,b){return D.intersects(b,a.engineObject.geometryRecords[0].geometry.getComponentAABB(c,
Ta))};b.prototype._boundingboxFilter=function(a,c,b){var d=this,f=this._boundingboxNodeTest(c,b);if(3!==f)if(0===f)a.length=0;else if(c.engineObject.geometryRecords[0].geometry.componentCount===c.featureIds.length){var g=k.getClipAABB(b,c.engineObject);k.filterInPlace(a,c.featureIds,function(a){return d._boundingboxFeatureTest(c,a,g)})}};b.prototype._addOrUpdateEdgeRendering=function(a,c){void 0===c&&(c=!0);if(!this._edgeView)return F.resolve();var b=a.engineObject,e=this._edgeView.hasObject(b),f=
this._extractObjectEdgeMaterials(a);a=f.perFeatureEdgeMaterials;var g={slicePlaneEnabled:this.slicePlaneEnabled};if(f.hasEdges)if(f=!b.isHidden(b.geometryRecords[0]),e)this._edgeView.updateAllComponentMaterials(b,a,g,c),this._edgeView.updateObjectVisibility(b,f);else{if(f)return ka.safeCast(this._edgeView.addObject(b,a,g,!1))}else e&&this._edgeView.removeObject(b);return F.resolve()};b.prototype._removeEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.engineObject)&&this._edgeView.removeObject(a.engineObject)};
b.prototype._applyFiltersToNode=function(a){var c=a.engineObject,b=c.areAllComponentsVisible();c.unhideAllComponents();if(0===this._filters.length)return!b;var e=a.featureIds;if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters;a=a.filteredIds;if(a===e)return!b;for(var b=c.getGeometryRecords()[0],f=0,g=0;g<e.length;g++){var h=e[g];f>=a.length||a[f]!==h?c.setComponentVisibility(b,g,!1):f++}return!0};b.prototype._computeFilteredIds=
function(a){for(var c=a.featureIds.slice(),b=0,e=this._filters;b<e.length;b++)(0,e[b])(c,a);return c.length===a.featureIds.length?a.featureIds:c};b.prototype._removeAllNodeDataFromStage=function(a){var c=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(b,e){return c._removeNodeStageData(e,a)})};b.prototype.removeNodeData=function(a,c){for(;0<a.length&&!c.done;){var b=a.pop();this._removeNodeStageData(b);c.madeProgress()}};b.prototype._removeNodeStageData=function(a,c){void 0===
c&&(c=this.elevationOffset);var b=this._nodeId2Meta.get(a);if(b){var e=b.engineObject;e.setHidden(e.geometryRecords[0],!0);this.visibleGeometryChanged(e);this._removeEdgeRendering(b);this._nodeId2Meta.delete(a);this._highlights.objectDeleted(e);e=this._controller.indexDepth-b.node.level+1;this._memCache.put(this._getMemCacheKey(a,c),b,b.node.memory,e)}};b.prototype._deleteNodeStageData=function(a){var c=this._stage,b=this._stageLayer,e=a.engineObject;this._edgeView&&this._edgeView.removeObject(e);
b.removeObject(e);for(var b=0,f=e.getGeometryRecords();b<f.length;b++){var g=f[b];this.memEstimateGeometryRemoved(g.geometry.data);c.remove(x.GEOMETRY,g.geometry.id);this._removeMaterial(g.material,c)}if(a.componentIndices){for(b=0;b<a.componentIndices.length;b++)a.componentColorBuffer.releaseIndex(a.componentIndices[b]);this._componentColorManager.garbageCollect()}c.remove(x.OBJECT,e.id)};b.prototype._removeMaterial=function(a,c){c.remove(x.MATERIAL,a.id);if(a=a.metadata.engineTex)this.memEstimateTextureRemoved(a),
c.remove(x.TEXTURE,a.id)};b.prototype.updateNodeStatus=function(a,c){if(a=this._nodeId2Meta.get(a)){c="hole"===c;var b=0;for(a=a.engineObject.getGeometryRecords();b<a.length;b++)a[b].material.updateParameters({polygonOffsetEnabled:c})}};b.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)};b.prototype._rendererChange=function(a){return ia(this,void 0,void 0,function(){var c,b,e,f,g,h,n,r;return ha(this,function(d){switch(d.label){case 0:this._currentRenderer=
a;this.notifyChange("rendererNeedsTextures");this._rendererVersion=k.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;if(!a)return[3,2];c=this;b=k.findFieldsCaseInsensitive;return[4,a.getRequiredFields(this.layer.fields)];case 1:c._rendererFields=b.apply(void 0,[d.sent(),this.layer.fields]),d.label=2;case 2:if(a&&"visualVariables"in a&&a.visualVariables)for(e=0,f=a.visualVariables;e<f.length;e++)g=f[e],"color"===g.type?this._colorVariable=
g:"opacity"===g.type?this._opacityVariable=g:E.warn("Unsupported visual variable type for 3D Object Scene Services: "+g.type);if(a)for(h=0,n=a.getSymbols();h<n.length;h++)r=n[h],"mesh-3d"!==r.type&&E.error("Symbols of type '"+r.type+"' are not supported for 3D Object Scene Services.");this._controller&&this._controller.requestUpdate();return[2]}})})};b.prototype._getSymbolInfos=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolInfos};
b.prototype._getSymbolColors=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolColors};b.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var c=a.featureIds?a.featureIds.length:1,b={},e=this._tmpAttributeOnlyGraphic;e.attributes=b;var f=this._currentRenderer,g=a.attributeInfo.attributeData,h=null!=a.featureIds?this.layer.objectIdField:null,
n=null!=g?this._rendererFields:null;null==a.cachedSymbolColors&&(a.cachedSymbolColors=new Uint8Array(4*a.featureIds.length));for(var r=a.cachedSymbolColors,m=!0,z=0;z<c;z++){null!=h&&(b[h]=a.featureIds[z]);if(null!=n)for(var t=0,l=n;t<l.length;t++){var p=l[t];g[p]&&(b[p]=k.getCachedAttributeValue(g[p],z))}l=f&&f.getSymbol(e,{arcadeUtils:za});t=null;l instanceof Aa&&(this._symbolInfos.has(l.id)||this._symbolInfos.set(l.id,k.getSymbolInfo(l)),t=this._symbolInfos.get(l.id));a.cachedSymbolInfos[z]=t;
var q=p=null,u=!0,l=!0;f&&"visualVariables"in f&&(this._colorVariable&&(u=U.getColor(this._colorVariable,e,{color:Ua}))&&(p=P,p[0]=u.r/255,p[1]=u.g/255,p[2]=u.b/255,this._opacityVariable||null===u.a||(q=u.a)),this._opacityVariable&&(q=U.getOpacity(this._opacityVariable,e)));t&&t.material?(u=t.material,p=null==p||null==q?W.overrideColor(p,q,u.color,u.alpha,da,P):W.overrideColor(p,q,null,null,da,P),G.encodeSymbolColor(p,u.colorMixMode,r,4*z),u=t.castShadows):(G.encodeSymbolColor(null,null,r,4*z),u=
!0);if(0<z&&m){for(t=4*(z-1);t<4*z;t++)r[t]!==r[t+4]&&(m=!1);u!==l&&(m=!1)}l=u}a.uniformSymbolColor=m}};b.prototype._extractObjectEdgeMaterials=function(a){var c=[],b=a.engineObject,e=a.featureIds?a.featureIds.length:1,f={opacity:this.fullOpacity},g=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),h=!1,k=null,r=null;a=this._getSymbolInfos(a);for(var l=0;l<e;l++){var m=a[l];b.getComponentVisibility(b.getGeometryRecords()[0],l)&&m?(r!==m&&(r=m,(k=Ga.createMaterialFromEdges(this._edgeView,
m.edges,f))&&(h=!0)),c.push(y.isSome(k)?k:g)):c.push(g)}return{hasEdges:h,perFeatureEdgeMaterials:c}};b.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors){var c=a.featureIds?a.featureIds.length:1,b=this._getSymbolColors(a);if(a.uniformSymbolColor){var e=G.decodeSymbolColor(b,0),f=e.color,e=e.colorMixMode,b=!0;a.cachedSymbolInfos[0]&&(b=a.cachedSymbolInfos[0].castShadows);for(var g=0,h=a.engineObject.getGeometryRecords();g<h.length;g++)c=h[g],c=c.material,c.updateParameters({componentData:{castShadows:b,
externalColor:f,externalColorMixMode:e}});this._updateObjectOpacity(a.engineObject,1>f[3])}else{f=a.componentColorBuffer.textureBuffer;e=!0;for(g=0;g<c;g++){var h=4*g,k=a.componentIndices[g],l=1;a.cachedSymbolInfos[g]&&(l=!0===a.cachedSymbolInfos[g].castShadows?1:0);f.setData(k,0,b[h],b[h+1],b[h+2]&254|l,b[h+3]);e=e&&G.isOpaqueSymbolColor(b,h)}b=0;for(g=a.engineObject.getGeometryRecords();b<g.length;b++)c=g[b],c=c.material,c.updateParameters({componentData:f});this._updateObjectOpacity(a.engineObject,
!e);this._stage.renderView.setNeedsRender()}}};b.prototype._setComponentIndices=function(a,c){for(var b=a.getAttribute(B.VertexAttrConstants.COMPONENTINDEX),e=b.data,f=b.offsetIdx,b=b.strideIdx,g=a.getIndices(B.VertexAttrConstants.COMPONENTINDEX),h=0;h<c.length;h++)for(var k=a.componentOffsets[h+1],l=a.componentOffsets[h];l<k;l++)e[f+g[l]*b]=c[h]};b.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};
b.prototype._opacityChange=function(a){var c=this;this._nodeId2Meta.forEach(function(a){c._updateObjectOpacity(a.engineObject);c._updateEdgeRendering(a)})};b.prototype._updateObjectOpacity=function(a,c){var b=0;for(a=a.getGeometryRecords();b<a.length;b++){var e=a[b].material,f=e.metadata;void 0!==c&&(f.symbolIsTransparent=c);f=this._calcEngineMaterialTransparencyParams(f.i3sTex,f.i3sMatParams,f.symbolIsTransparent);e.updateParameters(f)}};b.prototype._updateEngineObject=function(a){this._setObjectSymbology(a);
this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this.visibleGeometryChanged(a.engineObject)};b.prototype._slicePlaneEnabledChange=function(a){var b=this,d={slicePlaneEnabled:a};this._stageLayer.isSliceable=a;this._nodeId2Meta.forEach(function(a){for(var c=0,e=a.engineObject.getGeometryRecords();c<e.length;c++)e[c].material.updateParameters(d);b._updateEdgeRendering(a,!1)})};b.prototype._updateEdgeRendering=function(a,b){void 0===b&&(b=!0);this._edgeView&&this._edgeView.hasObject(a.engineObject)&&
this._addOrUpdateEdgeRendering(a,b)};b.prototype._forAllFeatures=function(a,b,d){var c=this;void 0===d&&(d=0);R.everyMap(this._nodeId2Meta,function(e,g){if(y.isSome(b))switch(b(e)){case 0:return!1;case 2:return!0}return 0!==c._forAllFeaturesOfNode(e,a,d)})};b.prototype._forAllFeaturesOfNode=function(a,b,d){void 0===d&&(d=0);var c=a.featureIds,f=a.engineObject.geometryRecords[0],g=2===d&&this._clippingArea?k.getClipAABB(this._clippingArea,a.engineObject):null,h=g?this._boundingboxNodeTest(a,this._clippingArea):
3;if(0===h)return 1;for(var l=0;l<c.length;l++)if(a.engineObject.getComponentVisibility(f,l)||1===d||2===d&&(3===h||this._boundingboxFeatureTest(a,l,g))){var m=b(c[l],l,a,f);switch(m){case 0:return m}}return 1};b.prototype._createGraphic=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=b.attributeInfo.attributeData;if(null!=b)for(var e=0,f=Object.keys(b);e<f.length;e++){var g=f[e];c[g]=k.getCachedAttributeValue(b[g],a)}return this._createLayerGraphic(c)};
b.prototype._boundingBoxCornerPoints=function(a,b,d){a=b.geometries[0].getComponentAABB(a,Va);for(var c=0;8>c;++c)C[0]=c&1?a[0]:a[3],C[1]=c&2?a[1]:a[4],C[2]=c&4?a[2]:a[5],wa.vec3.transformMat4(C,C,b.objectTransformation),d[3*c]=C[0],d[3*c+1]=C[1],d[3*c+2]=C[2];return d};b.prototype.highlight=function(a,b){var c=this;void 0===b&&(b={});var e=this._highlights;"number"===typeof a?a=[a]:a instanceof L?a=[a]:a instanceof la&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof L){a=a.map(function(a){return M.attributeLookup(a.attributes,
c._getObjectIdField())});var f=e.acquireSet(b);b=f.set;f=f.handle;e.setFeatureIds(b,a);return f}if("number"===typeof a[0])return f=e.acquireSet(b),b=f.set,f=f.handle,e.setFeatureIds(b,a),f}return Wa};b.prototype.visibleGeometryChanged=function(a){var b=this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=sa.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=
null}))};b.prototype.test=function(){var a=this;return{controller:this._controller,get visibleObjectIds(){var b=[];a._forAllFeatures(function(a,c,f,g){f.engineObject.isHidden(g)||f.engineObject.areAllComponentsHidden()||!f.engineObject.getComponentVisibility(g,c)||b.push(a);return 1});b.sort(function(a,b){return a-b});return b},get numNodes(){return a._nodeId2Meta.size}}};l([m.property()],b.prototype,"view",void 0);l([m.property()],b.prototype,"layer",void 0);l([m.property()],b.prototype,"_controller",
void 0);l([m.property({dependsOn:["_controller.updating"]})],b.prototype,"updating",void 0);l([m.property({dependsOn:["_controller.rootNodeVisible"]})],b.prototype,"suspended",void 0);l([m.property(Ha.updatingPercentage)],b.prototype,"updatingPercentage",void 0);l([m.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],b.prototype,"updatingPercentageValue",void 0);l([m.property({readOnly:!0})],b.prototype,"hasTexturesOrVertexColors",null);l([m.property({readOnly:!0})],b.prototype,"rendererNeedsTextures",
null);l([m.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],b.prototype,"elevationOffset",null);l([m.property({type:Boolean})],b.prototype,"slicePlaneEnabled",void 0);l([m.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],b.prototype,"uncompressedTextureDownsamplingEnabled",null);l([m.property({dependsOn:["layer.version"]})],b.prototype,"useCompressedTextures",null);return b=l([m.subclass("esri.views.3d.layers.I3SMeshView3D")],
b)}(m.declared(ma,A,qa));Q.I3SMeshView3D=A;var Sa=T.mat4f64.create(),C=xa.vec3f64.create(),Va=D.create(),Ta=D.create(),P=[0,0,0,0],Ua=new ja([0,0,0,0]),ea=[0,0,0,0],Wa={remove:function(){},pause:function(){},resume:function(){}}});