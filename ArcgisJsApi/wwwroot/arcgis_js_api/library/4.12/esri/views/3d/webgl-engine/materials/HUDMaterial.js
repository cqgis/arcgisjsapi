// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/types/mat4 ../../../../geometry/support/aaBoundingRect ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/GLMaterialTexture ../lib/Material ../lib/screenSizePerspectiveUtils ../lib/Util ./internal/bufferWriters ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/HUDPrograms ../../../webgl/renderState".split(" "),
function(P,ua,J,ca,Q,da,R,S,T,U,h,B,ea,fa,ga,ha,V,ia,F,e,y,k,ja,K,r){function L(c,a,b){c.setUniform1f("cameraGroundRelative",b.cameraAboveGround?1:-1);c.setUniform1f("polygonOffset",a.shaderPolygonOffset);c.setUniform4fv("viewport",b.viewport);c.setUniform1f("perDistancePixelRatio",Math.tan(b.fovY/2)/(b.viewport[2]/2));k.bindVerticalOffset(a.verticalOffset,b,c);c.setUniformMatrix4fv("viewNormal",b.viewInvTransp);a.screenSizePerspective&&(k.bindScreenSizePerspective(a.screenSizePerspective,c,"screenSizePerspective"),
k.bindScreenSizePerspective(a.screenSizePerspectiveAlignment||a.screenSizePerspective,c,"screenSizePerspectiveAlignment"))}function W(c,a,b,f){b.occlusionTest&&(a.setUniform1i("hudVisibilityTexture",1),c.bindTexture(f.hudVisibilityTexture,1),c.setActiveTexture(0));a.setUniform1f("uRenderTransparentlyOccludedHUD","occluded"===f.renderTransparentlyOccludedHUD?1:"notOccluded"===f.renderTransparentlyOccludedHUD?0:.75);c=f.pixelRatio||1;a.setUniform4fv("overrideColor",b.color);a.setUniform1f("pixelRatio",
c);b.textureIsSignedDistanceField&&(a.setUniform4fv("outlineColor",b.outlineColor),a.setUniform1f("outlineSize",b.outlineSize));b.vvSizeEnabled&&(a.setUniform3fv("vvSizeMinSize",b.vvSizeMinSize),a.setUniform3fv("vvSizeMaxSize",b.vvSizeMaxSize),a.setUniform3fv("vvSizeOffset",b.vvSizeOffset),a.setUniform3fv("vvSizeFactor",b.vvSizeFactor));b.vvColorEnabled&&(a.setUniform1fv("vvColorValues",b.vvColorValues),a.setUniform4fv("vvColorColors",b.vvColorColors));a.setUniform2f("screenOffset",2*b.screenOffset[0]*
c,2*b.screenOffset[1]*c);a.setUniform2fv("anchorPos",G(b))}function G(c,a){void 0===a&&(a=X);if(c.textureIsSignedDistanceField){var b=c.anchorPos;c=c.distanceFieldBoundingBox;var f=a;f[0]=b[0]*(c[2]-c[0])+c[0];f[1]=b[1]*(c[3]-c[1])+c[1]}else T.vec2.copy(a,c.anchorPos);return a}P=function(c){function a(b,a){a=c.call(this,a)||this;a.params=k.copyParameters(b,ka);return a}J(a,c);a.prototype.dispose=function(){};a.prototype.setParameterValues=function(b){for(var a in b)"textureId"===a&&e.assert(!!this.params.textureId,
"Can only change texture of material that already has a texture"),this.params[a]=b[a];this.notifyDirty("matChanged")};a.prototype.getParameters=function(){return this.params};a.prototype.intersect=function(b,a,d,t,l,c,e,g,la){la?this.intersectDrapedRenderHudGeometry(b,a,d,t,l,c,e,g):this.intersectHudGeometry(b,a,d,t,l,c,e,g)};a.prototype.intersectDrapedRenderHudGeometry=function(b,a,d,t,l,c,z,g){a=b.getAttribute(e.VertexAttrConstants.POSITION);d=b.getAttribute(e.VertexAttrConstants.SIZE);t=this.params;
l=G(t);var f=1,p=1;g&&(p=g(M),f=p[0],p=p[5]);f*=b.pixelRatio;p*=b.pixelRatio;g=ma*b.pixelRatio;for(var H=0;H<a.data.length/a.size;H++){var q=H*a.size;h.vec3.set(n,a.data[q],a.data[q+1],a.data[q+2]);q=H*d.size;u[0]=d.data[q]*f;u[1]=d.data[q+1]*p;var q=n[0],k=n[1],v=void 0;t.textureIsSignedDistanceField&&(v=t.outlineSize*b.pixelRatio/2);this._isInsideIconBoundaries(c,q,k,g,v,t,l)&&z()}};a.prototype.intersectHudGeometry=function(b,a,d,t,l,c,z,g){if(t.enable.selectionMode&&t.enable.hud&&!ha.isAllHidden(a.componentVisibilities,
b.componentOffsets)){var f=b.data;b=this.params;l=a=1;Q.mat3.fromMat4(I,d);if(g){l=g(M);a=l[0];l=l[5];g=I;c=g[0];var p=g[1],k=g[2],q=g[3],r=g[4],D=g[5],x=g[6],m=g[7],w=g[8],A=1/Math.sqrt(c*c+p*p+k*k),E=1/Math.sqrt(q*q+r*r+D*D),y=1/Math.sqrt(x*x+m*m+w*w);g[0]=c*A;g[1]=p*A;g[2]=k*A;g[3]=q*E;g[4]=r*E;g[5]=D*E;g[6]=x*y;g[7]=m*y;g[8]=w*y}g=f.getVertexAttr()[e.VertexAttrConstants.POSITION];c=f.getVertexAttr()[e.VertexAttrConstants.SIZE];p=f.getVertexAttr()[e.VertexAttrConstants.NORMAL];f=f.getVertexAttr()[e.VertexAttrConstants.AUXPOS1];
e.assert(3<=g.size);k=t.point;q=t.camera;r=G(b);a*=q.pixelRatio;l*=q.pixelRatio;D="screen"===this.params.centerOffsetUnits;for(x=0;x<g.data.length/g.size;x++)m=x*g.size,h.vec3.set(n,g.data[m],g.data[m+1],g.data[m+2]),h.vec3.transformMat4(n,n,d),m=x*c.size,u[0]=c.data[m]*a,u[1]=c.data[m+1]*l,h.vec3.transformMat4(n,n,q.viewMatrix),m=x*f.size,h.vec3.set(v,f.data[m+0],f.data[m+1],f.data[m+2]),D||(n[0]+=v[0],n[1]+=v[1],0!==v[2]&&(m=v[2],h.vec3.normalize(v,n),h.vec3.subtract(n,n,h.vec3.scale(v,v,m)))),
m=x*p.size,h.vec3.set(Y,p.data[m],p.data[m+1],p.data[m+2]),this.applyVerticalOffsetTransformation(n,Y,I,q,N),q.applyProjection(n,C),-1<C[0]&&(m=Math.floor(C[0])+this.params.screenOffset[0],w=Math.floor(C[1])+this.params.screenOffset[1],D&&(m+=v[0],0!==v[1]&&(w+=F.applyScaleFactor(v[1],N.factorAlignment))),F.applyPrecomputedScaleFactorVec2(u,N.factor,u),A=na*q.pixelRatio,E=void 0,b.textureIsSignedDistanceField&&(E=b.outlineSize*q.pixelRatio/2),this._isInsideIconBoundaries(k,m,w,A,E,b,r)&&(w=t.ray,
h.vec3.transformMat4(Z,n,R.mat4.invert(oa,q.viewMatrix)),C[0]=k[0],C[1]=k[1],q.unprojectPoint(C,n),m=B.vec3f64.create(),h.vec3.copy(m,w.direction),A=1/h.vec3.length(m),h.vec3.scale(m,m,A),w=h.vec3.distance(w.origin,n)*A,z(w,m,-1,1,!0,Z)))}};a.prototype._isInsideIconBoundaries=function(b,a,d,c,l,e,z){a=a-c-(0<z[0]?u[0]*z[0]:0);var f=a+u[0]+2*c;d=d-c-(0<z[1]?u[1]*z[1]:0);c=d+u[1]+2*c;e.textureIsSignedDistanceField&&(e=e.distanceFieldBoundingBox,a+=u[0]*e[0],d+=u[1]*e[1],f-=u[0]*(1-e[2]),c-=u[1]*(1-
e[3]),a-=l,f+=l,d-=l,c+=l);return b[0]>a&&b[0]<f&&b[1]>d&&b[1]<c};a.prototype.createBufferWriter=function(){return new pa(this)};a.prototype.createRenderer=function(b,a){return new ja(b,a,this)};a.prototype.normalAndViewAngle=function(b,a,d,c){void 0===c&&(c=O);h.vec3.transformMat3(c.normal,b,a);h.vec3.transformMat4(c.normal,c.normal,d.viewInverseTransposeMatrix);c.cosAngle=h.vec3.dot(aa,qa);return c};a.prototype.updateScaleInfo=function(b,a,d){a=this.params;a.screenSizePerspective?b.factor=F.precomputeScaleFactor(O.cosAngle,
d,a.screenSizePerspective,b.factor):(b.factor.scale=1,b.factor.factor=0,b.factor.minPixelSize=0,b.factor.paddingPixels=0);a.screenSizePerspectiveAlignment?b.factorAlignment=F.precomputeScaleFactor(O.cosAngle,d,a.screenSizePerspectiveAlignment,b.factorAlignment):(b.factorAlignment.factor=b.factor.factor,b.factorAlignment.scale=b.factor.scale,b.factorAlignment.minPixelSize=b.factor.minPixelSize,b.factorAlignment.paddingPixels=b.factor.paddingPixels)};a.prototype.applyVerticalOffsetTransformation=function(b,
a,d,c,l,e){var f=this.params;ea.isMat4(d)&&(d=Q.mat3.fromMat4(I,d));if(!f.verticalOffset||!f.verticalOffset.screenLength)return l&&(f.screenSizePerspective||f.screenSizePerspectiveAlignment)?(c=this.normalAndViewAngle(a,d,c),f=h.vec3.length(b),this.updateScaleInfo(l,c.cosAngle,f)):l&&(l.factor.scale=1,l.factorAlignment.scale=1),e?h.vec3.copy(e,b):b;a=this.normalAndViewAngle(a,d,c);d=h.vec3.length(b);c=k.verticalOffsetAtDistance(c,d,f.verticalOffset,a.cosAngle,f.screenSizePerspectiveAlignment||f.screenSizePerspective);
l&&this.updateScaleInfo(l,a.cosAngle,d);return h.vec3.add(e||b,b,h.vec3.scale(a.normal,a.normal,c))};a.prototype.getGLMaterials=function(){return{color:ra,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:sa}};a.prototype.calculateRelativeScreenBounds=function(b,a,c){void 0===c&&(c=fa.create());var f=this.params,d=c;void 0===d&&(d=X);T.vec2.copy(d,f.anchorPos);d[0]*=-b[0];d[1]*=-b[1];d[0]+=f.screenOffset[0]*a;d[1]+=f.screenOffset[1]*a;c[2]=c[0]+b[0];c[3]=c[1]+b[1];return c};a.prototype.calculateAnchorPosForRendering=
function(b){return G(this.params,b)};a.shouldRenderVisibilityDuringRenderPass=function(b){return 0===b||4};return a}(ia);var ra=function(c){function a(b,a,d){b=c.call(this,b,a,d,b.getParameters().textureId)||this;b.isOcclusionSlot=!1;b.updateParameters();return b}J(a,c);a.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?17:16};a.prototype.selectProgram=function(){var b=this.params;this.occlusionProgram=this.programRep.getProgram(K.occlusionPass,{verticalOffset:!!b.verticalOffset,
screenSizePerspective:!!b.screenSizePerspective,centerOffsetUnitsScreen:"screen"===b.centerOffsetUnits,slice:b.slicePlaneEnabled});this.renderProgram=this.programRep.getProgram(K.colorPass,{occlTest:b.occlusionTest,sdf:b.textureIsSignedDistanceField,vvSize:!!b.vvSizeEnabled,vvColor:!!b.vvColorEnabled,verticalOffset:!!b.verticalOffset,screenSizePerspective:!!b.screenSizePerspective,centerOffsetUnitsScreen:"screen"===b.centerOffsetUnits,debugDrawBorder:!!b.debugDrawBorder,slice:b.slicePlaneEnabled});
this.renderPipelineState=r.makePipelineState({blending:r.simpleBlendingParams(1,771),polygonOffset:b.polygonOffset&&ba,depthTest:{func:515},depthWrite:r.defaultDepthWriteParams,colorWrite:r.defaultColorWriteParams});this.occlusionPipelineState=r.makePipelineState({depthTest:{func:515},depthWrite:r.defaultDepthWriteParams,colorWrite:r.defaultColorWriteParams})};a.prototype.beginSlot=function(b){if(this.params.occlusionTest)return this.isOcclusionSlot=11===b,11===b||b===this.mainSlot;this.isOcclusionSlot=
!1;return b===this.mainSlot};a.prototype.getProgram=function(){return this.isOcclusionSlot?this.occlusionProgram:this.renderProgram};a.prototype.getPrograms=function(){return[this.occlusionProgram,this.renderProgram]};a.prototype.updateParameters=function(){this.params=k.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);this.selectProgram();this.selectSlot()};a.prototype.bind=function(b,a){if(this.isOcclusionSlot){var c=this.occlusionProgram;b.bindProgram(c);
b.setPipelineState(this.occlusionPipelineState);L(c,this.params,a);c.setUniform4f("color",1,1,1,1);c.setUniform1f("pixelRatio",a.pixelRatio||1)}else c=this.renderProgram,b.bindProgram(c),b.setPipelineState(this.renderPipelineState),this.bindTexture(b,c),this.bindTextureScale(b,c),L(c,this.params,a),W(b,c,this.params,a)};a.prototype.bindView=function(b,a){b=a.origin;var c=this.getProgram();k.bindView(b,a.view,c);k.bindCamPos(b,a.viewInvTransp,c);this.params.slicePlaneEnabled&&k.bindSlicePlane(a.origin,
a.slicePlane,c)};a.prototype.bindInstance=function(b,a){b=this.getProgram();b.setUniformMatrix4fv("model",a.transformation);b.setUniformMatrix4fv("modelNormal",a.transformationNormal)};a.prototype.release=function(b){};a.prototype.getDrawMode=function(){return this.isOcclusionSlot?0:4};return a}(V),sa=function(c){function a(b,a,d){b=c.call(this,b,a,d,b.getParameters().textureId)||this;b.updateParameters();return b}J(a,c);a.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?
17:16};a.prototype.beginSlot=function(b){return b===this.mainSlot};a.prototype.getProgram=function(){return this.program};a.prototype.updateParameters=function(){this.params=k.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);this.selectProgram();this.selectSlot()};a.prototype.selectProgram=function(){var b=this.params;this.program=this.programRep.getProgram(K.highlightPass,{occlTest:b.occlusionTest,sdf:b.textureIsSignedDistanceField,vvSize:!!b.vvSizeEnabled,
vvColor:!!b.vvColorEnabled,verticalOffset:!!b.verticalOffset,screenSizePerspective:!!b.screenSizePerspective,centerOffsetUnitsScreen:"screen"===b.centerOffsetUnits,binaryHighlightOcclusion:b.binaryHighlightOcclusion,slice:b.slicePlaneEnabled});this.pipelineState=r.makePipelineState({blending:r.separateBlendingParams(1,1,771,771),polygonOffset:b.polygonOffset&&ba,depthTest:{func:513},colorWrite:r.defaultColorWriteParams})};a.prototype.bind=function(b,a){var c=this.program;b.bindProgram(c);b.setPipelineState(this.pipelineState);
this.bindTexture(b,c);this.bindTextureScale(b,c);L(c,this.params,a);W(b,c,this.params,a);k.bindHighlightRendering(b,a,this.program)};a.prototype.bindView=function(a,c){a=c.origin;var b=this.getProgram();k.bindView(a,c.view,b);k.bindCamPos(a,c.viewInvTransp,b);this.params.slicePlaneEnabled&&k.bindSlicePlane(c.origin,c.slicePlane,b)};a.prototype.bindInstance=function(a,c){a=this.getProgram();a.setUniformMatrix4fv("model",c.transformation);a.setUniformMatrix4fv("modelNormal",c.transformationNormal)};
a.prototype.release=function(a){};a.prototype.getDrawMode=function(){return 4};return a}(V),N={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},X=U.vec2f64.create(),n=B.vec3f64.create(),Y=B.vec3f64.create(),C=ca.createRenderScreenPointArray3(),aa=B.vec3f64.create(),Z=B.vec3f64.create(),I=da.mat3f64.create(),oa=S.mat4f64.create(),v=B.vec3f64.create(),O={normal:aa,cosAngle:0},M=S.mat4f64.create();R.mat4.identity(M);var na=1,
ma=2,u=[0,0],qa=B.vec3f64.fromValues(0,0,1),ka={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,
0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:U.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},ta=ga.newLayout().vec3f(e.VertexAttrConstants.POSITION).vec3f(e.VertexAttrConstants.NORMAL).vec2f(e.VertexAttrConstants.UV0).vec4u8(e.VertexAttrConstants.COLOR).vec2f(e.VertexAttrConstants.SIZE).vec4f(e.VertexAttrConstants.AUXPOS1).vec4f(e.VertexAttrConstants.AUXPOS2),
pa=function(){function c(a){this.material=a;this.vertexBufferLayout=ta}c.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};c.prototype.elementCount=function(a){return 6*a.indices[e.VertexAttrConstants.POSITION].length};c.prototype.write=function(a,b,c,d){y.writePosition(b.indices[e.VertexAttrConstants.POSITION],b.vertexAttr[e.VertexAttrConstants.POSITION].data,a.transformation,c.position,d,6);y.writeNormal(b.indices[e.VertexAttrConstants.NORMAL],b.vertexAttr[e.VertexAttrConstants.NORMAL].data,
a.invTranspTransformation,c.normal,d,6);a=b.vertexAttr[e.VertexAttrConstants.UV0].data;var f=void 0,l=void 0,p=void 0,k=void 0;null==a||4>a.length?(a=this.material.getParameters(),l=f=0,p=a.texCoordScale[0],k=a.texCoordScale[1]):(f=a[0],l=a[1],p=a[2],k=a[3]);var p=Math.min(1.99999,p+1),k=Math.min(1.99999,k+1),g=b.indices[e.VertexAttrConstants.POSITION].length,h=c.uv0;a=d;for(var n=0;n<g;++n)h.set(a,0,f),h.set(a,1,l),a+=1,h.set(a,0,p),h.set(a,1,l),a+=1,h.set(a,0,p),h.set(a,1,k),a+=1,h.set(a,0,p),h.set(a,
1,k),a+=1,h.set(a,0,f),h.set(a,1,k),a+=1,h.set(a,0,f),h.set(a,1,l),a+=1;y.writeColor(b.indices[e.VertexAttrConstants.COLOR],b.vertexAttr[e.VertexAttrConstants.COLOR].data,4,c.color,d,6);f=b.indices[e.VertexAttrConstants.SIZE];l=b.vertexAttr[e.VertexAttrConstants.SIZE].data;p=f.length;k=c.size;a=d;for(n=0;n<p;++n)for(var g=l[2*f[n]],h=l[2*f[n]+1],r=0;6>r;++r)k.set(a,0,g),k.set(a,1,h),a+=1;b.indices[e.VertexAttrConstants.AUXPOS1]&&b.vertexAttr[e.VertexAttrConstants.AUXPOS1]&&y.writeBufferVec4(b.indices[e.VertexAttrConstants.AUXPOS1],
b.vertexAttr[e.VertexAttrConstants.AUXPOS1].data,c.auxpos1,d,6);b.indices[e.VertexAttrConstants.AUXPOS2]&&b.vertexAttr[e.VertexAttrConstants.AUXPOS2]&&y.writeBufferVec4(b.indices[e.VertexAttrConstants.AUXPOS2],b.vertexAttr[e.VertexAttrConstants.AUXPOS2].data,c.auxpos2,d,6)};return c}(),ba={factor:0,units:-4};return P});