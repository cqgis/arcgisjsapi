// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/arrayUtils ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingRect ../../2d/engine/vectorTiles/VectorTileDisplayObject3D ../support/mathUtils ./ElevationTileAgent ./MapTileAgent ./TerrainConst ./terrainUtils ./TileAgent ./TilePerLayerInfo ./tileUtils ../../webgl/Texture ../../webgl/Util".split(" "),
function(K,L,B,C,p,D,l,q,E,F,t,G,H,u,v,f,I,k,y,z,J,A){function w(c){c.dispose();c instanceof u?u.Pool.release(c):c instanceof v&&v.Pool.release(c)}var x=I.weakAssert,r=q.vec3f64.create(),m=q.vec3f64.create(),h=F.vec4f64.create();return function(){function c(a){this._numSubdivisionAtLevel=a;this.lij=[0,0,0];this._dirty=!0;this.extent=t.create();this._elevationBounds=D.vec2f64.create();this.children=[null,null,null,null];this.layerInfo=Array(f.LayerClass.COUNT);this.extentInRadians=t.create();this.centerAtSeaLevel=
q.vec3f64.create();this.center=q.vec3f64.create();this.up=q.vec3f64.zeros();this._intersectsClippingArea=this._isWithinClippingArea=!0;this._clippingArea=null;this._memoryUsed=this.radius=this.edgeLen2=this.edgeLen=this.renderOrder=this.screenDepth=this._maxTesselation=0}Object.defineProperty(c.prototype,"memoryUsed",{get:function(){return this._memoryUsed},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"maxTesselation",{get:function(){return this._maxTesselation},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"numSubdivisionsAtLevel",{get:function(){return this._numSubdivisionAtLevel},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"isWithinClippingArea",{get:function(){return this._isWithinClippingArea},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"intersectsClippingArea",{get:function(){return this._intersectsClippingArea},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"clippingArea",{get:function(){return this._clippingArea},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"surface",{get:function(){return this._surface},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"visible",{get:function(){if(this._dirty){var a=this._isVisible();a!==this._visible&&
(this._visible=a,this.updateAgentSuspension(),this._visible=a);this._dirty=!1}return this._visible},enumerable:!0,configurable:!0});c.prototype.init=function(a,b,d){this.lij[0]=a[0];this.lij[1]=a[1];this.lij[2]=a[2];d.tilingScheme.getExtent(a[0],a[1],a[2],this.extent,this.extentInRadians);this._intersectsClippingArea=this._isWithinClippingArea=!0;this._clippingArea=null;this.radius=this.edgeLen2=this.edgeLen=0;this.vlevel=a?a[0]:0;b&&b._elevationBounds?p.vec2.copy(this.elevationBounds,b.elevationBounds):
p.vec2.set(this.elevationBounds,0,0);this._pendingUpdates=0;this.renderData=null;this.screenDepth=0;this._visible=!1;this._dirty=!0;this._parent=b;this._surface=d;for(a=0;4>a;a++)this.children[a]=null;for(a=0;a<f.LayerClass.COUNT;a++){b=d.numLayers(a);var g=this.layerInfo[a];this.layerInfo[a]?g.length=b:(g=Array(b),this.layerInfo[a]=g);for(var e=0;e<b;e++)g[e]=y.TilePerLayerInfo.makeEmptyLayerInfo(a,this._surface.upsampleInfoPool,g[e]),a===f.LayerClass.ELEVATION&&this.findElevationBoundsForLayer(e,
-1)}this.computeElevationBounds();this._maxTesselation=Math.min(d.tilingScheme.pixelSize[0],f.MAX_PATCH_TESSELATION)};c.prototype.dispose=function(){x(!this.renderData,"tile.renderData was not unloaded");this._parent&&x(-1===this._parent.children.indexOf(this),"still linked");for(var a=0;a<f.LayerClass.COUNT;a++)for(var b=0,d=this.layerInfo[a];b<d.length;b++)d[b].dispose();this._surface=this._parent=null;this._memoryUsed=0};c.prototype.updateMemoryUsed=function(){for(var a=this._surface.tilingScheme.pixelSize,
a=a[0]*a[1]*4,b=this._memoryUsed=0,d=this.layerInfo[f.LayerClass.MAP];b<d.length;b++){var g=d[b],g=g.data;g instanceof J?this._memoryUsed+=A.getGpuMemoryUsage(g):g instanceof HTMLImageElement?this._memoryUsed+=a:g instanceof G&&(this._memoryUsed+=g.getGpuMemoryUsage()+g.getCpuMemoryUsage())}b=0;for(d=this.layerInfo[f.LayerClass.ELEVATION];b<d.length;b++)g=d[b],this._memoryUsed+=g.data?a:0;this.renderData&&(this._memoryUsed+=this.renderData.estimatedGeometryMemoryUsage,a=this.renderData.textureDescriptor)&&
(this._memoryUsed+=A.getGpuMemoryUsage(a))};c.prototype.updateScreenDepth=function(a){l.vec3.copy(h,this.center);h[3]=1;E.vec4.transformMat4(h,h,a);this.screenDepth=h[2]/h[3]};c.prototype.shouldSplit=function(a,b){var d=this.lij[0];l.vec3.subtract(r,this.center,b);var g=l.vec3.squaredLength(r),e=a[4];if(this.edgeLen2>g&&d<e)return f.TileUpdate.SPLIT;var c=a[1],g=2*Math.sqrt(g),h=this.edgeLen/(a[0]*g);return h<c?this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],f.TileUpdate.VSPLITMERGE):f.TileUpdate.NONE:
d>=e?(a=d+Math.ceil(-H.log2(c/h)),a!==this.vlevel?(this.vlevel=a,f.TileUpdate.VSPLITMERGE):f.TileUpdate.NONE):6<d&&(l.vec3.scale(m,this.up,l.vec3.dot(this.up,r)),l.vec3.subtract(m,m,r),d=l.vec3.squaredLength(m),d>this.radius*this.radius&&(l.vec3.scale(m,m,this.radius/Math.sqrt(d)),l.vec3.add(m,m,this.center),l.vec3.subtract(m,b,m),b=this._elevationBounds[1]-this._elevationBounds[0],Math.min(1,(Math.abs(l.vec3.dot(m,this.up))+.5*b+this.curvatureHeight)/l.vec3.length(m))*(this.edgeLen/(a[2]*g))<.1/
a[5]*a[3]))?f.TileUpdate.NONE:f.TileUpdate.SPLIT};c.prototype.load=function(a){for(var b=null==this.renderData&&a.loadCachedElevationData(this),d=0;d<f.LayerClass.COUNT;d++)if(this.layerInfo[d])if(d===f.LayerClass.ELEVATION&&b)for(var g=0,e=this.layerInfo[d];g<e.length;g++)e[g].loadingAgent=k.DONE;else this._createOrUpdateAgents(0,d);a.loadTile(this)};c.prototype.unload=function(a){a.unloadTile(this,this.elevationDone);for(a=0;a<f.LayerClass.COUNT;a++)for(var b=0,d=this.layerInfo[a];b<d.length;b++){var g=
d[b];g.loadingAgent&&g.loadingAgent!==k.DONE&&(w(g.loadingAgent),g.loadingAgent=null);g.pendingUpdates=0}this._pendingUpdates&=~f.TileUpdate.GEOMETRY;this._pendingUpdates&=~f.TileUpdate.TEXTURE};c.prototype.updateClippingStatus=function(a){if(t.equals(a,this._clippingArea))return!1;var b=this._intersectsClippingArea,d=this._isWithinClippingArea;a?(this._intersectsClippingArea=this.intersectsExtent(a),this._isWithinClippingArea=this.isWithinExtent(a)):this._isWithinClippingArea=this._intersectsClippingArea=
!0;this._clippingArea=a;this._dirty=!0;a=d&&this._isWithinClippingArea;b=!d&&!b&&!this._isWithinClippingArea&&!this._intersectsClippingArea;!this.renderData||a||b||this.setPendingUpdate(f.TileUpdate.GEOMETRY);return!0};c.prototype.updateVisibility=function(){this._dirty=!0};c.prototype.getLayerInfo=function(a,b){return this.layerInfo[b][a]};c.prototype.hasLayerData=function(a,b){return(a=this.layerInfo[b][a])&&a.data&&!a.dataInvalidated};c.prototype.hasDataAvailable=function(a,b,d){return(b=this.layerInfo[d][b].tilemap)?
"unavailable"!==b.getAvailability(a.lij[1],a.lij[2]):!0};Object.defineProperty(c.prototype,"hasPendingUpdates",{get:function(){return 0!==this._pendingUpdates},enumerable:!0,configurable:!0});c.prototype.isSuspended=function(a){return this.hasPendingUpdate(f.TileUpdate.SPLIT)?!0:a===f.LayerClass.ELEVATION?!1:!this.visible};Object.defineProperty(c.prototype,"elevationDone",{get:function(){if(this.hasPendingUpdate(f.TileUpdate.GEOMETRY))return!1;for(var a=0,b=this.layerInfo[f.LayerClass.ELEVATION];a<
b.length;a++){var d=b[a];if(d.loadingAgent!==k.DONE||!d.upsampleFromTile)return!1}return!0},enumerable:!0,configurable:!0});c.prototype.hasPendingUpdate=function(a){return(this._pendingUpdates&a)===a};c.prototype.setPendingUpdate=function(a){this._pendingUpdates|=a;this._surface.setPendingUpdates()};c.prototype.resetPendingUpdate=function(a){return this.hasPendingUpdate(a)?(this._pendingUpdates&=~a,!0):!1};c.prototype.requestLayerData=function(a,b,d){var g=this;f.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",
this.lij.toString(),b,a,d.tile.lij.toString());var e=this.layerInfo[b][a];if(-1<e.waitingAgents.indexOf(d))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),d.tile.lij.toString(),b,a),!0;e.waitingAgents.push(d);if(e.data&&!e.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),d.tile.lij.toString(),b,a),setTimeout(function(){return d.dataArrived(g)},
0),!0;if(e.requestPromise)return!0;e.requestAbort=C.createAbortController();var c=this._surface.requestTileData(this,a,b,e.requestAbort);if(!c)return e.requestAbort=null,!1;a=function(){e.requestPromise===c&&(e.requestPromise=null,e.requestAbort=null)};e.requestPromise=c;c.then(a,a);return!!e.requestPromise};c.prototype.descendants=function(a){a||(a=[]);for(var b=0;4>b;b++){var d=this.children[b];d&&(d.descendants(a),a.unshift(this.children[b]))}return a};Object.defineProperty(c.prototype,"isLeaf",
{get:function(){return!this.children[0]&&!this.children[1]&&!this.children[2]&&!this.children[3]},enumerable:!0,configurable:!0});c.prototype.hasLij=function(a){return this.lij[0]===a[0]&&this.lij[1]===a[1]&&this.lij[2]===a[2]};c.prototype.findByLij=function(a){if(this.hasLij(a))return this;for(var b=0;4>b;b++){var d=this.children[b];if(d&&(d=d.findByLij(a)))return d}return null};c.prototype.unrequestLayerData=function(a,b,d){f.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",
this.lij.toString(),b,a,d.tile.lij.toString());var c=this.layerInfo[b][a],e=c.waitingAgents;d=null!=B.removeUnordered(e,d);x(d,"agent has not requested this piece of map data");1>e.length&&(c.abortRequest(),f.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),b,a),this.updateMemoryUsed())};c.prototype.dataArrived=function(a,b,d){a=this.layerInfo[b][a];a.data=d;a.dataInvalidated=!1;for(d=0;d<a.waitingAgents.length;d++)a.waitingAgents[d].dataArrived(this);
a.waitingAgents.length=0;this.updateMemoryUsed()};c.prototype.dataMissing=function(a,b,d){d.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),b,a);a=this.layerInfo[b][a];a.dataMissing=!0;for(b=0;b<a.waitingAgents.length;b++)a.waitingAgents[b].dataMissing(this);a.waitingAgents.length=0;this.updateMemoryUsed()};c.prototype.updateRenderData=function(a){switch(a){case f.LayerClass.MAP:return this.updateTexture();case f.LayerClass.ELEVATION:return this.updateGeometry()}};c.prototype.updateTexture=
function(){this.renderData&&(this._pendingUpdates|=f.TileUpdate.TEXTURE,this._surface.setPendingUpdates())};c.prototype.updateGeometry=function(){this.setPendingUpdate(f.TileUpdate.GEOMETRY);for(var a=0,b=this.layerInfo[f.LayerClass.ELEVATION];a<b.length;a++)b[a].pendingUpdates|=f.TileUpdate.GEOMETRY;this._surface.setPendingUpdates()};c.prototype.invalidateLayerData=function(a,b){this.layerInfo[b][a].invalidateSourceData();this.restartAgents(b)};c.prototype.computeElevationBounds=function(){p.vec2.set(this._elevationBounds,
Number.MAX_VALUE,-Number.MAX_VALUE);for(var a=!1,b=0,d=this.layerInfo[f.LayerClass.ELEVATION];b<d.length;b++){var c=d[b];c.elevationBounds&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],c.elevationBounds[0]),this._elevationBounds[1]=Math.max(this._elevationBounds[1],c.elevationBounds[1]),a=!0)}a||p.vec2.set(this._elevationBounds,0,0);this.updateRadiusAndCenter()};c.prototype.updateRadiusAndCenter=function(){l.vec3.scale(m,this.up,.5*(this._elevationBounds[0]+this._elevationBounds[1]));
l.vec3.add(this.center,this.centerAtSeaLevel,m)};c.prototype.findElevationBoundsForLayer=function(a,b){var d=this.layerInfo[f.LayerClass.ELEVATION][a];if(!d.elevationBounds||d.elevationBounds[2]<b)if(b=this._surface.layerViewByIndex(a,f.LayerClass.ELEVATION),z.fallsWithinLayer(this,b.layer,!1)){b=!1;if(d.data){var c=d.data;p.vec2.copy(h,c.bounds);h[2]=this.lij[0];b=!0}else{for(var e=0,n=void 0,c=void 0,k=this._parent;k&&(!c||e<f.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&!(e=this.vlevel-k.lij[0],n=c||n,
c=k.layerInfo[f.LayerClass.ELEVATION][a].data,!c&&n&&e>=f.ELEVATION_DESIRED_RESOLUTION_LEVEL);k=k._parent);if(c=c||n)c.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],h),Infinity!==h[0]&&(h[2]=c.level,b=!0)}b&&(d.elevationBounds?l.vec3.copy(d.elevationBounds,h):d.elevationBounds=[h[0],h[1],h[2]])}};c.prototype.modifyLayers=function(a,b,d){for(var c=this.layerInfo[d],e=0;e<c.length;e++){var n=c[e];n.loadingAgent&&n.loadingAgent!==k.DONE&&(w(n.loadingAgent),n.loadingAgent=null);n.waitingAgents.length=
0}if(d===f.LayerClass.MAP)for(e=0;e<c.length;++e)void 0===a[e]&&c[e].dispose();a=b.length;n=Array(a);for(e=0;e<a;e++){var h=b[e];n[e]=-1<h?c[h]:y.TilePerLayerInfo.makeEmptyLayerInfo(d,this._surface.upsampleInfoPool)}this.layerInfo[d]=n;this.updateMemoryUsed()};c.prototype.restartAgents=function(a){this.renderData&&(this._createOrUpdateAgents(0,a),this.updateRenderData(a))};c.prototype.updateAgents=function(a){if(this.renderData){for(var b=this.layerInfo[a],d=0;d<b.length;d++){var c=b[d];c.loadingAgent===
k.DONE&&(c.loadingAgent=null)}this._createOrUpdateAgents(0,a)}};c.prototype.updateAgentSuspension=function(){for(var a=0;a<f.LayerClass.COUNT;a++)for(var b=this.isSuspended(a),d=0,c=this.layerInfo[a];d<c.length;d++){var e=c[d];e.loadingAgent&&e.loadingAgent!==k.DONE&&(e.loadingAgent.setSuspension(b),e.loadingAgent===k.DONE&&this.updateRenderData(a))}};c.prototype.removeLayerAgent=function(a,b){a=this.layerInfo[b][a];a.loadingAgent&&a.loadingAgent!==k.DONE&&a.loadingAgent.dispose();a.loadingAgent=
null};c.prototype.agentDone=function(a,b){var d=this.layerInfo[b][a];d.loadingAgent=k.DONE;d.data||d.upsampleFromTile||this._createOrUpdateAgents(a+1,b)};c.prototype._createOrUpdateAgents=function(a,b){for(var d=this.isSuspended(b),c=this.layerInfo[b];a<c.length;++a){var e=c[a],h=!1,l=this._surface.layerViewByIndex(a,b);if(e.loadingAgent)e.loadingAgent!==k.DONE&&e.loadingAgent.setSuspension(d),e.loadingAgent!==k.DONE&&(h=e.loadingAgent.update());else if(z.fallsWithinLayer(this,l.layer,!1)){var h=
e,m=a,p=b,q=d,r=p===f.LayerClass.ELEVATION?u.Pool.acquire():v.Pool.acquire();r.init(this,m,p,q);h.loadingAgent=r;(h=e.loadingAgent.startLoading())?e.loadingAgent===k.DONE&&this.setPendingUpdate(f.TileUpdate.GEOMETRY):(w(e.loadingAgent),e.loadingAgent=k.DONE)}e.loadingAgent===k.DONE&&this.updateRenderData(b);if(h&&l.isOpaque)break}};c.prototype.isWithinExtent=function(a){var b=this.extent;return b[0]>=a[0]&&a[2]>=b[2]&&b[1]>=a[1]&&a[3]>=b[3]};c.prototype.intersectsExtent=function(a){var b=this.extent;
return b[2]>=a[0]&&a[2]>=b[0]&&b[3]>=a[1]&&a[3]>=b[1]};return c}()});