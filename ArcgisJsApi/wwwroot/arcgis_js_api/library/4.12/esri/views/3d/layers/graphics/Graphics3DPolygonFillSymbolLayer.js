// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ./constants ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/RibbonLineMaterial".split(" "),
function(r,y,E,F,G,H,p,I,z,t,u,J,K,v,A,L,M,N,m,O,P,B,w,C,Q,R,D,x,S,T,U){Object.defineProperty(y,"__esModule",{value:!0});r=function(r){function l(a,b,g,k){a=r.call(this,a,b,g,k)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};return a}E(l,r);l.prototype.doLoad=function(){return G(this,void 0,void 0,function(){return F(this,function(a){this._prepareFillResources();this._prepareOutlineResources();return[2]})})};l.prototype._prepareFillResources=function(){var a=this._getStageIdHint(),
b=p.get(this.symbolLayer,"material","color"),b=this._getCombinedOpacityAndColor(b),b={color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new S(b,a+"_colormat");this._context.stage.add(w.ModelContentType.MATERIAL,this._material)};l.prototype._prepareOutlineResources=function(){var a=this.symbolLayer.outline;if(this._hasOutline=!!(p.isSome(a)&&a.size&&0<a.size&&p.isSome(a.color))){var b=this._getStageIdHint()+
"_outline",g=this._getOutlineColor(),a=I.pt2px(p.isSome(a)?a.size:0),k=this._context.slicePlaneEnabled;this._outlineMaterial=1.5<=a?new U({width:a,color:g,polygonOffset:!0,slicePlaneEnabled:k},b+"_ribbonlinemat"):new T({color:g,slicePlaneEnabled:k},b+"_nativelinemat");this._context.stage.add(w.ModelContentType.MATERIAL,this._outlineMaterial)}};l.prototype.destroy=function(){r.prototype.destroy.call(this);this._material&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._material.id),this._material=
null);this._outlineMaterial&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._outlineMaterial.id),this._outlineMaterial=null)};l.prototype.createGraphics3DGraphic=function(a){var b=a.graphic,g=b.geometry.type;if("polyline"!==g&&"polygon"!==g&&"extent"!==g)return this.logger.warn("unsupported geometry type for fill symbol: "+g),null;if(!this._validateGeometry(b.geometry))return null;g="graphic"+b.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var k=this.getGraphicElevationContext(b);
return"on-the-ground"===k.mode?this._createAsOverlay(b,a,k,g):this._createAs3DShape(b,a,k,g,b.uid)};l.prototype.layerOpacityChanged=function(){var a=this._material.getColor(),b=p.get(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(b);this._material.setColor([a[0],a[1],a[2],b]);this._material.setTransparent(1>b||this._isPropertyDriven("opacity"));this._outlineMaterial&&(a=this._outlineMaterial.getColor(),a={color:[a[0],a[1],a[2],this._getOutlineOpacity()]},this._outlineMaterial.setParameterValues(a));
return!0};l.prototype.layerElevationInfoChanged=function(a,b,g){var k=this._elevationContext.mode;if(null==g||null==k)return!1;if("on-the-ground"===g&&"on-the-ground"===k)return!0;if(g!==k&&("on-the-ground"===g||"on-the-ground"===k))return!1;var h=m.needsElevationUpdates2D(k);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return h})};l.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._outlineMaterial&&
this._outlineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};l.prototype.pixelRatioChanged=function(a,b){return!0};l.prototype.setDrawOrder=function(a,b,g){this.updateSymbolLayerOrder(a,b);this._material&&(this._material.renderPriority=a+b/2,g.add(this._material.id));this._outlineMaterial&&(this._outlineMaterial.renderPriority=a,g.add(this._outlineMaterial.id))};l.prototype._createAs3DShape=function(a,b,g,k,h){var f=this._getPolyGeometry(a);a=f.rings;var d=
this._getOutlineGeometry(f,a),f=m.getGeometryVertexData3D(d,f.hasZ,f.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,g);c.idHint=k;c.color=b;c.data=f;var e;this._hasOutline&&(e=new f.vertexData.constructor(f.vertexData));c.outNum=0;c.outGeometries=[];c.outTransforms=[];c.outMaterials=[];this._createAs3DShapeFill(c);c.data.vertexData=e;this._createAs3DShapeOutline(c);this._logGeometryCreationWarnings(c.data,a,"rings","FillSymbol3DLayer");
if(0===c.outNum)return null;b=new R({geometries:c.outGeometries,materials:c.outMaterials,transformations:c.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:h},idHint:k});b=new N(this,b,c.outGeometries,null,null,L.perVertexElevationAligner,g);b.alignedTerrainElevation=f.terrainElevation;b.needsElevationUpdates=m.needsElevationUpdates2D(g.mode);return b};l.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,g=a.data.eleVertexData,k=a.data.vertexData,
h=function(e){var d=b[e];e=d.count;var h=d.index;if(f._context.clippingExtent&&(m.computeBoundingBox(g,h,e,n),m.boundingBoxClipped(n,f._context.clippingExtent)))return"continue";var c=new Float64Array(g.buffer,3*h*g.BYTES_PER_ELEMENT,3*e),l=new Float64Array(k.buffer,3*h*k.BYTES_PER_ELEMENT,3*e),d=d.holeIndices.map(function(a){return a-h}),d=z(c,d,3);if(0===d.length)return"continue";m.applyOrigin(k,h,e,q);e=f._createFillGeometry(d,0,l,c,a.color);e=new C(e,a.idHint);e.singleUse=!0;c=u.mat4f64.create();
t.mat4.translate(c,c,q);a.outGeometries.push(e);a.outMaterials.push(f._material);a.outTransforms.push(c);a.outNum++},f=this,d=0;d<b.length;++d)h(d)};l.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,g=a.data.eleVertexData,c=a.data.vertexData,h=0;h<b.length;++h){var f=b[h],d=f.index,e=f.count;if(this._context.clippingExtent&&(m.computeBoundingBox(g,d,e,n),m.boundingBoxClipped(n,this._context.clippingExtent)))continue;m.applyOrigin(c,d,e,q);f=
new Float64Array(g.buffer,3*d*g.BYTES_PER_ELEMENT,3*e);d=new Float64Array(c.buffer,3*d*c.BYTES_PER_ELEMENT,3*e);d=B.createPolylineGeometry(d,f,!1,A.WHITE,1);d=new C(d,a.idHint+"outline"+h);d.singleUse=!0;f=u.mat4f64.create();t.mat4.translate(f,f,q);a.outGeometries.push(d);a.outMaterials.push(this._outlineMaterial);a.outTransforms.push(f);a.outNum++}};l.prototype._createAsOverlay=function(a,b,g,k){var h=this._getPolyGeometry(a);g=h.rings;var f=this._getOutlineGeometry(h,g);this._material.renderPriority=
this._symbolLayerOrder+this._symbolLayerOrderDelta/2;this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);h=m.getGeometryVertexDataDraped(f,h.spatialReference,this._context.overlaySR);c.idHint=k;c.color=b;c.data=h;var d;this._hasOutline&&(d=new h.vertexData.constructor(h.vertexData));c.outNum=0;c.outGeometries=[];c.outBoundingBox=v.empty();c.layerUid=this._context.layer.uid;c.graphicsUid=a.uid;this._createAsOverlayFill(c);c.data.vertexData=d;this._createAsOverlayOutline(c);
this._logGeometryCreationWarnings(c.data,g,"rings","FillSymbol3DLayer");return 0<c.outNum?new M(this,c.outGeometries,c.outBoundingBox):null};l.prototype._createAsOverlayFill=function(a){for(var b=a.data.vertexData,g=a.data.geometryData.polygons,c=function(d){var e=g[d];d=e.count;var c=e.index,f=new Float64Array(b.buffer,3*c*b.BYTES_PER_ELEMENT,3*d),e=e.holeIndices.map(function(a){return a-c}),f=z(f,e,3);if(0===f.length)return"continue";m.computeBoundingBox(b,c,d,n);if(m.boundingBoxClipped(n,h._context.clippingExtent))return"continue";
v.expand(a.outBoundingBox,n);m.applyOrigin(b,c,d,q);m.setZ(b,c,d,h._getDrapedZ());d=u.mat4f64.create();t.mat4.translate(d,d,q);f=h._createFillGeometry(f,c,b,null,a.color);e=new D(f);e.data.layerUid=a.layerUid;e.data.graphicUid=a.graphicsUid;e.material=h._material;var k=n;e.center=[.5*(k[0]+k[3]),.5*(k[1]+k[4]),0];e.bsRadius=.5*Math.sqrt((k[3]-k[0])*(k[3]-k[0])+(k[4]-k[1])*(k[4]-k[1]));e.transformation=d;e.name=a.idHint;e.uniqueName=a.idHint+"#"+f.id;a.outGeometries.push(e);a.outNum++},h=this,f=0;f<
g.length;++f)c(f)};l.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=a.data.vertexData,c=a.data.geometryData.outlines,k=0;k<c.length;++k){var h=c[k],f=h.index,h=h.count;m.computeBoundingBox(b,f,h,n);if(!m.boundingBoxClipped(n,this._context.clippingExtent)){v.expand(a.outBoundingBox,n);m.applyOrigin(b,f,h,q);m.setZ(b,f,h,this._getDrapedZ());h=new Float64Array(b.buffer,3*f*b.BYTES_PER_ELEMENT,3*h);f=u.mat4f64.create();t.mat4.translate(f,f,q);var h=B.createPolylineGeometry(h,
null,!0,A.WHITE,1),d=new D(h);d.data.layerUid=a.layerUid;d.data.graphicUid=a.graphicsUid;d.material=this._outlineMaterial;var e=n;d.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];d.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));d.transformation=f;d.name=a.idHint+"outline";d.uniqueName=a.idHint+"outline#"+h.id;a.outGeometries.push(d);a.outNum++}}};l.prototype._getOutlineGeometry=function(a,b){return b};l.prototype._getOutlineOpacity=function(){var a=this._getLayerOpacity(),b=p.get(this.symbolLayer,
"outline","color");return a*(p.isSome(b)?b.a:0)};l.prototype._getOutlineColor=function(){var a=p.get(this.symbolLayer,"outline","color"),b=this._getOutlineOpacity();return P.mixinColorAndOpacity(p.isSome(a)?H.toUnitRGB(a):null,b)};l.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?K.fromExtent(a):a};l.prototype._createFillGeometry=function(a,b,c,k,h){for(var f=a.length,d=new Uint32Array(f),e=new Uint32Array(f),g=0;g<f;g++)d[g]=a[g]+b,e[g]=0;a={};b={};a[x.VertexAttrConstants.POSITION]=
d;a[x.VertexAttrConstants.COLOR]=e;b[x.VertexAttrConstants.POSITION]={size:3,data:c};b[x.VertexAttrConstants.COLOR]={size:4,data:h};k&&(b.mapPos={size:3,data:k},a.mapPos=d);return new Q(b,a)};return l}(O.default);y.Graphics3DPolygonFillSymbolLayer=r;var n=v.create(),q=J.vec3f64.create(),c={idHint:null,color:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};y.default=r});