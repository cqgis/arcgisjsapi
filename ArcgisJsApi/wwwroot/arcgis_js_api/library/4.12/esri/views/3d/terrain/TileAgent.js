// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/tsSupport/extendsHelper","./TerrainConst","./tileUtils"],function(c,k,p,t,v){var w=Error("Abstract method called on TileAgent");c=function(){function b(){}b.prototype.init=function(a,b,g,e){this.tile=a;this._layerIdx=b;this._layerClass=g;this._suspended=e;this._tileLayerInfo=a.getLayerInfo(b,g);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)};b.prototype.startLoading=function(){return this._requestNext()};b.prototype.dispose=
function(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null);this._tileLayerInfo=this.tile=null};b.prototype.setSuspension=function(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())};b.prototype.update=function(){var a=this._findAncestorWithData();this._setUpsampleTile(a);
return this._requestNext()};b.prototype.dataArrived=function(a){this._setUpsampleTile(a);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()};b.prototype.dataMissing=function(a){this._tileRequested=null;this._tileLayerInfo.disposeData();this._requestNext()};b.prototype._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()};b.prototype._requestNext=function(){if(this._suspended)return!0;var a=this._findNextDownload();
if(this._tileRequested){if(a===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}a?a.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested};b.prototype._findNextDownload=function(){for(var a=this._layerIdx,b=this._layerClass,g=this.tile.surface.layerViewByIndex(a,b),e=g.layer,c=g.dataLevelRange,g=c.minLevel,c=c.maxLevel,l=this._desiredMinLevelDelta(),
k=t.START_LOADING_LEVEL_DELTA+l,p=this._scaleRangeEnabled?v.fallsWithinLayer:function(){return!0},f,d=this.tile,q=0,m=this._tileLayerInfo.upsampleFromTile,m=m?m.tile.lij[0]:-1,u=this.tile.surface,h=u.getTilemapTile(d);d&&p(d,e,!1)&&d.lij[0]>=g;){var r=d.lij[0],n=d.layerInfo[b][a];if(n.data&&q>=l){r>m&&this._setUpsampleTile(d);n.dataInvalidated&&(f=d);break}if((!h||h.hasDataAvailable(d,a,b))&&r<=c&&!n.data&&!n.dataMissing){if(!f||0===r%t.LOADING_LEVEL_MODULO||this.tile.lij[0]-f.lij[0]<l)f=d;if(q>=
k)break}(d=d.parent)&&h&&(h=h.parent||u.getTilemapTile(d));q++}f&&this.tile.lij[0]-f.lij[0]<l&&this._tileLayerInfo.upsampleFromTile&&(f=null);return f};b.prototype._findAncestorWithData=function(){for(var a=this.tile.vlevel,b=this._desiredMinLevelDelta(),c,e=this.tile;e;e=e.parent)if(e.hasLayerData(this._layerIdx,this._layerClass)){if(a-e.lij[0]>=b)return e;c=e}return c};b.prototype._setUpsampleTile=function(a){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass)};
Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{findNextDownload:function(){return a._findNextDownload()},tileLayerInfo:this._tileLayerInfo}},enumerable:!0,configurable:!0});return b}();k=function(b){function a(){return null!==b&&b.apply(this,arguments)||this}p(a,b);a.prototype._desiredMinLevelDelta=function(){throw w;};return a}(c);(c||(c={})).DONE=new k;return c});