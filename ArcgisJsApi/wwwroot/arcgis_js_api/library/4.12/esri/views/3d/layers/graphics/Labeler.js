// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/graphics/dehydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./graphicSymbolUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/Stage ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas".split(" "),
function(y,z,D,r,u,v,E,A,F,w,p,q,G,H,I,J,K,L,M,B,N,C,O,P,Q){Object.defineProperty(z,"__esModule",{value:!0});y=function(x){function d(){var a=null!==x&&x.apply(this,arguments)||this;a.idHint="__labeler";a._dirty=!1;a.labels={};a.labelsToAdd={};a.labelsToRemove={};a.labelingContexts=[];return a}D(d,x);d.prototype.setup=function(){var a=this;this.handles||(this.handles=new F,this.handles.add([this.view.watch("state.camera",function(){return a.setDirty()}),this.view.watch("pixelRatio",function(){return a.resetAllLabels()})]));
this.textTextureAtlas||(this.textTextureAtlas=new Q.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new C(this.view._stage),this.calloutMaterialCollection=new C(this.view._stage));this.handles.add(this.view.resourceController.scheduler.registerTask(8,function(b){return a.update(b)},function(){return a.needsUpdate()}))};d.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=
null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=[];this.labels={};this.labelsToAdd={};this.labelsToRemove={}};d.prototype.isActiveLabelingContext=function(a){return a.active&&this.labelsEnabled(a)};d.prototype.activateLabelingContext=function(a){for(var b in a.labels){var c=a.labels[b];this.labels[b]=c;c.graphics3DGraphic.setVisibilityFlag(0,
!0,1)}a.active=!0};d.prototype.deactivateLabelingContext=function(a){for(var b in a.labels){var c=a.labels[b];c.graphics3DGraphic.setVisibilityFlag(0,!1,1);c.rendered&&(this.labelsToRemove[b]=a.labels[b]);delete this.labels[b];delete this.labelsToAdd[b]}a.active=!1};d.prototype.addLabelTextureToAtlas=function(a){for(var b=0;b<a.graphics3DGraphic._labelGraphics.length;b++){var c=a.graphics3DGraphic._labelGraphics[b];if(c._labelClass){var f=a.textRenderers[c._labelIndex];f&&this.textTextureAtlas.addTextTexture(f,
c.stageObject)}}a.rendered=!0};d.prototype.removeLabelTextureFromAtlas=function(a){for(var b=a.graphics3DGraphic,c=0;c<b._labelGraphics.length;c++){var f=b._labelGraphics[c];f._labelClass&&(f=a.textRenderers[f._labelIndex])&&this.textTextureAtlas.removeTextTexture(f,b._labelGraphics[c].stageObject)}a.rendered=!1};d.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty};d.prototype.update=function(a){for(var b=this._dirty=!1,c=0,f=this.labelingContexts;c<f.length;c++){var e=f[c];if(this.isActiveLabelingContext(e)){if(!this.hasValidLabelClassContext(e)){if(this.hasInvalidLabelClassContext(e)){this.deactivateLabelingContext(e);
continue}this.createLabelClassContext(e);if(this.hasPendingLabelClassContext(e)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(e))continue}for(var d in e.labelsToInitialize){var h=e.labelsToInitialize[d];this.ensureGraphics3DResources(h)&&(this.labels[d]=h,b=!0);(h.visible&&h.hasTextTextureResources||!h.visible&&h.hasGraphics3DResources)&&delete e.labelsToInitialize[d];if(a&&(a.madeProgress(),a.done)){this._dirty=!0;return}}}}a&&b&&this.view.deconflictor.setDirty();for(d in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[d]),
delete this.labelsToRemove[d];for(d in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[d]),delete this.labelsToAdd[d];this._dirty||this.notifyChange("updating")};d.prototype.hasPendingLabelClassContext=function(a){return a.labelClassPromise&&!!a.labelClassAbortController};d.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};d.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};d.prototype.createLabelClassContextAsync=
function(a){return v(this,void 0,void 0,function(){var b,c,f,d,g=this;return u(this,function(e){switch(e.label){case 0:return b=a.labelClassAbortController.signal,[4,a.layer.when()];case 1:e.sent();p.throwIfAborted(b);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();c=a.graphics3DCore;f=c.layer.labelingInfo&&c.layer.labelingInfo.filter(function(a){return!!a.symbol});if(!f||0===f.length)return[2];d=Array(f.length);return[4,A.forEach(f,function(f,e){return v(g,void 0,void 0,function(){var g,
h,k,m;return u(this,function(l){switch(l.label){case 0:return g=f.symbol,h=K.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(g)),[4,h.load()];case 1:l.sent();p.throwIfAborted(b);k=null;if(!I.isCalloutSupport(g)||!g.hasVisibleCallout())return[3,3];k=J.make(g,c.symbolCreationContext);return[4,k.load()];case 2:l.sent(),p.throwIfAborted(b),l.label=3;case 3:return[4,A.result(H.createLabelFunction(f,a.layer.fields.map(function(a){return a.toJSON()}),this.view.spatialReference))];case 4:return m=l.sent(),
p.throwIfAborted(b),!0===m.ok&&(d[e]={labelClass:f,labelFunction:m.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:k,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(h.symbol)}),[2]}})})})];case 2:return e.sent(),p.throwIfAborted(b),a.labelClassContexts=d,[2]}})})};d.prototype.createLabelClassContext=function(a){return v(this,void 0,void 0,function(){var b=this;return u(this,function(c){a.labelClassPromise||(a.labelClassPromise=this.createLabelClassContextAsync(a).catch(function(b){if(p.isAbortError(b))throw b;
a.labelClassContexts=null}).then(function(){a.labelClassAbortController=null;b.notifyChange("updating")}),this.notifyChange("updating"));return[2,a.labelClassPromise]})})};d.prototype.createTextRenderParameters=function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?P.default.fromSymbol(a,this.view.pixelRatio):null};d.prototype.destroyLabelClassContext=function(a){for(var b=0,c=a.labelClassContexts;b<c.length;b++){var d=c[b];--d.graphics3DSymbol.referenced;d.graphics3DSymbol=null}b=a.labelClassAbortController;
a.labelClassAbortController=p.createAbortController();b&&b.abort();a.labelClassContexts=[];a.labelClassPromise=null;this.notifyChange("updating")};d.prototype.createTextSymbolGraphic=function(a,b,c,d,e){a={text:a.text,centerOffset:c.centerOffset,translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,anchor:c.anchor,centerOffsetUnits:c.centerOffsetUnits,verticalOffset:c.verticalOffset,debugDrawBorder:M.LABELS_SHOW_BORDER,displayWidth:a.displayWidth,displayHeight:a.displayHeight};
n.graphic=b;n.renderingInfo=null;n.layer=d;return e.createLabel(n,a,this.hudMaterialCollection,this.textTextureAtlas)};d.prototype.createLineCalloutGraphic=function(a,b,c,d,e){b={symbol:b,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,centerOffset:d.centerOffset,centerOffsetUnits:d.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};n.graphic=a;n.renderingInfo=b;n.layer=e;return c.createGraphics3DGraphic(n)};d.prototype.ensureGraphics3DResources=
function(a){var b=a.graphics3DGraphic;if(b.destroyed||a.hasGraphics3DResources)return!1;this.ensureTextTextureResources(a);var c=a.labelingContext,d=!1,e=b.graphic,g=c.labelClassContexts,h=c.layer,k=this.labelsEnabled(c);if(!g||0===g.length||!b._graphics[0])return!1;for(var t=0;t<g.length;t++){var l=g[t],p=l.labelClass,n=a.textRenderers[t];if(n){var m=l.graphics3DSymbol,q=null;m.symbol&&"label-3d"===m.symbol.type&&(q=m.symbol);var r=m.symbolLayers[0],m=L.get({graphics3DGraphic:b,labelSymbol:q,labelClass:l.labelClass});
if(r&&!w.isNone(m)){if(d=this.createTextSymbolGraphic(n,e,m,h,r)){if(d._labelClass=p,d._labelIndex=t,b.addLabelGraphic(d,c.stageLayer,this.view._stage),b.setVisibilityFlag(0,k,1),b.clearVisibilityFlag(1,1),b.setVisibilityFlag(3,!1,1),d=!0,l.graphics3DCalloutSymbolLayer&&m.hasLabelVerticalOffset&&(e=this.createLineCalloutGraphic(e,q,l.graphics3DCalloutSymbolLayer,m,h)))l.calloutSymbolLayerIndex=b._labelGraphics.length,b.addLabelGraphic(e,c.stageLayer,this.view._stage)}else return!1;break}}}c.scaleVisibility&&
d&&c.scaleVisibility.updateGraphicLabelScaleVisibility(b);return a.hasGraphics3DResources=!0};d.prototype.destroyGraphics3DResources=function(a){a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};d.prototype.ensureTextTextureResources=function(a){if(!a.hasTextTextureResources){var b=a.labelingContext,c=b.labelClassContexts,d=a.graphics3DGraphic.graphic;if(c&&0!==c.length){for(var e=0;e<c.length;e++){var g=c[e];a.textRenderers[e]=null;if(g.textRenderParameters){var h=g.labelFunction,
k=void 0;if("arcade"===h.type){var n=G.hydrateGraphic(d,b.layer);try{k=h.evaluate(n)}catch(l){k=null}}else k=h.evaluate(d);w.isNone(k)||""===k||(a.textRenderers[e]=new O.default(k,g.textRenderParameters))}}a.hasTextTextureResources=!0}}};d.prototype.destroyTextTextureResources=function(a){a.textRenderers=[];a.hasTextTextureResources=!1};d.prototype.addGraphic=function(a,b){var c={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:a,graphics3DGraphic:b,textRenderers:[]};
b=b.graphic.uid;a.labels[b]=c;this.isActiveLabelingContext(a)&&this.hasValidLabelClassContext(a)&&this.ensureGraphics3DResources(c)?this.labels[b]=c:a.labelsToInitialize[b]=c;this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};d.prototype.removeGraphic=function(a,b){b=b.graphic.uid;var c=a.labels[b];c&&(this.labels[b]&&(this.removeLabelTextureFromAtlas(c),delete this.labels[b],delete this.labelsToAdd[b],delete this.labelsToRemove[b]),c.hasTextTextureResources&&this.destroyTextTextureResources(c),
c.hasGraphics3DResources&&this.destroyGraphics3DResources(c),delete a.labels[b],delete a.labelsToInitialize[b],this.setDirty(a.graphics3DCore.asyncUpdates),this.view.deconflictor.setDirty())};d.prototype.labelsEnabled=function(a){return!0===a.layer.labelsVisible&&null!=a.layer.labelingInfo&&0<a.layer.labelingInfo.length};d.prototype.labelingInfoChange=function(a,b){return v(this,void 0,void 0,function(){var c,d,e,g;return u(this,function(f){if(b){c=0;for(d=b;c<d.length;c++)if(e=d[c],g=a.labels[e])this.removeGraphic(a,
g.graphics3DGraphic),this.addGraphic(a,g.graphics3DGraphic);return[2]}this.visibilityInfoChange(a);this.resetLabels(a);return[2,this.createLabelClassContext(a)]})})};d.prototype.globalPropertyChanged=function(a,b){for(var c=function(c){var d=new Map,e;for(e in b.labels){var f=b.labels[e].graphics3DGraphic;d.set(f.graphic.uid,f)}w.expect(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,d,function(a){return a._labelGraphics[0]});c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,
d,function(a){return a._labelGraphics[c.calloutSymbolLayerIndex]})},d=0,e=b.labelClassContexts;d<e.length;d++)c(e[d])};d.prototype.visibilityInfoChange=function(a){var b=a.layer.labelsVisible;b&&!a.active&&this.activateLabelingContext(a);!b&&a.active&&this.deactivateLabelingContext(a);this.setDirty(a.graphics3DCore.asyncUpdates)};d.prototype.resetAllLabels=function(){for(var a=0,b=this.labelingContexts;a<b.length;a++)this.resetLabels(b[a])};d.prototype.resetLabels=function(a){for(var b in a.labels){var c=
a.labels[b];this.labels[b]&&(this.removeLabelTextureFromAtlas(c),delete this.labels[b],delete this.labelsToAdd[b],delete this.labelsToRemove[b]);c.hasTextTextureResources&&this.destroyTextTextureResources(c);c.hasGraphics3DResources&&this.destroyGraphics3DResources(c);c.visible=!1;c.rendered=!1;a.labelsToInitialize[b]=c}this.destroyLabelClassContext(a);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};d.prototype.findLabelingContext=function(a){for(var b=0,c=this.labelingContexts;b<
c.length;b++){var d=c[b];if(d.graphics3DCore===a)return d}return null};d.prototype.addGraphicsOwner=function(a,b){var c=this;if(!this.findLabelingContext(a)){var d=a.layer,e={graphics3DCore:a,layer:d,scaleVisibility:b,active:a.layer.labelsVisible,labelClassPromise:null,labelClassAbortController:p.createAbortController(),labelClassContexts:[],labels:{},labelsToInitialize:{},stageLayer:new N(this.idHint+"_"+d.uid,{isPickable:!0},d.uid)};this.view._stage.add(B.ModelContentType.LAYER,e.stageLayer);this.view._stage.addToViewContent([e.stageLayer.id]);
this.labelingContexts.push(e);this.setDirty();return{addGraphic:function(a){return c.addGraphic(e,a)},removeGraphic:function(a){return c.removeGraphic(e,a)},featureReductionChange:function(){},layerLabelsEnabled:function(){return c.labelsEnabled(e)},labelingInfoChange:function(a){return c.labelingInfoChange(e,a)},elevationInfoChange:function(){return c.globalPropertyChanged("elevationInfo",e)},slicePlaneEnabledChange:function(){return c.globalPropertyChanged("slicePlaneEnabled",e)},visibilityInfoChange:function(){return c.visibilityInfoChange(e)},
reset:function(){return c.resetLabels(e)},clear:function(){},processStageDirty:function(){return c.view._stage.processDirtyLayer(e.stageLayer.id)}}}};d.prototype.removeGraphicsOwner=function(a){if(a=this.findLabelingContext(a)){var b=this.labelingContexts.indexOf(a);this.labelingContexts.splice(b,1);for(var c in a.labels)this.removeGraphic(a,a.labels[c].graphics3DGraphic);c=a.stageLayer.id;this.view._stage.removeFromViewContent([c]);this.view._stage.remove(B.ModelContentType.LAYER,c);a.stageLayer=
null;this.setDirty()}};d.prototype.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;var c=this.labels[a];c&&(b&&!c.rendered?(this.labelsToAdd[a]=c,c.hasTextTextureResources||(c.labelingContext.labelsToInitialize[a]=c)):!b&&c.rendered&&(this.labelsToRemove[a]=c),c.visible=b,this.setDirty(c.labelingContext.graphics3DCore.asyncUpdates))};Object.defineProperty(d.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0});
d.prototype.setDirty=function(a){void 0===a&&(a=!0);var b=this._dirty;this._dirty||(this._dirty=!0);a||this.update(null);b!==this._dirty&&this.notifyChange("updating")};Object.defineProperty(d.prototype,"updating",{get:function(){var a=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.labelingContexts.some(function(b){return a.hasPendingLabelClassContext(b)})},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"test",{get:function(){return{textTextureAtlas:this.textTextureAtlas}},
enumerable:!0,configurable:!0});r([q.property({constructOnly:!0})],d.prototype,"view",void 0);r([q.property()],d.prototype,"textTextureAtlas",void 0);r([q.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating"]})],d.prototype,"updating",null);return d=r([q.subclass("esri.views.3d.layers.graphics.Labeler")],d)}(q.declared(E));z.Labeler=y;var n={graphic:null,renderingInfo:null,layer:null}});