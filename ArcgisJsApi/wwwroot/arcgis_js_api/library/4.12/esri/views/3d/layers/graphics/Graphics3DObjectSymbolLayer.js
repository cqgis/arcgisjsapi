// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/lang ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ./ElevationAligners ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lodResourceUtils ./objectResourceUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(H,I,U,J,K,L,O,p,P,y,Q,g,h,r,t,V,W,X,n,Y,x,R,Z,M,aa,z,S,u,ba,ca,A,da){Object.defineProperty(I,"__esModule",{value:!0});H=function(v){function c(b,a,e,d){b=v.call(this,b,a,e,d)||this;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;return b}U(c,v);c.prototype.getCachedSize=function(){var b=this._symbolSize;return{width:b[0],depth:b[1],height:b[2]}};c.prototype.doLoad=function(b){return K(this,void 0,void 0,function(){var a,e,d,f;return J(this,function(c){switch(c.label){case 0:a=this._getStageIdHint();
if(!this._isPropertyDriven("size")&&(e=x.validateSymbolLayerSize(this.symbolLayer)))throw Error();d=this.symbolLayer;return this.isByResource?[4,this._prepareModelResources(d.resource.href,b)]:[3,2];case 1:return c.sent(),[3,4];case 2:return f=d.resource?d.resource.primitive:V.defaultPrimitive,[4,this._preparePrimitiveResources(f,a)];case 3:c.sent(),c.label=4;case 4:return[2]}})})};Object.defineProperty(c.prototype,"isByResource",{get:function(){return!(!this.symbolLayer.resource||!this.symbolLayer.resource.href)},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0});c.prototype._preparePrimitiveResources=function(b,a){return K(this,void 0,void 0,function(){var e,d,c,k,l,F,D,m,g,q,B,E;return J(this,function(f){if(!M.isValidPrimitive(b))throw Error("Unknown object symbol primitive: "+b);e=this.symbolLayer;this._resourceBoundingBox=t.create(M.primitiveBoundingBox(b));this._resourceSize=h.vec3f64.fromArray(t.size(this._resourceBoundingBox));
this._symbolSize=h.vec3f64.fromArray(x.computeSizeWithResourceSize(this._resourceSize,e));d=p.get(this.symbolLayer,"material","color");c=this._getCombinedOpacity(d);k={specular:[0,0,0],opacity:c,transparent:1>c||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:h.vec3f64.ONES,diffuse:h.vec3f64.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows};l=this.symbol;"point-3d"===l.type&&l.verticalOffset&&(F=l.verticalOffset,
D=F.screenLength,m=F.minWorldLength,g=F.maxWorldLength,k.verticalOffset={screenLength:P.pt2px(D),minWorldLength:m||0,maxWorldLength:null!=g?g:Infinity},k.castShadows=!1);this._context.screenSizePerspectiveEnabled&&(k.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._isPropertyDriven("color")?k.externalColor=r.vec4f64.ONES:(q=p.isSome(e.material)&&e.material.color,B=p.isSome(q)?L.toUnitRGBA(q):r.vec4f64.ONES,k.externalColor=B);this._fastUpdates=z.initFastSymbolUpdatesState(this._context.renderer,
this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(O.mixin(k,this._fastUpdates.materialParameters),k.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(k.instanced.push("color"),this._optionalFields.push("color"));E=new da(k,a+"_objectmat");this._lodResources=M.primitiveLodResources(b,E,a);this._originalOpacities=A.materialsFromLodResources(this._lodResources).map(function(){return 1});if(!this._lodResources)throw Error("Unknown object symbol primitive: "+
b);this.finalizeSymbolResources();this.initializeLodRenderer();this.complexity=this.computeComplexity();return[2]})})};c.prototype._prepareModelResources=function(b,a){return K(this,void 0,void 0,function(){var e,d,c,k,l,g,D,m,n,q,B,E,r,u,w,y,v,C=this;return J(this,function(f){switch(f.label){case 0:return e=["transformation"],d={instanced:e,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},c={materialParamsMixin:d,streamDataRequester:this._context.streamDataRequester},
this._fastUpdates=z.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(O.mixin(c.materialParamsMixin,this._fastUpdates.materialParameters),e.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(e.push("color"),this._optionalFields.push("color")),k=this.symbol,"point-3d"===k.type&&k.verticalOffset&&(l=k.verticalOffset,g=l.screenLength,D=l.minWorldLength,m=l.maxWorldLength,c.materialParamsMixin.verticalOffset=
{screenLength:P.pt2px(g),minWorldLength:D||0,maxWorldLength:null!=m?m:Infinity},c.materialParamsMixin.castShadows=!1),c.signal=a,[4,Z.fetch(b,c)];case 1:return n=f.sent(),q=R.makeLodResources(n.lods),R.fillEstimatedMinScreenSpaceRadius(q),q.levels.sort(function(a,b){return a.minScreenSpaceRadius-b.minScreenSpaceRadius}),q.levels[0].minScreenSpaceRadius=Math.min(2,q.levels[0].minScreenSpaceRadius),this._lodResources=q,B=this._context,E=this.symbolLayer.material,r=this._getExternalColorParameters(E),
u=p.get(this.symbolLayer,"material","color"),w=this._getCombinedOpacity(u,{hasIntrinsicColor:!0}),y=this._isPropertyDriven("opacity"),v=A.materialsFromLodResources(this._lodResources),this._originalOpacities=v.map(function(a){return a.getParameters().opacity||1}),v.forEach(function(a){var b=a.getParameters();a.setParameterValues(r);var e=b.opacity*w;a.setParameterValues({opacity:e,transparent:1>e||y||b.transparent});B.screenSizePerspectiveEnabled&&a.setParameterValues({screenSizePerspective:B.sharedResources.screenSizePerspectiveSettings})}),
this._resourceBoundingBox=n.referenceBoundingBox,this._resourceSize=h.vec3f64.fromArray(t.size(this._resourceBoundingBox)),this._pivotOffset=h.vec3f64.fromArray(this._lodResources.levels[0].pivotOffset),this._symbolSize=h.vec3f64.fromArray(x.computeSizeWithResourceSize(this._resourceSize,this.symbolLayer)),z.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions())&&v.forEach(function(a){return a.setParameterValues(C._fastUpdates.materialParameters)}),
this.finalizeSymbolResources(),this.initializeLodRenderer(),this.complexity=this.computeComplexity(),[2]}})})};c.prototype.finalizeSymbolResources=function(){var b=this._context.stage;this._materials=A.materialsFromLodResources(this._lodResources);this._materials.forEach(function(a){b.add(u.ModelContentType.MATERIAL,a)});this._textures=A.texturesFromLodResources(this._lodResources);this._textures.forEach(function(a){b.add(u.ModelContentType.TEXTURE,a)});this._geometries=A.geometriesFromLodResources(this._lodResources);
this._geometries.forEach(function(a){b.add(u.ModelContentType.GEOMETRY,a)})};c.prototype.initializeLodRenderer=function(){var b=this,a=this._context.stage;this._lodRenderer=new ca.LodRenderer(this._lodResources,this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:function(a){return b._instanceIndexToGraphicUid.get(a)}},this._fastUpdates.enabled?{applyTransform:function(a,d,c){a.getFeatureAttribute(d,C);y.mat4.copy(c,z.evaluateModelTransform(b._fastUpdates.materialParameters,C,c))},scaleFactor:function(a,
c,f){c.getFeatureAttribute(f,C);return z.evaluateModelTransformScale(a,b._fastUpdates.materialParameters,C)}}:null);this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;a.addRenderPlugin(this._lodRenderer.slots,this._lodRenderer)};c.prototype._getExternalColorParameters=function(b){var a={};this._isPropertyDriven("color")?a.externalColor=r.vec4f64.ONES:p.isSome(b)&&p.isSome(b.color)?a.externalColor=L.toUnitRGBA(b.color):(a.externalColor=r.vec4f64.ONES,a.colorMixMode="ignore");return a};
c.prototype.destroy=function(){v.prototype.destroy.call(this);var b=this._context.stage;this._lodRenderer&&(b.removeRenderPlugin(this._lodRenderer),this._lodRenderer.destroy());this._materials&&this._materials.forEach(function(a){return b.remove(u.ModelContentType.MATERIAL,a.id)});this._textures&&this._textures.forEach(function(a){return b.remove(u.ModelContentType.TEXTURE,a.id)});this._geometries&&this._geometries.forEach(function(a){return b.remove(u.ModelContentType.GEOMETRY,a.id)})};c.prototype.createGraphics3DGraphic=
function(b){var a=b.graphic;if(!this._validateGeometry(a.geometry))return null;var e=n.placePointOnGeometry(a.geometry);if(p.isNone(e))return this.logger.warn("unsupported geometry type for icon symbol: "+a.geometry.type),null;var c=this.getGraphicElevationContext(a);return this._createAs3DShape(a,e,b.renderingInfo,c,a.uid)};c.prototype.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};c.prototype.graphicLayerToGraphicId=function(b){return 0};c.prototype.layerOpacityChanged=
function(){var b=this,a=this._isPropertyDriven("opacity"),e=this.isByResource;this._materials.forEach(function(c,f){var d=p.get(b.symbolLayer,"material","color");f=b._getCombinedOpacity(d,{hasIntrinsicColor:e})*b._originalOpacities[f];c.setParameterValues({opacity:f,transparent:1>f||a})});return!0};c.prototype.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,n.needsElevationUpdates3D)};c.prototype.slicePlaneEnabledChanged=function(b,a){var e=this;this._lodRenderer.slicePlaneEnabled=
this._context.slicePlaneEnabled;this._materials.forEach(function(a){a.setParameterValues({slicePlaneEnabled:e._context.slicePlaneEnabled})});return!0};c.prototype.pixelRatioChanged=function(b,a){return!0};c.prototype.applyRendererDiff=function(b,a){var e=this,c;for(c in b.diff)switch(c){case "visualVariables":if(z.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions()))this._materials.forEach(function(a){return a.setParameterValues(e._fastUpdates.materialParameters)}),
this._lodRenderer.notifyShaderTransformationChanged();else return!1;break;default:return!1}return!0};c.prototype.computeComplexity=function(){if(!this._lodResources)return v.prototype.computeComplexity.call(this);var b=A.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(a,b){return a+b.data.getIndices(ba.VertexAttrConstants.POSITION).length},0)/3,a=aa.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,
estimated:!1,memory:a}};c.prototype._createAs3DShape=function(b,a,e,c,f){b=this.getFastUpdateAttrValues(b);var d=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?x.mixinColorAndOpacity(e.color,e.opacity):null,l=this._context.clippingExtent;S.pointToVector(a,w,this._context.elevationProvider.spatialReference);if(l&&!n.pointInBox2D(w,l))return null;var l=this._requiresTerrainElevation(c),h=this._computeGlobalTransform(a,c,N,l?G:null);e=this._computeLocalTransform(this.symbolLayer,e,T);var g=
this._lodRenderer.instanceData,m=g.addInstance();this._instanceIndexToGraphicUid.set(m,f);g.setLocalTransform(m,e,!1);g.setGlobalTransform(m,h);b&&g.setFeatureAttribute(m,b);d&&g.setColor(m,d);f=new X(this,m,W.perLodInstanceElevationAligner,c);l&&(f.alignedTerrainElevation=G.terrainElevation);f.needsElevationUpdates=n.needsElevationUpdates3D(c.mode);n.extendPointGraphicElevationContext(f,a,this._context.elevationProvider);return f};c.prototype._computeGlobalTransform=function(b,a,c,d){a=n.computeElevation(this._context.elevationProvider,
b,a,this._context.renderCoordsHelper,d);w[0]=b.x;w[1]=b.y;w[2]=a;S.computeLinearTransformation(b.spatialReference,w,c,this._context.renderSpatialReference);return c};c.prototype._computeLocalTransform=function(b,a,c){y.mat4.identity(c);this._applyObjectRotation(a,!1,c);this._applyObjectRotation(b,!0,c);this._applyObjectScale(a,c);this._applyAnchor(b,c);return c};c.prototype._applyObjectScale=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._isPropertyDriven("size")&&
b.size?b.size:this._symbolSize,b=x.computeObjectScale(b,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||y.mat4.scale(a,a,b))};c.prototype.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}};c.prototype.updateGeometry=function(b,a){var c=a&&n.placePointOnGeometry(a);if(p.isNone(c))return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==
a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(c,b.elevationContext,N,a?G:null);a&&(b.alignedTerrainElevation=G.terrainElevation);this._lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,N,!0);n.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0};c.prototype._preparePatchTransform=function(b,a){var c=this;if(a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition){var d=function(a,b,c){return(null!=
a&&"complete"===a.type?a.newValue:b)||c},f=d(a.heading,this.symbolLayer.heading,0),k=d(a.tilt,this.symbolLayer.tilt,0),g=d(a.roll,this.symbolLayer.roll,0),n=d(a.width,this.symbolLayer.width,void 0),p=d(a.height,this.symbolLayer.height,void 0),m=d(a.depth,this.symbolLayer.depth,void 0),r=d(a.anchor,this.symbolLayer.anchor,void 0),d=d(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;
var q={heading:f,tilt:k,roll:g,anchor:r,anchorPosition:d};1===this.loadStatus&&b.symbolLayerStatePatches.push(function(){c._symbolSize=h.vec3f64.fromArray(x.computeSizeWithResourceSize(c._resourceSize,{width:n,height:p,depth:m,isPrimitive:c.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push(function(a,b){b=c._computeLocalTransform(q,b,T);c._lodRenderer.instanceData.setLocalTransform(a.instanceIndex,b,!0)})}};c.prototype._preparePatchColor=function(b,a){var c=this;if(a.material&&"partial"===
a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type)){var d=a.color.newValue,f=p.isSome(d)?L.toUnitRGBA(d):r.vec4f64.ONES;delete a.color;b.graphics3DGraphicPatches.push(function(a,b){if(c._hasPerInstanceColor())c._lodRenderer.instanceData.setColor(a.instanceIndex,f);else for(a=0,b=c._materials;a<b.length;a++)b[a].setParameterValues({externalColor:f})})}};c.prototype._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};c.prototype._applyObjectRotation=function(b,
a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return x.computeObjectRotation(b.heading,b.tilt,b.roll,c)};c.prototype._computeAnchor=function(b){var a=h.vec3f64.create();switch(b.anchor){case "center":g.vec3.copy(a,t.center(this._resourceBoundingBox));g.vec3.negate(a,a);break;case "top":var c=t.center(this._resourceBoundingBox);g.vec3.set(a,-c[0],-c[1],-this._resourceBoundingBox[5]);break;case "bottom":c=t.center(this._resourceBoundingBox);g.vec3.set(a,-c[0],
-c[1],-this._resourceBoundingBox[2]);break;case "relative":var c=t.center(this._resourceBoundingBox),d=t.size(this._resourceBoundingBox);b=(b=b.anchorPosition)?h.vec3f64.fromValues(b.x,b.y,b.z):h.vec3f64.ZEROS;g.vec3.multiply(a,d,b);g.vec3.add(a,a,c);g.vec3.negate(a,a);break;default:this._pivotOffset?g.vec3.negate(a,this._pivotOffset):g.vec3.copy(a,h.vec3f64.ZEROS)}return a};c.prototype._applyAnchor=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b))&&
y.mat4.translate(a,a,b)};c.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};c.prototype._fastVisualVariableConvertOptions=function(){var b=this._resourceBoundingBox?h.vec3f64.fromArray(t.size(this._resourceBoundingBox)):h.vec3f64.ONES,a=this._resourceBoundingBox?this._computeAnchor(this.symbolLayer):h.vec3f64.ZEROS,c=this._context.renderCoordsHelper.unitInMeters,d=x.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,
c),f=h.vec3f64.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:b,symbolSize:this._symbolSize||h.vec3f64.ONES,unitInMeters:c,transformation:{anchor:a,scale:d,rotation:f}}};return c}(Y.default);I.Graphics3DObjectSymbolLayer=H;var w=h.vec3f64.create(),T=Q.mat4f64.create(),N=Q.mat4f64.create(),C=r.vec4f64.create(),G={verticalDistanceToGround:0,terrainElevation:0};I.default=H});