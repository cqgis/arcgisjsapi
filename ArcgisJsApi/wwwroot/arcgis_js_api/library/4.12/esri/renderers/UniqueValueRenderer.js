// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/paramHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/assignHelper ../symbols ../symbols ../core/arrayUtils ../core/Error ../core/lang ../core/Logger ../core/urlUtils ../core/accessorSupport/decorators ../core/accessorSupport/ensureType ../layers/support/fieldUtils ../portal/Portal ./Renderer ./mixins/VisualVariablesRenderer ./support/diffUtils ./support/LegendOptions ./support/UniqueValueInfo ../support/arcadeOnDemand ../symbols/support/jsonUtils ../symbols/support/styleUtils".split(" "),
function(M,N,C,d,D,r,t,w,u,k,x,E,l,F,y,f,z,p,v,G,H,I,J,q,A,m,K){var h=F.getLogger("esri.renderers.UniqueValueRenderer"),L=z.ensureType(q.default);return function(B){function a(b){b=B.call(this)||this;b._valueInfoMap={};b._isDefaultSymbolDerived=!1;b.type="unique-value";b.backgroundFillSymbol=null;b.field=null;b.field2=null;b.field3=null;b.valueExpression=null;b.valueExpressionTitle=null;b.legendOptions=null;b.defaultLabel=null;b.fieldDelimiter=null;b.portal=null;b.styleOrigin=null;b.diff={uniqueValueInfos:function(b,
g){if(b||g){if(!b||!g)return{type:"complete",oldValue:b,newValue:g};for(var c=!1,a={type:"collection",added:[],removed:[],changed:[],unchanged:[]},f=function(e){var d=x.find(b,function(b){return b.value===g[e].value});d?I.diff(d,g[e])?(a.changed.push({type:"complete",oldValue:d,newValue:g[e]}),c=!0):a.unchanged.push({oldValue:d,newValue:g[e]}):(a.added.push(g[e]),c=!0)},d=0;d<g.length;d++)f(d);f=function(e){x.find(g,function(c){return c.value===b[e].value})||(a.removed.push(b[e]),c=!0)};for(d=0;d<
b.length;d++)f(d);return c?a:void 0}}};b._set("uniqueValueInfos",[]);return b}C(a,B);n=a;Object.defineProperty(a.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!0,configurable:!0});a.prototype.writeBackgroundFillSymbolWebScene=function(b,c,a,e){m.writeTarget(b,c,a,e)};a.prototype.castField=function(b){return null==b||"function"===typeof b?b:z.ensureString(b)};a.prototype.writeField=function(b,c,a,e){"string"===typeof b?c[a]=b:e&&e.messages?e.messages.push(new E("property:unsupported",
"UniqueValueRenderer.field set to a function cannot be written to JSON")):h.error(".field: cannot write field to JSON since it's not a string value")};Object.defineProperty(a.prototype,"defaultSymbol",{set:function(b){this._isDefaultSymbolDerived=!1;this._set("defaultSymbol",b)},enumerable:!0,configurable:!0});a.prototype.readDefaultSymbol=function(b,c,a){return m.read(b,c,a)};a.prototype.writeDefaultSymbolWebScene=function(b,c,a,e){this._isDefaultSymbolDerived||m.writeTarget(b,c,a,e)};a.prototype.writeDefaultSymbol=
function(b,c,a,e){this._isDefaultSymbolDerived||m.writeTarget(b,c,a,e)};a.prototype.readPortal=function(b,c,a){return a.portal||v.getDefault()};a.prototype.readStyleOrigin=function(b,c,a){if(c.styleName)return Object.freeze({styleName:c.styleName});if(c.styleUrl)return b=y.fromJSON(c.styleUrl,a),Object.freeze({styleUrl:b})};a.prototype.writeStyleOrigin=function(b,c,a,e){b.styleName?c.styleName=b.styleName:b.styleUrl&&(c.styleUrl=y.toJSON(b.styleUrl,e))};Object.defineProperty(a.prototype,"uniqueValueInfos",
{set:function(b){this.styleOrigin?h.error("#uniqueValueInfos\x3d","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",b),this._updateValueInfoMap())},enumerable:!0,configurable:!0});a.prototype.addUniqueValueInfo=function(b,c){this.styleOrigin?h.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(b="object"===typeof b?L(b):new q.default({value:b,symbol:c}),this.uniqueValueInfos.push(b),
this._valueInfoMap[b.value]=b)};a.prototype.removeUniqueValueInfo=function(b){if(this.styleOrigin)h.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(var c=0;c<this.uniqueValueInfos.length;c++)if(this.uniqueValueInfos[c].value===b+""){delete this._valueInfoMap[b];this.uniqueValueInfos.splice(c,1);break}};a.prototype.getUniqueValueInfo=function(b,c){return t(this,void 0,void 0,function(){var a,e;return r(this,function(g){switch(g.label){case 0:return a=
c,this.valueExpression?[4,A.loadArcade()]:[3,2];case 1:e=g.sent().arcadeUtils,a=w({},a,{arcadeUtils:e}),g.label=2;case 2:return[2,this._getUniqueValueInfo(b,a)]}})})};a.prototype.getSymbol=function(b,c){if(!this.valueExpression||c&&c.arcadeUtils)return(b=this._getUniqueValueInfo(b,c))&&b.symbol||this.defaultSymbol;h.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used")};a.prototype.getSymbolAsync=function(b,c){return t(this,void 0,void 0,function(){var a,e,d;return r(this,function(g){switch(g.label){case 0:return a=
c,this.valueExpression?[4,A.loadArcade()]:[3,2];case 1:e=g.sent().arcadeUtils,a=w({},a,{arcadeUtils:e}),g.label=2;case 2:return d=this._getUniqueValueInfo(b,a),[2,d&&d.symbol||this.defaultSymbol]}})})};a.prototype.getSymbols=function(){for(var b=[],c=0,a=this.uniqueValueInfos;c<a.length;c++){var e=a[c];e.symbol&&b.push(e.symbol)}this.defaultSymbol&&b.push(this.defaultSymbol);return b};a.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(b,c){return b+
c.getAttributeHash()},"")};a.prototype.getMeshHash=function(){var b=JSON.stringify(this.backgroundFillSymbol),c=JSON.stringify(this.defaultSymbol),a=this.uniqueValueInfos.reduce(function(b,c){return b+c.getMeshHash()},"");return b+"."+c+"."+a+"."+(this.field+"."+this.field2+"."+this.field3+"."+this.fieldDelimiter)+"."+this.valueExpression};a.prototype.clone=function(){var b=new n({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:l.clone(this.defaultSymbol),
valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:l.clone(this.visualVariables),legendOptions:l.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:l.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(b._isDefaultSymbolDerived=!0);b._set("portal",this.portal);var c=l.clone(this.uniqueValueInfos);this.styleOrigin&&(b._set("styleOrigin",Object.freeze(l.clone(this.styleOrigin))),
Object.freeze(c));b._set("uniqueValueInfos",c);b._updateValueInfoMap();return b};a.prototype.collectRequiredFields=function(b,c){return t(this,void 0,void 0,function(){return r(this,function(a){switch(a.label){case 0:return[4,this.collectVVRequiredFields(b,c)];case 1:return a.sent(),this.getSymbols().forEach(function(a){return a.collectRequiredFields(b,c)}),p.collectField(b,c,this.field),p.collectField(b,c,this.field2),p.collectField(b,c,this.field3),[4,p.collectArcadeFieldNames(b,c,this.valueExpression)];
case 2:return a.sent(),[2]}})})};a.prototype.populateFromStyle=function(){var b=this;return K.fetchStyle(this.styleOrigin,{portal:this.portal}).then(function(c){var a=[];b._valueInfoMap={};c&&c.data&&Array.isArray(c.data.items)&&c.data.items.forEach(function(e){var d=new u.WebStyleSymbol({styleUrl:c.styleUrl,styleName:c.styleName,portal:b.portal,name:e.name});b.defaultSymbol||e.name!==c.data.defaultItem||(b.defaultSymbol=d,b._isDefaultSymbolDerived=!0);d=new q.default({value:e.name,symbol:d});a.push(d);
b._valueInfoMap[e.name]=d});b._set("uniqueValueInfos",Object.freeze(a));!b.defaultSymbol&&b.uniqueValueInfos.length&&(b.defaultSymbol=b.uniqueValueInfos[0].symbol,b._isDefaultSymbolDerived=!0);return b})};a.prototype._updateValueInfoMap=function(){var b=this;this._valueInfoMap={};this.uniqueValueInfos.forEach(function(c){return b._valueInfoMap[c.value+""]=c})};a.prototype._getUniqueValueInfo=function(b,c){return this.valueExpression?this._getUnqiueValueInfoForExpression(b,c):this._getUnqiueValueInfoForFields(b)};
a.prototype._getUnqiueValueInfoForExpression=function(b,c){var a=c.arcadeUtils,d=c.viewingMode,f=c.scale;c=c.spatialReference;var h=this._cache.compiledFunc;h||(h=a.createSyntaxTree(this.valueExpression),h=a.createFunction(h),this._cache.compiledFunc=h);b=a.executeFunction(h,a.createExecContext(b,a.getViewInfo({viewingMode:d,scale:f,spatialReference:c})));return this._valueInfoMap[b+""]};a.prototype._getUnqiueValueInfoForFields=function(b){var a=this.field,d=b.attributes,e;if("function"!==typeof a&&
this.field2){b=this.field2;e=this.field3;var f=[];a&&f.push(d[a]);b&&f.push(d[b]);e&&f.push(d[e]);e=f.join(this.fieldDelimiter||"")}else"function"===typeof a?e=a(b):a&&(e=d[a]);return this._valueInfoMap[e+""]};a.fromPortalStyle=function(b,a){var c=new n(a&&a.properties);c._set("styleOrigin",Object.freeze({styleName:b}));c._set("portal",a&&a.portal||v.getDefault());a=c.populateFromStyle();a.catch(function(a){h.error("#fromPortalStyle('"+b+"'[, ...])","Failed to create unique value renderer from style name",
a)});return a};a.fromStyleUrl=function(b,a){a=new n(a&&a.properties);a._set("styleOrigin",Object.freeze({styleUrl:b}));a=a.populateFromStyle();a.catch(function(a){h.error("#fromStyleUrl('"+b+"'[, ...])","Failed to create unique value renderer from style URL",a)});return a};var n;d([f.property({readOnly:!0,dependsOn:["valueExpression"]})],a.prototype,"_cache",null);d([f.enumeration.serializable()({uniqueValue:"unique-value"})],a.prototype,"type",void 0);d([f.property({types:{base:u.BaseSymbol,key:"type",
typeMap:{"simple-fill":k.symbolTypesRenderer.typeMap["simple-fill"],"picture-fill":k.symbolTypesRenderer.typeMap["picture-fill"],"polygon-3d":k.symbolTypesRenderer.typeMap["polygon-3d"]}},json:{read:m.read,write:m.writeTarget}})],a.prototype,"backgroundFillSymbol",void 0);d([f.writer("web-scene","backgroundFillSymbol",{backgroundFillSymbol:{type:u.PolygonSymbol3D}})],a.prototype,"writeBackgroundFillSymbolWebScene",null);d([f.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],
a.prototype,"field",void 0);d([f.cast("field")],a.prototype,"castField",null);d([f.writer("field")],a.prototype,"writeField",null);d([f.property({type:String,json:{write:!0}})],a.prototype,"field2",void 0);d([f.property({type:String,json:{write:!0}})],a.prototype,"field3",void 0);d([f.property({type:String,json:{write:!0}})],a.prototype,"valueExpression",void 0);d([f.property({type:String,json:{write:!0}})],a.prototype,"valueExpressionTitle",void 0);d([f.property({type:J.default,json:{write:!0}})],
a.prototype,"legendOptions",void 0);d([f.property({type:String,json:{write:!0}})],a.prototype,"defaultLabel",void 0);d([f.property({types:k.symbolTypesRenderer})],a.prototype,"defaultSymbol",null);d([f.reader("defaultSymbol")],a.prototype,"readDefaultSymbol",null);d([f.writer("web-scene","defaultSymbol",{defaultSymbol:{types:k.symbolTypesRenderer3D}})],a.prototype,"writeDefaultSymbolWebScene",null);d([f.writer("defaultSymbol")],a.prototype,"writeDefaultSymbol",null);d([f.property({type:String,json:{write:!0}})],
a.prototype,"fieldDelimiter",void 0);d([f.property({type:v,readOnly:!0})],a.prototype,"portal",void 0);d([f.reader("portal",["styleName"])],a.prototype,"readPortal",null);d([f.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:function(){return{enabled:!0}}}}})],a.prototype,"styleOrigin",void 0);d([f.reader("styleOrigin",["styleName","styleUrl"])],a.prototype,"readStyleOrigin",null);d([f.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],a.prototype,"writeStyleOrigin",
null);d([f.property({type:[q.default],json:{write:{overridePolicy:function(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],a.prototype,"uniqueValueInfos",null);d([D(1,f.cast(k.ensureType))],a.prototype,"addUniqueValueInfo",null);return a=n=d([f.subclass("esri.renderers.UniqueValueRenderer")],a)}(f.declared(G,H))});