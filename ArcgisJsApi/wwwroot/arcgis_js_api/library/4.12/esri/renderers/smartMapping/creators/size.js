// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../.. ../../../core/Error ../../../core/promiseUtils ../../../core/screenUtils ../../../intl/substitute ./support/ageUtils ./support/utils ../heuristics/outline ../heuristics/sizeRange ../support/utils ../symbology/size ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/utils ../../visualVariables/SizeVariable".split(" "),
function(ga,C,t,A,q,G,E,f,H,F,U,w,k,K,V,p,z,L,W,X,M){function Y(b){return q(this,void 0,void 0,function(){var a,e,c,d,g,h;return A(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new f("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new f("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");
a=t({},b);e=[0,2,1,3];c=p.createLayerAdapter(a.layer,e);a.layer=c;if(!c)throw new f("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+p.getLayerTypeLabels(e).join(", "));"height"===a.axis&&(a.sizeOptimizationEnabled=!1);return[4,c.load()];case 1:m.sent();d=c.geometryType;if("mesh"===d)throw new f("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(a.worldScale){if("polyline"===d||"polygon"===d)throw new f("size-visual-variable:not-supported",
"'worldScale' sizing is not supported for polyline and polygon layers");if(!a.view||"3d"!==a.view.type)throw new f("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true");}g=p.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});if(h=k.verifyBasicFieldValidity(c,g,"size-visual-variable:invalid-parameters"))throw h;return[2,a]}})})}function Z(b){return q(this,void 0,void 0,
function(){var a,e,c,d,g,h,m;return A(this,function(n){switch(n.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new f("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new f("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=t({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=
null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;e=[0,2,1,3];c=p.createLayerAdapter(a.layer,e);a.layer=c;if(!c)throw new f("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+p.getLayerTypeLabels(e).join(", "));return[4,c.load()];case 1:n.sent();d=c.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new f("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");
if(g&&("polyline"===d||"polygon"===d))throw new f("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new f("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");h=p.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});
if(m=k.verifyBasicFieldValidity(c,h,"size-continuous-renderer:invalid-parameters"))throw m;return[2,a]}})})}function aa(b){return q(this,void 0,void 0,function(){var a,e,c,d,g,h,m,n;return A(this,function(l){switch(l.label){case 0:if(!b||!b.layer||!b.field&&!b.valueExpression)throw new f("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(b.valueExpression&&!b.view)throw new f("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");
a=t({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";a.normalizationType=p.getNormalizationType(a);e=[0,2,1,3];c=p.createLayerAdapter(a.layer,e);a.layer=c;if(!c)throw new f("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+p.getLayerTypeLabels(e).join(", "));d=null!=a.minValue&&null!=a.maxValue;if(!d&&(null!=a.minValue||null!=a.maxValue))throw new f("size-class-breaks-renderer:missing-parameters",
"Both 'minValue' and 'maxValue' are required when specifying custom data range");return[4,c.load()];case 1:l.sent();g=c.geometryType;h=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===g?a.outlineOptimizationEnabled:!1;if("mesh"===g)throw new f("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(h&&("polyline"===g||"polygon"===g))throw new f("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");
if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new f("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");m=p.getFieldsList({field:a.field,normalizationField:a.normalizationField});if(n=k.verifyBasicFieldValidity(c,m,"size-class-breaks-renderer:invalid-parameters"))throw n;return[2,a]}})})}function ba(b){b=t({},b);delete b.basemap;delete b.sizeScheme;
delete b.legendOptions;delete b.symbolType;delete b.defaultSymbolEnabled;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function N(b){b=t({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");if(b.worldScale=a)b.axis="3d-volumetric-uniform"===b.symbolType?"all":"height";delete b.symbolType;delete b.defaultSymbolEnabled;return b}function ca(b){return q(this,void 0,void 0,function(){var a,e,c,d,g,h;return A(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&b.endTime))throw new f("size-age-renderer:missing-parameters",
"'layer', 'view', 'startTime', 'endTime' parameters are required");a=t({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;e=[0,2,1,3];c=p.createLayerAdapter(a.layer,e);a.layer=c;if(!c)throw new f("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+p.getLayerTypeLabels(e).join(", "));return[4,c.load()];case 1:m.sent();d=c.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===d?
a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new f("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(g&&("polyline"===d||"polygon"===d))throw new f("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new f("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");
if(h=w.verifyDates(c,a.startTime,a.endTime,"size-age-renderer:invalid-parameters"))throw h;if(a.unit&&-1===w.supportedAgeUnits.indexOf(a.unit))throw new f("size-age-renderer:invalid-unit","Supported units are: "+w.supportedAgeUnits.join(", "));return[2,a]}})})}function O(b){var a=b.sizeScheme,e=b.basemap;a?a=z.cloneScheme(a):(a=(b=z.getSchemes({basemap:b.basemap,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view}))&&b.primaryScheme,e=b&&b.basemapId);return{scheme:a,basemapId:e}}function P(b,
a){var e;switch(a){case "point":case "multipoint":e=[b.minSize,b.maxSize];break;case "polyline":e=[b.minWidth,b.maxWidth];break;case "polygon":e=[b.marker.minSize,b.marker.maxSize]}return e}function da(b,a,e,c){return q(this,void 0,void 0,function(){var d,g,h,m,n,l,I,x,p,u,Q,r,v,q,y,D,B,t,w,R;return A(this,function(ha){d=c.layer;g=c.field;h="function"===typeof g;n=(m=g&&!h?d.getField(g):null)&&"date"===m.type;l=d.geometryType;I=O({basemap:c.basemap,geometryType:l,sizeScheme:c.sizeScheme,worldScale:c.worldScale,
view:c.view});x=I.scheme;if(!x)throw new f("size-visual-variable:insufficient-info","Unable to find size scheme");u=(p=a&&[a.minSize,a.maxSize])||P(x,l);r=(Q=k.getDefaultDataRange(b,n,!1))||[b.min,b.max];v=[];y=(q="height"===c.axis)?c.axis:void 0;D=u[0];B=u[1];q&&"number"===typeof D&&"number"===typeof B&&(t=k.getSizeRangeForAxis({minSize:D,maxSize:B},y),v.push(new M({axis:"width-and-depth",minSize:t.minSize})),B=t.maxSize);v.unshift(new M({field:g,valueExpression:c.valueExpression,valueExpressionTitle:c.valueExpressionTitle,
valueUnit:"unknown",normalizationField:e,axis:y,minSize:D,maxSize:B,minDataValue:r[0],maxDataValue:r[1],legendOptions:c.legendOptions}));w=new W({type:"size",minSliderValue:b.min,maxSliderValue:b.max});R=new L({visualVariables:[w]});return[2,{basemapId:I.basemapId,visualVariables:v,statistics:b,defaultValuesUsed:!!Q,sizeScheme:z.cloneScheme(x),authoringInfo:R}]})})}function S(b,a,e,c,d){var g=d.field,h=d.layer.geometryType,m=d.defaultSymbolEnabled,n=z.cloneScheme(b.sizeScheme),l="polygon"===h,f=l?
n.marker:n,n=l?n.background:null,l=l?"point":h,x=a&&a.opacity,p=b.visualVariables.map(function(a){return a.clone()});a&&a.visualVariables&&a.visualVariables.length&&p.push.apply(p,a.visualVariables.map(function(a){return a.clone()}));return{renderer:new E.ClassBreaksRenderer({backgroundFillSymbol:n&&k.createSymbol(h,{type:d.symbolType,color:n.color,outline:k.getSymbolOutlineFromScheme(n,h,x)}),classBreakInfos:[{minValue:-T,maxValue:T,symbol:k.createSymbol(l,{type:d.symbolType,color:f.color,size:k.getSymbolSizeFromScheme(f,
l),outline:k.getSymbolOutlineFromScheme(f,l,x)})}],defaultLabel:m?G.other:null,defaultSymbol:m?k.createSymbol(l,{type:d.symbolType,color:f.noDataColor,size:k.getSymbolSizeFromScheme(f,l,!0),outline:k.getSymbolOutlineFromScheme(f,l,x)}):null,field:g,normalizationField:c,normalizationType:e,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,visualVariables:p,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),visualVariables:b.visualVariables.map(function(a){return a.clone()}),
statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,sizeScheme:z.cloneScheme(b.sizeScheme),basemapId:b.basemapId}}function ea(b,a){var e=F.toPt(b.minSize);b=(F.toPt(b.maxSize)-e)/(4<=a?a-1:a);for(var c=[],d=0;d<a;d++)c.push(e+b*d);return c}function fa(b,a){var e=b.defaultSymbolEnabled,c=b.layer.geometryType,d="polygon"===c,g=-1<b.symbolType.indexOf("3d-volumetric"),h=O({basemap:b.basemap,geometryType:c,sizeScheme:b.sizeScheme,worldScale:g,view:b.view}),f=h.scheme,n=a.result,l=a.outlineResult,
p=n.classBreakInfos,x=b.classificationMethod,q=b.normalizationType,u=d?f.marker:f,t=d?f.background:null,r=d?"point":c,d=P(u,r),v=g&&k.getSizeRangeForAxis({minSize:d[0],maxSize:d[1]},"height"),w=ea({minSize:d[0],maxSize:g?v.maxSize:d[1]},p.length),y=l&&l.opacity,e=new E.ClassBreaksRenderer({backgroundFillSymbol:t&&k.createSymbol(c,{type:b.symbolType,color:t.color,outline:k.getSymbolOutlineFromScheme(t,c,y)}),classBreakInfos:p.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,symbol:k.createSymbol(r,
{type:b.symbolType,color:u.color,size:w[c],widthAndDepth:v&&v.minSize,outline:k.getSymbolOutlineFromScheme(u,r,y)}),label:a.label}}),defaultLabel:e?G.other:null,defaultSymbol:e?k.createSymbol(r,{type:b.symbolType,color:u.noDataColor,size:k.getSymbolSizeFromScheme(u,r,!0),widthAndDepth:v&&v.minSize,outline:k.getSymbolOutlineFromScheme(u,r,y)}):null,field:b.field,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationType:q,normalizationField:b.normalizationField,
normalizationTotal:"percent-of-total"===q?n.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new L({type:"class-breaks-size",classificationMethod:x,standardDeviationInterval:b.standardDeviationInterval})});"standard-deviation"!==x&&X.setLabelsForClassBreaks({classBreakInfos:e.classBreakInfos,classificationMethod:x,normalizationType:q,round:!0});l&&l.visualVariables&&l.visualVariables.length&&(e.visualVariables=l.visualVariables.map(function(a){return a.clone()}));return{renderer:e,
sizeScheme:z.cloneScheme(f),classBreaksResult:n,defaultValuesUsed:a.defaultValuesUsed,basemapId:h.basemapId}}function J(b){return q(this,void 0,void 0,function(){var a,e,c,d,f,h,m,n;return A(this,function(g){switch(g.label){case 0:return[4,Y(b)];case 1:return a=g.sent(),e=a.view,c=a.layer,f=(d=a.normalizationField)?"field":void 0,[4,H.all([a.statistics?a.statistics:k.getSummaryStatistics({layer:c,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:f,
normalizationField:d,minValue:a.minValue,maxValue:a.maxValue,view:e}),a.sizeOptimizationEnabled?V({view:e,layer:c}):null])];case 2:return h=g.sent(),m=h[0],n=h[1],[2,da(m,n,d,a)]}})})}Object.defineProperty(C,"__esModule",{value:!0});var T=Math.pow(2,53)-1;C.createVisualVariables=J;C.createContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,e,c,d,f,h,m;return A(this,function(g){switch(g.label){case 0:return[4,Z(b)];case 1:return a=g.sent(),e={layer:a.layer,view:a.view},[4,H.all([J(N(a)),
a.outlineOptimizationEnabled?K(e):null])];case 2:return c=g.sent(),d=c[0],f=c[1],m=(h=a.normalizationField)?"field":void 0,[2,S(d,f,m,h,a)]}})})};C.createClassBreaksRenderer=function(b){return q(this,void 0,void 0,function(){var a,e;return A(this,function(c){switch(c.label){case 0:return[4,aa(b)];case 1:return a=c.sent(),[4,k.getClassBreaks(ba(a),a.outlineOptimizationEnabled)];case 2:return e=c.sent(),[2,fa(a,e)]}})})};C.createAgeRenderer=function(b){return q(this,void 0,void 0,function(){var a,e,
c,d,f,h,m,n,l,k,p,q,u,z,r,v,C,y,D,B,E,F;return A(this,function(g){switch(g.label){case 0:return[4,ca(b)];case 1:a=g.sent();e=a.defaultSymbolEnabled;c=a.view;d=a.layer;f=a.startTime;h=a.endTime;m=a.symbolType;n={layer:a.layer,view:a.view};u=(q=H).all;if(!a.unit)return[3,2];z={unit:a.unit,statistics:null,valueExpression:null};return[3,4];case 2:return[4,w.getSuggestedAgeUnit({view:c,layer:d,startTime:f,endTime:h})];case 3:z=g.sent(),g.label=4;case 4:return[4,u.apply(q,[[z,a.outlineOptimizationEnabled?
K(n):null]])];case 5:return l=g.sent(),k=l[0],p=l[1],r=k.unit,v=k.statistics,y=(C=k.valueExpression)||w.getAgeExpressions({layer:d,startTime:f,endTime:h,unit:r}).valueExpression,D=U.substitute(G["ageInfo_"+r],{unit:r,startTime:w.formatDate(f,r,d),endTime:w.formatDate(h,r,d)}),[4,J(N({layer:d,basemap:a.basemap,valueExpression:y,symbolType:m,statistics:v,legendOptions:{title:D},sizeScheme:a.sizeScheme,view:a.view}))];case 6:return B=g.sent(),E={layer:d,valueExpression:y,defaultSymbolEnabled:e,symbolType:m},
F=S(B,p,null,null,E),[2,t({},F,{unit:r})]}})})}});