// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/assignHelper ../.. ../../../core/Error ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./support/dotDensityUtils ./support/utils ../heuristics/outline ../statistics/spatialStatistics ../statistics/summaryStatisticsForAttributes ../statistics/support/attributeDensity ../support/utils ../symbology/dotDensity ../../support/AuthoringInfo".split(" "),function(P,
A,r,p,E,F,t,y,B,u,C,G,H,I,J,z,D,K){function L(b){return p(this,void 0,void 0,function(){var a,c,f,h;return r(this,function(e){switch(e.label){case 0:if(!(b&&b.layer&&b.view&&b.attributes&&b.attributes.length))throw new t("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(8<b.attributes.length)throw new t("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");a=E({},b);c=[2,1];f=z.createLayerAdapter(a.layer,
c);a.layer=f;a.dotBlendingEnabled=null==a.dotBlendingEnabled?!0:a.dotBlendingEnabled;a.dotValueOptimizationEnabled=null==a.dotValueOptimizationEnabled?!0:a.dotValueOptimizationEnabled;if(!f)throw new t("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+z.getLayerTypeLabels(c).join(", "));return[4,y.all([a.view.when(),f.load()])];case 1:e.sent();h=f.geometryType;if("polygon"!==h)throw new t("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");
return[2,a]}})})}function M(b){var a=b.dotDensityScheme,c=b.basemap;a?a=D.cloneScheme(a):(a=(b=D.getSchemes({basemap:b.basemap,numColors:b.attributes.length}))&&b.primaryScheme,c=b&&b.basemapId);return{scheme:a,basemapId:c}}function N(b){return p(this,void 0,void 0,function(){var a,c,f,h,e,k,q,l,d,g,n,v;return r(this,function(m){switch(m.label){case 0:return a=b.view,c=b.layer,f=b.attributes,[4,c.getSampleFeatures({view:a,sampleSize:500})];case 1:return h=m.sent(),[4,y.all([H({features:h,geometryType:c.geometryType}),
I({layer:c,attributes:f,view:a})])];case 2:e=m.sent();k=e[0];q=e[1];l="avgSize"in k&&k.avgSize;d=q.avg;if(!l)throw new t("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!d)throw new t("dot-density-renderer:insufficient-info","Average attribute value is invalid");g=B.getResolutionForScale(a.scale,a.spatialReference);n=l*l/(g*g)*.1;v=u.roundValue(d/n);return[2,{dotValue:v||1,referenceScale:a.scale,minSliderValue:1,maxSliderValue:u.roundValue(d)}]}})})}function O(b){return p(this,
void 0,void 0,function(){var a,c,f,h,e,k,q,l,d,g,n,v,m,w;return r(this,function(x){switch(x.label){case 0:a=b.view;c=b.layer;f=b.attributes;h=[];e=0;for(k=f;e<k.length;e++)q=k[e],h.push.apply(h,z.getFieldsList({field:q.field,valueExpression:q.valueExpression}));return[4,c.getSampleFeatures({view:a,sampleSize:500,requiredFields:h})];case 1:return l=x.sent(),[4,J(l,f,a)];case 2:d=x.sent();if(!d.avgDensity||!d.minDensity||!d.maxDensity)throw new t("dot-density-renderer:insufficient-info","Invalid density values");
g=B.getResolutionForScale(a.scale,a.spatialReference);n=g*g;v=u.roundValue(d.minDensity*n);m=u.roundValue(d.maxDensity*n);w=u.roundValue(d.avgDensity*n*10)||1;w>m&&(w=m);return[2,{dotValue:w,referenceScale:a.scale,minSliderValue:v,maxSliderValue:m}]}})})}Object.defineProperty(A,"__esModule",{value:!0});A.createRenderer=function(b){return p(this,void 0,void 0,function(){var a,c,f,h,e,k,q,l,d,g,n,v,m,w,x,u,p;return r(this,function(r){switch(r.label){case 0:return[4,L(b)];case 1:a=r.sent();c=a.layer;
f=c.geometryType;e=(h=M(a))&&h.scheme;if(!e)throw new t("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");k={layer:c,view:a.view,attributes:a.attributes};q={layer:a.layer,view:a.view};return[4,y.all([a.trueDensity?O(k):N(k),a.outlineOptimizationEnabled?G(q):null])];case 2:return l=r.sent(),d=l[0],g=l[1],n=d.dotValue,v=d.referenceScale,m=d.minSliderValue,w=d.maxSliderValue,x=C.createColors(e.colors,a.attributes.length),u=a.attributes.map(function(a,b){return{field:a.field,
valueExpression:a.valueExpression,label:a.label,valueExpressionTitle:a.valueExpressionTitle,color:x[b]}}),p=new F.DotDensityRenderer({attributes:u,dotBlendingEnabled:a.dotBlendingEnabled,outline:g?C.getSymbolOutlineFromScheme(e,f,g.opacity):null,dotValue:n,referenceScale:a.dotValueOptimizationEnabled?v:null,legendOptions:a.legendOptions}),g&&g.visualVariables&&g.visualVariables.length&&(p.visualVariables=g.visualVariables.map(function(a){return a.clone()})),p.authoringInfo=new K({type:"dot-density",
minSliderValue:m,maxSliderValue:w}),[2,{renderer:p,dotDensityScheme:e,basemapId:h.basemapId}]}})})}});