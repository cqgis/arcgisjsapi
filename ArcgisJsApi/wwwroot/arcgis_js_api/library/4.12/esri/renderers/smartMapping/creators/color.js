// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../.. ../../../pointCloudRenderers ../../../core/Error ../../../core/promiseUtils ../../../intl/substitute ./support/ageUtils ./support/utils ../heuristics/outline ../support/utils ../symbology/color ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/numberUtils ../../support/utils ../../visualVariables/ColorVariable".split(" "),
function(Z,q,r,w,p,G,F,B,h,m,M,x,f,J,n,t,C,N,O,y,P){function Q(b){if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))return m.reject(f.createError("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));if(b.valueExpression&&!b.sqlExpression&&!b.view)return m.reject(f.createError("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified"));var a=r({},b);b=[0,2,1,3];var c=n.createLayerAdapter(a.layer,
b);return(a.layer=c)?c.load().then(function(){if("mesh"!==c.geometryType&&a.worldScale&&(!a.view||"3d"!==a.view.type))return m.reject(f.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"));var b=n.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});return(b=f.verifyBasicFieldValidity(c,b,"color-visual-variable:invalid-parameters"))?m.reject(b):a}):m.reject(f.createError("color-visual-variable:invalid-parameters",
"'layer' must be one of these types: "+n.getLayerTypeLabels(b).join(", ")))}function R(b){return p(this,void 0,void 0,function(){var a,c,e,d,u,g;return w(this,function(l){switch(l.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new h("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new h("color-continuous-renderer:missing-parameters",
"View is required when 'valueExpression' is specified");a=r({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new h("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(c).join(", "));return[4,e.load()];case 1:l.sent();d=e.geometryType;a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===
d)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==d)throw new h("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");
}u=n.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});if(g=f.verifyBasicFieldValidity(e,u,"color-continuous-renderer:invalid-parameters"))throw g;return[2,a]}})})}function S(b){return p(this,void 0,void 0,function(){var a,c,e,d,u,g,l;return w(this,function(k){switch(k.label){case 0:if(!b||!b.layer||!b.field&&!b.valueExpression)throw new h("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");
if(b.valueExpression&&!b.view)throw new h("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=r({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";a.normalizationType=n.getNormalizationType(a);c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new h("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+
n.getLayerTypeLabels(c).join(", "));d=null!=a.minValue&&null!=a.maxValue;if(!d&&(null!=a.minValue||null!=a.maxValue))throw new h("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return[4,e.load()];case 1:k.sent();u=e.geometryType;a.outlineOptimizationEnabled="polygon"===u?a.outlineOptimizationEnabled:!1;if("mesh"===u)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";
else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==u)throw new h("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}g=n.getFieldsList({field:a.field,normalizationField:a.normalizationField});
if(l=f.verifyBasicFieldValidity(e,g,"color-class-breaks-renderer:invalid-parameters"))throw l;return[2,a]}})})}function T(b){b=r({},b);delete b.basemap;delete b.colorScheme;delete b.legendOptions;delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function U(b){if(!b||!b.layer)return m.reject(f.createError("color-point-cloud-true-color-renderer:missing-parameters","'layer' parameter is required"));
var a=r({},b);b=[4];var c=n.createLayerAdapter(a.layer,b);a.layer=c;a.density=a.density||25;a.size=a.size||"100%";return f.isValidPointSize(a.size)?c?c.load().then(function(){return a}):m.reject(f.createError("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(b).join(", "))):m.reject(f.createError("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function V(b){if(!(b&&
b.layer&&b.field))return m.reject(f.createError("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required"));var a=b.field.toLowerCase();if("intensity"!==a&&"elevation"!==a)return m.reject(f.createError("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'"));var c=r({},b);b=[4];a=n.createLayerAdapter(c.layer,b);c.layer=a;c.density=c.density||25;c.size=c.size||"100%";return f.isValidPointSize(c.size)?
a?a.load().then(function(){return c}):m.reject(f.createError("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(b).join(", "))):m.reject(f.createError("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function K(b){b=r({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;
b.worldScale=a;return b}function W(b){return p(this,void 0,void 0,function(){var a,c,e,d,f;return w(this,function(g){switch(g.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&b.endTime))throw new h("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");a=r({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];e=n.createLayerAdapter(a.layer,c);a.layer=e;if(!e)throw new h("color-age-renderer:invalid-parameters",
"'layer' must be one of these types: "+n.getLayerTypeLabels(c).join(", "));return[4,e.load()];case 1:g.sent();d=e.geometryType;a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else if("3d-volumetric-uniform"===a.symbolType&&"point"!==d)throw new h("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");
if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");if(f=x.verifyDates(e,a.startTime,a.endTime,"color-age-renderer:invalid-parameters"))throw f;if(a.unit&&-1===x.supportedAgeUnits.indexOf(a.unit))throw new h("color-age-renderer:invalid-unit","Supported units are: "+x.supportedAgeUnits.join(", "));
return[2,a]}})})}function z(b,a){var c=b.colorScheme,e=b.basemap;if(c)c=t.cloneScheme(c);else{a=a||b.theme||"high-to-low";var d=t.getSchemes({theme:a,basemap:b.basemap,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view});d&&(e=d.basemapId,c=b.schemeId?t.getSchemeById({id:a+"/"+e+"/"+b.schemeId,geometryType:b.geometryType}):d.primaryScheme)}return{scheme:c,basemapId:e}}function D(b,a,c){for(var e=(a-b)/(c-1),d=[b],f=1;f<=c-2;f++)d.push(b+f*e);d.push(a);return O.round(d,{strictBounds:!0})}
function L(b,a,c,e,d){var u=d.field,g=d.layer.geometryType,l=d.defaultSymbolEnabled,k=t.cloneScheme(b.colorScheme),m=a&&a.opacity,h=[b.visualVariable.clone()];a&&a.visualVariables&&a.visualVariables.length&&h.push.apply(h,a.visualVariables.map(function(a){return a.clone()}));return{renderer:new F.ClassBreaksRenderer({classBreakInfos:[{minValue:-E,maxValue:E,symbol:f.createSymbol(g,{type:d.symbolType,color:k.noDataColor,size:f.getSymbolSizeFromScheme(k,g),outline:f.getSymbolOutlineFromScheme(k,g,m),
meshInfo:{colorMixMode:d.colorMixMode,edgesType:d.edgesType}})}],defaultLabel:l?G.other:null,defaultSymbol:l?f.createSymbol(g,{type:d.symbolType,color:k.noDataColor,size:f.getSymbolSizeFromScheme(k,g),outline:f.getSymbolOutlineFromScheme(k,g,m),meshInfo:{colorMixMode:d.colorMixMode,edgesType:d.edgesType}}):null,field:u,normalizationType:c,normalizationField:e,valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,visualVariables:h,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),
visualVariable:b.visualVariable.clone(),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,colorScheme:t.cloneScheme(b.colorScheme),basemapId:b.basemapId}}function H(b){return Q(b).then(function(a){var b=a.normalizationField,e=b?"field":void 0;return(a.statistics?m.resolve(a.statistics):f.getSummaryStatistics({layer:a.layer,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:e,normalizationField:b,minValue:a.minValue,maxValue:a.maxValue,
view:a.view})).then(function(c){var d=a.layer,e=a.field,l=e&&"function"!==typeof e?d.getField(e):null,k=l&&"date"===l.type,d=z({basemap:a.basemap,theme:a.theme,geometryType:d.geometryType,colorScheme:a.colorScheme,worldScale:a.worldScale,view:a.view});if(l=d.scheme){var h=f.createColors(l.colors,5);if(5>h.length)c=m.reject(f.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors"));else{var n=f.getDefaultDataRange(c,k,!0),A=-1<l.id.indexOf("seq-"),A=n?D(n[0],
n[1],5):f.createStopValues(c,A),h=f.createColors(h,5),e=new P({field:e,valueExpression:a.valueExpression,valueExpressionTitle:a.valueExpressionTitle,normalizationField:b,stops:y.createColorStops({values:A,isDate:k,dateFormatOptions:k?y.timelineDateFormatOptions:null,colors:h,labelIndexes:[0,2,4]}),legendOptions:a.legendOptions}),k=new N({type:"color",minSliderValue:c.min,maxSliderValue:c.max,theme:l.theme}),k=new C({visualVariables:[k]});c=m.resolve({basemapId:d.basemapId,visualVariable:e,statistics:c,
defaultValuesUsed:!!n,colorScheme:t.cloneScheme(l),authoringInfo:k})}}else c=m.reject(f.createError("color-visual-variable:insufficient-info","Unable to find color scheme"));return c})})}function X(b,a){b=b.colorsForClassBreaks;var c;if(b&&0<b.length&&(b.some(function(b){b.numClasses===a&&(c=b.colors);return!!c}),!c)){var e=b[b.length-1];b=a-e.numClasses;if(0<b){var d=e.colors[e.numClasses-1];c=e.colors.splice(0);for(e=1;e<=b;e++)c.push(d)}}c&&(c=f.createColors(c,c.length));return c}function Y(b,
a){return p(this,void 0,void 0,function(){var c,e,d,u,g,l,k,m,n,A,r,q,v,p;return w(this,function(w){c=b.layer;e=b.defaultSymbolEnabled;d=c.geometryType;u=z({basemap:b.basemap,geometryType:d,colorScheme:b.colorScheme,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view});g=u.scheme;l=a.result;k=a.outlineResult;m=l.classBreakInfos;n=b.classificationMethod;A="standard-deviation"===n;r=b.normalizationType;if(!g)throw new h("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");
q=X(g,m.length);if(!q||q.length!==m.length)throw new h("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");v=k&&k.opacity;p=new F.ClassBreaksRenderer({classBreakInfos:m.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,symbol:f.createSymbol(d,{type:b.symbolType,color:q[c],size:f.getSymbolSizeFromScheme(g,d),outline:f.getSymbolOutlineFromScheme(g,d,v),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}),label:a.label}}),defaultLabel:e?
G.other:null,defaultSymbol:e?f.createSymbol(d,{type:b.symbolType,color:g.noDataColor,size:f.getSymbolSizeFromScheme(g,d),outline:f.getSymbolOutlineFromScheme(g,d,v),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}):null,field:b.field,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationType:r,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===r?l.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new C({type:"class-breaks-color",
classificationMethod:n,standardDeviationInterval:b.standardDeviationInterval})});A||y.setLabelsForClassBreaks({classBreakInfos:p.classBreakInfos,classificationMethod:n,normalizationType:r,round:!0});k&&k.visualVariables&&k.visualVariables.length&&(p.visualVariables=k.visualVariables.map(function(a){return a.clone()}));return[2,{renderer:p,colorScheme:t.cloneScheme(g),classBreaksResult:l,defaultValuesUsed:a.defaultValuesUsed,basemapId:u.basemapId}]})})}Object.defineProperty(q,"__esModule",{value:!0});
var E=Math.pow(2,53)-1;q.createVisualVariable=H;q.createContinuousRenderer=function(b){return p(this,void 0,void 0,function(){var a,c,e,d,f,g,l;return w(this,function(k){switch(k.label){case 0:return[4,R(b)];case 1:return a=k.sent(),c={layer:a.layer,view:a.view},[4,m.all([H(K(a)),a.outlineOptimizationEnabled?J(c):null])];case 2:return e=k.sent(),d=e[0],f=e[1],l=(g=a.normalizationField)?"field":void 0,[2,L(d,f,l,g,a)]}})})};q.createClassBreaksRenderer=function(b){return p(this,void 0,void 0,function(){var a,
c;return w(this,function(e){switch(e.label){case 0:return[4,S(b)];case 1:return a=e.sent(),[4,f.getClassBreaks(T(a),a.outlineOptimizationEnabled)];case 2:return c=e.sent(),[2,Y(a,c)]}})})};q.createPCTrueColorRenderer=function(b){return U(b).then(function(a){return{renderer:new B.PointCloudRGBRenderer({field:"RGB",pointsPerInch:a.density,pointSizeAlgorithm:f.getPointSizeAlgorithm(a.size)})}})};q.createPCContinuousRenderer=function(b){return V(b).then(function(a){return(a.statistics?m.resolve(a.statistics):
f.getSummaryStatistics({layer:a.layer,field:a.field})).then(function(b){var c=z({basemap:a.basemap,colorScheme:a.colorScheme,geometryType:a.layer.geometryType,schemeId:"elevation"===a.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"}),d=c.scheme;if(d){var h=f.createColors(d.colors,5);if(5>h.length)b=m.reject(f.createError("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors"));else{var g=f.getDefaultDataRange(b,!1,!0),
l=g?D(g[0],g[1],5):f.createStopValues(b),h=y.createColorStops({values:l,isDate:!1,dateFormatOptions:null,colors:h,labelIndexes:[0,2,4]});b=m.resolve({stops:h,basemapId:c.basemapId,statistics:b,defaultValuesUsed:!!g,colorScheme:t.cloneScheme(d)})}}else b=m.reject(f.createError("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme"));return b}).then(function(b){return{renderer:new B.PointCloudStretchRenderer({field:a.field,pointsPerInch:a.density,pointSizeAlgorithm:f.getPointSizeAlgorithm(a.size),
stops:b.stops}),basemapId:b.basemapId,statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,colorScheme:b.colorScheme}})})};q.createAgeRenderer=function(b){return p(this,void 0,void 0,function(){var a,c,e,d,f,g,h,k,n,q,p,t,y,v,z,F,I,B,C,D,E;return w(this,function(l){switch(l.label){case 0:return[4,W(b)];case 1:return a=l.sent(),c=a.defaultSymbolEnabled,e=a.view,d=a.layer,f=a.startTime,g=a.endTime,h=a.symbolType,k=a.colorMixMode,n=a.edgesType,q={layer:a.layer,view:a.view},[4,m.all([a.unit?
{unit:a.unit,statistics:null,valueExpression:null}:x.getSuggestedAgeUnit({view:e,layer:d,startTime:f,endTime:g}),a.outlineOptimizationEnabled?J(q):null])];case 2:return p=l.sent(),t=p[0],y=p[1],v=t.unit,z=t.statistics,I=(F=t.valueExpression)||x.getAgeExpressions({layer:d,startTime:f,endTime:g,unit:v}).valueExpression,B=M.substitute(G["ageInfo_"+v],{unit:v,startTime:x.formatDate(f,v,d),endTime:x.formatDate(g,v,d)}),[4,H(K({layer:d,basemap:a.basemap,valueExpression:I,symbolType:h,statistics:z,legendOptions:{title:B},
colorScheme:a.colorScheme,theme:a.theme,view:e}))];case 3:return C=l.sent(),D={layer:d,valueExpression:I,defaultSymbolEnabled:c,symbolType:h,colorMixMode:k,edgesType:n},E=L(C,y,null,null,D),[2,r({},E,{unit:v})]}})})}});