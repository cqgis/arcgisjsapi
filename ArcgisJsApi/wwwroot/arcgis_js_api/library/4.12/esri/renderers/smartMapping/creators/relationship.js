// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../../../core/Error ../../../core/lang ../../../core/promiseUtils ./type ./support/utils ../support/utils ../symbology/relationship ../../support/AuthoringInfo ../../support/AuthoringInfoClassBreakInfo ../../support/AuthoringInfoFieldInfo ../../../symbols/support/utils".split(" "),function(ca,u,J,p,n,K,h,N,O,P,r,w,z,Q,x,A,R){function S(b){return n(this,
void 0,void 0,function(){var a,c,d,e,f,g,l,k,q;return p(this,function(m){switch(m.label){case 0:if(!(b&&b.layer&&b.view&&b.field1&&b.field2))throw new h("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");a=J({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"quantile";a.numClasses=a.numClasses||3;a.focus=a.focus||null;if(-1===T.indexOf(a.classificationMethod))throw new h("relationship-renderer:invalid-parameters",
"classification method "+a.classificationMethod+" is not supported");if(2>a.numClasses||4<a.numClasses)throw new h("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(b.focus&&-1===U.indexOf(b.focus))throw new h("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");c=[0,2,1,3];d=w.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new h("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(c).join(", "));
return[4,d.load()];case 1:m.sent();e=d.geometryType;f=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new h("relationship-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(f&&"polygon"===e)throw new h("relationship-renderer:not-supported",
"3d symbols are not supported for polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}g=a.field1;l=a.field2;k=[g.field,l.field];g.normalizationField&&k.push(g.normalizationField);l.normalizationField&&k.push(l.normalizationField);if(q=r.verifyBasicFieldValidity(d,k,"relationship-renderer:invalid-parameters"))throw q;
return[2,a]}})})}function V(b){return n(this,void 0,void 0,function(){var a,c,d,e,f,g;return p(this,function(l){if(!(b&&b.renderer&&b.numClasses))throw new h("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");a=b.field1;c=b.field2;d=b.renderer;e=b.numClasses;f=b.colors;g=Math.pow(e,2);if((a||c)&&!(a&&c&&a.field&&c.field))throw new h("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(a&&!a.classBreakInfos||
c&&!c.classBreakInfos)throw new h("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!d.authoringInfo)throw new h("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");if(d.uniqueValueInfos.length!==g)throw new h("update-relationship-renderer:invalid-parameters","Renderer must have "+g+" unique value infos to support "+e+" classes");if(f&&f.length!==g)throw new h("update-relationship-renderer:invalid-parameters",
"The scheme must have "+g+" colors");return[2,b]})})}function B(b,a){b=N.clone(W[b]);return z.flatten2DArray(b,a)}function X(b,a){return B(b,a).map(function(a){return{value:a,count:0}})}function L(b,a,c,d){var e=b.field;b=b.normalizationField;var f=a.field;a=a.normalizationField;c=c.map(function(a){return[a.minValue,a.maxValue]});d=d.map(function(a){return[a.minValue,a.maxValue]});var g=Y[c.length];return"\n  var field1 \x3d $feature['"+e+"'];\n  var field2 \x3d $feature['"+f+"'];\n  var hasNormField1 \x3d "+
(b?"true":"false")+";\n  var hasNormField2 \x3d "+(a?"true":"false")+";\n  var normField1 \x3d "+(b?"$feature['"+b+"']":"null")+";\n  var normField2 \x3d "+(a?"$feature['"+a+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 \x26\x26 (IsEmpty(normField1) || normField1 \x3d\x3d 0)) ||\n    (hasNormField2 \x26\x26 (IsEmpty(normField2) || normField2 \x3d\x3d 0))\n  ) {\n    return null;\n  }\n\n  var value1 \x3d IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 \x3d IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 \x3d "+
JSON.stringify(c)+";\n  var breaks2 \x3d "+JSON.stringify(d)+";\n  var classCodes \x3d "+JSON.stringify(g)+";\n\n  function getClassCode(value, breaks) {\n    var code \x3d null;\n\n    for (var i in breaks) {\n      var info \x3d breaks[i];\n      if (value \x3e\x3d info[0] \x26\x26 value \x3c\x3d info[1]) {\n        code \x3d classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 \x3d getClassCode(value1, breaks1);\n  var code2 \x3d getClassCode(value2, breaks2);\n\n  var classValue \x3d IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}
function Z(b,a,c){return n(this,void 0,void 0,function(){var d,e,f,g,l,k,q,m,t,C,M,n,r,D,E,u,w,F,H,I,x;return p(this,function(v){switch(v.label){case 0:e=b.basemap;f=b.classificationMethod;g=b.field1;l=b.field2;k=b.focus;q=b.numClasses;m=b.layer;t=a.classBreakInfos;C=c.classBreakInfos;if(q!==t.length||t.length!==C.length)throw new h("relationship-renderer:error","incompatible class breaks");M=X(q,k);n=L(b.field1,b.field2,t,C);v=e;var p=m.geometryType,y=b.relationshipScheme,A=-1<b.symbolType.indexOf("3d-volumetric"),
B=b.view;y=y?z.cloneScheme(y):(v=z.getSchemes({basemap:v,geometryType:p,theme:"default",worldScale:A,view:B}))&&v.primaryScheme;r=d=y;return[4,P.createRenderer({layer:m,basemap:e,valueExpression:n,valueExpressionTitle:K.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:b.defaultSymbolEnabled,typeScheme:J({colors:z.getColors(r,q,k)},r),statistics:{uniqueValueInfos:M},legendOptions:b.legendOptions,outlineOptimizationEnabled:b.outlineOptimizationEnabled,symbolType:b.symbolType,
colorMixMode:b.colorMixMode,edgesType:b.edgesType,view:b.view})];case 1:D=v.sent();E=D.renderer;u=E.uniqueValueInfos;w=K.relationship;F=0;for(H=u;F<H.length;F++)I=H[F],I.label=w[I.value];x=new Q({type:"relationship",classificationMethod:f,numClasses:q,focus:k,field1:{field:g.field,normalizationField:g.normalizationField,classBreakInfos:t.map(G)},field2:{field:l.field,normalizationField:l.normalizationField,classBreakInfos:C.map(G)}});E.authoringInfo=x;return[2,{renderer:E,classBreaks:{field1:a,field2:c},
uniqueValueInfos:D.uniqueValueInfos,relationshipScheme:r,basemapId:D.basemapId}]}})})}function aa(b,a,c){var d=B(a,c);b.sort(function(a,b){a=d.indexOf(a.value);b=d.indexOf(b.value);var c=0;a<b?c=-1:a>b&&(c=1);return c})}function ba(b,a){var c=b.authoringInfo;c.numClasses=a.numClasses;c.focus=a.focus||null;c.focus||delete c.focus;var d=a.field1;a=a.field2;c.field1=new A.default({field:d.field,normalizationField:d.normalizationField,classBreakInfos:d.classBreakInfos.map(function(a){return new x.default(G(a))})});
c.field2=new A.default({field:a.field,normalizationField:a.normalizationField,classBreakInfos:a.classBreakInfos.map(function(a){return new x.default(G(a))})});b.authoringInfo=c}Object.defineProperty(u,"__esModule",{value:!0});var T=["equal-interval","natural-breaks","quantile"],U=["HH","HL","LH","LL"],W={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},Y={2:["L",
"H"],3:["L","M","H"],4:["L","M1","M2","H"]},G=function(b){return{minValue:b.minValue,maxValue:b.maxValue}};u.updateRenderer=function(b){return n(this,void 0,void 0,function(){var a,c,d,e,f,g,l,k,h;return p(this,function(m){switch(m.label){case 0:return[4,V(b)];case 1:return a=m.sent(),c=a.field1,d=a.field2,e=a.renderer,f=a.numClasses,g=a.focus,l=a.colors,k=e.clone(),k.valueExpression=L(c,d,c.classBreakInfos,d.classBreakInfos),aa(k.uniqueValueInfos,f,g),l&&(h=r.createColors(l,l.length),k.uniqueValueInfos.forEach(function(a,
b){return R.applyColorToSymbol(a.symbol,h[b])})),ba(k,a),[2,k]}})})};u.createRenderer=function(b){return n(this,void 0,void 0,function(){var a,c,d,e,f,g,l,k,q,m,t,n;return p(this,function(p){switch(p.label){case 0:return[4,S(b)];case 1:return a=p.sent(),c=a.layer,d=a.classificationMethod,e=a.field1,f=a.field2,g=a.numClasses,l=a.view,k={layer:c,classificationMethod:d,field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationField?"field":null,minValue:e.minValue,maxValue:e.maxValue,
analyzeData:!(null!=e.minValue&&null!=e.maxValue),numClasses:g,view:l},q={layer:c,classificationMethod:d,field:f.field,normalizationField:f.normalizationField,normalizationType:f.normalizationField?"field":null,minValue:f.minValue,maxValue:f.maxValue,analyzeData:!(null!=f.minValue&&null!=f.maxValue),numClasses:g,view:l},[4,O.all([r.getClassBreaks(k),r.getClassBreaks(q)])];case 2:m=p.sent();t=m[0];n=m[1];if(!t||!n)throw new h("relationship-renderer:error","error when calculating class breaks");return[2,
Z(a,t.result,n.result)]}})})}});