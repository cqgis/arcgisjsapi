// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/promiseUtils ../../utils ../../../../support/heatmapUtils ../../../../../support/arcadeUtils ../../../../../tasks/support/ClassBreaksDefinition ../../../../../tasks/support/generateRendererUtils".split(" "),function(R,h,I,J,D,q,K,L){function z(a,c,b){c=null==c?-Infinity:c;b=null==b?Infinity:b;return a.filter(function(a){if(null!=a&&n(a)&&a>=c&&a<=b)return a})}function r(a,c){var b=a.field,d="function"===typeof b,e=a.valueExpression,f=q.createFunction(e),
g=a.normalizationType,m=a.normalizationField,l=a.normalizationTotal,t=[],h=(a=a.view)&&q.getViewInfo({viewingMode:"2d"===a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference});if(!c)return t;c.forEach(function(a){var c=a.attributes,k;e?(k=q.createExecContext(a,h),k=q.executeFunction(f,k)):d?k=b.call(null,a):c&&(k=c[b]);g&&null!=k&&n(k)&&(c=c&&parseFloat(c[m]),"log"===g&&0!==k?k=Math.log(k)*Math.LOG10E:"percent-of-total"===g&&n(l)&&0!==l?k=k/l*100:"field"===g&&n(c)&&0!==c&&
(k/=c));t.push(k)});return t}function M(a,c){for(var b=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,e=null,f=null,g=null,m=null,l=0;l<a.length;l++)var t=a[l],e=e+t,b=Math.min(b,t),d=Math.max(d,t);if(l=a.length){f=e/l;for(m=g=0;m<a.length;m++)t=a[m],g+=Math.pow(t-f,2);m=c?1<l?g/(l-1):0:0<l?g/l:0;g=Math.sqrt(m)}else d=b=null;return{avg:f,count:l,max:d,min:b,stddev:g,sum:e,variance:m}}function A(a){var c=a.field,b=a.classificationMethod||"equal-interval",d=a.normalizationType,e=a.normalizationField,
f=new K;f.classificationField=c;f.breakCount=a.breakCount;f.classificationMethod=b;f.standardDeviationInterval="standard-deviation"===b?a.standardDeviationInterval||1:void 0;f.normalizationType=d;f.normalizationField="field"===d?e:void 0;return f}function E(a,c){var b=c.classBreaks,d=b[0].minValue,e=b[b.length-1].maxValue,f="standard-deviation"===a.classificationMethod,g=N,b=b.map(function(a){var b=a.label;a={minValue:a.minValue,maxValue:a.maxValue,label:b};if(f&&b){var c=b.match(g).map(function(a){return+a.trim()});
2===c.length?(a.minStdDev=c[0],a.maxStdDev=c[1],0>c[0]&&0<c[1]&&(a.hasAvg=!0)):1===c.length&&(-1<b.indexOf("\x3c")?(a.minStdDev=null,a.maxStdDev=c[0]):-1<b.indexOf("\x3e")&&(a.minStdDev=c[0],a.maxStdDev=null))}return a});return{minValue:d,maxValue:e,classBreakInfos:b,normalizationTotal:c.normalizationTotal}}function u(a,c,b){c=(c-a)/b;for(var d=[],e,f=1;f<=b;f++)e=a+c,e=Number(e.toFixed(16)),d.push([a,e]),a=e;return d}function F(a){var c=a.field,b=a.normalizationType,d=a.normalizationField;a=a.normalizationTotal;
var e=c;"percent-of-total"===b?e="(("+c+" / "+a+") * 100)":"log"===b?e="(log("+c+") * "+O+")":"field"===b&&(e="("+c+" / "+d+")");return e}function P(a,c){for(var b=-1,d=a.length-1;0<=d;d--)if(c>=a[d][0]){b=d;break}return b}function G(a,c){var b;c=c.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()!==c){b=a[d];break}return b}function v(a,c){var b;c=c.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()===c){b=a[d];break}return b}function x(a,c){if(c)for(var b in a)a[b].label=c[b];return{count:a}}
function H(a,c,b,d){var e=a.count;a=[];d&&b&&"coded-value"===b.type&&b.codedValues.forEach(function(a){a=a.code;e.hasOwnProperty(a)||(e[a]={data:a,count:0})});for(var f in e)b=e[f],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function n(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}Object.defineProperty(h,"__esModule",{value:!0});var Q=/_value$/i,N=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,O=Math.LOG10E;h.statisticTypes="min max avg stddev count sum variance".split(" ");
h.getSummaryStatisticsFromFeatureSet=function(a,c){a=(a=a&&a.features)&&a[0]&&a[0].attributes;var b={},d;for(d in a)b[d.replace(Q,"").toLowerCase()]=a[d];b.min===b.max&&null!=b.min&&null==b.stddev&&(b.stddev=b.variance=0);c&&("min max avg stddev sum variance".split(" ").forEach(function(a){null!=b[a]&&(b[a]=Math.ceil(b[a]))}),b.min===b.max&&null!=b.min&&(b.avg=b.min,b.stddev=b.variance=0));return b};h.calculateStatsFromMemory=function(a,c,b){c=r(a,c);c=z(c,a.minValue,a.maxValue);var d=M(c,!a.normalizationType);
b&&["avg","stddev","variance"].forEach(function(a){null!=d[a]&&(d[a]=Math.ceil(d[a]))});return d};h.getDataValues=r;h.processSummaryStatisticsResult=function(a){for(var c in a)-1<h.statisticTypes.indexOf(c)&&(n(a[c])||(a[c]=null));return a};h.createCBDefn=A;h.calculateHeatmapStats=function(a,c,b,d,e,f){void 0===c&&(c=10);var g=new Float64Array(e*f),m=D.createKernel(c);c=Math.round(3*c);var l=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,p=0,n=0,r=0,k=0;b=D.createValueFunction(d,b);for(d=0;d<
a.length;d++)for(var q=a[d],w=q.geometry,u=w.x-c,v=w.y-c,x=Math.max(0,u),p=Math.max(0,v),z=Math.min(f,w.y+c),w=Math.min(e,w.x+c),q=+b(q.attributes),B=p;B<z;B++)for(var A=m[B-v],C=x;C<w;C++){var p=B*e+C,y=g[p],p=g[p]+=A*m[C-u]*q,y=p-y,n=n+y,r=r+y*y;p<l&&(l=p);p>h&&(h=p);k++}return k?{mean:n/k,stdDev:Math.sqrt((r-n*n/k)/k),min:l,max:h,mid:(h-l)/2,count:k}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};h.calculateClassBreaksFromMemory=function(a,c){var b=a.normalizationTotal,d=A({field:a.field,normalizationType:a.normalizationType,
normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5});c=r(a,c);c=z(c,a.minValue,a.maxValue);b=L.createGenerateRendererClassBreaks({definition:d,values:c,normalizationTotal:b});return E(a,b)};h.resolveCBResult=E;h.getEqualIntervalBins=u;h.generateBinParams=function(a){var c=[],b=a.classBreaks,d=b[0].minValue,e=b[b.length-1].maxValue;b.forEach(function(a){c.push([a.minValue,a.maxValue])});
return{min:d,max:e,intervals:c,sqlExpr:F({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};h.getFieldExpr=F;h.calculateHistogramFromMemory=function(a,c,b){var d=c.min,e=c.max,f=c.normTotal,g=a.numBins||10,m=c.intervals||u(d,e,g);c=m.map(function(a,b){return{minValue:m[b][0],maxValue:m[b][1],count:0}});g=0;for(a=r(a,b);g<a.length;g++)b=a[g],null!=b&&b>=d&&b<=
e&&(b=P(m,b),-1<b&&c[b].count++);return{bins:c,minValue:d,maxValue:e,normalizationTotal:f}};h.getHistogramFromFeatureSet=function(a,c,b,d,e){var f={};a&&a.features&&a.features.forEach(function(a){var b=a.attributes;a=G(b,"countOFExpr");b=v(b,"countOFExpr");0!==a&&(f[a]=b)});var g=[];u(c,b,d).forEach(function(a,b){b=(b+1).toString();g.push({minValue:a[0],maxValue:a[1],count:f.hasOwnProperty(b)?f[b]:0})});return{bins:g,minValue:c,maxValue:b,normalizationTotal:e}};h.getUniqueValuesFromFeatureSet=function(a,
c,b,d){var e="countOF"+(b||"Expr"),f={},g=!1;(a&&a.features).forEach(function(a){var c=a.attributes;a=v(c,e);c=b?v(c,b):G(c,e);null===c&&0===a&&(g=!0);if(null==c||"string"===typeof c&&""===c.trim())c=null;null==f[c]?f[c]={count:a,data:c}:f[c].count+=a});return b&&g?c.queryFeatureCount(b+" is NULL").then(function(a){f["null"].count+=a||0;return x(f,d)}).catch(function(){return x(f,d)}):I.resolve(x(f,d))};h.createUVResult=H;h.calculateUniqueValuesFromMemory=function(a,c,b){var d=a.features?"features":
"features-in-memory",e={},f=0;for(c=r(a,c);f<c.length;f++){var g=c[f];if(null==g||"string"===typeof g&&""===g.trim())g=null;null==e[g]?e[g]={count:1,data:g}:e[g].count++}return H({count:e},d,b,a.returnAllCodedValues)};h.msSinceUnixEpochSQL=function(a,c){return J.getDateDiffSQL(a,new Date(0),c,"milliseconds").sqlExpression};h.isValidNumber=n});