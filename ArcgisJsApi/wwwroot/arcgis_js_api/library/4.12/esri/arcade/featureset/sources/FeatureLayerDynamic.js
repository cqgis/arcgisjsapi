// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../Graphic ../../Attachment ../polyfill/FeatureLayerAndTable ../support/FeatureSet ../support/IdSet ../support/sha ../support/shared ../support/sqlUtils ../support/sqlUtils ../support/stats ../../../core/promiseUtils ../../../layers/graphics/featureConversionUtils ../../../tasks/QueryTask ../../../tasks/operations/query ../../../tasks/support/FeatureSet ../../../tasks/support/Query ../../../tasks/support/StatisticDefinition".split(" "),
function(N,O,C,D,E,F,G,w,H,t,u,y,I,p,J,K,L,M,v,z){return function(A){function g(a){var d=A.call(this,a)||this;d.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic";d._removeGeometry=!1;d._overrideFields=null;d.formulaCredential=null;d._pageJustIds=!1;d._requestStandardised=!1;a.spatialReference&&(d.spatialReference=a.spatialReference);d._transparent=!0;d._maxProcessing=1E3;d._layer=a.layer;d._wset=null;void 0!==a.outFields&&(d._overrideFields=a.outFields);void 0!==a.includeGeometry&&
(d._removeGeometry=!1===a.includeGeometry);return d}C(g,A);g.prototype._maxQueryRate=function(){return t.defaultMaxRecords};g.prototype.end=function(){return this._layer};g.prototype.optimisePagingFeatureQueries=function(a){this._pageJustIds=a};g.prototype.convertQueryToLruCacheKey=function(a){a=t.stableStringify(a.toJSON());return(new H(a,"TEXT")).getHash("SHA-1","B64")};g.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=p.create(function(d,f){try{!0===a._layer.loaded?
(a._initialiseFeatureSet(),d(a)):(a._layer.when().then(function(){try{a._initialiseFeatureSet(),d(a)}catch(e){f(e)}},f),a._layer.load())}catch(e){f(e)}}));return this._loadPromise};g.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){for(var a=[],d=0,
f=this.fields;d<f.length;d++){var e=f[d];if("oid"===e.type)a.push(e);else for(var k=0,b=this._layer.outFields;k<b.length;k++){var h=b[k];if(h.toLowerCase()===e.name.toLowerCase()){a.push(e);break}}}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];d=[];f=0;for(k=this.fields;f<k.length;f++)if(e=k[f],"oid"===e.type)a.push(e),d.push(e.name);else for(var b=0,c=this._overrideFields;b<c.length;b++)if(h=c[b],
h.toLowerCase()===e.name.toLowerCase()){a.push(e);d.push(e.name);break}this.fields=a;this._overrideFields=d}this._layer.source&&this._layer.source.layerDefinition&&(a=this._layer.source.layerDefinition.currentVersion,!0===this._layer.source.layerDefinition.useStandardizedQueries?(this._databaseType=t.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==a&&null!==a&&10.61<=a&&(this._databaseType=t.FeatureServiceDatabaseType.Standardised)):void 0!==a&&null!==a&&(10.5<=a&&(this._databaseType=t.FeatureServiceDatabaseType.StandardisedNoInterval,
this._requestStandardised=!0),10.61<=a&&(this._databaseType=t.FeatureServiceDatabaseType.Standardised)));this.objectIdField=this._layer.objectIdField;this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};g.prototype._isInFeatureSet=function(){return t.IdState.InFeatureSet};g.prototype._refineSetBlock=function(a){return p.resolve(a)};g.prototype._candidateIdTransform=function(a){return a};g.prototype._transformSetWithIdChanges=
function(){};g.prototype._getSet=function(a){var d=this;return null===this._wset?this._ensureLoaded().then(function(){return d._getFilteredSet("",null,null,null,a)}).then(function(a){return d._wset=a}):p.resolve(this._wset)};g.prototype._runDatabaseProbe=function(a){var d=this;return p.create(function(f,e){try{d._ensureLoaded().then(function(){try{var k=new v;k.where=a.replace("OBJECTID",d._layer.objectIdField);d._layer.queryObjectIds(k).then(function(){f(!0)},function(a){try{f(!1)}catch(h){e(h)}})}catch(b){e(b)}})}catch(k){e(k)}})};
g.prototype._canUsePagination=function(){return this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsPagination?!0:!1};g.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url};g.prototype.pbfSupportedForQuery=function(a){return!a.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF};g.prototype.queryPBF=function(a,d){a.quantizationParameters={mode:"edit"};
return L.executeQueryPBF(this._layer.parsedUrl,a,{type:"optimized"}).then(function(a){return M.fromJSON(J.convertToFeatureSet(a.data)).unquantize()})};g.prototype.nativeSource=function(){return this._layer};g.prototype.executeQuery=function(a,d){var f=this,e=new K({url:this._layer.parsedUrl.path}),k="execute"===d&&this.pbfSupportedForQuery(a),b=null;if(this.recentlyUsedQueries){var h=this.convertQueryToLruCacheKey(a),b=this.recentlyUsedQueries.getFromCache(h);null===b&&(b=!0!==k?e[d](a):this.queryPBF(a,
e),this.recentlyUsedQueries.addToCache(h,b),b=b.catch(function(a){f.recentlyUsedQueries.removeFromCache(h);throw a;}))}null===b&&(b=!0!==k?e[d](a):this.queryPBF(a,e));return b};g.prototype._getFilteredSet=function(a,d,f,e,k){var b=this;return this.databaseType().then(function(h){if(b.isTable()&&d&&null!==a&&""!==a)return new w([],[],!0,null);if(b._canUsePagination())return b._getFilteredSetUsingPaging(a,d,f,e,k);var c="",n=!1;null!==e&&b._layer.capabilities&&b._layer.capabilities.query&&!0===b._layer.capabilities.query.supportsOrderBy&&
(c=e.constructClause(),n=!0);var l=new v;l.where=null===f?null===d?"1\x3d1":"":u.toWhereClause(f,h);b._requestStandardised&&(l.sqlFormat="standard");l.spatialRelationship=b._makeRelationshipEnum(a);l.outSpatialReference=b.spatialReference;l.orderByFields=""!==c?c.split(","):null;l.geometry=null===d?null:d;l.relationParameter=b._makeRelationshipParam(a);return b.executeQuery(l,"executeForIds").then(function(a){null===a&&(a=[]);b._checkCancelled(k);return new w([],a,n,null)})})};g.prototype._expandPagedSet=
function(a,d,f,e,k){return this._expandPagedSetFeatureSet(a,d,f,e,k)};g.prototype._getFilteredSetUsingPaging=function(a,d,f,e,k){var b=this;try{var h="",c=!1;null!==e&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(h=e.constructClause(),c=!0);return this.databaseType().then(function(e){e=null===f?null===d?"1\x3d1":"":u.toWhereClause(f,e);b._layer.definitionExpression&&(e=""!==e?"(("+b._layer.definitionExpression+") AND ("+e+"))":b._layer.definitionExpression);
var l=b._maxQueryRate();void 0!==b._layer.maxRecordCount&&b._layer.maxRecordCount<l&&(l=b._layer.maxRecordCount);var g=null;if(!0===b._pageJustIds)g=new w([],["GETPAGES"],c,{spatialRel:b._makeRelationshipEnum(a),relationParam:b._makeRelationshipParam(a),outFields:b._layer.objectIdField,resultRecordCount:l,resultOffset:0,geometry:null===d?null:d,where:e,orderByFields:h,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});else{var n=!0;!0===b._removeGeometry&&
(n=!1);var m=null!==b._overrideFields?b._overrideFields:b._fieldsIncludingObjectId(b._layer.outFields?b._layer.outFields:["*"]),g=new w([],["GETPAGES"],c,{spatialRel:b._makeRelationshipEnum(a),relationParam:b._makeRelationshipParam(a),outFields:m.join(","),resultRecordCount:l,resultOffset:0,geometry:null===d?null:d,where:e,orderByFields:h,returnGeometry:n,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})}return b._expandPagedSet(g,l,0,1,k).then(function(){return g})})}catch(n){return p.reject(n)}};
g.prototype._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,
useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}};g.prototype._getPhysicalPage=function(a,d,f){var e=this;try{var k=a.pagesDefinition.internal.lastRetrieved,b=new v;this._requestStandardised&&(b.sqlFormat="standard");b.spatialRelationship=
a.pagesDefinition.spatialRel;b.relationParameter=a.pagesDefinition.relationParam;b.outFields=a.pagesDefinition.outFields.split(",");b.num=a.pagesDefinition.resultRecordCount;b.start=a.pagesDefinition.internal.lastRetrieved;b.geometry=a.pagesDefinition.geometry;b.where=a.pagesDefinition.where;b.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;b.returnGeometry=a.pagesDefinition.returnGeometry;b.outSpatialReference=this.spatialReference;return this.executeQuery(b,
"execute").then(function(b){e._checkCancelled(f);if(a.pagesDefinition.internal.lastRetrieved!==k)return"done";for(var c=0;c<b.features.length;c++)a.pagesDefinition.internal.set[k+c]=b.features[c].attributes[e._layer.objectIdField];if(!1===e._pageJustIds)for(c=0;c<b.features.length;c++)e._featureCache[b.features[c].attributes[e._layer.objectIdField]]=b.features[c];b.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=
k+a.pagesDefinition.resultRecordCount;return"done"})}catch(h){return p.reject(h)}};g.prototype._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;for(var d=!1,f=0;f<a.length;f++)if(a[f].toUpperCase()===this.objectIdField.toUpperCase()){d=!0;break}!1===d&&a.push(this.objectIdField);return a};g.prototype._getFeatures=function(a,d,f,e){var k=this,b=[];try{-1!==d&&void 0===this._featureCache[d]&&b.push(d);if(!0===this._checkIfNeedToExpandKnownPage(a,
this._maxProcessingRate(),e))return this._expandPagedSet(a,this._maxProcessingRate(),0,0,e).then(function(){return k._getFeatures(a,d,f,e)});for(var h=0,c=a._lastFetchedIndex;c<a._known.length;c++){a._lastFetchedIndex+=1;h++;if(void 0===this._featureCache[a._known[c]]){var g=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var l=this._layer._mode;if(void 0!==l._featureMap[a._known[c]]){var B=l._featureMap[a._known[c]];null!==B&&(g=!0,this._featureCache[a._known[c]]=B)}}if(!1===g&&(a._known[c]!==
d&&b.push(a._known[c]),b.length>=this._maxProcessingRate()-1))break}if(h>=f&&0===b.length)break}if(0===b.length)return p.resolve("success");try{var r=new v;this._requestStandardised&&(r.sqlFormat="standard");r.objectIds=b;r.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);r.returnGeometry=!0;!0===this._removeGeometry&&(r.returnGeometry=!1);r.outSpatialReference=this.spatialReference;return this.executeQuery(r,
"execute").then(function(a){k._checkCancelled(e);if(void 0!==a.error)return p.reject(Error(a.error));for(var b=0;b<a.features.length;b++)k._featureCache[a.features[b].attributes[k._layer.objectIdField]]=a.features[b];return"success"})}catch(m){return p.reject(m)}}catch(m){return p.reject(m)}};g.prototype._getDistinctPages=function(a,d,f,e,k,b,h,c,g){var l=this;return this._ensureLoaded().then(function(){return l.databaseType()}).then(function(n){for(var r=f.parseTree.column,m=0;m<l._layer.fields.length;m++)if(l._layer.fields[m].name.toLowerCase()===
r.toLowerCase()){r=l._layer.fields[m].name;break}m=new v;l._requestStandardised&&(m.sqlFormat="standard");n=null===b?null===k?"1\x3d1":"":u.toWhereClause(b,n);l._layer.definitionExpression&&(n=""!==n?"(("+l._layer.definitionExpression+") AND ("+n+"))":l._layer.definitionExpression);m.where=n;m.spatialRelationship=l._makeRelationshipEnum(e);m.relationParameter=l._makeRelationshipParam(e);m.geometry=null===k?null:k;m.returnDistinctValues=!0;m.returnGeometry=!1;m.outFields=[r];return l.executeQuery(m,
"execute").then(function(n){l._checkCancelled(g);if(!n.hasOwnProperty("features"))return p.reject(Error("Unnexected Result querying statistics from layer"));for(var m=!1,q=0;q<l._layer.fields.length;q++)if(l._layer.fields[q].name===r){"date"===l._layer.fields[q].type&&(m=!0);break}for(q=0;q<n.features.length;q++){if(m){var x=n.features[q].attributes[r];null!==x?c.push(new Date(x)):c.push(x)}else c.push(n.features[q].attributes[r]);if(c.length>=h)break}return 0===n.features.length?c:n.features.length===
l._layer.maxRecordCount&&c.length<h?l._getDistinctPages(a+n.features.length,d,f,e,k,b,h,c,g).then(function(a){return{calculated:!0,result:a}}):c})})};g.prototype._distinctStat=function(a,d,f,e,k,b,h){return this._getDistinctPages(0,a,d,f,e,k,b,[],h).then(function(a){return{calculated:!0,result:a}})};g.prototype.isTable=function(){return null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType};g.prototype._countstat=function(a,d,f,e,k){var b=this;return this.databaseType().then(function(a){var c=
new v;b._requestStandardised&&(c.sqlFormat="standard");if(b.isTable()&&f&&null!==d&&""!==d)return{calculated:!0,result:0};a=null===e?null===f?"1\x3d1":"":u.toWhereClause(e,a);b._layer.definitionExpression&&(a=""!==a?"(("+b._layer.definitionExpression+") AND ("+a+"))":b._layer.definitionExpression);c.where=a;c.where=a;c.spatialRelationship=b._makeRelationshipEnum(d);c.relationParameter=b._makeRelationshipParam(d);c.geometry=null===f?null:f;c.returnGeometry=!1;return b.executeQuery(c,"executeForCount").then(function(a){return{calculated:!0,
result:a}})})};g.prototype._stats=function(a,d,f,e,k,b,h){var c=this;return this._ensureLoaded().then(function(){var g=c._layer.capabilities&&c._layer.capabilities.query&&!0===c._layer.capabilities.query.supportsSqlExpression,l=c._layer.capabilities&&c._layer.capabilities.query&&!0===c._layer.capabilities.query.supportsStatistics,t=c._layer.capabilities&&c._layer.capabilities.query&&!0===c._layer.capabilities.query.supportsDistinct;return"count"===a?t?c._countstat(a,f,e,k,h):{calculated:!1}:!1===
l||!1===y.isSingleField(d)&&!1===g||!1===d.isStandardized?""!==f||null!==k?{calculated:!1}:c._manualStat(a,d,b,h):"distinct"===a?!1===t?""!==f||null!==k?{calculated:!1}:c._manualStat(a,d,b,h):c._distinctStat(a,d,f,e,k,b,h):c.databaseType().then(function(b){if(c.isTable()&&e&&null!==f&&""!==f)return{calculated:!0,result:null};var h=new v;c._requestStandardised&&(h.sqlFormat="standard");var g=null===k?null===e?"1\x3d1":"":u.toWhereClause(k,b);c._layer.definitionExpression&&(g=""!==g?"(("+c._layer.definitionExpression+
") AND ("+g+"))":c._layer.definitionExpression);h.where=g;h.spatialRelationship=c._makeRelationshipEnum(f);h.relationParameter=c._makeRelationshipParam(f);h.geometry=null===e?null:e;g=new z;g.statisticType=I.decodeStatType(a);g.onStatisticField=u.toWhereClause(d,b);g.outStatisticFieldName="ARCADE_STAT_RESULT";h.returnGeometry=!1;var l="ARCADE_STAT_RESULT";h.outStatistics=[g];return c.executeQuery(h,"execute").then(function(a){if(!a.hasOwnProperty("features")||0===a.features.length)return p.reject(Error("Unnexected Result querying statistics from layer"));
for(var b=!1,c=0;c<a.fields.length;c++)if("ARCADE_STAT_RESULT"===a.fields[c].name.toUpperCase()){l=a.fields[c].name;"date"===a.fields[c].type&&(b=!0);break}return b?(b=a.features[0].attributes[l],null!==b&&(b=new Date(a.features[0].attributes[l])),{calculated:!0,result:b}):{calculated:!0,result:a.features[0].attributes[l]}})})})};g.prototype._stat=function(a,d,f,e,g,b,h){return this._stats(a,d,f,e,g,b,h)};g.prototype._canDoAggregates=function(a,d,g,e,k){var b=this;return this._ensureLoaded().then(function(){var a=
!1,c=b._layer.capabilities&&b._layer.capabilities.query&&!0===b._layer.capabilities.query.supportsSqlExpression;void 0!==b._layer.capabilities&&null!==b._layer.capabilities.query&&!0===b._layer.capabilities.query.supportsStatistics&&!0===b._layer.capabilities.query.supportsOrderBy&&(a=!0);if(a)for(var e=0;e<d.length-1;e++)null!==d[e].workingexpr&&(!1===d[e].workingexpr.isStandardized?a=!1:!1===y.isSingleField(d[e].workingexpr)&&!1===c&&(a=!1));return!1===a?!1:!0})};g.prototype._makeRelationshipEnum=
function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};g.prototype._makeRelationshipParam=
function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};g.prototype._getAggregatePagesDataSourceDefinition=function(a,d,g,e,k,b,h){var c=this;return this._ensureLoaded().then(function(){return c.databaseType()}).then(function(f){var l="",n=!1,r=!1;null!==b&&c._layer.capabilities&&c._layer.capabilities.query&&!0===c._layer.capabilities.query.supportsOrderBy&&(l=b.constructClause(),r=!0);c._layer.capabilities&&c._layer.capabilities.query&&!1===c._layer.capabilities.query.supportsPagination&&
(r=!1,n=!0,l=c._layer.objectIdField);for(var m=[],q=0;q<d.length;q++){var p=new z;p.onStatisticField=null!==d[q].workingexpr?u.toWhereClause(d[q].workingexpr,f):"";p.outStatisticFieldName=d[q].field;p.statisticType=d[q].toStatisticsName();m.push(p)}""===l&&(l=a.join(","));q=c._maxQueryRate();void 0!==c._layer.maxRecordCount&&c._layer.maxRecordCount<q&&(q=c._layer.maxRecordCount);f=null===k?null===e?"1\x3d1":"":u.toWhereClause(k,f);c._layer.definitionExpression&&(f=""!==f?"(("+c._layer.definitionExpression+
") AND ("+f+"))":c._layer.definitionExpression);return new w([],["GETPAGES"],r,{groupbypage:!0,spatialRel:c._makeRelationshipEnum(g),relationParam:c._makeRelationshipParam(g),outFields:["*"],useOIDpagination:n,generatedOid:h,resultRecordCount:q,resultOffset:0,groupByFieldsForStatistics:a,outStatistics:m,geometry:null===e?null:e,where:f,orderByFields:l,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})})};g.prototype._getAgregagtePhysicalPage=function(a,
d,g){var e=this;try{var f=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(f=""!==f?"("+f+") AND ("+a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());var b=a.pagesDefinition.internal.lastRetrieved,h=new v;this._requestStandardised&&(h.sqlFormat="standard");h.where=f;h.spatialRelationship=a.pagesDefinition.spatialRel;h.relationParameter=a.pagesDefinition.relationParam;
h.outFields=a.pagesDefinition.outFields;h.outStatistics=a.pagesDefinition.outStatistics;h.geometry=a.pagesDefinition.geometry;h.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;h.num=a.pagesDefinition.resultRecordCount;h.start=a.pagesDefinition.internal.lastRetrieved;h.returnGeometry=a.pagesDefinition.returnGeometry;h.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;return this.isTable()&&h.geometry&&h.spatialRelationship?p.resolve([]):
this.executeQuery(h,"execute").then(function(c){e._checkCancelled(g);if(!c.hasOwnProperty("features"))return p.reject(Error("Unnexected Result querying aggregates from layer"));var d=[];if(a.pagesDefinition.internal.lastRetrieved!==b)return[];for(var f=0;f<c.features.length;f++)a.pagesDefinition.internal.set[b+f]=c.features[f].attributes[a.pagesDefinition.generatedOid];for(f=0;f<c.features.length;f++)d.push(new D({attributes:c.features[f].attributes,geometry:null}));!0===a.pagesDefinition.useOIDpagination?
0===c.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=c.features[c.features.length-1].attributes[a.pagesDefinition.generatedOid]:c.features.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=b+a.pagesDefinition.resultRecordCount;return d})}catch(c){return p.reject(c)}};g.create=function(a,d,f,e){a=new F({url:a,outFields:null===d?["*"]:d});return new g({layer:a,spatialReference:f,
lrucache:e})};g.prototype.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.layerDefinition&&this._layer.source.layerDefinition.relationships?this._layer.source.layerDefinition.relationships:[]};g.prototype.serviceUrl=function(){return t.extractServiceUrl(this._layer.parsedUrl.path)};g.prototype.queryAttachments=function(a,d,f,e){var g=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var b=
{objectIds:[a]};if(d&&0<d||f&&0<f)b.size=[d&&0<d?d:0,f&&0<f?f:d+1];e&&0<e.length&&(b.attachmentTypes=e);return this._layer.queryAttachments(b).then(function(b){var c=[];b&&b[a]&&b[a].forEach(function(b){c.push(new E(b.id,b.name,b.contentType,b.size,g._layer.parsedUrl.path+"/"+a.toString()+"/attachments/"+b.id.toString()))});return c})}return p.resolve([])};return g}(G)});