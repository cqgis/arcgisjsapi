// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../Graphic ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../tasks/support/RelationshipQuery".split(" "),function(z,A,v,w,x,t,n,u,h,q){return function(r){function c(a){var b=r.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated";b._findObjectId=-1;b._requestStandardised=!1;b._removeGeometry=!1;b._overrideFields=null;b.featureObjectId=
null;b.relatedLayer=null;b.relationship=null;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;b._findObjectId=a.objectId;b.featureObjectId=a.objectId;b.relationship=a.relationship;b.relatedLayer=a.relatedLayer;void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}v(c,r);c.prototype._maxQueryRate=function(){return n.defaultMaxRecords};c.prototype.end=
function(){return this._layer};c.prototype.optimisePagingFeatureQueries=function(a){};c.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=h.create(function(b,f){h.all([a._layer.load(),a.relatedLayer.load()]).then(function(){a._initialiseFeatureSet();b(a)},f)}));return this._loadPromise};c.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this.relatedLayer.geometryType;this.fields=
this.relatedLayer.fields.slice(0);if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{for(var a=[],b=[],f=0,d=this.fields;f<d.length;f++){var c=d[f];if("oid"===c.type)a.push(c),b.push(c.name);else for(var e=0,g=this._overrideFields;e<g.length;e++)if(g[e].toLowerCase()===c.name.toLowerCase()){a.push(c);b.push(c.name);break}}this.fields=a;this._overrideFields=b}a=this._layer.nativeSource();a.source&&a.source.layerDefinition&&
(!0===a.source.layerDefinition.useStandardizedQueries?this._databaseType=n.FeatureServiceDatabaseType.Standardised:(a=a.source.layerDefinition.currentVersion,void 0!==a&&null!==a&&10.5<=a&&(this._databaseType=n.FeatureServiceDatabaseType.Standardised,this._requestStandardised=!0)));this.objectIdField=this.relatedLayer.objectIdField;this.hasM=this.relatedLayer.supportsM;this.hasZ=this.relatedLayer.supportsZ;this.typeIdField=this.relatedLayer.typeIdField;this.types=this.relatedLayer.types};c.prototype.databaseType=
function(){var a=this;return this.relatedLayer.databaseType().then(function(){a._databaseType=a.relatedLayer._databaseType;return a._databaseType})};c.prototype.isTable=function(){return this.relatedLayer.isTable()};c.prototype._isInFeatureSet=function(a){return n.IdState.InFeatureSet};c.prototype._transformSetWithIdChanges=function(a){};c.prototype._candidateIdTransform=function(a){return a};c.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",
null,null,null,a)}).then(function(a){return b._wset=a}):h.resolve(this._wset)};c.prototype._changeFeature=function(a){for(var b={},c=0,d=this.fields;c<d.length;c++){var k=d[c];b[k.name]=a.attributes[k.name]}return new w({geometry:!0===this._removeGeometry?null:a.geometry,attributes:b})};c.prototype._getFilteredSet=function(a,b,c,d,k){var e=this;return this._layer.databaseType().then(function(f){if(e.isTable()&&b&&null!==a&&""!==a)return new t([],[],!0,null);var l=e._layer.nativeSource();if(l.capabilities.queryRelated&&
l.capabilities.queryRelated.supportsPagination)return e._getFilteredSetUsingPaging(a,b,c,d,k);var m="",g=!1;null!==d&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(m=d.constructClause(),g=!0);var p=new q;p.objectIds=[e._findObjectId];p.where=null===c?"1\x3d1":u.toWhereClause(c,f);e._requestStandardised&&(p.sqlFormat="standard");p.outSpatialReference=e.spatialReference;p.orderByFields=""!==m?m.split(","):null;return l.queryRelatedFeatures(p).then(function(c){e._checkCancelled(k);
var d=c[e._findObjectId]?c[e._findObjectId].features:[];c=[];for(var f=0;f<d.length;f++)e._featureCache[d[f].attributes[e._layer.objectIdField]]=d[f],c.push(d[f].attributes[e._layer.objectIdField]);d=b&&null!==a&&""!==a;return new t(d?c:[],d?[]:c,g,null)})})};c.prototype.nativeCapabilities=function(){return this._layer.nativeSource()};c.prototype._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;for(var b=!1,c=0;c<a.length;c++)if(a[c].toUpperCase()===
this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);return a};c.prototype._getFilteredSetUsingPaging=function(a,c,f,d,k){var b=this;try{var g="",l=!1,m=this._layer.nativeSource();null!==d&&m&&m.capabilities.queryRelated&&!0===m.capabilities.queryRelated.supportsOrderBy&&(g=d.constructClause(),l=!0);return this._layer.databaseType().then(function(d){d=null===f?"1\x3d1":u.toWhereClause(f,d);var e=b._maxQueryRate();void 0!==m.maxRecordCount&&m.maxRecordCount<e&&(e=m.maxRecordCount);
var h=c&&null!==a&&""!==a,n=null,q=!0;!0===b._removeGeometry&&(q=!1);var r=null!==b._overrideFields?b._overrideFields:b._fieldsIncludingObjectId(b.relatedLayer.fields?b.relatedLayer.fields.map(function(a){return a.name}):["*"]),n=new t(h?["GETPAGES"]:[],h?[]:["GETPAGES"],l,{outFields:r.join(","),resultRecordCount:e,resultOffset:0,objectIds:[b._findObjectId],where:d,orderByFields:g,returnGeometry:q,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});return b._expandPagedSet(n,
e,0,1,k).then(function(){return n})})}catch(y){return h.reject(y)}};c.prototype._expandPagedSet=function(a,b,c,d,k){return this._expandPagedSetFeatureSet(a,b,c,d,k)};c.prototype._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,where:a.where,objectIds:a.objectIds,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:
{groupbypage:!0,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,objectIds:a.objectIds,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}};c.prototype._getPhysicalPage=function(a,b,c){var d=this;try{var f=a.pagesDefinition.internal.lastRetrieved,
e=this._layer.nativeSource(),g=new q;!0===this._requestStandardised&&(g.sqlFormat="standard");g.relationshipId=this.relationship.id;g.objectIds=a.pagesDefinition.objectIds;g.resultOffset=a.pagesDefinition.internal.lastRetrieved;g.resultRecordCount=a.pagesDefinition.resultRecordCount;g.outFields=a.pagesDefinition.outFields.split(",");g.where=a.pagesDefinition.where;g.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;g.returnGeometry=a.pagesDefinition.returnGeometry;
g.outSpatialReference=this.spatialReference;return e.queryRelatedFeatures(g).then(function(b){d._checkCancelled(c);if(a.pagesDefinition.internal.lastRetrieved!==f)return"done";b=b[d._findObjectId]?b[d._findObjectId].features:[];for(var e=0;e<b.length;e++)a.pagesDefinition.internal.set[f+e]=b[e].attributes[d._layer.objectIdField];for(e=0;e<b.length;e++)d._featureCache[b[e].attributes[d._layer.objectIdField]]=b[e];b.length!==a.pagesDefinition.resultRecordCount&&(a.pagesDefinition.internal.fullyResolved=
!0);a.pagesDefinition.internal.lastRetrieved=f+a.pagesDefinition.resultRecordCount;return"done"})}catch(l){return h.reject(l)}};c.prototype._makeRelationshipEnum=function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";
case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};c.prototype._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};c.prototype._getFeatures=function(a,b,c,d){d=[];-1!==b&&void 0===this._featureCache[b]&&d.push(b);for(var f=a._lastFetchedIndex;f<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[f]]&&(a._known[f]!==b&&d.push(a._known[f]),d.length>c));f++);
return 0===d.length?h.resolve("success"):h.reject(Error("Unaccounted for Features. Not in Feature Collection"))};c.prototype._refineSetBlock=function(a,b,c){return h.resolve(a)};c.prototype._stat=function(a,b,c,d,k,e,g){return h.resolve({calculated:!1})};c.prototype._canDoAggregates=function(a,b,c,d,k){return h.resolve(!1)};c.prototype.relationshipMetaData=function(){return this.relatedLayer.relationshipMetaData()};c.prototype.serviceUrl=function(){return this.relatedLayer.serviceUrl()};c.prototype.queryAttachments=
function(a,b,c,d){return this.relatedLayer.queryAttachments(a,b,c,d)};return c}(x)});