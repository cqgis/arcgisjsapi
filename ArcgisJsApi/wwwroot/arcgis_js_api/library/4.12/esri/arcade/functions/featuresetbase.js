// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../Dictionary ../Dictionary ../Feature ../featureSetCollection ../featureSetUtils ../languageUtils ../featureset/actions/AttributeFilter ../featureset/actions/OrderBy ../featureset/actions/Top ../featureset/sources/FeatureLayerMemory ../featureset/support/OrderbyClause ../../core/promiseUtils ../../core/sql/WhereClause ../../layers/FeatureLayer".split(" "),function(I,w,x,t,u,y,n,c,z,E,F,G,H,m,q,A){function B(a,p,c){var k=a.getVariables();if(0<k.length){for(var f=[],b=0;b<k.length;b++)f.push(p.evaluateIdentifier(c,
{name:k[b]}));return m.all(f).then(function(b){for(var g={},c=0;c<k.length;c++)g[k[c]]=b[c];a.parameters=g;return a})}return m.resolve(a)}function e(a,c,d){void 0===d&&(d=null);for(var k in a)if(k.toLowerCase()===c.toLowerCase())return a[k];return d}function C(a){if(null===a)return null;var c={type:e(a,"type",""),name:e(a,"name","")};if("range"===c.type)c.range=e(a,"range",[]);else{c.codedValues=[];var d=0;for(a=e(a,"codedValues",[]);d<a.length;d++){var k=a[d];c.codedValues.push({name:e(k,"name",
""),code:e(k,"code",null)})}}return c}function v(a){if(null===a)return null;var c={},d=e(a,"wkt",null);null!==d&&(c.wkt=d);a=e(a,"wkid",null);null!==a&&(c.wkid=a);return c}function D(a){if(null===a)return null;var c={hasZ:e(a,"hasz",!1),hasM:e(a,"hasm",!1)},d=e(a,"spatialreference",null);d&&(c.spatialReference=v(d));d=e(a,"x",null);if(null!==d)return c.x=d,c.y=e(a,"y",null),c;d=e(a,"rings",null);if(null!==d)return c.rings=d,c;d=e(a,"paths",null);if(null!==d)return c.paths=d,c;d=e(a,"points",null);
if(null!==d)return c.points=d,c;for(var d=0,k="xmin xmax ymin ymax zmin zmax mmin mmax".split(" ");d<k.length;d++){var f=k[d],b=e(a,f,null);null!==b&&(c[f]=b)}return c}Object.defineProperty(w,"__esModule",{value:!0});w.registerFunctions=function(a){"async"===a.mode&&(a.functions.featuresetbyid=function(e,d){return a.standardFunctionAsync(e,d,function(a,f,b){c.pcCheck(b,2,4);if(b[0]instanceof y){a=c.toString(b[1]);f=c.defaultUndefined(b[2],null);var g=c.toBoolean(c.defaultUndefined(b[3],!0));null===
f&&(f=["*"]);if(!1===c.isArray(f))throw Error("Invalid Parameter");return b[0].featureSetById(a,g,f)}throw Error("Invalid Parameter");})},a.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),a.functions.featuresetbyportalitem=function(e,d){return a.standardFunctionAsync(e,d,function(a,f,b){c.pcCheck(b,2,4);a=c.toString(b[0]);f=c.toString(b[1]);var g=c.defaultUndefined(b[2],null);b=c.toBoolean(c.defaultUndefined(b[3],!0));null===g&&(g=["*"]);if(!1===c.isArray(g))throw Error("Invalid Parameter");
if(e.services&&e.services.portal)return n.constructFeatureSetFromPortalItem(a,f,e.spatialReference,g,b,e.services.portal,e.lrucache);throw Error("Portal is required");})},a.signatures.push({name:"featuresetbyportalitem",min:"2",max:"4"}),a.functions.featuresetbyname=function(e,d){return a.standardFunctionAsync(e,d,function(a,f,b){c.pcCheck(b,2,4);if(b[0]instanceof y){a=c.toString(b[1]);f=c.defaultUndefined(b[2],null);var g=c.toBoolean(c.defaultUndefined(b[3],!0));null===f&&(f=["*"]);if(!1===c.isArray(f))throw Error("Invalid Parameter");
return b[0].featureSetByName(a,g,f)}throw Error("Invalid Parameter");})},a.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),a.functions.featureset=function(p,d){return a.standardFunction(p,d,function(a,f,b){c.pcCheck(b,1,1);f=b[0];a={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(c.isString(f))f=JSON.parse(f),void 0!==f.layerDefinition?(a.layerDefinition=f.layerDefinition,a.featureSet=f.featureSet,f.layerDefinition.spatialReference&&
(a.layerDefinition.spatialReference=f.layerDefinition.spatialReference)):(a.featureSet.features=f.features,a.featureSet.geometryType=f.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=f.objectIdFieldName,a.layerDefinition.typeIdField=f.typeIdFieldName,a.layerDefinition.fields=f.fields,f.spatialReference&&(a.layerDefinition.spatialReference=f.spatialReference));else if(b[0]instanceof x){f=JSON.parse(b[0].castToText());var g=e(f,"layerdefinition");
if(null!==g){a.layerDefinition.geometryType=e(g,"geometrytype","");a.featureSet.geometryType=a.layerDefinition.geometryType;a.layerDefinition.objectIdField=e(g,"objectidfield","");a.layerDefinition.typeIdField=e(g,"typeidfield","");if(b=e(g,"spatialreference",null))a.layerDefinition.spatialReference=v(b);b=0;for(var d=e(g,"fields",[]);b<d.length;b++)g=d[b],g={name:e(g,"name",""),alias:e(g,"alias",""),type:e(g,"type",""),nullable:e(g,"nullable",!0),editable:e(g,"editable",!0),length:e(g,"length",null),
domain:C(e(g,"domain"))},a.layerDefinition.fields.push(g);if(f=e(f,"featureset",null)){b={};g=0;for(d=a.layerDefinition.fields;g<d.length;g++){var l=d[g];b[l.name.toLowerCase()]=l.name}for(var h=0,k=e(f,"features",[]);h<k.length;h++){f=k[h];g={};d=e(f,"attributes",{});for(l in d)g[b[l.toLowerCase()]]=d[l];a.featureSet.features.push({attributes:g,geometry:D(e(f,"geometry",null))})}}}else{a.layerDefinition.geometryType=e(f,"geometrytype","");a.featureSet.geometryType=a.layerDefinition.geometryType;
a.layerDefinition.objectIdField=e(f,"objectidfieldname","");a.layerDefinition.typeIdField=e(f,"typeidfieldname","");if(b=e(f,"spatialreference",null))a.layerDefinition.spatialReference=v(b);b=0;for(d=e(f,"fields",[]);b<d.length;b++)g=d[b],g={name:e(g,"name",""),alias:e(g,"alias",""),type:e(g,"type",""),nullable:e(g,"nullable",!0),editable:e(g,"editable",!0),length:e(g,"length",null),domain:C(e(g,"domain"))},a.layerDefinition.fields.push(g);b={};g=0;for(d=a.layerDefinition.fields;g<d.length;g++)l=
d[g],b[l.name.toLowerCase()]=l.name;h=0;for(k=e(f,"features",[]);h<k.length;h++){f=k[h];g={};d=e(f,"attributes",{});for(l in d)g[b[l.toLowerCase()]]=d[l];a.featureSet.features.push({attributes:g,geometry:D(e(f,"geometry",null))})}}}else throw Error("Invalid Parameter");if(a.layerDefinition&&a.featureSet){b:{l=0;for(f=" esriGeometryPoint esriGeometryPolyline esriGeometryPolygon esriGeometryMultipoint esriGeometryEnvelope".split(" ");l<f.length;l++)if(f[l]===a.layerDefinition.geometryType){l=!0;break b}l=
!1}l=!1===l||null===a.layerDefinition.objectIdField||""===a.layerDefinition.objectIdField||!1===c.isArray(a.layerDefinition.fields)||!1===c.isArray(a.featureSet.features)?!1:void 0}else l=!1;if(!1===l)throw Error("Invalid Parameter");return G.create(a,p.spatialReference)})},a.signatures.push({name:"featureset",min:"1",max:"1"}),a.functions.filter=function(e,d){return a.standardFunctionAsync(e,d,function(d,f,b){c.pcCheck(b,2,2);return c.isFeatureSet(b[0])?b[0].load().then(function(c){var g=q.WhereClause.create(b[1],
c.getFieldsIndex()),d=g.getVariables();if(0<d.length){c=[];for(var f=0;f<d.length;f++)c.push(a.evaluateIdentifier(e,{name:d[f]}));return m.all(c).then(function(a){for(var c={},f=0;f<d.length;f++)c[d[f]]=a[f];g.parameters=c;return new z({parentfeatureset:b[0],whereclause:g})})}return m.resolve(new z({parentfeatureset:b[0],whereclause:g}))}):a.failDefferred("Filter cannot accept this parameter type")})},a.signatures.push({name:"filter",min:"2",max:"2"}),a.functions.orderby=function(e,d){return a.standardFunctionAsync(e,
d,function(d,f,b){c.pcCheck(b,2,2);return c.isFeatureSet(b[0])?(d=new H(b[1]),m.resolve(new E({parentfeatureset:b[0],orderbyclause:d}))):a.failDefferred("Order cannot accept this parameter type")})},a.signatures.push({name:"orderby",min:"2",max:"2"}),a.functions.top=function(e,d){return a.standardFunctionAsync(e,d,function(d,f,b){c.pcCheck(b,2,2);return c.isFeatureSet(b[0])?m.resolve(new F({parentfeatureset:b[0],topnum:b[1]})):c.isArray(b[0])?c.toNumber(b[1])>=b[0].length?b[0].slice(0):b[0].slice(0,
c.toNumber(b[1])):c.isImmutableArray(b[0])?c.toNumber(b[1])>=b[0].length()?b[0].slice(0):b[0].slice(0,c.toNumber(b[1])):a.failDefferred("Top cannot accept this parameter type")})},a.signatures.push({name:"top",min:"2",max:"2"}),a.functions.first=function(e,d){return a.standardFunctionAsync(e,d,function(a,d,b){c.pcCheck(b,1,1);return c.isFeatureSet(b[0])?b[0].first(a.abortSignal).then(function(a){if(null!==a){var c=u.createFromGraphicLikeObject(a.geometry,a.attributes,b[0]);c._underlyingGraphic=a;
a=c}return a}):c.isArray(b[0])?0===b[0].length?m.resolve(null):m.resolve(b[0][0]):c.isImmutableArray(b[0])?0===b[0].length()?m.resolve(null):m.resolve(b[0].get(0)):null})},a.signatures.push({name:"first",min:"1",max:"1"}),a.functions.attachments=function(e,d){return a.standardFunctionAsync(e,d,function(a,d,b){c.pcCheck(b,1,2);var g=-1,f=-1,l=null;if(1<b.length)if(b[1]instanceof x)b[1].hasField("minsize")&&(g=c.toNumber(b[1].field("minsize"))),b[1].hasField("maxsize")&&(f=c.toNumber(b[1].field("maxsize"))),
b[1].hasField("types")&&(a=c.toStringArray(b[1].field("types"),!1),0<a.length&&(l=a));else if(null!==b[1])throw Error("Invalid Parameter");if(b[0]instanceof u){var h=b[0]._layer;h instanceof A&&(h=n.constructFeatureSet(h,e.spatialReference,["*"],!0,e.lrucache));return null===h||!1===c.isFeatureSet(h)?[]:h.load().then(function(){return h.queryAttachments(b[0].field(h.objectIdField),g,f,l)})}if(null===b[0])return[];throw Error("Invalid Parameter");})},a.signatures.push({name:"attachments",min:"1",max:"2"}),
a.functions.featuresetbyrelationship=function(e,d){return a.standardFunctionAsync(e,d,function(a,d,b){c.pcCheck(b,2,4);var g=b[0],f=c.toString(b[1]),l=c.defaultUndefined(b[2],null),h=c.toBoolean(c.defaultUndefined(b[3],!0));null===l&&(l=["*"]);if(!1===c.isArray(l))throw Error("Invalid Parameter");if(null===b[0])return null;if(!(b[0]instanceof u))throw Error("Invalid Parameter");a=g._layer;a instanceof A&&(a=n.constructFeatureSet(a,e.spatialReference,["*"],!0,e.lrucache));return null===a||!1===c.isFeatureSet(a)?
null:a.load().then(function(a){var b=a.relationshipMetaData().filter(function(a){return a.name===f});if(0===b.length)return null;if(void 0!==b[0].relationshipTableId&&null!==b[0].relationshipTableId&&-1<b[0].relationshipTableId)return n.constructFeatureSetFromRelationship(a,b[0],g.field(a.objectIdField),a.spatialReference,l,h,e.lrucache);var c=a.serviceUrl();if(!c)return null;c="/"===c.charAt(c.length-1)?c+b[0].relatedTableId.toString():c+"/"+b[0].relatedTableId.toString();return n.constructFeatureSetFromUrl(c,
a.spatialReference,l,h,e.lrucache).then(function(a){return a.load().then(function(){return a.relationshipMetaData()}).then(function(c){c=c.filter(function(a){return a.id===b[0].id});if(null===g.field(b[0].keyField))return c=q.WhereClause.create(c[0].keyField+" is null",a.getFieldsIndex()),a.filter(c);c=q.WhereClause.create(c[0].keyField+"\x3d @id",a.getFieldsIndex());c.parameters={id:g.field(b[0].keyField)};return a.filter(c)})})})})},a.signatures.push({name:"featuresetbyrelationship",min:"2",max:"4"}),
a.functions.groupby=function(e,d){return a.standardFunctionAsync(e,d,function(d,f,b){c.pcCheck(b,3,3);return c.isFeatureSet(b[0])?b[0].load().then(function(d){var f=[],g=[],h=[];if(c.isString(b[1]))h.push(b[1]);else if(b[1]instanceof t)h.push(b[1]);else if(c.isArray(b[1]))h=b[1];else if(c.isImmutableArray(b[1]))h=b[1].toArray();else return a.failDefferred("Illegal Value: GroupBy");for(var k=0,n=h;k<n.length;k++)if(h=n[k],c.isString(h))f.push({name:c.toString(h),expression:q.WhereClause.create(c.toString(h),
d.getFieldsIndex())});else if(h instanceof t){var r=h.hasField("name")?h.field("name"):"",h=h.hasField("expression")?h.field("expression"):"";if(!r)return a.failDefferred("Illegal Value: GroupBy");f.push({name:r,expression:q.WhereClause.create(h?r:h,d.getFieldsIndex())})}else return a.failDefferred("Illegal Value: GroupBy");h=[];if(c.isString(b[2]))h.push(b[2]);else if(c.isArray(b[2]))h=b[2];else if(c.isImmutableArray(b[2]))h=b[2].toArray();else if(b[2]instanceof t)h.push(b[2]);else return a.failDefferred("Illegal Value: GroupBy");
k=0;for(n=h;k<n.length;k++)if(h=n[k],h instanceof t){var r=h.hasField("name")?h.field("name"):"",p=h.hasField("statistic")?h.field("statistic"):"",h=h.hasField("expression")?h.field("expression"):"";if(!r||!p||!h)return a.failDefferred("Illegal Value: GroupBy");g.push({name:r,statistic:p.toLowerCase(),expression:q.WhereClause.create(h,d.getFieldsIndex())})}else return a.failDefferred("Illegal Value: GroupBy");d=[];for(k=0;k<f.length;k++)h=f[k],d.push(B(h.expression,a,e));for(k=0;k<g.length;k++)h=
g[k],d.push(B(h.expression,a,e));return 0<d.length?m.all(d).then(function(){return m.resolve(b[0].groupby(f,g))}):m.resolve(b[0].groupby(f,g))}):a.failDefferred("Illegal Value: GroupBy")})},a.signatures.push({name:"groupby",min:"3",max:"3"}))}});