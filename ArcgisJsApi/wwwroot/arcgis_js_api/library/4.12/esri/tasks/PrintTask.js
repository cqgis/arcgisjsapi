// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper dojox/gfx/canvas ../kernel ../request ../core/jsonMap ../core/lang ../core/promiseUtils ../core/screenUtils ../core/urlUtils ../core/accessorSupport/decorators ../geometry/Polygon ../renderers/visualVariables/support/visualVariableUtils ./Geoprocessor ./Task ./support/fileFormat ./support/layoutTemplate ./support/printTaskUtils ./support/PrintTemplate ./support/Query".split(" "),
function(aa,ba,M,t,N,C,v,G,w,O,D,H,P,I,x,y,Q,R,S,T,U,V,m,W,X){function E(m){return m&&(m.path||"image/svg+xml"===m.contentType)}var K={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},L=new D.default({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),Y=new D.default({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),Z=new X({returnGeometry:!0});return function(D){function e(a){a=D.call(this,a)||this;a._ssExtent=null;a._legendLayers=[];a._legendLayerNameMap=
{};a._gpServerUrl=null;a._cimVersion=null;a._is11xService=!1;a._gpMetadata=null;a.updateDelay=1E3;return a}N(e,D);Object.defineProperty(e.prototype,"_geoprocessor",{get:function(){return new S(this.url,{updateDelay:this.updateDelay})},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"mode",{get:function(){return this._gpMetadata&&this._gpMetadata.executionType?Y.fromJSON(this._gpMetadata.executionType):"sync"},enumerable:!0,configurable:!0});e.prototype.execute=function(a,c){var d=
this,b=this.url,k=b.lastIndexOf("/GPServer/");0<k&&(b=b.slice(0,k+9));return P.resolve().then(function(){if(d._gpServerUrl===b)return{data:d._gpMetadata};d._gpServerUrl=b;return O(b,{query:{f:"json"}})}).then(function(b){d._gpMetadata=b.data;d._cimVersion=d._gpMetadata.cimVersion;d._is11xService=!!d._cimVersion;return d._getGpPrintParams(a)}).then(function(a){return d._geoprocessor["async"===d.mode?"submitJob":"execute"](a,c).then(function(a){return"sync"===d.mode?a.results&&a.results[0]&&a.results[0].value:
d._geoprocessor.getResultData(a.jobId,"Output_File",c).then(function(a){return a.value})})})};e.prototype._createOperationalLayers=function(a,c){return t(this,void 0,void 0,function(){var d,b,k,q,u,r,p,f,g;return v(this,function(h){switch(h.label){case 0:d=[],b={layerView:null,printTemplate:c,view:a},k=0,c.preserveScale&&(k=c.outScale||a.scale),q=m.getVisibleLayerViews(a,k),u=0,r=q,h.label=1;case 1:if(!(u<r.length))return[3,27];p=r[u];f=p.layer;if(!f.loaded||m.isGroupLayer(f))return[3,26];g=void 0;
b.layerView=p;if(!m.isBingMapsLayer(f))return[3,2];g=this._createBingMapsLayerJSON(f,b);return[3,25];case 2:return m.isCSVLayer(f)?[4,this._createCSVLayerJSON(f,b)]:[3,4];case 3:return g=h.sent(),[3,25];case 4:return m.isFeatureLayer(f)?[4,this._createFeatureLayerJSON(f,b)]:[3,6];case 5:return g=h.sent(),[3,25];case 6:return m.isGraphicsLayer(f)?[4,this._createGraphicsLayerJSON(f,b)]:[3,8];case 7:return g=h.sent(),[3,25];case 8:if(!m.isImageryLayer(f))return[3,9];g=this._createImageryLayerJSON(f,
b);return[3,25];case 9:return m.isKMLLayer(f)?[4,this._createKMLLayerJSON(f,b)]:[3,11];case 10:return g=h.sent(),[3,25];case 11:if(!m.isMapImageLayer(f))return[3,12];g=this._createMapImageLayerJSON(f,b);return[3,25];case 12:return m.isMapNotesLayer(f)?[4,this._createMapNotesLayerJSON(f,b)]:[3,14];case 13:return g=h.sent(),[3,25];case 14:if(!m.isOpenStreetMapLayer(f))return[3,15];g=this._createOpenStreetMapLayerJSON(f,b);return[3,25];case 15:return m.isStreamLayer(f)?[4,this._createStreamLayerJSON(f,
b)]:[3,17];case 16:return g=h.sent(),[3,25];case 17:if(!m.isTileLayer(f))return[3,18];g=this._createTileLayerJSON(f,b);return[3,25];case 18:return m.isVectorTileLayer(f)?[4,this._createVectorTileLayerJSON(f,b)]:[3,20];case 19:return g=h.sent(),[3,25];case 20:if(!m.isWebTileLayer(f))return[3,21];g=this._createWebTileLayerJSON(f,b);return[3,25];case 21:if(!m.isWMSLayer(f))return[3,22];g=this._createWMSLayerJSON(f,b);return[3,25];case 22:if(!m.isWMTSLayer(f))return[3,23];g=this._createWMTSLayerJSON(f,
b);return[3,25];case 23:return[4,this._createScreenshotJSON(f,b)];case 24:g=h.sent(),h.label=25;case 25:g&&(Array.isArray(g)?d.push.apply(d,g):(g.id=f.id,g.title=this._legendLayerNameMap[f.id]||f.title,g.opacity=f.opacity,g.minScale=f.minScale||0,g.maxScale=f.maxScale||0,d.push(g))),h.label=26;case 26:return u++,[3,1];case 27:return k&&d.forEach(function(a){a.minScale=0;a.maxScale=0}),a.graphics&&a.graphics.length?[4,this._createFeatureCollectionJSON(null,a.graphics,c)]:[3,29];case 28:(g=h.sent())&&
d.push(g),h.label=29;case 29:return[2,d]}})})};e.prototype._createBingMapsLayerJSON=function(a,c){return{culture:a.culture,key:a.key,type:"BingMaps"+("aerial"===a.style?"Aerial":"hybrid"===a.style?"Hybrid":"Road")}};e.prototype._createCSVLayerJSON=function(a,c){var d=c.layerView,b=c.printTemplate;return t(this,void 0,void 0,function(){var c,q;return v(this,function(k){switch(k.label){case 0:this._legendLayers&&this._legendLayers.push({id:a.id});if(!this._is11xService)return[3,1];c={type:"CSV"};a.write(c,
{origin:"web-map"});delete c.popupInfo;delete c.layerType;c.showLabels=b.showLabels&&a.labelsVisible;return[3,3];case 1:return[4,this._getGraphics(d)];case 2:return q=k.sent(),[2,this._createFeatureCollectionJSON(a,q,b)];case 3:return[2,c]}})})};e.prototype._createFeatureCollectionJSON=function(a,c,d){return t(this,void 0,void 0,function(){var b,k,q,u,r,p,f,g,h,n,e,t,l,w,z,B,A,x=this;return v(this,function(F){switch(F.label){case 0:b=a,k=m.createPolygonLayer(),q=m.createPolylineLayer(),u=m.createPointLayer(),
r=m.createMultipointLayer(),p=m.createPointLayer(),p.layerDefinition.name="textLayer",delete p.layerDefinition.drawingInfo,b&&("esri.layers.FeatureLayer"===b.declaredClass||"esri.layers.StreamLayer"===b.declaredClass?k.layerDefinition.name=q.layerDefinition.name=u.layerDefinition.name=r.layerDefinition.name=this._legendLayerNameMap[b.id]||b.get("arcgisProps.title")||b.title:"esri.layers.GraphicsLayer"===b.declaredClass&&(c=b.graphics.items)),f=b&&b.renderer&&"esri.renderer.SimpleRenderer"===b.renderer.declaredClass,
b&&b.renderer&&"function"!==typeof b.get("renderer.field")?(g=b.renderer.toJSON(),k.layerDefinition.drawingInfo.renderer=g,q.layerDefinition.drawingInfo.renderer=g,u.layerDefinition.drawingInfo.renderer=g,r.layerDefinition.drawingInfo.renderer=g):(delete k.layerDefinition.drawingInfo,delete q.layerDefinition.drawingInfo,delete u.layerDefinition.drawingInfo,delete r.layerDefinition.drawingInfo),h=b&&b.fields,n=b&&b.renderer,e=[],n&&"function"!==typeof b.get("renderer.field")&&("class-breaks"===n.type?
(h||(h=[{name:n.field,type:"esriFieldTypeDouble"}],n.normalizationField&&h.push({name:n.normalizationField,type:"esriFieldTypeDouble"})),n.field&&e.push(n.field),n.normalizationField&&e.push(n.normalizationField)):"unique-value"===n.type&&(h||(h=[{name:n.field,type:"esriFieldTypeString"}],n.field2&&h.push({name:n.field2,type:"esriFieldTypeString"}),n.field3&&h.push({name:n.field3,type:"esriFieldTypeString"})),n.field&&e.push(n.field),n.field2&&e.push(n.field2),n.field3&&e.push(n.field3))),h&&(k.layerDefinition.fields=
h,q.layerDefinition.fields=h,u.layerDefinition.fields=h,r.layerDefinition.fields=h),t=c&&c.length,w=function(a){var f,g,h,n;return v(this,function(J){switch(J.label){case 0:f=c[a]||c.getItemAt(a);if(!1===f.visible||!f.geometry)return[2,"continue"];l=f.toJSON();l.hasOwnProperty("popupTemplate")&&delete l.popupTemplate;l.geometry&&l.geometry.z&&delete l.geometry.z;if(l.symbol&&l.symbol.outline&&"esriCLS"===l.symbol.outline.type&&!z._is11xService)return[2,"continue"];l.symbol&&l.symbol.outline&&l.symbol.outline.color&&
l.symbol.outline.color[3]&&!z._is11xService&&(l.symbol.outline.color[3]=255);if(!b||!b.renderer||l.symbol||"function"!==typeof b.renderer.field&&!b.renderer.compiledFunc&&!b.renderer.hasVisualVariables())return[3,2];g=b.renderer;return[4,g.getSymbolAsync(f)];case 1:h=J.sent();if(!h)return[2,"continue"];l.symbol=h.toJSON();g.hasVisualVariables()&&m.applyVisualVariables(l.symbol,{renderer:g,graphic:f,symbol:h});J.label=2;case 2:return l.symbol&&(l.symbol.angle||delete l.symbol.angle,E(l.symbol)?l.symbol=
z._convertSvgToPictureMarkerSymbolJson(l.symbol):l.symbol.text&&delete l.attributes),d&&d.forceFeatureAttributes||(b&&b.renderer&&"simple"===b.renderer.type?delete l.attributes:e.length&&(n={},e.forEach(function(a){l.attributes&&l.attributes.hasOwnProperty(a)&&(n[a]=l.attributes[a])}),l.attributes=n)),"polygon"===f.geometry.type?k.featureSet.features.push(l):"polyline"===f.geometry.type?q.featureSet.features.push(l):"point"===f.geometry.type?l.symbol&&l.symbol.text?p.featureSet.features.push(l):u.featureSet.features.push(l):
"multipoint"===f.geometry.type?r.featureSet.features.push(l):"extent"===f.geometry.type&&(l.geometry=Q.fromExtent(f.geometry).toJSON(),k.featureSet.features.push(l)),[2]}})},z=this,B=0,F.label=1;case 1:return B<t?[5,w(B)]:[3,4];case 2:F.sent(),F.label=3;case 3:return B++,[3,1];case 4:return A=[k,q,r,u,p].filter(function(a){return 0<a.featureSet.features.length}),A.forEach(function(a){var b=a.featureSet.features.every(function(a){return a.symbol});!b&&!f||d&&d.forceFeatureAttributes||a.featureSet.features.forEach(function(a){delete a.attributes});
b&&delete a.layerDefinition.drawingInfo;a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&x._convertSvgRenderer(a.layerDefinition.drawingInfo.renderer)}),[2,A.length?{featureCollection:{layers:A}}:null]}})})};e.prototype._createFeatureLayerJSON=function(a,c){return t(this,void 0,void 0,function(){var d,b,k,q,e,r,p,f,g,h;return v(this,function(n){switch(n.label){case 0:this._legendLayers&&this._legendLayers.push({id:a.id});if((b=a.renderer)&&"dot-density"===b.type)return[2,this._createScreenshotJSON(a,
c)];k=c.layerView;q=c.printTemplate;e=c.view;r=b&&("valueExpression"in b&&b.valueExpression||"hasVisualVariables"in b&&b.hasVisualVariables());p=a.source&&"feature-layer"!==a.source.type;if(!this._is11xService&&r||a.featureReduction||p||!b||"field"in b&&!(null==b.field||"string"===typeof b.field&&a.getField(b.field)))return[3,1];d={};this._setURLandToken(d,a);a.write(d,{origin:"web-map"});delete d.layerType;delete d.popupInfo;delete d.visibility;d.showLabels=q.showLabels&&a.labelsVisible;d.layerDefinition&&
d.layerDefinition.drawingInfo&&d.layerDefinition.drawingInfo.renderer&&(this._convertSvgRenderer(d.layerDefinition.drawingInfo.renderer),"visualVariables"in b&&b.visualVariables&&b.visualVariables[0]&&(f=b.visualVariables[0],"size"===f.type&&f.maxSize&&"number"!==typeof f.maxSize&&f.minSize&&"number"!==typeof f.minSize&&(g=R.getSizeRangeAtScale(f,e.scale),d.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=g.minSize,d.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=g.maxSize)));
return[3,4];case 1:return[4,this._getGraphics(k)];case 2:return h=n.sent(),[4,this._createFeatureCollectionJSON(a,h,q)];case 3:d=n.sent(),n.label=4;case 4:return[2,d]}})})};e.prototype._createGraphicsLayerJSON=function(a,c){var d=c.printTemplate;return t(this,void 0,void 0,function(){return v(this,function(b){return[2,this._createFeatureCollectionJSON(a,null,d)]})})};e.prototype._createImageryLayerJSON=function(a,c){this._legendLayers&&this._legendLayers.push({id:a.id});c={bandIds:a.bandIds,compressionQuality:a.compressionQuality,
format:a.format,interpolation:a.interpolation};a.mosaicRule&&(c.mosaicRule=a.mosaicRule.toJSON());a.renderingRule&&(c.renderingRule=a.renderingRule.toJSON());this._setURLandToken(c,a);return c};e.prototype._createKMLLayerJSON=function(a,c){return t(this,void 0,void 0,function(){var d,b,k,q,e,r,p;return v(this,function(f){switch(f.label){case 0:d=c.printTemplate;if(this._is11xService)return b={type:"kml"},a.write(b,{origin:"web-map"}),delete b.layerType,b.url=x.normalize(a.url),b.showLabels=d.showLabels&&
a.labelsVisible,[2,b];k=[];q=c.layerView;q.allVisibleMapImages.forEach(function(b,c){c={id:a.id+"_image"+c,type:"image",title:a.id,minScale:a.minScale||0,maxScale:a.maxScale||0,opacity:a.opacity,extent:b.extent};"data:image/png;base64,"===b.href.substr(0,22)?c.imageData=b.href.substr(22):c.url=b.href;k.push(c)});e=q.allVisiblePoints.items.concat(q.allVisiblePolylines.items,q.allVisiblePolygons.items);p=[{id:a.id}];return[4,this._createFeatureCollectionJSON(null,e,d)];case 1:return r=M.apply(void 0,
p.concat([f.sent()])),k.push(r),[2,k]}})})};e.prototype._createMapImageLayerJSON=function(a,c){var d,b={id:a.id,subLayerIds:[]},k=[],q=c.view.scale,e=function(a){var c=0===q,d=0===a.minScale||q<=a.minScale,g=0===a.maxScale||q>=a.maxScale;a.visible&&(c||d&&g)&&(a.sublayers?a.sublayers.forEach(e):(c=a.toExportImageJSON().drawingInfo,d=a.toJSON(),d.layerDefinition.drawingInfo=c,k.unshift(d),b.subLayerIds.push(a.id)))};a.sublayers&&a.sublayers.forEach(e);k.length&&(k=k.map(function(a){return{id:a.id,
name:a.name,layerDefinition:a.layerDefinition}}),d={layers:k,visibleLayers:b.subLayerIds},this._setURLandToken(d,a),this._legendLayers.push(b));return d};e.prototype._createMapNotesLayerJSON=function(a,c){var d=c.layerView,b=c.printTemplate;return t(this,void 0,void 0,function(){var a,c,e,r,p;return v(this,function(f){switch(f.label){case 0:a=[],c=0,e=d.graphicsViews,f.label=1;case 1:if(!(c<e.length))return[3,4];r=e[c];return[4,this._createFeatureCollectionJSON(r,r.graphics,b)];case 2:(p=f.sent())&&
a.push.apply(a,p.featureCollection.layers),f.label=3;case 3:return c++,[3,1];case 4:return[2,{featureCollection:{layers:a}}]}})})};e.prototype._createOpenStreetMapLayerJSON=function(a,c){return{type:"OpenStreetMap"}};e.prototype._createScreenshotJSON=function(a,c){var d=c.printTemplate,b=c.view;return t(this,void 0,void 0,function(){var c,e,u,r,p,f,g,h,n,m;return v(this,function(k){switch(k.label){case 0:return c={type:"image"},e={format:"png",layers:[a],rotation:0},u=this._ssExtent||b.extent.clone(),
r=96,f=p=!0,d.exportOptions&&(g=d.exportOptions,0<g.dpi&&(r=g.dpi),0<g.width&&(p=g.width%2===b.width%2),0<g.height&&(f=g.height%2===b.height%2)),"map-only"!==d.layout||!d.preserveScale||d.outScale&&d.outScale!==b.scale||96!==r||p&&f||(e.area={x:0,y:0,width:b.width,height:b.height},p||--e.area.width,f||--e.area.height,this._ssExtent||(h=b.toMap(I.createScreenPoint(e.area.width,e.area.height)),u.ymin=h.y,u.xmax=h.x,this._ssExtent=u)),c.extent=u.clone()._normalize(!0).toJSON(),[4,b.takeScreenshot(e)];
case 1:return n=k.sent(),m=x.dataComponents(n.dataUrl),c.imageData=m.data,[2,c]}})})};e.prototype._createStreamLayerJSON=function(a,c){var d=c.layerView,b=c.printTemplate;return t(this,void 0,void 0,function(){var c;return v(this,function(e){switch(e.label){case 0:return this._legendLayers&&this._legendLayers.push({id:a.id}),[4,this._getGraphics(d)];case 1:return c=e.sent(),[2,this._createFeatureCollectionJSON(a,c,b)]}})})};e.prototype._createTileLayerJSON=function(a,c){c={};this._setURLandToken(c,
a);return c};e.prototype._createVectorTileLayerJSON=function(a,c){return t(this,void 0,void 0,function(){var d,b,e;return v(this,function(k){return this._is11xService&&a.serviceUrl&&a.styleUrl&&(d=w.id&&w.id.findCredential(a.styleUrl),b=w.id&&w.id.findCredential(a.serviceUrl),!d&&!b||"2.1.0"!==this._cimVersion)?(e={type:"VectorTileLayer"},e.styleUrl=x.normalize(a.styleUrl),d&&(e.token=d.token),b&&b.token!==e.token&&(e.additionalTokens=[{url:a.serviceUrl,token:b.token}]),[2,e]):[2,this._createScreenshotJSON(a,
c)]})})};e.prototype._createWebTileLayerJSON=function(a,c){c={type:"WebTiledLayer",urlTemplate:a.urlTemplate.replace(/\${/g,"{"),credits:a.copyright};a.subDomains&&0<a.subDomains.length&&(c.subDomains=a.subDomains);return c};e.prototype._createWMSLayerJSON=function(a,c){var d,b=[],e=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(e):a.name&&b.unshift(a.name))};a.sublayers&&a.sublayers.forEach(e);b.length&&(d={type:"wms",transparentBackground:a.imageTransparency,visibleLayers:b,url:x.normalize(a.url),
version:a.version});return d};e.prototype._createWMTSLayerJSON=function(a,c){c=a.activeLayer;return{type:"wmts",format:c.imageFormat,layer:c.id,style:c.styleId,tileMatrixSet:c.tileMatrixSetId,url:x.normalize(a.url)}};e.prototype._setURLandToken=function(a,c){c.url&&(a.url=x.normalize(c.url),c=w.id&&w.id.findCredential(c.url))&&(a.token=c.token)};e.prototype._convertSvgToPictureMarkerSymbolJson=function(a){this._canvasParent?(this._canvasSurface.clear(),this._canvasSurface.setDimensions(1024,1024)):
(this._canvasParent=document.createElement("div"),this._canvasSurface=G.createSurface(this._canvasParent,1024,1024));var c;c="image/svg+xml"===a.contentType?this._canvasSurface.createObject(G.Image,{src:"data:image/svg+xml;base64,"+a.imageData,width:I.pt2px(a.width),height:I.pt2px(a.height),x:0,y:0}):this._canvasSurface.createObject(G.Path,a.path).setFill(a.color).setStroke(a.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var d=this._canvasSurface.rawNode.getContext("2d");
c=c.getBoundingBox();var b=Math.ceil(c.width+c.x),e=Math.ceil(c.height+c.y),q=d.getImageData(c.x,c.y,b,e);d.canvas.width=b;d.canvas.height=e;d.putImageData(q,0,0);return{type:"esriPMS",imageData:d.canvas.toDataURL("image/png").substr(22),angle:a.angle,contentType:"image/png",height:a.size?a.size:e-c.y,width:a.size?a.size:b-c.x,xoffset:a.xoffset,yoffset:a.yoffset}};e.prototype._convertSvgRenderer=function(a){var c=this,d=a.type;if("simple"===d&&E(a.symbol))a.symbol=this._convertSvgToPictureMarkerSymbolJson(a.symbol);
else if("unique-value"===d||"class-breaks"===d)E(a.defaultSymbol)&&(a.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(a.defaultSymbol)),(a=a["unique-value"===d?"uniqueValueInfos":"classBreakInfos"])&&a.forEach(function(a){E(a.symbol)&&(a.symbol=c._convertSvgToPictureMarkerSymbolJson(a.symbol))})};e.prototype._getGraphics=function(a){return a.queryFeatures(Z).then(function(a){return a.features})};e.prototype._getPrintDefinition=function(a,c){return t(this,void 0,void 0,function(){var d,b,e,
q,m;return v(this,function(k){switch(k.label){case 0:return d=a.view,b=d.spatialReference,q={},[4,this._createOperationalLayers(d,c)];case 1:return e=(q.operationalLayers=k.sent(),q),m=this._ssExtent||a.extent||d.extent,b&&b.isWrappable&&(m=m.clone()._normalize(!0),b=m.spatialReference),e.mapOptions={extent:m&&m.toJSON(),spatialReference:b&&b.toJSON(),showAttribution:c.attributionVisible},this._ssExtent=null,d.rotation&&(e.mapOptions.rotation=-d.rotation),c.preserveScale&&(e.mapOptions.scale=c.outScale||
d.scale),[2,e]}})})};e.prototype._getGpPrintParams=function(a){return t(this,void 0,void 0,function(){var c,d,b,e,m,u,r,p,f,g,h,n,t,w,l,x,z,B,A,y=this;return v(this,function(k){switch(k.label){case 0:c=a.template||new W;null==c.showLabels&&(c.showLabels=!0);d=c.exportOptions;e=V.toJSON(c.layout);d&&(m=d.dpi,b={dpi:m},"map_only"===e.toLowerCase()||""===e)&&(u=d.width,r=d.height,b.outputSize=[u,r]);if(p=c.layoutOptions){h=g=void 0;if("Miles"===p.scalebarUnit||"Kilometers"===p.scalebarUnit)g="Kilometers",
h="Miles";else if("Meters"===p.scalebarUnit||"Feet"===p.scalebarUnit)g="Meters",h="Feet";f={titleText:p.titleText,authorText:p.authorText,copyrightText:p.copyrightText,customTextElements:p.customTextElements,scaleBarOptions:{metricUnit:L.toJSON(g),metricLabel:K[g],nonMetricUnit:L.toJSON(h),nonMetricLabel:K[h]}}}n=null;p&&p.legendLayers&&(n=p.legendLayers.map(function(a){y._legendLayerNameMap[a.layerId]=a.title;var b={id:a.layerId};a.subLayerIds&&(b.subLayerIds=a.subLayerIds);return b}));return[4,
this._getPrintDefinition(a,c)];case 1:return t=k.sent(),t.operationalLayers&&(l=/[\u4E00-\u9FFF\u0E00-\u0E7F\u0900-\u097F\u3040-\u309F\u30A0-\u30FF\u31F0-\u31FF]/,x=/[\u0600-\u06FF]/,z=function(a){var b=a.text,c=(a=a.font)&&a.family&&a.family.toLowerCase();b&&a&&("arial"===c||"arial unicode ms"===c)&&(a.family=l.test(b)?"Arial Unicode MS":"Arial","normal"!==a.style&&x.test(b)&&(a.family="Arial Unicode MS"))},t.operationalLayers.forEach(function(a){a.featureCollection&&a.featureCollection.layers&&
a.featureCollection.layers.forEach(function(a){a.layerDefinition&&a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&a.layerDefinition.drawingInfo.renderer.symbol&&(w=a.layerDefinition.drawingInfo.renderer,"esriTS"===w.symbol.type&&z(w.symbol));a.featureSet&&a.featureSet.features&&a.featureSet.features.forEach(function(a){a.symbol&&"esriTS"===a.symbol.type&&z(a.symbol)})})})),a.outSpatialReference&&(t.mapOptions.spatialReference=a.outSpatialReference.toJSON()),H.mixin(t,{exportOptions:b,
layoutOptions:f}),H.mixin(t.layoutOptions,{legendOptions:{operationalLayers:null!=n?n:this._legendLayers.slice()}}),this._legendLayers.length=0,B=JSON.stringify(t),A={Web_Map_as_JSON:B,Format:U.toJSON(c.format),Layout_Template:e},a.extraParameters&&H.mixin(A,a.extraParameters),[2,A]}})})};C([y.property({dependsOn:["url","updateDelay"]})],e.prototype,"_geoprocessor",null);C([y.property()],e.prototype,"_gpMetadata",void 0);C([y.property({dependsOn:["_gpMetadata"],readOnly:!0})],e.prototype,"mode",null);
C([y.property()],e.prototype,"updateDelay",void 0);return e=C([y.subclass("esri.tasks.PrintTask")],e)}(y.declared(T))});