// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define(["require","exports","./iteratorUtils","./PooledArray","./string"],function(e,h,m,n,k){Object.defineProperty(h,"__esModule",{value:!0});e=function(){function a(b,d,c){this._namespace=b;this._storage=d;this._removeFunc=!1;this._miss=this._hit=0;this._storage.register(this);this._namespace+=":";c&&(this._storage.registerRemoveFunc(this._namespace,c),this._removeFunc=!0)}Object.defineProperty(a.prototype,"namespace",{get:function(){return this._namespace.slice(0,-1)},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"hitRate",{get:function(){return this._hit/(this._hit+this._miss)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"size",{get:function(){return this._storage.size},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSize",{get:function(){return this._storage.maxSize},enumerable:!0,configurable:!0});a.prototype.resetHitRate=function(){this._hit=this._miss=0};a.prototype.destroy=function(){this._storage.clear(this._namespace);this._removeFunc&&
this._storage.deregisterRemoveFunc(this._namespace);this._storage.deregister(this)};a.prototype.put=function(b,d,c,a){void 0===a&&(a=1);this._storage.put(this._namespace+b,d,c,a)};a.prototype.get=function(b){b=this._storage.get(this._namespace+b);void 0===b?++this._miss:++this._hit;return b};a.prototype.pop=function(b){b=this._storage.pop(this._namespace+b);void 0===b?++this._miss:++this._hit;return b};a.prototype.clear=function(){this._storage.clear(this._namespace)};a.prototype.clearAll=function(){this._storage.clearAll()};
a.prototype.getStats=function(){return this._storage.getStats()};a.prototype.resetStats=function(){this._storage.resetStats()};return a}();h.MemCache=e;e=function(){function a(b){void 0===b&&(b=10485760);this._maxSize=b;this._db=new Map;this._miss=this._hit=this._size=0;this._removeFuncs=[];this._users=new n}a.prototype.register=function(b){this._users.push(b)};a.prototype.deregister=function(b){this._users.removeUnordered(b)};a.prototype.registerRemoveFunc=function(b,d){this._removeFuncs.push([b,
d])};a.prototype.deregisterRemoveFunc=function(b){this._removeFuncs=this._removeFuncs.filter(function(d){return d[0]!==b})};Object.defineProperty(a.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSize",{get:function(){return this._maxSize},set:function(b){this._maxSize=Math.max(b,0);this._size>this._maxSize&&this._removeEntries()},enumerable:!0,configurable:!0});a.prototype.put=function(b,d,a,g){if(this._db.has(b)){var c=this._db.get(b);
this._size-=c.size;this._db.delete(b);this._notifyRemoved(b,c.entry)}a>this._maxSize?this._notifyRemoved(b,d):void 0===d?console.warn("Refusing to cache undefined entry "):!a||0>a?console.warn("Refusing to cache entry with invalid size "+a):(this._db.set(b,{entry:d,size:a,lifetime:g,lives:g}),this._size+=a,this._size>this._maxSize&&this._removeEntries())};a.prototype.pop=function(b){if(this._db.has(b)){var a=this._db.get(b);this._size-=a.size;this._db.delete(b);++this._hit;return a.entry}++this._miss};
a.prototype.get=function(b){var a=this._db.get(b);if(void 0===a)++this._miss;else return this._db.delete(b),a.lives=a.lifetime,this._db.set(b,a),++this._hit,a.entry};a.prototype.getStats=function(){var b=this,a={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},c={},g=[];this._db.forEach(function(a,d){var l=a.lifetime;g[l]=(g[l]||0)+1;b._users.forEach(function(b){b=b.namespace;if(k.startsWith(d,
b))return c[b]=(c[b]||0)+a.size,!1})});var e={};this._users.forEach(function(b){var a=b.namespace;!isNaN(b.hitRate)&&0<b.hitRate?(c[a]=c[a]||0,e[a]=Math.round(100*b.hitRate)+"%"):e[a]="0%"});var f=Object.keys(c);f.forEach(function(a){return c[a]=c[a]/b._size*100});f.sort(function(b,a){return c[a]-c[b]});f.forEach(function(b){return a[b]=Math.round(c[b])+"% / "+e[b]});for(f=0;f<g.length;++f){var h=g[f];h&&(a["Lifetime "+f]=Math.round(h/this._db.size*100)+"%")}return a};a.prototype.resetStats=function(){this._hit=
this._miss=0;this._users.forEach(function(b){return b.resetHitRate()})};a.prototype.clear=function(b){var a=this;this._db.forEach(function(c,d){k.startsWith(d,b)&&(a._size-=c.size,a._db.delete(d),a._notifyRemoved(d,c.entry))})};a.prototype.clearAll=function(){var b=this;this._db.forEach(function(a,c){b._notifyRemoved(c,a.entry)});this._size=0;this._db.clear()};a.prototype._getHitRate=function(){return this._hit/(this._hit+this._miss)};a.prototype._notifyRemoved=function(b,a){this._removeFuncs.forEach(function(c){if(k.startsWith(b,
c[0]))c[1](a)})};a.prototype._removeEntries=function(){var a=this;m.everyMap(this._db,function(b,c){a._db.delete(c);1>=b.lives?(a._size-=b.size,a._notifyRemoved(c,b.entry)):(--b.lives,a._db.set(c,b));return a._size>.9*a.maxSize})};return a}();h.MemCacheStorage=e});