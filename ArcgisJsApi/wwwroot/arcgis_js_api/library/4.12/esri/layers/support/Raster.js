// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("../../core/Accessor ../../core/lang ../../core/urlUtils ../../core/promiseUtils ../../request ../../geometry/Extent ../../geometry/SpatialReference ./PixelBlock ./rasterFormats/RasterCodec ./rasterFormats/ImageCanvasDecoder".split(" "),function(k,g,l,f,m,n,p,q,h,r){return k.createSubclass({declaredClass:"esri.layers.support.Raster",validPixelTypes:"u1 u2 u4 u8 u16 u32 s8 s16 s32 f32".split(" "),validFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq".split(" "),properties:{parsedUrl:{readOnly:!0,
dependsOn:["url"],get:function(){return this.url?l.urlToObject(this.url):null}},url:null},read:function(a){if(!a.imageServiceParameters||!a.nBands)return f.reject(Error("Insufficient parameters to read data"));var b=g.clone(a.imageServiceParameters),c=a.nBands,d=a.pixelType||"f32";a=a.requestAsImageElement;-1>=this.validPixelTypes.indexOf(d.toUpperCase())&&(b.pixelType="f32");b.format=b.format||"lerc";-1>=this.validFormats.indexOf(b.format.toLowerCase())&&(b.format="lerc");this._prepareGetImageParameters(b);
var e=g.clone(b);this._cleanupRequestParams(e);return this._requestArrayBuffer(b,e,c,d,a)},_requestArrayBuffer:function(a,b,c,d,e){return m(this.parsedUrl.path+"/exportImage",{responseType:"array-buffer",query:g.mixin(b,{f:"image"})}).then(function(b){b=b.data;if(!this._isDataValid(b))return b=Error(String.fromCharCode.apply(null,new Uint8Array(b))),f.reject(b);var c=a.format.toUpperCase(),d=c;"BSQ"!==d&&"BIP"!==d&&(d=h.getFormat(b));if(-1>=this.validFormats.indexOf(d.toLowerCase()))return f.reject(Error("Cannot decode the pixelBlock. Unsupported Format: "+
d));if(-1<c.indexOf("PNG")&&("png"===d||"jpg"===d))return e?this._getImageElement(b,a,d):this._decodePixelBlockWithCanvas(b,a);try{return this._decodePixelBlock(b,{width:a.width,height:a.height,planes:null,pixelType:null,noDataValue:null,format:c}).then(function(b){return{pixelData:{pixelBlock:b,extent:a.extent},params:a}})}catch(t){return f.reject(t)}}.bind(this))},_prepareGetImageParameters:function(a){if(a.size&&a.bbox){var b=a.size.split(",");a.width=parseFloat(b[0]);a.height=parseFloat(b[1]);
a.extent||(b=a.bbox.split(","),a.extent=new n(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3]),new p(a.bboxSR)))}else{if(!a.width||Math.floor(a.width)!==a.width||!a.height||Math.floor(a.height)!==a.height)throw Error("Incorrect Image Dimensions");if(!a.extent||"esri.geometry.Extent"!==a.extent.declaredClass)throw Error("Incorrect extent");var b=a.extent,c=b.spatialReference.wkid||JSON.stringify(b.spatialReference.toJSON());delete a._ts;g.mixin(a,{bbox:b.xmin+","+b.ymin+","+b.xmax+
","+b.ymax,imageSR:c,bboxSR:c,size:a.width+","+a.height},a.disableClientCaching?{_ts:Date.now()}:{})}},_adjustExtent:function(a,b,c){var d=a.ymax-a.ymin,e=a.xmax-a.xmin;c>=b?a.ymax=a.ymin+e*b/c:a.xmax=a.xmin+d*c/b;return a},_cleanupRequestParams:function(a){if(!a)return a;var b=["width","height","extent"],c;for(c in b)a.hasOwnProperty(b[c])&&delete a[b[c]];return a},_getFormat:function(a){a=new Uint8Array(a,0,10);var b="";255===a[0]&&216===a[1]?b="JPEG":137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]?
b="PNG":67===a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9]?b="LERC":-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error")&&(b="ERROR");return b},_isDataValid:function(a){a=new Uint8Array(a,0,10);return-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error")?!1:!0},_decodePixelBlock:function(a,b){return this._rasterJobHandler?this._rasterJobHandler.decode({data:a,options:b}):h.decode(a,b)},_decodePixelBlockWithCanvas:function(a,
b){this._canvasDecoder=this._canvasDecoder||new r;return this._canvasDecoder.decode(a,b).then(function(a){a=new q(a);a.calculateStatistics();return{pixelData:{pixelBlock:a,extent:b.extent},params:b}},function(a){return f.reject(Error("Failed to load raster"))})},_getImageElement:function(a,b,c){a=new Blob([a],{type:"image/"+("PNG"===c?"png":"jpeg")});var d=URL.createObjectURL(a),e=new Image;a=f.createResolver();c=a.promise;e.addEventListener("load",a);e.addEventListener("error",a.reject);e.src=d;
return c.then(function(){URL.revokeObjectURL(d);return{imageElement:e,params:b}},function(a){URL.revokeObjectURL(d);return f.reject(Error("Failed to load raster"))})}})});