// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/extendsHelper @dojo/framework/shim/Map ../../../core/Error ../../../core/Evented ../../../core/has ../../../core/Logger ../../../core/maybe ../../../core/libs/rbush/rbush ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../featureConversionUtils ./optimizedFeatureQueryEngineAdapter".split(" "),function(m,n,A,B,C,k,q,r,t,u,p,v,w,l,x,y){Object.defineProperty(n,
"__esModule",{value:!0});var g=[],z=u.getLogger("esri.layers.graphics.data.FeatureStore"),h={minX:0,minY:0,maxX:0,maxY:0};m=function(){function c(a,b,d){this._geometryInfo=a;this._onFeatureAdd=b;this._onFeatureRemove=d;this._featuresById=new k.default;this._boundsByFeature=new k.default;this._featuresByBounds=new k.default;this._index=v(9,t("csp-restrictions")?function(a){return{minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]}}:["[0]","[1]","[2]","[3]"]);this.events=new r;this.featureAdapter=y.optimizedFeatureQueryEngineAdapter}
Object.defineProperty(c.prototype,"geometryType",{get:function(){return this._geometryInfo.geometryType},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasM",{get:function(){return this._geometryInfo.hasM},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasZ",{get:function(){return this._geometryInfo.hasZ},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"numFeatures",{get:function(){return this._featuresById.size},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"fullBounds",{get:function(){if(!this.numFeatures)return null;var a=l.create(l.NEGATIVE_INFINITY);this._boundsByFeature.forEach(function(b){b&&(a[0]=Math.min(b[0],a[0]),a[1]=Math.min(b[1],a[1]),a[2]=Math.max(b[2],a[2]),a[3]=Math.max(b[3],a[3]))});return a},enumerable:!0,configurable:!0});c.prototype.add=function(a){this._add(a,g);this._index.load(g);this._emitChanged();g.length=0};c.prototype.addMany=function(a){for(var b=0;b<a.length;b++)this._add(a[b],g);this._index.load(g);
this._emitChanged();g.length=0};c.prototype.clear=function(){this._featuresById.clear();this._boundsByFeature.clear();this._featuresByBounds.clear();this._index.clear();this._emitChanged()};c.prototype.removeById=function(a){var b=this._featuresById.get(a);if(!b)return null;var d=this._boundsByFeature.get(b);d&&(this._index.remove(d),this._featuresByBounds.delete(d));this._boundsByFeature.delete(b);this._featuresById.delete(a);this._emitChanged();return b};c.prototype.removeIf=function(a,b){var d=
this;this._featuresById.forEach(function(e,f){b(e)&&(d._remove(e),a.push(e))});this._emitChanged()};c.prototype.removeManyById=function(a){for(var b=0;b<a.length;b++){var d=a[b],e=this._featuresById.get(d);if(e){var f=this._boundsByFeature.get(e);f&&(this._index.remove(f),this._featuresByBounds.delete(f));this._boundsByFeature.delete(e)}this._featuresById.delete(d)}this._emitChanged()};c.prototype.forEachBounds=function(a,b,d){for(var e=0;e<a.length;e++){var f=this._boundsByFeature.get(a[e]);f&&b(w.fromRect(d,
f))}};c.prototype.getFeature=function(a){return this._featuresById.get(a)};c.prototype.has=function(a){return this._featuresById.has(a)};c.prototype.forEach=function(a){this._featuresById.forEach(function(b){return a(b)})};c.prototype.forEachInBounds=function(a,b){var d=0,e=this._index;h.minX=a[0];h.minY=a[1];h.maxX=a[2];h.maxY=a[3];for(a=e.search(h);d<a.length;d++)b(this._featuresByBounds.get(a[d]))};c.prototype.transferById=function(a,b){if(b=this._featuresById.get(b))this._remove(b),a.add(b),this._emitChanged()};
c.prototype.transferByIds=function(a,b){for(var d=[],e=0;e<b.length;e++){var f=this._featuresById.get(b[e]);f&&(this._remove(f),d.push(f))}a.addMany(d);this._emitChanged()};c.prototype.transferIdRange=function(a,b,d){for(var e=[];b<d;b++){var f=this._featuresById.get(b);f&&(this._remove(f),e.push(f))}a.addMany(e);this._emitChanged()};c.prototype.transferIf=function(a,b){var d=this,e=[];this._featuresById.forEach(function(a,c){b(a)&&(d._remove(a),e.push(a))});a.addMany(e);this._emitChanged()};c.prototype.transferAll=
function(a){var b=this,d=[];this._featuresById.forEach(function(a,c){b._remove(a);d.push(a)});a.addMany(d);this._emitChanged()};c.prototype._emitChanged=function(){this.events.emit("changed",void 0)};c.prototype._add=function(a,b){if(a){var d=a.objectId;if(null==d)z.error(new q("featurestore:invalid-feature","feature id is missing",{feature:a}));else{var e=this._featuresById.get(d),c;e?(c=this._boundsByFeature.get(e),a.localId=e.localId,c&&(this._index.remove(c),this._boundsByFeature.delete(e),this._featuresByBounds.delete(c))):
p.isSome(this._onFeatureAdd)&&this._onFeatureAdd(a);a.geometry?(c=x.getBoundsOptimizedGeometry(c||l.create(),a.geometry,this._geometryInfo.hasZ,this._geometryInfo.hasM),this._boundsByFeature.set(a,c),this._featuresByBounds.set(c,a),this._featuresById.set(d,a),b.push(c)):(this._boundsByFeature.set(a,null),this._featuresById.set(d,a))}}};c.prototype._remove=function(a){var b;if(a){p.isSome(this._onFeatureRemove)&&this._onFeatureRemove(a);if(b=this._boundsByFeature.get(a))this._index.remove(b),this._boundsByFeature.delete(a),
this._featuresByBounds.delete(b);this._featuresById.delete(a.objectId)}};return c}();n.default=m});