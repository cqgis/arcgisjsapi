// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../geometry ../../../core/Accessor ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/requireUtils ../../../core/workers ../../../core/accessorSupport/decorators ../data/QueryEngineCapabilities ../../support/TimeInfo ../../../tasks/support/FeatureSet module".split(" "),
function(x,n,y,h,z,A,r,e,p,B,C,D,q,K,E,F,f,G,H,I,J){Object.defineProperty(n,"__esModule",{value:!0});var v=D.getLogger("esri.layers.graphics.sources.GeoJSONSource");e=function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;a.type="geojson";a.fullExtent=null;a.timeInfo=null;return a}y(c,e);c.prototype.load=function(a){a=q.isSome(a)?a.signal:null;this.addResolvingPromise(this._startWorker(a));return this.when()};c.prototype.applyEdits=function(a){var b=this;return this.load().then(function(){return b._applyEdits(a)})};
c.prototype.openPorts=function(){var a=this;return this.load().then(function(){return a._connection.openPorts()})};c.prototype.queryFeatures=function(a,b){var d=this;void 0===b&&(b={});return this.load(b).then(function(){return d._connection.invoke("queryFeatures",a?a.toJSON():null,b)}).then(function(a){return I.fromJSON(a)})};c.prototype.queryFeaturesJSON=function(a,b){var d=this;void 0===b&&(b={});return this.load(b).then(function(){return d._connection.invoke("queryFeatures",a?a.toJSON():null,
b)})};c.prototype.queryFeatureCount=function(a,b){var d=this;void 0===b&&(b={});return this.load(b).then(function(){return d._connection.invoke("queryFeatureCount",a?a.toJSON():null,b)})};c.prototype.queryObjectIds=function(a,b){var d=this;void 0===b&&(b={});return this.load(b).then(function(){return d._connection.invoke("queryObjectIds",a?a.toJSON():null,b)})};c.prototype.queryExtent=function(a,b){var d=this;void 0===b&&(b={});return this.load(b).then(function(){return d._connection.invoke("queryExtent",
a?a.toJSON():null,b)}).then(function(a){return{count:a.count,extent:r.Extent.fromJSON(a.extent)}})};c.prototype._applyEdits=function(a){var b=this;if(!this._connection)throw new p("geojson-layer-source:edit-failure","Memory source not loaded");var d=this.layer.objectIdField,c=[],e=[],f=[];if(a.addFeatures)for(var k=0,m=a.addFeatures;k<m.length;k++){var g=m[k];c.push(this._serializeFeature(g))}if(a.deleteFeatures)for(k=0,m=a.deleteFeatures;k<m.length;k++)g=m[k],"objectId"in g&&null!=g.objectId?e.push(g.objectId):
"attributes"in g&&null!=g.attributes[d]&&e.push(g.attributes[d]);if(a.updateFeatures)for(d=0,a=a.updateFeatures;d<a.length;d++)g=a[d],f.push(this._serializeFeature(g));return this._connection.invoke("applyEdits",{adds:c,updates:f,deletes:e}).then(function(a){var c=a.timeExtent,d=a.featureEditResults;b.fullExtent=a.fullExtent;b.timeInfo&&(a=b.timeInfo.clone(),a.read({timeExtent:c}),b.timeInfo=a);return b._createEditsResult(d)})};c.prototype._createEditsResult=function(a){return{addFeatureResults:a.addResults?
a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};c.prototype._createFeatureEditResult=function(a){var b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new p("geojson-layer-source:edit-failure",b.description,{code:b.code}):null}};c.prototype._serializeFeature=
function(a){var b=a.attributes;return(a=this._geometryForSerialization(a))?{geometry:a.toJSON(),attributes:b}:{attributes:b}};c.prototype._geometryForSerialization=function(a){a=a.geometry;return q.isNone(a)?null:"mesh"===a.type||"extent"===a.type?r.Polygon.fromExtent(a.extent):a};c.prototype._startWorker=function(a){return A(this,void 0,void 0,function(){var b,c,e,f,h,k,m,g,n,p,q,l,t,u,w;return z(this,function(d){switch(d.label){case 0:return[3,2];case 1:d.sent(),d.label=2;case 2:return b=this,[4,
F.open(E.getAbsMid("./geojson/GeoJSONSourceWorker",x,J),{strategy:B("esri-workers-for-memory-layers")?"dedicated":"local",signal:a})];case 3:return b._connection=d.sent(),c=this.layer,e=c.fields,f=c.spatialReference,h=c.hasZ,k=c.geometryType,m=c.objectIdField,g=c.url,n=c.timeInfo,p="defaults"===this.layer.originOf("spatialReference"),q={url:g,fields:e&&e.map(function(a){return a.toJSON()}),geometryType:r.typeKebabDictionary.toJSON(k),hasZ:h,objectIdField:m,timeInfo:n?n.toJSON():null,spatialReference:p?
null:f&&f.toJSON()},[4,this._connection.invoke("load",q,{signal:a})];case 4:l=d.sent();t=0;for(u=l.warnings;t<u.length;t++)w=u[t],v.warn(w.message,{layer:this.layer});l.featureErrors.length&&v.warn("Encountered "+l.featureErrors.length+" validation errors while loading features",l.featureErrors);this.fullExtent=r.Extent.fromJSON(l.layerDefinition.extent);this.timeInfo=H.fromJSON(l.layerDefinition.timeInfo);this.layerDefinition=l.layerDefinition;this.capabilities={attachment:null,data:{supportsAttachment:!1,
supportsM:!1,supportsZ:l.layerDefinition.hasZ},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsUpdate:!0,supportsExceedsLimitStatistics:!0},query:G.queryCapabilities,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0},editing:{supportsGeometryUpdate:!0,supportsGlobalId:!1,
supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}};return[2]}})})};h([f.property()],c.prototype,"capabilities",void 0);h([f.property()],c.prototype,"type",void 0);h([f.property()],c.prototype,"fullExtent",void 0);h([f.property({constructOnly:!0})],c.prototype,"layer",void 0);h([f.property()],c.prototype,"layerDefinition",void 0);h([f.property()],c.prototype,
"timeInfo",void 0);return c=h([f.subclass("esri.layers.graphics.sources.GeoJSONSource")],c)}(f.declared(e,C));n.GeoJSONSource=e;n.default=e});