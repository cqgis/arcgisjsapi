// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper @dojo/framework/shim/Set ../../../core/maybe ../../../core/promiseUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils".split(" "),function(C,z,A,J,K,L,M,n,D,w,N,G,O,H,P,p){Object.defineProperty(z,"__esModule",
{value:!0});C=function(){function f(a,b,e){this.items=a;this.queryGeometry=b;this.definitionExpression=e.definitionExpression;this.geometryType=e.geometryType;this.hasM=e.hasM;this.hasZ=e.hasZ;this.objectIdField=e.objectIdField;this.spatialReference=e.spatialReference;this.fieldsIndex=e.fieldsIndex;this.timeInfo=e.timeInfo;this.featureAdapter=e.featureAdapter}Object.defineProperty(f.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0});f.prototype.createQueryResponse=
function(a){var b;b=a.outStatistics?a.outStatistics.some(function(a){return"exceedslimit"===a.statisticType})?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(w.isValid(a.outSR)&&!w.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=p.cleanFromGeometryEngine(A({spatialReference:a.outSR},H.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR))):b.queryGeometry=p.cleanFromGeometryEngine(A({spatialReference:a.outSR},
this.queryGeometry)));return b};f.prototype.executeAttributesQuery=function(a){var b=O.getWhereClause(a.where,this.fieldsIndex);if(!b)return n.resolve(this);if(b.isStandardized){for(var e=0,h=[],d=0,c=this.items;d<c.length;d++){var g=c[d];b.testFeature(g,this.featureAdapter)&&(h[e++]=g)}b=new f(h,this.queryGeometry,this);b.definitionExpression=a.where;return n.resolve(b)}return n.reject(new TypeError("Where clause is not standardized"))};f.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||
!a.objectIds.length)return n.resolve(this);var b=new L.default(a.objectIds),e=this.featureAdapter.getObjectId;return n.resolve(new f(this.items.filter(function(a){return b.has(e(a))}),this.queryGeometry,this))};f.prototype.executeTimeQuery=function(a){a=P.getTimeOperator(this.timeInfo,a.timeExtent,this.featureAdapter);if(!M.isSome(a))return n.resolve(this);a=this.items.filter(a);return n.resolve(new f(a,this.queryGeometry,this))};f.prototype.project=function(a){return K(this,void 0,void 0,function(){var b,
e,h,d=this;return J(this,function(c){switch(c.label){case 0:if(!a||w.equals(this.spatialReference,a))return[2,this];b=this.featureAdapter;return[4,H.projectMany(this.items.map(function(a){return p.getGeometry(d,b.getGeometry(a))}),this.spatialReference,a)];case 1:return e=c.sent(),h=e.map(function(a,c){return b.cloneWithGeometry(d.items[c],N.convertFromGeometry(a,d.hasZ,d.hasM))}),[2,new f(h,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,
hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}})})};f.prototype._createFeatureQueryResponse=function(a){var b=this,e=this.items,h=this.geometryType,d=this.hasM,c=this.hasZ,g=this.objectIdField,l=this.spatialReference,I=a.outFields,f=a.outSR,q=a.quantizationParameters,k=a.resultRecordCount,t=a.resultOffset,m=!1;null!=k&&null!=t&&(k=t+k,m=e.length>k,e=e.slice(t,Math.min(e.length,k)));return{exceededTransferLimit:m,
features:this._createFeatures(a,e),fields:I&&I.map(function(a){return b.fieldsIndex.get(a)}),geometryType:h,hasM:d,hasZ:c,objectIdFieldName:g,spatialReference:p.cleanFromGeometryEngine(f?f:l),transform:q&&D.toQuantizationTransform(q)||null}};f.prototype._createFeatures=function(a,b){var e=new G.default(a,this.featureAdapter,this.fieldsIndex),h=a.quantizationParameters,d=a.returnGeometry,c=a.returnCentroid,g=a.maxAllowableOffset,l=a.orderByFields;a=[];var f=0;if(b.length&&l&&l.length){var l=l[0].split(" "),
u=l[0],q=this.fieldsIndex.get(u),k="DESC"===l[1];b.sort(function(a,b){a=e.getFieldValue(a,u,q);b=e.getFieldValue(b,u,q);if("number"===typeof a&&"number"===typeof b)return k?b-a:a-b;if("string"===typeof a&&"string"===typeof b)return a=a.toUpperCase(),b=b.toUpperCase(),(k?a>b:a<b)?-1:(k?a<b:a>b)?1:0})}if(d||c)if(h=D.toQuantizationTransform(h),d&&!c)for(c=0;c<b.length;c++)d=b[c],a[f++]={attributes:e.getAttributes(d),geometry:p.getGeometry(this,this.featureAdapter.getGeometry(d),g,h)};else if(!d&&c)for(g=
0;g<b.length;g++)d=b[g],a[f++]={attributes:e.getAttributes(d),centroid:p.transformCentroid(this,this.featureAdapter.getCentroid(d,this),h)};else for(c=0;c<b.length;c++)d=b[c],a[f++]={attributes:e.getAttributes(d),centroid:p.transformCentroid(this,this.featureAdapter.getCentroid(d,this),h),geometry:p.getGeometry(this,this.featureAdapter.getGeometry(d),g,h)};else for(g=0;g<b.length;g++)d=b[g],(d=e.getAttributes(d))&&(a[f++]={attributes:d});return a};f.prototype._createExceedsLimitQueryResponse=function(a){var b=
!1,e=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,d=0;for(a=a.outStatistics;d<a.length;d++){var c=a[d];if("exceedslimit"===c.statisticType){e=null!=c.maxPointCount?c.maxPointCount:Number.POSITIVE_INFINITY;h=null!=c.maxRecordCount?c.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=c.maxVertexCount?c.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)b=this.items.length>e;else if(this.items.length>h)b=!0;else var e=this.hasZ?this.hasM?
4:3:this.hasM?3:2,g=this.featureAdapter,b=this.items.reduce(function(a,b){b=g.getGeometry(b);return a+(b&&b.coords.length||0)},0)/e>b;return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};f.prototype._createStatisticsQueryResponse=function(a){var b=new G.default(a,this.featureAdapter,this.fieldsIndex),e=a.outStatistics,h=[],d=[],c=a.groupByFieldsForStatistics;
a=a.having;for(var g=c&&c.length,c=g&&c[0],f=this.fieldsIndex.get(c),p=!f,u={},q={},k={},t={attributes:{}},m=0;m<e.length;m++){var r=e[m],n=r.outStatisticFieldName,x=r.statisticType,r="exceedslimit"!==x?r.onStatisticField:void 0,w=this.fieldsIndex.get(r),C=g&&(r===c||p)&&"count"===x;if(g){u[r]||(u[r]=this._calculateUniqueValues(b,c,f));var z=u[r],A;for(A in z){var v=z[A],B=v.count,E=v.data,y=v.items;if(!a||b.validateItems(y,a)){var v=q[E]||{attributes:{}},F=null;C?F=B:(B=this._calculateStatistics(y,
b,r,w),y="var"===x?"variance":x,F=B[y]);v.attributes[n]=F;v.attributes[p?"EXPR_1":c]=E;q[E]=v}}}else k[r]||(k[r]=this._calculateStatistics(this.items,b,r,w)),B=k[r],y="var"===x?"variance":x,t.attributes[n]=B[y];d.push({name:n,alias:n,type:"esriFieldTypeDouble"})}if(g)for(var D in q)h.push(q[D]);else h.push(t);return{fields:d,features:h}};f.prototype._calculateStatistics=function(a,b,e,h){for(var d=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,g=null,f=null,n=null,p=null,q=[],k=0,t=0;t<a.length;t++){var m=
b.getFieldValue(a[t],e,h);"string"===typeof m?k++:null==m||isNaN(m)||(g+=m,d=Math.min(d,m),c=Math.max(c,m),q.push(m),k++)}if(k){f=g/k;for(b=a=0;b<q.length;b++)m=q[b],a+=Math.pow(m-f,2);p=1<k?a/(k-1):0;n=Math.sqrt(p)}else c=d=null;return{avg:f,count:k,max:c,min:d,stddev:n,sum:g,variance:p}};f.prototype._calculateUniqueValues=function(a,b,e){for(var f={},d=0,c=this.items;d<c.length;d++){var g=c[d],l=a.getFieldValue(g,b,e);if(null==l||"string"===typeof l&&""===l.trim())l=null;null==f[l]?f[l]={count:1,
data:l,items:[g]}:(f[l].count++,f[l].items.push(g))}return f};return f}();z.default=C});