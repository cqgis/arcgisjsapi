// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/Handles ../core/jsonMap ../core/maybe ../core/promiseUtils ../core/urlUtils ../core/accessorSupport/decorators ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/spatialReferenceUtils ./Layer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(p,U,g,B,f,q,r,t,C,D,l,E,F,u,G,H,m,I,d,J,K,k,L,M,N,O,P,Q,R,v,S,n,w){function T(d,c){return d.some(function(b){for(var a in b)if(J.willPropertyWrite(b,a,null,c))return!0;return!1})}function y(d,c,b){var a=[],e=new Map;d.forEach(function(d){var f=new n;f.read(d,c);b&&-1===b.indexOf(f.name)&&(f.visible=!1);e.set(f.id,f);null!=d.parentLayerId&&-1!==d.parentLayerId?(d=e.get(d.parentLayerId),d.sublayers||(d.sublayers=[]),d.sublayers.unshift(f)):a.unshift(f)});return a}var A=new G.JSONMap({svg:"image/svg+xml",
png:"image/png",jpg:"image/jpeg",gif:"image/gif",bmp:"image/bmp"},{ignoreUnknown:!1});return function(x){function c(b,a){var e=x.call(this)||this;e._sublayersHandles=new u;e.allSublayers=new F({root:e,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});e.customParameters=null;e.customLayerParameters=null;e.copyright=null;e.description=null;e.fullExtent=null;e.fullExtents=null;e.featureInfoFormat=null;e.featureInfoUrl=null;e.imageFormat=null;e.imageMaxHeight=2048;
e.imageMaxWidth=2048;e.imageTransparency=!0;e.legendEnabled=!0;e.mapUrl=null;e.isReference=null;e.operationalLayerType="WMS";e.spatialReference=null;e.spatialReferences=null;e.sublayers=null;e.type="wms";e.url=null;e.version=null;e.watch("sublayers",function(a,b){b&&(b.forEach(function(a){a.layer=null}),e._sublayersHandles.removeAll(),e._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=e;a.layer=e}),e._sublayersHandles||(e._sublayersHandles=new u),e._sublayersHandles.add([a.on("after-add",
function(a){a=a.item;a.parent=e;a.layer=e}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})]))},!0);return e}B(c,x);c.prototype.normalizeCtorArgs=function(b,a){return"string"===typeof b?g({url:b},a):b};c.prototype.load=function(b){var a=this,e=H.isSome(b)?b.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},b).then(function(){return a._fetchService(e)}));return this.when()};c.prototype.readFullExtentFromItemOrMap=function(b,a,e){b=a.extent;return new K({xmin:b[0][0],
ymin:b[0][1],xmax:b[1][0],ymax:b[1][1]})};c.prototype.writeFullExtent=function(b,a,e,c){a.extent=[[b.xmin,b.ymin],[b.xmax,b.ymax]]};c.prototype.readImageFormat=function(b,a){return(b=a.supportedImageFormatTypes)&&-1<b.indexOf("image/png")?"image/png":b&&b[0]};c.prototype.readSpatialReferenceFromItemOrDocument=function(b,a,e){return new k(a.spatialReferences[0])};c.prototype.writeSpatialReferences=function(b,a,e,c){var d=this.spatialReference&&this.spatialReference.wkid;b&&d?(a.spatialReferences=b.filter(function(a){return a!==
d}),a.spatialReferences.unshift(d)):a.spatialReferences=b};c.prototype.readSublayersFromItemOrMap=function(b,a,e){return y(a.layers,e,a.visibleLayers)};c.prototype.readSublayers=function(b,a,e){return y(a.layers,e)};c.prototype.writeSublayers=function(b,a,e,c){a.layers=[];var d=new Map;b=b.flatten(function(a){return(a=a.sublayers)&&a.toArray()}).toArray();b.forEach(function(a){"number"===typeof a.parent.id&&(d.has(a.parent.id)?d.get(a.parent.id).push(a.id):d.set(a.parent.id,[a.id]))});b.forEach(function(b){var e=
g({sublayer:b},c),f=b.write({parentLayerId:"number"===typeof b.parent.id?b.parent.id:-1},e);d.has(b.id)&&(f.sublayerIds=d.get(b.id));!b.sublayers&&b.name&&(b=b.write({},e),delete b.id,a.layers.push(b))});a.visibleLayers=b.filter(function(a){return a.visible&&!a.sublayers}).map(function(a){return a.name})};c.prototype.createExportImageParameters=function(b){this._exportWMSImageParameters=new S({layer:this,extent:b});return this._exportWMSImageParameters.toJSON()};c.prototype.fetchImage=function(b,
a,e,c){var d=this.mapUrl;b={responseType:"image",query:this._mixCustomParameters(g({width:a,height:e},this.createExportImageParameters(b))),signal:c&&c.signal};c&&c.timestamp&&(b.query=g({_ts:c.timestamp},b.query));return l(d,b).then(function(a){return a.data})};c.prototype.fetchFeatureInfo=function(b,a,e,c,d){var f=this,z=w.getPopupLayers(this._exportWMSImageParameters.visibleSublayers);if(!this.featureInfoUrl||!z)return null;a=g({query_layers:z,request:"GetFeatureInfo",info_format:this.featureInfoFormat,
feature_count:25,width:a,height:e},"1.3.0"===this.version?{I:c,J:d}:{x:c,y:d});var h=g({},this.createExportImageParameters(b),a),h=this._mixCustomParameters(h);return l(this.featureInfoUrl,{query:h,responseType:"text"}).then(function(a){var b=f.featureInfoUrl,b=b+(-1===b.indexOf("?")?"?":""),c;for(c in h)b+="?"===b.substring(b.length-1,b.length)?"":"\x26",b+=c+"\x3d"+h[c];return new C({sourceLayer:f,popupTemplate:new D({title:f.title,content:'\x3ciframe src\x3d"'+b+'" frameborder\x3d"0" marginwidth\x3d"0" marginheight\x3d"0"\x3e'+
a.data+"\x3c/iframe\x3e"})})})};c.prototype.findSublayerById=function(b){return this.allSublayers.find(function(a){return a.id===b})};c.prototype.supportsSpatialReference=function(b){return R.isWmsServer(this.url)||this.spatialReferences.some(function(a){a=900913===a?k.WebMercator:new k({wkid:a});return L.equals(a,b)})};c.prototype.importLayerViewModule=function(b){return r(this,void 0,void 0,function(){return q(this,function(a){switch(b.type){case "2d":return[2,m.create(function(a){return p(["../views/2d/layers/WMSLayerView2D"],
a)})];case "3d":return[2,m.create(function(a){return p(["../views/3d/layers/WMSLayerView3D"],a)})]}return[2]})})};c.prototype._fetchService=function(b){return r(this,void 0,void 0,function(){var a=this;return q(this,function(c){return[2,m.resolve().then(function(){if(a.resourceInfo)return{data:a.resourceInfo};a.parsedUrl.query&&a.parsedUrl.query.service&&(a.parsedUrl.query.SERVICE=a.parsedUrl.query.service,delete a.parsedUrl.query.service);a.parsedUrl.query&&a.parsedUrl.query.request&&(a.parsedUrl.query.REQUEST=
a.parsedUrl.query.request,delete a.parsedUrl.query.request);return l(a.parsedUrl.path,{query:g({SERVICE:"WMS",REQUEST:"GetCapabilities"},a.parsedUrl.query,a.customParameters),responseType:"xml",signal:b})}).then(function(b){if(!a.resourceInfo){b.data=w.parseCapabilities(b.data);var c=new I.Url(a.parsedUrl.path);"https"!==c.scheme||c.port&&"443"!==c.port||-1!==t.request.httpsDomains.indexOf(c.host)||t.request.httpsDomains.push(c.host)}b.data&&a.read(b.data,{origin:"service"})})]})})};c.prototype._mixCustomParameters=
function(b){if(!this.customLayerParameters&&!this.customParameters)return b;var a=g({},this.customParameters,this.customLayerParameters),c;for(c in a)b[c.toLowerCase()]=a[c];return b};f([d.property({readOnly:!0})],c.prototype,"allSublayers",void 0);f([d.property({json:{type:Object,write:!0}})],c.prototype,"customParameters",void 0);f([d.property({type:["show","hide","hide-children"]})],c.prototype,"listMode",void 0);f([d.property({json:{type:Object,write:!0}})],c.prototype,"customLayerParameters",
void 0);f([d.property({type:String,json:{write:!0}})],c.prototype,"copyright",void 0);f([d.property()],c.prototype,"description",void 0);f([d.property({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{service:{read:{source:"extent"}}}}})],c.prototype,"fullExtent",void 0);f([d.reader(["web-document","portal-item"],"fullExtent",["extent"])],c.prototype,"readFullExtentFromItemOrMap",null);f([d.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],
c.prototype,"writeFullExtent",null);f([d.property()],c.prototype,"fullExtents",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],c.prototype,"featureInfoFormat",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],c.prototype,"featureInfoUrl",void 0);f([d.property({type:String,json:{origins:{"web-document":{default:"image/png",read:{reader:A.read,source:"format"},write:{writer:A.write,target:"format"}}}}})],c.prototype,"imageFormat",void 0);f([d.reader("imageFormat",
["supportedImageFormatTypes"])],c.prototype,"readImageFormat",null);f([d.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],c.prototype,"imageMaxHeight",void 0);f([d.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],c.prototype,"imageMaxWidth",void 0);f([d.property()],c.prototype,"imageTransparency",void 0);f([d.property(v.legendEnabled)],c.prototype,"legendEnabled",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],
c.prototype,"mapUrl",void 0);f([d.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],c.prototype,"isReference",void 0);f([d.property({type:["WMS"]})],c.prototype,"operationalLayerType",void 0);f([d.property({type:k,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],c.prototype,"spatialReference",void 0);f([d.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],c.prototype,"readSpatialReferenceFromItemOrDocument",
null);f([d.property({type:[Number],json:{read:{source:"spatialReferences"},write:{ignoreOrigin:!0}}})],c.prototype,"spatialReferences",void 0);f([d.writer(["web-document","portal-item"],"spatialReferences")],c.prototype,"writeSpatialReferences",null);f([d.property({type:E.ofType(n),json:{write:{target:"layers",overridePolicy:function(b,a,c){if(T(this.allSublayers,c))return{ignoreOrigin:!0}}}}})],c.prototype,"sublayers",void 0);f([d.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],
c.prototype,"readSublayersFromItemOrMap",null);f([d.reader("service","sublayers",["layers"])],c.prototype,"readSublayers",null);f([d.writer("sublayers",{layers:{type:[n]},visibleLayers:{type:[String]}})],c.prototype,"writeSublayers",null);f([d.property({json:{read:!1},readOnly:!0,value:"wms"})],c.prototype,"type",void 0);f([d.property(v.url)],c.prototype,"url",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],c.prototype,"version",void 0);return c=f([d.subclass("esri.layers.WMSLayer")],
c)}(d.declared(M,N,O,P,Q))});